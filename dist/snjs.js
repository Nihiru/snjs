!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("SNLibrary",[],t):"object"==typeof exports?exports.SNLibrary=t():e.SNLibrary=t()}(window,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/dist/",r(r.s=209)}([function(e,t,r){"use strict";(function(e){r.d(t,"h",(function(){return l})),r.d(t,"o",(function(){return p})),r.d(t,"g",(function(){return f})),r.d(t,"m",(function(){return y})),r.d(t,"k",(function(){return h})),r.d(t,"l",(function(){return d})),r.d(t,"n",(function(){return v})),r.d(t,"i",(function(){return m})),r.d(t,"z",(function(){return g})),r.d(t,"q",(function(){return b})),r.d(t,"f",(function(){return w})),r.d(t,"x",(function(){return x})),r.d(t,"u",(function(){return k})),r.d(t,"b",(function(){return S})),r.d(t,"v",(function(){return R})),r.d(t,"c",(function(){return P})),r.d(t,"s",(function(){return O})),r.d(t,"r",(function(){return _})),r.d(t,"p",(function(){return j})),r.d(t,"a",(function(){return I})),r.d(t,"e",(function(){return D})),r.d(t,"t",(function(){return C})),r.d(t,"d",(function(){return E})),r.d(t,"j",(function(){return A})),r.d(t,"y",(function(){return T})),r.d(t,"w",(function(){return M}));var n=r(3),a=r.n(n),o=r(89),i=r.n(o),s=r(90),u=r.n(s);function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(){return"undefined"!=typeof window?window:void 0!==e?e:null}function p(){return null!==l()}function f(e,t,r){return e.find((function(e){return e[t]===r}))}function y(e){return null!==e&&("function"==typeof e||"object"===c(e))}function h(e){return null!==e&&"function"==typeof e}function d(e){return null==e}function v(e){return"string"==typeof e||e instanceof String}function m(e,t){return e>t?e:t}function g(e,t,r){return u()(e.concat(t),(function(e,t){var n=!0,a=!1,o=void 0;try{for(var i,s=r[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var u=i.value;if(e[u]!==t[u])return!1}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return!0}))}function b(e){return e[e.length-1]}function w(e,t){var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;e.push(s)}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}function x(e,t){var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;e.splice(e.indexOf(s),1)}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}function k(e,t){e.splice(e.indexOf(t),1)}function S(e,t){return e.filter((function(e){return!t.includes(e)})).concat(t.filter((function(t){return!e.includes(t)})))}function R(e,t){e.splice(t,1)}function P(e,t){var r=e.slice();return R(r,t),r}function O(e,t){if(e){var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){delete e[o.value]}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}}function _(e,t){var r=Object.assign({},e),n=!0,a=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){delete r[i.value]}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return r}function j(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.map((function(e,t){return 0===t?e.trim().replace(/[\/]*$/g,""):e.trim().replace(/(^[\/]*|[\/]*$)/g,"")})).filter((function(e){return e.length})).join("/")}function I(e){return JSON.parse(JSON.stringify(e))}function D(e,t){if(!e||!t)throw"Attempting to deepMerge with null values";return i()(e,t,(function(e,t){if(a()(e))return t})),e}function C(e,t){var r={},n=!0,a=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var u=i.value;r[u]=e[u]}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return I(r)}function E(e){var t=Object.getOwnPropertyNames(e),r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value,u=e[s];e[s]=u&&"object"===c(u)?E(u):u}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}return Object.freeze(e)}function A(e,t){var r=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(e),t);return r&&!d(r.get)}function T(e,t){var r=t/4;return e.substring(0,r)}function M(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return console.warn("Sleeping for",e),t.abrupt("return",new Promise((function(t,r){setTimeout((function(){t()}),e)})));case 2:case"end":return t.stop()}}))}}).call(this,r(53))},function(e,t,r){var n=r(16),a=r(184);e.exports=function(e,t){var r=[];if(!e||!e.length)return r;var o=-1,i=[],s=e.length;for(t=n(t,3);++o<s;){var u=e[o];t(u,o,e)&&(r.push(u),i.push(o))}return a(e,i),r}},function(e,t,r){var n=r(70)(r(181));e.exports=n},function(e,t){var r=Array.isArray;e.exports=r},function(e,t,r){var n=r(176)(r(177));e.exports=n},function(e,t,r){(function(e){var r,n,a,o;function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}window,o=function(){return function(e){function t(t){for(var r,a,o=t[0],i=t[1],s=0,u=[];s<o.length;s++)a=o[s],Object.prototype.hasOwnProperty.call(n,a)&&n[a]&&u.push(n[a][0]),n[a]=0;for(r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r]);for(c&&c(t);u.length;)u.shift()()}var r={},n={1:0,2:0};function a(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.e=function(e){var t=[],r=n[e];if(0!==r)if(r)t.push(r[2]);else{var o=new Promise((function(t,a){r=n[e]=[t,a]}));t.push(r[2]=o);var i,s=document.createElement("script");s.charset="utf-8",s.timeout=120,a.nc&&s.setAttribute("nonce",a.nc),s.src=function(e){return a.p+""+({0:"libsodium",3:"vendors~libsodium"}[e]||e)+".bundle.js"}(e);var u=new Error;i=function(t){s.onerror=s.onload=null,clearTimeout(c);var r=n[e];if(0!==r){if(r){var a=t&&("load"===t.type?"missing":t.type),o=t&&t.target&&t.target.src;u.message="Loading chunk "+e+" failed.\n("+a+": "+o+")",u.name="ChunkLoadError",u.type=a,u.request=o,r[1](u)}n[e]=void 0}};var c=setTimeout((function(){i({type:"timeout",target:s})}),12e4);s.onerror=s.onload=i,document.head.appendChild(s)}return Promise.all(t)},a.m=e,a.c=r,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==i(e)&&e&&e.__esModule)return e;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(r,n,function(t){return e[t]}.bind(null,n));return r},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/dist/",a.oe=function(e){throw console.error(e),e};var o=window.webpackJsonpSNCrypto=window.webpackJsonpSNCrypto||[],s=o.push.bind(o);o.push=t,o=o.slice();for(var u=0;u<o.length;u++)t(o[u]);var c=s;return a(a.s=8)}([function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return a})),r.d(t,"j",(function(){return o})),r.d(t,"o",(function(){return i})),r.d(t,"k",(function(){return s})),r.d(t,"i",(function(){return u})),r.d(t,"n",(function(){return c})),r.d(t,"p",(function(){return l})),r.d(t,"d",(function(){return p})),r.d(t,"c",(function(){return f})),r.d(t,"l",(function(){return y})),r.d(t,"g",(function(){return h})),r.d(t,"b",(function(){return d})),r.d(t,"m",(function(){return v})),r.d(t,"h",(function(){return m})),r.d(t,"f",(function(){return g})),r.d(t,"e",(function(){return b})),r.d(t,"q",(function(){return w}));var n=r(4),a=r(1).Buffer;function o(){return"undefined"!=typeof window?window:void 0!==e?e:null}function i(){return!("undefined"!=typeof document&&document.documentMode||/Edge/.test(navigator.userAgent))&&o().crypto&&!!o().crypto.subtle}function s(){return o().crypto?o().crypto.subtle:null}function u(){var e=o(),t=e.crypto||e.msCrypto;if(t){var r=new Uint32Array(4);t.getRandomValues(r);var n=-1;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){n++;var t=r[n>>3]>>n%8*4&15;return("x"===e?t:3&t|8).toString(16)}))}var a=(new Date).getTime();return e.performance&&"function"==typeof e.performance.now&&(a+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===e?t:3&t|8).toString(16)}))}function c(e){return"string"==typeof e||e instanceof String}function l(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,r){var n=new Blob([e]),a=new FileReader;a.onload=function(e){t(e.target.result)},a.readAsArrayBuffer(n)})));case 1:case"end":return t.stop()}}))}function p(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,r){var n=new Blob([e]),a=new FileReader;a.onload=function(e){t(e.target.result)},a.readAsText(n)})));case 1:case"end":return t.stop()}}))}function f(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:for(t=new Uint8Array(e),r="",a=0;a<t.byteLength;a++)(n=t[a].toString(16)).length<2&&(n="0"+n),r+=n;return o.abrupt("return",r);case 4:case"end":return o.stop()}}))}function y(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:for(t=[],r=0;r<e.length;r+=2)t.push(parseInt(e.substr(r,2),16));return n.abrupt("return",new Uint8Array(t));case 3:case"end":return n.stop()}}))}function h(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(b(e));case 2:for(t=o.sent,r=t.length,n=new Uint8Array(r),a=0;a<r;a++)n[a]=t.charCodeAt(a);return o.abrupt("return",n.buffer);case 7:case"end":return o.stop()}}))}function d(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,r){var n=new Blob([e],{type:"application/octet-binary"}),a=new FileReader;a.onload=function(e){var r=e.target.result;t(r.substr(r.indexOf(",")+1))},a.readAsDataURL(n)})));case 1:case"end":return t.stop()}}))}function v(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=a.from(e,"hex"),r.abrupt("return",t.toString("base64"));case 2:case"end":return r.stop()}}))}function m(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=a.from(e,"base64"),r.abrupt("return",t.toString("hex"));case 2:case"end":return r.stop()}}))}function g(e){return o().btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)})))}function b(e){return o().atob(e)}function w(e){var t,r=arguments;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(t=r.length>1&&void 0!==r[1]?r[1]:"binary",!a.isBuffer(e)){o.next=5;break}return o.abrupt("return",e);case 5:if(null!==e){o.next=9;break}return o.abrupt("return",null);case 9:if("string"!=typeof e){o.next=13;break}return o.abrupt("return",a.from(e,t));case 13:if(!(e instanceof Uint8Array)){o.next=17;break}return o.abrupt("return",n(e));case 17:if(!(e instanceof Promise)){o.next=21;break}return o.abrupt("return",e);case 21:throw new TypeError("Invalid type; string or buffer expected");case 22:case"end":return o.stop()}}))}}).call(this,r(2))},function(e,t,r){"use strict";(function(e){
/*!
       * The buffer module from node.js, for the browser.
       *
       * @author   Feross Aboukhadijeh <http://feross.org>
       * @license  MIT
       */
var n=r(5),a=r(6),o=r(3);function i(){return u.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function s(e,t){if(i()<t)throw new RangeError("Invalid typed array length");return u.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=u.prototype:(null===e&&(e=new u(t)),e.length=t),e}function u(e,t,r){if(!(u.TYPED_ARRAY_SUPPORT||this instanceof u))return new u(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return p(this,e)}return c(this,e,t,r)}function c(e,t,r,n){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,r,n){if(t.byteLength,r<0||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(n||0))throw new RangeError("'length' is out of bounds");return t=void 0===r&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,r):new Uint8Array(t,r,n),u.TYPED_ARRAY_SUPPORT?(e=t).__proto__=u.prototype:e=f(e,t),e}(e,t,r,n):"string"==typeof t?function(e,t,r){if("string"==typeof r&&""!==r||(r="utf8"),!u.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var n=0|h(t,r),a=(e=s(e,n)).write(t,r);return a!==n&&(e=e.slice(0,a)),e}(e,t,r):function(e,t){if(u.isBuffer(t)){var r=0|y(t.length);return 0===(e=s(e,r)).length?e:(t.copy(e,0,0,r),e)}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(n=t.length)!=n?s(e,0):f(e,t);if("Buffer"===t.type&&o(t.data))return f(e,t.data)}var n;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function p(e,t){if(l(t),e=s(e,t<0?0:0|y(t)),!u.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function f(e,t){var r=t.length<0?0:0|y(t.length);e=s(e,r);for(var n=0;n<r;n+=1)e[n]=255&t[n];return e}function y(e){if(e>=i())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i().toString(16)+" bytes");return 0|e}function h(e,t){if(u.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return B(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return V(e).length;default:if(n)return B(e).length;t=(""+t).toLowerCase(),n=!0}}function d(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return D(this,t,r);case"utf8":case"utf-8":return O(this,t,r);case"ascii":return j(this,t,r);case"latin1":case"binary":return I(this,t,r);case"base64":return P(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function v(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function m(e,t,r,n,a){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=a?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(a)return-1;r=e.length-1}else if(r<0){if(!a)return-1;r=0}if("string"==typeof t&&(t=u.from(t,n)),u.isBuffer(t))return 0===t.length?-1:g(e,t,r,n,a);if("number"==typeof t)return t&=255,u.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?a?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):g(e,[t],r,n,a);throw new TypeError("val must be string, number or Buffer")}function g(e,t,r,n,a){var o,i=1,s=e.length,u=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;i=2,s/=2,u/=2,r/=2}function c(e,t){return 1===i?e[t]:e.readUInt16BE(t*i)}if(a){var l=-1;for(o=r;o<s;o++)if(c(e,o)===c(t,-1===l?0:o-l)){if(-1===l&&(l=o),o-l+1===u)return l*i}else-1!==l&&(o-=o-l),l=-1}else for(r+u>s&&(r=s-u),o=r;o>=0;o--){for(var p=!0,f=0;f<u;f++)if(c(e,o+f)!==c(t,f)){p=!1;break}if(p)return o}return-1}function b(e,t,r,n){r=Number(r)||0;var a=e.length-r;n?(n=Number(n))>a&&(n=a):n=a;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");n>o/2&&(n=o/2);for(var i=0;i<n;++i){var s=parseInt(t.substr(2*i,2),16);if(isNaN(s))return i;e[r+i]=s}return i}function w(e,t,r,n){return H(B(t,e.length-r),e,r,n)}function x(e,t,r,n){return H(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function k(e,t,r,n){return x(e,t,r,n)}function S(e,t,r,n){return H(V(t),e,r,n)}function R(e,t,r,n){return H(function(e,t){for(var r,n,a,o=[],i=0;i<e.length&&!((t-=2)<0);++i)n=(r=e.charCodeAt(i))>>8,a=r%256,o.push(a),o.push(n);return o}(t,e.length-r),e,r,n)}function P(e,t,r){return 0===t&&r===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,r))}function O(e,t,r){r=Math.min(e.length,r);for(var n=[],a=t;a<r;){var o,i,s,u,c=e[a],l=null,p=c>239?4:c>223?3:c>191?2:1;if(a+p<=r)switch(p){case 1:c<128&&(l=c);break;case 2:128==(192&(o=e[a+1]))&&(u=(31&c)<<6|63&o)>127&&(l=u);break;case 3:o=e[a+1],i=e[a+2],128==(192&o)&&128==(192&i)&&(u=(15&c)<<12|(63&o)<<6|63&i)>2047&&(u<55296||u>57343)&&(l=u);break;case 4:o=e[a+1],i=e[a+2],s=e[a+3],128==(192&o)&&128==(192&i)&&128==(192&s)&&(u=(15&c)<<18|(63&o)<<12|(63&i)<<6|63&s)>65535&&u<1114112&&(l=u)}null===l?(l=65533,p=1):l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|1023&l),n.push(l),a+=p}return function(e){var t=e.length;if(t<=_)return String.fromCharCode.apply(String,e);for(var r="",n=0;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=_));return r}(n)}t.Buffer=u,t.SlowBuffer=function(e){return+e!=e&&(e=0),u.alloc(+e)},t.INSPECT_MAX_BYTES=50,u.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=i(),u.poolSize=8192,u._augment=function(e){return e.__proto__=u.prototype,e},u.from=function(e,t,r){return c(null,e,t,r)},u.TYPED_ARRAY_SUPPORT&&(u.prototype.__proto__=Uint8Array.prototype,u.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&u[Symbol.species]===u&&Object.defineProperty(u,Symbol.species,{value:null,configurable:!0})),u.alloc=function(e,t,r){return function(e,t,r,n){return l(t),t<=0?s(e,t):void 0!==r?"string"==typeof n?s(e,t).fill(r,n):s(e,t).fill(r):s(e,t)}(null,e,t,r)},u.allocUnsafe=function(e){return p(null,e)},u.allocUnsafeSlow=function(e){return p(null,e)},u.isBuffer=function(e){return!(null==e||!e._isBuffer)},u.compare=function(e,t){if(!u.isBuffer(e)||!u.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,n=t.length,a=0,o=Math.min(r,n);a<o;++a)if(e[a]!==t[a]){r=e[a],n=t[a];break}return r<n?-1:n<r?1:0},u.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(e,t){if(!o(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return u.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var n=u.allocUnsafe(t),a=0;for(r=0;r<e.length;++r){var i=e[r];if(!u.isBuffer(i))throw new TypeError('"list" argument must be an Array of Buffers');i.copy(n,a),a+=i.length}return n},u.byteLength=h,u.prototype._isBuffer=!0,u.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)v(this,t,t+1);return this},u.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)v(this,t,t+3),v(this,t+1,t+2);return this},u.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)v(this,t,t+7),v(this,t+1,t+6),v(this,t+2,t+5),v(this,t+3,t+4);return this},u.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?O(this,0,e):d.apply(this,arguments)},u.prototype.equals=function(e){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===u.compare(this,e)},u.prototype.inspect=function(){var e="",r=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,r).match(/.{2}/g).join(" "),this.length>r&&(e+=" ... ")),"<Buffer "+e+">"},u.prototype.compare=function(e,t,r,n,a){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===a&&(a=this.length),t<0||r>e.length||n<0||a>this.length)throw new RangeError("out of range index");if(n>=a&&t>=r)return 0;if(n>=a)return-1;if(t>=r)return 1;if(this===e)return 0;for(var o=(a>>>=0)-(n>>>=0),i=(r>>>=0)-(t>>>=0),s=Math.min(o,i),c=this.slice(n,a),l=e.slice(t,r),p=0;p<s;++p)if(c[p]!==l[p]){o=c[p],i=l[p];break}return o<i?-1:i<o?1:0},u.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},u.prototype.indexOf=function(e,t,r){return m(this,e,t,r,!0)},u.prototype.lastIndexOf=function(e,t,r){return m(this,e,t,r,!1)},u.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var a=this.length-t;if((void 0===r||r>a)&&(r=a),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return b(this,e,t,r);case"utf8":case"utf-8":return w(this,e,t,r);case"ascii":return x(this,e,t,r);case"latin1":case"binary":return k(this,e,t,r);case"base64":return S(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,e,t,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var _=4096;function j(e,t,r){var n="";r=Math.min(e.length,r);for(var a=t;a<r;++a)n+=String.fromCharCode(127&e[a]);return n}function I(e,t,r){var n="";r=Math.min(e.length,r);for(var a=t;a<r;++a)n+=String.fromCharCode(e[a]);return n}function D(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var a="",o=t;o<r;++o)a+=N(e[o]);return a}function C(e,t,r){for(var n=e.slice(t,r),a="",o=0;o<n.length;o+=2)a+=String.fromCharCode(n[o]+256*n[o+1]);return a}function E(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function A(e,t,r,n,a,o){if(!u.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>a||t<o)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function T(e,t,r,n){t<0&&(t=65535+t+1);for(var a=0,o=Math.min(e.length-r,2);a<o;++a)e[r+a]=(t&255<<8*(n?a:1-a))>>>8*(n?a:1-a)}function M(e,t,r,n){t<0&&(t=4294967295+t+1);for(var a=0,o=Math.min(e.length-r,4);a<o;++a)e[r+a]=t>>>8*(n?a:3-a)&255}function K(e,t,r,n,a,o){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function F(e,t,r,n,o){return o||K(e,0,r,4),a.write(e,t,r,n,23,4),r+4}function L(e,t,r,n,o){return o||K(e,0,r,8),a.write(e,t,r,n,52,8),r+8}u.prototype.slice=function(e,t){var r,n=this.length;if((e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e),u.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=u.prototype;else{var a=t-e;r=new u(a,void 0);for(var o=0;o<a;++o)r[o]=this[o+e]}return r},u.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||E(e,t,this.length);for(var n=this[e],a=1,o=0;++o<t&&(a*=256);)n+=this[e+o]*a;return n},u.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||E(e,t,this.length);for(var n=this[e+--t],a=1;t>0&&(a*=256);)n+=this[e+--t]*a;return n},u.prototype.readUInt8=function(e,t){return t||E(e,1,this.length),this[e]},u.prototype.readUInt16LE=function(e,t){return t||E(e,2,this.length),this[e]|this[e+1]<<8},u.prototype.readUInt16BE=function(e,t){return t||E(e,2,this.length),this[e]<<8|this[e+1]},u.prototype.readUInt32LE=function(e,t){return t||E(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},u.prototype.readUInt32BE=function(e,t){return t||E(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},u.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||E(e,t,this.length);for(var n=this[e],a=1,o=0;++o<t&&(a*=256);)n+=this[e+o]*a;return n>=(a*=128)&&(n-=Math.pow(2,8*t)),n},u.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||E(e,t,this.length);for(var n=t,a=1,o=this[e+--n];n>0&&(a*=256);)o+=this[e+--n]*a;return o>=(a*=128)&&(o-=Math.pow(2,8*t)),o},u.prototype.readInt8=function(e,t){return t||E(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},u.prototype.readInt16LE=function(e,t){t||E(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},u.prototype.readInt16BE=function(e,t){t||E(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},u.prototype.readInt32LE=function(e,t){return t||E(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},u.prototype.readInt32BE=function(e,t){return t||E(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},u.prototype.readFloatLE=function(e,t){return t||E(e,4,this.length),a.read(this,e,!0,23,4)},u.prototype.readFloatBE=function(e,t){return t||E(e,4,this.length),a.read(this,e,!1,23,4)},u.prototype.readDoubleLE=function(e,t){return t||E(e,8,this.length),a.read(this,e,!0,52,8)},u.prototype.readDoubleBE=function(e,t){return t||E(e,8,this.length),a.read(this,e,!1,52,8)},u.prototype.writeUIntLE=function(e,t,r,n){e=+e,t|=0,r|=0,n||A(this,e,t,r,Math.pow(2,8*r)-1,0);var a=1,o=0;for(this[t]=255&e;++o<r&&(a*=256);)this[t+o]=e/a&255;return t+r},u.prototype.writeUIntBE=function(e,t,r,n){e=+e,t|=0,r|=0,n||A(this,e,t,r,Math.pow(2,8*r)-1,0);var a=r-1,o=1;for(this[t+a]=255&e;--a>=0&&(o*=256);)this[t+a]=e/o&255;return t+r},u.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,1,255,0),u.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},u.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):T(this,e,t,!0),t+2},u.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):T(this,e,t,!1),t+2},u.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):M(this,e,t,!0),t+4},u.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):M(this,e,t,!1),t+4},u.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t|=0,!n){var a=Math.pow(2,8*r-1);A(this,e,t,r,a-1,-a)}var o=0,i=1,s=0;for(this[t]=255&e;++o<r&&(i*=256);)e<0&&0===s&&0!==this[t+o-1]&&(s=1),this[t+o]=(e/i>>0)-s&255;return t+r},u.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t|=0,!n){var a=Math.pow(2,8*r-1);A(this,e,t,r,a-1,-a)}var o=r-1,i=1,s=0;for(this[t+o]=255&e;--o>=0&&(i*=256);)e<0&&0===s&&0!==this[t+o+1]&&(s=1),this[t+o]=(e/i>>0)-s&255;return t+r},u.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,1,127,-128),u.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},u.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):T(this,e,t,!0),t+2},u.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):T(this,e,t,!1),t+2},u.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,4,2147483647,-2147483648),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):M(this,e,t,!0),t+4},u.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||A(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):M(this,e,t,!1),t+4},u.prototype.writeFloatLE=function(e,t,r){return F(this,e,t,!0,r)},u.prototype.writeFloatBE=function(e,t,r){return F(this,e,t,!1,r)},u.prototype.writeDoubleLE=function(e,t,r){return L(this,e,t,!0,r)},u.prototype.writeDoubleBE=function(e,t,r){return L(this,e,t,!1,r)},u.prototype.copy=function(e,t,r,n){if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var a,o=n-r;if(this===e&&r<t&&t<n)for(a=o-1;a>=0;--a)e[a+t]=this[a+r];else if(o<1e3||!u.TYPED_ARRAY_SUPPORT)for(a=0;a<o;++a)e[a+t]=this[a+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+o),t);return o},u.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),1===e.length){var a=e.charCodeAt(0);a<256&&(e=a)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!u.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var o;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(o=t;o<r;++o)this[o]=e;else{var i=u.isBuffer(e)?e:B(new u(e,n).toString()),s=i.length;for(o=0;o<r-t;++o)this[o+t]=i[o%s]}return this};var U=/[^+\/0-9A-Za-z-_]/g;function N(e){return e<16?"0"+e.toString(16):e.toString(16)}function B(e,t){var r;t=t||1/0;for(var n=e.length,a=null,o=[],i=0;i<n;++i){if((r=e.charCodeAt(i))>55295&&r<57344){if(!a){if(r>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(i+1===n){(t-=3)>-1&&o.push(239,191,189);continue}a=r;continue}if(r<56320){(t-=3)>-1&&o.push(239,191,189),a=r;continue}r=65536+(a-55296<<10|r-56320)}else a&&(t-=3)>-1&&o.push(239,191,189);if(a=null,r<128){if((t-=1)<0)break;o.push(r)}else if(r<2048){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function V(e){return n.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(U,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function H(e,t,r,n){for(var a=0;a<n&&!(a+r>=t.length||a>=e.length);++a)t[a+r]=e[a];return a}}).call(this,r(2))},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==i(Symbol.iterator)?function(e){return i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":i(e)})(e)}var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":r(window))&&(n=window)}e.exports=n},function(e,t){var r={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==r.call(e)}},function(e,t,r){(function(t){var n=r(7).strict;e.exports=function(e){if(n(e)){var r=t.from(e.buffer);return e.byteLength!==e.buffer.byteLength&&(r=r.slice(e.byteOffset,e.byteOffset+e.byteLength)),r}return t.from(e)}}).call(this,r(1).Buffer)},function(e,t,r){"use strict";t.byteLength=function(e){var t=c(e),r=t[0],n=t[1];return 3*(r+n)/4-n},t.toByteArray=function(e){var t,r,n=c(e),i=n[0],s=n[1],u=new o(function(e,t,r){return 3*(t+r)/4-r}(0,i,s)),l=0,p=s>0?i-4:i;for(r=0;r<p;r+=4)t=a[e.charCodeAt(r)]<<18|a[e.charCodeAt(r+1)]<<12|a[e.charCodeAt(r+2)]<<6|a[e.charCodeAt(r+3)],u[l++]=t>>16&255,u[l++]=t>>8&255,u[l++]=255&t;return 2===s&&(t=a[e.charCodeAt(r)]<<2|a[e.charCodeAt(r+1)]>>4,u[l++]=255&t),1===s&&(t=a[e.charCodeAt(r)]<<10|a[e.charCodeAt(r+1)]<<4|a[e.charCodeAt(r+2)]>>2,u[l++]=t>>8&255,u[l++]=255&t),u},t.fromByteArray=function(e){for(var t,r=e.length,a=r%3,o=[],i=0,s=r-a;i<s;i+=16383)o.push(l(e,i,i+16383>s?s:i+16383));return 1===a?(t=e[r-1],o.push(n[t>>2]+n[t<<4&63]+"==")):2===a&&(t=(e[r-2]<<8)+e[r-1],o.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),o.join("")};for(var n=[],a=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,u=i.length;s<u;++s)n[s]=i[s],a[i.charCodeAt(s)]=s;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function l(e,t,r){for(var a,o,i=[],s=t;s<r;s+=3)a=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(255&e[s+2]),i.push(n[(o=a)>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]);return i.join("")}a["-".charCodeAt(0)]=62,a["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,r,n,a){var o,i,s=8*a-n-1,u=(1<<s)-1,c=u>>1,l=-7,p=r?a-1:0,f=r?-1:1,y=e[t+p];for(p+=f,o=y&(1<<-l)-1,y>>=-l,l+=s;l>0;o=256*o+e[t+p],p+=f,l-=8);for(i=o&(1<<-l)-1,o>>=-l,l+=n;l>0;i=256*i+e[t+p],p+=f,l-=8);if(0===o)o=1-c;else{if(o===u)return i?NaN:1/0*(y?-1:1);i+=Math.pow(2,n),o-=c}return(y?-1:1)*i*Math.pow(2,o-n)},t.write=function(e,t,r,n,a,o){var i,s,u,c=8*o-a-1,l=(1<<c)-1,p=l>>1,f=23===a?Math.pow(2,-24)-Math.pow(2,-77):0,y=n?0:o-1,h=n?1:-1,d=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,i=l):(i=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-i))<1&&(i--,u*=2),(t+=i+p>=1?f/u:f*Math.pow(2,1-p))*u>=2&&(i++,u/=2),i+p>=l?(s=0,i=l):i+p>=1?(s=(t*u-1)*Math.pow(2,a),i+=p):(s=t*Math.pow(2,p-1)*Math.pow(2,a),i=0));a>=8;e[r+y]=255&s,y+=h,s/=256,a-=8);for(i=i<<a|s,c+=a;c>0;e[r+y]=255&i,y+=h,i/=256,c-=8);e[r+y-h]|=128*d}},function(e,t){e.exports=a,a.strict=o,a.loose=i;var r=Object.prototype.toString,n={"[object Int8Array]":!0,"[object Int16Array]":!0,"[object Int32Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Uint16Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0};function a(e){return o(e)||i(e)}function o(e){return e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array}function i(e){return n[r.call(e)]}},function(e,t,r){"use strict";r.r(t);var n=r(0);function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r;return t=e,(r=[{key:"generateUUIDSync",value:function(){return Object(n.i)()}},{key:"generateUUID",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(n.i)());case 1:case"end":return e.stop()}}))}},{key:"timingSafeEqual",value:function(e,t){var r=String(e),n=String(t),a=r.length,o=0;a!==n.length&&(n=r,o=1);for(var i=0;i<a;i++)o|=r.charCodeAt(i)^n.charCodeAt(i);return 0===o}}])&&a(t.prototype,r),e}();function s(e){return(s="function"==typeof Symbol&&"symbol"==i(Symbol.iterator)?function(e){return i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":i(e)})(e)}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var f=n.k(),y="AES-CBC",h="SHA-256",d="PBKDF2",v="HMAC",m=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=c(this,l(t).call(this))).ready=Promise.all([r.e(3),r.e(0)]).then(r.bind(null,166)).then((function(t){return e.sodium=t,e.sodium.ready})),e}var a,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(t,e),a=t,(o=[{key:"pbkdf2",value:function(e,t,r,n){var a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(this.webCryptoImportKey(e,d,["deriveBits"]));case 2:if(a=o.sent){o.next=6;break}return console.error("Key is null, unable to continue"),o.abrupt("return",null);case 6:return o.abrupt("return",this.webCryptoDeriveBits(a,t,r,n));case 7:case"end":return o.stop()}}),null,this)}},{key:"generateRandomKey",value:function(e){var t,r;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e/8,r=n.j().crypto.getRandomValues(new Uint8Array(t)),a.abrupt("return",n.c(r));case 3:case"end":return a.stop()}}))}},{key:"aes256CbcEncrypt",value:function(e,t,r){var a,o,i,s,u,c,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:return p.next=2,regeneratorRuntime.awrap(n.l(r));case 2:return a=p.sent,p.next=5,regeneratorRuntime.awrap(n.l(t));case 5:return o=p.sent,i={name:y,iv:o},p.next=9,regeneratorRuntime.awrap(this.webCryptoImportKey(a,i.name,["encrypt"]));case 9:return s=p.sent,p.next=12,regeneratorRuntime.awrap(n.p(e));case 12:return u=p.sent,p.next=15,regeneratorRuntime.awrap(crypto.subtle.encrypt(i,s,u));case 15:return c=p.sent,p.next=18,regeneratorRuntime.awrap(n.b(c));case 18:return l=p.sent,p.abrupt("return",l);case 20:case"end":return p.stop()}}),null,this)}},{key:"aes256CbcDecrypt",value:function(e,t,r){var a,o,i,s,u;return regeneratorRuntime.async((function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,regeneratorRuntime.awrap(n.l(r));case 2:return a=c.sent,c.next=5,regeneratorRuntime.awrap(n.l(t));case 5:return o=c.sent,i={name:y,iv:o},c.next=9,regeneratorRuntime.awrap(this.webCryptoImportKey(a,i.name,["decrypt"]));case 9:return s=c.sent,c.next=12,regeneratorRuntime.awrap(n.g(e));case 12:return u=c.sent,c.abrupt("return",crypto.subtle.decrypt(i,s,u).then((function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",n.d(e));case 1:case"end":return t.stop()}}))})).catch((function(e){return console.error("Error performing AES-CBC decryption:",e),null})));case 14:case"end":return c.stop()}}),null,this)}},{key:"hmac256",value:function(e,t){var r,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,regeneratorRuntime.awrap(n.l(t));case 2:return r=i.sent,i.next=5,regeneratorRuntime.awrap(this.webCryptoImportKey(r,v,["sign"],{name:h}));case 5:return a=i.sent,i.next=8,regeneratorRuntime.awrap(n.p(e));case 8:return o=i.sent,i.abrupt("return",crypto.subtle.sign({name:v},a,o).then((function(e){return n.c(e)})).catch((function(e){return console.error("Error computing HMAC:",e),null})));case 10:case"end":return i.stop()}}),null,this)}},{key:"sha256",value:function(e){var t,r;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,regeneratorRuntime.awrap(n.p(e));case 2:return t=a.sent,a.next=5,regeneratorRuntime.awrap(crypto.subtle.digest(h,t));case 5:return r=a.sent,a.abrupt("return",n.c(r));case 7:case"end":return a.stop()}}))}},{key:"unsafeSha1",value:function(e){var t,r;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,regeneratorRuntime.awrap(n.p(e));case 2:return t=a.sent,a.next=5,regeneratorRuntime.awrap(crypto.subtle.digest("SHA-1",t));case 5:return r=a.sent,a.abrupt("return",n.c(r));case 7:case"end":return a.stop()}}))}},{key:"webCryptoImportKey",value:function(e,t,r,a){var o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(!n.n(e)){i.next=6;break}return i.next=3,regeneratorRuntime.awrap(n.p(e));case 3:i.t0=i.sent,i.next=7;break;case 6:i.t0=e;case 7:return o=i.t0,i.abrupt("return",f.importKey("raw",o,{name:t,hash:a},!1,r).then((function(e){return e})).catch((function(e){return console.error(e),null})));case 9:case"end":return i.stop()}}))}},{key:"webCryptoDeriveBits",value:function(e,t,r,a){var o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.t0=d,i.next=3,regeneratorRuntime.awrap(n.p(t));case 3:return i.t1=i.sent,i.t2=r,i.t3={name:"SHA-512"},o={name:i.t0,salt:i.t1,iterations:i.t2,hash:i.t3},i.abrupt("return",f.deriveBits(o,e,a).then((function(e){return n.c(new Uint8Array(e))})).catch((function(e){return console.error(e),null})));case 8:case"end":return i.stop()}}))}},{key:"argon2",value:function(e,t,r,a,o){var i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,regeneratorRuntime.awrap(this.ready);case 2:return s.t0=this.sodium,s.t1=o,s.next=6,regeneratorRuntime.awrap(n.q(e,"binary"));case 6:return s.t2=s.sent,s.next=9,regeneratorRuntime.awrap(n.q(t,"hex"));case 9:return s.t3=s.sent,s.t4=r,s.t5=a,s.t6=this.sodium.crypto_pwhash_ALG_DEFAULT,i=s.t0.crypto_pwhash.call(s.t0,s.t1,s.t2,s.t3,s.t4,s.t5,s.t6,"hex"),s.abrupt("return",i);case 15:case"end":return s.stop()}}),null,this)}},{key:"xchacha20Encrypt",value:function(e,t,r,a){return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(this.ready);case 2:if(48===t.length){o.next=4;break}throw"Nonce must be 24 bytes";case 4:return o.t0=this.sodium,o.next=7,regeneratorRuntime.awrap(n.q(e));case 7:return o.t1=o.sent,o.next=10,regeneratorRuntime.awrap(n.q(a));case 10:return o.t2=o.sent,o.next=13,regeneratorRuntime.awrap(n.q(t,"hex"));case 13:return o.t3=o.sent,o.next=16,regeneratorRuntime.awrap(n.q(r,"hex"));case 16:return o.t4=o.sent,o.abrupt("return",o.t0.crypto_aead_xchacha20poly1305_ietf_encrypt.call(o.t0,o.t1,o.t2,null,o.t3,o.t4,"base64"));case 18:case"end":return o.stop()}}),null,this)}},{key:"xchacha20Decrypt",value:function(e,t,r,a){return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(this.ready);case 2:if(48===t.length){o.next=4;break}throw"Nonce must be 24 bytes";case 4:return o.prev=4,o.t0=this.sodium,o.next=8,regeneratorRuntime.awrap(n.q(e,"base64"));case 8:return o.t1=o.sent,o.next=11,regeneratorRuntime.awrap(n.q(a));case 11:return o.t2=o.sent,o.next=14,regeneratorRuntime.awrap(n.q(t,"hex"));case 14:return o.t3=o.sent,o.next=17,regeneratorRuntime.awrap(n.q(r,"hex"));case 17:return o.t4=o.sent,o.abrupt("return",o.t0.crypto_aead_xchacha20poly1305_ietf_decrypt.call(o.t0,null,o.t1,o.t2,o.t3,o.t4,"text"));case 21:return o.prev=21,o.t5=o.catch(4),o.abrupt("return",null);case 24:case"end":return o.stop()}}),null,this,[[4,21]])}}])&&u(a.prototype,o),t}(o);r.d(t,"SNPureCrypto",(function(){return o})),r.d(t,"SNWebCrypto",(function(){return m})),r.d(t,"isWebCryptoAvailable",(function(){return n.o})),r.d(t,"Buffer",(function(){return n.a})),r.d(t,"base64Encode",(function(){return n.f})),r.d(t,"base64Decode",(function(){return n.e})),r.d(t,"base64ToHex",(function(){return n.h})),r.d(t,"hexToBase64",(function(){return n.m}))}])},"object"==i(t)&&"object"==i(e)?e.exports=o():(n=[],void 0===(a="function"==typeof(r=o)?r.apply(t,n):r)||(e.exports=a))}).call(this,r(25)(e))},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(55),o="object"==("undefined"==typeof self?"undefined":n(self))&&self&&self.Object===Object&&self,i=a||o||Function("return this")();e.exports=i},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=r(e);return null!=e&&("object"==t||"function"==t)}},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){return null!=e&&"object"==r(e)}},function(e,t,r){var n=r(103),a=r(108);e.exports=function(e,t){var r=a(e,t);return n(r)?r:void 0}},function(e,t,r){var n=r(36),a=r(43);e.exports=function(e){return null!=e&&a(e.length)&&!n(e)}},function(e,t,r){var n=r(12),a=r(104),o=r(105),i="[object Null]",s="[object Undefined]",u=n?n.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?s:i:u&&u in Object(e)?a(e):o(e)}},function(e,t,r){var n=r(6).Symbol;e.exports=n},function(e,t,r){var n=r(67),a=r(38);e.exports=function(e,t,r,o){var i=!r;r||(r={});for(var s=-1,u=t.length;++s<u;){var c=t[s],l=o?o(r[c],e[c],c,r,e):void 0;void 0===l&&(l=e[c]),i?a(r,c,l):n(r,c,l)}return r}},function(e,t,r){var n=r(68),a=r(153),o=r(10);e.exports=function(e){return o(e)?n(e):a(e)}},function(e,t){e.exports=function(e,t){return e===t||e!=e&&t!=t}},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(145),o=r(159),i=r(46),s=r(3),u=r(169);e.exports=function(e){return"function"==typeof e?e:null==e?i:"object"==n(e)?s(e)?o(e[0],e[1]):a(e):u(e)}},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(11),o=r(8),i="[object Symbol]";e.exports=function(e){return"symbol"==n(e)||o(e)&&a(e)==i}},function(e,t,r){var n=r(17),a=1/0;e.exports=function(e){if("string"==typeof e||n(e))return e;var t=e+"";return"0"==t&&1/e==-a?"-0":t}},function(e,t,r){var n=r(73);e.exports=function(e){return e&&e.length?n(e):[]}},function(e,t,r){var n=r(21),a=r(98),o=r(99),i=r(100),s=r(101),u=r(102);function c(e){var t=this.__data__=new n(e);this.size=t.size}c.prototype.clear=a,c.prototype.delete=o,c.prototype.get=i,c.prototype.has=s,c.prototype.set=u,e.exports=c},function(e,t,r){var n=r(93),a=r(94),o=r(95),i=r(96),s=r(97);function u(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}u.prototype.clear=n,u.prototype.delete=a,u.prototype.get=o,u.prototype.has=i,u.prototype.set=s,e.exports=u},function(e,t,r){var n=r(15);e.exports=function(e,t){for(var r=e.length;r--;)if(n(e[r][0],t))return r;return-1}},function(e,t,r){var n=r(9)(Object,"create");e.exports=n},function(e,t,r){var n=r(117);e.exports=function(e,t){var r=e.__data__;return n(t)?r["string"==typeof t?"string":"hash"]:r.map}},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,r){var n=r(124),a=r(8),o=Object.prototype,i=o.hasOwnProperty,s=o.propertyIsEnumerable,u=n(function(){return arguments}())?n:function(e){return a(e)&&i.call(e,"callee")&&!s.call(e,"callee")};e.exports=u},function(e,t,r){(function(e){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(6),o=r(126),i="object"==n(t)&&t&&!t.nodeType&&t,s=i&&"object"==n(e)&&e&&!e.nodeType&&e,u=s&&s.exports===i?a.Buffer:void 0,c=(u?u.isBuffer:void 0)||o;e.exports=c}).call(this,r(25)(e))},function(e,t){e.exports=function(e){return function(t){return e(t)}}},function(e,t,r){var n=r(68),a=r(130),o=r(10);e.exports=function(e){return o(e)?n(e,!0):a(e)}},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n=9007199254740991,a=/^(?:0|[1-9]\d*)$/;e.exports=function(e,t){var o=r(e);return!!(t=null==t?n:t)&&("number"==o||"symbol"!=o&&a.test(e))&&e>-1&&e%1==0&&e<t}},function(e,t){e.exports=function(e,t){for(var r=-1,n=null==e?0:e.length,a=Array(n);++r<n;)a[r]=t(e[r],r,e);return a}},function(e,t,r){var n=r(155),a=r(35),o=r(156),i=r(78),s=r(157),u=r(11),c=r(56),l=c(n),p=c(a),f=c(o),y=c(i),h=c(s),d=u;(n&&"[object DataView]"!=d(new n(new ArrayBuffer(1)))||a&&"[object Map]"!=d(new a)||o&&"[object Promise]"!=d(o.resolve())||i&&"[object Set]"!=d(new i)||s&&"[object WeakMap]"!=d(new s))&&(d=function(e){var t=u(e),r="[object Object]"==t?e.constructor:void 0,n=r?c(r):"";if(n)switch(n){case l:return"[object DataView]";case p:return"[object Map]";case f:return"[object Promise]";case y:return"[object Set]";case h:return"[object WeakMap]"}return t}),e.exports=d},function(e,t,r){var n=r(3),a=r(51),o=r(161),i=r(164);e.exports=function(e,t){return n(e)?e:a(e,t)?[e]:o(i(e))}},function(e,t,r){var n=r(54),a=r(69)((function(e,t,r){n(e,t,r)}));e.exports=a},function(e,t,r){var n=r(9)(r(6),"Map");e.exports=n},function(e,t,r){var n=r(11),a=r(7),o="[object AsyncFunction]",i="[object Function]",s="[object GeneratorFunction]",u="[object Proxy]";e.exports=function(e){if(!a(e))return!1;var t=n(e);return t==i||t==s||t==o||t==u}},function(e,t,r){var n=r(109),a=r(116),o=r(118),i=r(119),s=r(120);function u(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}u.prototype.clear=n,u.prototype.delete=a,u.prototype.get=o,u.prototype.has=i,u.prototype.set=s,e.exports=u},function(e,t,r){var n=r(58);e.exports=function(e,t,r){"__proto__"==t&&n?n(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}},function(e,t,r){var n=r(62);e.exports=function(e){var t=new e.constructor(e.byteLength);return new n(t).set(new n(e)),t}},function(e,t){e.exports=function(e,t){var r=-1,n=e.length;for(t||(t=Array(n));++r<n;)t[r]=e[r];return t}},function(e,t,r){var n=r(64)(Object.getPrototypeOf,Object);e.exports=n},function(e,t){var r=Object.prototype;e.exports=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||r)}},function(e,t){var r=9007199254740991;e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=r}},function(e,t,r){var n=r(127),a=r(28),o=r(45),i=o&&o.isTypedArray,s=i?a(i):n;e.exports=s},function(e,t,r){(function(e){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(55),o="object"==n(t)&&t&&!t.nodeType&&t,i=o&&"object"==n(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o&&a.process,u=function(){try{var e=i&&i.require&&i.require("util").types;return e||s&&s.binding&&s.binding("util")}catch(e){}}();e.exports=u}).call(this,r(25)(e))},function(e,t){e.exports=function(e){return e}},function(e,t){e.exports=function(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r}},function(e,t){e.exports=function(e,t){for(var r=-1,n=t.length,a=e.length;++r<n;)e[a+r]=t[r];return e}},function(e,t,r){var n=r(152),a=r(83),o=Object.prototype.propertyIsEnumerable,i=Object.getOwnPropertySymbols,s=i?function(e){return null==e?[]:(e=Object(e),n(i(e),(function(t){return o.call(e,t)})))}:a;e.exports=s},function(e,t,r){var n=r(33),a=r(18);e.exports=function(e,t){for(var r=0,o=(t=n(t,e)).length;null!=e&&r<o;)e=e[a(t[r++])];return r&&r==o?e:void 0}},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(3),o=r(17),i=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,s=/^\w*$/;e.exports=function(e,t){if(a(e))return!1;var r=n(e);return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!o(e))||(s.test(e)||!i.test(e)||null!=t&&e in Object(t))}},function(e,t,r){var n=r(16),a=r(208);e.exports=function(e,t,r){return a(e,t,n(r,2))}},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":r(window))&&(n=window)}e.exports=n},function(e,t,r){var n=r(20),a=r(57),o=r(59),i=r(122),s=r(7),u=r(29),c=r(66);e.exports=function e(t,r,l,p,f){t!==r&&o(r,(function(o,u){if(f||(f=new n),s(o))i(t,r,u,l,e,p,f);else{var y=p?p(c(t,u),o,u+"",t,r,f):void 0;void 0===y&&(y=o),a(t,u,y)}}),u)}},function(e,t,r){(function(t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n="object"==(void 0===t?"undefined":r(t))&&t&&t.Object===Object&&t;e.exports=n}).call(this,r(53))},function(e,t){var r=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return r.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},function(e,t,r){var n=r(38),a=r(15);e.exports=function(e,t,r){(void 0===r||a(e[t],r))&&(void 0!==r||t in e)||n(e,t,r)}},function(e,t,r){var n=r(9),a=function(){try{var e=n(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=a},function(e,t,r){var n=r(121)();e.exports=n},function(e,t,r){(function(e){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(6),o="object"==n(t)&&t&&!t.nodeType&&t,i=o&&"object"==n(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o?a.Buffer:void 0,u=s?s.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var r=e.length,n=u?u(r):new e.constructor(r);return e.copy(n),n}}).call(this,r(25)(e))},function(e,t,r){var n=r(39);e.exports=function(e,t){var r=t?n(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}},function(e,t,r){var n=r(6).Uint8Array;e.exports=n},function(e,t,r){var n=r(123),a=r(41),o=r(42);e.exports=function(e){return"function"!=typeof e.constructor||o(e)?{}:n(a(e))}},function(e,t){e.exports=function(e,t){return function(r){return e(t(r))}}},function(e,t,r){var n=r(11),a=r(41),o=r(8),i="[object Object]",s=Function.prototype,u=Object.prototype,c=s.toString,l=u.hasOwnProperty,p=c.call(Object);e.exports=function(e){if(!o(e)||n(e)!=i)return!1;var t=a(e);if(null===t)return!0;var r=l.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&c.call(r)==p}},function(e,t){e.exports=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}},function(e,t,r){var n=r(38),a=r(15),o=Object.prototype.hasOwnProperty;e.exports=function(e,t,r){var i=e[t];o.call(e,t)&&a(i,r)&&(void 0!==r||t in e)||n(e,t,r)}},function(e,t,r){var n=r(129),a=r(26),o=r(3),i=r(27),s=r(30),u=r(44),c=Object.prototype.hasOwnProperty;e.exports=function(e,t){var r=o(e),l=!r&&a(e),p=!r&&!l&&i(e),f=!r&&!l&&!p&&u(e),y=r||l||p||f,h=y?n(e.length,String):[],d=h.length;for(var v in e)!t&&!c.call(e,v)||y&&("length"==v||p&&("offset"==v||"parent"==v)||f&&("buffer"==v||"byteLength"==v||"byteOffset"==v)||s(v,d))||h.push(v);return h}},function(e,t,r){var n=r(70),a=r(136);e.exports=function(e){return n((function(t,r){var n=-1,o=r.length,i=o>1?r[o-1]:void 0,s=o>2?r[2]:void 0;for(i=e.length>3&&"function"==typeof i?(o--,i):void 0,s&&a(r[0],r[1],s)&&(i=o<3?void 0:i,o=1),t=Object(t);++n<o;){var u=r[n];u&&e(t,u,n,i)}return t}))}},function(e,t,r){var n=r(46),a=r(71),o=r(72);e.exports=function(e,t){return o(a(e,t,n),e+"")}},function(e,t,r){var n=r(132),a=Math.max;e.exports=function(e,t,r){return t=a(void 0===t?e.length-1:t,0),function(){for(var o=arguments,i=-1,s=a(o.length-t,0),u=Array(s);++i<s;)u[i]=o[t+i];i=-1;for(var c=Array(t+1);++i<t;)c[i]=o[i];return c[t]=r(u),n(e,this,c)}}},function(e,t,r){var n=r(133),a=r(135)(n);e.exports=a},function(e,t,r){var n=r(74),a=r(139),o=r(142),i=r(77),s=r(143),u=r(47),c=200;e.exports=function(e,t,r){var l=-1,p=a,f=e.length,y=!0,h=[],d=h;if(r)y=!1,p=o;else if(f>=c){var v=t?null:s(e);if(v)return u(v);y=!1,p=i,d=new n}else d=t?[]:h;e:for(;++l<f;){var m=e[l],g=t?t(m):m;if(m=r||0!==m?m:0,y&&g==g){for(var b=d.length;b--;)if(d[b]===g)continue e;t&&d.push(g),h.push(m)}else p(d,g,r)||(d!==h&&d.push(g),h.push(m))}return h}},function(e,t,r){var n=r(37),a=r(137),o=r(138);function i(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new n;++t<r;)this.add(e[t])}i.prototype.add=i.prototype.push=a,i.prototype.has=o,e.exports=i},function(e,t,r){var n=r(76),a=r(140),o=r(141);e.exports=function(e,t,r){return t==t?o(e,t,r):n(e,a,r)}},function(e,t){e.exports=function(e,t,r,n){for(var a=e.length,o=r+(n?1:-1);n?o--:++o<a;)if(t(e[o],o,e))return o;return-1}},function(e,t){e.exports=function(e,t){return e.has(t)}},function(e,t,r){var n=r(9)(r(6),"Set");e.exports=n},function(e,t,r){var n=r(147),a=r(8);e.exports=function e(t,r,o,i,s){return t===r||(null==t||null==r||!a(t)&&!a(r)?t!=t&&r!=r:n(t,r,o,i,e,s))}},function(e,t,r){var n=r(74),a=r(148),o=r(77),i=1,s=2;e.exports=function(e,t,r,u,c,l){var p=r&i,f=e.length,y=t.length;if(f!=y&&!(p&&y>f))return!1;var h=l.get(e);if(h&&l.get(t))return h==t;var d=-1,v=!0,m=r&s?new n:void 0;for(l.set(e,t),l.set(t,e);++d<f;){var g=e[d],b=t[d];if(u)var w=p?u(b,g,d,t,e,l):u(g,b,d,e,t,l);if(void 0!==w){if(w)continue;v=!1;break}if(m){if(!a(t,(function(e,t){if(!o(m,t)&&(g===e||c(g,e,r,u,l)))return m.push(t)}))){v=!1;break}}else if(g!==b&&!c(g,b,r,u,l)){v=!1;break}}return l.delete(e),l.delete(t),v}},function(e,t,r){var n=r(82),a=r(49),o=r(14);e.exports=function(e){return n(e,o,a)}},function(e,t,r){var n=r(48),a=r(3);e.exports=function(e,t,r){var o=t(e);return a(e)?o:n(o,r(e))}},function(e,t){e.exports=function(){return[]}},function(e,t,r){var n=r(7);e.exports=function(e){return e==e&&!n(e)}},function(e,t){e.exports=function(e,t){return function(r){return null!=r&&(r[e]===t&&(void 0!==t||e in Object(r)))}}},function(e,t,r){var n=r(33),a=r(185),o=r(186),i=r(18);e.exports=function(e,t){return t=n(t,e),null==(e=o(e,t))||delete e[i(a(t))]}},function(e,t,r){var n=r(48),a=r(41),o=r(49),i=r(83),s=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)n(t,o(e)),e=a(e);return t}:i;e.exports=s},function(e,t,r){var n=r(82),a=r(87),o=r(29);e.exports=function(e){return n(e,o,a)}},function(e,t,r){var n=r(54),a=r(69)((function(e,t,r,a){n(e,t,r,a)}));e.exports=a},function(e,t,r){var n=r(73);e.exports=function(e,t){return t="function"==typeof t?t:void 0,e&&e.length?n(e,void 0,t):[]}},function(e,t,r){var n=r(31),a=r(16),o=r(172),i=r(3);e.exports=function(e,t){return(i(e)?n:o)(e,a(t,3))}},function(e,t,r){var n=r(31),a=r(188),o=r(86),i=r(33),s=r(13),u=r(203),c=r(204),l=r(88),p=c((function(e,t){var r={};if(null==e)return r;var c=!1;t=n(t,(function(t){return t=i(t,e),c||(c=t.length>1),t})),s(e,l(e),r),c&&(r=a(r,7,u));for(var p=t.length;p--;)o(r,t[p]);return r}));e.exports=p},function(e,t){e.exports=function(){this.__data__=[],this.size=0}},function(e,t,r){var n=r(22),a=Array.prototype.splice;e.exports=function(e){var t=this.__data__,r=n(t,e);return!(r<0)&&(r==t.length-1?t.pop():a.call(t,r,1),--this.size,!0)}},function(e,t,r){var n=r(22);e.exports=function(e){var t=this.__data__,r=n(t,e);return r<0?void 0:t[r][1]}},function(e,t,r){var n=r(22);e.exports=function(e){return n(this.__data__,e)>-1}},function(e,t,r){var n=r(22);e.exports=function(e,t){var r=this.__data__,a=n(r,e);return a<0?(++this.size,r.push([e,t])):r[a][1]=t,this}},function(e,t,r){var n=r(21);e.exports=function(){this.__data__=new n,this.size=0}},function(e,t){e.exports=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r}},function(e,t){e.exports=function(e){return this.__data__.get(e)}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t,r){var n=r(21),a=r(35),o=r(37),i=200;e.exports=function(e,t){var r=this.__data__;if(r instanceof n){var s=r.__data__;if(!a||s.length<i-1)return s.push([e,t]),this.size=++r.size,this;r=this.__data__=new o(s)}return r.set(e,t),this.size=r.size,this}},function(e,t,r){var n=r(36),a=r(106),o=r(7),i=r(56),s=/^\[object .+?Constructor\]$/,u=Function.prototype,c=Object.prototype,l=u.toString,p=c.hasOwnProperty,f=RegExp("^"+l.call(p).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!o(e)||a(e))&&(n(e)?f:s).test(i(e))}},function(e,t,r){var n=r(12),a=Object.prototype,o=a.hasOwnProperty,i=a.toString,s=n?n.toStringTag:void 0;e.exports=function(e){var t=o.call(e,s),r=e[s];try{e[s]=void 0;var n=!0}catch(e){}var a=i.call(e);return n&&(t?e[s]=r:delete e[s]),a}},function(e,t){var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},function(e,t,r){var n,a=r(107),o=(n=/[^.]+$/.exec(a&&a.keys&&a.keys.IE_PROTO||""))?"Symbol(src)_1."+n:"";e.exports=function(e){return!!o&&o in e}},function(e,t,r){var n=r(6)["__core-js_shared__"];e.exports=n},function(e,t){e.exports=function(e,t){return null==e?void 0:e[t]}},function(e,t,r){var n=r(110),a=r(21),o=r(35);e.exports=function(){this.size=0,this.__data__={hash:new n,map:new(o||a),string:new n}}},function(e,t,r){var n=r(111),a=r(112),o=r(113),i=r(114),s=r(115);function u(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}u.prototype.clear=n,u.prototype.delete=a,u.prototype.get=o,u.prototype.has=i,u.prototype.set=s,e.exports=u},function(e,t,r){var n=r(23);e.exports=function(){this.__data__=n?n(null):{},this.size=0}},function(e,t){e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},function(e,t,r){var n=r(23),a="__lodash_hash_undefined__",o=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(n){var r=t[e];return r===a?void 0:r}return o.call(t,e)?t[e]:void 0}},function(e,t,r){var n=r(23),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return n?void 0!==t[e]:a.call(t,e)}},function(e,t,r){var n=r(23),a="__lodash_hash_undefined__";e.exports=function(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=n&&void 0===t?a:t,this}},function(e,t,r){var n=r(24);e.exports=function(e){var t=n(this,e).delete(e);return this.size-=t?1:0,t}},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=r(e);return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},function(e,t,r){var n=r(24);e.exports=function(e){return n(this,e).get(e)}},function(e,t,r){var n=r(24);e.exports=function(e){return n(this,e).has(e)}},function(e,t,r){var n=r(24);e.exports=function(e,t){var r=n(this,e),a=r.size;return r.set(e,t),this.size+=r.size==a?0:1,this}},function(e,t){e.exports=function(e){return function(t,r,n){for(var a=-1,o=Object(t),i=n(t),s=i.length;s--;){var u=i[e?s:++a];if(!1===r(o[u],u,o))break}return t}}},function(e,t,r){var n=r(57),a=r(60),o=r(61),i=r(40),s=r(63),u=r(26),c=r(3),l=r(125),p=r(27),f=r(36),y=r(7),h=r(65),d=r(44),v=r(66),m=r(128);e.exports=function(e,t,r,g,b,w,x){var k=v(e,r),S=v(t,r),R=x.get(S);if(R)n(e,r,R);else{var P=w?w(k,S,r+"",e,t,x):void 0,O=void 0===P;if(O){var _=c(S),j=!_&&p(S),I=!_&&!j&&d(S);P=S,_||j||I?c(k)?P=k:l(k)?P=i(k):j?(O=!1,P=a(S,!0)):I?(O=!1,P=o(S,!0)):P=[]:h(S)||u(S)?(P=k,u(k)?P=m(k):y(k)&&!f(k)||(P=s(S))):O=!1}O&&(x.set(S,P),b(P,S,g,w,x),x.delete(S)),n(e,r,P)}}},function(e,t,r){var n=r(7),a=Object.create,o=function(){function e(){}return function(t){if(!n(t))return{};if(a)return a(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}();e.exports=o},function(e,t,r){var n=r(11),a=r(8),o="[object Arguments]";e.exports=function(e){return a(e)&&n(e)==o}},function(e,t,r){var n=r(10),a=r(8);e.exports=function(e){return a(e)&&n(e)}},function(e,t){e.exports=function(){return!1}},function(e,t,r){var n=r(11),a=r(43),o=r(8),i={};i["[object Float32Array]"]=i["[object Float64Array]"]=i["[object Int8Array]"]=i["[object Int16Array]"]=i["[object Int32Array]"]=i["[object Uint8Array]"]=i["[object Uint8ClampedArray]"]=i["[object Uint16Array]"]=i["[object Uint32Array]"]=!0,i["[object Arguments]"]=i["[object Array]"]=i["[object ArrayBuffer]"]=i["[object Boolean]"]=i["[object DataView]"]=i["[object Date]"]=i["[object Error]"]=i["[object Function]"]=i["[object Map]"]=i["[object Number]"]=i["[object Object]"]=i["[object RegExp]"]=i["[object Set]"]=i["[object String]"]=i["[object WeakMap]"]=!1,e.exports=function(e){return o(e)&&a(e.length)&&!!i[n(e)]}},function(e,t,r){var n=r(13),a=r(29);e.exports=function(e){return n(e,a(e))}},function(e,t){e.exports=function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}},function(e,t,r){var n=r(7),a=r(42),o=r(131),i=Object.prototype.hasOwnProperty;e.exports=function(e){if(!n(e))return o(e);var t=a(e),r=[];for(var s in e)("constructor"!=s||!t&&i.call(e,s))&&r.push(s);return r}},function(e,t){e.exports=function(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t}},function(e,t){e.exports=function(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)}},function(e,t,r){var n=r(134),a=r(58),o=r(46),i=a?function(e,t){return a(e,"toString",{configurable:!0,enumerable:!1,value:n(t),writable:!0})}:o;e.exports=i},function(e,t){e.exports=function(e){return function(){return e}}},function(e,t){var r=800,n=16,a=Date.now;e.exports=function(e){var t=0,o=0;return function(){var i=a(),s=n-(i-o);if(o=i,s>0){if(++t>=r)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(15),o=r(10),i=r(30),s=r(7);e.exports=function(e,t,r){if(!s(r))return!1;var u=n(t);return!!("number"==u?o(r)&&i(t,r.length):"string"==u&&t in r)&&a(r[t],e)}},function(e,t){var r="__lodash_hash_undefined__";e.exports=function(e){return this.__data__.set(e,r),this}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t,r){var n=r(75);e.exports=function(e,t){return!!(null==e?0:e.length)&&n(e,t,0)>-1}},function(e,t){e.exports=function(e){return e!=e}},function(e,t){e.exports=function(e,t,r){for(var n=r-1,a=e.length;++n<a;)if(e[n]===t)return n;return-1}},function(e,t){e.exports=function(e,t,r){for(var n=-1,a=null==e?0:e.length;++n<a;)if(r(t,e[n]))return!0;return!1}},function(e,t,r){var n=r(78),a=r(144),o=r(47),i=n&&1/o(new n([,-0]))[1]==1/0?function(e){return new n(e)}:a;e.exports=i},function(e,t){e.exports=function(){}},function(e,t,r){var n=r(146),a=r(158),o=r(85);e.exports=function(e){var t=a(e);return 1==t.length&&t[0][2]?o(t[0][0],t[0][1]):function(r){return r===e||n(r,e,t)}}},function(e,t,r){var n=r(20),a=r(79),o=1,i=2;e.exports=function(e,t,r,s){var u=r.length,c=u,l=!s;if(null==e)return!c;for(e=Object(e);u--;){var p=r[u];if(l&&p[2]?p[1]!==e[p[0]]:!(p[0]in e))return!1}for(;++u<c;){var f=(p=r[u])[0],y=e[f],h=p[1];if(l&&p[2]){if(void 0===y&&!(f in e))return!1}else{var d=new n;if(s)var v=s(y,h,f,e,t,d);if(!(void 0===v?a(h,y,o|i,s,d):v))return!1}}return!0}},function(e,t,r){var n=r(20),a=r(80),o=r(149),i=r(151),s=r(32),u=r(3),c=r(27),l=r(44),p=1,f="[object Arguments]",y="[object Array]",h="[object Object]",d=Object.prototype.hasOwnProperty;e.exports=function(e,t,r,v,m,g){var b=u(e),w=u(t),x=b?y:s(e),k=w?y:s(t),S=(x=x==f?h:x)==h,R=(k=k==f?h:k)==h,P=x==k;if(P&&c(e)){if(!c(t))return!1;b=!0,S=!1}if(P&&!S)return g||(g=new n),b||l(e)?a(e,t,r,v,m,g):o(e,t,x,r,v,m,g);if(!(r&p)){var O=S&&d.call(e,"__wrapped__"),_=R&&d.call(t,"__wrapped__");if(O||_){var j=O?e.value():e,I=_?t.value():t;return g||(g=new n),m(j,I,r,v,g)}}return!!P&&(g||(g=new n),i(e,t,r,v,m,g))}},function(e,t){e.exports=function(e,t){for(var r=-1,n=null==e?0:e.length;++r<n;)if(t(e[r],r,e))return!0;return!1}},function(e,t,r){var n=r(12),a=r(62),o=r(15),i=r(80),s=r(150),u=r(47),c=1,l=2,p="[object Boolean]",f="[object Date]",y="[object Error]",h="[object Map]",d="[object Number]",v="[object RegExp]",m="[object Set]",g="[object String]",b="[object Symbol]",w="[object ArrayBuffer]",x="[object DataView]",k=n?n.prototype:void 0,S=k?k.valueOf:void 0;e.exports=function(e,t,r,n,k,R,P){switch(r){case x:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case w:return!(e.byteLength!=t.byteLength||!R(new a(e),new a(t)));case p:case f:case d:return o(+e,+t);case y:return e.name==t.name&&e.message==t.message;case v:case g:return e==t+"";case h:var O=s;case m:var _=n&c;if(O||(O=u),e.size!=t.size&&!_)return!1;var j=P.get(e);if(j)return j==t;n|=l,P.set(e,t);var I=i(O(e),O(t),n,k,R,P);return P.delete(e),I;case b:if(S)return S.call(e)==S.call(t)}return!1}},function(e,t){e.exports=function(e){var t=-1,r=Array(e.size);return e.forEach((function(e,n){r[++t]=[n,e]})),r}},function(e,t,r){var n=r(81),a=1,o=Object.prototype.hasOwnProperty;e.exports=function(e,t,r,i,s,u){var c=r&a,l=n(e),p=l.length;if(p!=n(t).length&&!c)return!1;for(var f=p;f--;){var y=l[f];if(!(c?y in t:o.call(t,y)))return!1}var h=u.get(e);if(h&&u.get(t))return h==t;var d=!0;u.set(e,t),u.set(t,e);for(var v=c;++f<p;){var m=e[y=l[f]],g=t[y];if(i)var b=c?i(g,m,y,t,e,u):i(m,g,y,e,t,u);if(!(void 0===b?m===g||s(m,g,r,i,u):b)){d=!1;break}v||(v="constructor"==y)}if(d&&!v){var w=e.constructor,x=t.constructor;w!=x&&"constructor"in e&&"constructor"in t&&!("function"==typeof w&&w instanceof w&&"function"==typeof x&&x instanceof x)&&(d=!1)}return u.delete(e),u.delete(t),d}},function(e,t){e.exports=function(e,t){for(var r=-1,n=null==e?0:e.length,a=0,o=[];++r<n;){var i=e[r];t(i,r,e)&&(o[a++]=i)}return o}},function(e,t,r){var n=r(42),a=r(154),o=Object.prototype.hasOwnProperty;e.exports=function(e){if(!n(e))return a(e);var t=[];for(var r in Object(e))o.call(e,r)&&"constructor"!=r&&t.push(r);return t}},function(e,t,r){var n=r(64)(Object.keys,Object);e.exports=n},function(e,t,r){var n=r(9)(r(6),"DataView");e.exports=n},function(e,t,r){var n=r(9)(r(6),"Promise");e.exports=n},function(e,t,r){var n=r(9)(r(6),"WeakMap");e.exports=n},function(e,t,r){var n=r(84),a=r(14);e.exports=function(e){for(var t=a(e),r=t.length;r--;){var o=t[r],i=e[o];t[r]=[o,i,n(i)]}return t}},function(e,t,r){var n=r(79),a=r(160),o=r(166),i=r(51),s=r(84),u=r(85),c=r(18),l=1,p=2;e.exports=function(e,t){return i(e)&&s(t)?u(c(e),t):function(r){var i=a(r,e);return void 0===i&&i===t?o(r,e):n(t,i,l|p)}}},function(e,t,r){var n=r(50);e.exports=function(e,t,r){var a=null==e?void 0:n(e,t);return void 0===a?r:a}},function(e,t,r){var n=r(162),a=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,o=/\\(\\)?/g,i=n((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(a,(function(e,r,n,a){t.push(n?a.replace(o,"$1"):r||e)})),t}));e.exports=i},function(e,t,r){var n=r(163),a=500;e.exports=function(e){var t=n(e,(function(e){return r.size===a&&r.clear(),e})),r=t.cache;return t}},function(e,t,r){var n=r(37),a="Expected a function";function o(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError(a);var r=function r(){var n=arguments,a=t?t.apply(this,n):n[0],o=r.cache;if(o.has(a))return o.get(a);var i=e.apply(this,n);return r.cache=o.set(a,i)||o,i};return r.cache=new(o.Cache||n),r}o.Cache=n,e.exports=o},function(e,t,r){var n=r(165);e.exports=function(e){return null==e?"":n(e)}},function(e,t,r){var n=r(12),a=r(31),o=r(3),i=r(17),s=1/0,u=n?n.prototype:void 0,c=u?u.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(o(t))return a(t,e)+"";if(i(t))return c?c.call(t):"";var r=t+"";return"0"==r&&1/t==-s?"-0":r}},function(e,t,r){var n=r(167),a=r(168);e.exports=function(e,t){return null!=e&&a(e,t,n)}},function(e,t){e.exports=function(e,t){return null!=e&&t in Object(e)}},function(e,t,r){var n=r(33),a=r(26),o=r(3),i=r(30),s=r(43),u=r(18);e.exports=function(e,t,r){for(var c=-1,l=(t=n(t,e)).length,p=!1;++c<l;){var f=u(t[c]);if(!(p=null!=e&&r(e,f)))break;e=e[f]}return p||++c!=l?p:!!(l=null==e?0:e.length)&&s(l)&&i(f,l)&&(o(e)||a(e))}},function(e,t,r){var n=r(170),a=r(171),o=r(51),i=r(18);e.exports=function(e){return o(e)?n(i(e)):a(e)}},function(e,t){e.exports=function(e){return function(t){return null==t?void 0:t[e]}}},function(e,t,r){var n=r(50);e.exports=function(e){return function(t){return n(t,e)}}},function(e,t,r){var n=r(173),a=r(10);e.exports=function(e,t){var r=-1,o=a(e)?Array(e.length):[];return n(e,(function(e,n,a){o[++r]=t(e,n,a)})),o}},function(e,t,r){var n=r(174),a=r(175)(n);e.exports=a},function(e,t,r){var n=r(59),a=r(14);e.exports=function(e,t){return e&&n(e,t,a)}},function(e,t,r){var n=r(10);e.exports=function(e,t){return function(r,a){if(null==r)return r;if(!n(r))return e(r,a);for(var o=r.length,i=t?o:-1,s=Object(r);(t?i--:++i<o)&&!1!==a(s[i],i,s););return r}}},function(e,t,r){var n=r(16),a=r(10),o=r(14);e.exports=function(e){return function(t,r,i){var s=Object(t);if(!a(t)){var u=n(r,3);t=o(t),r=function(e){return u(s[e],e,s)}}var c=e(t,r,i);return c>-1?s[u?t[c]:c]:void 0}}},function(e,t,r){var n=r(76),a=r(16),o=r(178),i=Math.max;e.exports=function(e,t,r){var s=null==e?0:e.length;if(!s)return-1;var u=null==r?0:o(r);return u<0&&(u=i(s+u,0)),n(e,a(t,3),u)}},function(e,t,r){var n=r(179);e.exports=function(e){var t=n(e),r=t%1;return t==t?r?t-r:t:0}},function(e,t,r){var n=r(180),a=1/0,o=17976931348623157e292;e.exports=function(e){return e?(e=n(e))===a||e===-a?(e<0?-1:1)*o:e==e?e:0:0===e?e:0}},function(e,t,r){var n=r(7),a=r(17),o=NaN,i=/^\s+|\s+$/g,s=/^[-+]0x[0-9a-f]+$/i,u=/^0b[01]+$/i,c=/^0o[0-7]+$/i,l=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(a(e))return o;if(n(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=n(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(i,"");var r=u.test(e);return r||c.test(e)?l(e.slice(2),r?2:8):s.test(e)?o:+e}},function(e,t,r){var n=r(182);e.exports=function(e,t){return e&&e.length&&t&&t.length?n(e,t):e}},function(e,t,r){var n=r(31),a=r(75),o=r(183),i=r(28),s=r(40),u=Array.prototype.splice;e.exports=function(e,t,r,c){var l=c?o:a,p=-1,f=t.length,y=e;for(e===t&&(t=s(t)),r&&(y=n(e,i(r)));++p<f;)for(var h=0,d=t[p],v=r?r(d):d;(h=l(y,v,h,c))>-1;)y!==e&&u.call(y,h,1),u.call(e,h,1);return e}},function(e,t){e.exports=function(e,t,r,n){for(var a=r-1,o=e.length;++a<o;)if(n(e[a],t))return a;return-1}},function(e,t,r){var n=r(86),a=r(30),o=Array.prototype.splice;e.exports=function(e,t){for(var r=e?t.length:0,i=r-1;r--;){var s=t[r];if(r==i||s!==u){var u=s;a(s)?o.call(e,s,1):n(e,s)}}return e}},function(e,t){e.exports=function(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}},function(e,t,r){var n=r(50),a=r(187);e.exports=function(e,t){return t.length<2?e:n(e,a(t,0,-1))}},function(e,t){e.exports=function(e,t,r){var n=-1,a=e.length;t<0&&(t=-t>a?0:a+t),(r=r>a?a:r)<0&&(r+=a),a=t>r?0:r-t>>>0,t>>>=0;for(var o=Array(a);++n<a;)o[n]=e[n+t];return o}},function(e,t,r){var n=r(20),a=r(189),o=r(67),i=r(190),s=r(191),u=r(60),c=r(40),l=r(192),p=r(193),f=r(81),y=r(88),h=r(32),d=r(194),v=r(195),m=r(63),g=r(3),b=r(27),w=r(199),x=r(7),k=r(201),S=r(14),R=1,P=2,O=4,_="[object Arguments]",j="[object Function]",I="[object GeneratorFunction]",D="[object Object]",C={};C[_]=C["[object Array]"]=C["[object ArrayBuffer]"]=C["[object DataView]"]=C["[object Boolean]"]=C["[object Date]"]=C["[object Float32Array]"]=C["[object Float64Array]"]=C["[object Int8Array]"]=C["[object Int16Array]"]=C["[object Int32Array]"]=C["[object Map]"]=C["[object Number]"]=C[D]=C["[object RegExp]"]=C["[object Set]"]=C["[object String]"]=C["[object Symbol]"]=C["[object Uint8Array]"]=C["[object Uint8ClampedArray]"]=C["[object Uint16Array]"]=C["[object Uint32Array]"]=!0,C["[object Error]"]=C[j]=C["[object WeakMap]"]=!1,e.exports=function e(t,r,E,A,T,M){var K,F=r&R,L=r&P,U=r&O;if(E&&(K=T?E(t,A,T,M):E(t)),void 0!==K)return K;if(!x(t))return t;var N=g(t);if(N){if(K=d(t),!F)return c(t,K)}else{var B=h(t),V=B==j||B==I;if(b(t))return u(t,F);if(B==D||B==_||V&&!T){if(K=L||V?{}:m(t),!F)return L?p(t,s(K,t)):l(t,i(K,t))}else{if(!C[B])return T?t:{};K=v(t,B,F)}}M||(M=new n);var H=M.get(t);if(H)return H;M.set(t,K),k(t)?t.forEach((function(n){K.add(e(n,r,E,n,t,M))})):w(t)&&t.forEach((function(n,a){K.set(a,e(n,r,E,a,t,M))}));var W=U?L?y:f:L?keysIn:S,z=N?void 0:W(t);return a(z||t,(function(n,a){z&&(n=t[a=n]),o(K,a,e(n,r,E,a,t,M))})),K}},function(e,t){e.exports=function(e,t){for(var r=-1,n=null==e?0:e.length;++r<n&&!1!==t(e[r],r,e););return e}},function(e,t,r){var n=r(13),a=r(14);e.exports=function(e,t){return e&&n(t,a(t),e)}},function(e,t,r){var n=r(13),a=r(29);e.exports=function(e,t){return e&&n(t,a(t),e)}},function(e,t,r){var n=r(13),a=r(49);e.exports=function(e,t){return n(e,a(e),t)}},function(e,t,r){var n=r(13),a=r(87);e.exports=function(e,t){return n(e,a(e),t)}},function(e,t){var r=Object.prototype.hasOwnProperty;e.exports=function(e){var t=e.length,n=new e.constructor(t);return t&&"string"==typeof e[0]&&r.call(e,"index")&&(n.index=e.index,n.input=e.input),n}},function(e,t,r){var n=r(39),a=r(196),o=r(197),i=r(198),s=r(61),u="[object Boolean]",c="[object Date]",l="[object Map]",p="[object Number]",f="[object RegExp]",y="[object Set]",h="[object String]",d="[object Symbol]",v="[object ArrayBuffer]",m="[object DataView]",g="[object Float32Array]",b="[object Float64Array]",w="[object Int8Array]",x="[object Int16Array]",k="[object Int32Array]",S="[object Uint8Array]",R="[object Uint8ClampedArray]",P="[object Uint16Array]",O="[object Uint32Array]";e.exports=function(e,t,r){var _=e.constructor;switch(t){case v:return n(e);case u:case c:return new _(+e);case m:return a(e,r);case g:case b:case w:case x:case k:case S:case R:case P:case O:return s(e,r);case l:return new _;case p:case h:return new _(e);case f:return o(e);case y:return new _;case d:return i(e)}}},function(e,t,r){var n=r(39);e.exports=function(e,t){var r=t?n(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}},function(e,t){var r=/\w*$/;e.exports=function(e){var t=new e.constructor(e.source,r.exec(e));return t.lastIndex=e.lastIndex,t}},function(e,t,r){var n=r(12),a=n?n.prototype:void 0,o=a?a.valueOf:void 0;e.exports=function(e){return o?Object(o.call(e)):{}}},function(e,t,r){var n=r(200),a=r(28),o=r(45),i=o&&o.isMap,s=i?a(i):n;e.exports=s},function(e,t,r){var n=r(32),a=r(8),o="[object Map]";e.exports=function(e){return a(e)&&n(e)==o}},function(e,t,r){var n=r(202),a=r(28),o=r(45),i=o&&o.isSet,s=i?a(i):n;e.exports=s},function(e,t,r){var n=r(32),a=r(8),o="[object Set]";e.exports=function(e){return a(e)&&n(e)==o}},function(e,t,r){var n=r(65);e.exports=function(e){return n(e)?void 0:e}},function(e,t,r){var n=r(205),a=r(71),o=r(72);e.exports=function(e){return o(a(e,void 0,n),e+"")}},function(e,t,r){var n=r(206);e.exports=function(e){return(null==e?0:e.length)?n(e,1):[]}},function(e,t,r){var n=r(48),a=r(207);e.exports=function e(t,r,o,i,s){var u=-1,c=t.length;for(o||(o=a),s||(s=[]);++u<c;){var l=t[u];r>0&&o(l)?r>1?e(l,r-1,o,i,s):n(s,l):i||(s[s.length]=l)}return s}},function(e,t,r){var n=r(12),a=r(26),o=r(3),i=n?n.isConcatSpreadable:void 0;e.exports=function(e){return o(e)||a(e)||!!(i&&e&&e[i])}},function(e,t,r){var n=r(17),a=4294967294,o=Math.floor,i=Math.min;e.exports=function(e,t,r,s){t=r(t);for(var u=0,c=null==e?0:e.length,l=t!=t,p=null===t,f=n(t),y=void 0===t;u<c;){var h=o((u+c)/2),d=r(e[h]),v=void 0!==d,m=null===d,g=d==d,b=n(d);if(l)var w=s||g;else w=y?g&&(s||v):p?g&&v&&(s||!m):f?g&&v&&!m&&(s||!b):!m&&!b&&(s?d<=t:d<t);w?u=h+1:c=h}return i(c,a)}},function(e,t,r){"use strict";r.r(t);var n={};r.r(n),r.d(n,"Migration20200115",(function(){return di}));var a=r(0);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var i={Item:"SF|Item",RootKey:"SN|RootKey|NoSync",ItemsKey:"SN|ItemsKey",EncryptedStorage:"SN|EncryptedStorage",Note:"Note",Tag:"Tag",SmartTag:"SN|SmartTag",Component:"SN|Component",Editor:"SN|Editor",ActionsExtension:"Extension",UserPrefs:"SN|UserPreferences",Privileges:"SN|Privileges",HistorySession:"SN|HistorySession",Theme:"SN|Theme",Mfa:"SF|MFA",ServerExtension:"SF|Extension",FilesafeCredentials:"SN|FileSafe|Credentials",FilesafeFileMetadata:"SN|FileSafe|FileMetadata",FilesafeIntegration:"SN|FileSafe|Integration",ExtensionRepo:"SN|ExtensionRepo"};function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var u=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.payloads,n=void 0===r?[]:r,a=t.source;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.source=a,this.payloadMap={},this.allPayloads=n;var o=!0,i=!1,s=void 0;try{for(var u,c=n[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){var l=u.value;this.payloadMap[l.uuid]=l}}catch(e){i=!0,s=e}finally{try{o||null==c.return||c.return()}finally{if(i)throw s}}Object.freeze(this)}var t,r,n;return t=e,(r=[{key:"findPayload",value:function(e){return this.payloadMap[e]}},{key:"concat",value:function(t){var r=t.allPayloads.slice(),n=!0,o=!1,i=void 0;try{for(var s,u=this.allPayloads[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var c=s.value;Object(a.g)(t.allPayloads,"uuid",c.uuid)||r.push(c)}}catch(e){o=!0,i=e}finally{try{n||null==u.return||u.return()}finally{if(o)throw i}}return new e({payloads:r,source:this.source})}},{key:"payloadsThatReferencePayload",value:function(e){for(var t=[],r=0,n=Object.keys(this.payloadMap);r<n.length;r++){var o=n[r],i=this.findPayload(o);i.errorDecrypting||Object(a.g)(i.content.references,"uuid",e.uuid)&&t.push(i)}return t}}])&&s(t.prototype,r),n&&s(t,n),e}();function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var l=function(){function e(t){var r=t.collections;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.collections=r,Object.freeze(this)}var t,r,n;return t=e,(r=[{key:"collectionForSource",value:function(e){return this.collections.find((function(t){return t.source===e}))}}])&&c(t.prototype,r),n&&c(t,n),e}();function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var f=function(){function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.keypath=t,this.operator=r,this.value=n,e.IsRecursiveOperator(this.operator)&&(this.value=this.value.map((function(t){return Array.isArray(t)?e.FromArray(t):t})))}var t,r,n;return t=e,n=[{key:"CompoundPredicate",value:function(t){return new e("ignored","and",t)}},{key:"FromArray",value:function(t){return new e(t[0],t[1],t[2])}},{key:"ObjectSatisfiesPredicate",value:function(t,r){if(Array.isArray(r)&&(r=this.FromArray(r)),e.IsRecursiveOperator(r.operator)){if("and"===r.operator){var n=!0,a=!1,o=void 0;try{for(var i,s=r.value[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var u=i.value;if(!this.ObjectSatisfiesPredicate(t,u))return!1}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return!0}if("or"===r.operator){var c=!0,l=!1,p=void 0;try{for(var f,y=r.value[Symbol.iterator]();!(c=(f=y.next()).done);c=!0){var h=f.value;if(this.ObjectSatisfiesPredicate(t,h))return!0}}catch(e){l=!0,p=e}finally{try{c||null==y.return||y.return()}finally{if(l)throw p}}return!1}}var d=r.value;"string"==typeof d&&d.includes(".ago")&&(d=this.DateFromString(d));var v=r.keypath.split(".").reduce((function(e,t){return e&&e[t]}),t),m=[!1,"",null,void 0,NaN];return void 0===v?"!="===r.operator?!m.includes(r.value):m.includes(r.value):"="===r.operator?Array.isArray(v)?JSON.stringify(v)===JSON.stringify(d):v===d:"!="===r.operator?Array.isArray(v)?JSON.stringify(v)!==JSON.stringify(d):v!==d:"<"===r.operator?v<d:">"===r.operator?v>d:"<="===r.operator?v<=d:">="===r.operator?v>=d:"startsWith"===r.operator?v.startsWith(d):"in"===r.operator?-1!==d.indexOf(v):"includes"===r.operator?this.resolveIncludesPredicate(v,d):"matches"===r.operator&&new RegExp(d).test(v)}},{key:"resolveIncludesPredicate",value:function(t,r){if("string"==typeof r)return t.includes(r);var n;n=Array.isArray(r)?e.FromArray(r):r;var a=!0,o=!1,i=void 0;try{for(var s,u=t[Symbol.iterator]();!(a=(s=u.next()).done);a=!0){var c=s.value;if(this.ObjectSatisfiesPredicate(c,n))return!0}}catch(e){o=!0,i=e}finally{try{a||null==u.return||u.return()}finally{if(o)throw i}}return!1}},{key:"ItemSatisfiesPredicate",value:function(t,r){return Array.isArray(r)&&(r=e.FromArray(r)),this.ObjectSatisfiesPredicate(t,r)}},{key:"ItemSatisfiesPredicates",value:function(e,t){var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(!this.ItemSatisfiesPredicate(e,s))return!1}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}return!0}},{key:"DateFromString",value:function(e){var t=e.split("."),r=t[1],n=new Date,a=parseInt(t[0]);return"days"===r?n.setDate(n.getDate()-a):"hours"===r&&n.setHours(n.getHours()-a),n}},{key:"IsRecursiveOperator",value:function(e){return["and","or"].includes(e)}}],(r=null)&&p(t.prototype,r),n&&p(t,n),e}(),y={FullSyncCompleted:"sync:full-completed",SingleSyncCompleted:"sync:single-completed",DownloadFirstSyncCompleted:"sync:initial-completed",SyncTakingTooLong:"sync:taking-too-long",SyncError:"sync:error",SyncException:"sync:sync-exception",InvalidSession:"sync:invalid-session",MajorDataChange:"major-data-change",LocalDataIncrementalLoad:"local-data-incremental-load",EnterOutOfSync:"enter-out-of-sync",ExitOutOfSync:"exit-out-of-sync"};function h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var d={SignedIn:2,SignedOut:3,CompletedSync:5,FailedSync:6,HighLatencySync:7,EnteredOutOfSync:8,ExitedOutOfSync:9,Started:10,Launched:11,KeyStatusChanged:12};var v=0,m=.5,g=.9,b=1,w=1.1,x=1.2,k=1.3,S=3;function R(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var P={Web:1,Desktop:2,Mobile:3},O={Ios:1,Android:2,MacWeb:3,MacDesktop:4,WindowsWeb:5,WindowsDesktop:6,LinuxWeb:7,LinuxDesktop:8};function _(e){return{"mac-web":O.MacWeb,"mac-desktop":O.MacDesktop,"linux-web":O.LinuxWeb,"linux-desktop":O.LinuxDesktop,"windows-web":O.WindowsWeb,"windows-desktop":O.WindowsDesktop,ios:O.Ios,android:O.Android}[e]}function j(e){return e===P.Web||e===P.Desktop}function I(e){return e===P.Mobile}var D={LocalPasscode:1,AccountPassword:2,Biometric:3},C={RootKeyParams:"ROOT_KEY_PARAMS",WrappedRootKey:"WRAPPED_ROOT_KEY",RootKeyWrapperKeyParams:"ROOT_KEY_WRAPPER_KEY_PARAMS",Session:"session",User:"user",ServerHost:"server",LegacyUuid:"uuid",LastSyncToken:"syncToken",PaginationToken:"cursorToken",StorageObject:"storage",BiometricPrefs:"biometrics_prefs",MobilePasscodeTiming:"passcode_timing",PrivilegesExpirey:"SessionExpiresAtKey",PrivilegesSessionLength:"SessionLengthKey",SessionHistoryPersistable:"sessionHistory_persist",SessionHistoryRevisions:"sessionHistory_revisions",SessionHistoryOptimize:"sessionHistory_autoOptimize"};function E(e,t){return e?"".concat(e,"-").concat(t):t}var A="org.standardnotes.sn";function T(e){var t=e.leftContent,r=e.rightContent,n=e.keysToIgnore,o=e.appDataKeysToIgnore;if((t=JSON.parse(JSON.stringify(t))).appData){var i=t.appData[A];Object(a.s)(i,o),i?0===Object.keys(i).length&&delete t.appData:delete t.appData}if(Object(a.s)(t,n),(r=JSON.parse(JSON.stringify(r))).appData){var s=r.appData[A];Object(a.s)(s,o),s?0===Object.keys(s).length&&delete r.appData:delete r.appData}return Object(a.s)(r,n),JSON.stringify(t)===JSON.stringify(r)}function M(e,t,r){return r||(r=[]),!T({leftContent:e.content,rightContent:t.content,keysToIgnore:e.contentKeysToIgnoreWhenCheckingEquality().concat(r),appDataKeysToIgnore:e.appDatacontentKeysToIgnoreWhenCheckingEquality()})}function K(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var F=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n;return t=e,n=[{key:"SetGenerators",value:function(e){var t=e.syncImpl,r=e.asyncImpl;this.syncUuidFunc=t,this.asyncUuidFunc=r}},{key:"canGenSync",value:function(){return!Object(a.l)(this.syncUuidFunc)}},{key:"GenerateUuid",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.syncUuidFunc){e.next=4;break}return e.abrupt("return",this.syncUuidFunc());case 4:return e.abrupt("return",this.asyncUuidFunc());case 5:case"end":return e.stop()}}),null,this)}},{key:"GenerateUuidSynchronously",value:function(){return this.syncUuidFunc()}}],(r=null)&&K(t.prototype,r),n&&K(t,n),e}();function L(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function U(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var N=1,B=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.content={references:[],appData:L({},A,{})},this.resetLocalReferencePointers(),t){if(!t.isPayload)throw"Attempting to construct SNItem from non-payload object ".concat(t,".");this.updateFromPayload(t)}this.uuid||F.canGenSync()&&(this.uuid=F.GenerateUuidSynchronously())}var t,r,n;return t=e,(r=[{key:"payloadRepresentation",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.override;return ua({object:this,override:t})}},{key:"populateDefaultContentValues",value:function(){this.errorDecrypting||this.deleted||(this.content.references||(this.content.references=[]),this.content.appData||(this.content.appData=L({},A,{})))}},{key:"initUUID",value:function(){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.uuid){t.next=4;break}return t.next=3,regeneratorRuntime.awrap(e.GenerateUuid());case 3:this.uuid=t.sent;case 4:case"end":return t.stop()}}),null,this)}},{key:"updateFromPayload",value:function(e){if(e){var t=[ae.Content],r=!0,n=!1,o=void 0;try{for(var i,s=e.fields()[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var u=i.value;if(!Object(a.j)(this,u)){var c=e[u];if(t.includes(u)){var l=Object(a.a)(c||null);this[u]=l}else this[u]=c}}}catch(e){n=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw o}}this.content?this.mapContentToLocalProperties(this.content):!0===e.deleted&&this.handleDeletedContent(),this.dirtiedDate&&"string"==typeof this.dirtiedDate&&(this.dirtiedDate=new Date(this.dirtiedDate)),this.lastSyncBegan&&"string"==typeof this.lastSyncBegan&&(this.lastSyncBegan=new Date(this.lastSyncBegan)),this.lastSyncEnd&&"string"==typeof this.lastSyncEnd&&(this.lastSyncEnd=new Date(this.lastSyncEnd)),this.created_at?this.created_at=new Date(this.created_at):this.created_at=new Date,this.updated_at?this.updated_at=new Date(this.updated_at):this.updated_at=new Date(0),this._client_updated_at=null,this.populateDefaultContentValues()}}},{key:"mapContentToLocalProperties",value:function(e){}},{key:"collapseContent",value:function(){var e=this.structureParams();return Object(a.e)(this.content,e),e}},{key:"structureParams",value:function(){return this.getContentCopy()}},{key:"handleDeletedContent",value:function(){}},{key:"setDirty",value:function(e){var t=e.dirty,r=e.updateClientDate;if(!e.authorized)throw"Do not call setDirty directly. Use modelManager.setItemDirty";this.dirty=t,this.dirtiedDate=new Date,t&&r?this.client_updated_at=new Date:this.hasRawClientUpdatedAtValue()||(this.client_updated_at=new Date(this.updated_at)),this.collapseContent()}},{key:"updateLocalRelationships",value:function(){for(var e=this.content.references.map((function(e){return e.uuid})),t=0,r=Object.keys(this._referencedItems);t<r.length;t++){var n=r[t],a=this._referencedItems[n];e.includes(a.uuid)||(delete this._referencedItems[n],a.setIsNoLongerReferencedBy(this))}}},{key:"addItemAsRelationship",value:function(e){if(e.setIsBeingReferencedBy(this),this._referencedItems[e.uuid]||(this._referencedItems[e.uuid]=e),!this.hasRelationshipWithItem(e)){var t=this.content.references||[];t.push({uuid:e.uuid,content_type:e.content_type}),this.content.references=t}}},{key:"removeItemAsRelationship",value:function(e){e.setIsNoLongerReferencedBy(this),this.removeReferenceWithUuid(e.uuid),delete this._referencedItems[e.uuid]}},{key:"setIsBeingReferencedBy",value:function(e){this._referencingItems[e.uuid]||(this._referencingItems[e.uuid]=e)}},{key:"setIsNoLongerReferencedBy",value:function(e){delete this._referencingItems[e.uuid]}},{key:"removeReferenceWithUuid",value:function(e){var t=this.content.references||[];t=t.filter((function(t){return t.uuid!==e})),this.content.references=t,delete this._referencedItems[e]}},{key:"hasRelationshipWithItem",value:function(e){var t=this.content.references.find((function(t){return t.uuid===e.uuid}));return!Object(a.l)(t)}},{key:"isBeingRemovedLocally",value:function(){for(var e=0,t=Object.keys(this._referencedItems);e<t.length;e++){var r=t[e];this._referencedItems[r].setIsNoLongerReferencedBy(this)}}},{key:"resetLocalReferencePointers",value:function(){this._referencingItems={},this._referencedItems={}}},{key:"didCompleteMapping",value:function(e){}},{key:"setDomainDataItem",value:function(e,t,r){if(r){if(!this.errorDecrypting){this.content.appData||(this.content.appData={});var n=this.content.appData[r];n||(n={}),n[e]=t,this.content.appData[r]=n}}else console.error("DEFAULT_APP_DOMAIN needs to be set.")}},{key:"getDomainDataItem",value:function(e,t){if(t){if(!this.errorDecrypting){this.content.appData||(this.content.appData={});var r=this.content.appData[t];return r?r[e]:null}}else console.error("DEFAULT_APP_DOMAIN needs to be set.")}},{key:"setAppDataItem",value:function(e,t){this.setDomainDataItem(e,t,A)}},{key:"getAppDataItem",value:function(e){return this.getDomainDataItem(e,A)}},{key:"hasRawClientUpdatedAtValue",value:function(){return null!=this.getAppDataItem("client_updated_at")}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["conflict_of"]}},{key:"appDatacontentKeysToIgnoreWhenCheckingEquality",value:function(){return["client_updated_at"]}},{key:"getContentCopy",value:function(){return JSON.parse(JSON.stringify(this.content))}},{key:"strategyWhenConflictingWithItem",value:function(e){var t=e.item;return this.errorDecrypting?Rn.KeepLeftDuplicateRight:this.isSingleton?Rn.KeepLeft:this.deleted||t.deleted?Rn.KeepRight:M(this,t)?M(this,t,["references"])?Rn.KeepLeftDuplicateRight:Rn.KeepLeftMergeRefs:Rn.KeepRight}},{key:"isItemContentEqualWith",value:function(e){return T({leftContent:this.content,rightContent:e.content,keysToIgnore:this.contentKeysToIgnoreWhenCheckingEquality(),appDataKeysToIgnore:this.appDatacontentKeysToIgnoreWhenCheckingEquality()})}},{key:"satisfiesPredicate",value:function(e){return f.ItemSatisfiesPredicate(this,e)}},{key:"createdAtString",value:function(){return this.dateToLocalizedString(this.created_at)}},{key:"updatedAtString",value:function(){return this.dateToLocalizedString(this.client_updated_at)}},{key:"updatedAtTimestamp",value:function(){return this.updated_at.getTime()}},{key:"dateToLocalizedString",value:function(t){if("undefined"!=typeof Intl&&Intl.DateTimeFormat){if(!e.sharedDateFormatter){var r=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language;e.sharedDateFormatter=new Intl.DateTimeFormat(r,{year:"numeric",month:"short",day:"2-digit",weekday:"long",hour:"2-digit",minute:"2-digit"})}return e.sharedDateFormatter.format(t)}return t.toDateString()+" "+t.toLocaleTimeString()}},{key:"isItem",get:function(){return!0}},{key:"referencedItemsCount",get:function(){return Object.keys(this._referencedItems).length}},{key:"referencingItemsCount",get:function(){return Object.keys(this._referencingItems).length}},{key:"allReferencingItems",get:function(){var e=this;return Object.keys(this._referencingItems).map((function(t){return e._referencingItems[t]}))}},{key:"pinned",get:function(){return this.getAppDataItem("pinned")}},{key:"archived",get:function(){return this.getAppDataItem("archived")}},{key:"locked",get:function(){return this.getAppDataItem("locked")}},{key:"client_updated_at",get:function(){if(!this._client_updated_at){var e=this.getAppDataItem("client_updated_at");this._client_updated_at=e?new Date(e):new Date(this.updated_at)}return this._client_updated_at},set:function(e){this._client_updated_at=e,this.setAppDataItem("client_updated_at",e)}},{key:"neverSynced",get:function(){return!this.updated_at||0===this.updated_at.getTime()}},{key:"isSingleton",get:function(){return!1}},{key:"singletonPredicate",get:function(){throw"Must override SNItem.singletonPredicate"}},{key:"singletonStrategy",get:function(){return N}}])&&U(t.prototype,r),n&&U(t,n),e}(),V={V000Base64Decrypted:"000",V001:"001",V002:"002",V003:"003",V004:"004",VersionLength:3};function H(e,t){return Number(e)-Number(t)}var W={Sync:0,SyncDecrypted:1,LocalStorageEncrypted:2,LocalStorageDecrypted:3,LocalStoragePreferEncrypted:4,FileEncrypted:5,FileDecrypted:6,FilePreferEncrypted:7};function z(e){return e===W.LocalStorageEncrypted||e===W.LocalStorageDecrypted||e===W.LocalStoragePreferEncrypted}function q(e){return e===W.FileEncrypted||e===W.FileDecrypted||e===W.FilePreferEncrypted}function Y(e){return e===W.SyncDecrypted||e===W.LocalStorageDecrypted||e===W.FileDecrypted}function J(e){return e===W.Sync||e===W.LocalStorageEncrypted||e===W.FileEncrypted}function G(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Q(e,t,r){return t&&G(e.prototype,t),r&&G(e,r),e}var $=function(){function e(t){var r=t.uuid,n=t.content;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.uuid=r,this.content=Object(a.a)(n),this.content.version||(this.content.dataAuthenticationKey?this.content.version=V.V002:this.content.version=V.V001),!this.content.version)throw"Attempting to create key without version.";Object.freeze(this)}return Q(e,null,[{key:"Create",value:function(t){var r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(r=t.uuid,n=t.content,r){a.next=5;break}return a.next=4,regeneratorRuntime.awrap(F.GenerateUuid());case 4:r=a.sent;case 5:return a.abrupt("return",new e({uuid:r,content:n}));case 6:case"end":return a.stop()}}))}}]),Q(e,[{key:"compare",value:function(e){if(this.version!==e.version)return!1;var t=this.serverPassword&&e.serverPassword;return this.masterKey===e.masterKey&&(!t||this.serverPassword===e.serverPassword)}},{key:"getPersistableValue",value:function(){var e={version:this.version};return this.masterKey&&(e.masterKey=this.masterKey),this.dataAuthenticationKey&&(e.dataAuthenticationKey=this.dataAuthenticationKey),e}},{key:"version",get:function(){return this.content.version}},{key:"isRootKey",get:function(){return!0}},{key:"itemsKey",get:function(){return this.masterKey}},{key:"masterKey",get:function(){return this.content.masterKey}},{key:"serverPassword",get:function(){return this.content.serverPassword}},{key:"dataAuthenticationKey",get:function(){return this.content.dataAuthenticationKey}}],[{key:"contentType",value:function(){return i.RootKey}}]),e}();function X(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Z(e){return new ee(e)}var ee=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!Object(a.m)(t)||t.isKeyParamsObject)throw"Attempting to construct root key params with non-object";this.content=t}var t,r,n;return t=e,(r=[{key:"getPortableValue",value:function(){return H(this.version,V.V003)>=0?Object(a.r)(this.content,["pw_cost"]):this.content}},{key:"isKeyParamsObject",get:function(){return!0}},{key:"kdfIterations",get:function(){return this.content.pw_cost}},{key:"seed",get:function(){return this.content.pw_nonce}},{key:"identifier",get:function(){return this.content.identifier||this.content.email}},{key:"salt",get:function(){return this.content.pw_salt}},{key:"version",get:function(){return this.content.version}}])&&X(t.prototype,r),n&&X(t,n),e}(),te={EncryptedString:0,DecryptedBareObject:1,DecryptedBase64String:2},re=r(5);function ne(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var ae={Uuid:"uuid",ContentType:"content_type",ItemsKeyId:"items_key_id",EncItemKey:"enc_item_key",Content:"content",CreatedAt:"created_at",UpdatedAt:"updated_at",Deleted:"deleted",Legacy003AuthHash:"auth_hash",Legacy003AuthParams:"auth_params",Dirty:"dirty",DirtiedDate:"dirtiedDate",WaitingForKey:"waitingForKey",ErrorDecrypting:"errorDecrypting",ErrorDecryptingChanged:"errorDecryptingValueChanged",Dummy:"dummy",LastSyncBegan:"lastSyncBegan",LastSyncEnd:"lastSyncEnd"};function oe(e){return(oe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ie(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function se(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ue(e,t){return!t||"object"!==oe(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ce(e,t,r){return(ce="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=le(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function le(e){return(le=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function pe(e,t){return(pe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var fe="00000000000000000000000000000000",ye=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),ue(this,le(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&pe(e,t)}(t,e),r=t,a=[{key:"pwCost",value:function(){return 3e3}},{key:"versionString",value:function(){return V.V001}}],(n=[{key:"generateNewItemsKeyContent",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=3,regeneratorRuntime.awrap(this.crypto.generateRandomKey(256));case 3:return e=r.sent,t=this.constructor.versionString(),r.abrupt("return",{itemsKey:e,version:t});case 6:case"end":return r.stop()}}),null,this)}},{key:"createRootKey",value:function(e){var t,r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:return t=e.identifier,r=e.password,n=this.constructor.pwCost(),u.next=4,regeneratorRuntime.awrap(this.crypto.generateRandomKey(128));case 4:return a=u.sent,u.next=7,regeneratorRuntime.awrap(this.crypto.unsafeSha1(t+"SN"+a));case 7:return o=u.sent,u.next=10,regeneratorRuntime.awrap(this.deriveKey({password:r,pwSalt:o,pwCost:n}));case 10:return i=u.sent,s=Z({email:t,pw_cost:n,pw_nonce:a,pw_salt:o,version:V.V001}),u.abrupt("return",{key:i,keyParams:s});case 13:case"end":return u.stop()}}),null,this)}},{key:"computeRootKey",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(t=e.password,(r=e.keyParams).isKeyParamsObject){a.next=3;break}throw"Attempting to compute root key with non params object.";case 3:return a.next=5,regeneratorRuntime.awrap(this.deriveKey({password:t,pwSalt:r.salt,pwCost:r.kdfIterations}));case 5:return n=a.sent,a.abrupt("return",n);case 7:case"end":return a.stop()}}),null,this)}},{key:"decryptString",value:function(e,t){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",this.crypto.aes256CbcDecrypt(e,fe,t));case 1:case"end":return r.stop()}}),null,this)}},{key:"encryptString",value:function(e,t){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",this.crypto.aes256CbcEncrypt(e,fe,t));case 1:case"end":return r.stop()}}),null,this)}},{key:"generateEncryptionParameters",value:function(e){var r,n,a,o,i,s,u,c,l,p,f;return regeneratorRuntime.async((function(y){for(;;)switch(y.prev=y.next){case 0:if(n=e.payload,a=e.key,(o=e.format)!==te.DecryptedBareObject&&o!==te.DecryptedBase64String){y.next=3;break}return y.abrupt("return",ce(le(t.prototype),"generateEncryptionParameters",this).call(this,{payload:n,key:a,format:o}));case 3:if(o===te.EncryptedString){y.next=5;break}throw"Unsupport format for generateEncryptionParameters ".concat(o);case 5:if(a&&a.itemsKey){y.next=7;break}throw"Attempting to generateEncryptionParameters with no itemsKey.";case 7:return y.next=9,regeneratorRuntime.awrap(this.crypto.generateRandomKey(512));case 9:return i=y.sent,y.next=12,regeneratorRuntime.awrap(this.encryptString(i,a.itemsKey));case 12:return s=y.sent,y.next=15,regeneratorRuntime.awrap(this.firstHalfOfKey(i));case 15:return u=y.sent,y.next=18,regeneratorRuntime.awrap(this.secondHalfOfKey(i));case 18:return c=y.sent,y.next=21,regeneratorRuntime.awrap(this.encryptString(JSON.stringify(n.content),u));case 21:return l=y.sent,p=a.version+l,y.next=25,regeneratorRuntime.awrap(this.crypto.hmac256(p,c));case 25:return f=y.sent,y.abrupt("return",ya((ie(r={},ae.ItemsKeyId,a.isItemsKey?a.uuid:null),ie(r,ae.Content,p),ie(r,ae.EncItemKey,s),ie(r,ae.Legacy003AuthHash,f),r)));case 27:case"end":return y.stop()}}),null,this)}},{key:"generateDecryptedParameters",value:function(e){var r,n,a,o,i,s,u,c,l,p,f,y,h,d;return regeneratorRuntime.async((function(v){for(;;)switch(v.prev=v.next){case 0:if(r=e.encryptedParameters,n=e.key,(a=r.getContentFormat())!==te.DecryptedBareObject&&a!==te.DecryptedBase64String){v.next=4;break}return v.abrupt("return",ce(le(t.prototype),"generateDecryptedParameters",this).call(this,{encryptedParameters:r,key:n}));case 4:if(r.enc_item_key){v.next=7;break}return console.error("Missing item encryption key, skipping decryption."),v.abrupt("return",r);case 7:if(o=r.enc_item_key,o=V.V001+o,!(i=this.encryptionComponentsFromString(o,n.itemsKey)).uuid||i.uuid===r.uuid){v.next=13;break}return console.error("Item key params UUID does not match item UUID"),v.abrupt("return",ha({encryptionParameters:r,override:(s={},ie(s,ae.ErrorDecrypting,!0),ie(s,ae.ErrorDecryptingChanged,!r.errorDecrypting),s)}));case 13:return v.next=15,regeneratorRuntime.awrap(this.decryptString(i.contentCiphertext,i.encryptionKey));case 15:if(u=v.sent){v.next=19;break}return console.error("Error decrypting parameters",r),v.abrupt("return",ha({encryptionParameters:r,override:(c={},ie(c,ae.ErrorDecrypting,!0),ie(c,ae.ErrorDecryptingChanged,!r.errorDecrypting),c)}));case 19:return v.next=21,regeneratorRuntime.awrap(this.firstHalfOfKey(u));case 21:if(l=v.sent,!(p=this.encryptionComponentsFromString(r.content,l)).uuid||p.uuid===r.uuid){v.next=25;break}return v.abrupt("return",ha({encryptionParameters:r,override:(f={},ie(f,ae.ErrorDecrypting,!0),ie(f,ae.ErrorDecryptingChanged,!r.errorDecrypting),f)}));case 25:return v.next=27,regeneratorRuntime.awrap(this.decryptString(p.contentCiphertext,p.encryptionKey));case 27:if(y=v.sent){v.next=32;break}return v.abrupt("return",ha({encryptionParameters:r,override:(h={},ie(h,ae.ErrorDecrypting,!0),ie(h,ae.ErrorDecryptingChanged,!r.errorDecrypting),h)}));case 32:return v.abrupt("return",ha({encryptionParameters:r,override:(d={},ie(d,ae.Content,JSON.parse(y)),ie(d,ae.ErrorDecrypting,!1),ie(d,ae.ErrorDecryptingChanged,!0===r.errorDecrypting),ie(d,ae.WaitingForKey,!1),d)}));case 33:case"end":return v.stop()}}),null,this)}},{key:"encryptionComponentsFromString",value:function(e,t){var r=e.substring(0,V.VersionLength);return{contentCiphertext:e.substring(V.VersionLength,e.length),encryptionVersion:r,encryptionKey:t}}},{key:"deriveKey",value:function(){var e,t,r,n,a,o,i,s=arguments;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:return e=s.length>0&&void 0!==s[0]?s[0]:{},t=e.password,r=e.pwSalt,n=e.pwCost,u.next=3,regeneratorRuntime.awrap(this.crypto.pbkdf2(t,r,n,512));case 3:return a=u.sent,u.next=6,regeneratorRuntime.awrap(this.splitKey({key:a,numParts:2}));case 6:return o=u.sent,u.next=9,regeneratorRuntime.awrap($.Create({content:{serverPassword:o[0],masterKey:o[1],version:this.constructor.versionString()}}));case 9:return i=u.sent,u.abrupt("return",i);case 11:case"end":return u.stop()}}),null,this)}}])&&se(r.prototype,n),a&&se(r,a),t}(function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.crypto=t}var t,r,n;return t=e,(r=[{key:"firstHalfOfKey",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.substring(0,e.length/2));case 1:case"end":return t.stop()}}))}},{key:"secondHalfOfKey",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.substring(e.length/2,e.length));case 1:case"end":return t.stop()}}))}},{key:"splitKey",value:function(e){var t,r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:for(t=e.key,r=e.numParts,n=t.length,a=n/r,o=[],i=0;i<r;i++)s=t.slice(a*i,a*(i+1)),o.push(s);return u.abrupt("return",o);case 6:case"end":return u.stop()}}))}},{key:"generateNewItemsKeyContent",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override generateNewItemsKeyContent";case 1:case"end":return e.stop()}}))}},{key:"createItemsKey",value:function(){var e,t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap(this.generateNewItemsKeyContent());case 2:return e=n.sent,t=ua({object:{content:e}}),r=new Ve(t),n.next=7,regeneratorRuntime.awrap(r.initUUID());case 7:return n.abrupt("return",r);case 8:case"end":return n.stop()}}),null,this)}},{key:"generateEncryptionParameters",value:function(e){var t,r,n,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(t=e.payload,e.key,(r=e.format)!==te.DecryptedBareObject){i.next=5;break}return i.abrupt("return",ya({content:t.content}));case 5:if(r!==te.DecryptedBase64String){i.next=14;break}return n=JSON.stringify(t.content),i.next=9,regeneratorRuntime.awrap(Object(re.base64Encode)(n));case 9:return a=i.sent,o=V.V000Base64Decrypted+a,i.abrupt("return",ya({content:o}));case 14:throw"Must override generateEncryptionParameters to handle format ".concat(r,".");case 15:case"end":return i.stop()}}))}},{key:"generateDecryptedParameters",value:function(e){var t,r,n,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(t=e.encryptedParameters,e.key,t.isEncryptionParameters){i.next=3;break}throw"Atempting to generate decrypted parameters from non-parameters object.";case 3:if((r=t.getContentFormat())!==te.DecryptedBareObject){i.next=8;break}return i.abrupt("return",ya(t));case 8:if(r!==te.DecryptedBase64String){i.next=23;break}return n=t.content.substring(V.VersionLength,t.content.length),i.prev=10,i.next=13,regeneratorRuntime.awrap(Object(re.base64Decode)(n));case 13:o=i.sent,a=JSON.parse(o),i.next=20;break;case 17:i.prev=17,i.t0=i.catch(10),a=t.content;case 20:return i.abrupt("return",ha({encryptionParameters:t,override:{content:a}}));case 23:throw"Must override generateDecryptedParameters to handle format ".concat(r,".");case 24:case"end":return i.stop()}}),null,null,[[10,17]])}}])&&ne(t.prototype,r),n&&ne(t,n),e}());function he(e){return(he="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function de(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ve(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function me(e,t){return!t||"object"!==he(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ge(e,t,r){return(ge="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=be(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function be(e){return(be=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function we(e,t){return(we=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xe=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),me(this,be(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&we(e,t)}(t,e),r=t,a=[{key:"pwCost",value:function(){return 3e3}},{key:"versionString",value:function(){return V.V002}}],(n=[{key:"generateNewItemsKeyContent",value:function(){var e,t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return e=256,a.next=3,regeneratorRuntime.awrap(this.crypto.generateRandomKey(e));case 3:return t=a.sent,a.next=6,regeneratorRuntime.awrap(this.crypto.generateRandomKey(e));case 6:return r=a.sent,n=this.constructor.versionString(),a.abrupt("return",{itemsKey:t,dataAuthenticationKey:r,version:n});case 9:case"end":return a.stop()}}),null,this)}},{key:"createRootKey",value:function(e){var t,r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:return t=e.identifier,r=e.password,n=this.constructor.pwCost(),u.next=4,regeneratorRuntime.awrap(this.crypto.generateRandomKey(128));case 4:return a=u.sent,u.next=7,regeneratorRuntime.awrap(this.crypto.unsafeSha1(t+":"+a));case 7:return o=u.sent,u.next=10,regeneratorRuntime.awrap(this.deriveKey({password:r,pwSalt:o,pwCost:n}));case 10:return i=u.sent,s=Z({email:t,pw_cost:n,pw_nonce:a,pw_salt:o,version:V.V002}),u.abrupt("return",{key:i,keyParams:s});case 13:case"end":return u.stop()}}),null,this)}},{key:"computeRootKey",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(t=e.password,(r=e.keyParams).isKeyParamsObject){a.next=3;break}throw"Attempting to compute root key with non params object.";case 3:return a.next=5,regeneratorRuntime.awrap(this.deriveKey({password:t,pwSalt:r.salt,pwCost:r.kdfIterations}));case 5:return n=a.sent,a.abrupt("return",n);case 7:case"end":return a.stop()}}),null,this)}},{key:"decryptString",value:function(e,t,r){return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",this.crypto.aes256CbcDecrypt(e,r,t));case 1:case"end":return n.stop()}}),null,this)}},{key:"encryptString",value:function(e,t,r){return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",this.crypto.aes256CbcEncrypt(e,r,t));case 1:case"end":return n.stop()}}),null,this)}},{key:"encryptTextParams",value:function(e,t,r,n,a){var o,i,s,u,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,regeneratorRuntime.awrap(this.crypto.generateRandomKey(128));case 2:return o=l.sent,l.next=5,regeneratorRuntime.awrap(this.encryptString(e,t,o));case 5:return i=l.sent,s=[a,n,o,i].join(":"),l.next=9,regeneratorRuntime.awrap(this.crypto.hmac256(s,r));case 9:return u=l.sent,c=[a,u,n,o,i].join(":"),l.abrupt("return",c);case 12:case"end":return l.stop()}}),null,this)}},{key:"decryptTextParams",value:function(e){var t,r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(t=e.ciphertextToAuth,r=e.contentCiphertext,n=e.encryptionKey,a=e.iv,o=e.authHash,i=e.authKey,n){u.next=3;break}throw"Attempting to decryptTextParams with null encryptionKey";case 3:return u.next=5,regeneratorRuntime.awrap(this.crypto.hmac256(t,i));case 5:if(s=u.sent,!1!==this.crypto.timingSafeEqual(o,s)){u.next=9;break}return console.error("Auth hash does not match, returning null."),u.abrupt("return",null);case 9:return u.abrupt("return",this.decryptString(r,n,a));case 10:case"end":return u.stop()}}),null,this)}},{key:"generateEncryptionParameters",value:function(e){var r,n,a,o,i,s,u,c,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:if(n=e.payload,a=e.key,(o=e.format)!==te.DecryptedBareObject&&o!==te.DecryptedBase64String){p.next=3;break}return p.abrupt("return",ge(be(t.prototype),"generateEncryptionParameters",this).call(this,{payload:n,key:a,format:o}));case 3:if(o===te.EncryptedString){p.next=5;break}throw"Unsupport format for generateEncryptionParameters ".concat(o);case 5:if(a&&a.itemsKey){p.next=7;break}throw"Attempting to generateEncryptionParameters with no itemsKey.";case 7:return p.next=9,regeneratorRuntime.awrap(this.crypto.generateRandomKey(512));case 9:return i=p.sent,p.next=12,regeneratorRuntime.awrap(this.encryptTextParams(i,a.itemsKey,a.dataAuthenticationKey,n.uuid,a.version));case 12:return s=p.sent,p.next=15,regeneratorRuntime.awrap(this.firstHalfOfKey(i));case 15:return u=p.sent,p.next=18,regeneratorRuntime.awrap(this.secondHalfOfKey(i));case 18:return c=p.sent,p.next=21,regeneratorRuntime.awrap(this.encryptTextParams(JSON.stringify(n.content),u,c,n.uuid,a.version));case 21:return l=p.sent,p.abrupt("return",ya((de(r={},ae.ItemsKeyId,a.isItemsKey?a.uuid:null),de(r,ae.Content,l),de(r,ae.EncItemKey,s),r)));case 23:case"end":return p.stop()}}),null,this)}},{key:"generateDecryptedParameters",value:function(e){var r,n,a,o,i,s,u,c,l,p,f,y,h,d;return regeneratorRuntime.async((function(v){for(;;)switch(v.prev=v.next){case 0:if(r=e.encryptedParameters,n=e.key,(a=r.getContentFormat())!==te.DecryptedBareObject&&a!==te.DecryptedBase64String){v.next=4;break}return v.abrupt("return",ge(be(t.prototype),"generateDecryptedParameters",this).call(this,{encryptedParameters:r,key:n}));case 4:if(r.enc_item_key){v.next=7;break}return console.error("Missing item encryption key, skipping decryption."),v.abrupt("return",r);case 7:if(n&&n.itemsKey){v.next=9;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 9:return o=r.enc_item_key,i=this.encryptionComponentsFromString(o,n.itemsKey,n.dataAuthenticationKey),v.next=13,regeneratorRuntime.awrap(this.decryptTextParams(i));case 13:if(s=v.sent){v.next=17;break}return console.error("Error decrypting item_key parameters",r),v.abrupt("return",ha({encryptionParameters:r,override:(u={},de(u,ae.ErrorDecrypting,!0),de(u,ae.ErrorDecryptingChanged,!r.errorDecrypting),u)}));case 17:return v.next=19,regeneratorRuntime.awrap(this.firstHalfOfKey(s));case 19:return c=v.sent,v.next=22,regeneratorRuntime.awrap(this.secondHalfOfKey(s));case 22:return l=v.sent,p=this.encryptionComponentsFromString(r.content,c,l),v.next=26,regeneratorRuntime.awrap(this.decryptTextParams(p));case 26:if(f=v.sent){v.next=31;break}return v.abrupt("return",ha({encryptionParameters:r,override:(y={},de(y,ae.ErrorDecrypting,!0),de(y,ae.ErrorDecryptingChanged,!r.errorDecrypting),y)}));case 31:return v.prev=31,v.t0=JSON,v.next=35,regeneratorRuntime.awrap(Object(re.base64Decode)(p.authParams));case 35:v.t1=v.sent,d=v.t0.parse.call(v.t0,v.t1),v.next=41;break;case 39:v.prev=39,v.t2=v.catch(31);case 41:return v.abrupt("return",ha({encryptionParameters:r,override:(h={},de(h,ae.Content,JSON.parse(f)),de(h,ae.Legacy003AuthParams,d),de(h,ae.ErrorDecrypting,!1),de(h,ae.ErrorDecryptingChanged,!0===r.errorDecrypting),de(h,ae.WaitingForKey,!1),h)}));case 42:case"end":return v.stop()}}),null,this,[[31,39]])}},{key:"deriveKey",value:function(){var e,t,r,n,a,o,i,s=arguments;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(e=s.length>0&&void 0!==s[0]?s[0]:{},t=e.password,r=e.pwSalt,(n=e.pwCost)&&r&&t){u.next=3;break}throw"Attempting to 003.deriveKey with invalid parameters";case 3:return u.next=5,regeneratorRuntime.awrap(this.crypto.pbkdf2(t,r,n,768));case 5:return a=u.sent,u.next=8,regeneratorRuntime.awrap(this.splitKey({key:a,numParts:3}));case 8:return o=u.sent,u.next=11,regeneratorRuntime.awrap($.Create({content:{serverPassword:o[0],masterKey:o[1],dataAuthenticationKey:o[2],version:this.constructor.versionString()}}));case 11:return i=u.sent,u.abrupt("return",i);case 13:case"end":return u.stop()}}),null,this)}},{key:"encryptionComponentsFromString",value:function(e,t,r){var n=e.split(":");return{encryptionVersion:n[0],authHash:n[1],uuid:n[2],iv:n[3],contentCiphertext:n[4],ciphertextToAuth:[n[0],n[2],n[3],n[4]].join(":"),encryptionKey:t,authKey:r}}}])&&ve(r.prototype,n),a&&ve(r,a),t}(ye);function ke(e){return(ke="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Se(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Re(e,t){return!t||"object"!==ke(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Pe(e){return(Pe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Oe(e,t){return(Oe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _e=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Re(this,Pe(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Oe(e,t)}(t,e),r=t,a=[{key:"pwCost",value:function(){return 11e4}},{key:"versionString",value:function(){return V.V003}}],(n=[{key:"computeRootKey",value:function(e){var t,r,n,a,o,i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(t=e.password,(r=e.keyParams).isKeyParamsObject){s.next=3;break}throw"Attempting to compute root key with non params object.";case 3:return n=this.constructor.pwCost(),a=this.constructor.versionString(),s.next=7,regeneratorRuntime.awrap(this.generateSalt(r.identifier,a,n,r.seed));case 7:return o=s.sent,s.next=10,regeneratorRuntime.awrap(this.deriveKey({password:t,pwSalt:o,pwCost:n}));case 10:return i=s.sent,s.abrupt("return",i);case 12:case"end":return s.stop()}}),null,this)}},{key:"createRootKey",value:function(e){var t,r,n,a,o,i,s,u;return regeneratorRuntime.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=e.identifier,r=e.password,n=this.constructor.versionString(),a=this.constructor.pwCost(),c.next=5,regeneratorRuntime.awrap(this.crypto.generateRandomKey(256));case 5:return o=c.sent,c.next=8,regeneratorRuntime.awrap(this.generateSalt(t,n,a,o));case 8:return i=c.sent,c.next=11,regeneratorRuntime.awrap(this.deriveKey({password:r,pwSalt:i,pwCost:a}));case 11:return s=c.sent,u=Z({identifier:t,pw_cost:a,pw_nonce:o,version:n}),c.abrupt("return",{key:s,keyParams:u});case 14:case"end":return c.stop()}}),null,this)}},{key:"generateSalt",value:function(e,t,r,n){var a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(this.crypto.sha256([e,"SF",t,r,n].join(":")));case 2:return a=o.sent,o.abrupt("return",a);case 4:case"end":return o.stop()}}),null,this)}}])&&Se(r.prototype,n),a&&Se(r,a),t}(xe);function je(e){return(je="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ie(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function De(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ce(e,t){return!t||"object"!==je(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ee(e,t,r){return(Ee="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ae(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Ae(e){return(Ae=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Te(e,t){return(Te=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Me=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Ce(this,Ae(t).apply(this,arguments))}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Te(e,t)}(t,e),r=t,o=[{key:"versionString",value:function(){return V.V004}},{key:"kdfIterations",value:function(){return 5}}],(n=[{key:"generateNewItemsKeyContent",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(this.crypto.generateRandomKey(256));case 2:return e=r.sent,t=this.constructor.versionString(),r.abrupt("return",{itemsKey:e,version:t});case 5:case"end":return r.stop()}}),null,this)}},{key:"generateSalt",value:function(e){var t,r,n;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=e.identifier,r=e.seed,o.next=3,regeneratorRuntime.awrap(this.crypto.sha256([t,r].join(":")));case 3:return n=o.sent,o.abrupt("return",Object(a.y)(n,128));case 5:case"end":return o.stop()}}),null,this)}},{key:"computeRootKey",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(t=e.password,(r=e.keyParams).isKeyParamsObject){o.next=3;break}throw"Attempting to compute root key with non params object.";case 3:return o.next=5,regeneratorRuntime.awrap(this.generateSalt({identifier:r.identifier,seed:r.seed}));case 5:return n=o.sent,o.next=8,regeneratorRuntime.awrap(this.deriveKey({password:t,salt:n,iterations:this.constructor.kdfIterations()}));case 8:return a=o.sent,o.abrupt("return",a);case 10:case"end":return o.stop()}}),null,this)}},{key:"createRootKey",value:function(e){var t,r,n,a,o,i,s,u;return regeneratorRuntime.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=e.identifier,r=e.password,n=this.constructor.versionString(),a=this.constructor.kdfIterations(),c.next=5,regeneratorRuntime.awrap(this.crypto.generateRandomKey(256));case 5:return o=c.sent,c.next=8,regeneratorRuntime.awrap(this.generateSalt({identifier:t,seed:o}));case 8:return i=c.sent,c.next=11,regeneratorRuntime.awrap(this.deriveKey({password:r,salt:i,iterations:a}));case 11:return s=c.sent,u=Z({identifier:t,pw_cost:a,pw_nonce:o,version:n}),c.abrupt("return",{key:s,keyParams:u});case 14:case"end":return c.stop()}}),null,this)}},{key:"encryptString",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(t=e.plaintext,r=e.rawKey,n=e.nonce,a=e.aad,n){o.next=3;break}throw"encryptString null nonce";case 3:if(r){o.next=5;break}throw"encryptString null rawKey";case 5:return o.abrupt("return",this.crypto.xchacha20Encrypt(t,n,r,JSON.stringify(a)));case 6:case"end":return o.stop()}}),null,this)}},{key:"decryptString",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=e.ciphertext,r=e.rawKey,n=e.nonce,a=e.aad,o.abrupt("return",this.crypto.xchacha20Decrypt(t,n,r,JSON.stringify(a)));case 2:case"end":return o.stop()}}),null,this)}},{key:"generateEncryptedProtocolString",value:function(e){var t,r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:return t=e.plaintext,r=e.rawKey,n=e.itemUuid,u.next=3,regeneratorRuntime.awrap(this.crypto.generateRandomKey(192));case 3:return a=u.sent,o=this.constructor.versionString(),u.next=7,regeneratorRuntime.awrap(this.encryptString({plaintext:t,rawKey:r,nonce:a,aad:{u:n,v:o}}));case 7:return i=u.sent,s=[o,a,i].join(":"),u.abrupt("return",s);case 10:case"end":return u.stop()}}),null,this)}},{key:"generateEncryptionParameters",value:function(e){var r,n,a,o,i,s,u,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:if(n=e.payload,a=e.key,(o=e.format)!==te.DecryptedBareObject&&o!==te.DecryptedBase64String){l.next=3;break}return l.abrupt("return",Ee(Ae(t.prototype),"generateEncryptionParameters",this).call(this,{payload:n,key:a,format:o}));case 3:if(o===te.EncryptedString){l.next=5;break}throw"Unsupport format for generateEncryptionParameters ".concat(o);case 5:if(a&&a.itemsKey){l.next=7;break}throw"Attempting to generateEncryptionParameters with no itemsKey.";case 7:return l.next=9,regeneratorRuntime.awrap(this.crypto.generateRandomKey(256));case 9:return i=l.sent,s=JSON.stringify(n.content),l.next=13,regeneratorRuntime.awrap(this.generateEncryptedProtocolString({plaintext:s,rawKey:i}));case 13:return u=l.sent,l.next=16,regeneratorRuntime.awrap(this.generateEncryptedProtocolString({plaintext:i,rawKey:a.itemsKey}));case 16:return c=l.sent,l.abrupt("return",ya((Ie(r={},ae.ItemsKeyId,a.isItemsKey?a.uuid:null),Ie(r,ae.Content,u),Ie(r,ae.EncItemKey,c),r)));case 18:case"end":return l.stop()}}),null,this)}},{key:"generateDecryptedParameters",value:function(e){var r,n,a,o,i,s,u,c,l,p;return regeneratorRuntime.async((function(f){for(;;)switch(f.prev=f.next){case 0:if(r=e.encryptedParameters,n=e.key,(a=r.getContentFormat())!==te.DecryptedBareObject&&a!==te.DecryptedBase64String){f.next=4;break}return f.abrupt("return",Ee(Ae(t.prototype),"generateDecryptedParameters",this).call(this,{encryptedParameters:r,key:n}));case 4:if(n&&n.itemsKey){f.next=6;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 6:return o=this.deconstructEncryptedPayloadString(r.enc_item_key),f.next=9,regeneratorRuntime.awrap(this.decryptString({ciphertext:o.ciphertext,rawKey:n.itemsKey,nonce:o.nonce,aad:{u:o.uuid,v:o.version}}));case 9:if(i=f.sent){f.next=13;break}return console.error("Error decrypting itemKey parameters",r),f.abrupt("return",ha({encryptionParameters:r,override:(s={},Ie(s,ae.ErrorDecrypting,!0),Ie(s,ae.ErrorDecryptingChanged,!r.errorDecrypting),s)}));case 13:return u=this.deconstructEncryptedPayloadString(r.content),f.next=16,regeneratorRuntime.awrap(this.decryptString({ciphertext:u.ciphertext,rawKey:i,nonce:u.nonce,aad:{u:u.uuid,v:u.version}}));case 16:if(c=f.sent){f.next=21;break}return f.abrupt("return",ha({encryptionParameters:r,override:(l={},Ie(l,ae.ErrorDecrypting,!0),Ie(l,ae.ErrorDecryptingChanged,!r.errorDecrypting),l)}));case 21:return f.abrupt("return",ha({encryptionParameters:r,override:(p={},Ie(p,ae.Content,JSON.parse(c)),Ie(p,ae.ErrorDecrypting,!1),Ie(p,ae.ErrorDecryptingChanged,!0===r.errorDecrypting),Ie(p,ae.WaitingForKey,!1),p)}));case 22:case"end":return f.stop()}}),null,this)}},{key:"deconstructEncryptedPayloadString",value:function(e){var t=e.split(":");return{version:t[0],nonce:t[1],ciphertext:t[2]}}},{key:"deriveKey",value:function(){var e,t,r,n,a,o,i,s,u=arguments;return regeneratorRuntime.async((function(c){for(;;)switch(c.prev=c.next){case 0:if(e=u.length>0&&void 0!==u[0]?u[0]:{},t=e.password,r=e.salt,(n=e.iterations)&&r&&t){c.next=3;break}throw"Attempting to 004.deriveKey with invalid parameters";case 3:return c.next=5,regeneratorRuntime.awrap(this.crypto.argon2(t,r,n,67108864,64));case 5:return a=c.sent,c.next=8,regeneratorRuntime.awrap(this.splitKey({key:a,numParts:2}));case 8:return o=c.sent,i=o[0],s=o[1],c.abrupt("return",$.Create({content:{masterKey:i,serverPassword:s,version:this.constructor.versionString()}}));case 12:case"end":return c.stop()}}),null,this)}}])&&De(r.prototype,n),o&&De(r,o),t}(_e);function Ke(e){return(Ke="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Fe(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Le(e,t){return!t||"object"!==Ke(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ue(e,t,r){return(Ue="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ne(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Ne(e){return(Ne=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Be(e,t){return(Be=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ve=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Le(this,Ne(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Be(e,t)}(t,e),r=t,a=[{key:"FromRaw",value:function(e){return new t(ua({object:{content:e}}))}}],(n=[{key:"strategyWhenConflictingWithItem",value:function(e){var r=e.item;return this.errorDecrypting?Ue(Ne(t.prototype),"strategyWhenConflictingWithItem",this).call(this,{item:r}):Rn.KeepLeft}},{key:"content_type",get:function(){return i.ItemsKey}},{key:"version",get:function(){return this.content.version}},{key:"isItemsKey",get:function(){return!0}},{key:"isDefault",get:function(){return this.content.isDefault}},{key:"itemsKey",get:function(){return this.content.itemsKey}},{key:"dataAuthenticationKey",get:function(){if(this.version===V.V004)throw"Attempting to access legacy data authentication key.";return this.content.dataAuthenticationKey}}])&&Fe(r.prototype,n),a&&Fe(r,a),t}(B);function He(e){return(He="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function We(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ze(e,t){return!t||"object"!==He(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function qe(e,t,r){return(qe="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ye(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Ye(e){return(Ye=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Je(e,t){return(Je=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ge="editor-editor",Qe="themes",$e="editor-stack",Xe="note-tags",Ze="rooms",et="modal",tt=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=ze(this,Ye(t).call(this,e))).componentData||(r.componentData={}),r.disassociatedItemIds||(r.disassociatedItemIds=[]),r.associatedItemIds||(r.associatedItemIds=[]),r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Je(e,t)}(t,e),r=t,a=[{key:"associativeAreas",value:function(){return[Ge]}}],(n=[{key:"mapContentToLocalProperties",value:function(e){qe(Ye(t.prototype),"mapContentToLocalProperties",this).call(this,e),e.hosted_url||(this.legacy_url=e.url),this.local_url=e.local_url,this.hosted_url=e.hosted_url||e.url,this.offlineOnly=e.offlineOnly,this.name=e.name,this.autoupdateDisabled=e.autoupdateDisabled,this.package_info=e.package_info,this.area=e.area,this.active=e.active,this.permissions=e.permissions,this.permissions||(this.permissions=[]),e.valid_until&&(this.valid_until=new Date(e.valid_until)),this.componentData=e.componentData||{},this.disassociatedItemIds=e.disassociatedItemIds||[],this.associatedItemIds=e.associatedItemIds||[]}},{key:"handleDeletedContent",value:function(){qe(Ye(t.prototype),"handleDeletedContent",this).call(this),this.active=!1}},{key:"structureParams",value:function(){var e={legacy_url:this.legacy_url,hosted_url:this.hosted_url,local_url:this.local_url,valid_until:this.valid_until,offlineOnly:this.offlineOnly,name:this.name,area:this.area,package_info:this.package_info,permissions:this.permissions,active:this.active,autoupdateDisabled:this.autoupdateDisabled,componentData:this.componentData,disassociatedItemIds:this.disassociatedItemIds,associatedItemIds:this.associatedItemIds},r=qe(Ye(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"strategyWhenConflictingWithItem",value:function(e){var r=e.item;return this.errorDecrypting?qe(Ye(t.prototype),"strategyWhenConflictingWithItem",this).call(this,{item:r}):Rn.KeepLeft}},{key:"isEditor",value:function(){return this.area===Ge}},{key:"isTheme",value:function(){return this.content_type===i.Theme||this.area===Qe}},{key:"isDefaultEditor",value:function(){return!0===this.getAppDataItem("defaultEditor")}},{key:"setLastSize",value:function(e){this.setAppDataItem("lastSize",e)}},{key:"getLastSize",value:function(){return this.getAppDataItem("lastSize")}},{key:"acceptsThemes",value:function(){return!this.content.package_info||!0===this.content.package_info.acceptsThemes}},{key:"getClientDataKey",value:function(){return this.legacy_url?this.legacy_url:this.uuid}},{key:"hasValidHostedUrl",value:function(){return this.hosted_url||this.legacy_url}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["active","disassociatedItemIds","associatedItemIds"].concat(qe(Ye(t.prototype),"contentKeysToIgnoreWhenCheckingEquality",this).call(this))}},{key:"isAssociative",value:function(){return t.associativeAreas().includes(this.area)}},{key:"associateWithItem",value:function(e){this.associatedItemIds.push(e.uuid)}},{key:"isExplicitlyEnabledForItem",value:function(e){return-1!==this.associatedItemIds.indexOf(e.uuid)}},{key:"isExplicitlyDisabledForItem",value:function(e){return-1!==this.disassociatedItemIds.indexOf(e.uuid)}},{key:"content_type",get:function(){return i.Component}}])&&We(r.prototype,n),a&&We(r,a),t}(B),rt=r(91),nt=r.n(rt),at=r(4),ot=r.n(at),it=r(2),st=r.n(it),ut=r(1),ct=r.n(ut);function lt(e){return(lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function pt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ft(e,t){return!t||"object"!==lt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function yt(e,t,r){return(yt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ht(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function ht(e){return(ht=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function dt(e,t){return(dt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var vt=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=ft(this,ht(t).call(this,e))).notes||(r.notes=[]),r.data||(r.data={}),r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&dt(e,t)}(t,e),r=t,(n=[{key:"mapContentToLocalProperties",value:function(e){yt(ht(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.url=e.url,this.name=e.name,this.data=e.data||{},this.default=e.default,this.systemEditor=e.systemEditor}},{key:"structureParams",value:function(){var e={url:this.url,name:this.name,data:this.data,default:this.default,systemEditor:this.systemEditor},r=yt(ht(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"referenceParams",value:function(){return nt()(this.notes,(function(e){return{uuid:e.uuid,content_type:e.content_type}}))}},{key:"addItemAsRelationship",value:function(e){e.content_type===i.Note&&(ot()(this.notes,e)||this.notes.push(e)),yt(ht(t.prototype),"addItemAsRelationship",this).call(this,e)}},{key:"removeItemAsRelationship",value:function(e){e.content_type===i.Note&&st()(this.notes,e),yt(ht(t.prototype),"removeItemAsRelationship",this).call(this,e)}},{key:"removeAndDirtyAllRelationships",value:function(){yt(ht(t.prototype),"removeAndDirtyAllRelationships",this).call(this),this.notes=[]}},{key:"removeReferencesNotPresentIn",value:function(e){var r=this;yt(ht(t.prototype),"removeReferencesNotPresentIn",this).call(this,e);var n=e.map((function(e){return e.uuid}));this.notes.forEach((function(e){n.includes(e.uuid)||ct()(r.notes,{uuid:e.uuid})}))}},{key:"setData",value:function(e,t){return!(JSON.stringify(this.data[e])===JSON.stringify(t)||(this.data[e]=t,0))}},{key:"dataForKey",value:function(e){return this.data[e]||{}}},{key:"content_type",get:function(){return i.Editor}}])&&pt(r.prototype,n),a&&pt(r,a),t}(B),mt=r(92),gt=r.n(mt),bt=r(34),wt=r.n(bt);var xt=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),wt()(this,t),this.running=!1,this.error=!1,this.lastExecuted&&(this.lastExecuted=new Date(this.lastExecuted))};function kt(e){return(kt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function St(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Rt(e,t){return!t||"object"!==kt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Pt(e,t,r){return(Pt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ot(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Ot(e){return(Ot=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _t(e,t){return(_t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var jt=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=Rt(this,Ot(t).call(this,e)),e.actions&&(r.actions=e.actions.map((function(e){return new xt(e)}))),r.actions||(r.actions=[]),r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_t(e,t)}(t,e),r=t,(n=[{key:"actionsWithContextForItem",value:function(e){return this.actions.filter((function(t){return t.context===e.content_type||"Item"===t.context}))}},{key:"mapContentToLocalProperties",value:function(e){Pt(Ot(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.description=e.description,this.url=e.url,this.name=e.name,this.package_info=e.package_info,this.supported_types=e.supported_types,e.actions&&(this.actions=e.actions.map((function(e){return new xt(e)})))}},{key:"structureParams",value:function(){var e={name:this.name,url:this.url,package_info:this.package_info,description:this.description,actions:this.actions.map((function(e){return gt()(e,["subrows","subactions"])})),supported_types:this.supported_types},r=Pt(Ot(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"content_type",get:function(){return i.ActionsExtension}}])&&St(r.prototype,n),a&&St(r,a),t}(B);function It(e){return(It="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Dt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ct(e,t){return!t||"object"!==It(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Et(e,t,r){return(Et="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=At(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function At(e){return(At=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Tt(e,t){return(Tt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Mt=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Ct(this,At(t).call(this,e))).content_type||(r.content_type=i.Tag),r.notes||(r.notes=[]),r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Tt(e,t)}(t,e),r=t,o=[{key:"arrayToDisplayString",value:function(e){return e.sort((function(e,t){return e.title>t.title})).map((function(e,t){return"#"+e.title})).join(" ")}}],(n=[{key:"mapContentToLocalProperties",value:function(e){Et(At(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.title=e.title}},{key:"structureParams",value:function(){var e={title:this.title},r=Et(At(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"addItemAsRelationship",value:function(e){e.content_type===i.Note&&(Object(a.g)(this.notes,"uuid",e.uuid)||this.notes.push(e)),Et(At(t.prototype),"addItemAsRelationship",this).call(this,e)}},{key:"removeItemAsRelationship",value:function(e){e.content_type===i.Note&&ct()(this.notes,{uuid:e.uuid}),Et(At(t.prototype),"removeItemAsRelationship",this).call(this,e)}},{key:"updateLocalRelationships",value:function(){var e=this,t=this.content.references.map((function(e){return e.uuid}));this.notes.slice().forEach((function(r){t.includes(r.uuid)||(ct()(e.notes,{uuid:r.uuid}),r.setIsNoLongerReferencedBy(e))}))}},{key:"isBeingRemovedLocally",value:function(){var e=this;this.notes.forEach((function(t){t.setIsNoLongerReferencedBy(e)})),this.notes.length=0,Et(At(t.prototype),"isBeingRemovedLocally",this).call(this)}},{key:"didCompleteMapping",value:function(e){var t=!0,r=!1,n=void 0;try{for(var a,o=this.notes[Symbol.iterator]();!(t=(a=o.next()).done);t=!0)a.value.tagDidCompleteMapping(this)}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}}},{key:"isSmartTag",value:function(){return this.content_type===i.SmartTag}}])&&Dt(r.prototype,n),o&&Dt(r,o),t}(B);function Kt(e){return(Kt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ft(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Lt(e,t){return!t||"object"!==Kt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ut(e,t,r){return(Ut="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Nt(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Nt(e){return(Nt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Bt(e,t){return(Bt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Vt=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Lt(this,Nt(t).call(this,e))).text||(r.text=""),r.tags||(r.tags=[]),r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Bt(e,t)}(t,e),r=t,o=[{key:"filterDummyNotes",value:function(e){return e.filter((function(e){return!e.dummy}))}}],(n=[{key:"mapContentToLocalProperties",value:function(e){Ut(Nt(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.title=e.title,this.text=e.text}},{key:"structureParams",value:function(){var e={title:this.title,text:this.text},r=Ut(Nt(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"addItemAsRelationship",value:function(e){e.content_type===i.Tag&&e.addItemAsRelationship(this),Ut(Nt(t.prototype),"addItemAsRelationship",this).call(this,e)}},{key:"setIsBeingReferencedBy",value:function(e){e.content_type===i.Tag&&(Object(a.g)(this.tags,"uuid",e.uuid)||this.tags.push(e)),Ut(Nt(t.prototype),"setIsBeingReferencedBy",this).call(this,e),this.clearSavedTagsString()}},{key:"setIsNoLongerReferencedBy",value:function(e){Ut(Nt(t.prototype),"setIsNoLongerReferencedBy",this).call(this,e),e.content_type===i.Tag&&Object(a.u)(this.tags,e),e.content_type===i.Tag&&this.hasRelationshipWithItem(e)&&this.removeReferenceWithUuid(e.uuid),this.clearSavedTagsString()}},{key:"tagDidCompleteMapping",value:function(e){this.clearSavedTagsString()}},{key:"safeText",value:function(){return this.text||""}},{key:"safeTitle",value:function(){return this.title||""}},{key:"clearSavedTagsString",value:function(){this.savedTagsString=null}},{key:"tagsString",value:function(){return this.savedTagsString=Mt.arrayToDisplayString(this.tags),this.savedTagsString}},{key:"content_type",get:function(){return i.Note}}])&&Ft(r.prototype,n),o&&Ft(r,o),t}(B);function Ht(e){return(Ht="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Wt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function zt(e,t){return!t||"object"!==Ht(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function qt(e){return(qt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Yt(e,t){return(Yt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Jt=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),zt(this,qt(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Yt(e,t)}(t,e),r=t,a=[{key:"contentType",value:function(){return i.UserPrefs}}],(n=[{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new f("content_type","=",this.content_type)}}])&&Wt(r.prototype,n),a&&Wt(r,a),t}(B);function Gt(e){return(Gt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Qt(e,t){return!t||"object"!==Gt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function $t(e){return($t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Xt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Zt(e,t,r){return t&&Xt(e.prototype,t),r&&Xt(e,r),e}function er(e,t){return(er=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tr=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Qt(this,$t(t).call(this,e))).errorDecrypting||r.content.desktopPrivileges||(r.content.desktopPrivileges={}),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&er(e,t)}(t,e),Zt(t,null,[{key:"contentType",value:function(){return i.Privileges}}]),Zt(t,[{key:"setCredentialsForAction",value:function(e,t){this.content.desktopPrivileges[e]=t}},{key:"getCredentialsForAction",value:function(e){return this.content.desktopPrivileges[e]||[]}},{key:"toggleCredentialForAction",value:function(e,t){this.isCredentialRequiredForAction(e,t)?this.removeCredentialForAction(e,t):this.addCredentialForAction(e,t)}},{key:"removeCredentialForAction",value:function(e,t){st()(this.content.desktopPrivileges[e],t)}},{key:"addCredentialForAction",value:function(e,t){var r=this.getCredentialsForAction(e);r.push(t),this.setCredentialsForAction(e,r)}},{key:"isCredentialRequiredForAction",value:function(e,t){return this.getCredentialsForAction(e).includes(t)}},{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new f("content_type","=",this.content_type)}}]),t}(B);function rr(e){return(rr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function nr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ar(e,t){return!t||"object"!==rr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function or(e){return(or=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ir(e,t){return(ir=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var sr=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=ar(this,or(t).call(this,e))).content_type=i.SmartTag,r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ir(e,t)}(t,e),r=t,a=[{key:"systemSmartTags",value:function(){var e=ua({object:{uuid:"all-notes",dummy:!0,content:{title:"All notes",isSystemTag:!0,isAllTag:!0,predicate:new f.FromArray(["content_type","=",i.Note])}}}),r=ua({object:{uuid:"archived-notes",dummy:!0,content:{title:"Archived",isSystemTag:!0,isArchiveTag:!0,predicate:new f.FromArray(["archived","=",!0])}}}),n=ua({object:{uuid:"trashed-notes",dummy:!0,content:{title:"Trash",isSystemTag:!0,isTrashTag:!0,predicate:new f.FromArray(["content.trashed","=",!0])}}});return[new t(e),new t(r),new t(n)]}}],(n=null)&&nr(r.prototype,n),a&&nr(r,a),t}(Mt);function ur(e){return(ur="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function cr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function lr(e,t){return!t||"object"!==ur(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function pr(e,t,r){return(pr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=fr(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function fr(e){return(fr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function yr(e,t){return(yr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var hr=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=lr(this,fr(t).call(this,e))).area="themes",r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&yr(e,t)}(t,e),r=t,(n=[{key:"isLayerable",value:function(){return this.package_info&&this.package_info.layerable}},{key:"strategyWhenConflictingWithItem",value:function(e){var r=e.item;return this.errorDecrypting?pr(fr(t.prototype),"strategyWhenConflictingWithItem",this).call(this,{item:r}):Rn.KeepLeft}},{key:"setMobileRules",value:function(e){this.setAppDataItem("mobileRules",e)}},{key:"getMobileRules",value:function(){return this.getAppDataItem("mobileRules")||{constants:{},rules:{}}}},{key:"hasMobileRules",value:function(){return this.getAppDataItem("mobileRules")}},{key:"setNotAvailOnMobile",value:function(e){this.setAppDataItem("notAvailableOnMobile",e)}},{key:"getNotAvailOnMobile",value:function(){return this.getAppDataItem("notAvailableOnMobile")}},{key:"setMobileActive",value:function(e){this.setAppDataItem("mobileActive",e)}},{key:"isMobileActive",value:function(){return this.getAppDataItem("mobileActive")}},{key:"content_type",get:function(){return i.Theme}}])&&cr(r.prototype,n),a&&cr(r,a),t}(tt);function dr(e){return(dr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function vr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function mr(e,t){return!t||"object"!==dr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function gr(e,t,r){return(gr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=br(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function br(e){return(br=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function wr(e,t){return(wr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xr,kr=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),mr(this,br(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&wr(e,t)}(t,e),r=t,(n=[{key:"mapContentToLocalProperties",value:function(e){gr(br(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.storage=e.storage}},{key:"content_type",get:function(){return i.EncryptedStorage}}])&&vr(r.prototype,n),a&&vr(r,a),t}(B);function Sr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var Rr=(Sr(xr={},i.Note,Vt),Sr(xr,i.Tag,Mt),Sr(xr,i.ItemsKey,Ve),Sr(xr,i.SmartTag,sr),Sr(xr,i.ActionsExtension,jt),Sr(xr,i.Editor,vt),Sr(xr,i.Theme,hr),Sr(xr,i.Component,tt),Sr(xr,i.Privileges,tr),Sr(xr,i.UserPrefs,Jt),xr);function Pr(e){if(!e.isPayload)throw"Attempting to create item from non-payload object.";return new(Rr[e.content_type]||B)(e)}function Or(e){var t,r,n,o,i,s,u,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:return t=e.payload,r=e.baseCollection,n=e.isConflict,o=[],l.next=4,regeneratorRuntime.awrap(F.GenerateUuid());case 4:return l.t0=l.sent,i={uuid:l.t0,dirty:!0,dirtiedDate:null,lastSyncBegan:null,lastSyncEnd:null},n&&(i.content={conflict_of:t.uuid}),s=fa({payload:t,override:i}),o.push(s),u=r.payloadsThatReferencePayload(t),l.next=12,regeneratorRuntime.awrap(jr({payloads:u,add:[{uuid:s.uuid,content_type:s.content_type}]}));case 12:return c=l.sent,Object(a.f)(o,c),l.abrupt("return",o);case 15:case"end":return l.stop()}}))}function _r(e){var t,r,n,o,i,s,u;return regeneratorRuntime.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=e.payload,r=e.baseCollection,n=[],c.t0=fa,c.t1=t,c.next=6,regeneratorRuntime.awrap(F.GenerateUuid());case 6:return c.t2=c.sent,c.t3={uuid:c.t2,dirty:!0},c.t4={payload:c.t1,override:c.t3},o=(0,c.t0)(c.t4),n.push(o),i=r.payloadsThatReferencePayload(t),c.next=14,regeneratorRuntime.awrap(jr({payloads:i,add:[{uuid:o.uuid,content_type:o.content_type}],removeIds:[t.uuid]}));case 14:return s=c.sent,Object(a.f)(n,s),u=fa({payload:t,override:{deleted:!0,dirty:!1,content:{references:[]}}}),n.push(u),c.abrupt("return",n);case 19:case"end":return c.stop()}}))}function jr(e){var t,r,n,a,o,i,s,u,c,l,p,f,y,h,d,v,m,g,b,w,x,k,S,R;return regeneratorRuntime.async((function(P){for(;;)switch(P.prev=P.next){case 0:t=e.payloads,r=e.add,n=e.removeIds,a=[],o=!0,i=!1,s=void 0,P.prev=5,u=t[Symbol.iterator]();case 7:if(o=(c=u.next()).done){P.next=55;break}if(l=c.value,p=l.content.references.slice(),!r){P.next=30;break}for(f=!0,y=!1,h=void 0,P.prev=14,d=r[Symbol.iterator]();!(f=(v=d.next()).done);f=!0)m=v.value,p.push(m);P.next=22;break;case 18:P.prev=18,P.t0=P.catch(14),y=!0,h=P.t0;case 22:P.prev=22,P.prev=23,f||null==d.return||d.return();case 25:if(P.prev=25,!y){P.next=28;break}throw h;case 28:return P.finish(25);case 29:return P.finish(22);case 30:if(!n){P.next=50;break}for(g=!0,b=!1,w=void 0,P.prev=34,x=n[Symbol.iterator]();!(g=(k=x.next()).done);g=!0)S=k.value,ct()(p,{uuid:S});P.next=42;break;case 38:P.prev=38,P.t1=P.catch(34),b=!0,w=P.t1;case 42:P.prev=42,P.prev=43,g||null==x.return||x.return();case 45:if(P.prev=45,!b){P.next=48;break}throw w;case 48:return P.finish(45);case 49:return P.finish(42);case 50:R=fa({payload:l,override:{dirty:!0,content:{references:p}}}),a.push(R);case 52:o=!0,P.next=7;break;case 55:P.next=61;break;case 57:P.prev=57,P.t2=P.catch(5),i=!0,s=P.t2;case 61:P.prev=61,P.prev=62,o||null==u.return||u.return();case 64:if(P.prev=64,!i){P.next=67;break}throw s;case 67:return P.finish(64);case 68:return P.finish(61);case 69:return P.abrupt("return",a);case 70:case"end":return P.stop()}}),null,null,[[5,57,61,69],[14,18,22,30],[23,,25,29],[34,38,42,50],[43,,45,49],[62,,64,68]])}var Ir={RemoteRetrieved:1,RemoteSaved:2,LocalSaved:3,LocalRetrieved:4,LocalDirtied:5,ComponentRetrieved:6,DesktopInstalled:7,RemoteActionRetrieved:8,FileImport:9,RemoteConflict:10,ImportConflict:11,SaveOrSaving:12,DecryptedTransient:13,ConflictUuid:14,ConflictData:15};function Dr(e){return[Ir.RemoteRetrieved,Ir.ComponentRetrieved,Ir.RemoteActionRetrieved].includes(e)}function Cr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Er=function(){function e(t,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t.isItem)throw"Cannot create payload from item directly";if(!r)throw"Do not construct payloads directly. Use generator functions";var n=!0,o=!1,i=void 0;try{for(var s,u=this.constructor.fields()[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var c=s.value,l=t[c];Object(a.l)(l)||(this[c]=l)}}catch(e){o=!0,i=e}finally{try{n||null==u.return||u.return()}finally{if(o)throw i}}}var t,r,n;return t=e,n=[{key:"fields",value:function(){throw"Must override PurePayload.fields"}}],(r=[{key:"mergedWith",value:function(e){return fa({payload:this,override:e})}},{key:"fields",value:function(){return this.constructor.fields()}},{key:"getFormat",value:function(){if(Object(a.n)(this.content))return this.content.startsWith(V.V000Base64Decrypted)?te.DecryptedBase64String:te.EncryptedString;if(Object(a.m)(this.content))return te.DecryptedBareObject;throw"Unhandle content format for payload.getFormat()"}},{key:"version",get:function(){return Object(a.n)(this.content)?this.content.substring(0,V.VersionLength):this.content.version}},{key:"isPayload",get:function(){return!0}}])&&Cr(t.prototype,r),n&&Cr(t,n),e}();function Ar(e){return(Ar="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Tr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Mr(e,t){return!t||"object"!==Ar(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Kr(e){return(Kr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Fr(e,t){return(Fr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Lr=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Mr(this,Kr(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Fr(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){throw"Must override SNPureItemPayload.fields"}}],(n=[{key:"compareContentFields",value:function(e){var t=new B(this),r=new B(e);return t.isItemContentEqualWith(r)}},{key:"version",get:function(){return this.content.substring(0,V.VersionLength)}},{key:"discardable",get:function(){return this.deleted&&!this.dirty}}])&&Tr(r.prototype,n),a&&Tr(r,a),t}(Er);function Ur(e){return(Ur="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Nr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Br(e,t){return!t||"object"!==Ur(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Vr(e){return(Vr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Hr(e,t){return(Hr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Wr=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Br(this,Vr(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Hr(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[ae.Uuid,ae.ContentType,ae.ItemsKeyId,ae.EncItemKey,ae.Content,ae.CreatedAt,ae.UpdatedAt,ae.Deleted,ae.Legacy003AuthHash,ae.Legacy003AuthParams,ae.Dirty,ae.DirtiedDate,ae.ErrorDecrypting,ae.WaitingForKey]}}],(n=null)&&Nr(r.prototype,n),a&&Nr(r,a),t}(Lr);function zr(e){return(zr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function qr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Yr(e,t){return!t||"object"!==zr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Jr(e){return(Jr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Gr(e,t){return(Gr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Qr=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Yr(this,Jr(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Gr(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[ae.Uuid,ae.ContentType,ae.ItemsKeyId,ae.EncItemKey,ae.Content,ae.CreatedAt,ae.UpdatedAt,ae.Deleted,ae.Legacy003AuthHash]}}],(n=null)&&qr(r.prototype,n),a&&qr(r,a),t}(Lr);function $r(e){return($r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Xr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Zr(e,t){return!t||"object"!==$r(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function en(e){return(en=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function tn(e,t){return(tn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var rn=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Zr(this,en(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&tn(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[ae.Uuid,ae.ContentType,ae.ItemsKeyId,ae.EncItemKey,ae.Content,ae.CreatedAt,ae.UpdatedAt,ae.Legacy003AuthHash]}}],(n=null)&&Xr(r.prototype,n),a&&Xr(r,a),t}(Lr);function nn(e){return(nn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function an(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function on(e,t){return!t||"object"!==nn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function sn(e){return(sn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function un(e,t){return(un=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var cn=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),on(this,sn(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&un(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[ae.Uuid,ae.ContentType,ae.ItemsKeyId,ae.EncItemKey,ae.Content,ae.CreatedAt,ae.UpdatedAt,ae.Deleted,ae.Legacy003AuthHash,ae.Legacy003AuthParams,ae.Dirty,ae.DirtiedDate,ae.ErrorDecrypting,ae.ErrorDecryptingChanged,ae.WaitingForKey,ae.Dummy,ae.LastSyncBegan,ae.LastSyncEnd]}}],(n=null)&&an(r.prototype,n),a&&an(r,a),t}(Lr);function ln(e){return(ln="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function pn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function fn(e,t){return!t||"object"!==ln(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function yn(e){return(yn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function hn(e,t){return(hn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var dn=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),fn(this,yn(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&hn(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[ae.Uuid,ae.ContentType,ae.UpdatedAt,ae.Deleted,ae.Dirty,ae.LastSyncEnd]}}],(n=null)&&pn(r.prototype,n),a&&pn(r,a),t}(Lr);function vn(e){return(vn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function mn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function gn(e,t){return!t||"object"!==vn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function bn(e){return(bn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function wn(e,t){return(wn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xn=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),gn(this,bn(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&wn(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[ae.ItemsKeyId,ae.EncItemKey,ae.Content,ae.Legacy003AuthHash,ae.ErrorDecrypting,ae.ErrorDecryptingChanged,ae.WaitingForKey]}}],(n=[{key:"getContentFormat",value:function(){return"string"==typeof this.content?this.content.startsWith(V.V000Base64Decrypted)?te.DecryptedBase64String:te.EncryptedString:te.DecryptedBareObject}},{key:"isEncryptionParameters",get:function(){return!0}}])&&mn(r.prototype,n),a&&mn(r,a),t}(Er);function kn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Sn=function(){function e(t){var r=t.baseCollection,n=t.applyCollection,a=t.relatedCollectionSet;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseCollection=r,this.applyCollection=n,this.relatedCollectionSet=a}var t,r,n;return t=e,(r=[{key:"resultingCollection",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override PayloadDelta.resultingCollection.";case 1:case"end":return e.stop()}}))}},{key:"findBasePayload",value:function(e){var t=e.id;return this.baseCollection.findPayload(t)}},{key:"findRelatedPayload",value:function(e){var t=e.id,r=e.source;return this.relatedCollectionSet.collectionForSource(r).findPayload(t)}}])&&kn(t.prototype,r),n&&kn(t,n),e}(),Rn={KeepLeft:1,KeepRight:2,KeepLeftDuplicateRight:3,DuplicateLeftKeepRight:4,KeepLeftMergeRefs:5};function Pn(e){return(Pn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function On(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _n(e,t){return!t||"object"!==Pn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function jn(e){return(jn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function In(e,t){return(In=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Dn=function(e){function t(e){var r,n=e.baseCollection,a=e.basePayload,o=e.applyPayload,i=e.source;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=_n(this,jn(t).call(this,{baseCollection:n}))).basePayload=a,r.applyPayload=o,r.source=i,r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&In(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:function(){var e,t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return e=Pr(this.basePayload),t=Pr(this.applyPayload),r=e.strategyWhenConflictingWithItem({item:t}),a.next=5,regeneratorRuntime.awrap(this.payloadsByHandlingStrategy({strategy:r}));case 5:return n=a.sent,a.abrupt("return",new u({payloads:n,source:this.source}));case 7:case"end":return a.stop()}}),null,this)}},{key:"payloadsByHandlingStrategy",value:function(e){var t,r,n,o,i,s,u,c,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:if((t=e.strategy)!==Rn.KeepLeft){p.next=3;break}return p.abrupt("return",[this.basePayload]);case 3:if(t!==Rn.KeepRight){p.next=5;break}return p.abrupt("return",[this.applyPayload]);case 5:if(t!==Rn.KeepLeftDuplicateRight){p.next=12;break}return r=Object(a.i)(this.basePayload.updated_at,this.applyPayload.updated_at),n=fa({payload:this.basePayload,override:{updated_at:r,dirty:!0}}),p.next=10,regeneratorRuntime.awrap(Or({payload:this.applyPayload,baseCollection:this.baseCollection,isConflict:!0}));case 10:return o=p.sent,p.abrupt("return",[n].concat(o));case 12:if(t!==Rn.DuplicateLeftKeepRight){p.next=18;break}return p.next=15,regeneratorRuntime.awrap(Or({payload:this.basePayload,baseCollection:this.baseCollection,isConflict:!0}));case 15:return i=p.sent,s=this.applyPayload,p.abrupt("return",i.concat([s]));case 18:if(t!==Rn.KeepLeftMergeRefs){p.next=23;break}return u=Object(a.z)(this.basePayload.content.references,this.applyPayload.content.references,["uuid","content_type"]),c=Object(a.i)(this.basePayload.updated_at,this.applyPayload.updated_at),l=fa({payload:this.basePayload,override:{updated_at:c,dirty:!0,content:{references:u}}}),p.abrupt("return",[l]);case 23:throw"Unhandled strategy";case 24:case"end":return p.stop()}}),null,this)}}])&&On(r.prototype,n),o&&On(r,o),t}(Sn);function Cn(e){return(Cn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function En(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function An(e,t){return!t||"object"!==Cn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Tn(e){return(Tn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Mn(e,t){return(Mn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Kn=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),An(this,Tn(t).apply(this,arguments))}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Mn(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:function(){var e,t,r,n,o,i,s,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:e=[],t=!0,r=!1,n=void 0,l.prev=4,o=this.applyCollection.allPayloads[Symbol.iterator]();case 6:if(t=(i=o.next()).done){l.next=15;break}return s=i.value,l.next=10,regeneratorRuntime.awrap(this.payloadsByHandlingPayload({payload:s,currentResults:e}));case 10:c=l.sent,Object(a.f)(e,c);case 12:t=!0,l.next=6;break;case 15:l.next=21;break;case 17:l.prev=17,l.t0=l.catch(4),r=!0,n=l.t0;case 21:l.prev=21,l.prev=22,t||null==o.return||o.return();case 24:if(l.prev=24,!r){l.next=27;break}throw n;case 27:return l.finish(24);case 28:return l.finish(21);case 29:return l.abrupt("return",new u({payloads:e,source:Ir.FileImport}));case 30:case"end":return l.stop()}}),null,this,[[4,17,21,29],[22,,24,28]])}},{key:"payloadsByHandlingPayload",value:function(e){var t,r,n,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(t=e.payload,r=e.currentResults,(n=r.find((function(e){return e.content.conflict_of===t.uuid})))||(n=r.find((function(e){return e.uuid===t.uuid}))),n||(n=this.findBasePayload({id:t.uuid})),n){i.next=6;break}return i.abrupt("return",[t]);case 6:return a=new Dn({baseCollection:this.baseCollection,basePayload:n,applyPayload:t}),i.next=9,regeneratorRuntime.awrap(a.resultingCollection());case 9:return o=i.sent,i.abrupt("return",o.allPayloads);case 11:case"end":return i.stop()}}),null,this)}}])&&En(r.prototype,n),o&&En(r,o),t}(Sn);function Fn(e){return(Fn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ln(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Un(e,t){return!t||"object"!==Fn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Nn(e){return(Nn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Bn(e,t){return(Bn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Vn=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Un(this,Nn(t).apply(this,arguments))}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Bn(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:function(){var e,t,r,n,o,i,s,c,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:e=[],t=!0,r=!1,n=void 0,p.prev=4,o=this.applyCollection.allPayloads[Symbol.iterator]();case 6:if(t=(i=o.next()).done){p.next=22;break}if(s=i.value,e.push(s),c=this.findBasePayload({id:s.uuid})){p.next=12;break}return p.abrupt("continue",19);case 12:if(f=c,y=void 0,h=void 0,y=Pr(s),h=Pr(f),!y.isItemContentEqualWith(h)){p.next=15;break}return p.abrupt("continue",19);case 15:return p.next=17,regeneratorRuntime.awrap(Or({payload:c,baseCollection:this.baseCollection,isConflict:!0}));case 17:l=p.sent,Object(a.f)(e,l);case 19:t=!0,p.next=6;break;case 22:p.next=28;break;case 24:p.prev=24,p.t0=p.catch(4),r=!0,n=p.t0;case 28:p.prev=28,p.prev=29,t||null==o.return||o.return();case 31:if(p.prev=31,!r){p.next=34;break}throw n;case 34:return p.finish(31);case 35:return p.finish(28);case 36:return p.abrupt("return",new u({payloads:e,source:Ir.RemoteRetrieved}));case 37:case"end":return p.stop()}var f,y,h}),null,this,[[4,24,28,36],[29,,31,35]])}}])&&Ln(r.prototype,n),o&&Ln(r,o),t}(Sn);function Hn(e){return(Hn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Wn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function zn(e,t){return!t||"object"!==Hn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function qn(e){return(qn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Yn(e,t){return(Yn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Jn=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),zn(this,qn(t).apply(this,arguments))}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Yn(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.applyCollection.source!==Ir.ConflictUuid){e.next=4;break}return e.abrupt("return",this.collectionsByHandlingUuidConflicts());case 4:if(this.applyCollection.source!==Ir.ConflictData){e.next=8;break}return e.abrupt("return",this.collectionsByHandlingDataConflicts());case 8:throw"Unhandled conflict type ".concat(this.applyCollection.source);case 9:case"end":return e.stop()}}),null,this)}},{key:"collectionsByHandlingDataConflicts",value:function(){var e,t,r,n,o,i,s,c,l,p,f,y;return regeneratorRuntime.async((function(h){for(;;)switch(h.prev=h.next){case 0:e=[],t=!0,r=!1,n=void 0,h.prev=4,o=this.applyCollection.allPayloads[Symbol.iterator]();case 6:if(t=(i=o.next()).done){h.next=27;break}if(s=i.value,c=this.findBasePayload({id:s.uuid})){h.next=12;break}return e.push(s),h.abrupt("continue",24);case 12:if(l=this.findRelatedPayload({id:s.uuid,source:Ir.DecryptedTransient})){h.next=18;break}if(s.deleted){h.next=16;break}throw"Unable to find decrypted counterpart for data conflict.";case 16:return e.push(s),h.abrupt("continue",24);case 18:return p=new Dn({baseCollection:this.baseCollection,basePayload:c,applyPayload:l}),h.next=21,regeneratorRuntime.awrap(p.resultingCollection());case 21:f=h.sent,y=f.allPayloads,Object(a.f)(e,y);case 24:t=!0,h.next=6;break;case 27:h.next=33;break;case 29:h.prev=29,h.t0=h.catch(4),r=!0,n=h.t0;case 33:h.prev=33,h.prev=34,t||null==o.return||o.return();case 36:if(h.prev=36,!r){h.next=39;break}throw n;case 39:return h.finish(36);case 40:return h.finish(33);case 41:return h.abrupt("return",new u({payloads:e,source:Ir.RemoteRetrieved}));case 42:case"end":return h.stop()}}),null,this,[[4,29,33,41],[34,,36,40]])}},{key:"collectionsByHandlingUuidConflicts",value:function(){var e,t,r,n,o,i,s,c,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:e=[],t=!0,r=!1,n=void 0,p.prev=4,o=this.applyCollection.allPayloads[Symbol.iterator]();case 6:if(t=(i=o.next()).done){p.next=16;break}return s=i.value,c=this.findRelatedPayload({id:s.uuid,source:Ir.DecryptedTransient}),p.next=11,regeneratorRuntime.awrap(_r({baseCollection:this.baseCollection,payload:c}));case 11:l=p.sent,Object(a.f)(e,l);case 13:t=!0,p.next=6;break;case 16:p.next=22;break;case 18:p.prev=18,p.t0=p.catch(4),r=!0,n=p.t0;case 22:p.prev=22,p.prev=23,t||null==o.return||o.return();case 25:if(p.prev=25,!r){p.next=28;break}throw n;case 28:return p.finish(25);case 29:return p.finish(22);case 30:return p.abrupt("return",new u({payloads:e,source:Ir.RemoteRetrieved}));case 31:case"end":return p.stop()}}),null,this,[[4,18,22,30],[23,,25,29]])}}])&&Wn(r.prototype,n),o&&Wn(r,o),t}(Sn);function Gn(e){return(Gn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Qn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function $n(e,t){return!t||"object"!==Gn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Xn(e){return(Xn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Zn(e,t){return(Zn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ea=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),$n(this,Xn(t).apply(this,arguments))}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Zn(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:function(){var e,t,r,n,o,i,s,c,l,p,f,y,h,d,v,m,g,b;return regeneratorRuntime.async((function(w){for(;;)switch(w.prev=w.next){case 0:e=[],t=[],r=!0,n=!1,o=void 0,w.prev=5,i=this.applyCollection.allPayloads[Symbol.iterator]();case 7:if(r=(s=i.next()).done){w.next=27;break}if(c=s.value,l=this.findRelatedPayload({id:c.uuid,source:Ir.SavedOrSaving}),p=this.findRelatedPayload({id:c.uuid,source:Ir.DecryptedTransient})){w.next=16;break}if(c.deleted){w.next=14;break}throw"Cannot find decrypted for non-deleted payload.";case 14:return e.push(c),w.abrupt("continue",24);case 16:if(!l){w.next=19;break}return t.push(p),w.abrupt("continue",24);case 19:if(!(f=this.findBasePayload({id:c.uuid}))||!f.dirty){w.next=23;break}return t.push(p),w.abrupt("continue",24);case 23:e.push(p);case 24:r=!0,w.next=7;break;case 27:w.next=33;break;case 29:w.prev=29,w.t0=w.catch(5),n=!0,o=w.t0;case 33:w.prev=33,w.prev=34,r||null==i.return||i.return();case 36:if(w.prev=36,!n){w.next=39;break}throw o;case 39:return w.finish(36);case 40:return w.finish(33);case 41:y=[],h=0,d=t;case 43:if(!(h<d.length)){w.next=60;break}if(v=d[h],m=this.findRelatedPayload({id:v.uuid,source:Ir.DecryptedTransient})){w.next=48;break}return w.abrupt("continue",57);case 48:if(g=this.findBasePayload({id:v.uuid})){w.next=51;break}return w.abrupt("continue",57);case 51:if(g.compareContentFields(m)){w.next=57;break}return w.next=55,regeneratorRuntime.awrap(Or({payload:m,baseCollection:this.baseCollection,isConflict:!0}));case 55:b=w.sent,Object(a.f)(y,b);case 57:h++,w.next=43;break;case 60:return w.abrupt("return",new u({payloads:e.concat(y),source:Ir.RemoteRetrieved}));case 61:case"end":return w.stop()}}),null,this,[[5,29,33,41],[34,,36,40]])}}])&&Qn(r.prototype,n),o&&Qn(r,o),t}(Sn);function ta(e){return(ta="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ra(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function na(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function aa(e,t){return!t||"object"!==ta(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function oa(e){return(oa=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ia(e,t){return(ia=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var sa=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),aa(this,oa(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ia(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:function(){var e,t,r,n,a,o,i,s,c,l,p;return regeneratorRuntime.async((function(f){for(;;)switch(f.prev=f.next){case 0:for(e=[],t=!0,r=!1,n=void 0,f.prev=4,a=this.applyCollection.allPayloads[Symbol.iterator]();!(t=(o=a.next()).done);t=!0)s=o.value,c=this.findBasePayload({id:s.uuid}),l=c?c.deleted:s.deleted,p=la({object:s,source:Ir.RemoteSaved,override:(i={},ra(i,ae.LastSyncEnd,new Date),ra(i,ae.Deleted,l),i)}),e.push(p);f.next=12;break;case 8:f.prev=8,f.t0=f.catch(4),r=!0,n=f.t0;case 12:f.prev=12,f.prev=13,t||null==a.return||a.return();case 15:if(f.prev=15,!r){f.next=18;break}throw n;case 18:return f.finish(15);case 19:return f.finish(12);case 20:return f.abrupt("return",new u({payloads:e,source:Ir.RemoteSaved}));case 21:case"end":return f.stop()}}),null,this,[[4,8,12,20],[13,,15,19]])}}])&&na(r.prototype,n),a&&na(r,a),t}(Sn);function ua(e){var t=e.object,r=e.source,n=e.intent,o=e.override;if(!Object(a.l)(r))throw"Use CreateSourcedPayloadFromObject if creating payload with source.";if(!Object(a.l)(n))throw"Use CreateIntentPayloadFromObject if creating payload with intent.";return pa({object:t,payloadClass:cn,override:o})}function ca(e){var t=e.object,r=e.intent,n=e.override;return pa({object:t,payloadClass:function(e){if(e===W.FileEncrypted||e===W.FileDecrypted||e===W.FilePreferEncrypted)return rn;if(e===W.LocalStoragePreferEncrypted||e===W.LocalStorageDecrypted||e===W.LocalStorageEncrypted)return Wr;if(e===W.Sync||e===W.SyncDecrypted)return Qr;throw"No item payload class found for intent ".concat(e)}(r),override:n})}function la(e){var t=e.object,r=e.source,n=e.override;return pa({object:t,payloadClass:da(r),override:n})}function pa(e){var t=e.object,r=e.payloadClass,n=e.override,o=Object(a.t)(t,r.fields());if(n){if(!Object(a.m)(n))throw"Attempting to override payload with non-object";Object(a.e)(o,Object(a.a)(n))}return Object(a.d)(new r(o,!0))}function fa(e){var t=e.payload,r=e.override,n=Object(a.t)(t,t.fields());return r&&Object(a.e)(n,Object(a.a)(r)),Object(a.d)(new t.constructor(n,!0))}function ya(e){var t=Object(a.a)(e);return Object(a.d)(new xn(t,!0))}function ha(e){var t=e.encryptionParameters,r=e.override;if(!t.isEncryptionParameters)throw"Attempting to copy encryption parameters from non-parameters object.";var n=Object(a.t)(t,xn.fields());return r&&Object(a.e)(n,Object(a.a)(r)),Object(a.d)(new xn(n,!0))}function da(e){if(e===Ir.FileImport)return rn;if(e===Ir.LocalRetrieved||e===Ir.LocalDirtied)return Wr;if(e===Ir.RemoteRetrieved||e===Ir.ConflictData||e===Ir.ConflictUuid)return Qr;if(e===Ir.LocalSaved||e===Ir.RemoteSaved)return dn;throw"No item payload class found for source ".concat(e)}function va(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var ma=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.eventObservers=[]}var t,r,n;return t=e,(r=[{key:"addEventObserver",value:function(e){var t=this;return this.eventObservers.push(e),function(){st()(t.eventObservers,e)}}},{key:"notifyEvent",value:function(e,t){var r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:r=!0,n=!1,a=void 0,u.prev=3,o=this.eventObservers[Symbol.iterator]();case 5:if(r=(i=o.next()).done){u.next=12;break}return s=i.value,u.next=9,regeneratorRuntime.awrap(s(e,t||{}));case 9:r=!0,u.next=5;break;case 12:u.next=18;break;case 14:u.prev=14,u.t0=u.catch(3),n=!0,a=u.t0;case 18:u.prev=18,u.prev=19,r||null==o.return||o.return();case 21:if(u.prev=21,!n){u.next=24;break}throw a;case 24:return u.finish(21);case 25:return u.finish(18);case 26:case"end":return u.stop()}}),null,this,[[3,14,18,26],[19,,21,25]])}},{key:"deinit",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}))}},{key:"handleApplicationStage",value:function(e){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}))}},{key:"log",value:function(e){if(this.loggingEnabled){for(var t,r=new Date,n=r.toLocaleTimeString().replace(" PM","").replace(" AM",""),a="".concat(n,".").concat(r.getMilliseconds()),o=arguments.length,i=new Array(o>1?o-1:0),s=1;s<o;s++)i[s-1]=arguments[s];i?(t=console).log.apply(t,[a,e].concat(i)):console.log(a,e)}}}])&&va(t.prototype,r),n&&va(t,n),e}();function ga(e){return(ga="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ba(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function wa(e,t){return!t||"object"!==ga(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function xa(e){return(xa=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ka(e,t){return(ka=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Sa=function(e){function t(e){var r,n=e.deviceInterface;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=wa(this,xa(t).call(this))).deviceInterface=n,r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ka(e,t)}(t,e),r=t,(n=[{key:"alert",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,r){window.alert(e.text),t()})));case 1:case"end":return t.stop()}}))}},{key:"confirm",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,r){window.confirm(e.text)?t():r()})));case 1:case"end":return t.stop()}}))}}])&&ba(r.prototype,n),a&&ba(r,a),t}(ma);var Ra=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.token=t};function Pa(e,t){return"\n          Strict sign in refused server sign in parameters.\n          The latest security version is ".concat(t,", but your account is\n          reported to have version ").concat(e,". If you'd like to proceed\n          with sign in anyway, please disable strict sign in and try again.\n          ")}function Oa(e){return(Oa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ja(e,t){return!t||"object"!==Oa(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ia(e){return(Ia=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Da(e,t){return(Da=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ca=function(e){function t(e){var r,n=e.storageService,a=e.apiService,o=e.alertService,i=e.protocolService,s=e.timeout;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!n||!i)throw"Invalid SessionManager construction";return(r=ja(this,Ia(t).call(this))).protocolService=i,r.storageService=n,r.apiService=a,r.alertService=o||new Sa,r.timeout=s||setTimeout.bind(window),r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Da(e,t)}(t,e),r=t,(n=[{key:"initializeFromDisk",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(this.storageService.getValue(C.User));case 2:if(this.user=r.sent,this.user){r.next=8;break}return r.next=6,regeneratorRuntime.awrap(this.storageService.getValue(C.LegacyUuid));case 6:(e=r.sent)&&(this.user={uuid:e});case 8:return r.next=10,regeneratorRuntime.awrap(this.storageService.getValue(C.Session));case 10:if(!(t=r.sent)){r.next=14;break}return r.next=14,regeneratorRuntime.awrap(this.setSession(new Ra(t)));case 14:case"end":return r.stop()}}),null,this)}},{key:"setSession",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:this.session=e,this.apiService.setSession(this.session);case 2:case"end":return t.stop()}}),null,this)}},{key:"online",value:function(){return!this.offline()}},{key:"offline",value:function(){return Object(a.l)(this.session)}},{key:"getUser",value:function(){return this.user}},{key:"returnAfterTimeout",value:function(e){var t=this;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",new Promise((function(r,n){t.timeout((function(){r(e)}))})));case 1:case"end":return r.stop()}}))}},{key:"signOut",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:this.user=null,this.session=null;case 2:case"end":return e.stop()}}),null,this)}},{key:"register",value:function(e){var t,r,n,a,o,i,s=this;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(t=e.email,!((r=e.password).length<8)){u.next=3;break}return u.abrupt("return",this.apiService.error("\n          Your password must be at least ".concat(8," characters in length.\n          For your security, please choose a longer password or,\n          ideally, a passphrase, and try again.\n         ")));case 3:return u.next=5,regeneratorRuntime.awrap(this.protocolService.createRootKey({identifier:t,password:r}));case 5:return n=u.sent,a=n.key.serverPassword,o=n.keyParams,i=n.key,u.abrupt("return",this.apiService.register({email:t,serverPassword:a,keyParams:o}).then((function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(s.handleAuthResponse(e));case 2:return t.abrupt("return",s.returnAfterTimeout({response:e,keyParams:o,rootKey:i}));case 3:case"end":return t.stop()}}))})));case 10:case"end":return u.stop()}}),null,this)}},{key:"signIn",value:function(e){var t,r,n,a,o,i,s,u,c,l,p,f,y=this;return regeneratorRuntime.async((function(h){for(;;)switch(h.prev=h.next){case 0:return t=e.email,r=e.password,n=e.strict,a=e.mfaKeyPath,o=e.mfaCode,h.next=3,regeneratorRuntime.awrap(this.apiService.getAccountKeyParams({email:t,mfaKeyPath:a,mfaCode:o}).then((function(e){return{keyParams:y.protocolService.createKeyParams(e)}})));case 3:if(!(i=h.sent).error){h.next=6;break}return h.abrupt("return",i);case 6:if((s=i.keyParams)&&s.version){h.next=9;break}return h.abrupt("return",this.apiService.error("Invalid email or password."));case 9:if(this.protocolService.supportedVersions().includes(s.version)){h.next=15;break}if(!this.protocolService.isVersionNewerThanLibraryVersion(s.version)){h.next=14;break}return h.abrupt("return",this.apiService.error("This version of the application does not support your\n                                                      newer account type. Please upgrade to the latest version\n                                                      of Standard Notes to sign in."));case 14:return h.abrupt("return",this.apiService.error("The protocol version associated with your account is\n                                                      outdated and no longer supported by this application.\n                                                      Please visit standardnotes.org/help/security for more\n                                                      information."));case 15:if(!this.protocolService.isProtocolVersionOutdated(s.version)){h.next=26;break}if(u=this.protocolService.costMinimumForVersion(s.version),!(s.kdfIterations<u)){h.next=19;break}return h.abrupt("return",this.apiService.error("Unable to login due to insecure password parameters.\n                                                      Please visit standardnotes.org/help/security for\n                                                      more information."));case 19:return h.next=23,regeneratorRuntime.awrap(this.alertService.confirm({title:"Update Recommended",text:"The encryption version for your account is outdated and\n                                                      requires upgrade. You may proceed with login, but are\n                                                      advised to perform a security update using the web or\n                                                      desktop application. Please visit\n                                                      standardnotes.org/help/security for more information.",confirmButtonText:"Sign In"}).catch((function(){})));case 23:if(h.sent){h.next=26;break}return h.abrupt("return",this.apiService.error());case 26:if(this.protocolService.platformSupportsKeyDerivation(s)){h.next=28;break}return h.abrupt("return",this.apiService.error("Your account was created on a platform with higher security\n                                                      capabilities than this browser supports. If we attempted\n                                                      to generate your login keys here, it would take hours. Please\n                                                      use a browser with more up to date security capabilities,\n                                                      like Google Chrome or Firefox, to log in."));case 28:if(!n){h.next=32;break}if(c=this.protocolService.getLatestVersion(),s.version===c){h.next=32;break}return h.abrupt("return",this.apiService.error(Pa(s.version,c)));case 32:return h.next=34,regeneratorRuntime.awrap(this.protocolService.computeRootKey({password:r,keyParams:s}).then((function(e){return{rootKey:e,serverPassword:e.serverPassword}})));case 34:return l=h.sent,p=l.rootKey,f=l.serverPassword,h.abrupt("return",this.apiService.signIn({email:t,serverPassword:f,mfaKeyPath:a,mfaCode:o}).then((function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(y.handleAuthResponse(e));case 2:return t.abrupt("return",y.returnAfterTimeout({response:e,keyParams:s,rootKey:p}));case 3:case"end":return t.stop()}}))})));case 38:case"end":return h.stop()}}),null,this)}},{key:"changePassword",value:function(e){var t,r,n,a,o,i,s,u,c,l=this;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:return t=e.email,r=e.currentPassword,n=e.currentKeyParams,a=e.newPassword,p.next=3,regeneratorRuntime.awrap(this.protocolService.computeRootKey({password:r,keyParams:n}).then((function(e){return e.serverPassword})));case 3:return o=p.sent,p.next=6,regeneratorRuntime.awrap(this.protocolService.createRootKey({identifier:t,password:a}).then((function(e){return{newRootKey:e.key,newServerPassword:e.key.serverPassword,newKeyParams:e.keyParams}})));case 6:return i=p.sent,s=i.newServerPassword,u=i.newRootKey,c=i.newKeyParams,p.abrupt("return",this.apiService.changePassword({email:t,currentServerPassword:o,newServerPassword:s,newKeyParams:c}).then((function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(l.handleAuthResponse(e));case 2:return t.abrupt("return",l.returnAfterTimeout({response:e,keyParams:c,rootKey:u}));case 3:case"end":return t.stop()}}))})));case 11:case"end":return p.stop()}}),null,this)}},{key:"handleAuthResponse",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.user,this.user=t,n.next=4,regeneratorRuntime.awrap(this.storageService.setValue(C.User,t));case 4:return r=new Ra(e.token),n.next=7,regeneratorRuntime.awrap(this.storageService.setValue(C.Session,r));case 7:return n.next=9,regeneratorRuntime.awrap(this.setSession(r));case 9:case"end":return n.stop()}}),null,this)}}])&&_a(r.prototype,n),o&&_a(r,o),t}(ma),Ea="sync_token",Aa="cursor_token",Ta="compute_integrity",Ma="integrity_hash",Ka="limit",Fa="items",La="api";function Ua(e){return(Ua="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Na(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Ba(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Na(Object(r),!0).forEach((function(t){Va(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Na(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function Va(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ha(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Wa(e,t){return!t||"object"!==Ua(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function za(e){return(za=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function qa(e,t){return(qa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ya=function(e){function t(e){var r,n=e.httpService,a=e.storageService,o=e.host;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Wa(this,za(t).call(this))).httpService=n,r.storageService=a,r.host=o,r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qa(e,t)}(t,e),r=t,(n=[{key:"setHost",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return this.host=e,t.next=3,regeneratorRuntime.awrap(this.storageService.setValue(C.ServerHost,e));case 3:case"end":return t.stop()}}),null,this)}},{key:"getHost",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.host){t.next=5;break}return t.next=3,regeneratorRuntime.awrap(this.storageService.getValue(C.ServerHost));case 3:e=t.sent,this.host=e||window._default_sf_server;case 5:return t.abrupt("return",this.host);case 6:case"end":return t.stop()}}),null,this)}},{key:"setSession",value:function(e){this.session=e}},{key:"path",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(this.getHost());case 2:if(t=r.sent){r.next=5;break}throw"Attempting to build path ".concat(e," with no host.");case 5:if(e){r.next=7;break}throw"Attempting to build path with null path.";case 7:return r.abrupt("return",Object(a.p)(t,e));case 8:case"end":return r.stop()}}),null,this)}},{key:"params",value:function(e){var t=wt()(e,Va({},La,"20190520"));return t}},{key:"error",value:function(e){return{error:{message:e}}}},{key:"errorResponse",value:function(e,t){return this.log("".concat(t,": ").concat(e)),Object(a.m)(e)?e:Object(a.n)(e)?this.error(e):this.error(t)}},{key:"getAccountKeyParams",value:function(e){var t,r,n,a,o,i,s=this;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:return t=e.email,r=e.mfaKeyPath,n=e.mfaCode,u.next=3,regeneratorRuntime.awrap(this.path("/auth/params"));case 3:return a=u.sent,o=this.params(Va({email:t},r,n)),u.next=7,regeneratorRuntime.awrap(this.httpService.getAbsolute({url:a,params:o}).catch((function(e){return s.errorResponse(e,"A server error occurred while trying to sign in. Please try again.")})));case 7:return i=u.sent,u.abrupt("return",i);case 9:case"end":return u.stop()}}),null,this)}},{key:"register",value:function(e){var t,r,n,a,o,i,s=this;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(t=e.email,r=e.serverPassword,n=e.keyParams,!this.registerInProgress){u.next=3;break}return u.abrupt("return",this.error("An existing registration request is already in progress."));case 3:return this.registering=!0,u.next=6,regeneratorRuntime.awrap(this.path("/auth"));case 6:return a=u.sent,o=this.params(Ba({password:r,email:t},n.getPortableValue())),u.next=10,regeneratorRuntime.awrap(this.httpService.postAbsolute({url:a,params:o}).catch((function(e){return s.errorResponse(e,"A server error occurred while trying to register. Please try again.")})));case 10:return i=u.sent,this.registering=!1,u.abrupt("return",i);case 13:case"end":return u.stop()}}),null,this)}},{key:"signIn",value:function(e){var t,r,n,a,o,i,s,u=this;return regeneratorRuntime.async((function(c){for(;;)switch(c.prev=c.next){case 0:if(t=e.email,r=e.serverPassword,n=e.mfaKeyPath,a=e.mfaCode,!this.authenticating){c.next=3;break}return c.abrupt("return",this.error("An existing sign in request is already in progress."));case 3:return this.authenticating=!0,c.next=6,regeneratorRuntime.awrap(this.path("/auth/sign_in"));case 6:return o=c.sent,i=this.params(Va({email:t,password:r},n,a)),c.next=10,regeneratorRuntime.awrap(this.httpService.postAbsolute({url:o,params:i}).catch((function(e){return u.errorResponse(e,"A server error occurred while trying to sign in. Please try again.")})));case 10:return s=c.sent,this.authenticating=!1,c.abrupt("return",s);case 13:case"end":return c.stop()}}),null,this)}},{key:"changePassword",value:function(e){var t,r,n,a,o,i,s=this;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(e.email,t=e.currentServerPassword,r=e.newServerPassword,n=e.newKeyParams,!this.changing){u.next=3;break}return u.abrupt("return",this.error("An existing change password request is already in progress."));case 3:return this.changing=!0,u.next=6,regeneratorRuntime.awrap(this.path("/auth/change_pw"));case 6:return a=u.sent,o=Ba({current_password:t,new_password:r},n.getPortableValue()),u.next=10,regeneratorRuntime.awrap(this.httpService.postAbsolute({url:a,params:o,authentication:this.session.token}).catch((function(e){return s.errorResponse(e,"Something went wrong while changing your password.\n                                                      Your password was not changed. Please try again.")})));case 10:return i=u.sent,this.changing=!1,u.abrupt("return",i);case 13:case"end":return u.stop()}}),null,this)}},{key:"sync",value:function(e){var t,r,n,a,o,i,s,u,c,l,p,f=this;return regeneratorRuntime.async((function(y){for(;;)switch(y.prev=y.next){case 0:return r=e.payloads,n=e.lastSyncToken,a=e.paginationToken,o=e.limit,i=e.checkIntegrity,s=e.contentType,u=e.customEvent,y.next=3,regeneratorRuntime.awrap(this.path("/items/sync"));case 3:return c=y.sent,l=this.params((Va(t={},Fa,r),Va(t,Ea,n),Va(t,Aa,a),Va(t,Ta,i),Va(t,Ka,o),Va(t,"content_type",s),Va(t,"event",u),t)),y.next=7,regeneratorRuntime.awrap(this.httpService.postAbsolute({url:c,params:l,authentication:this.session.token}).catch((function(e){return f.errorResponse(e,"Could not connect to server.")})));case 7:return p=y.sent,y.abrupt("return",p);case 9:case"end":return y.stop()}}),null,this)}}])&&Ha(r.prototype,n),o&&Ha(r,o),t}(ma),Ja=r(19),Ga=r.n(Ja);function Qa(e){return(Qa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function $a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Xa(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Za(e,t,r){return(Za="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=eo(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function eo(e){return(eo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function to(e,t){return(to=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ro(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var no="stream-items",ao="stream-context-item",oo="save-items",io="associate-item",so="deassociate-item",uo="create-item",co="create-items",lo="delete-items",po="set-component-data",fo="install-local-component",yo="toggle-activate-component",ho="request-permissions",vo="duplicate-item",mo="component-registered",go="themes",bo="reply",wo=function(e){function t(e){var r,n=e.modelManager,a=e.syncService,o=e.alertService,i=e.timeout,s=e.environment,u=e.platform;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==Qa(t)&&"function"!=typeof t?Xa(e):t}(this,eo(t).call(this)),ro(Xa(r),"detectFocusChange",(function(){var e=!0,t=!1,n=void 0;try{for(var a,o=function(){var e=a.value;if(document.activeElement===r.iframeForComponent(e))return r.timeout((function(){r.focusChangedForComponent(e)})),"break"},i=r.activeComponents[Symbol.iterator]();!(e=(a=i.next()).done);e=!0){if("break"===o())break}}catch(e){t=!0,n=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw n}}})),ro(Xa(r),"onWindowMessage",(function(e){r.log("Web app: received message",e),e.data.sessionKey&&r.handleMessage(r.componentForSessionKey(e.data.sessionKey),e.data)})),t.ClientDataDomain="org.standardnotes.sn.components",r.timeout=i||setTimeout.bind(window),r.modelManager=n,r.syncService=a,r.alertService=o,r.environment=s,r.platform=u,r.isDesktop=r.environment===P.Desktop,r.isMobile=r.environment===P.Mobile,r.streamObservers=[],r.contextStreamObservers=[],r.activeComponents=[],r.permissionDialogs=[],r.handlers=[],r.configureForGeneralUsage(),s!==P.Mobile&&r.configureForNonMobileUsage(),r}var r,n,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&to(e,t)}(t,e),r=t,(n=[{key:"setDesktopManager",value:function(e){this.desktopManager=e,this.configureForDesktop()}},{key:"configureForGeneralUsage",value:function(){var e=this;this.modelManager.addMappingObserver("*",(function(t,r,n,a,o){var s,u,c,l,p,f,y,h,d,v,m,g,b,w,x,k,S,R,P,O,_;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:(s=t.filter((function(e){return e.content_type===i.Component||e.content_type===i.Theme}))).length>0&&a!==Ir.RemoteSaved&&e.isDesktop&&e.desktopManager.syncComponentsInstallation(s),u=!0,c=!1,l=void 0,r.prev=5,p=s[Symbol.iterator]();case 7:if(u=(f=p.next()).done){r.next=21;break}if(y=f.value,h=ot()(e.activeComponents,{uuid:y.uuid}),!y.active||y.deleted||h){r.next=15;break}return r.next=13,regeneratorRuntime.awrap(e.activateComponent(y));case 13:r.next=18;break;case 15:if(y.active||!h){r.next=18;break}return r.next=18,regeneratorRuntime.awrap(e.deactivateComponent(y));case 18:u=!0,r.next=7;break;case 21:r.next=27;break;case 23:r.prev=23,r.t0=r.catch(5),c=!0,l=r.t0;case 27:r.prev=27,r.prev=28,u||null==p.return||p.return();case 30:if(r.prev=30,!c){r.next=33;break}throw l;case 33:return r.finish(30);case 34:return r.finish(27);case 35:d=!0,v=!1,m=void 0,r.prev=38,g=function(){var r=w.value;if(o&&o===r.component.uuid)return"continue";var n=t.filter((function(e){return-1!==r.contentTypes.indexOf(e.content_type)}));if(0===n.length)return"continue";var a=[{name:no,content_types:r.contentTypes.sort()}];e.runWithPermissions(r.component,a,(function(){e.sendItemsInReply(r.component,n,r.originalMessage)}))},b=e.streamObservers[Symbol.iterator]();case 41:if(d=(w=b.next()).done){r.next=48;break}if("continue"!==g()){r.next=45;break}return r.abrupt("continue",45);case 45:d=!0,r.next=41;break;case 48:r.next=54;break;case 50:r.prev=50,r.t1=r.catch(38),v=!0,m=r.t1;case 54:r.prev=54,r.prev=55,d||null==b.return||b.return();case 57:if(r.prev=57,!v){r.next=60;break}throw m;case 60:return r.finish(57);case 61:return r.finish(54);case 62:x=[{name:ao}],k=!0,S=!1,R=void 0,r.prev=66,P=function(){var r=_.value;if(o&&o===r.component.uuid)return"continue";var n=!0,i=!1,s=void 0;try{for(var u,c=e.handlers[Symbol.iterator]();!(n=(u=c.next()).done);n=!0){var l=u.value;if((l.areas.includes(r.component.area)||l.areas.includes("*"))&&l.contextRequestHandler){var p=l.contextRequestHandler(r.component);p&&function(){var n=ot()(t,{uuid:p.uuid});n&&e.runWithPermissions(r.component,x,(function(){e.sendContextItemInReply(r.component,n,r.originalMessage,a)}))}()}}}catch(e){i=!0,s=e}finally{try{n||null==c.return||c.return()}finally{if(i)throw s}}},O=e.contextStreamObservers[Symbol.iterator]();case 69:if(k=(_=O.next()).done){r.next=76;break}if("continue"!==P()){r.next=73;break}return r.abrupt("continue",73);case 73:k=!0,r.next=69;break;case 76:r.next=82;break;case 78:r.prev=78,r.t2=r.catch(66),S=!0,R=r.t2;case 82:r.prev=82,r.prev=83,k||null==O.return||O.return();case 85:if(r.prev=85,!S){r.next=88;break}throw R;case 88:return r.finish(85);case 89:return r.finish(82);case 90:case"end":return r.stop()}}),null,null,[[5,23,27,35],[28,,30,34],[38,50,54,62],[55,,57,61],[66,78,82,90],[83,,85,89]])}))}},{key:"isNativeExtension",value:function(e){var t=[window._extensions_manager_location,window._batch_manager_location],r=e.content.hosted_url,n=e.content.local_url&&e.content.local_url.replace("sn://","");return t.includes(r)||t.includes(n)}},{key:"deinit",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:Za(eo(t.prototype),"deinit",this).call(this),window&&(window.removeEventListener("focus",this.detectFocusChange,!0),window.removeEventListener("blur",this.detectFocusChange,!0),window.removeEventListener("message",this.onWindowMessage));case 2:case"end":return e.stop()}}),null,this)}},{key:"configureForNonMobileUsage",value:function(){window.addEventListener?window.addEventListener("focus",this.detectFocusChange,!0):window.attachEvent("onfocusout",this.detectFocusChange),window.addEventListener?window.addEventListener("blur",this.detectFocusChange,!0):window.attachEvent("onblur",this.detectFocusChange),window.addEventListener("message",this.onWindowMessage)}},{key:"configureForDesktop",value:function(){var e=this;this.desktopManager.registerUpdateObserver((function(t){t.active&&t.isTheme()&&e.postActiveThemesToAllComponents()}))}},{key:"postActiveThemesToAllComponents",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,a=this.components[Symbol.iterator]();!(e=(n=a.next()).done);e=!0){var o=n.value;!o.isTheme()&&o.active&&o.window&&this.postActiveThemesToComponent(o)}}catch(e){t=!0,r=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw r}}}},{key:"getActiveThemes",value:function(){return this.componentsForArea(Qe).filter((function(e){return e.active}))}},{key:"urlsForActiveThemes",value:function(){var e=this;return this.getActiveThemes().map((function(t){return e.urlForComponent(t)}))}},{key:"postActiveThemesToComponent",value:function(e){var t={themes:this.urlsForActiveThemes()};this.sendMessageToComponent(e,{action:go,data:t})}},{key:"contextItemDidChangeInArea",value:function(e){var t=!0,r=!1,n=void 0;try{for(var a,o=this.handlers[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;if(!1!==i.areas.includes(e)||i.areas.includes("*")){var s=this.contextStreamObservers.filter((function(t){return t.component.area===e})),u=!0,c=!1,l=void 0;try{for(var p,f=s[Symbol.iterator]();!(u=(p=f.next()).done);u=!0){var y=p.value;if(i.contextRequestHandler){var h=i.contextRequestHandler(y.component);h&&this.sendContextItemInReply(y.component,h,y.originalMessage)}}}catch(e){c=!0,l=e}finally{try{u||null==f.return||f.return()}finally{if(c)throw l}}}}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}}},{key:"setComponentHidden",value:function(e,t){if(t)e.hidden=!0;else if(e.hidden){e.hidden=!1;var r=ot()(this.contextStreamObservers,{identifier:e.uuid});r&&this.handleStreamContextItemMessage(e,r.originalMessage);var n=ot()(this.streamObservers,{identifier:e.uuid});n&&this.handleStreamItemsMessage(e,n.originalMessage)}}},{key:"jsonForItem",value:function(e,r,n){var a={uuid:e.uuid,content_type:e.content_type,created_at:e.created_at,updated_at:e.updated_at,deleted:e.deleted};return a.content=e.collapseContent(),a.clientData=e.getDomainDataItem(r.getClientDataKey(),t.ClientDataDomain)||{},!n||n!==Ir.RemoteSaved&&n!==Ir.LocalSaved||(a.isMetadataUpdate=!0),this.removePrivatePropertiesFromResponseItems([a],r),a}},{key:"sendItemsInReply",value:function(e,t,r,n){var a=this;this.log("Web|componentManager|sendItemsInReply",e,t,r);var o={items:{}},i=t.map((function(t){return a.jsonForItem(t,e,n)}));o.items=i,this.replyToMessage(e,r,o)}},{key:"sendContextItemInReply",value:function(e,t,r,n){this.log("Web|componentManager|sendContextItemInReply",e,t,r);var a={item:this.jsonForItem(t,e,n)};this.replyToMessage(e,r,a)}},{key:"replyToMessage",value:function(e,t,r){var n={action:bo,original:t,data:r};this.sendMessageToComponent(e,n)}},{key:"sendMessageToComponent",value:function(e,t){var r=[mo,go];if(!e.hidden||r.includes(t.action)){this.log("Web|sendMessageToComponent",e,t);var n=this.urlForComponent(e);n.startsWith("http")||n.startsWith("file")||(n=window.location.href+n),e.window||this.alertService.alert({text:"Standard Notes is trying to communicate with ".concat(e.name,", \n        but an error is occurring. Please restart this extension and try again.")}),this.isMobile&&(t=JSON.stringify(t)),e.window.postMessage(t,n)}else this.log("Component disabled for current item, ignoring messages.",e.name)}},{key:"componentsForArea",value:function(e){return this.components.filter((function(t){return t.area===e}))}},{key:"urlForComponent",value:function(e){if(e.offlineOnly&&!this.isDesktop)return null;if(e.offlineOnly||this.isDesktop&&e.local_url)return e.local_url&&e.local_url.replace("sn://",this.desktopManager.getExtServerHost());var t=e.hosted_url||e.legacy_url;if(this.isMobile){var r=this.platform===O.Ios?"localhost":"10.0.2.2";t=t.replace("localhost",r).replace("sn.local",r)}return t}},{key:"componentForUrl",value:function(e){return this.components.filter((function(t){return t.hosted_url===e||t.legacy_url===e}))[0]}},{key:"componentForSessionKey",value:function(e){var t=ot()(this.components,{sessionKey:e});if(!t){var r=!0,n=!1,a=void 0;try{for(var o,i=this.handlers[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(s.componentForSessionKeyHandler&&(t=s.componentForSessionKeyHandler(e)))break}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}return t}},{key:"handleMessage",value:function(e,t){var r=this;if(!e)return this.log("Component not defined for message, returning",t),void this.alertService.alert({text:"An extension is trying to communicate with Standard Notes,but there is an error establishing a bridge. Please restart the app and try again."});var n=[oo,io,so,uo,co,lo,po];if(e.readonly&&n.includes(t.action))this.alertService.alert({text:"The extension ".concat(e.name," is trying to save, but it is in a locked state and cannot accept changes.")});else{if(t.action===no)this.handleStreamItemsMessage(e,t);else if(t.action===ao)this.handleStreamContextItemMessage(e,t);else if(t.action===po)this.handleSetComponentDataMessage(e,t);else if(t.action===lo)this.handleDeleteItemsMessage(e,t);else if(t.action===co||t.action===uo)this.handleCreateItemsMessage(e,t);else if(t.action===oo)this.handleSaveItemsMessage(e,t);else if(t.action===yo){var a=this.modelManager.findItem(t.data.uuid);this.handleToggleComponentMessage(e,a,t)}else t.action===ho?this.handleRequestPermissionsMessage(e,t):t.action===fo?this.handleInstallLocalComponentMessage(e,t):t.action===vo&&this.handleDuplicateItemMessage(e,t);var o=!0,i=!1,s=void 0;try{for(var u,c=function(){var n=u.value;n.actionHandler&&(n.areas.includes(e.area)||n.areas.includes("*"))&&r.timeout((function(){n.actionHandler(e,t.action,t.data)}))},l=this.handlers[Symbol.iterator]();!(o=(u=l.next()).done);o=!0)c()}catch(e){i=!0,s=e}finally{try{o||null==l.return||l.return()}finally{if(i)throw s}}}}},{key:"removePrivatePropertiesFromResponseItems",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r.incoming){var n=["updated_at"],a=!0,o=!1,i=void 0;try{for(var s,u=e[Symbol.iterator]();!(a=(s=u.next()).done);a=!0){var c=s.value;if(c.isItem)console.error("Attempting to pass object. Use JSON.");else{var l=!0,p=!1,f=void 0;try{for(var y,h=n[Symbol.iterator]();!(l=(y=h.next()).done);l=!0){var d=y.value;delete c[d]}}catch(e){p=!0,f=e}finally{try{l||null==h.return||h.return()}finally{if(p)throw f}}}}}catch(e){o=!0,i=e}finally{try{a||null==u.return||u.return()}finally{if(o)throw i}}}if(!t||!this.isNativeExtension(t)){var v=["autoupdateDisabled","permissions","active"];r&&r.includeUrls&&(v=v.concat(["url","hosted_url","local_url"]));var m=!0,g=!1,b=void 0;try{for(var w,x=e[Symbol.iterator]();!(m=(w=x.next()).done);m=!0){var k=w.value;if(k.isItem)console.error("Attempting to pass object. Use JSON.");else{var S=!0,R=!1,P=void 0;try{for(var O,_=v[Symbol.iterator]();!(S=(O=_.next()).done);S=!0){var j=O.value;delete k.content[j]}}catch(e){R=!0,P=e}finally{try{S||null==_.return||_.return()}finally{if(R)throw P}}}}}catch(e){g=!0,b=e}finally{try{m||null==x.return||x.return()}finally{if(g)throw b}}}}},{key:"handleStreamItemsMessage",value:function(e,t){var r=this,n=[{name:no,content_types:t.data.content_types.sort()}];this.runWithPermissions(e,n,(function(){ot()(r.streamObservers,{identifier:e.uuid})||r.streamObservers.push({identifier:e.uuid,component:e,originalMessage:t,contentTypes:t.data.content_types});var n=[],a=!0,o=!1,i=void 0;try{for(var s,u=t.data.content_types[Symbol.iterator]();!(a=(s=u.next()).done);a=!0){var c=s.value;n=n.concat(r.modelManager.validItemsForContentType(c))}}catch(e){o=!0,i=e}finally{try{a||null==u.return||u.return()}finally{if(o)throw i}}r.sendItemsInReply(e,n,t)}))}},{key:"handleStreamContextItemMessage",value:function(e,t){var r=this,n=[{name:ao}];this.runWithPermissions(e,n,(function(){ot()(r.contextStreamObservers,{identifier:e.uuid})||r.contextStreamObservers.push({identifier:e.uuid,component:e,originalMessage:t});var n=!0,a=!1,o=void 0;try{for(var i,s=r.handlersForArea(e.area)[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var u=i.value;if(u.contextRequestHandler){var c=u.contextRequestHandler(e);c&&r.sendContextItemInReply(e,c,t)}}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}}))}},{key:"isItemIdWithinComponentContextJurisdiction",value:function(e,t){return this.itemIdsInContextJurisdictionForComponent(t).includes(e)}},{key:"itemIdsInContextJurisdictionForComponent",value:function(e){var t=[],r=!0,n=!1,a=void 0;try{for(var o,i=this.handlersForArea(e.area)[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(s.contextRequestHandler){var u=s.contextRequestHandler(e);u&&t.push(u.uuid)}}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}return t}},{key:"handlersForArea",value:function(e){return this.handlers.filter((function(t){return t.areas.includes(e)}))}},{key:"handleSaveItemsMessage",value:function(e,r){var n,a,o,i,s,u,c,l,p,f,y,h=this;return regeneratorRuntime.async((function(d){for(;;)switch(d.prev=d.next){case 0:n=r.data.items,a=[],o=this.itemIdsInContextJurisdictionForComponent(e),i=n.slice(),s=!0,u=!1,c=void 0,d.prev=7,l=n.slice()[Symbol.iterator]();case 9:if(s=(p=l.next()).done){d.next=18;break}if(f=p.value,!o.includes(f.uuid)){d.next=15;break}return a.push({name:ao}),st()(i,f),d.abrupt("break",18);case 15:s=!0,d.next=9;break;case 18:d.next=24;break;case 20:d.prev=20,d.t0=d.catch(7),u=!0,c=d.t0;case 24:d.prev=24,d.prev=25,s||null==l.return||l.return();case 27:if(d.prev=27,!u){d.next=30;break}throw c;case 30:return d.finish(27);case 31:return d.finish(24);case 32:i.length>0&&(y=Ga()(i.map((function(e){return e.content_type}))).sort(),a.push({name:no,content_types:y})),this.runWithPermissions(e,a,(function(){var a,o,i,s,u,c,l,p,f,y,d,v,m,g,b,w,x,k,S,R;return regeneratorRuntime.async((function(P){for(;;)switch(P.prev=P.next){case 0:for(h.removePrivatePropertiesFromResponseItems(n,e,{includeUrls:!0,incoming:!0}),a=n.map((function(e){return e.uuid})),o=h.modelManager.findItems(a),i=0,s=!0,u=!1,c=void 0,P.prev=7,l=o[Symbol.iterator]();!(s=(p=l.next()).done);s=!0)(f=p.value).locked&&(ct()(n,{uuid:f.uuid}),i++);P.next=15;break;case 11:P.prev=11,P.t0=P.catch(7),u=!0,c=P.t0;case 15:P.prev=15,P.prev=16,s||null==l.return||l.return();case 18:if(P.prev=18,!u){P.next=21;break}throw c;case 21:return P.finish(18);case 22:return P.finish(15);case 23:return i>0&&(y=1===i?"item":"items",d=1===i?"is":"are",h.alertService.alert({title:"Items Locked",text:"".concat(i," ").concat(y," you are attempting to save ").concat(d," locked and cannot be edited.")})),v=n.map((function(e){return ua({object:e})})),P.next=27,regeneratorRuntime.awrap(h.modelManager.mapPayloadsToLocalItems({paylods:v,source:Ir.ComponentRetrieved,sourceKey:e.uuid}));case 27:m=P.sent,g=!0,b=!1,w=void 0,P.prev=31,x=n[Symbol.iterator]();case 33:if(g=(k=x.next()).done){P.next=46;break}if(S=k.value,R=ot()(m,{uuid:S.uuid})){P.next=39;break}return h.alertService.alert({text:"The extension ".concat(e.name," is trying to save an item with type")+"".concat(S.content_type,", but that item does not exist. Please restart this extension and try again.")}),P.abrupt("continue",43);case 39:if(R.locked){P.next=43;break}return S.clientData&&R.setDomainDataItem(e.getClientDataKey(),S.clientData,t.ClientDataDomain),P.next=43,regeneratorRuntime.awrap(h.modelManager.setItemDirty(R,!0,!0,Ir.ComponentRetrieved,e.uuid));case 43:g=!0,P.next=33;break;case 46:P.next=52;break;case 48:P.prev=48,P.t1=P.catch(31),b=!0,w=P.t1;case 52:P.prev=52,P.prev=53,g||null==x.return||x.return();case 55:if(P.prev=55,!b){P.next=58;break}throw w;case 58:return P.finish(55);case 59:return P.finish(52);case 60:h.syncService.sync().then((function(t){var n=Object.assign({},r);n.action=t&&t.error?"save-error":"save-success",h.replyToMessage(e,r,{error:t&&t.error}),h.handleMessage(e,n)}));case 61:case"end":return P.stop()}}),null,null,[[7,11,15,23],[16,,18,22],[31,48,52,60],[53,,55,59]])}));case 34:case"end":return d.stop()}}),null,this,[[7,20,24,32],[25,,27,31]])}},{key:"handleDuplicateItemMessage",value:function(e,t){var r=this,n=t.data.item,a=this.modelManager.findItem(n.uuid),o=[{name:no,content_types:[a.content_type]}];this.runWithPermissions(e,o,(function(){var n;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(r.modelManager.duplicateItem({item:a}));case 2:n=o.sent,r.syncService.sync(),r.replyToMessage(e,t,{item:r.jsonForItem(n,e)});case 5:case"end":return o.stop()}}))}))}},{key:"handleCreateItemsMessage",value:function(e,r){var n=this,a=r.data.item?[r.data.item]:r.data.items,o=Ga()(a.map((function(e){return e.content_type}))),i=[{name:no,content_types:o}];this.runWithPermissions(e,i,(function(){var o,i,s,u,c,l,p,f,y,h;return regeneratorRuntime.async((function(d){for(;;)switch(d.prev=d.next){case 0:n.removePrivatePropertiesFromResponseItems(a,e,{incoming:!0}),o=[],i=!0,s=!1,u=void 0,d.prev=5,c=a[Symbol.iterator]();case 7:if(i=(l=c.next()).done){d.next=21;break}return p=l.value,f=la({object:p,source:Ir.RemoteRetrieved}),y=Pr(f),p.clientData&&y.setDomainDataItem(e.getClientDataKey(),p.clientData,t.ClientDataDomain),n.modelManager.addItem(y),d.next=15,regeneratorRuntime.awrap(n.modelManager.resolveReferencesForItem(y,!0));case 15:return d.next=17,regeneratorRuntime.awrap(n.modelManager.setItemDirty(y,!0));case 17:o.push(y);case 18:i=!0,d.next=7;break;case 21:d.next=27;break;case 23:d.prev=23,d.t0=d.catch(5),s=!0,u=d.t0;case 27:d.prev=27,d.prev=28,i||null==c.return||c.return();case 30:if(d.prev=30,!s){d.next=33;break}throw u;case 33:return d.finish(30);case 34:return d.finish(27);case 35:n.syncService.sync(),h=r.action===uo?{item:n.jsonForItem(o[0],e)}:{items:o.map((function(t){return n.jsonForItem(t,e)}))},n.replyToMessage(e,r,h);case 38:case"end":return d.stop()}}),null,null,[[5,23,27,35],[28,,30,34]])}))}},{key:"handleDeleteItemsMessage",value:function(e,t){var r=this,n=Ga()(t.data.items.map((function(e){return e.content_type}))).sort(),a=[{name:no,content_types:n}];this.runWithPermissions(e,a,(function(){var n,a,o,s,u,c,l,p,f,y,h;return regeneratorRuntime.async((function(d){for(;;)switch(d.prev=d.next){case 0:return n=t.data.items,a=1===n.length?"item":"items",o=null,s=!0,d.next=6,regeneratorRuntime.awrap(r.alertService.confirm({text:"Are you sure you want to delete ".concat(n.length," ").concat(a,"?")}).catch((function(){s=!1})));case 6:if(!s){d.next=45;break}u=!0,c=!1,l=void 0,d.prev=10,p=n[Symbol.iterator]();case 12:if(u=(f=p.next()).done){d.next=27;break}if(y=f.value,h=r.modelManager.findItem(y.uuid)){d.next=18;break}return r.alertService.alert({text:"The item you are trying to delete cannot be found."}),d.abrupt("continue",24);case 18:if(![i.Component,i.Theme].includes(h.content_type)){d.next=21;break}return d.next=21,regeneratorRuntime.awrap(r.deactivateComponent(h,!0));case 21:return d.next=23,regeneratorRuntime.awrap(r.modelManager.setItemToBeDeleted(h));case 23:r.modelManager.notifyMappingObservers([h],Ir.RemoteSaved);case 24:u=!0,d.next=12;break;case 27:d.next=33;break;case 29:d.prev=29,d.t0=d.catch(10),c=!0,l=d.t0;case 33:d.prev=33,d.prev=34,u||null==p.return||p.return();case 36:if(d.prev=36,!c){d.next=39;break}throw l;case 39:return d.finish(36);case 40:return d.finish(33);case 41:r.syncService.sync(),o={deleted:!0},d.next=46;break;case 45:o={deleted:!1};case 46:r.replyToMessage(e,t,o);case 47:case"end":return d.stop()}}),null,null,[[10,29,33,41],[34,,36,40]])}))}},{key:"handleRequestPermissionsMessage",value:function(e,t){var r=this;this.runWithPermissions(e,t.data.permissions,(function(){r.replyToMessage(e,t,{approved:!0})}))}},{key:"handleSetComponentDataMessage",value:function(e,t){var r=this;this.runWithPermissions(e,[],(function(){return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return e.componentData=t.data.componentData,n.next=3,regeneratorRuntime.awrap(r.modelManager.setItemDirty(e,!0));case 3:r.syncService.sync();case 4:case"end":return n.stop()}}))}))}},{key:"handleToggleComponentMessage",value:function(e,t,r){this.toggleComponent(t)}},{key:"toggleComponent",value:function(e){var t,r=this;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(e.area!==et){n.next=4;break}this.openModalComponent(e),n.next=18;break;case 4:if(!e.active){n.next=9;break}return n.next=7,regeneratorRuntime.awrap(this.deactivateComponent(e));case 7:n.next=18;break;case 9:if(e.content_type!==i.Theme){n.next=16;break}return t=this.getActiveThemes(),n.next=13,regeneratorRuntime.awrap(this.activateComponent(e));case 13:e.isLayerable()||setTimeout((function(){var e,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:e=!0,n=!1,a=void 0,u.prev=3,o=t[Symbol.iterator]();case 5:if(e=(i=o.next()).done){u.next=13;break}if(!(s=i.value)||s.isLayerable()){u.next=10;break}return u.next=10,regeneratorRuntime.awrap(r.deactivateComponent(s));case 10:e=!0,u.next=5;break;case 13:u.next=19;break;case 15:u.prev=15,u.t0=u.catch(3),n=!0,a=u.t0;case 19:u.prev=19,u.prev=20,e||null==o.return||o.return();case 22:if(u.prev=22,!n){u.next=25;break}throw a;case 25:return u.finish(22);case 26:return u.finish(19);case 27:case"end":return u.stop()}}),null,null,[[3,15,19,27],[20,,22,26]])}),10),n.next=18;break;case 16:return n.next=18,regeneratorRuntime.awrap(this.activateComponent(e));case 18:case"end":return n.stop()}}),null,this)}},{key:"handleInstallLocalComponentMessage",value:function(e,t){if(this.isNativeExtension(e)){var r=this.modelManager.findItem(t.data.uuid);this.desktopManager.installComponent(r)}}},{key:"runWithPermissions",value:function(e,t,r){e.permissions||(e.permissions=[]),t=Object(a.a)(t);var n=e.permissions,o=!0,i=!1,s=void 0;try{for(var u,c=function(){var e=u.value,r=n.find((function(t){return t.name===e.name}));if(!r)return"continue";var a=e.content_types;if(!a)return st()(t,e),"continue";var o=!0,i=!1,s=void 0;try{for(var c,l=r.content_types[Symbol.iterator]();!(o=(c=l.next()).done);o=!0){var p=c.value;st()(a,p)}}catch(e){i=!0,s=e}finally{try{o||null==l.return||l.return()}finally{if(i)throw s}}0===a.length&&st()(t,e)},l=t.slice()[Symbol.iterator]();!(o=(u=l.next()).done);o=!0)c()}catch(e){i=!0,s=e}finally{try{o||null==l.return||l.return()}finally{if(i)throw s}}t.length>0?this.promptForPermissions(e,t,(function(e){e&&r()})):r()}},{key:"promptForPermissions",value:function(e,t,r){var n=this,a={};a.component=e,a.permissions=t,a.permissionsString=this.permissionsStringForPermissions(t,e),a.actionBlock=r,a.callback=function(r){var o,i,s,u,c,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:if(!r){p.next=24;break}for(o=!0,i=!1,s=void 0,p.prev=4,u=function(){var t=l.value,r=e.permissions.find((function(e){return e.name===t.name}));if(r){var n=r.content_types||[];r.content_types=Ga()(n.concat(t.content_types))}else e.permissions.push(t)},c=t[Symbol.iterator]();!(o=(l=c.next()).done);o=!0)u();p.next=13;break;case 9:p.prev=9,p.t0=p.catch(4),i=!0,s=p.t0;case 13:p.prev=13,p.prev=14,o||null==c.return||c.return();case 16:if(p.prev=16,!i){p.next=19;break}throw s;case 19:return p.finish(16);case 20:return p.finish(13);case 21:return p.next=23,regeneratorRuntime.awrap(n.modelManager.setItemDirty(e,!0));case 23:n.syncService.sync();case 24:n.permissionDialogs=n.permissionDialogs.filter((function(n){return n===a?(n.actionBlock&&n.actionBlock(r),!1):!!(n.component!==e||n.permissions!==t&&(o=t,n.permissions.some((function(e){return!o.find((function(t){return JSON.stringify(t)===JSON.stringify(e)}))}))))||(r&&n.actionBlock&&n.actionBlock(r),!1);var o})),n.permissionDialogs.length>0&&n.presentPermissionsDialog(n.permissionDialogs[0]);case 26:case"end":return p.stop()}}),null,null,[[4,9,13,21],[14,,16,20]])};var o=ot()(this.permissionDialogs,{component:e});this.permissionDialogs.push(a),o?this.log("Existing dialog, not presenting."):this.presentPermissionsDialog(a)}},{key:"presentPermissionsDialog",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"openModalComponent",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"registerHandler",value:function(e){this.handlers.push(e)}},{key:"deregisterHandler",value:function(e){var t=ot()(this.handlers,{identifier:e});t?this.handlers.splice(this.handlers.indexOf(t),1):this.log("Attempting to deregister non-existing handler")}},{key:"registerComponentWindow",value:function(e,t){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e.window===t&&this.log("Web|componentManager","attempting to re-register same component window."),this.log("Web|componentManager|registerComponentWindow",e),e.window=t,r.next=5,regeneratorRuntime.awrap(F.GenerateUuid());case 5:e.sessionKey=r.sent,this.sendMessageToComponent(e,{action:mo,sessionKey:e.sessionKey,componentData:e.componentData,data:{uuid:e.uuid,environment:(o=this.environment,i=void 0,(R(i={},P.Web,"web"),R(i,P.Desktop,"desktop"),R(i,P.Mobile,"mobile"),i)[o]),platform:(n=this.platform,a=void 0,(R(a={},O.MacWeb,"mac-web"),R(a,O.MacDesktop,"mac-desktop"),R(a,O.LinuxWeb,"linux-web"),R(a,O.LinuxDesktop,"linux-desktop"),R(a,O.WindowsWeb,"windows-web"),R(a,O.WindowsDesktop,"windows-desktop"),R(a,O.Ios,"ios"),R(a,O.Android,"android"),a)[n]),activeThemeUrls:this.urlsForActiveThemes()}}),this.postActiveThemesToComponent(e),this.desktopManager&&this.desktopManager.notifyComponentActivation(e);case 9:case"end":return r.stop()}var n,a,o,i}),null,this)}},{key:"activateComponent",value:function(e){var t,r,n,a,o,i,s,u,c=arguments;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:for(t=c.length>1&&void 0!==c[1]&&c[1],r=!0!==e.active,e.active=!0,n=!0,a=!1,o=void 0,l.prev=6,i=this.handlers[Symbol.iterator]();!(n=(s=i.next()).done);n=!0)((u=s.value).areas.includes(e.area)||u.areas.includes("*"))&&u.activationHandler&&u.activationHandler(e);l.next=14;break;case 10:l.prev=10,l.t0=l.catch(6),a=!0,o=l.t0;case 14:l.prev=14,l.prev=15,n||null==i.return||i.return();case 17:if(l.prev=17,!a){l.next=20;break}throw o;case 20:return l.finish(17);case 21:return l.finish(14);case 22:if(!r||t){l.next=26;break}return l.next=25,regeneratorRuntime.awrap(this.modelManager.setItemDirty(e,!0));case 25:this.syncService.sync();case 26:this.activeComponents.includes(e)||this.activeComponents.push(e),e.area===Qe&&this.postActiveThemesToAllComponents();case 28:case"end":return l.stop()}}),null,this,[[6,10,14,22],[15,,17,21]])}},{key:"deactivateComponent",value:function(e){var t,r,n,a,o,i,s,u,c=arguments;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:for(t=c.length>1&&void 0!==c[1]&&c[1],r=!1!==e.active,e.active=!1,e.sessionKey=null,n=!0,a=!1,o=void 0,l.prev=7,i=this.handlers[Symbol.iterator]();!(n=(s=i.next()).done);n=!0)((u=s.value).areas.includes(e.area)||u.areas.includes("*"))&&u.activationHandler&&u.activationHandler(e);l.next=15;break;case 11:l.prev=11,l.t0=l.catch(7),a=!0,o=l.t0;case 15:l.prev=15,l.prev=16,n||null==i.return||i.return();case 18:if(l.prev=18,!a){l.next=21;break}throw o;case 21:return l.finish(18);case 22:return l.finish(15);case 23:if(!r||t){l.next=27;break}return l.next=26,regeneratorRuntime.awrap(this.modelManager.setItemDirty(e,!0));case 26:this.syncService.sync();case 27:st()(this.activeComponents,e),this.streamObservers=this.streamObservers.filter((function(t){return t.component!==e})),this.contextStreamObservers=this.contextStreamObservers.filter((function(t){return t.component!==e})),e.area===Qe&&this.postActiveThemesToAllComponents();case 31:case"end":return l.stop()}}),null,this,[[7,11,15,23],[16,,18,22]])}},{key:"reloadComponent",value:function(e){var t,r,n,a,o,i,s=this;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:for(e.active=!1,t=!0,r=!1,n=void 0,u.prev=4,a=this.handlers[Symbol.iterator]();!(t=(o=a.next()).done);t=!0)((i=o.value).areas.includes(e.area)||i.areas.includes("*"))&&i.activationHandler&&i.activationHandler(e);u.next=12;break;case 8:u.prev=8,u.t0=u.catch(4),r=!0,n=u.t0;case 12:u.prev=12,u.prev=13,t||null==a.return||a.return();case 15:if(u.prev=15,!r){u.next=18;break}throw n;case 18:return u.finish(15);case 19:return u.finish(12);case 20:return this.streamObservers=this.streamObservers.filter((function(t){return t.component!==e})),this.contextStreamObservers=this.contextStreamObservers.filter((function(t){return t.component!==e})),e.area===Qe&&this.postActiveThemesToAllComponents(),u.abrupt("return",new Promise((function(t,r){s.timeout((function(){e.active=!0;var r=!0,n=!1,a=void 0;try{for(var o,i=s.handlers[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var u=o.value;(u.areas.includes(e.area)||u.areas.includes("*"))&&(u.activationHandler&&u.activationHandler(e),t())}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}s.activeComponents.includes(e)||s.activeComponents.push(e),e.area===Qe&&s.postActiveThemesToAllComponents(),t()}))})));case 24:case"end":return u.stop()}}),null,this,[[4,8,12,20],[13,,15,19]])}},{key:"deleteComponent",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.modelManager.setItemToBeDeleted(e));case 2:this.syncService.sync();case 3:case"end":return t.stop()}}),null,this)}},{key:"isComponentActive",value:function(e){return e.active}},{key:"iframeForComponent",value:function(e){for(var t=0,r=Array.from(document.getElementsByTagName("iframe"));t<r.length;t++){var n=r[t];if(n.dataset.componentId===e.uuid)return n}}},{key:"focusChangedForComponent",value:function(e){var t=document.activeElement===this.iframeForComponent(e),r=!0,n=!1,a=void 0;try{for(var o,i=this.handlers[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;s.focusHandler&&s.focusHandler(e,t)}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}},{key:"handleSetSizeEvent",value:function(e,t){var r=function(e,r){var n=Object(a.n)(r.width)?r.width:"".concat(t.width,"px"),o=Object(a.n)(r.height)?r.height:"".concat(t.height,"px");e&&e.setAttribute("style","width:".concat(n,"; height:").concat(o,";"))};if(e.area===Ze||e.area===et){var n=e.area===Ze?"inner":"outer",o=document.getElementById("component-content-".concat(n,"-").concat(e.uuid));o&&r(o,t)}else{var i=this.iframeForComponent(e);if(!i)return;if(r(i,t),e.area===$e){var s=i.parentElement;s&&r(s,t)}}}},{key:"editorForNote",value:function(e){var t=this.componentsForArea(Ge),r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(s.isExplicitlyEnabledForItem(e))return s}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}if(this.isMobile){if(!e.content.mobilePrefersPlainEditor)return this.getDefaultEditor()}else if(!e.getAppDataItem("prefersPlainEditor"))return t.filter((function(e){return e.isDefaultEditor()}))[0]}},{key:"permissionsStringForPermissions",value:function(e,t){var r="",n=e.length,a=function(e,t){return e>0?e===t-1?2===t?" and ":", and ":", ":""};return e.forEach((function(e,s){if(e.name===no){for(var u=e.content_types.map((function(e){var t,r,n=(t=e,(r={},o(r,i.Note,"note"),o(r,i.Tag,"tag"),o(r,i.SmartTag,"smart tag"),o(r,i.ActionsExtension,"action-based extension"),o(r,i.Component,"component"),o(r,i.Editor,"editor"),o(r,i.Theme,"theme"),o(r,i.ServerExtension,"server extension"),o(r,i.Mfa,"two-factor authentication setting"),o(r,i.FilesafeCredentials,"FileSafe credential"),o(r,i.FilesafeFileMetadata,"FileSafe file"),o(r,i.FilesafeIntegration,"FileSafe integration"),r)[t]);return n?n+"s":"items of type "+e})),c="",l=0;l<u.length;l++){var p=u[l];c+=a(l,u.length+n-s-1),c+=p}r+=a(s,n),r+=c,u.length>=2&&s<n-1&&(r+=", ")}else if(e.name===ao){var f,y=(ro(f={},$e,"working note"),ro(f,Xe,"working note"),ro(f,Ge,"working note"),f);r+=a(s,n),r+=y[t.area]}})),r+"."}},{key:"components",get:function(){return this.modelManager.getItems([i.Component,i.Theme])}}])&&$a(r.prototype,n),s&&$a(r,s),t}(ma);function xo(e){return(xo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ko(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function So(e,t){return!t||"object"!==xo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ro(e){return(Ro=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Po(e,t){return(Po=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Oo=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),So(this,Ro(t).apply(this,arguments))}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Po(e,t)}(t,e),r=t,(n=[{key:"getAbsolute",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.url,r=e.params,n=e.authentication,a.abrupt("return",this.runHttp({verb:"get",url:t,params:r,authentication:n}));case 2:case"end":return a.stop()}}),null,this)}},{key:"postAbsolute",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.url,r=e.params,n=e.authentication,a.abrupt("return",this.runHttp({verb:"post",url:t,params:r,authentication:n}));case 2:case"end":return a.stop()}}),null,this)}},{key:"patchAbsolute",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.url,r=e.params,n=e.authentication,a.abrupt("return",this.runHttp({verb:"patch",url:t,params:r,authentication:n}));case 2:case"end":return a.stop()}}),null,this)}},{key:"runHttp",value:function(e){var t,r,n,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=e.verb,r=e.url,n=e.params,a=e.authentication,o=this.createRequest({verb:t,url:r,params:n,authentication:a}),i.abrupt("return",this.runRequest({request:o,verb:t,params:n}));case 3:case"end":return i.stop()}}),null,this)}},{key:"createRequest",value:function(e){var t=e.verb,r=e.url,n=e.params,a=e.authentication,o=new XMLHttpRequest;return"get"===t&&Object.keys(n).length>0&&(r=this.urlForUrlAndParams(r,n)),o.open(t,r,!0),o.setRequestHeader("Content-type","application/json"),a&&o.setRequestHeader("Authorization","Bearer "+a),o}},{key:"runRequest",value:function(e){var t,r,n,a=this;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=e.request,r=e.verb,n=e.params,o.abrupt("return",new Promise((function(e,o){t.onreadystatechange=function(){a.stateChangeHandlerForRequest(t,e,o)},"post"===r||"patch"===r?t.send(JSON.stringify(n)):t.send()})));case 2:case"end":return o.stop()}}))}},{key:"stateChangeHandlerForRequest",value:function(e,t,r){if(4===e.readyState){var n=e.responseText;if(n)try{n=JSON.parse(n)}catch(e){}Object(a.m)(n)||(n={});var o=e.status;o>=200&&o<=299?(n.status=o,t(n)):(console.error("Request error:",n),Object(a.n)(n)&&(n={error:{message:n}}),n.error||(n.error={status:o}),n.status=o,r(n))}}},{key:"urlForUrlAndParams",value:function(e,t){var r=Object.keys(t).map((function(e){return e+"="+encodeURIComponent(t[e])})).join("&");return e.includes("?")?e+"&"+r:e+"?"+r}}])&&ko(r.prototype,n),o&&ko(r,o),t}(ma),_o=r(52),jo=r.n(_o);function Io(e){return(Io="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Do(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var r=[],n=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Co(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Eo(e,t){return!t||"object"!==Io(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ao(e,t,r){return(Ao="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=To(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function To(e){return(To=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Mo(e,t){return(Mo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ko=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=Eo(this,To(t).call(this))).mappingObservers=[],e.creationObservers=[],e.items=[],e.itemsKeys=[],e.notes=[],e.tags=[],e.components=[],e.itemsHash={},e.resolveQueue={},e.masterCollection=new u,e.systemSmartTags=sr.systemSmartTags(),e}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Mo(e,t)}(t,e),r=t,(n=[{key:"getMasterCollection",value:function(){return this.masterCollection}},{key:"deinit",value:function(){Ao(To(t.prototype),"deinit",this).call(this),this.resetState()}},{key:"resetState",value:function(){this.items.length=0,this.itemsKeys.length=0,this.notes.length=0,this.tags.length=0,this.components.length=0,this.itemsHash={},this.resolveQueue={},this.masterCollection=new u}},{key:"setItemProperties",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.item,r=e.properties,n.abrupt("return",this.setItemsProperties({items:[t],properties:r}));case 2:case"end":return n.stop()}}),null,this)}},{key:"setItemsProperties",value:function(e){var t,r,n,a,o,i,s,u,c,l,p,f,y,h,d;return regeneratorRuntime.async((function(v){for(;;)switch(v.prev=v.next){case 0:t=e.items,r=e.properties,n=Object.keys(r),a=!0,o=!1,i=void 0,v.prev=5,s=t[Symbol.iterator]();case 7:if(a=(u=s.next()).done){v.next=31;break}for(c=u.value,l=!0,p=!1,f=void 0,v.prev=12,y=n[Symbol.iterator]();!(l=(h=y.next()).done);l=!0)d=h.value,c[d]=r[d];v.next=20;break;case 16:v.prev=16,v.t0=v.catch(12),p=!0,f=v.t0;case 20:v.prev=20,v.prev=21,l||null==y.return||y.return();case 23:if(v.prev=23,!p){v.next=26;break}throw f;case 26:return v.finish(23);case 27:return v.finish(20);case 28:a=!0,v.next=7;break;case 31:v.next=37;break;case 33:v.prev=33,v.t1=v.catch(5),o=!0,i=v.t1;case 37:v.prev=37,v.prev=38,a||null==s.return||s.return();case 40:if(v.prev=40,!o){v.next=43;break}throw i;case 43:return v.finish(40);case 44:return v.finish(37);case 45:return v.next=47,regeneratorRuntime.awrap(this.mapItems({items:t}));case 47:case"end":return v.stop()}}),null,this,[[5,33,37,45],[12,16,20,28],[21,,23,27],[38,,40,44]])}},{key:"modifyItem",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.item,r=e.modifier,n.abrupt("return",this.modifyItems({items:[t],modifier:r}));case 2:case"end":return n.stop()}}),null,this)}},{key:"modifyItems",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.items,r=e.modifier,n.next=3,regeneratorRuntime.awrap(r());case 3:return n.next=5,regeneratorRuntime.awrap(this.setItemsDirty(t,!0));case 5:case"end":return n.stop()}}),null,this)}},{key:"mapCollectionToLocalItems",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.collection,r=e.sourceKey,n.abrupt("return",this.mapPayloadsToLocalItems({payloads:t.allPayloads,source:t.source,sourceKey:r}));case 2:case"end":return n.stop()}}),null,this)}},{key:"mapItem",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=e.item,r=e.source,n=e.sourceKey,o.next=3,regeneratorRuntime.awrap(this.mapItems({items:[t],source:r,sourceKey:n}));case 3:return a=o.sent,o.abrupt("return",a[0]);case 5:case"end":return o.stop()}}),null,this)}},{key:"mapItems",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=e.items,r=e.source,n=e.sourceKey,a=t.map((function(e){return e.payloadRepresentation()})),o.abrupt("return",this.mapPayloadsToLocalItems({payloads:a,source:r,sourceKey:n}));case 3:case"end":return o.stop()}}),null,this)}},{key:"mapPayloadToLocalItem",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.payload,n.next=3,regeneratorRuntime.awrap(this.mapPayloadsToLocalItems({payloads:[t]}));case 3:return r=n.sent,n.abrupt("return",r[0]);case 5:case"end":return n.stop()}}),null,this)}},{key:"mapPayloadsToLocalItems",value:function(e){var t,r,n,a,o,i,s,c,l,p,f,y,h,d,v,m,g,b,w,x,k,S,R,P,O,_,j,I,D;return regeneratorRuntime.async((function(C){for(;;)switch(C.prev=C.next){case 0:t=e.payloads,r=e.source,n=e.sourceKey,a=[],o=[],i={},s=!0,c=!1,l=void 0,C.prev=7,p=t[Symbol.iterator]();case 9:if(s=(f=p.next()).done){C.next=40;break}if(y=f.value){C.next=14;break}return console.error("Payload is null"),C.abrupt("continue",37);case 14:if(y.isPayload){C.next=16;break}throw"Attempting to map non-payload object into local model.";case 16:if(y.content_type&&y.uuid||y.deleted){C.next=20;break}return console.error("Payload is corrupt:",y),C.abrupt("continue",37);case 20:if(h=this.findItem(y.uuid),d=!1,!0!==y.deleted){C.next=34;break}if(!y.dirty){C.next=28;break}d=!0,h&&(this.removeItemFromRespectiveArray(h),h.updateLocalRelationships()),C.next=34;break;case 28:if(!h){C.next=33;break}return C.next=31,regeneratorRuntime.awrap(this.removeItemLocally(h));case 31:C.next=34;break;case 33:return C.abrupt("continue",37);case 34:h?h.updateFromPayload(y):(h=Pr(y),this.insertItems({items:[h],globalOnly:d}),o.push(h)),h.errorDecrypting||a.push(h),i[h.uuid]={item:h,payload:y};case 37:s=!0,C.next=9;break;case 40:C.next=46;break;case 42:C.prev=42,C.t0=C.catch(7),c=!0,l=C.t0;case 46:C.prev=46,C.prev=47,s||null==p.return||p.return();case 49:if(C.prev=49,!c){C.next=52;break}throw l;case 52:return C.finish(49);case 53:return C.finish(46);case 54:v=[],m=[],g=0,b=Object.keys(i);case 57:if(!(g<b.length)){C.next=89;break}if(w=b[g],x=i[w],k=x.item,S=x.payload,v.push(S),m.push(k),!S.content){C.next=65;break}return C.next=65,regeneratorRuntime.awrap(this.resolveReferencesForItem(k));case 65:for(R=this.popItemsInterestedInMissingItem({item:k}),P=!0,O=!1,_=void 0,C.prev=69,j=R[Symbol.iterator]();!(P=(I=j.next()).done);P=!0)I.value.addItemAsRelationship(k);C.next=77;break;case 73:C.prev=73,C.t1=C.catch(69),O=!0,_=C.t1;case 77:C.prev=77,C.prev=78,P||null==j.return||j.return();case 80:if(C.prev=80,!O){C.next=83;break}throw _;case 83:return C.finish(80);case 84:return C.finish(77);case 85:k.didCompleteMapping(r);case 86:g++,C.next=57;break;case 89:if(D=new u({payloads:m.map((function(e){return e.payloadRepresentation()})),source:r}),this.masterCollection=this.masterCollection.concat(D),!(o.length>0)){C.next=94;break}return C.next=94,regeneratorRuntime.awrap(this.notifyCreationObservers(o,r,n));case 94:return C.next=96,regeneratorRuntime.awrap(this.notifyMappingObservers(a,r,n));case 96:return C.abrupt("return",m);case 97:case"end":return C.stop()}}),null,this,[[7,42,46,54],[47,,49,53],[69,73,77,85],[78,,80,84]])}},{key:"insertItem",value:function(e){var t=e.item;this.insertItems({items:[t]})}},{key:"insertItems",value:function(e){var t=e.items,r=e.globalOnly,n=!0,a=!1,o=void 0;try{for(var s,u=t[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var c=s.value;if(!this.itemsHash[c.uuid]&&(this.itemsHash[c.uuid]=c,this.items.push(c),!r))if(c.content_type===i.ItemsKey)this.itemsKeys.unshift(c);else if(c.content_type===i.Tag){var l=jo()(this.tags,c,(function(e){return e.title?e.title.toLowerCase():""}));this.tags.splice(l,0,c)}else c.content_type===i.Note?this.notes.unshift(c):c.content_type===i.Component&&this.components.unshift(c)}}catch(e){a=!0,o=e}finally{try{n||null==u.return||u.return()}finally{if(a)throw o}}}},{key:"addItem",value:function(e){var t,r=arguments;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=r.length>1&&void 0!==r[1]&&r[1],n.abrupt("return",this.addItems([e],t));case 2:case"end":return n.stop()}}),null,this)}},{key:"addItems",value:function(e){var t,r=arguments;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return r.length>1&&void 0!==r[1]&&r[1],console.warn("ModelManager.addItems is depracated. Use mapPayloadsToLocalItems instead."),t=e.map((function(e){return ua({object:e})})),n.next=5,regeneratorRuntime.awrap(this.mapPayloadsToLocalItems({payloads:t}));case 5:case"end":return n.stop()}}),null,this)}},{key:"resolveRelationshipWhenItemAvailable",value:function(e){var t=e.interestedItem,r=e.missingItemId,n=this.resolveQueue[r]||[];n.push(t),this.resolveQueue[r]=n}},{key:"popItemsInterestedInMissingItem",value:function(e){var t=e.item,r=this.resolveQueue[t.uuid];return delete this.resolveQueue[t.uuid],r||[]}},{key:"resolveReferencesForItem",value:function(e){var t,r,n,a,o,i,s,u,c,l,p,f,y,h,d,v=arguments;return regeneratorRuntime.async((function(m){for(;;)switch(m.prev=m.next){case 0:if(t=v.length>1&&void 0!==v[1]&&v[1],!e.errorDecrypting){m.next=3;break}return m.abrupt("return");case 3:if(r=e.content,e.updateLocalRelationships(),r.references&&!e.deleted){m.next=7;break}return m.abrupt("return");case 7:n=r.references.slice(),a=n.map((function(e){return e.uuid})),o=!0,i=this.findItems(a,o),s=!0,u=!1,c=void 0,m.prev=14,l=i.entries()[Symbol.iterator]();case 16:if(s=(p=l.next()).done){m.next=30;break}if(f=Do(p.value,2),y=f[0],!(h=f[1])){m.next=25;break}if(e.addItemAsRelationship(h),!t){m.next=23;break}return m.next=23,regeneratorRuntime.awrap(this.setItemDirty(h,!0));case 23:m.next=27;break;case 25:d=a[y],this.resolveRelationshipWhenItemAvailable({interestedItem:e,missingItemId:d});case 27:s=!0,m.next=16;break;case 30:m.next=36;break;case 32:m.prev=32,m.t0=m.catch(14),u=!0,c=m.t0;case 36:m.prev=36,m.prev=37,s||null==l.return||l.return();case 39:if(m.prev=39,!u){m.next=42;break}throw c;case 42:return m.finish(39);case 43:return m.finish(36);case 44:case"end":return m.stop()}}),null,this,[[14,32,36,44],[37,,39,43]])}},{key:"addCreationObserver",value:function(e){var t=this;return this.creationObservers.push(e),function(){ct()(t.creationObservers,e)}}},{key:"notifyCreationObservers",value:function(e,t,r){var n,a,o,i,s,u;return regeneratorRuntime.async((function(c){for(;;)switch(c.prev=c.next){case 0:n=!0,a=!1,o=void 0,c.prev=3,i=this.creationObservers[Symbol.iterator]();case 5:if(n=(s=i.next()).done){c.next=12;break}return u=s.value,c.next=9,regeneratorRuntime.awrap(u.callback({items:e,source:t,sourceKey:r}));case 9:n=!0,c.next=5;break;case 12:c.next=18;break;case 14:c.prev=14,c.t0=c.catch(3),a=!0,o=c.t0;case 18:c.prev=18,c.prev=19,n||null==i.return||i.return();case 21:if(c.prev=21,!a){c.next=24;break}throw o;case 24:return c.finish(21);case 25:return c.finish(18);case 26:case"end":return c.stop()}}),null,this,[[3,14,18,26],[19,,21,25]])}},{key:"addMappingObserver",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;Array.isArray(e)||(e=[e]);var a={types:e,priority:n,callback:t};return this.mappingObservers.push(a),function(){st()(r.mappingObservers,a)}}},{key:"notifyMappingObservers",value:function(e,t,r){var n,a,o,i,s,u,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:n=this.mappingObservers.sort((function(e,t){return e.priority<t.priority?-1:1})),a=!0,o=!1,i=void 0,l.prev=4,s=function(){var n,a,o,i,s,u,l,p,f,y;return regeneratorRuntime.async((function(h){for(;;)switch(h.prev=h.next){case 0:for(n=c.value,a=n.types.includes("*")?e:e.filter((function(e){return n.types.includes(e.content_type)})),o=[],i=[],s=!0,u=!1,l=void 0,h.prev=7,p=a[Symbol.iterator]();!(s=(f=p.next()).done);s=!0)(y=f.value).deleted?i.push(y):o.push(y);h.next=15;break;case 11:h.prev=11,h.t0=h.catch(7),u=!0,l=h.t0;case 15:h.prev=15,h.prev=16,s||null==p.return||p.return();case 18:if(h.prev=18,!u){h.next=21;break}throw l;case 21:return h.finish(18);case 22:return h.finish(15);case 23:if(!(a.length>0)){h.next=26;break}return h.next=26,regeneratorRuntime.awrap(n.callback(a,o,i,t,r));case 26:case"end":return h.stop()}}),null,null,[[7,11,15,23],[16,,18,22]])},u=n[Symbol.iterator]();case 7:if(a=(c=u.next()).done){l.next=13;break}return l.next=10,regeneratorRuntime.awrap(s());case 10:a=!0,l.next=7;break;case 13:l.next=19;break;case 15:l.prev=15,l.t0=l.catch(4),o=!0,i=l.t0;case 19:l.prev=19,l.prev=20,a||null==u.return||u.return();case 22:if(l.prev=22,!o){l.next=25;break}throw i;case 25:return l.finish(22);case 26:return l.finish(19);case 27:case"end":return l.stop()}}),null,this,[[4,15,19,27],[20,,22,26]])}},{key:"setItemDirty",value:function(e){var t,r,n,a,o=arguments;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:return t=!(o.length>1&&void 0!==o[1])||o[1],r=o.length>2?o[2]:void 0,n=o.length>3?o[3]:void 0,a=o.length>4?o[4]:void 0,e.content_type===i.Tag&&this.reorderTagLocation(e),s.abrupt("return",this.setItemsDirty([e],t,r,n,a));case 6:case"end":return s.stop()}}),null,this)}},{key:"setItemsDirty",value:function(e){var t,r,n,a,o,i,s,u,c,l,p=arguments;return regeneratorRuntime.async((function(f){for(;;)switch(f.prev=f.next){case 0:t=!(p.length>1&&void 0!==p[1])||p[1],r=p.length>2?p[2]:void 0,n=p.length>3?p[3]:void 0,a=p.length>4?p[4]:void 0,o=!0,i=!1,s=void 0,f.prev=7,u=e[Symbol.iterator]();case 9:if(o=(c=u.next()).done){f.next=17;break}if((l=c.value).isItem){f.next=13;break}throw"Attempting to dirty non-item object.";case 13:l.setDirty({dirty:t,updateClientDate:r,authorized:!0});case 14:o=!0,f.next=9;break;case 17:f.next=23;break;case 19:f.prev=19,f.t0=f.catch(7),i=!0,s=f.t0;case 23:f.prev=23,f.prev=24,o||null==u.return||u.return();case 26:if(f.prev=26,!i){f.next=29;break}throw s;case 29:return f.finish(26);case 30:return f.finish(23);case 31:return f.abrupt("return",this.mapItems({items:e,source:n||Ir.LocalDirtied,sourceKey:a}));case 32:case"end":return f.stop()}}),null,this,[[7,19,23,31],[24,,26,30]])}},{key:"duplicateItem",value:function(e){var t,r,n,a,o,i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(t=e.item,r=e.isConflict,t.isItem){s.next=3;break}throw"Attempting to duplicate non-item object.";case 3:return n=ua({object:t}),s.next=6,regeneratorRuntime.awrap(Or({payload:n,baseCollection:this.getMasterCollection(),isConflict:r}));case 6:return a=s.sent,s.next=9,regeneratorRuntime.awrap(this.mapPayloadsToLocalItems({payloads:a}));case 9:return o=s.sent,i=o.find((function(e){return e.uuid===a[0].uuid})),s.abrupt("return",i);case 12:case"end":return s.stop()}}),null,this)}},{key:"createItem",value:function(e){var t,r,n,a,o,i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(t=e.contentType,r=e.content,n=e.add,a=e.needsSync,t){s.next=3;break}throw"Attempting to create item with no contentType";case 3:return s.t0=ua,s.next=6,regeneratorRuntime.awrap(F.GenerateUuid());case 6:if(s.t1=s.sent,s.t2=t,s.t3=r,s.t4={uuid:s.t1,content_type:s.t2,content:s.t3},s.t5={object:s.t4},o=(0,s.t0)(s.t5),i=Pr(o),!n){s.next=20;break}if(this.insertItem({item:i}),!a){s.next=18;break}return s.next=18,regeneratorRuntime.awrap(this.setItemDirty(i));case 18:return s.next=20,regeneratorRuntime.awrap(this.notifyCreationObservers([i]));case 20:return s.abrupt("return",i);case 21:case"end":return s.stop()}}),null,this)}},{key:"getDirtyItems",value:function(){return this.items.filter((function(e){return e.dirty&&!e.dummy&&(!e.errorDecrypting||e.deleted)}))}},{key:"setItemToBeDeleted",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.deleted=!0,e.dummy){t.next=4;break}return t.next=4,regeneratorRuntime.awrap(this.setItemDirty(e,!0));case 4:return t.next=6,regeneratorRuntime.awrap(this.handleReferencesForItemDeletion(e));case 6:this.removeItemFromRespectiveArray(e);case 7:case"end":return t.stop()}}),null,this)}},{key:"setItemsToBeDeleted",value:function(e){var t,r,n,a,o,i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:t=!0,r=!1,n=void 0,s.prev=3,a=e[Symbol.iterator]();case 5:if(t=(o=a.next()).done){s.next=12;break}return i=o.value,s.next=9,regeneratorRuntime.awrap(this.setItemToBeDeleted(i));case 9:t=!0,s.next=5;break;case 12:s.next=18;break;case 14:s.prev=14,s.t0=s.catch(3),r=!0,n=s.t0;case 18:s.prev=18,s.prev=19,t||null==a.return||a.return();case 21:if(s.prev=21,!r){s.next=24;break}throw n;case 24:return s.finish(21);case 25:return s.finish(18);case 26:case"end":return s.stop()}}),null,this,[[3,14,18,26],[19,,21,25]])}},{key:"handleReferencesForItemDeletion",value:function(e){var t,r,n,a,o,i,s,u,c,l,p,f,y,h;return regeneratorRuntime.async((function(d){for(;;)switch(d.prev=d.next){case 0:if(e.errorDecrypting){d.next=32;break}t=!0,r=!1,n=void 0,d.prev=4,a=e.content.references[Symbol.iterator]();case 6:if(t=(o=a.next()).done){d.next=18;break}if(i=o.value,!(s=this.findItem(i.uuid))){d.next=15;break}if(e.removeItemAsRelationship(s),!s.hasRelationshipWithItem(e)){d.next=15;break}return s.removeItemAsRelationship(e),d.next=15,regeneratorRuntime.awrap(this.setItemDirty(s,!0));case 15:t=!0,d.next=6;break;case 18:d.next=24;break;case 20:d.prev=20,d.t0=d.catch(4),r=!0,n=d.t0;case 24:d.prev=24,d.prev=25,t||null==a.return||a.return();case 27:if(d.prev=27,!r){d.next=30;break}throw n;case 30:return d.finish(27);case 31:return d.finish(24);case 32:u=e.allReferencingItems,c=!0,l=!1,p=void 0,d.prev=36,f=u[Symbol.iterator]();case 38:if(c=(y=f.next()).done){d.next=46;break}return(h=y.value).removeItemAsRelationship(e),d.next=43,regeneratorRuntime.awrap(this.setItemDirty(h,!0));case 43:c=!0,d.next=38;break;case 46:d.next=52;break;case 48:d.prev=48,d.t1=d.catch(36),l=!0,p=d.t1;case 52:d.prev=52,d.prev=53,c||null==f.return||f.return();case 55:if(d.prev=55,!l){d.next=58;break}throw p;case 58:return d.finish(55);case 59:return d.finish(52);case 60:e.resetLocalReferencePointers();case 61:case"end":return d.stop()}}),null,this,[[4,20,24,32],[25,,27,31],[36,48,52,60],[53,,55,59]])}},{key:"removeItemLocally",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:ct()(this.items,{uuid:e.uuid}),delete this.itemsHash[e.uuid],this.removeItemFromRespectiveArray(e),e.isBeingRemovedLocally();case 4:case"end":return t.stop()}}),null,this)}},{key:"removeItemFromRespectiveArray",value:function(e){e.content_type===i.Tag?ct()(this.tags,{uuid:e.uuid}):e.content_type===i.Note?ct()(this.notes,{uuid:e.uuid}):e.content_type===i.Component?ct()(this.components,{uuid:e.uuid}):e.content_type===i.ItemsKey&&ct()(this.itemsKeys,{uuid:e.uuid})}},{key:"getItems",value:function(e){return Array.isArray(e)?this.allItems.filter((function(t){return!t.dummy&&(e.includes(t.content_type)||e.includes("*"))})):this.managedItemsForContentType(e)||this.getItems([e])}},{key:"managedItemsForContentType",value:function(e){return e===i.Note?this.notes:e===i.Component?this.components:e===i.Tag?this.tags:null}},{key:"invalidItems",value:function(){return this.allItems.filter((function(e){return e.errorDecrypting}))}},{key:"validItemsForContentType",value:function(e){return(this.managedItemsForContentType(e)||this.allItems).filter((function(t){return!t.errorDecrypting&&(Array.isArray(e)?e.includes(t.content_type):t.content_type===e)}))}},{key:"findItem",value:function(e){return this.itemsHash[e]}},{key:"findItems",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=[],n=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var u=i.value,c=this.itemsHash[u];(c||t)&&r.push(c)}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return r}},{key:"itemsMatchingPredicate",value:function(e){return this.itemsMatchingPredicates([e])}},{key:"itemsMatchingPredicates",value:function(e){return this.filterItemsWithPredicates(this.allItems,e)}},{key:"filterItemsWithPredicates",value:function(e,t){return e.filter((function(e){if(e.deleted)return!1;var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(!e.satisfiesPredicate(s))return!1}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}return!0}))}},{key:"importPayloads",value:function(e){var t,r,n,a,o,i,s,c,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:return t=new Kn({baseCollection:this.getMasterCollection(),applyCollection:new u({payloads:e,source:Ir.FileImport})}),p.next=3,regeneratorRuntime.awrap(t.resultingCollection());case 3:return r=p.sent,p.next=6,regeneratorRuntime.awrap(this.mapCollectionToLocalItems({collection:r}));case 6:n=p.sent,a=!0,o=!1,i=void 0,p.prev=10,s=n[Symbol.iterator]();case 12:if(a=(c=s.next()).done){p.next=20;break}return l=c.value,p.next=16,regeneratorRuntime.awrap(this.setItemDirty(l,!0,!1));case 16:l.deleted=!1;case 17:a=!0,p.next=12;break;case 20:p.next=26;break;case 22:p.prev=22,p.t0=p.catch(10),o=!0,i=p.t0;case 26:p.prev=26,p.prev=27,a||null==s.return||s.return();case 29:if(p.prev=29,!o){p.next=32;break}throw i;case 32:return p.finish(29);case 33:return p.finish(26);case 34:return p.abrupt("return",n);case 35:case"end":return p.stop()}}),null,this,[[10,22,26,34],[27,,29,33]])}},{key:"noteCount",value:function(){return this.notes.filter((function(e){return!e.dummy})).length}},{key:"removeAllItemsFromMemory",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,a=this.items[Symbol.iterator]();!(e=(n=a.next()).done);e=!0)n.value.deleted=!0}catch(e){t=!0,r=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw r}}this.notifyMappingObservers(this.items),this.resetState()}},{key:"findTagByTitle",value:function(e){return Object(a.g)(this.tags,"title",e)}},{key:"findOrCreateTagByTitle",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(t=this.findTagByTitle(e)){r.next=5;break}return r.next=4,regeneratorRuntime.awrap(this.createItem({contentType:"Tag",content:{title:e},add:!0,needsSync:!0}));case 4:t=r.sent;case 5:return r.abrupt("return",t);case 6:case"end":return r.stop()}}),null,this)}},{key:"reorderTagLocation",value:function(e){st()(this.tags,e),this.tags.splice(jo()(this.tags,e,(function(e){return e.title?e.title.toLowerCase():""})),0,e)}},{key:"notesMatchingSmartTag",value:function(e){var t=[new f("content_type","=","Note"),e.content.predicate];if(!e.content.isTrashTag){var r=new f("content.trashed","=",!1);t.push(r)}return this.itemsMatchingPredicates(t)}},{key:"trashSmartTag",value:function(){return this.systemSmartTags.find((function(e){return e.content.isTrashTag}))}},{key:"trashedItems",value:function(){return this.notesMatchingSmartTag(this.trashSmartTag())}},{key:"emptyTrash",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return e=this.trashedItems(),t.abrupt("return",this.setItemsToBeDeleted(e));case 2:case"end":return t.stop()}}),null,this)}},{key:"getSmartTags",value:function(){var e=this.validItemsForContentType(i.SmartTag).sort((function(e,t){return e.content.title<t.content.title?-1:1}));return this.systemSmartTags.concat(e)}},{key:"allItems",get:function(){return this.items.slice()}},{key:"allNondummyItems",get:function(){return this.items.filter((function(e){return!e.dummy}))}},{key:"nonDeletedItems",get:function(){return this.items.filter((function(e){return!e.dummy&&!e.deleted}))}}])&&Co(r.prototype,n),o&&Co(r,o),t}(ma);function Fo(e){return(Fo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Lo(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Uo(e,t){return!t||"object"!==Fo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function No(e){return(No=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Bo(e,t){return(Bo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Vo=function(e){function t(e){var r,n=e.modelManager,a=e.syncService;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Uo(this,No(t).call(this))).syncService=a,r.modelManager=n,r.addObservers(),r.resolveQueue=[],r.registeredPredicates=[],r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Bo(e,t)}(t,e),r=t,(n=[{key:"popResolveQueue",value:function(){var e=this.resolveQueue.slice();return this.resolveQueue=[],e}},{key:"addObservers",value:function(){var e=this;this.modelManager.addCreationObserver({callback:function(t){var r=t.items;e.resolveQueue=e.resolveQueue.concat(r)}}),this.syncService.addEventObserver((function(t){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(t!==y.DownloadFirstSyncCompleted&&t!==y.FullSyncCompleted){r.next=3;break}return r.next=3,regeneratorRuntime.awrap(e.resolveSingletonsForItems(e.popResolveQueue(),t));case 3:case"end":return r.stop()}}))}))}},{key:"registerPredicate",value:function(e){this.registeredPredicates.push(e)}},{key:"validItemsMatchingPredicate",value:function(e){return this.modelManager.itemsMatchingPredicate(e).filter((function(e){return!e.deleted&&!e.errorDecrypting}))}},{key:"resolveSingletonsForItems",value:function(e,t){var r,n,o,i,s,u,c,l,p,f,h,d=this;return regeneratorRuntime.async((function(v){for(;;)switch(v.prev=v.next){case 0:r=function(e){var t=!0,r=!1,n=void 0;try{for(var a,o=d.registeredPredicates[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;if(e.satisfiesPredicate(i))return d.validItemsMatchingPredicate(i)}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}},n=function(e){return e.isSingleton?d.validItemsMatchingPredicate(e.singletonPredicate):null},o=function(e){var t=n(e);return t||r(e)},i=[],s=!0,u=!1,c=void 0,v.prev=7,l=e[Symbol.iterator]();case 9:if(s=(p=l.next()).done){v.next=22;break}if(f=p.value,!i.includes(f)){v.next=13;break}return v.abrupt("continue",19);case 13:if(h=o(f),Object(a.f)(i,h||[]),h&&!(h.length<=1)){v.next=17;break}return v.abrupt("continue",19);case 17:return v.next=19,regeneratorRuntime.awrap(this.handleStrategy({items:h,strategy:f.singletonStrategy}));case 19:s=!0,v.next=9;break;case 22:v.next=28;break;case 24:v.prev=24,v.t0=v.catch(7),u=!0,c=v.t0;case 28:v.prev=28,v.prev=29,s||null==l.return||l.return();case 31:if(v.prev=31,!u){v.next=34;break}throw c;case 34:return v.finish(31);case 35:return v.finish(28);case 36:i.length>0&&t===y.FullSyncCompleted&&setTimeout((function(){d.syncService.sync()}));case 37:case"end":return v.stop()}}),null,this,[[7,24,28,36],[29,,31,35]])}},{key:"handleStrategy",value:function(e){var t,r,n;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(t=e.items,e.strategy===N){o.next=3;break}throw"Unhandled singleton strategy";case 3:return r=t.sort((function(e,t){return e.errorDecrypting?1:t.errorDecrypting?-1:e.created_at<t.created_at?-1:1})),n=Object(a.c)(r,0),o.next=7,regeneratorRuntime.awrap(this.modelManager.setItemsToBeDeleted(n));case 7:case"end":return o.stop()}}),null,this)}},{key:"findOrCreateSingleton",value:function(e){var t,r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(t=e.predicate,r=e.createPayload,!((n=this.validItemsMatchingPredicate(t)).length>0)){u.next=4;break}return u.abrupt("return",n[0]);case 4:if(this.syncService.getLastSyncDate()){u.next=7;break}return u.next=7,regeneratorRuntime.awrap(this.syncService.sync());case 7:if(!((a=this.validItemsMatchingPredicate(t)).length>0)){u.next=10;break}return u.abrupt("return",a[0]);case 10:return o=this.modelManager.itemsMatchingPredicate(t).filter((function(e){return e.errorDecrypting})),u.next=13,regeneratorRuntime.awrap(this.modelManager.setItemsToBeDeleted(o));case 13:return u.t0=fa,u.t1=r,u.next=17,regeneratorRuntime.awrap(F.GenerateUuid());case 17:return u.t2=u.sent,u.t3={uuid:u.t2,dirty:!0},u.t4={payload:u.t1,override:u.t3},i=(0,u.t0)(u.t4),u.next=23,regeneratorRuntime.awrap(this.modelManager.mapPayloadToLocalItem({payload:i}));case 23:return s=u.sent,u.next=26,regeneratorRuntime.awrap(this.syncService.sync());case 26:return u.abrupt("return",s);case 27:case"end":return u.stop()}}),null,this)}}])&&Lo(r.prototype,n),o&&Lo(r,o),t}(ma);function Ho(e){return(Ho="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Wo(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function zo(e,t){return!t||"object"!==Ho(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function qo(e){return(qo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Yo(e,t){return(Yo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Jo=function(e){function t(e){var r,n=e.alertService,a=e.deviceInterface,o=e.httpService,i=e.modelManager,s=e.protocolService,u=e.syncService;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=zo(this,qo(t).call(this))).alertService=n,r.deviceInterface=a,r.httpService=o,r.modelManager=i,r.protocolService=s,r.syncService=u,r.previousPasswords=[],r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Yo(e,t)}(t,e),r=t,(n=[{key:"getExtensions",value:function(){return this.modelManager.validItemsForContentType(i.ActionsExtension)}},{key:"extensionsInContextOfItem",value:function(e){return this.getExtensions().filter((function(t){return t.supported_types.includes(e.content_type)||t.actionsWithContextForItem(e).length>0}))}},{key:"loadExtensionInContextOfItem",value:function(e,t){var r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return r={content_type:t.content_type,item_uuid:t.uuid},n.abrupt("return",this.httpService.getAbsolute({url:e.url,params:r}).then((function(t){return t.description&&(e.description=t.description),t.supported_types&&(e.supported_types=t.supported_types),t.actions?e.actions=t.actions.map((function(e){return new xt(e)})):e.actions=[],e})).catch((function(e){return console.error("Error loading extension",e),null})));case 2:case"end":return n.stop()}}),null,this)}},{key:"runAction",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:t=e.action,r=e.item,n=e.passwordRequestHandler,t.running=!0,o.t0=t.verb,o.next="get"===o.t0?5:"render"===o.t0?9:"show"===o.t0?13:"post"===o.t0?17:21;break;case 5:return o.next=7,regeneratorRuntime.awrap(this.handleGetAction({action:t,passwordRequestHandler:n}));case 7:return a=o.sent,o.abrupt("break",22);case 9:return o.next=11,regeneratorRuntime.awrap(this.handleRenderAction({action:t,passwordRequestHandler:n}));case 11:return a=o.sent,o.abrupt("break",22);case 13:return o.next=15,regeneratorRuntime.awrap(this.handleShowAction(t));case 15:return a=o.sent,o.abrupt("break",22);case 17:return o.next=19,regeneratorRuntime.awrap(this.handlePostAction(t,r));case 19:return a=o.sent,o.abrupt("break",22);case 21:return o.abrupt("break",22);case 22:return t.lastExecuted=new Date,t.running=!1,o.abrupt("return",a);case 25:case"end":return o.stop()}}),null,this)}},{key:"handleGetAction",value:function(e){var t,r,n=this;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.action,r=e.passwordRequestHandler,a.abrupt("return",new Promise((function(e,a){n.alertService.confirm({text:"Are you sure you want to replace the current note contents with this action's results?",onConfirm:function(){n.runConfirmedGetAction({action:t,passwordRequestHandler:r}).then(e)}})})));case 2:case"end":return a.stop()}}))}},{key:"runConfirmedGetAction",value:function(e){var t,r,n,a,o,i,s,u,c,l,p,f=this;return regeneratorRuntime.async((function(y){for(;;)switch(y.prev=y.next){case 0:return t=e.action,r=e.passwordRequestHandler,y.next=3,regeneratorRuntime.awrap(this.httpService.getAbsolute({url:t.url}).catch((function(e){var r=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return f.alertService.alert({text:r.message}),t.error=!0,{error:r}})));case 3:if(!(n=y.sent).error){y.next=6;break}return y.abrupt("return",n);case 6:return t.error=!1,y.next=9,regeneratorRuntime.awrap(this.payloadByDecryptingResponse({response:n,passwordRequestHandler:r}));case 9:return a=y.sent,y.next=12,regeneratorRuntime.awrap(this.modelManager.mapPayload({payload:a,source:Ir.RemoteActionRetrieved}));case 12:for(o=y.sent,i=!0,s=!1,u=void 0,y.prev=16,c=o[Symbol.iterator]();!(i=(l=c.next()).done);i=!0)p=l.value,this.modelManager.setItemDirty(p,!0);y.next=24;break;case 20:y.prev=20,y.t0=y.catch(16),s=!0,u=y.t0;case 24:y.prev=24,y.prev=25,i||null==c.return||c.return();case 27:if(y.prev=27,!s){y.next=30;break}throw u;case 30:return y.finish(27);case 31:return y.finish(24);case 32:return this.syncService.sync(),y.abrupt("return",{response:n,item:n.item});case 34:case"end":return y.stop()}}),null,this,[[16,20,24,32],[25,,27,31]])}},{key:"handleRenderAction",value:function(e){var t,r,n=this;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.action,r=e.passwordRequestHandler,a.abrupt("return",this.httpService.getAbsolute({url:t.url}).then((function(e){var a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t.error=!1,i.next=3,regeneratorRuntime.awrap(n.payloadByDecryptingResponse({response:e,passwordRequestHandler:r}));case 3:if(!(a=i.sent)){i.next=7;break}return o=n.modelManager.mapPayload({payload:a}),i.abrupt("return",{response:e,item:o});case 7:case"end":return i.stop()}}))})).catch((function(e){var r=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return n.alertService.alert({text:r.message}),t.error=!0,{error:r}})));case 2:case"end":return a.stop()}}),null,this)}},{key:"payloadByDecryptingResponse",value:function(e){var t,r,n,a,o,i,s,u,c,l,p,f,y,h,d;return regeneratorRuntime.async((function(v){for(;;)switch(v.prev=v.next){case 0:return t=e.response,r=e.key,n=e.passwordRequestHandler,a=ua({object:t.item}),v.next=4,regeneratorRuntime.awrap(this.protocolService.payloadByDecryptingPayload({payload:a,key:r}));case 4:if((o=v.sent).errorDecrypting){v.next=7;break}return v.abrupt("return",o);case 7:if(t.auth_params){v.next=10;break}return this.alertService.alert({text:"We were unable to decrypt this revision using your current keys, \n            and this revision is missing metadata that would allow us to try different \n            keys to decrypt it. This can likely be fixed with some manual intervention. \n            Please email hello@standardnotes.org for assistance."}),v.abrupt("return",null);case 10:i=[],s=!0,u=!1,c=void 0,v.prev=14,l=this.previousPasswords[Symbol.iterator]();case 16:if(s=(p=l.next()).done){v.next=34;break}if(f=p.value,!i.includes(f)){v.next=20;break}return v.abrupt("continue",31);case 20:return i.push(f),v.next=23,regeneratorRuntime.awrap(this.protocolService.computeRootKey({password:f,keyParams:t.auth_params}));case 23:if(y=v.sent){v.next=26;break}return v.abrupt("continue",31);case 26:return v.next=28,regeneratorRuntime.awrap(this.payloadByDecryptingResponse({response:t,key:y,passwordRequestHandler:n}));case 28:if(!(h=v.sent)){v.next=31;break}return v.abrupt("return",h);case 31:s=!0,v.next=16;break;case 34:v.next=40;break;case 36:v.prev=36,v.t0=v.catch(14),u=!0,c=v.t0;case 40:v.prev=40,v.prev=41,s||null==l.return||l.return();case 43:if(v.prev=43,!u){v.next=46;break}throw c;case 46:return v.finish(43);case 47:return v.finish(40);case 48:return v.next=50,regeneratorRuntime.awrap(n());case 50:return d=v.sent,this.previousPasswords.push(d),v.abrupt("return",this.payloadByDecryptingResponse({response:t,key:r,passwordRequestHandler:n}));case 53:case"end":return v.stop()}}),null,this,[[14,36,40,48],[41,,43,47]])}},{key:"handlePostAction",value:function(e,t){var r,n,a,o=this;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return r="decrypted"===e.access_type,i.next=3,regeneratorRuntime.awrap(this.outgoingPayloadForItem({item:t,decrypted:r}));case 3:return n=i.sent,a={items:[n]},i.abrupt("return",this.httpService.postAbsolute({url:e.url,params:a}).then((function(t){return e.error=!1,{response:t}})).catch((function(t){return e.error=!0,console.error("Action error response:",t),o.alertService.alert({text:"An issue occurred while processing this action. Please try again."}),{response:t}})));case 6:case"end":return i.stop()}}),null,this)}},{key:"handleShowAction",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return this.deviceInterface.openUrl(e.url),t.abrupt("return",{response:null});case 2:case"end":return t.stop()}}),null,this)}},{key:"outgoingPayloadForItem",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.item,r=e.decrypted,n=void 0!==r&&r?W.FileDecrypted:W.FileEncrypted,a.abrupt("return",this.protocolService.payloadByEncryptingPayload({payload:t.payloadRepresentation(),intent:n}));case 3:case"end":return a.stop()}}),null,this)}}])&&Wo(r.prototype,n),a&&Wo(r,a),t}(ma);function Go(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Qo=function(){function e(t){var r=t.application,n=t.challengeResponder;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.application=r,this.challengeResponder=n,this.stageHandlers={},this.registerStageHandlers()}var t,r,n;return t=e,n=[{key:"timestamp",value:function(){throw"Must override Migration.timestamp"}}],(r=[{key:"registerStageHandlers",value:function(){throw"Must override Migration.registerStageHandlers"}},{key:"registerStageHandler",value:function(e,t){this.stageHandlers[e]=t}},{key:"markDone",value:function(){this.done=!0,this.onDoneHandler&&this.onDoneHandler(),this.onDoneHandler=null}},{key:"onDone",value:function(e){this.onDoneHandler=e}},{key:"handleStage",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(!(t=this.stageHandlers[e])){r.next=4;break}return r.next=4,regeneratorRuntime.awrap(t());case 4:case"end":return r.stop()}}),null,this)}},{key:"requestChallengeResponse",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.challengeResponder(e));case 1:case"end":return t.stop()}}),null,this)}}])&&Go(t.prototype,r),n&&Go(t,n),e}();function $o(e){return($o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Xo(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Zo(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ei(e,t){return!t||"object"!==$o(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ti(e,t,r){return(ti="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ri(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function ri(e){return(ri=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ni(e,t){return(ni=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ai={Default:1,Ephemeral:2},oi={Default:1,Disabled:2},ii={Default:1,Nonwrapped:2},si={Wrapped:"wrapped",Unwrapped:"unwrapped",Nonwrapped:"nonwrapped"},ui=function(e){function t(e){var r,n=e.protocolService,a=e.deviceInterface,o=e.namespace;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=ei(this,ri(t).call(this))).deviceInterface=a,r.protocolService=n,r.namespace=o,r.setPersistencePolicy(ai.Default),r.setEncryptionPolicy(oi.Default),r.storagePersistable=!1,r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ni(e,t)}(t,e),r=t,o=[{key:"defaultValuesObject",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.wrapped,n=void 0===r?{}:r,a=t.unwrapped,o=void 0===a?{}:a,i=t.nonwrapped,s=void 0===i?{}:i;return Xo(e={},si.Wrapped,n),Xo(e,si.Unwrapped,o),Xo(e,si.Nonwrapped,s),e}},{key:"domainKeyForMode",value:function(e){if(e===ii.Default)return si.Unwrapped;if(e===ii.Nonwrapped)return si.Nonwrapped;throw"Invalid mode"}}],(n=[{key:"handleApplicationStage",value:function(e){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(ti(ri(t.prototype),"handleApplicationStage",this).call(this,e));case 2:e===b&&(this.storagePersistable=!0);case 3:case"end":return r.stop()}}),null,this)}},{key:"setPersistencePolicy",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.persistencePolicy=e,this.persistencePolicy!==ai.Ephemeral){t.next=6;break}return t.next=4,regeneratorRuntime.awrap(this.deviceInterface.removeAllRawStorageValues());case 4:return t.next=6,regeneratorRuntime.awrap(this.clearAllPayloads());case 6:case"end":return t.stop()}}),null,this)}},{key:"setEncryptionPolicy",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:this.encryptionPolicy=e;case 1:case"end":return t.stop()}}),null,this)}},{key:"isEphemeralSession",value:function(){return this.persistencePolicy===ai.Ephemeral}},{key:"initializeFromDisk",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(this.deviceInterface.getRawStorageValue(this.getPersistenceKey()));case 2:e=r.sent,t=e?JSON.parse(e):null,this.setInitialValues(t);case 5:case"end":return r.stop()}}),null,this)}},{key:"persistAsValueToDisk",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.deviceInterface.setRawStorageValue(this.getPersistenceKey(),JSON.stringify(e)));case 2:case"end":return t.stop()}}),null,this)}},{key:"setInitialValues",value:function(e){e||(e=this.defaultValuesObject()),e[si.Unwrapped]||(e[si.Unwrapped]={}),this.values=e}},{key:"isStorageWrapped",value:function(){var e=this.values[si.Wrapped];return!Object(a.l)(e)&&Object.keys(e).length>0}},{key:"canDecryptWithKey",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=this.values[si.Wrapped],n.next=3,regeneratorRuntime.awrap(this.decryptWrappedValue({wrappedValue:t,key:e,throws:!1}));case 3:return r=n.sent,n.abrupt("return",!r.errorDecrypting);case 5:case"end":return n.stop()}}),null,this)}},{key:"decryptWrappedValue",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(t=e.wrappedValue,r=e.key,t.content_type){o.next=3;break}throw"Attempting to decrypt nonexistent wrapped value";case 3:return n=ua({object:t,override:{content_type:i.EncryptedStorage}}),o.next=6,regeneratorRuntime.awrap(this.protocolService.payloadByDecryptingPayload({payload:n,key:r}));case 6:return a=o.sent,o.abrupt("return",a);case 8:case"end":return o.stop()}}),null,this)}},{key:"decryptStorage",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=this.values[si.Wrapped],r.next=3,regeneratorRuntime.awrap(this.decryptWrappedValue({wrappedValue:e}));case 3:if(!(t=r.sent).errorDecrypting){r.next=6;break}throw"Unable to decrypt storage.";case 6:this.values[si.Unwrapped]=Object(a.a)(t.content),delete this.values[si.Wrapped];case 8:case"end":return r.stop()}}),null,this)}},{key:"generatePersistenceValue",value:function(){var e,t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return e=Object.assign({},this.values),t=e[si.Unwrapped],a.t0=ua,a.next=5,regeneratorRuntime.awrap(F.GenerateUuid());case 5:return a.t1=a.sent,a.t2=t,a.t3=i.EncryptedStorage,a.t4={uuid:a.t1,content:a.t2,content_type:a.t3},a.t5={object:a.t4},r=(0,a.t0)(a.t5),a.next=13,regeneratorRuntime.awrap(this.protocolService.payloadByEncryptingPayload({payload:r,intent:W.LocalStoragePreferEncrypted}));case 13:return n=a.sent,e[si.Wrapped]=n,e[si.Unwrapped]=null,a.abrupt("return",e);case 17:case"end":return a.stop()}}),null,this)}},{key:"repersistToDisk",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.storagePersistable){t.next=2;break}return t.abrupt("return");case 2:if(this.persistencePolicy!==ai.Ephemeral){t.next=4;break}return t.abrupt("return");case 4:return t.next=6,regeneratorRuntime.awrap(this.generatePersistenceValue());case 6:return e=t.sent,this.values[si.Wrapped]=e[si.Wrapped],t.abrupt("return",this.persistAsValueToDisk(e));case 9:case"end":return t.stop()}}),null,this)}},{key:"setValue",value:function(e,t){var r,n=arguments;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(r=n.length>2&&void 0!==n[2]?n[2]:ii.Default,this.values){a.next=3;break}throw"Attempting to set storage key ".concat(e," before loading local storage.");case 3:return this.values[this.domainKeyForMode(r)][e]=t,a.abrupt("return",this.repersistToDisk());case 5:case"end":return a.stop()}}),null,this)}},{key:"getValue",value:function(e){var t,r=arguments;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(t=r.length>1&&void 0!==r[1]?r[1]:ii.Default,this.values){n.next=3;break}throw"Attempting to get storage key ".concat(e," before loading local storage.");case 3:if(this.values[this.domainKeyForMode(t)]){n.next=5;break}throw"Storage domain mode not available ".concat(t," for key ").concat(e);case 5:return n.abrupt("return",this.values[this.domainKeyForMode(t)][e]);case 6:case"end":return n.stop()}}),null,this)}},{key:"removeValue",value:function(e){var t,r=arguments;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(t=r.length>1&&void 0!==r[1]?r[1]:ii.Default,this.values){n.next=3;break}throw"Attempting to remove storage key ".concat(e," before loading local storage.");case 3:return delete this.values[this.domainKeyForMode(t)][e],n.abrupt("return",this.repersistToDisk());case 5:case"end":return n.stop()}}),null,this)}},{key:"getPersistenceKey",value:function(){return E(this.namespace,C.StorageObject)}},{key:"defaultValuesObject",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.wrapped,r=e.unwrapped,n=e.nonwrapped;return this.constructor.defaultValuesObject({wrapped:t,unwrapped:r,nonwrapped:n})}},{key:"domainKeyForMode",value:function(e){return this.constructor.domainKeyForMode(e)}},{key:"clearValues",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setInitialValues(),e.next=3,regeneratorRuntime.awrap(this.repersistToDisk());case 3:case"end":return e.stop()}}),null,this)}},{key:"getAllRawPayloads",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.getAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),null,this)}},{key:"savePayload",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.savePayloads([e]));case 1:case"end":return t.stop()}}),null,this)}},{key:"savePayloads",value:function(e){var t,r,n,a,o,i,s,u,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:if(this.persistencePolicy!==ai.Ephemeral){l.next=2;break}return l.abrupt("return");case 2:t=[],r=[],n=!0,a=!1,o=void 0,l.prev=7,i=e[Symbol.iterator]();case 9:if(n=(s=i.next()).done){l.next=22;break}if(!(u=s.value).discardable){l.next=15;break}t.push(u),l.next=19;break;case 15:return l.next=17,regeneratorRuntime.awrap(this.protocolService.payloadByEncryptingPayload({payload:u,intent:this.encryptionPolicy===oi.Default?W.LocalStoragePreferEncrypted:W.LocalStorageDecrypted}));case 17:c=l.sent,r.push(c);case 19:n=!0,l.next=9;break;case 22:l.next=28;break;case 24:l.prev=24,l.t0=l.catch(7),a=!0,o=l.t0;case 28:l.prev=28,l.prev=29,n||null==i.return||i.return();case 31:if(l.prev=31,!a){l.next=34;break}throw o;case 34:return l.finish(31);case 35:return l.finish(28);case 36:if(!(t.length>0)){l.next=39;break}return l.next=39,regeneratorRuntime.awrap(this.deletePayloads(t));case 39:return l.next=41,regeneratorRuntime.awrap(this.deviceInterface.saveRawDatabasePayloads(r));case 41:case"end":return l.stop()}}),null,this,[[7,24,28,36],[29,,31,35]])}},{key:"deletePayloads",value:function(e){var t,r,n,a,o,i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:t=!0,r=!1,n=void 0,s.prev=3,a=e[Symbol.iterator]();case 5:if(t=(o=a.next()).done){s.next=12;break}return i=o.value,s.next=9,regeneratorRuntime.awrap(this.deletePayloadWithId(i.uuid));case 9:t=!0,s.next=5;break;case 12:s.next=18;break;case 14:s.prev=14,s.t0=s.catch(3),r=!0,n=s.t0;case 18:s.prev=18,s.prev=19,t||null==a.return||a.return();case 21:if(s.prev=21,!r){s.next=24;break}throw n;case 24:return s.finish(21);case 25:return s.finish(18);case 26:case"end":return s.stop()}}),null,this,[[3,14,18,26],[19,,21,25]])}},{key:"deletePayloadWithId",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.deviceInterface.removeRawDatabasePayloadWithId(e));case 1:case"end":return t.stop()}}),null,this)}},{key:"clearAllPayloads",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.removeAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),null,this)}},{key:"clearAllData",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([this.clearValues(),this.clearAllPayloads()]));case 1:case"end":return e.stop()}}),null,this)}}])&&Zo(r.prototype,n),o&&Zo(r,o),t}(ma);function ci(e){return(ci="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function li(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function pi(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function fi(e,t){return!t||"object"!==ci(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function yi(e){return(yi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function hi(e,t){return(hi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var di=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),fi(this,yi(t).apply(this,arguments))}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&hi(e,t)}(t,e),r=t,o=[{key:"timestamp",value:function(){return new Date("2020-01-15").getTime()}}],(n=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(v,(function(){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(!j(e.application.environment)){t.next=4;break}return t.abrupt("return",e.migrateStorageStructureForWebDesktop());case 4:if(!I(e.application.environment)){t.next=6;break}return t.abrupt("return",e.migrateStorageStructureForMobile());case 6:case"end":return t.stop()}}))})),this.registerStageHandler(g,(function(){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(e.migrateArbitraryRawStorageToManagedStorageAllPlatforms());case 2:return t.next=4,regeneratorRuntime.awrap(e.migrateSessionStorage());case 4:case"end":return t.stop()}}))})),this.registerStageHandler(w,(function(){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(e.createDefaultItemsKeyForAllPlatforms());case 2:e.markDone();case 3:case"end":return t.stop()}}))}))}},{key:"migrateStorageStructureForWebDesktop",value:function(){var e,t,r,n,o,i,s,u,c,l,p,f,y,h,d,v,m,g;return regeneratorRuntime.async((function(b){for(;;)switch(b.prev=b.next){case 0:return t=this.application.deviceInterface,li(e={},si.Wrapped,null),li(e,si.Unwrapped,{}),li(e,si.Nonwrapped,{}),r=e,b.next=4,regeneratorRuntime.awrap(t.getJsonParsedStorageValue("auth_params"));case 4:return(n=b.sent)&&(r.nonwrapped[C.RootKeyParams]=n),b.next=8,regeneratorRuntime.awrap(t.getJsonParsedStorageValue("encryptedStorage"));case 8:if(!(o=b.sent)){b.next=35;break}return i=ua({object:o}),b.next=13,regeneratorRuntime.awrap(this.webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage(i));case 13:if(s=b.sent,u=s.key,c=s.decryptedStoragePayload,l=s.keyParams,r.nonwrapped[C.RootKeyWrapperKeyParams]=l.getPortableValue(),p=Object(a.a)(c.content.storage),r.nonwrapped[C.RootKeyParams]=p.auth_params,f=u,Object(a.l)(p.mk)){b.next=30;break}return b.next=25,regeneratorRuntime.awrap(this.webDesktopHelperExtractAndWrapAccountKeysFromValueStore(u,p));case 25:y=b.sent,h=y.accountKey,d=y.wrappedKey,f=h,r.nonwrapped[C.WrappedRootKey]=d;case 30:return b.next=32,regeneratorRuntime.awrap(this.webDesktopHelperEncryptStorage(f,c,p));case 32:r.wrapped=b.sent,b.next=57;break;case 35:return b.next=37,regeneratorRuntime.awrap(this.application.deviceInterface.getRawStorageValue("ak"));case 37:return v=b.sent,m=Object(a.l)(v)?V.V002:V.V003,b.t0=regeneratorRuntime,b.t1=$,b.next=43,regeneratorRuntime.awrap(this.application.deviceInterface.getRawStorageValue("mk"));case 43:return b.t2=b.sent,b.next=46,regeneratorRuntime.awrap(this.application.deviceInterface.getRawStorageValue("pw"));case 46:return b.t3=b.sent,b.t4=v,b.t5=m,b.t6={masterKey:b.t2,serverPassword:b.t3,dataAuthenticationKey:b.t4,version:b.t5},b.t7={content:b.t6},b.t8=b.t1.Create.call(b.t1,b.t7),b.next=54,b.t0.awrap.call(b.t0,b.t8);case 54:return g=b.sent,b.next=57,regeneratorRuntime.awrap(this.application.deviceInterface.setKeychainValue(g.getPersistableValue()));case 57:return b.next=59,regeneratorRuntime.awrap(this.allPlatformHelperSetStorageStructure(r));case 59:case"end":return b.stop()}}),null,this)}},{key:"allPlatformHelperSetStorageStructure",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return(t=ui.defaultValuesObject(e))[si.Unwrapped]=null,r.next=4,regeneratorRuntime.awrap(this.application.deviceInterface.setRawStorageValue(E(this.application.namespace,C.StorageObject),JSON.stringify(t)));case 4:case"end":return r.stop()}}),null,this)}},{key:"webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage",value:function(e){var t,r,n,a,o,i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,regeneratorRuntime.awrap(this.application.deviceInterface.getJsonParsedStorageValue("offlineParams"));case 2:t=s.sent,r=this.application.protocolService.createKeyParams(t),n={errorDecrypting:!0};case 5:if(!n.errorDecrypting){s.next=18;break}return s.next=8,regeneratorRuntime.awrap(this.requestChallengeResponse(D.LocalPasscode));case 8:return o=s.sent,i=o.value,s.next=12,regeneratorRuntime.awrap(this.application.protocolService.computeRootKey({password:i,keyParams:r}));case 12:return a=s.sent,s.next=15,regeneratorRuntime.awrap(this.application.protocolService.payloadByDecryptingPayload({payload:e,key:a}));case 15:n=s.sent,s.next=5;break;case 18:return s.abrupt("return",{decryptedStoragePayload:n,key:a,keyParams:r});case 19:case"end":return s.stop()}}),null,this)}},{key:"webDesktopHelperExtractAndWrapAccountKeysFromValueStore",value:function(e,t){var r,n,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return r=t.ak?V.V003:V.V002,i.next=3,regeneratorRuntime.awrap($.Create({content:{masterKey:t.mk,serverPassword:t.pw,dataAuthenticationKey:t.ak,version:r}}));case 3:if(n=i.sent,delete t.mk,delete t.pw,delete t.ak,a=ua({object:n}),!e){i.next=12;break}return i.next=11,regeneratorRuntime.awrap(this.application.protocolService.payloadByEncryptingPayload({payload:a,key:e,intent:W.LocalStorageEncrypted}));case 11:o=i.sent;case 12:return i.abrupt("return",{accountKey:n,wrappedKey:o});case 13:case"end":return i.stop()}}),null,this)}},{key:"webDesktopHelperEncryptStorage",value:function(e,t,r){var n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,regeneratorRuntime.awrap(this.application.protocolService.payloadByEncryptingPayload({key:e,intent:W.LocalStoragePreferEncrypted,payload:fa({payload:t,override:{content_type:i.EncryptedStorage,content:r}})}));case 2:return n=a.sent,a.abrupt("return",n);case 4:case"end":return a.stop()}}),null,this)}},{key:"migrateStorageStructureForMobile",value:function(){var e,t,r,n,o,s,u,c,l,p,f,y,h,d,v,m,g,b,w,x,k=this;return regeneratorRuntime.async((function(S){for(;;)switch(S.prev=S.next){case 0:return S.next=2,regeneratorRuntime.awrap(this.application.deviceInterface.getJsonParsedStorageValue("encrypted_account_keys"));case 2:return t=S.sent,S.next=5,regeneratorRuntime.awrap(this.application.deviceInterface.getJsonParsedStorageValue("auth_params"));case 5:return r=S.sent,S.next=8,regeneratorRuntime.awrap(this.application.deviceInterface.getJsonParsedStorageValue("pc_params"));case 8:return n=S.sent,o={nonwrapped:(e={},li(e,C.WrappedRootKey,t),li(e,C.RootKeyWrapperKeyParams,n),li(e,C.RootKeyParams,r),e),unwrapped:{}},S.next=12,regeneratorRuntime.awrap(this.application.deviceInterface.getKeychainValue());case 12:if(s=S.sent,!n){S.next=53;break}if(u=this.application.protocolService.createKeyParams(n),c=function(){var e,t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(k.application.deviceInterface.getKeychainValue());case 2:e=o.sent,t=e.offline.pw,r={serverPassword:null};case 5:if(r.serverPassword===t){o.next=15;break}return o.next=8,regeneratorRuntime.awrap(k.requestChallengeResponse(D.LocalPasscode));case 8:return n=o.sent,a=n.value,o.next=12,regeneratorRuntime.awrap(k.application.protocolService.computeRootKey({password:a,keyParams:u}));case 12:r=o.sent,o.next=5;break;case 15:return o.abrupt("return",r);case 16:case"end":return o.stop()}}))},l=s.offline.timing,o.unwrapped[C.MobilePasscodeTiming]=l,!t){S.next=34;break}return S.next=21,regeneratorRuntime.awrap(c());case 21:return p=S.sent,S.next=24,regeneratorRuntime.awrap(this.application.protocolService.payloadByDecryptingPayload({payload:ua({object:t}),key:p}));case 24:return f=S.sent,y=f.content.accountKeys,h=Object(a.l)(y.ak)?V.V002:V.V003,d=fa({payload:f,override:{content:{masterKey:y.mk,serverPassword:y.pw,dataAuthenticationKey:y.ak,version:y.version||h,accountKeys:null}}}),S.next=30,regeneratorRuntime.awrap(this.application.protocolService.payloadByEncryptingPayload({payload:d,key:p,intent:W.LocalStoragePreferEncrypted}));case 30:v=S.sent,o.nonwrapped[C.WrappedRootKey]=v,S.next=51;break;case 34:if(t){S.next=51;break}return S.next=37,regeneratorRuntime.awrap(c());case 37:return m=S.sent,S.t0=ua,S.next=41,regeneratorRuntime.awrap(F.GenerateUuid());case 41:return S.t1=S.sent,S.t2=o.unwrapped,S.t3=i.EncryptedStorage,S.t4={uuid:S.t1,content:S.t2,content_type:S.t3},S.t5={object:S.t4},g=(0,S.t0)(S.t5),S.next=49,regeneratorRuntime.awrap(this.application.protocolService.payloadByEncryptingPayload({payload:g,key:m,intent:W.LocalStoragePreferEncrypted}));case 49:b=S.sent,o.wrapped=b;case 51:S.next=61;break;case 53:if(!s||!s.mk){S.next=61;break}return w=Object(a.l)(s.ak)?V.V002:V.V003,S.next=58,regeneratorRuntime.awrap($.Create({content:{masterKey:s.mk,serverPassword:s.pw,dataAuthenticationKey:s.ak,version:s.version||w}}));case 58:return x=S.sent,S.next=61,regeneratorRuntime.awrap(this.application.deviceInterface.setKeychainValue(x.getPersistableValue()));case 61:return S.next=63,regeneratorRuntime.awrap(this.allPlatformHelperSetStorageStructure(o));case 63:case"end":return S.stop()}}),null,this)}},{key:"migrateArbitraryRawStorageToManagedStorageAllPlatforms",value:function(){var e,t,r,n,o,i,s,u,c,l,p,f;return regeneratorRuntime.async((function(y){for(;;)switch(y.prev=y.next){case 0:return y.next=2,regeneratorRuntime.awrap(this.application.deviceInterface.getAllRawStorageKeyValues());case 2:e=y.sent,t=[E(this.application.namespace,C.StorageObject),"encryptedStorage","offlineParams","pc_params"],r=function(e){try{return JSON.parse(e)}catch(t){return e}},n=!0,o=!1,i=void 0,y.prev=8,s=e[Symbol.iterator]();case 10:if(n=(u=s.next()).done){y.next=23;break}if(c=u.value,l=c.key,p=c.value,!t.includes(l)){y.next=16;break}return y.abrupt("continue",20);case 16:if(Object(a.l)(p)){y.next=20;break}return f=r(p),y.next=20,regeneratorRuntime.awrap(this.application.storageService.setValue(l,f));case 20:n=!0,y.next=10;break;case 23:y.next=29;break;case 25:y.prev=25,y.t0=y.catch(8),o=!0,i=y.t0;case 29:y.prev=29,y.prev=30,n||null==s.return||s.return();case 32:if(y.prev=32,!o){y.next=35;break}throw i;case 35:return y.finish(32);case 36:return y.finish(29);case 37:case"end":return y.stop()}}),null,this,[[8,25,29,37],[30,,32,36]])}},{key:"migrateSessionStorage",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(this.application.storageService.getValue("jwt"));case 2:if(e=r.sent){r.next=5;break}return r.abrupt("return");case 5:return t=new Ra(e),r.next=8,regeneratorRuntime.awrap(this.application.storageService.setValue(C.Session,t));case 8:case"end":return r.stop()}}),null,this)}},{key:"createDefaultItemsKeyForAllPlatforms",value:function(){var e,t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap(this.application.keyManager.getRootKey());case 2:if(!(e=n.sent)){n.next=14;break}return n.next=6,regeneratorRuntime.awrap(this.application.keyManager.getRootKeyParams());case 6:return t=n.sent,r=Ve.FromRaw({itemsKey:e.masterKey,dataAuthenticationKey:e.dataAuthenticationKey,version:t.version}),n.next=10,regeneratorRuntime.awrap(r.initUUID());case 10:return n.next=12,regeneratorRuntime.awrap(this.application.modelManager.mapItem({item:r}));case 12:return n.next=14,regeneratorRuntime.awrap(this.application.modelManager.setItemDirty(r));case 14:case"end":return n.stop()}}),null,this)}}])&&pi(r.prototype,n),o&&pi(r,o),t}(Qo);function vi(e){return(vi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function mi(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function gi(e,t){return!t||"object"!==vi(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function bi(e){return(bi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function wi(e,t){return(wi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xi=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),gi(this,bi(t).apply(this,arguments))}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&wi(e,t)}(t,e),r=t,o=[{key:"timestamp",value:function(){return new Date("2020-01-01").getTime()}}],(n=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(v,(function(){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(e.migrateMigrationTimestampAllPlatforms());case 2:e.markDone();case 3:case"end":return t.stop()}}))}))}},{key:"migrateMigrationTimestampAllPlatforms",value:function(){var e,t,r,n,o,i,s,u,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:e=!1,t=0,r=["migrations","ephemeral","user","cachedThemes","syncToken"];case 3:if(!(t<r.length)){l.next=14;break}return n=r[t],l.next=7,regeneratorRuntime.awrap(this.application.deviceInterface.getRawStorageValue(n));case 7:if(!l.sent){l.next=11;break}return e=!0,l.abrupt("break",14);case 11:t++,l.next=3;break;case 14:return o=E(this.application.namespace,"last_migration_timestamp"),l.next=17,regeneratorRuntime.awrap(this.application.deviceInterface.getRawStorageValue(o));case 17:if(i=l.sent,(s=!Object(a.l)(i))||!e){l.next=25;break}return u=new Date(0).getTime(),l.next=23,regeneratorRuntime.awrap(this.application.deviceInterface.setRawStorageValue(o,u));case 23:l.next=32;break;case 25:if(s||e){l.next=31;break}return c=(new Date).getTime(),l.next=29,regeneratorRuntime.awrap(this.application.deviceInterface.setRawStorageValue(o,c));case 29:l.next=32;break;case 31:case 32:case"end":return l.stop()}}),null,this)}}])&&mi(r.prototype,n),o&&mi(r,o),t}(Qo);function ki(e){return(ki="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Si(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ri(e,t){return!t||"object"!==ki(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Pi(e,t,r){return(Pi="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Oi(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Oi(e){return(Oi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _i(e,t){return(_i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ji=function(e){function t(e){var r,n=e.application,a=e.challengeResponder;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Ri(this,Oi(t).call(this))).application=n,r.challengeResponder=a,r}var r,o,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_i(e,t)}(t,e),r=t,(o=[{key:"initialize",value:function(){var e,t=this;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(this.runBaseMigration());case 2:return r.next=4,regeneratorRuntime.awrap(this.getRequiredMigrations());case 4:this.activeMigrations=r.sent,this.activeMigrations.length>0&&(e=Object(a.q)(this.activeMigrations)).onDone((function(){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(t.saveLastMigrationTimestamp(e.constructor.timestamp()));case 2:case"end":return r.stop()}}))}));case 6:case"end":return r.stop()}}),null,this)}},{key:"handleApplicationStage",value:function(e){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(Pi(Oi(t.prototype),"handleApplicationStage",this).call(this,e));case 2:return e===m&&(this.addLoginObserver(),this.addSyncObserver()),r.next=5,regeneratorRuntime.awrap(this.handleStage(e));case 5:case"end":return r.stop()}}),null,this)}},{key:"runBaseMigration",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return e=new xi({application:this.application}),t.next=3,regeneratorRuntime.awrap(e.handleStage(v));case 3:case"end":return t.stop()}}),null,this)}},{key:"getRequiredMigrations",value:function(){var e,t,r,a,o,i,s,u,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,regeneratorRuntime.awrap(this.getLastMigrationTimestamp());case 2:for(e=l.sent,t=[],r=Object.keys(n).map((function(e){return n[e]})).sort((function(e,t){var r=e.timestamp(),n=t.timestamp();return r<n?-1:r>n?1:0})),a=!0,o=!1,i=void 0,l.prev=8,s=r[Symbol.iterator]();!(a=(u=s.next()).done);a=!0)(c=u.value).timestamp()>e&&t.push(new c({application:this.application,challengeResponder:this.challengeResponder}));l.next=16;break;case 12:l.prev=12,l.t0=l.catch(8),o=!0,i=l.t0;case 16:l.prev=16,l.prev=17,a||null==s.return||s.return();case 19:if(l.prev=19,!o){l.next=22;break}throw i;case 22:return l.finish(19);case 23:return l.finish(16);case 24:return l.abrupt("return",t);case 25:case"end":return l.stop()}}),null,this,[[8,12,16,24],[17,,19,23]])}},{key:"getTimeStampKey",value:function(){return E(this.application.namespace,"last_migration_timestamp")}},{key:"getLastMigrationTimestamp",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.application.deviceInterface.getRawStorageValue(this.getTimeStampKey()));case 2:if(e=t.sent,!Object(a.l)(e)){t.next=5;break}throw"Timestamp should not be null. Be sure to run base migration first.";case 5:return t.abrupt("return",JSON.parse(e));case 6:case"end":return t.stop()}}),null,this)}},{key:"saveLastMigrationTimestamp",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.application.deviceInterface.setRawStorageValue(this.getTimeStampKey(),JSON.stringify(e)));case 2:case"end":return t.stop()}}),null,this)}},{key:"addLoginObserver",value:function(){var e=this;this.application.addEventObserver((function(t,r){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(t!==d.SignedIn){r.next=3;break}return r.next=3,regeneratorRuntime.awrap(e.handleStage(S));case 3:case"end":return r.stop()}}))}))}},{key:"addSyncObserver",value:function(){var e=this;this.application.syncService.addEventObserver((function(t,r){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(t!==y.FullSyncCompleted){r.next=3;break}return r.next=3,regeneratorRuntime.awrap(e.handleStage(k));case 3:case"end":return r.stop()}}))}))}},{key:"handleStage",value:function(e){var t,r,n,a,o,i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:t=!0,r=!1,n=void 0,s.prev=3,a=this.activeMigrations[Symbol.iterator]();case 5:if(t=(o=a.next()).done){s.next=12;break}return i=o.value,s.next=9,regeneratorRuntime.awrap(i.handleStage(e));case 9:t=!0,s.next=5;break;case 12:s.next=18;break;case 14:s.prev=14,s.t0=s.catch(3),r=!0,n=s.t0;case 18:s.prev=18,s.prev=19,t||null==a.return||a.return();case 21:if(s.prev=21,!r){s.next=24;break}throw n;case 24:return s.finish(21);case 25:return s.finish(18);case 26:case"end":return s.stop()}}),null,this,[[3,14,18,26],[19,,21,25]])}}])&&Si(r.prototype,o),i&&Si(r,i),t}(ma);function Ii(e){return(Ii="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Di(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ci(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ei(e,t){return!t||"object"!==Ii(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ai(e,t,r){return(Ai="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ti(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Ti(e){return(Ti=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Mi(e,t){return(Mi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ki=function(e){function t(e){var r,n=e.modelManager,o=e.crypto;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!n)throw"Invalid ProtocolService construction.";return(r=Ei(this,Ti(t).call(this))).operators=[],r.modelManager=n,r.crypto=o,!r.crypto&&Object(a.o)()&&Object(re.isWebCryptoAvailable)()&&(r.crypto=new re.SNWebCrypto),F.SetGenerators({syncImpl:r.crypto.generateUUIDSync,asyncImpl:r.crypto.generateUUIDSync}),r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Mi(e,t)}(t,e),r=t,(n=[{key:"setKeyManager",value:function(e){this.keyManager=e}},{key:"setItemsKeyManager",value:function(e){var t=this;this.keyObsUnsubscribe=e.addItemsKeyChangeObserver((function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(t.decryptErroredItems());case 2:case"end":return e.stop()}}))}))}},{key:"deinit",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return this.keyObsUnsubscribe(),e.abrupt("return",Ai(Ti(t.prototype),"deinit",this).call(this));case 2:case"end":return e.stop()}}),null,this)}},{key:"getLatestVersion",value:function(){return V.V004}},{key:"getUserVersion",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.keyManager.getRootKeyParams());case 2:return e=t.sent,t.abrupt("return",e&&e.version);case 4:case"end":return t.stop()}}),null,this)}},{key:"upgradeAvailable",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.getUserVersion());case 2:return e.t0=e.sent,e.t1=this.getLatestVersion(),e.abrupt("return",e.t0!==e.t1);case 5:case"end":return e.stop()}}),null,this)}},{key:"platformSupportsKeyDerivation",value:function(e){return H(e.version,V.V004)>=0||!!Object(re.isWebCryptoAvailable)()}},{key:"supportedVersions",value:function(){return[V.V001,V.V002,V.V003,V.V004]}},{key:"isVersionNewerThanLibraryVersion",value:function(e){return 1===H(e,this.getLatestVersion())}},{key:"isProtocolVersionOutdated",value:function(e){var t={};t[V.V001]=Date.parse("2018-01-01"),t[V.V002]=Date.parse("2020-01-01");var r=t[e];return!!r&&new Date>r}},{key:"costMinimumForVersion",value:function(e){if(H(e,V.V003)>=0)throw"Cost minimums only apply to versions <= 002";if(e===V.V001)return ye.pwCost();if(e===V.V002)return xe.pwCost();throw"Invalid version for cost minimum: ".concat(e)}},{key:"createOperatorForLatestVersion",value:function(){return this.createOperatorForVersion(this.getLatestVersion())}},{key:"createOperatorForVersion",value:function(e){if(e===V.V001)return new ye(this.crypto);if(e===V.V002)return new xe(this.crypto);if(e===V.V003)return new _e(this.crypto);if(e===V.V004)return new Me(this.crypto);if(e===V.V000Base64Decrypted)return this.createOperatorForLatestVersion();throw"Unable to find operator for version ".concat(e)}},{key:"operatorForVersion",value:function(e){var t=e,r=this.operators[t];return r||(r=this.createOperatorForVersion(e),this.operators[t]=r),r}},{key:"defaultOperator",value:function(){return this.operatorForVersion(this.getLatestVersion())}},{key:"computeRootKey",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=e.password,r=e.keyParams,n=r.version,a=this.operatorForVersion(n),o.abrupt("return",a.computeRootKey({password:t,keyParams:r}));case 4:case"end":return o.stop()}}),null,this)}},{key:"createRootKey",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.identifier,r=e.password,n=this.defaultOperator(),a.abrupt("return",n.createRootKey({identifier:t,password:r}));case 3:case"end":return a.stop()}}),null,this)}},{key:"payloadContentFormatForIntent",value:function(e){var t=e.key,r=e.intent;if(t){if(r===W.Sync||r===W.FileEncrypted||r===W.FilePreferEncrypted||r===W.LocalStorageEncrypted||r===W.LocalStoragePreferEncrypted)return te.EncryptedString;throw"Unhandled encrypted case in protocolService.payloadContentFormatForIntent."}if(r===W.LocalStorageDecrypted||r===W.LocalStoragePreferEncrypted||r===W.FileDecrypted||r===W.FilePreferEncrypted)return te.DecryptedBareObject;if(r===W.SyncDecrypted)return te.DecryptedBase64String;throw"Unhandled decrypted case in protocolService.payloadContentFormatForIntent."}},{key:"payloadByEncryptingPayload",value:function(e){var t,r,n,o,i,s,u;return regeneratorRuntime.async((function(c){for(;;)switch(c.prev=c.next){case 0:if(t=e.payload,r=e.key,n=e.intent,!t.errorDecrypting){c.next=3;break}return c.abrupt("return",t);case 3:if(!Object(a.l)(n)){c.next=5;break}throw"Attempting to encrypt payload with null intent";case 5:if(r||Y(n)){c.next=9;break}return c.next=8,regeneratorRuntime.awrap(this.keyManager.keyToUseForEncryptionOfPayload({payload:t,intent:n}));case 8:r=c.sent;case 9:if(r||!J(n)){c.next=11;break}throw"Attempting to generate encrypted payload with no key.";case 11:if(t.getFormat()===te.DecryptedBareObject){c.next=13;break}throw"Attempting to encrypt already encrypted payload.";case 13:if(t.isPayload){c.next=15;break}throw"Attempting to encrypt non-payload.";case 15:if(t.content){c.next=17;break}throw"Attempting to encrypt payload with no content.";case 17:if(t.uuid){c.next=19;break}throw"Attempting to encrypt payload with no uuid.";case 19:return o=r?r.version:this.getLatestVersion(),i=this.payloadContentFormatForIntent({key:r,intent:n}),s=this.operatorForVersion(o),c.next=24,regeneratorRuntime.awrap(s.generateEncryptionParameters({payload:t,key:r,format:i}));case 24:if(u=c.sent){c.next=27;break}throw"Unable to generate encryption parameters";case 27:return c.abrupt("return",ca({object:t,override:u,intent:n}));case 28:case"end":return c.stop()}}),null,this)}},{key:"payloadsByEncryptingPayloads",value:function(e){var t,r,n,o,i,s,u,c,l,p,f;return regeneratorRuntime.async((function(y){for(;;)switch(y.prev=y.next){case 0:t=e.payloads,r=e.intent,n=[],o=!0,i=!1,s=void 0,y.prev=5,u=t[Symbol.iterator]();case 7:if(o=(c=u.next()).done){y.next=17;break}return l=c.value,p=Object(a.k)(r)?r(l):r,y.next=12,regeneratorRuntime.awrap(this.payloadByEncryptingPayload({payload:l,intent:p}));case 12:f=y.sent,n.push(f);case 14:o=!0,y.next=7;break;case 17:y.next=23;break;case 19:y.prev=19,y.t0=y.catch(5),i=!0,s=y.t0;case 23:y.prev=23,y.prev=24,o||null==u.return||u.return();case 26:if(y.prev=26,!i){y.next=29;break}throw s;case 29:return y.finish(26);case 30:return y.finish(23);case 31:return y.abrupt("return",n);case 32:case"end":return y.stop()}}),null,this,[[5,19,23,31],[24,,26,30]])}},{key:"payloadByDecryptingPayload",value:function(e){var t,r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(t=e.payload,r=e.key,t.content){u.next=3;break}throw"Attempting to decrypt payload that has no content.";case 3:if(t.isPayload){u.next=5;break}throw"Attempting to decrypt non-payload.";case 5:if((n=t.getFormat())!==te.DecryptedBareObject){u.next=8;break}return u.abrupt("return",t);case 8:if(r||n!==te.EncryptedString){u.next=14;break}return u.next=11,regeneratorRuntime.awrap(this.keyManager.keyToUseForDecryptionOfPayload({payload:t}));case 11:if(r=u.sent){u.next=14;break}return u.abrupt("return",ua({object:t,override:{waitingForKey:!0,errorDecrypting:!0}}));case 14:return a=t.version,o=this.operatorForVersion(a),i=ya(t),u.next=19,regeneratorRuntime.awrap(o.generateDecryptedParameters({encryptedParameters:i,key:r}));case 19:return s=u.sent,u.abrupt("return",ua({object:t,override:s}));case 21:case"end":return u.stop()}}),null,this)}},{key:"payloadsByDecryptingPayloads",value:function(e){var t,r,n,o,i,s,u,c,l,p,f;return regeneratorRuntime.async((function(y){for(;;)switch(y.prev=y.next){case 0:t=e.payloads,r=e.key,n=[],o=!0,i=!1,s=void 0,y.prev=5,u=t[Symbol.iterator]();case 7:if(o=(c=u.next()).done){y.next=35;break}if(l=c.value){y.next=12;break}return n.push(l),y.abrupt("continue",32);case 12:if(l.isPayload){y.next=14;break}throw"Attempting to decrypt non-payload object in payloadsByDecryptingPayloads.";case 14:if(!0!==l.deleted||!Object(a.l)(l.content)){y.next=17;break}return n.push(l),y.abrupt("continue",32);case 17:if(Object(a.n)(l.content)){y.next=21;break}return n.push(l),y.abrupt("continue",32);case 21:return y.prev=21,y.next=24,regeneratorRuntime.awrap(this.payloadByDecryptingPayload({payload:l,key:r}));case 24:p=y.sent,n.push(p),y.next=32;break;case 28:y.prev=28,y.t0=y.catch(21),n.push(ua({object:l,override:(f={},Di(f,ae.ErrorDecrypting,!0),Di(f,ae.ErrorDecryptingChanged,!l.errorDecrypting),f)})),console.error("Error decrypting payload",l,y.t0);case 32:o=!0,y.next=7;break;case 35:y.next=41;break;case 37:y.prev=37,y.t1=y.catch(5),i=!0,s=y.t1;case 41:y.prev=41,y.prev=42,o||null==u.return||u.return();case 44:if(y.prev=44,!i){y.next=47;break}throw s;case 47:return y.finish(44);case 48:return y.finish(41);case 49:return y.abrupt("return",n);case 50:case"end":return y.stop()}}),null,this,[[5,37,41,49],[21,28],[42,,44,48]])}},{key:"decryptErroredItems",value:function(){var e,t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==(e=this.modelManager.allItems.filter((function(e){return e.waitingForKey||e.errorDecrypting}))).length){n.next=3;break}return n.abrupt("return");case 3:return t=e.map((function(e){return e.payloadRepresentation()})),n.next=6,regeneratorRuntime.awrap(this.payloadsByDecryptingPayloads({payloads:t}));case 6:return r=n.sent,n.next=9,regeneratorRuntime.awrap(this.modelManager.mapPayloadsToLocalItems({payloads:r}));case 9:case"end":return n.stop()}}),null,this)}},{key:"payloadsByDecryptingBackupFile",value:function(e){var t,r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(t=e.data,r=e.password,n=t.keyParams||t.auth_params,a=t.items,o=a.map((function(e){return la({object:e,source:Ir.FileImport})})),!n){u.next=13;break}return u.next=7,regeneratorRuntime.awrap(this.computeRootKey({password:r,keyParams:n}));case 7:return s=u.sent,u.next=10,regeneratorRuntime.awrap(this.payloadsByDecryptingPayloads({payloads:o,key:s}));case 10:i=u.sent,u.next=14;break;case 13:i=o;case 14:return u.abrupt("return",i);case 15:case"end":return u.stop()}}),null,this)}},{key:"createKeyParams",value:function(e){if(e.isKeyParamsObject)throw"Attempting to create key params from non-raw value.";return e.version||(e.version=V.V002),Z(e)}},{key:"createBackupFile",value:function(){var e,t,r,n,a,o,i,s,u,c,l=arguments;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:if(e=l.length>0&&void 0!==l[0]?l[0]:{},t=e.subItems,r=e.intent,n=e.returnIfEmpty,a=t||this.modelManager.allItems,!n||0!==a.length){p.next=4;break}return p.abrupt("return",null);case 4:return r||(r=W.FilePreferEncrypted),o=a.map((function(e){return ua({object:e})})),p.next=8,regeneratorRuntime.awrap(this.payloadsByEncryptingPayloads({payloads:o,intent:r}));case 8:return i=p.sent,s={items:i},p.next=12,regeneratorRuntime.awrap(this.keyManager.getRootKeyParams());case 12:return(u=p.sent)&&r!==W.FileDecrypted&&(s.keyParams=u.getPortableValue()),c=2,p.abrupt("return",JSON.stringify(s,null,c));case 16:case"end":return p.stop()}}),null,this)}}])&&Ci(r.prototype,n),o&&Ci(r,o),t}(ma);function Fi(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Li=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.item=Object(a.e)({},t),this.defaultContentKeyToDiffOn="text",this.textCharDiffLength=0,Object(a.n)(this.item.updated_at)&&(this.item.updated_at=new Date(this.item.updated_at))}var t,r,n;return t=e,(r=[{key:"setPreviousEntry",value:function(e){this.hasPreviousEntry=null!=e,this.item.content[this.defaultContentKeyToDiffOn]&&(this.textCharDiffLength=e?this.item.content[this.defaultContentKeyToDiffOn].length-e.item.content[this.defaultContentKeyToDiffOn].length:this.item.content[this.defaultContentKeyToDiffOn].length)}},{key:"operationVector",value:function(){return void 0!==this.textCharDiffLength?this.hasPreviousEntry&&0!==this.textCharDiffLength?this.textCharDiffLength<0?-1:1:0:1}},{key:"deltaSize",value:function(){return void 0!==this.textCharDiffLength?Math.abs(this.textCharDiffLength):1}},{key:"isSameAsEntry",value:function(e){if(!e)return!1;var t=new B(ua({object:this.item})),r=new B(ua({object:e.item}));return t.isItemContentEqualWith(r)}}])&&Fi(t.prototype,r),n&&Fi(t,n),e}();function Ui(e){return(Ui="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ni(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Bi(e,t){return!t||"object"!==Ui(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Vi(e){return(Vi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Hi(e,t){return(Hi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Wi=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Bi(this,Vi(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Hi(e,t)}(t,e),r=t,(n=[{key:"previewTitle",value:function(){return this.item.updated_at.toLocaleString()}},{key:"previewSubTitle",value:function(){return this.hasPreviousEntry?this.textCharDiffLength<0?"".concat(-1*this.textCharDiffLength," characters removed"):this.textCharDiffLength>0?"".concat(this.textCharDiffLength," characters added"):"Title or metadata changed":"".concat(this.textCharDiffLength," characters loaded")}}])&&Ni(r.prototype,n),a&&Ni(r,a),t}(Li);function zi(e){var t,r,n,a=(t={},r=i.Note,n=Wi,r in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,t)[e.content_type];if(!a)throw"Invalid item history class";return new a(e)}function qi(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Yi=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.entries||(this.entries=[]),t.entries){var r=!0,n=!1,a=void 0;try{for(var o,i=t.entries[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value,u=this.createEntryForItem(s.item);u.setPreviousEntry(this.getLastEntry()),this.entries.push(u)}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}}var t,r,n;return t=e,(r=[{key:"createEntryForItem",value:function(e){return zi(e)}},{key:"getLastEntry",value:function(){return this.entries[this.entries.length-1]}},{key:"addHistoryEntryForItem",value:function(e){var t=this.createEntryForItem(e),r=this.getLastEntry();if(t.setPreviousEntry(r),!t.isSameAsEntry(r))return this.entries.push(t),t}},{key:"clear",value:function(){this.entries.length=0}},{key:"optimize",value:function(){var e=this,t=[],r=function(e){return e.deltaSize()>15},n=function(n,a,o){if(o)t.push(n);else{var i=t.indexOf(n);-1!==i&&t.splice(i,1)}if(o&&r(n)&&-1===n.operationVector()){var s=e.entries[a-1];s&&t.push(s)}};this.entries.forEach((function(t,a){if(0===a||a===e.entries.length-1)n(t,a,!0);else{var o=r(t);n(t,a,o)}})),this.entries=this.entries.filter((function(e,r){return-1!==t.indexOf(e)}))}}])&&qi(t.prototype,r),n&&qi(t,n),e}();function Ji(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Gi=60,Qi=function(){function e(t){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Object.assign(this,t),this.content||(this.content={}),this.content.itemUUIDToItemHistoryMapping||(this.content.itemUUIDToItemHistoryMapping={}),Object.keys(this.content.itemUUIDToItemHistoryMapping).forEach((function(e){var t=r.content.itemUUIDToItemHistoryMapping[e];r.content.itemUUIDToItemHistoryMapping[e]=new Yi(t)})),this.setItemRevisionThreshold(Gi)}var t,r,n;return t=e,(r=[{key:"addEntryForItem",value:function(e){return this.historyForItem(e).addHistoryEntryForItem(e)}},{key:"historyForItem",value:function(e){var t=this.content.itemUUIDToItemHistoryMapping[e.uuid];return t||(t=new Yi,this.content.itemUUIDToItemHistoryMapping[e.uuid]=t),t}},{key:"clearItemHistory",value:function(e){this.historyForItem(e).clear()}},{key:"clearAllHistory",value:function(){this.content.itemUUIDToItemHistoryMapping={}}},{key:"setItemRevisionThreshold",value:function(e){this.itemRevisionThreshold=e}},{key:"optimizeHistoryForItem",value:function(e){var t=this.historyForItem(e);t.entries.length>this.itemRevisionThreshold&&t.optimize()}}])&&Ji(t.prototype,r),n&&Ji(t,n),e}();function $i(e){return($i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Xi(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Zi(e,t){return!t||"object"!==$i(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function es(e){return(es=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ts(e,t){return(ts=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var rs=function(e){function t(e){var r,n=e.modelManager,a=e.storageService,o=e.contentTypes,i=e.timeout;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Zi(this,es(t).call(this))).modelManager=n,r.storageService=a,r.contentTypes=o,r.timeout=i,r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ts(e,t)}(t,e),r=t,(n=[{key:"initializeFromDisk",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.storageService.getValue(C.SessionHistoryPersistable));case 2:return this.persistable=t.sent,t.next=5,regeneratorRuntime.awrap(this.storageService.getValue(C.SessionHistoryRevisions).then((function(e){return new Qi(e)})));case 5:return this.historySession=t.sent,t.next=8,regeneratorRuntime.awrap(this.storageService.getValue(C.SessionHistoryOptimize));case 8:e=t.sent,Object(a.l)(e)?this.autoOptimize=!0:this.autoOptimize=e,this.addMappingObserver();case 11:case"end":return t.stop()}}),null,this)}},{key:"addMappingObserver",value:function(){var e=this;this.modelManager.addMappingObserver(this.contentTypes,(function(t,r,n,a,o){if(a!==Ir.LocalDirtied){var i=!0,s=!1,u=void 0;try{for(var c,l=t[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var p=c.value;try{p.deleted||e.addHistoryEntryForItem(p)}catch(e){console.error("Unable to add item history entry:",e)}}}catch(e){s=!0,u=e}finally{try{i||null==l.return||l.return()}finally{if(s)throw u}}}}))}},{key:"isDiskEnabled",value:function(){return this.persistable}},{key:"isAutoOptimizeEnabled",value:function(){return this.autoOptimize}},{key:"saveToDisk",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable){e.next=2;break}return e.abrupt("return");case 2:this.storageService.setValue(C.SessionHistoryRevisions,this.historySession);case 3:case"end":return e.stop()}}),null,this)}},{key:"setSessionItemRevisionThreshold",value:function(e){this.historySession.setItemRevisionThreshold(e)}},{key:"addHistoryEntryForItem",value:function(e){var t,r,n=this;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:t={uuid:e.uuid,content_type:e.content_type,updated_at:e.updated_at,content:e.getContentCopy()},r=this.historySession.addEntryForItem(t),this.autoOptimize&&this.historySession.optimizeHistoryForItem(e),r&&this.persistable&&(this.diskTimeout&&(this.timeout.hasOwnProperty("cancel")?this.timeout.cancel(this.diskTimeout):clearTimeout(this.diskTimeout)),this.diskTimeout=this.timeout((function(){n.saveToDisk()}),2e3));case 5:case"end":return a.stop()}}),null,this)}},{key:"historyForItem",value:function(e){return this.historySession.historyForItem(e)}},{key:"clearHistoryForItem",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return this.historySession.clearItemHistory(e),t.abrupt("return",this.saveToDisk());case 2:case"end":return t.stop()}}),null,this)}},{key:"clearAllHistory",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearAllHistory(),e.abrupt("return",this.storageService.removeValue(C.SessionHistoryRevisions));case 2:case"end":return e.stop()}}),null,this)}},{key:"toggleDiskSaving",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable=!this.persistable,!this.persistable){e.next=6;break}this.storageService.setValue(C.SessionHistoryPersistable,!0),this.saveToDisk(),e.next=8;break;case 6:return this.storageService.setValue(C.SessionHistoryPersistable,!1),e.abrupt("return",this.storageService.removeValue(C.SessionHistoryRevisions));case 8:case"end":return e.stop()}}),null,this)}},{key:"toggleAutoOptimize",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:this.autoOptimize=!this.autoOptimize,this.autoOptimize?this.storageService.setValue(C.SessionHistoryOptimize,!0):this.storageService.setValue(C.SessionHistoryOptimize,!1);case 2:case"end":return e.stop()}}),null,this)}}])&&Xi(r.prototype,n),o&&Xi(r,o),t}(ma);function ns(e){return(ns="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function as(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function os(e,t){return!t||"object"!==ns(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function is(e){return(is=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ss(e,t){return(ss=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var us={ManageExtensions:"ActionManageExtensions",ManageBackups:"ActionManageBackups",ViewProtectedNotes:"ActionViewProtectedNotes",ManagePrivileges:"ActionManagePrivileges",ManagePasscode:"ActionManagePasscode",DeleteNote:"ActionDeleteNote"},cs={AccountPassword:"CredentialAccountPassword",LocalPasscode:"CredentialLocalPasscode"},ls=function(e){function t(e){var r,n=e.modelManager,a=e.syncService,o=e.singletonManager,i=e.keyManager,s=e.storageService,u=e.sessionManager;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!(n&&a&&o&&i))throw"Invalid privileges manager construction.";return(r=os(this,is(t).call(this))).modelManager=n,r.syncService=a,r.singletonManager=o,r.keyManager=i,r.storageService=s,r.sessionManager=u,r.loadDefaults(),r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ss(e,t)}(t,e),r=t,(n=[{key:"loadDefaults",value:function(){this.availableActions=Object.keys(us).map((function(e){return us[e]})),this.availableCredentials=[cs.AccountPassword,cs.LocalPasscode],this.sessionLengths=[0,300,3600,604800]}},{key:"getAvailableActions",value:function(){return this.availableActions}},{key:"getAvailableCredentials",value:function(){return this.availableCredentials}},{key:"netCredentialsForAction",value:function(e){var t,r,n,a,o,i,s,u,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,regeneratorRuntime.awrap(this.getPrivileges());case 2:t=l.sent,r=t.getCredentialsForAction(e),n=[],a=!0,o=!1,i=void 0,l.prev=8,s=r[Symbol.iterator]();case 10:if(a=(u=s.next()).done){l.next=27;break}if((c=u.value)!==cs.AccountPassword){l.next=19;break}return l.next=15,regeneratorRuntime.awrap(this.sessionManager.online());case 15:l.sent&&n.push(c),l.next=24;break;case 19:if(c!==cs.LocalPasscode){l.next=24;break}return l.next=22,regeneratorRuntime.awrap(this.keyManager.hasRootKeyWrapper());case 22:l.sent&&n.push(c);case 24:a=!0,l.next=10;break;case 27:l.next=33;break;case 29:l.prev=29,l.t0=l.catch(8),o=!0,i=l.t0;case 33:l.prev=33,l.prev=34,a||null==s.return||s.return();case 36:if(l.prev=36,!o){l.next=39;break}throw i;case 39:return l.finish(36);case 40:return l.finish(33);case 41:return l.abrupt("return",n);case 42:case"end":return l.stop()}}),null,this,[[8,29,33,41],[34,,36,40]])}},{key:"getPrivileges",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=tr.contentType(),t=new f("content_type","=",e),r.abrupt("return",this.singletonManager.findOrCreateSingleton({predicate:t,createPayload:ua({object:{content_type:e,content:{}}})}));case 3:case"end":return r.stop()}}),null,this)}},{key:"savePrivileges",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.getPrivileges());case 2:return e=t.sent,t.next=5,regeneratorRuntime.awrap(this.modelManager.setItemDirty(e));case 5:return t.abrupt("return",this.syncService.sync());case 6:case"end":return t.stop()}}),null,this)}},{key:"setSessionLength",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return n=e,a=void 0,(a=new Date).setSeconds(a.getSeconds()+n),t=a,r.next=4,regeneratorRuntime.awrap(this.storageService.setValue(C.PrivilegesExpirey,t));case 4:return r.next=6,regeneratorRuntime.awrap(this.storageService.setValue(C.PrivilegesSessionLength,e));case 6:case"end":return r.stop()}var n,a}),null,this)}},{key:"clearSession",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setSessionLength(0));case 1:case"end":return e.stop()}}),null,this)}},{key:"getSelectedSessionLength",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.storageService.getValue(C.PrivilegesSessionLength));case 2:if(!(e=t.sent)){t.next=7;break}return t.abrupt("return",e);case 7:return t.abrupt("return",0);case 8:case"end":return t.stop()}}),null,this)}},{key:"getSessionExpirey",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.storageService.getValue(C.PrivilegesExpirey));case 2:if(!(e=t.sent)){t.next=7;break}return t.abrupt("return",new Date(e));case 7:return t.abrupt("return",new Date);case 8:case"end":return t.stop()}}),null,this)}},{key:"actionHasPrivilegesConfigured",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.netCredentialsForAction(e));case 2:return t.t0=t.sent.length,t.abrupt("return",t.t0>0);case 4:case"end":return t.stop()}}),null,this)}},{key:"actionRequiresPrivilege",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(this.getSessionExpirey());case 2:if(!(r.sent>new Date)){r.next=5;break}return r.abrupt("return",!1);case 5:return r.next=7,regeneratorRuntime.awrap(this.netCredentialsForAction(e));case 7:return t=r.sent,r.abrupt("return",t.length>0);case 9:case"end":return r.stop()}}),null,this)}},{key:"authenticateAction",value:function(e,t){var r,n,a,o,i,s,u,c,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:return p.next=2,regeneratorRuntime.awrap(this.netCredentialsForAction(e));case 2:r=p.sent,n=[],a=[],o=!0,i=!1,s=void 0,p.prev=8,u=r[Symbol.iterator]();case 10:if(o=(c=u.next()).done){p.next=19;break}return l=c.value,p.next=14,regeneratorRuntime.awrap(this.verifyAuthenticationParameters(l,t[l]));case 14:p.sent?n.push(l):a.push(l);case 16:o=!0,p.next=10;break;case 19:p.next=25;break;case 21:p.prev=21,p.t0=p.catch(8),i=!0,s=p.t0;case 25:p.prev=25,p.prev=26,o||null==u.return||u.return();case 28:if(p.prev=28,!i){p.next=31;break}throw s;case 31:return p.finish(28);case 32:return p.finish(25);case 33:return p.abrupt("return",{success:0===a.length,successfulCredentials:n,failedCredentials:a});case 34:case"end":return p.stop()}}),null,this,[[8,21,25,33],[26,,28,32]])}},{key:"verifyAuthenticationParameters",value:function(e,t){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(e!==cs.AccountPassword){r.next=4;break}return r.abrupt("return",this.keyManager.validateAccountPassword(t));case 4:if(e!==cs.LocalPasscode){r.next=6;break}return r.abrupt("return",this.keyManager.validatePasscode(t));case 6:case"end":return r.stop()}}),null,this)}},{key:"displayInfoForCredential",value:function(e){var t={};return t[cs.AccountPassword]={label:"Account Password",prompt:"Please enter your account password."},t[cs.LocalPasscode]={label:"Local Passcode",prompt:"Please enter your local passcode."},t[e]}},{key:"displayInfoForAction",value:function(e){var t={};return t[us.ManageExtensions]={label:"Manage Extensions"},t[us.ManageBackups]={label:"Download/Import Backups"},t[us.ViewProtectedNotes]={label:"View Protected Notes"},t[us.ManagePrivileges]={label:"Manage Privileges"},t[us.ManagePasscode]={label:"Manage Passcode"},t[us.DeleteNote]={label:"Delete Notes"},t[e]}},{key:"getSessionLengthOptions",value:function(){return[{value:0,label:"Don't Remember"},{value:300,label:"5 Minutes"},{value:3600,label:"1 Hour"},{value:604800,label:"1 Week"}]}}])&&as(r.prototype,n),a&&as(r,a),t}(ma);function ps(e){return(ps="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function fs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ys(e){return(ys=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function hs(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ds(e,t){return(ds=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var vs=0,ms=function(e){function t(e){var r,n=e.modelManager,a=e.storageService,o=e.protocolService,i=e.itemsKeyManager,s=e.deviceInterface;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!(n&&a&&o&&i&&s))throw"Invalid KeyManager construction";return(r=function(e,t){return!t||"object"!==ps(t)&&"function"!=typeof t?hs(e):t}(this,ys(t).call(this))).keyMode=vs,r.protocolService=o,r.modelManager=n,r.storageService=a,r.itemsKeyManager=i,r.deviceInterface=s,r.keyObservers=[],Object.defineProperty(hs(r),"rootKey",{enumerable:!1,writable:!0}),r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ds(e,t)}(t,e),r=t,(n=[{key:"initialize",value:function(){var e,t,r,n;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(this.getWrappedRootKeyFromStorage());case 2:return e=o.sent,o.next=5,regeneratorRuntime.awrap(this.getAccountKeyParams());case 5:return t=o.sent,o.next=8,regeneratorRuntime.awrap(this.hasRootKeyWrapper());case 8:if(r=o.sent,n=!Object(a.l)(e)||!Object(a.l)(t),!r||!n){o.next=14;break}this.keyMode=2,o.next=27;break;case 14:if(!r||n){o.next=18;break}this.keyMode=3,o.next=27;break;case 18:if(r||!n){o.next=22;break}this.keyMode=1,o.next=27;break;case 22:if(r||n){o.next=26;break}this.keyMode=vs,o.next=27;break;case 26:throw"Invalid key mode condition";case 27:if(1!==this.keyMode){o.next=33;break}return o.next=30,regeneratorRuntime.awrap(this.getRootKeyFromKeychain());case 30:return this.rootKey=o.sent,o.next=33,regeneratorRuntime.awrap(this.notifyObserversOfChange());case 33:case"end":return o.stop()}}),null,this)}},{key:"onStatusChange",value:function(e){var t=this;return this.keyObservers.push(e),function(){Object(a.u)(t.keyObservers,e)}}},{key:"notifyObserversOfChange",value:function(){var e,t,r,n,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:e=!0,t=!1,r=void 0,i.prev=3,n=this.keyObservers[Symbol.iterator]();case 5:if(e=(a=n.next()).done){i.next=12;break}return o=a.value,i.next=9,regeneratorRuntime.awrap(o());case 9:e=!0,i.next=5;break;case 12:i.next=18;break;case 14:i.prev=14,i.t0=i.catch(3),t=!0,r=i.t0;case 18:i.prev=18,i.prev=19,e||null==n.return||n.return();case 21:if(i.prev=21,!t){i.next=24;break}throw r;case 24:return i.finish(21);case 25:return i.finish(18);case 26:case"end":return i.stop()}}),null,this,[[3,14,18,26],[19,,21,25]])}},{key:"getRootKeyFromKeychain",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(this.deviceInterface.getKeychainValue());case 2:if(e=r.sent,!Object(a.l)(e)){r.next=5;break}return r.abrupt("return",null);case 5:return r.next=7,regeneratorRuntime.awrap($.Create({content:e}));case 7:return t=r.sent,r.abrupt("return",t);case 9:case"end":return r.stop()}}),null,this)}},{key:"saveRootKeyToKeychain",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Object(a.l)(this.rootKey)){t.next=2;break}throw"Attempting to non-existent root key to the keychain.";case 2:if(1===this.keyMode){t.next=4;break}throw"Should not be persisting wrapped key to keychain.";case 4:return e=this.rootKey.getPersistableValue(),t.next=7,regeneratorRuntime.awrap(this.deviceInterface.setKeychainValue(e));case 7:case"end":return t.stop()}}),null,this)}},{key:"hasRootKeyWrapper",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.getRootKeyWrapperKeyParams());case 2:return e=t.sent,t.abrupt("return",!Object(a.l)(e));case 4:case"end":return t.stop()}}),null,this)}},{key:"hasPasscode",value:function(){return 3===this.keyMode||2===this.keyMode}},{key:"rootKeyNeedsUnwrapping",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.hasRootKeyWrapper());case 2:if(e.t0=e.sent,!e.t0){e.next=5;break}e.t0=Object(a.l)(this.rootKey);case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}}),null,this)}},{key:"getRootKeyWrapperKeyParams",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.storageService.getValue(C.RootKeyWrapperKeyParams,ii.Nonwrapped));case 2:if(e=t.sent){t.next=5;break}return t.abrupt("return",null);case 5:return t.abrupt("return",this.protocolService.createKeyParams(e));case 6:case"end":return t.stop()}}),null,this)}},{key:"getWrappedRootKeyFromStorage",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(C.WrappedRootKey,ii.Nonwrapped));case 1:case"end":return e.stop()}}),null,this)}},{key:"getRootKeyParams",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(3!==this.keyMode){e.next=4;break}return e.abrupt("return",this.getRootKeyWrapperKeyParams());case 4:if(1!==this.keyMode&&2!==this.keyMode){e.next=8;break}return e.abrupt("return",this.getAccountKeyParams());case 8:throw"Unhandled key mode for getRootKeyParams ".concat(this.keyMode);case 9:case"end":return e.stop()}}),null,this)}},{key:"getAccountKeyParams",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.storageService.getValue(C.RootKeyParams,ii.Nonwrapped));case 2:if(e=t.sent){t.next=5;break}return t.abrupt("return",null);case 5:return t.abrupt("return",this.protocolService.createKeyParams(e));case 6:case"end":return t.stop()}}),null,this)}},{key:"validateWrappingKey",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,regeneratorRuntime.awrap(this.getWrappedRootKeyFromStorage());case 2:if(t=a.sent,3!==this.keyMode){a.next=7;break}return a.abrupt("return",this.storageService.canDecryptWithKey(e));case 7:if(1!==this.keyMode&&2!==this.keyMode){a.next=15;break}return r=ua({object:t}),a.next=11,regeneratorRuntime.awrap(this.protocolService.payloadByDecryptingPayload({payload:r,key:e}));case 11:return n=a.sent,a.abrupt("return",!n.errorDecrypting);case 15:throw"Unhandled case in validateWrappingKey";case 16:case"end":return a.stop()}}),null,this)}},{key:"computeWrappingKey",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.passcode,a.next=3,regeneratorRuntime.awrap(this.getRootKeyWrapperKeyParams());case 3:return r=a.sent,a.next=6,regeneratorRuntime.awrap(this.protocolService.computeRootKey({password:t,keyParams:r}));case 6:return n=a.sent,a.abrupt("return",n);case 8:case"end":return a.stop()}}),null,this)}},{key:"unwrapRootKey",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(t=e.wrappingKey,3!==this.keyMode){o.next=4;break}return this.rootKey=t,o.abrupt("return");case 4:if(2===this.keyMode){o.next=6;break}throw"Invalid key mode condition for unwrapping.";case 6:return o.next=8,regeneratorRuntime.awrap(this.getWrappedRootKeyFromStorage());case 8:return r=o.sent,n=ua({object:r}),o.next=12,regeneratorRuntime.awrap(this.protocolService.payloadByDecryptingPayload({payload:n,key:t}));case 12:if(!(a=o.sent).errorDecrypting){o.next=17;break}throw"Unable to decrypt root key with provided wrapping key.";case 17:return o.next=19,regeneratorRuntime.awrap($.Create({uuid:a.uuid,content:a.content}));case 19:return this.rootKey=o.sent,o.next=22,regeneratorRuntime.awrap(this.notifyObserversOfChange());case 22:case"end":return o.stop()}}),null,this)}},{key:"setNewRootKeyWrapper",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(t=e.wrappingKey,r=e.keyParams,this.keyMode!==vs){n.next=5;break}this.keyMode=3,n.next=10;break;case 5:if(1!==this.keyMode){n.next=9;break}this.keyMode=2,n.next=10;break;case 9:throw"Attempting to set wrapper on already wrapped key.";case 10:return n.next=12,regeneratorRuntime.awrap(this.deviceInterface.clearKeychainValue());case 12:if(3!==this.keyMode&&2!==this.keyMode){n.next=27;break}if(3!==this.keyMode){n.next=19;break}return this.rootKey=t,n.next=17,regeneratorRuntime.awrap(this.itemsKeyManager.reencryptItemsKeys());case 17:n.next=21;break;case 19:return n.next=21,regeneratorRuntime.awrap(this.wrapAndPersistRootKey({wrappingKey:t}));case 21:return n.next=23,regeneratorRuntime.awrap(this.storageService.setValue(C.RootKeyWrapperKeyParams,r.getPortableValue(),ii.Nonwrapped));case 23:return n.next=25,regeneratorRuntime.awrap(this.notifyObserversOfChange());case 25:n.next=28;break;case 27:throw"Invalid keyMode on setNewRootKeyWrapper";case 28:case"end":return n.stop()}}),null,this)}},{key:"wrapAndPersistRootKey",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.wrappingKey,r=ua({object:this.rootKey,override:{content:this.rootKey.getPersistableValue()}}),a.next=4,regeneratorRuntime.awrap(this.protocolService.payloadByEncryptingPayload({payload:r,key:t,intent:W.LocalStorageEncrypted}));case 4:return n=a.sent,a.next=7,regeneratorRuntime.awrap(this.storageService.setValue(C.WrappedRootKey,n,ii.Nonwrapped));case 7:case"end":return a.stop()}}),null,this)}},{key:"removeRootKeyWrapper",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(3===this.keyMode||2===this.keyMode){e.next=2;break}throw"Attempting to remove root key wrapper on unwrapped key.";case 2:return 3===this.keyMode?(this.keyMode=vs,this.rootKey=null):2===this.keyMode&&(this.keyMode=1),e.next=5,regeneratorRuntime.awrap(this.storageService.removeValue(C.WrappedRootKey,ii.Nonwrapped));case 5:return e.next=7,regeneratorRuntime.awrap(this.storageService.removeValue(C.RootKeyWrapperKeyParams,ii.Nonwrapped));case 7:if(1!==this.keyMode){e.next=10;break}return e.next=10,regeneratorRuntime.awrap(this.saveRootKeyToKeychain());case 10:return e.next=12,regeneratorRuntime.awrap(this.notifyObserversOfChange());case 12:case"end":return e.stop()}}),null,this)}},{key:"setNewRootKey",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(t=e.key,r=e.keyParams,t.isRootKey){a.next=3;break}throw"Root key must be a ".concat(i.RootKey," object.");case 3:if(r){a.next=5;break}throw"keyParams must be supplied if setting root key.";case 5:if(3!==this.keyMode){a.next=9;break}this.keyMode=2,a.next=17;break;case 9:if(this.keyMode!==vs){a.next=13;break}this.keyMode=1,a.next=17;break;case 13:if(1!==this.keyMode&&2!==this.keyMode){a.next=16;break}a.next=17;break;case 16:throw"Unhandled key mode for setNewRootKey ".concat(this.keyMode);case 17:if(n=this.rootKey,this.rootKey=t,n!==t){a.next=21;break}throw"Attempting to set root key as same current value.";case 21:return a.next=23,regeneratorRuntime.awrap(this.storageService.setValue(C.RootKeyParams,r.getPortableValue(),ii.Nonwrapped));case 23:if(1!==this.keyMode){a.next=28;break}return a.next=26,regeneratorRuntime.awrap(this.saveRootKeyToKeychain());case 26:a.next=31;break;case 28:if(2!==this.keyMode){a.next=31;break}return a.next=31,regeneratorRuntime.awrap(this.wrapAndPersistRootKey({wrappingKey:n}));case 31:return a.next=33,regeneratorRuntime.awrap(this.notifyObserversOfChange(i.RootKey));case 33:return a.next=35,regeneratorRuntime.awrap(this.itemsKeyManager.reencryptItemsKeys());case 35:case"end":return a.stop()}}),null,this)}},{key:"getRootKey",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rootKey);case 1:case"end":return e.stop()}}),null,this)}},{key:"clearLocalKeyState",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.deviceInterface.clearKeychainValue());case 2:return e.next=4,regeneratorRuntime.awrap(this.storageService.removeValue(C.WrappedRootKey,ii.Nonwrapped));case 4:return e.next=6,regeneratorRuntime.awrap(this.storageService.removeValue(C.RootKeyWrapperKeyParams,ii.Nonwrapped));case 6:return e.next=8,regeneratorRuntime.awrap(this.storageService.removeValue(C.RootKeyParams,ii.Nonwrapped));case 8:return this.keyMode=vs,this.rootKey=null,e.next=12,regeneratorRuntime.awrap(this.notifyObserversOfChange());case 12:case"end":return e.stop()}}),null,this)}},{key:"validateAccountPassword",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,regeneratorRuntime.awrap(this.getRootKeyParams());case 2:return t=a.sent,a.next=5,regeneratorRuntime.awrap(this.protocolService.computeRootKey({password:e,keyParams:t}));case 5:return r=a.sent,n=r.compare(this.rootKey),a.abrupt("return",n?r:null);case 8:case"end":return a.stop()}}),null,this)}},{key:"validatePasscode",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap(this.getRootKeyWrapperKeyParams());case 2:return t=n.sent,n.next=5,regeneratorRuntime.awrap(this.protocolService.computeRootKey({password:e,keyParams:t}));case 5:return r=n.sent,n.abrupt("return",this.validateWrappingKey(r));case 7:case"end":return n.stop()}}),null,this)}},{key:"contentTypeUsesRootKeyEncryption",value:function(e){return e===i.ItemsKey||e===i.EncryptedStorage}},{key:"keyToUseForEncryptionOfPayload",value:function(e){var t,r,n;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(t=e.payload,r=e.intent,!Object(a.l)(r)){o.next=3;break}throw"Intent must be supplied when looking up key for encryption of item.";case 3:if(!this.contentTypeUsesRootKeyEncryption(t.content_type)){o.next=16;break}return o.next=6,regeneratorRuntime.awrap(this.getRootKey());case 6:if(n=o.sent){o.next=13;break}if(!J(r)){o.next=12;break}throw"Root key encryption is required but no root key is available.";case 12:return o.abrupt("return",null);case 13:return o.abrupt("return",n);case 16:return o.abrupt("return",this.itemsKeyManager.getDefaultItemsKey());case 17:case"end":return o.stop()}}),null,this)}},{key:"keyToUseForDecryptionOfPayload",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(t=e.payload,!this.contentTypeUsesRootKeyEncryption(t.content_type)){a.next=3;break}return a.abrupt("return",this.getRootKey());case 3:if(!t.items_key_id){a.next=6;break}return r=this.itemsKeyManager.itemsKeyForPayload(t),a.abrupt("return",r);case 6:if((n=t.version)!==this.protocolService.getLatestVersion()){a.next=9;break}throw"No associated key found for item encrypted with latest protocol version.";case 9:return a.abrupt("return",this.itemsKeyManager.defaultItemsKeyForItemVersion(n));case 10:case"end":return a.stop()}}),null,this)}}])&&fs(r.prototype,n),o&&fs(r,o),t}(ma);function gs(e){return(gs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function bs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ws(e,t){return!t||"object"!==gs(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function xs(e){return(xs=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ks(e,t){return(ks=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ss=V.V003,Rs=function(e){function t(e){var r,n=e.syncService,a=e.modelManager,o=e.protocolService;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=ws(this,xs(t).call(this))).syncService=n,r.modelManager=a,r.protocolService=o,r.keyObservers=[],r.registerSyncObserver(),r.modelManager.addMappingObserver([i.ItemsKey],(function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(r.notifyObserversOfChange());case 2:case"end":return e.stop()}}))})),r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ks(e,t)}(t,e),r=t,(n=[{key:"setKeyManager",value:function(e){this.keyManager=e}},{key:"addItemsKeyChangeObserver",value:function(e){var t=this;return this.keyObservers.push(e),function(){Object(a.u)(t.keyObservers,e)}}},{key:"notifyObserversOfChange",value:function(){var e,t,r,n,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:e=!0,t=!1,r=void 0,i.prev=3,n=this.keyObservers[Symbol.iterator]();case 5:if(e=(a=n.next()).done){i.next=12;break}return o=a.value,i.next=9,regeneratorRuntime.awrap(o());case 9:e=!0,i.next=5;break;case 12:i.next=18;break;case 14:i.prev=14,i.t0=i.catch(3),t=!0,r=i.t0;case 18:i.prev=18,i.prev=19,e||null==n.return||n.return();case 21:if(i.prev=21,!t){i.next=24;break}throw r;case 24:return i.finish(21);case 25:return i.finish(18);case 26:case"end":return i.stop()}}),null,this,[[3,14,18,26],[19,,21,25]])}},{key:"registerSyncObserver",value:function(){var e=this;this.syncService.addEventObserver((function(t){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(t!==y.FullSyncCompleted){r.next=3;break}return r.next=3,regeneratorRuntime.awrap(e.handleFullSyncCompletion());case 3:if(t!==y.DownloadFirstSyncCompleted){r.next=6;break}return r.next=6,regeneratorRuntime.awrap(e.handleDownloadFirstSyncCompletion());case 6:case"end":return r.stop()}}))}))}},{key:"handleDownloadFirstSyncCompletion",value:function(){var e,t,r,n,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(e=this.allItemsKeys,t=e.filter((function(e){return e.neverSynced})),r=e.find((function(e){return!e.neverSynced&&e.isDefault})),Object(a.l)(r)){i.next=9;break}return i.next=7,regeneratorRuntime.awrap(this.modelManager.setItemsToBeDeleted(t));case 7:i.next=20;break;case 9:return i.next=11,regeneratorRuntime.awrap(this.keyManager.getRootKey());case 11:if(!(n=i.sent)){i.next=20;break}if(!((o=t.filter((function(e){return e.version!==n.version}))).length>0)){i.next=17;break}return i.next=17,regeneratorRuntime.awrap(this.modelManager.setItemsToBeDeleted(o));case 17:if(0!==e.length){i.next=20;break}return i.next=20,regeneratorRuntime.awrap(this.createNewDefaultItemsKey());case 20:case"end":return i.stop()}}),null,this)}},{key:"handleFullSyncCompletion",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.getDefaultItemsKey()){e.next=6;break}return e.next=4,regeneratorRuntime.awrap(this.createNewDefaultItemsKey());case 4:if(3!==this.keyManager.keyMode){e.next=6;break}return e.abrupt("return",this.syncService.repersistAllItems());case 6:case"end":return e.stop()}}),null,this)}},{key:"itemsKeyForPayload",value:function(e){return this.allItemsKeys.find((function(t){return t.uuid===e.items_key_id}))}},{key:"getDefaultItemsKey",value:function(){return 1===this.allItemsKeys.length?this.allItemsKeys[0]:this.allItemsKeys.find((function(e){return e.isDefault}))}},{key:"reencryptItemsKeys",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(!((e=this.allItemsKeys).length>0)){t.next=4;break}return t.next=4,regeneratorRuntime.awrap(this.modelManager.setItemsDirty(e));case 4:case"end":return t.stop()}}),null,this)}},{key:"defaultItemsKeyForItemVersion",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.allItemsKeys.find((function(t){return t.version===e})));case 1:case"end":return t.stop()}}),null,this)}},{key:"createNewDefaultItemsKey",value:function(){var e,t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(this.keyManager.getRootKey());case 2:if(e=o.sent,!(H(t=e?e.version:this.protocolService.getLatestVersion(),Ss)<=0)){o.next=10;break}return r=Ve.FromRaw({itemsKey:e.masterKey,dataAuthenticationKey:e.dataAuthenticationKey,version:t}),o.next=8,regeneratorRuntime.awrap(r.initUUID());case 8:o.next=13;break;case 10:return o.next=12,regeneratorRuntime.awrap(this.protocolService.operatorForVersion(t).createItemsKey());case 12:r=o.sent;case 13:if(!(n=this.getDefaultItemsKey())){o.next=18;break}return n.content.isDefault=!1,o.next=18,regeneratorRuntime.awrap(this.modelManager.setItemDirty(n));case 18:return r.content.isDefault=!0,a=r.payloadRepresentation({override:{dirty:!0}}),o.next=22,regeneratorRuntime.awrap(this.modelManager.mapPayloadToLocalItem({payload:a}));case 22:case"end":return o.stop()}}),null,this)}},{key:"allItemsKeys",get:function(){return this.modelManager.itemsKeys}}])&&bs(r.prototype,n),o&&bs(r,o),t}(ma);function Ps(e,t){return e.sort((function(e,r){var n=new Date(r.updated_at)-new Date(e.updated_at),a=0,o=0;return t&&(a=t.indexOf(e.content_type),o=t.indexOf(r.content_type),-1===a&&(a=t.length),-1===o&&(o=t.length)),a===o?n:a<o?-1:1}))}function Os(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var _s=function(){function e(t){var r=t.interval,n=t.receiver;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.interval=r,this.receiver=n}var t,r,n;return t=e,(r=[{key:"setSyncInProgress",value:function(e){this.inProgress=!0}},{key:"setUploadStatus",value:function(e){var t=e.completed,r=e.total;this.completedUpload=t,this.totalUpload=r}},{key:"setDownloadStatus",value:function(e){var t=e.downloaded;this.downloaded=t}},{key:"setDatabaseLoadStatus",value:function(e){var t=e.current,r=e.total,n=e.done;this.databaseLoadCurrent=t,this.databaseLoadTotal=r,this.databaseLoadDone=n}},{key:"setDidBegin",value:function(){this.syncing=!0,this.syncStart=new Date}},{key:"setDidEnd",value:function(){this.syncing=!1,this.syncEnd=new Date}},{key:"startTimingMonitor",value:function(){var e=this;this.timingMonitor&&this.this.stopTimingMonitor(),this.timingMonitor=this.interval((function(){e.secondsSinceSyncStart>5&&(e.receiver(y.SyncTakingTooLong),e.stopTimingMonitor())}),500)}},{key:"stopTimingMonitor",value:function(){this.interval.hasOwnProperty("cancel")?this.interval.cancel(this.timingMonitor):clearInterval(this.timingMonitor),this.timingMonitor=null}},{key:"hasError",value:function(){return this.error}},{key:"setError",value:function(e){this.error=e}},{key:"clearError",value:function(){this.error=null}},{key:"reset",value:function(){this.downloaded=0,this.completedUpload=0,this.totalUpload=0,this.inProgress=!1,this.syncing=!1,this.error=null}},{key:"syncInProgress",get:function(){return!0===this.syncing}},{key:"secondsSinceSyncStart",get:function(){return(new Date-this.syncStart)/1e3}}])&&Os(t.prototype,r),n&&Os(t,n),e}();function js(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Is=function(){function e(t){var r=t.receiver,n=t.maxDiscordance;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.discordance=0,this.receiver=r,this.maxDiscordance=n,this.reset()}var t,r,n;return t=e,(r=[{key:"setLastPresaveSyncDate",value:function(e){this._lastPreSyncSave=e}},{key:"setLastSyncDate",value:function(e){this._lastSyncDate=e}},{key:"isOutOfSync",value:function(){return this.outOfSync}},{key:"reset",value:function(){this._lastSyncDate=null,this._lastPreSyncSave=null,this.discordance=0,this.outOfSync=!1}},{key:"getLastClientIntegrityHash",value:function(){return this.lastClientHash}},{key:"clearIntegrityHashes",value:function(){this.lastClientHash=null,this.lastServerHash=null}},{key:"setIntegrityHashes",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:t=e.clientHash,r=e.serverHash,this.lastClientHash=t,this.lastServerHash=r,r&&0!==r.length&&t&&t!==r?(this.discordance++,this.discordance>=this.maxDiscordance&&!this.outOfSync&&(this.outOfSync=!0,this.receiver(y.EnterOutOfSync))):(this.outOfSync&&(this.outOfSync=!1,this.receiver(y.ExitOutOfSync)),this.discordance=0);case 5:case"end":return n.stop()}}),null,this)}},{key:"lastPreSyncSaveDate",get:function(){return this._lastPreSyncSave}},{key:"lastSyncDate",get:function(){return this._lastSyncDate}},{key:"needsSync",get:function(){return this.discordance>0&&this.discordance<this.maxDiscordance}}])&&js(t.prototype,r),n&&js(t,n),e}();function Ds(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Cs=function(){function e(t){var r=t.apiService,n=t.protocolService,a=t.contentType,o=t.customEvent,i=t.limit;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.apiService=r,this.protocolService=n,this.contentType=a,this.customEvent=o,this.limit=i,this.progressObj={retrievedPayloads:[]}}var t,r,n;return t=e,(r=[{key:"run",value:function(){var e,t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap(this.apiService.sync({lastSyncToken:this.progressObj.lastSyncToken,paginationToken:this.progressObj.paginationToken,limit:this.limit||500,contentType:this.contentType,customEvent:this.customEvent}));case 2:return e=n.sent,t=e.retrieved_items.map((function(e){return la({object:e,source:Ir.RemoteRetrieved})})),n.next=6,regeneratorRuntime.awrap(this.protocolService.payloadsByDecryptingPayloads({payloads:t}));case 6:if(r=n.sent,this.progressObj.retrievedPayloads=this.progressObj.retrievedPayloads.concat(r),this.progressObj.lastSyncToken=e.sync_token,this.progressObj.paginationToken=e.cursor_token,!e.cursor_token){n.next=14;break}return n.abrupt("return",this.run());case 14:return n.abrupt("return",this.progressObj.retrievedPayloads);case 15:case"end":return n.stop()}}),null,this)}}])&&Ds(t.prototype,r),n&&Ds(t,n),e}();function Es(e){return e===Ir.RemoteRetrieved?ea:e===Ir.RemoteSaved?sa:e===Ir.ConflictData||e===Ir.ConflictUuid?Jn:void 0}function As(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Ts=function(){function e(t){var r=t.response,n=t.decryptedResponsePayloads,a=t.baseCollection,o=t.payloadsSavedOrSaving;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.response=r,this.baseCollection=a,this.relatedCollectionSet=new l({collections:[new u({payloads:n,source:Ir.DecryptedTransient}),new u({payloads:o,source:Ir.SavedOrSaving})]})}var t,r,n;return t=e,(r=[{key:"collectionsByProcessingResponse",value:function(){var e,t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return e=[],o.next=3,regeneratorRuntime.awrap(this.collectionByProcessingRawItems({rawItems:this.response.rawRetrievedItems,source:Ir.RemoteRetrieved}));case 3:return t=o.sent,e.push(t),o.next=7,regeneratorRuntime.awrap(this.collectionByProcessingRawItems({rawItems:this.response.rawSavedItems,source:Ir.RemoteSaved}));case 7:return r=o.sent,e.push(r),o.next=11,regeneratorRuntime.awrap(this.collectionByProcessingRawItems({rawItems:this.response.rawUuidConflictItems,source:Ir.ConflictUuid}));case 11:return n=o.sent,e.push(n),o.next=15,regeneratorRuntime.awrap(this.collectionByProcessingRawItems({rawItems:this.response.rawDataConflictItems,source:Ir.ConflictData}));case 15:return a=o.sent,e.push(a),o.abrupt("return",e);case 18:case"end":return o.stop()}}),null,this)}},{key:"collectionByProcessingRawItems",value:function(e){var t,r,n,a,o,i,s,c,l=this;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:return t=e.rawItems,r=e.source,n=t.map((function(e){return la({object:e,source:r})})),a=new u({payloads:n,source:r}),o=Es(r),i=new o({baseCollection:this.baseCollection,applyCollection:a,relatedCollectionSet:this.relatedCollectionSet}),p.next=7,regeneratorRuntime.awrap(i.resultingCollection());case 7:return s=p.sent,c=s.allPayloads.map((function(e){return fa({payload:e,override:{dirty:l.finalDirtyStateForPayload(e)}})})),p.abrupt("return",new u({payloads:c,source:r}));case 10:case"end":return p.stop()}}),null,this)}},{key:"finalDirtyStateForPayload",value:function(e){var t=this.baseCollection.findPayload(e.uuid);return t?t.dirtiedDate>t.lastSyncBegan:e.dirty}}])&&As(t.prototype,r),n&&As(t,n),e}();function Ms(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Ks=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.rawResponse=t,Object(a.d)(this)}var t,r,n;return t=e,(r=[{key:"error",get:function(){return this.rawResponse.error}},{key:"lastSyncToken",get:function(){return this.rawResponse[Ea]}},{key:"paginationToken",get:function(){return this.rawResponse[Aa]}},{key:"integrityHash",get:function(){return this.rawResponse[Ma]}},{key:"checkIntegrity",get:function(){return this.integrityHash&&!this.paginationToken}},{key:"numberOfItemsInvolved",get:function(){return this.rawSavedItems.concat(this.rawRetrievedItems).concat(this.rawItemsFromConflicts).length}},{key:"allProcessedPayloads",get:function(){return this.retrievedPayloads.concat(this.savedPayloads).concat(this.conflictPayloads)}},{key:"savedPayloads",get:function(){return this.rawSavedItems.map((function(e){return la({object:e,source:Ir.RemoteSaved})}))}},{key:"retrievedPayloads",get:function(){return this.rawRetrievedItems.map((function(e){return la({object:e,source:Ir.RemoteRetrieved})}))}},{key:"conflictPayloads",get:function(){return this.rawItemsFromConflicts.map((function(e){return la({object:e,source:Ir.RemoteRetrieved})}))}},{key:"rawSavedItems",get:function(){return this.rawResponse.saved_items||[]}},{key:"rawRetrievedItems",get:function(){return this.rawResponse.retrieved_items||[]}},{key:"rawUuidConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return"uuid_conflict"===e.type})).map((function(e){return e.unsaved_item||e.item}))}},{key:"rawDataConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return"sync_conflict"===e.type})).map((function(e){return e.server_item||e.item}))}},{key:"rawItemsFromConflicts",get:function(){var e=this.rawResponse.conflicts||[],t=this.rawResponse.unsaved||[],r=e.map((function(e){return e.unsaved_item||e.server_item})),n=t.map((function(e){return e.item}));return r.concat(n)}},{key:"rawConflictObjects",get:function(){var e=this.rawResponse.conflicts||[],t=this.rawResponse.unsaved||[];return e.concat(t)}},{key:"hasError",get:function(){return!Object(a.l)(this.rawResponse.error)}}])&&Ms(t.prototype,r),n&&Ms(t,n),e}();function Fs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Ls=function(){function e(t){var r=t.payloads,n=t.receiver,a=t.lastSyncToken,o=t.paginationToken,i=t.checkIntegrity,s=t.apiService;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.payloads=r,this.pendingPayloads=r,this.lastSyncToken=a,this.paginationToken=o,this.checkIntegrity=i,this.apiService=s,this.receiver=n,this.responses=[]}var t,r,n;return t=e,(r=[{key:"popPayloads",value:function(e){var t=this.pendingPayloads.slice(0,e);return Object(a.x)(this.pendingPayloads,t),t}},{key:"run",value:function(){var e,t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return e=this.popPayloads(this.upLimit),n.next=3,regeneratorRuntime.awrap(this.apiService.sync({payloads:e,lastSyncToken:this.lastSyncToken,paginationToken:this.paginationToken,limit:this.downLimit,checkIntegrity:this.checkIntegrity}));case 3:return t=n.sent,r=new Ks(t),this.responses.push(r),this.lastSyncToken=r.lastSyncToken,this.paginationToken=r.paginationToken,n.next=10,regeneratorRuntime.awrap(this.receiver(r,1));case 10:if(this.done){n.next=12;break}return n.abrupt("return",this.run());case 12:case"end":return n.stop()}}),null,this)}},{key:"payloadsSavedOrSaving",get:function(){return Object(a.b)(this.payloads,this.pendingPayloads)}},{key:"done",get:function(){return 0===this.pendingPayloads.length&&!this.paginationToken}},{key:"upLimit",get:function(){return 150}},{key:"downLimit",get:function(){return 150}},{key:"numberOfItemsInvolved",get:function(){var e=0,t=!0,r=!1,n=void 0;try{for(var a,o=this.responses[Symbol.iterator]();!(t=(a=o.next()).done);t=!0)e+=a.value.numberOfItemsInvolved}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}return e}}])&&Fs(t.prototype,r),n&&Fs(t,n),e}();function Us(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ns(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Bs=function(){function e(t){var r=t.payloads,n=t.receiver;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.payloads=r,this.receiver=n}var t,r,n;return t=e,(r=[{key:"run",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=this.payloads.map((function(e){var t;return la({object:e,source:Ir.LocalSaved,override:(t={},Us(t,ae.Dirty,!1),Us(t,ae.LastSyncEnd,new Date),t)})})),t={payloads:e},r.next=4,regeneratorRuntime.awrap(this.receiver(t,1));case 4:case"end":return r.stop()}}),null,this)}}])&&Ns(t.prototype,r),n&&Ns(t,n),e}();function Vs(e){return(Vs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Hs(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Ws(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function zs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function qs(e,t){return!t||"object"!==Vs(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ys(e,t,r){return(Ys="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Js(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Js(e){return(Js=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Gs(e,t){return(Gs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Qs=5,$s=15,Xs={Default:1,DownloadFirst:2},Zs={External:1,SpawnQueue:2,ResolveQueue:3,MoreDirtyItems:4,AfterDownloadFirst:5,IntegrityCheck:6,ResolveOutOfSync:7},eu=function(e){function t(e){var r,n=e.sessionManager,a=e.protocolService,o=e.storageService,s=e.modelManager,u=e.apiService,c=e.interval;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=qs(this,Js(t).call(this))).sessionManager=n,r.protocolService=a,r.modelManager=s,r.storageService=o,r.apiService=u,r.interval=c,r.statusObservers=[],r.resolveQueue=[],r.spawnQueue=[],r.majorChangeThreshold=$s,r.maxDiscordance=Qs,r.initializeStatus(),r.initializeState(),r.localLoadPriorty=[i.ItemsKey,i.UserPrefs,i.Privileges,i.Component,i.Theme],r.nonEncryptedTypes=[i.Mfa,i.ServerExtension],r}var r,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Gs(e,t)}(t,e),r=t,(n=[{key:"initializeStatus",value:function(){var e=this;this.opStatus=new _s({interval:this.interval,receiver:function(t){e.notifyEvent(t)}})}},{key:"initializeState",value:function(){var e=this;this.state=new Is({maxDiscordance:this.maxDiscordance,receiver:function(t){t===y.EnterOutOfSync?e.notifyEvent(y.EnterOutOfSync):t===y.ExitOutOfSync&&e.notifyEvent(y.ExitOutOfSync)}})}},{key:"lockSyncing",value:function(){this.locked=!0}},{key:"unlockSyncing",value:function(){this.locked=!1}},{key:"isOutOfSync",value:function(){return this.state.isOutOfSync()}},{key:"getLastSyncDate",value:function(){return this.state.lastSyncDate}},{key:"resetSyncState",value:function(){this.state.reset()}},{key:"getDatabasePayloads",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getAllRawPayloads());case 1:case"end":return e.stop()}}),null,this)}},{key:"isDatabaseLoaded",value:function(){return this.databaseLoaded}},{key:"loadDatabasePayloads",value:function(e){var t,r,n,o,s,u,c,l,p,f,h;return regeneratorRuntime.async((function(d){for(;;)switch(d.prev=d.next){case 0:if(!this.databaseLoaded){d.next=2;break}throw"Attempting to initialize already initialized local database.";case 2:return t=e.map((function(e){return ua({object:e})})),r=Ps(t,this.localLoadPriorty),n=r.filter((function(e){return e.content_type===i.ItemsKey})),Object(a.x)(r,n),d.next=8,regeneratorRuntime.awrap(this.protocolService.payloadsByDecryptingPayloads({payloads:n}));case 8:return o=d.sent,d.next=11,regeneratorRuntime.awrap(this.modelManager.mapPayloadsToLocalItems({payloads:o,source:Ir.LocalRetrieved}));case 11:s=r.length,u=100,c=Math.ceil(s/u),l=0;case 15:if(!(l<c)){d.next=28;break}return p=l*u,f=r.slice(p,p+u),d.next=20,regeneratorRuntime.awrap(this.protocolService.payloadsByDecryptingPayloads({payloads:f}));case 20:return h=d.sent,d.next=23,regeneratorRuntime.awrap(this.modelManager.mapPayloadsToLocalItems({payloads:h,source:Ir.LocalRetrieved}));case 23:this.notifyEvent(y.LocalDataIncrementalLoad),this.opStatus.setDatabaseLoadStatus({current:p,total:s});case 25:l++,d.next=15;break;case 28:this.opStatus.setDatabaseLoadStatus({done:!0}),this.databaseLoaded=!0;case 30:case"end":return d.stop()}}),null,this)}},{key:"setLastSyncToken",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return this.syncToken=e,t.abrupt("return",this.storageService.setValue(C.LastSyncToken,e));case 2:case"end":return t.stop()}}),null,this)}},{key:"setPaginationToken",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.cursorToken=e,!e){t.next=5;break}return t.abrupt("return",this.storageService.setValue(C.PaginationToken,e));case 5:return t.abrupt("return",this.storageService.removeValue(C.PaginationToken));case 6:case"end":return t.stop()}}),null,this)}},{key:"getLastSyncToken",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.syncToken){e.next=4;break}return e.next=3,regeneratorRuntime.awrap(this.storageService.getValue(C.LastSyncToken));case 3:this.syncToken=e.sent;case 4:return e.abrupt("return",this.syncToken);case 5:case"end":return e.stop()}}),null,this)}},{key:"getPaginationToken",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken){e.next=4;break}return e.next=3,regeneratorRuntime.awrap(this.storageService.getValue(C.PaginationToken));case 3:this.cursorToken=e.sent;case 4:return e.abrupt("return",this.cursorToken);case 5:case"end":return e.stop()}}),null,this)}},{key:"clearSyncPositionTokens",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=null,this.cursorToken=null,e.next=4,regeneratorRuntime.awrap(this.storageService.removeValue(C.LastSyncToken));case 4:return e.next=6,regeneratorRuntime.awrap(this.storageService.removeValue(C.PaginationToken));case 6:case"end":return e.stop()}}),null,this)}},{key:"itemsNeedingSync",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return e=this.modelManager.getDirtyItems(),t.abrupt("return",e);case 2:case"end":return t.stop()}}),null,this)}},{key:"alternateUuidForItem",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(e.isItem){a.next=2;break}throw"Attempting to alternate uuid of non-item object";case 2:return t=ua({object:e}),a.next=5,regeneratorRuntime.awrap(_r({payload:t,baseCollection:this.modelManager.getMasterCollection()}));case 5:return r=a.sent,a.next=8,regeneratorRuntime.awrap(this.modelManager.mapPayloadsToLocalItems({payloads:r,source:Ir.LocalSaved}));case 8:return n=a.sent,a.next=11,regeneratorRuntime.awrap(this.persistPayloads({decryptedPayloads:r}));case 11:return a.abrupt("return",n[0]);case 12:case"end":return a.stop()}}),null,this)}},{key:"markAllItemsAsNeedingSync",value:function(){var e,t,r,n,a,o,i,s,u,c,l,p=arguments;return regeneratorRuntime.async((function(f){for(;;)switch(f.prev=f.next){case 0:if(e=p.length>0&&void 0!==p[0]?p[0]:{},t=e.alternateUuids,this.log("Marking all items as needing sync"),!t){f.next=30;break}r=this.modelManager.allNondummyItems.filter((function(e){return!e.errorDecrypting})).slice(),n=!0,a=!1,o=void 0,f.prev=7,i=r[Symbol.iterator]();case 9:if(n=(s=i.next()).done){f.next=16;break}return u=s.value,f.next=13,regeneratorRuntime.awrap(this.alternateUuidForItem(u));case 13:n=!0,f.next=9;break;case 16:f.next=22;break;case 18:f.prev=18,f.t0=f.catch(7),a=!0,o=f.t0;case 22:f.prev=22,f.prev=23,n||null==i.return||i.return();case 25:if(f.prev=25,!a){f.next=28;break}throw o;case 28:return f.finish(25);case 29:return f.finish(22);case 30:return c=this.modelManager.allNondummyItems,l=c.map((function(e){return ua({object:e,override:{dirty:!0}})})),f.next=34,regeneratorRuntime.awrap(this.modelManager.mapPayloadsToLocalItems({payloads:l}));case 34:return f.next=36,regeneratorRuntime.awrap(this.persistPayloads({decryptedPayloads:l}));case 36:case"end":return f.stop()}}),null,this,[[7,18,22,30],[23,,25,29]])}},{key:"repersistAllItems",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=this.modelManager.allItems,t=e.map((function(e){return ua({object:e})})),r.abrupt("return",this.persistPayloads({decryptedPayloads:t}));case 3:case"end":return r.stop()}}),null,this)}},{key:"popPayloadsNeedingPreSyncSave",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(t=this.state.lastPreSyncSaveDate){n.next=3;break}return n.abrupt("return",e);case 3:return r=e.filter((function(e){return!e.dirtiedDate||e.dirtiedDate>t})),this.state.setLastPresaveSyncDate(new Date),n.abrupt("return",r);case 6:case"end":return n.stop()}}),null,this)}},{key:"timingStrategyResolveOnNext",value:function(){var e=this;return new Promise((function(t,r){e.resolveQueue.push({resolve:t,reject:r})}))}},{key:"timingStrategyForceSpawnNew",value:function(e){var t=this;return new Promise((function(r,n){t.spawnQueue.push({resolve:r,reject:n,options:e})}))}},{key:"popSpawnQueue",value:function(){if(0===this.spawnQueue.length)return null;var e=this.spawnQueue[0];return Object(a.v)(this.spawnQueue,0),this.log("Syncing again from spawn queue"),this.sync(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Hs(Object(r),!0).forEach((function(t){Ws(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Hs(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({timingStrategy:2,source:Zs.SpawnQueue},e.options)).then((function(){e.resolve()})).catch((function(){e.reject()}))}},{key:"payloadsByPreparingForServer",value:function(e){var t=this;return this.protocolService.payloadsByEncryptingPayloads({payloads:e,intent:function(e){return t.nonEncryptedTypes.includes(e.content_type)?W.SyncDecrypted:W.Sync}})}},{key:"sync",value:function(){var e,t,r,n,o,i,s,u,c,l,p,f,h,d,v,m,g,b,w,x,k,S,R,P,O,_,j,I=this,D=arguments;return regeneratorRuntime.async((function(C){for(;;)switch(C.prev=C.next){case 0:if(e=D.length>0&&void 0!==D[0]?D[0]:{},t=e.timingStrategy,r=e.mode,n=e.checkIntegrity,o=e.source,!this.locked){C.next=4;break}return this.log("Sync Locked"),C.abrupt("return");case 4:return i=function(){return I.syncLock},s=function(){I.syncLock=!0},u=function(){I.syncLock=!1},c=this.opStatus.syncInProgress,l=this.databaseLoaded,(p=!i())&&l&&!c&&s(),o||(o=Zs.External),C.next=14,regeneratorRuntime.awrap(this.itemsNeedingSync());case 14:return f=C.sent,h=f.filter((function(e){return e.neverSynced&&e.deleted})),Object(a.x)(f,h),d=f.map((function(e){return e.payloadRepresentation()})),C.next=20,regeneratorRuntime.awrap(this.popPayloadsNeedingPreSyncSave(d));case 20:return v=C.sent,C.next=23,regeneratorRuntime.awrap(this.persistPayloads({decryptedPayloads:v}));case 23:if(m=this.resolveQueue.slice(),g=Object(a.l)(t)?1:t,!c&&l&&p){C.next=36;break}if(this.log(p?c?"Attempting to sync while existing sync in progress.":"Attempting to sync before local database has loaded.":"Another function call has begun preparing for sync."),1!==g){C.next=31;break}return C.abrupt("return",this.timingStrategyResolveOnNext());case 31:if(2!==g){C.next=35;break}return C.abrupt("return",this.timingStrategyForceSpawnNew({mode:r,checkIntegrity:n,source:o}));case 35:throw"Unhandled timing strategy ".concat(g);case 36:return this.opStatus.setDidBegin(),b=new Date,C.next=40,regeneratorRuntime.awrap(this.modelManager.setItemsProperties({items:f,properties:Ws({},ae.LastSyncBegan,b)}));case 40:return w=Object(a.l)(r)?Xs.Default:r,C.next=43,regeneratorRuntime.awrap(this.sessionManager.online());case 43:if(x=C.sent,w!==Xs.Default){C.next=56;break}if(this.completedInitialSync){C.next=47;break}throw"Attempting to default mode sync without having completed initial.";case 47:if(!x){C.next=53;break}return C.next=50,regeneratorRuntime.awrap(this.payloadsByPreparingForServer(d));case 50:k=C.sent,C.next=54;break;case 53:k=d;case 54:C.next=57;break;case 56:w===Xs.DownloadFirst&&(k=[]);case 57:if(!x){C.next=63;break}return C.next=60,regeneratorRuntime.awrap(this.syncOnlineOperation({payloads:k,checkIntegrity:n,source:o,mode:w}));case 60:S=C.sent,C.next=66;break;case 63:return C.next=65,regeneratorRuntime.awrap(this.syncOfflineOperation({payloads:k}));case 65:S=C.sent;case 66:return C.next=68,regeneratorRuntime.awrap(S.run());case 68:for(this.opStatus.setDidEnd(),u(),R=!0,P=!1,O=void 0,C.prev=73,_=m[Symbol.iterator]();!(R=(j=_.next()).done);R=!0)j.value.resolve();C.next=81;break;case 77:C.prev=77,C.t0=C.catch(73),P=!0,O=C.t0;case 81:C.prev=81,C.prev=82,R||null==_.return||_.return();case 84:if(C.prev=84,!P){C.next=87;break}throw O;case 87:return C.finish(84);case 88:return C.finish(81);case 89:if(Object(a.x)(this.resolveQueue,m),!this.opStatus.hasError()){C.next=92;break}return C.abrupt("return");case 92:return this.opStatus.reset(),this.state.setLastSyncDate(new Date),S.numberOfItemsInvolved>=this.majorChangeThreshold&&this.notifyEvent(y.MajorDataChange),C.next=97,regeneratorRuntime.awrap(this.handleNeverSyncedDeleted(h));case 97:if(w===Xs.DownloadFirst){C.next=100;break}return C.next=100,regeneratorRuntime.awrap(this.notifyEvent(y.FullSyncCompleted,{source:o}));case 100:if(w!==Xs.DownloadFirst){C.next=107;break}return this.completedInitialSync=!0,C.next=104,regeneratorRuntime.awrap(this.notifyEvent(y.DownloadFirstSyncCompleted));case 104:return C.abrupt("return",this.sync({source:Zs.AfterDownloadFirst,checkIntegrity:!0}));case 107:if(this.popSpawnQueue()||!(this.resolveQueue.length>0)){C.next=112;break}this.log("Syncing again from resolve queue"),this.sync({source:Zs.ResolveQueue}),C.next=125;break;case 112:return C.next=114,regeneratorRuntime.awrap(this.itemsNeedingSync());case 114:if(C.t1=C.sent.length,!(C.t1>0)){C.next=119;break}return C.abrupt("return",this.sync({source:Zs.MoreDirtyItems}));case 119:if(!S.checkIntegrity){C.next=123;break}this.state.needsSync&&S.done&&(this.log("Syncing again from integrity check"),this.sync({checkIntegrity:!0,timingStrategy:2,source:Zs.IntegrityCheck})),C.next=125;break;case 123:return C.next=125,regeneratorRuntime.awrap(this.state.clearIntegrityHashes());case 125:case"end":return C.stop()}}),null,this,[[73,77,81,89],[82,,84,88]])}},{key:"syncOnlineOperation",value:function(e){var t,r,n,a,o,i=this;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:return t=e.payloads,r=e.checkIntegrity,n=e.source,a=e.mode,this.log("Syncing online user","source:",n,"mode:",a,"payloads:",t),s.t0=Ls,s.t1=this.apiService,s.t2=t,s.t3=r,s.next=8,regeneratorRuntime.awrap(this.getLastSyncToken());case 8:return s.t4=s.sent,s.next=11,regeneratorRuntime.awrap(this.getPaginationToken());case 11:return s.t5=s.sent,s.t6=function(e,t){var r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(1!==t){n.next=11;break}if(!(r=e).hasError){n.next=7;break}return n.next=5,regeneratorRuntime.awrap(i.handleErrorServerResponse({operation:o,response:r}));case 5:n.next=9;break;case 7:return n.next=9,regeneratorRuntime.awrap(i.handleSuccessServerResponse({operation:o,response:r}));case 9:n.next=14;break;case 11:if(2!==t){n.next=14;break}return n.next=14,regeneratorRuntime.awrap(i.handleStatusChange({operation:o}));case 14:case"end":return n.stop()}}))},s.t7={apiService:s.t1,payloads:s.t2,checkIntegrity:s.t3,lastSyncToken:s.t4,paginationToken:s.t5,receiver:s.t6},o=new s.t0(s.t7),s.abrupt("return",o);case 16:case"end":return s.stop()}}),null,this)}},{key:"syncOfflineOperation",value:function(e){var t,r,n=this;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.payloads,this.log("Syncing offline user",t),r=new Bs({payloads:t,receiver:function(e,t){return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(1!==t){a.next=5;break}return a.next=3,regeneratorRuntime.awrap(n.handleOfflineResponse(e));case 3:a.next=8;break;case 5:if(2!==t){a.next=8;break}return a.next=8,regeneratorRuntime.awrap(n.handleStatusChange({operation:r}));case 8:case"end":return a.stop()}}))}}),a.abrupt("return",r);case 4:case"end":return a.stop()}}),null,this)}},{key:"handleStatusChange",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:t=e.operation,r=t.pendingUploadCount(),n=t.totalUploadCount(),a=n-r,this.opStatus.setUploadStatus({completed:a,total:n});case 5:case"end":return o.stop()}}),null,this)}},{key:"handleOfflineResponse",value:function(e){var t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=e.payloads,r=this.modelManager.getMasterCollection(),n=t.map((function(e){return r.findPayload(e.uuid).mergedWith(e)})),a.next=5,regeneratorRuntime.awrap(this.persistPayloads({decryptedPayloads:n}));case 5:return a.next=7,regeneratorRuntime.awrap(this.modelManager.mapPayloadsToLocalItems({payloads:t,source:Ir.LocalSaved}));case 7:case"end":return a.stop()}}),null,this)}},{key:"handleErrorServerResponse",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:e.operation,t=e.response,this.log("Sync Error",t),401===t.status&&this.notifyEvent(y.InvalidSession),this.opStatus.setError(t.error),this.notifyEvent(y.SyncError,t.error);case 5:case"end":return r.stop()}}),null,this)}},{key:"handleSuccessServerResponse",value:function(e){var t,r,n,o,i,s,u,c,l,p,f,h,d,v,m,g,b,w,x,k,S,R;return regeneratorRuntime.async((function(P){for(;;)switch(P.prev=P.next){case 0:if(t=e.operation,r=e.response,!this._simulate_latency){P.next=4;break}return P.next=4,regeneratorRuntime.awrap(Object(a.w)(this._simulate_latency.latency));case 4:this.log("Online Sync Response",r.rawResponse),this.setLastSyncToken(r.lastSyncToken),this.setPaginationToken(r.paginationToken),this.opStatus.clearError(),this.opStatus.setDownloadStatus({downloaded:r.allProcessedPayloads.length}),n=[],o=!0,i=!1,s=void 0,P.prev=13,u=r.allProcessedPayloads[Symbol.iterator]();case 15:if(o=(c=u.next()).done){P.next=26;break}if(!(l=c.value).deleted&&l.fields().includes(ae.Content)){P.next=19;break}return P.abrupt("continue",23);case 19:return P.next=21,regeneratorRuntime.awrap(this.protocolService.payloadByDecryptingPayload({payload:l}));case 21:p=P.sent,n.push(p);case 23:o=!0,P.next=15;break;case 26:P.next=32;break;case 28:P.prev=28,P.t0=P.catch(13),i=!0,s=P.t0;case 32:P.prev=32,P.prev=33,o||null==u.return||u.return();case 35:if(P.prev=35,!i){P.next=38;break}throw s;case 38:return P.finish(35);case 39:return P.finish(32);case 40:return f=this.modelManager.getMasterCollection(),h=new Ts({response:r,decryptedResponsePayloads:n,payloadsSavedOrSaving:t.payloadsSavedOrSaving,baseCollection:f}),P.next=44,regeneratorRuntime.awrap(h.collectionsByProcessingResponse());case 44:d=P.sent,v=!0,m=!1,g=void 0,P.prev=48,b=d[Symbol.iterator]();case 50:if(v=(w=b.next()).done){P.next=62;break}return x=w.value,P.next=54,regeneratorRuntime.awrap(this.modelManager.mapCollectionToLocalItems({collection:x}));case 54:return k=void 0,S=da(x.source),k=S.fields().includes(ae.Content)?x.allPayloads:x.allPayloads.map((function(e){return f.findPayload(e.uuid).mergedWith(e)})),P.next=59,regeneratorRuntime.awrap(this.persistPayloads({decryptedPayloads:k}));case 59:v=!0,P.next=50;break;case 62:P.next=68;break;case 64:P.prev=64,P.t1=P.catch(48),m=!0,g=P.t1;case 68:P.prev=68,P.prev=69,v||null==b.return||b.return();case 71:if(P.prev=71,!m){P.next=74;break}throw g;case 74:return P.finish(71);case 75:return P.finish(68);case 76:return P.next=78,regeneratorRuntime.awrap(this.notifyEvent(y.SingleSyncCompleted,r));case 78:if(!r.checkIntegrity){P.next=84;break}return P.next=81,regeneratorRuntime.awrap(this.computeDataIntegrityHash());case 81:return R=P.sent,P.next=84,regeneratorRuntime.awrap(this.state.setIntegrityHashes({clientHash:R,serverHash:r.integrityHash}));case 84:case"end":return P.stop()}}),null,this,[[13,28,32,40],[33,,35,39],[48,64,68,76],[69,,71,75]])}},{key:"handleNeverSyncedDeleted",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=e.map((function(e){return e.payloadRepresentation({override:{dirty:!1}})})),r.next=3,regeneratorRuntime.awrap(this.modelManager.mapPayloadsToLocalItems({payloads:t}));case 3:return r.next=5,regeneratorRuntime.awrap(this.persistPayloads({decryptedPayloads:t}));case 5:case"end":return r.stop()}}),null,this)}},{key:"persistPayloads",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(t=e.decryptedPayloads,0!==(r=void 0===t?[]:t).length){n.next=3;break}return n.abrupt("return");case 3:return n.next=5,regeneratorRuntime.awrap(this.storageService.savePayloads(r));case 5:case"end":return n.stop()}}),null,this)}},{key:"computeDataIntegrityHash",value:function(){var e,t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,e=this.modelManager.nonDeletedItems.sort((function(e,t){return t.updated_at-e.updated_at})),t=e.map((function(e){return e.updatedAtTimestamp()})),r=t.join(","),n.abrupt("return",this.protocolService.crypto.sha256(r));case 7:return n.prev=7,n.t0=n.catch(0),console.error("Error computing data integrity hash",n.t0),n.abrupt("return",null);case 11:case"end":return n.stop()}}),null,this,[[0,7]])}},{key:"deinit",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return Ys(Js(t.prototype),"deinit",this).call(this),this.state.reset(),this.opStatus.reset(),this.resolveQueue=[],this.spawnQueue=[],e.next=7,regeneratorRuntime.awrap(this.clearSyncPositionTokens());case 7:case"end":return e.stop()}}),null,this)}},{key:"resolveOutOfSync",value:function(){var e,t,r,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return e=new Cs({apiService:this.apiService,protocolService:this.protocolService,customEvent:"resolve-out-of-sync"}),a.next=3,regeneratorRuntime.awrap(e.run());case 3:return t=a.sent,r=new Vn({baseCollection:this.modelManager.getMasterCollection(),applyCollection:new u({payloads:t,source:Ir.RemoteRetrieved})}),a.next=7,regeneratorRuntime.awrap(r.resultingCollection());case 7:return n=a.sent,a.next=10,regeneratorRuntime.awrap(this.modelManager.mapCollectionToLocalItems({collection:n}));case 10:return a.next=12,regeneratorRuntime.awrap(this.persistPayloads({decryptedPayloads:n.payloads}));case 12:return a.abrupt("return",this.sync({checkIntegrity:!0,source:Zs.ResolveOutOfSync}));case 13:case"end":return a.stop()}}),null,this)}},{key:"statelessDownloadAllItems",value:function(){var e,t,r,n,a,o=arguments;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return e=o.length>0&&void 0!==o[0]?o[0]:{},t=e.contentType,r=e.customEvent,n=new Cs({apiService:this.apiService,protocolService:this.protocolService,contentType:t,customEvent:r}),i.next=4,regeneratorRuntime.awrap(n.run());case 4:return a=i.sent,i.abrupt("return",a.map((function(e){return Pr(e)})));case 6:case"end":return i.stop()}}),null,this)}},{key:"ut_setDatabaseLoaded",value:function(e){this.databaseLoaded=e}},{key:"ut_beginLatencySimulator",value:function(e){this._simulate_latency={latency:e||1e3,enabled:!0}}},{key:"ut_endLatencySimulator",value:function(){this._simulate_latency=null}}])&&zs(r.prototype,n),o&&zs(r,o),t}(ma);function tu(e){return(tu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ru(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function nu(e,t){return!t||"object"!==tu(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function au(e){return(au=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ou(e,t){return(ou=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var iu=function(e){function t(e){var r,n=e.storageService,a=e.keyManager,o=e.protocolService;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=nu(this,au(t).call(this))).storageService=n,r.keyManager=a,r.protocolService=o,r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ou(e,t)}(t,e),r=t,(n=[{key:"isPasscodeLocked",value:function(){return this.keyManager.rootKeyNeedsUnwrapping()}},{key:"getLaunchChallenges",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=[],r.next=3,regeneratorRuntime.awrap(this.keyManager.hasPasscode());case 3:return r.sent&&e.push(D.LocalPasscode),r.next=7,regeneratorRuntime.awrap(this.storageService.getValue(C.BiometricPrefs,ii.Nonwrapped));case 7:return(t=r.sent)&&t.enabled&&e.push(D.Biometric),r.abrupt("return",e);case 11:case"end":return r.stop()}}),null,this)}},{key:"enableBiometrics",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.storageService.setValue(C.BiometricPrefs,{enabled:!0},ii.Nonwrapped));case 2:case"end":return e.stop()}}),null,this)}},{key:"validateChallengeResponse",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.challenge!==D.LocalPasscode){t.next=4;break}return t.abrupt("return",this.keyManager.validatePasscode(e.value));case 4:if(e.challenge!==D.AccountPassword){t.next=8;break}return t.abrupt("return",this.keyManager.validateAccountPassword(e.value));case 8:if(e.challenge!==D.Biometric){t.next=10;break}return t.abrupt("return",!0===e.value);case 10:throw"Cannot validate challenge type ".concat(e.challenge);case 11:case"end":return t.stop()}}),null,this)}},{key:"handleChallengeResponse",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(e.challenge!==D.LocalPasscode){r.next=8;break}return r.next=3,regeneratorRuntime.awrap(this.keyManager.computeWrappingKey({passcode:e.value}));case 3:return t=r.sent,r.next=6,regeneratorRuntime.awrap(this.keyManager.unwrapRootKey({wrappingKey:t}));case 6:r.next=8;break;case 8:case"end":return r.stop()}}),null,this)}}])&&ru(r.prototype,n),a&&ru(r,a),t}(ma);function su(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var uu=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.environment,n=t.platform,a=t.namespace,o=t.host,i=t.deviceInterface,s=t.swapClasses,u=t.skipClasses,c=t.crypto;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!i)throw"Device Interface must be supplied.";if(!r)throw"Environment must be supplied when creating an application.";if(!n)throw"Platform must be supplied when creating an application.";this.environment=r,this.platform=n,this.namespace=a||"",this.host=o,this.deviceInterface=i,this.crypto=c,this.swapClasses=s,this.skipClasses=u,this.eventHandlers=[],this.services=[],this.streamObservers=[],this.serviceObservers=[],this.managedSubscribers=[],this.constructServices()}var t,r,n;return t=e,(r=[{key:"prepareForLaunch",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if((t=e.callbacks).requiresChallengeResponses){r.next=3;break}throw"Application.launch callbacks are not properly configured.";case 3:return this.launchCallbacks=t,r.next=6,regeneratorRuntime.awrap(this.deviceInterface.openDatabase());case 6:return r.next=8,regeneratorRuntime.awrap(this.migrationService.initialize());case 8:return r.next=10,regeneratorRuntime.awrap(this.handleStage(v));case 10:return r.next=12,regeneratorRuntime.awrap(this.storageService.initializeFromDisk());case 12:return r.next=14,regeneratorRuntime.awrap(this.keyManager.initialize());case 14:return r.next=16,regeneratorRuntime.awrap(this.handleStage(m));case 16:return this.started=!0,r.next=19,regeneratorRuntime.awrap(this.notifyEvent(d.Started));case 19:case"end":return r.stop()}}),null,this)}},{key:"launch",value:function(){var e,t,r,n,a=this,o=arguments;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return e=o.length>0&&void 0!==o[0]?o[0]:{},t=e.awaitDatabaseLoad,i.next=3,regeneratorRuntime.awrap(this.handleLaunchAuthentication());case 3:return i.next=5,regeneratorRuntime.awrap(this.storageService.isStorageWrapped());case 5:if(!i.sent){i.next=8;break}return i.next=8,regeneratorRuntime.awrap(this.storageService.decryptStorage());case 8:return i.next=10,regeneratorRuntime.awrap(this.handleStage(g));case 10:return i.next=12,regeneratorRuntime.awrap(this.sessionManager.initializeFromDisk());case 12:return this.historyManager.initializeFromDisk(),this.unlocked=!0,i.next=16,regeneratorRuntime.awrap(this.notifyEvent(d.Launched));case 16:return i.next=18,regeneratorRuntime.awrap(this.handleStage(b));case 18:return i.next=20,regeneratorRuntime.awrap(this.syncService.getDatabasePayloads());case 20:return r=i.sent,i.next=23,regeneratorRuntime.awrap(this.handleStage(w));case 23:if(n=this.syncService.loadDatabasePayloads(r).then((function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(!a.dealloced){e.next=2;break}throw"Application has been destroyed.";case 2:return e.next=4,regeneratorRuntime.awrap(a.handleStage(x));case 4:return a.beginAutoSyncTimer(),e.abrupt("return",a.syncService.sync({mode:Xs.DownloadFirst}));case 6:case"end":return e.stop()}}))})),!t){i.next=27;break}return i.next=27,regeneratorRuntime.awrap(n);case 27:case"end":return i.stop()}}),null,this)}},{key:"beginAutoSyncTimer",value:function(){var e=this;this.autoSyncInterval=this.deviceInterface.interval((function(){e.syncService.log("Syncing from autosync"),e.sync()}),3e4)}},{key:"handleLaunchAuthentication",value:function(){var e;return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.deviceAuthService.getLaunchChallenges());case 2:return e=t.sent,t.next=5,regeneratorRuntime.awrap(this.handleLaunchChallenge(e));case 5:case"end":return t.stop()}}),null,this)}},{key:"handleLaunchChallenge",value:function(e){var t,r,n,o,i,s,u,c,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:t=e.slice();case 1:if(!(t.length>0)){p.next=43;break}return p.next=4,regeneratorRuntime.awrap(this.launchCallbacks.requiresChallengeResponses(t));case 4:r=p.sent,n=Array.isArray(r)?r:[r],o=!0,i=!1,s=void 0,p.prev=9,u=n[Symbol.iterator]();case 11:if(o=(c=u.next()).done){p.next=27;break}return l=c.value,p.next=15,regeneratorRuntime.awrap(this.deviceAuthService.validateChallengeResponse(l));case 15:if(!p.sent){p.next=22;break}return p.next=19,regeneratorRuntime.awrap(this.deviceAuthService.handleChallengeResponse(l));case 19:Object(a.u)(t,l.challenge),p.next=24;break;case 22:return p.next=24,regeneratorRuntime.awrap(this.launchCallbacks.handleChallengeFailures([l]));case 24:o=!0,p.next=11;break;case 27:p.next=33;break;case 29:p.prev=29,p.t0=p.catch(9),i=!0,s=p.t0;case 33:p.prev=33,p.prev=34,o||null==u.return||u.return();case 36:if(p.prev=36,!i){p.next=39;break}throw s;case 39:return p.finish(36);case 40:return p.finish(33);case 41:p.next=1;break;case 43:case"end":return p.stop()}}),null,this,[[9,29,33,41],[34,,36,40]])}},{key:"getMigrationChallengeResponder",value:function(){var e=this;return function(t){var r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap(e.launchCallbacks.requiresChallengeResponses([t]));case 2:return r=n.sent,n.abrupt("return",r[0]);case 4:case"end":return n.stop()}}))}}},{key:"handleStage",value:function(e){var t,r,n,a,o,i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:t=!0,r=!1,n=void 0,s.prev=3,a=this.services[Symbol.iterator]();case 5:if(t=(o=a.next()).done){s.next=12;break}return i=o.value,s.next=9,regeneratorRuntime.awrap(i.handleApplicationStage(e));case 9:t=!0,s.next=5;break;case 12:s.next=18;break;case 14:s.prev=14,s.t0=s.catch(3),r=!0,n=s.t0;case 18:s.prev=18,s.prev=19,t||null==a.return||a.return();case 21:if(s.prev=21,!r){s.next=24;break}throw n;case 24:return s.finish(21);case 25:return s.finish(18);case 26:case"end":return s.stop()}}),null,this,[[3,14,18,26],[19,,21,25]])}},{key:"addEventObserver",value:function(e,t){var r=this,n={callback:e,singleEvent:t};return this.eventHandlers.push(n),function(){Object(a.u)(r.eventHandlers,n)}}},{key:"addSingleEventObserver",value:function(e,t){return this.addEventObserver((function(r){r===e&&t()}),e)}},{key:"notifyEvent",value:function(e,t){var r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:r=!0,n=!1,a=void 0,u.prev=3,o=this.eventHandlers.slice()[Symbol.iterator]();case 5:if(r=(i=o.next()).done){u.next=18;break}if(!(s=i.value).singleEvent||s.singleEvent!==e){u.next=12;break}return u.next=10,regeneratorRuntime.awrap(s.callback(e,t||{}));case 10:u.next=15;break;case 12:if(s.singleEvent){u.next=15;break}return u.next=15,regeneratorRuntime.awrap(s.callback(e,t||{}));case 15:r=!0,u.next=5;break;case 18:u.next=24;break;case 20:u.prev=20,u.t0=u.catch(3),n=!0,a=u.t0;case 24:u.prev=24,u.prev=25,r||null==o.return||o.return();case 27:if(u.prev=27,!n){u.next=30;break}throw a;case 30:return u.finish(27);case 31:return u.finish(24);case 32:case"end":return u.stop()}}),null,this,[[3,20,24,32],[25,,27,31]])}},{key:"isDatabaseLoaded",value:function(){return this.syncService.isDatabaseLoaded()}},{key:"savePayload",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.payload,r=fa({payload:t,override:{dirty:!0}}),n.next=4,regeneratorRuntime.awrap(this.modelManager.mapPayloadToLocalItem({payload:r}));case 4:return n.next=6,regeneratorRuntime.awrap(this.syncService.sync());case 6:case"end":return n.stop()}}),null,this)}},{key:"findItem",value:function(e){var t=e.uuid;return this.modelManager.findItem(t)}},{key:"findItems",value:function(e){var t=e.predicate;return this.modelManager.itemsMatchingPredicate(t)}},{key:"mergeItem",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.item,r=e.source,n.abrupt("return",this.modelManager.mapItem({item:t,source:r}));case 2:case"end":return n.stop()}}),null,this)}},{key:"createItem",value:function(e){var t,r,n,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=e.contentType,r=e.content,n=e.add,a=e.needsSync,i.next=3,regeneratorRuntime.awrap(this.modelManager.createItem({contentType:t,content:r,add:n,needsSync:a}));case 3:return o=i.sent,i.abrupt("return",o);case 5:case"end":return i.stop()}}),null,this)}},{key:"saveItem",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=e.item,r.next=3,regeneratorRuntime.awrap(this.modelManager.setItemDirty(t,!0));case 3:return r.next=5,regeneratorRuntime.awrap(this.syncService.sync());case 5:case"end":return r.stop()}}),null,this)}},{key:"saveItems",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=e.items,r.next=3,regeneratorRuntime.awrap(this.modelManager.setItemsDirty(t));case 3:return r.next=5,regeneratorRuntime.awrap(this.syncService.sync());case 5:case"end":return r.stop()}}),null,this)}},{key:"setItemNeedsSync",value:function(e){var t,r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.item,r=e.updateUserModifiedDate,n.abrupt("return",this.modelManager.setItemDirty(t,!0,r));case 2:case"end":return n.stop()}}),null,this)}},{key:"setItemsNeedsSync",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=e.items,r.abrupt("return",this.modelManager.setItemsDirty(t));case 2:case"end":return r.stop()}}),null,this)}},{key:"deleteItem",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:t=e.item,this.modelManager.setItemToBeDeleted(t),this.sync();case 3:case"end":return r.stop()}}),null,this)}},{key:"deleteItemLocally",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:t=e.item,this.modelManager.removeItemLocally(t);case 2:case"end":return r.stop()}}),null,this)}},{key:"emptyTrash",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.modelManager.emptyTrash());case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),null,this)}},{key:"getTrashedItems",value:function(){return this.modelManager.trashedItems()}},{key:"getItems",value:function(e){var t=e.contentType;return this.modelManager.getItems(t)}},{key:"getDisplayableItems",value:function(e){var t=e.contentType;return this.modelManager.validItemsForContentType(t)}},{key:"getNotesMatchingSmartTag",value:function(e){var t=e.smartTag;return this.modelManager.notesMatchingSmartTag(t)}},{key:"findTag",value:function(e){var t=e.title;return this.modelManager.findTagByTitle(t)}},{key:"findOrCreateTag",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=e.title,r.abrupt("return",this.modelManager.findOrCreateTagByTitle(t));case 2:case"end":return r.stop()}}),null,this)}},{key:"getSmartTags",value:function(){return this.modelManager.getSmartTags()}},{key:"getNoteCount",value:function(){return this.modelManager.noteCount()}},{key:"streamItems",value:function(e){var t=this,r=e.contentType,n=e.stream,o=this.modelManager.addMappingObserver(r,(function(e,t,r,a,o){var i=e.map((function(e){return e.content_type}));n({items:e,contentTypes:i,source:a,sourceKey:o})}));return this.streamObservers.push(o),function(){Object(a.u)(t.streamObservers,o)}}},{key:"setHost",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.apiService.setHost(e));case 1:case"end":return t.stop()}}),null,this)}},{key:"getHost",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.getHost());case 1:case"end":return e.stop()}}),null,this)}},{key:"getUser",value:function(){if(!this.unlocked)throw"Attempting to access user before application unlocked";return this.sessionManager.getUser()}},{key:"getUserVersion",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.getUserVersion());case 1:case"end":return e.stop()}}),null,this)}},{key:"protocolUpgradeAvailable",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.upgradeAvailable());case 1:case"end":return e.stop()}}),null,this)}},{key:"noAccount",value:function(){var e=this.getUser();return Object(a.l)(e)}},{key:"importData",value:function(e){var t,r,n,a,o,i,s;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:return t=e.data,r=e.password,n=e.awaitSync,u.next=3,regeneratorRuntime.awrap(this.protocolService.payloadsByDecryptingBackupFile({data:t,password:r}));case 3:return a=u.sent,o=a.filter((function(e){return!e.errorDecrypting})),u.next=7,regeneratorRuntime.awrap(this.modelManager.importPayloads(o));case 7:if(i=u.sent,s=this.sync(),!n){u.next=12;break}return u.next=12,regeneratorRuntime.awrap(s);case 12:return u.abrupt("return",{affectedItems:i,errorCount:a.length-o.length});case 13:case"end":return u.stop()}}),null,this)}},{key:"createBackupFile",value:function(){var e,t,r,n,a=arguments;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return e=a.length>0&&void 0!==a[0]?a[0]:{},t=e.subItems,r=e.intent,n=e.returnIfEmpty,o.abrupt("return",this.protocolService.createBackupFile({subItems:t,intent:r,returnIfEmpty:n}));case 2:case"end":return o.stop()}}),null,this)}},{key:"isEphemeralSession",value:function(){return this.storageService.isEphemeralSession()}},{key:"lockSyncing",value:function(){this.syncService.lockSyncing()}},{key:"unlockSyncing",value:function(){this.syncService.unlockSyncing()}},{key:"getSyncStatus",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.status);case 1:case"end":return e.stop()}}),null,this)}},{key:"sync",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.syncService.sync(e));case 1:case"end":return t.stop()}}),null,this)}},{key:"resolveOutOfSync",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.resolveOutOfSync());case 1:case"end":return e.stop()}}),null,this)}},{key:"setValue",value:function(e,t,r){return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",this.storageService.setValue(e,t,r));case 1:case"end":return n.stop()}}),null,this)}},{key:"getValue",value:function(e,t){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",this.storageService.getValue(e,t));case 1:case"end":return r.stop()}}),null,this)}},{key:"removeValue",value:function(e,t){return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",this.storageService.removeValue(e,t));case 1:case"end":return r.stop()}}),null,this)}},{key:"clearDatabase",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.clearAllPayloads());case 1:case"end":return e.stop()}}),null,this)}},{key:"rewriteItemsKeys",value:function(){var e,t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=this.itemsKeyManager.allItemsKeys,t=e.map((function(e){return e.payloadRepresentation()})),r.next=4,regeneratorRuntime.awrap(this.storageService.deletePayloads(t));case 4:return r.next=6,regeneratorRuntime.awrap(this.syncService.persistPayloads({decryptedPayloads:t}));case 6:case"end":return r.stop()}}),null,this)}},{key:"restart",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.deinit());case 2:return this.dealloced=!1,this.constructServices(),e.next=6,regeneratorRuntime.awrap(this.prepareForLaunch({callbacks:this.launchCallbacks}));case 6:return e.next=8,regeneratorRuntime.awrap(this.launch({awaitDatabaseLoad:!0}));case 8:case"end":return e.stop()}}),null,this)}},{key:"deinit",value:function(){var e,t,r,n,a,o,i,s,u,c,l,p,f,y,h,d;return regeneratorRuntime.async((function(v){for(;;)switch(v.prev=v.next){case 0:for(clearInterval(this.autoSyncInterval),e=!0,t=!1,r=void 0,v.prev=4,n=this.serviceObservers[Symbol.iterator]();!(e=(a=n.next()).done);e=!0)(0,a.value)();v.next=12;break;case 8:v.prev=8,v.t0=v.catch(4),t=!0,r=v.t0;case 12:v.prev=12,v.prev=13,e||null==n.return||n.return();case 15:if(v.prev=15,!t){v.next=18;break}throw r;case 18:return v.finish(15);case 19:return v.finish(12);case 20:for(o=!0,i=!1,s=void 0,v.prev=23,u=this.managedSubscribers[Symbol.iterator]();!(o=(c=u.next()).done);o=!0)(0,c.value)();v.next=31;break;case 27:v.prev=27,v.t1=v.catch(23),i=!0,s=v.t1;case 31:v.prev=31,v.prev=32,o||null==u.return||u.return();case 34:if(v.prev=34,!i){v.next=37;break}throw s;case 37:return v.finish(34);case 38:return v.finish(31);case 39:l=!0,p=!1,f=void 0,v.prev=42,y=this.services[Symbol.iterator]();case 44:if(l=(h=y.next()).done){v.next=52;break}if(!(d=h.value).deinit){v.next=49;break}return v.next=49,regeneratorRuntime.awrap(d.deinit());case 49:l=!0,v.next=44;break;case 52:v.next=58;break;case 54:v.prev=54,v.t2=v.catch(42),p=!0,f=v.t2;case 58:v.prev=58,v.prev=59,l||null==y.return||y.return();case 61:if(v.prev=61,!p){v.next=64;break}throw f;case 64:return v.finish(61);case 65:return v.finish(58);case 66:this.streamObservers=[],this.clearServices(),this.dealloced=!0,this.started=!1;case 70:case"end":return v.stop()}}),null,this,[[4,8,12,20],[13,,15,19],[23,27,31,39],[32,,34,38],[42,54,58,66],[59,,61,65]])}},{key:"registerService",value:function(e){this.services.push(e)}},{key:"register",value:function(e){var t,r,n,a,o;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=e.email,r=e.password,n=e.ephemeral,a=e.mergeLocal,this.lockSyncing(),i.next=4,regeneratorRuntime.awrap(this.sessionManager.register({email:t,password:r}));case 4:if((o=i.sent).response.error){i.next=27;break}return i.next=8,regeneratorRuntime.awrap(this.keyManager.setNewRootKey({key:o.rootKey,keyParams:o.keyParams}));case 8:return this.syncService.resetSyncState(),i.next=11,regeneratorRuntime.awrap(this.storageService.setPersistencePolicy(n?ai.Ephemeral:ai.Default));case 11:if(!a){i.next=16;break}return i.next=14,regeneratorRuntime.awrap(this.syncService.markAllItemsAsNeedingSync({alternateUuids:!0}));case 14:i.next=19;break;case 16:return this.modelManager.removeAllItemsFromMemory(),i.next=19,regeneratorRuntime.awrap(this.clearDatabase());case 19:return i.next=21,regeneratorRuntime.awrap(this.notifyEvent(d.SignedIn));case 21:return this.unlockSyncing(),i.next=24,regeneratorRuntime.awrap(this.syncService.sync({mode:Xs.DownloadFirst,timingStrategy:2}));case 24:this.protocolService.decryptErroredItems(),i.next=28;break;case 27:this.unlockSyncing();case 28:return i.abrupt("return",o.response);case 29:case"end":return i.stop()}}),null,this)}},{key:"signIn",value:function(e){var t,r,n,a,o,i,s,u,c;return regeneratorRuntime.async((function(l){for(;;)switch(l.prev=l.next){case 0:return t=e.email,r=e.password,n=e.strict,a=e.ephemeral,o=e.mfaKeyPath,i=e.mfaCode,s=e.mergeLocal,u=void 0===s||s,this.lockSyncing(),l.next=4,regeneratorRuntime.awrap(this.sessionManager.signIn({email:t,password:r,strict:n,mfaKeyPath:o,mfaCode:i}));case 4:if((c=l.sent).response.error){l.next=27;break}return l.next=8,regeneratorRuntime.awrap(this.keyManager.setNewRootKey({key:c.rootKey,keyParams:c.keyParams}));case 8:return this.syncService.resetSyncState(),l.next=11,regeneratorRuntime.awrap(this.storageService.setPersistencePolicy(a?ai.Ephemeral:ai.Default));case 11:if(!u){l.next=16;break}return l.next=14,regeneratorRuntime.awrap(this.syncService.markAllItemsAsNeedingSync({alternateUuids:!0}));case 14:l.next=19;break;case 16:return this.modelManager.removeAllItemsFromMemory(),l.next=19,regeneratorRuntime.awrap(this.clearDatabase());case 19:return l.next=21,regeneratorRuntime.awrap(this.notifyEvent(d.SignedIn));case 21:return this.unlockSyncing(),l.next=24,regeneratorRuntime.awrap(this.syncService.sync({mode:Xs.DownloadFirst,checkIntegrity:!0,timingStrategy:2}));case 24:this.protocolService.decryptErroredItems(),l.next=28;break;case 27:this.unlockSyncing();case 28:return l.abrupt("return",c.response);case 29:case"end":return l.stop()}}),null,this)}},{key:"changePassword",value:function(e){var t,r,n,a,o,i,s,u;return regeneratorRuntime.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=e.email,r=e.currentPassword,n=e.newPassword,a=e.rotateItemsKey,c.next=3,regeneratorRuntime.awrap(this.keyManager.getRootKeyParams());case 3:return o=c.sent,this.lockSyncing(),c.next=7,regeneratorRuntime.awrap(this.sessionManager.changePassword({email:t,currentPassword:r,currentKeyParams:o,newPassword:n}));case 7:if((i=c.sent).response.error){c.next=21;break}return c.next=11,regeneratorRuntime.awrap(this.keyManager.setNewRootKey({key:i.rootKey,keyParams:i.keyParams}));case 11:if(s=i.keyParams,u=s.version!==o.version,!a&&!u){c.next=16;break}return c.next=16,regeneratorRuntime.awrap(this.itemsKeyManager.createNewDefaultItemsKey());case 16:return this.unlockSyncing(),c.next=19,regeneratorRuntime.awrap(this.syncService.sync());case 19:c.next=22;break;case 21:this.unlockSyncing();case 22:return c.abrupt("return",i.response);case 23:case"end":return c.stop()}}),null,this)}},{key:"signOut",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.sessionManager.signOut());case 2:return e.next=4,regeneratorRuntime.awrap(this.keyManager.clearLocalKeyState());case 4:return e.next=6,regeneratorRuntime.awrap(this.storageService.clearAllData());case 6:return e.next=8,regeneratorRuntime.awrap(this.notifyEvent(d.SignedOut));case 8:return e.next=10,regeneratorRuntime.awrap(this.restart());case 10:case"end":return e.stop()}}),null,this)}},{key:"validateAccountPassword",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=e.password,r.abrupt("return",this.keyManager.validateAccountPassword(t));case 2:case"end":return r.stop()}}),null,this)}},{key:"isStarted",value:function(){return this.started}},{key:"hasPasscode",value:function(){return this.keyManager.hasPasscode()}},{key:"isLocked",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.started){e.next=2;break}return e.abrupt("return",!0);case 2:return e.abrupt("return",this.deviceAuthService.isPasscodeLocked());case 3:case"end":return e.stop()}}),null,this)}},{key:"lock",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.restart());case 1:case"end":return e.stop()}}),null,this)}},{key:"setPasscode",value:function(e){var t,r,n,a;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,regeneratorRuntime.awrap(this.protocolService.crypto.generateUUID());case 2:return t=o.sent,o.next=5,regeneratorRuntime.awrap(this.protocolService.createRootKey({identifier:t,password:e}));case 5:return r=o.sent,n=r.key,a=r.keyParams,o.next=10,regeneratorRuntime.awrap(this.keyManager.setNewRootKeyWrapper({wrappingKey:n,keyParams:a}));case 10:return o.next=12,regeneratorRuntime.awrap(this.rewriteItemsKeys());case 12:return o.next=14,regeneratorRuntime.awrap(this.syncService.sync());case 14:case"end":return o.stop()}}),null,this)}},{key:"removePasscode",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.keyManager.removeRootKeyWrapper());case 2:return e.next=4,regeneratorRuntime.awrap(this.rewriteItemsKeys());case 4:case"end":return e.stop()}}),null,this)}},{key:"changePasscode",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.removePasscode());case 2:return t.abrupt("return",this.setPasscode(e));case 3:case"end":return t.stop()}}),null,this)}},{key:"setStorageEncryptionPolicy",value:function(e){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this.storageService.setEncryptionPolicy(e));case 2:return t.abrupt("return",this.syncService.repersistAllItems());case 3:case"end":return t.stop()}}),null,this)}},{key:"generateUuid",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.crypto.generateUUID());case 1:case"end":return e.stop()}}),null,this)}},{key:"changeDeviceInterface",value:function(e){var t,r,n,a,o,i;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:for(this.deviceInterface=e,t=!0,r=!1,n=void 0,s.prev=4,a=this.services[Symbol.iterator]();!(t=(o=a.next()).done);t=!0)(i=o.value).deviceInterface&&(i.deviceInterface=e);s.next=12;break;case 8:s.prev=8,s.t0=s.catch(4),r=!0,n=s.t0;case 12:s.prev=12,s.prev=13,t||null==a.return||a.return();case 15:if(s.prev=15,!r){s.next=18;break}throw n;case 18:return s.finish(15);case 19:return s.finish(12);case 20:case"end":return s.stop()}}),null,this,[[4,8,12,20],[13,,15,19]])}},{key:"constructServices",value:function(){this.createModelManager(),this.createProtocolService(this.modelManager),this.createMigrationService(),this.createAlertManager(),this.createHttpManager(),this.createStorageManager(),this.createApiService(),this.createSessionManager(),this.createSyncManager(),this.createItemsKeyManager(),this.createKeyManager(),this.protocolService.setKeyManager(this.keyManager),this.protocolService.setItemsKeyManager(this.itemsKeyManager),this.itemsKeyManager.setKeyManager(this.keyManager),this.createDeviceAuthService(),this.createSingletonManager(),this.createComponentManager(),this.createPrivilegesManager(),this.createHistoryManager(),this.createActionsManager()}},{key:"clearServices",value:function(){this.migrationService=null,this.alertService=null,this.httpService=null,this.modelManager=null,this.protocolService=null,this.storageService=null,this.apiService=null,this.sessionManager=null,this.syncService=null,this.keyManager=null,this.itemsKeyManager=null,this.deviceAuthService=null,this.singletonManager=null,this.componentManager=null,this.privilegesService=null,this.actionsManager=null,this.services=[]}},{key:"createMigrationService",value:function(){this.migrationService=new(this.getClass(ji))({application:this,challengeResponder:this.getMigrationChallengeResponder()}),this.services.push(this.migrationService)}},{key:"createAlertManager",value:function(){this.shouldSkipClass(Sa)||(this.alertService=new(this.getClass(Sa))({deviceInterface:this.deviceInterface}),this.services.push(this.alertService))}},{key:"createApiService",value:function(){this.apiService=new(this.getClass(Ya))({storageService:this.storageService,httpService:this.httpService,host:this.host}),this.services.push(this.apiService)}},{key:"createComponentManager",value:function(){this.shouldSkipClass(wo)||(this.componentManager=new(this.getClass(wo))({modelManager:this.modelManager,syncService:this.syncService,alertService:this.alertService,timeout:this.deviceInterface.timeout,environment:this.environment,platform:this.platform}),this.services.push(this.componentManager))}},{key:"createHttpManager",value:function(){this.httpService=new(this.getClass(Oo)),this.services.push(this.httpService)}},{key:"createKeyManager",value:function(){var e=this;this.keyManager=new(this.getClass(ms))({modelManager:this.modelManager,storageService:this.storageService,protocolService:this.protocolService,itemsKeyManager:this.itemsKeyManager,deviceInterface:this.deviceInterface}),this.keyManager.onStatusChange((function(){return regeneratorRuntime.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(e.notifyEvent(d.KeyStatusChanged));case 2:case"end":return t.stop()}}))})),this.services.push(this.keyManager)}},{key:"createItemsKeyManager",value:function(){this.itemsKeyManager=new(this.getClass(Rs))({modelManager:this.modelManager,syncService:this.syncService,protocolService:this.protocolService}),this.services.push(this.itemsKeyManager)}},{key:"createModelManager",value:function(){this.modelManager=new(this.getClass(Ko)),this.services.push(this.modelManager)}},{key:"createSingletonManager",value:function(){this.singletonManager=new(this.getClass(Vo))({modelManager:this.modelManager,syncService:this.syncService}),this.services.push(this.singletonManager)}},{key:"createStorageManager",value:function(){this.storageService=new(this.getClass(ui))({protocolService:this.protocolService,namespace:this.namespace,deviceInterface:this.deviceInterface}),this.services.push(this.storageService)}},{key:"createProtocolService",value:function(e){this.protocolService=new(this.getClass(Ki))({modelManager:e,crypto:this.crypto}),this.services.push(this.protocolService)}},{key:"createSessionManager",value:function(){this.sessionManager=new(this.getClass(Ca))({storageService:this.storageService,alertService:this.alertService,protocolService:this.protocolService,apiService:this.apiService,timeout:this.deviceInterface.timeout}),this.services.push(this.sessionManager)}},{key:"createSyncManager",value:function(){var e=this;this.syncService=new(this.getClass(eu))({modelManager:this.modelManager,storageService:this.storageService,sessionManager:this.sessionManager,protocolService:this.protocolService,apiService:this.apiService,interval:this.deviceInterface.interval});var t=this.syncService.addEventObserver((function(t){var r;return regeneratorRuntime.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(a=t,o=void 0,!(r=(o={},h(o,y.FullSyncCompleted,d.CompletedSync),h(o,y.SyncError,d.FailedSync),h(o,y.SyncTakingTooLong,d.HighLatencySync),h(o,y.EnterOutOfSync,d.EnteredOutOfSync),h(o,y.ExitOutOfSync,d.ExitedOutOfSync),o)[a])){n.next=4;break}return n.next=4,regeneratorRuntime.awrap(e.notifyEvent(r));case 4:case"end":return n.stop()}var a,o}))}));this.serviceObservers.push(t),this.services.push(this.syncService)}},{key:"createDeviceAuthService",value:function(){this.deviceAuthService=new(this.getClass(iu))({storageService:this.storageService,protocolService:this.protocolService,keyManager:this.keyManager}),this.services.push(this.deviceAuthService)}},{key:"createPrivilegesManager",value:function(){this.privilegesService=new(this.getClass(ls))({storageService:this.storageService,keyManager:this.keyManager,modelManager:this.modelManager,syncService:this.syncService,sessionManager:this.sessionManager,singletonManager:this.singletonManager}),this.services.push(this.privilegesService)}},{key:"createHistoryManager",value:function(){this.historyManager=new(this.getClass(rs))({storageService:this.storageService,modelManager:this.modelManager,contentTypes:[i.Note],timeout:this.deviceInterface.timeout}),this.services.push(this.historyManager)}},{key:"createActionsManager",value:function(){this.actionsManager=new(this.getClass(Jo))({alertService:this.alertService,deviceInterface:this.deviceInterface,httpService:this.httpService,modelManager:this.modelManager,protocolService:this.protocolService,syncService:this.syncService}),this.services.push(this.actionsManager)}},{key:"shouldSkipClass",value:function(e){return this.skipClasses&&this.skipClasses.includes(e)}},{key:"getClass",value:function(e){var t=this.swapClasses&&this.swapClasses.find((function(t){return t.swap===e}));return t?t.with:e}}])&&su(t.prototype,r),n&&su(t,n),e}();function cu(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var lu=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.namespace,n=t.timeout,o=t.interval;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!n||!o)throw"'timeout' and 'interval' are required to initialize device interface.";this.namespace=r,this.timeout=n||setTimeout.bind(Object(a.h)()),this.interval=o||setInterval.bind(Object(a.h)())}var t,r,n;return t=e,(r=[{key:"getRawStorageValue",value:function(e){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.getRawStorageValue";case 1:case"end":return e.stop()}}))}},{key:"getJsonParsedStorageValue",value:function(e){var t;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(this.getRawStorageValue(e));case 2:return t=r.sent,r.abrupt("return",t?JSON.parse(t):t);case 4:case"end":return r.stop()}}),null,this)}},{key:"getAllRawStorageKeyValues",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.getAllRawStorageKeyValues";case 1:case"end":return e.stop()}}))}},{key:"setRawStorageValue",value:function(e,t){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.setRawStorageValue";case 1:case"end":return e.stop()}}))}},{key:"removeRawStorageValue",value:function(e){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.removeRawStorageValue";case 1:case"end":return e.stop()}}))}},{key:"removeAllRawStorageValues",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.removeAllRawStorageValues";case 1:case"end":return e.stop()}}))}},{key:"openDatabase",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.openDatabase";case 1:case"end":return e.stop()}}))}},{key:"getAllRawDatabasePayloads",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.getAllRawDatabasePayloads";case 1:case"end":return e.stop()}}))}},{key:"saveRawDatabasePayload",value:function(e){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.saveRawDatabasePayload";case 1:case"end":return e.stop()}}))}},{key:"saveRawDatabasePayloads",value:function(e){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.saveRawDatabasePayloads";case 1:case"end":return e.stop()}}))}},{key:"removeRawDatabasePayloadWithId",value:function(e){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.removeRawDatabasePayloadWithId";case 1:case"end":return e.stop()}}))}},{key:"removeAllRawDatabasePayloads",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.removeAllRawDatabasePayloads";case 1:case"end":return e.stop()}}))}},{key:"getKeychainValue",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.getKeychainValue";case 1:case"end":return e.stop()}}))}},{key:"setKeychainValue",value:function(e){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.setKeychainValue";case 1:case"end":return e.stop()}}))}},{key:"clearKeychainValue",value:function(){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.clearKeychainValue";case 1:case"end":return e.stop()}}))}}])&&cu(t.prototype,r),n&&cu(t,n),e}();var pu=function e(t){var r=t.challenge,n=t.value;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.challenge=r,this.value=n,Object.freeze(this)};r.d(t,"SNApplication",(function(){return uu})),r.d(t,"SNProtocolService",(function(){return Ki})),r.d(t,"SNProtocolOperator001",(function(){return ye})),r.d(t,"SNProtocolOperator002",(function(){return xe})),r.d(t,"SNProtocolOperator003",(function(){return _e})),r.d(t,"SNProtocolOperator004",(function(){return Me})),r.d(t,"DeviceInterface",(function(){return lu})),r.d(t,"SNItem",(function(){return B})),r.d(t,"SNItemsKey",(function(){return Ve})),r.d(t,"SNPredicate",(function(){return f})),r.d(t,"SNNote",(function(){return Vt})),r.d(t,"SNTag",(function(){return Mt})),r.d(t,"SNSmartTag",(function(){return sr})),r.d(t,"SNActionsExtension",(function(){return jt})),r.d(t,"Action",(function(){return xt})),r.d(t,"SNTheme",(function(){return hr})),r.d(t,"SNEncryptedStorage",(function(){return kr})),r.d(t,"SNComponent",(function(){return tt})),r.d(t,"SNEditor",(function(){return vt})),r.d(t,"SNComponentManager",(function(){return wo})),r.d(t,"HistorySession",(function(){return Qi})),r.d(t,"ItemHistory",(function(){return Yi})),r.d(t,"ItemHistoryEntry",(function(){return Li})),r.d(t,"SNPrivileges",(function(){return tr})),r.d(t,"SNWebCrypto",(function(){return re.SNWebCrypto})),r.d(t,"SNReactNativeCrypto",(function(){return re.SNReactNativeCrypto})),r.d(t,"SNModelManager",(function(){return Ko})),r.d(t,"SNHttpService",(function(){return Oo})),r.d(t,"DeviceAuthService",(function(){return iu})),r.d(t,"ChallengeResponse",(function(){return pu})),r.d(t,"PureService",(function(){return ma})),r.d(t,"SNStorageService",(function(){return ui})),r.d(t,"StoragePersistencePolicies",(function(){return ai})),r.d(t,"StorageEncryptionPolicies",(function(){return oi})),r.d(t,"StorageValueModes",(function(){return ii})),r.d(t,"ValueModesKeys",(function(){return si})),r.d(t,"Challenges",(function(){return D})),r.d(t,"SNSyncService",(function(){return eu})),r.d(t,"SyncSources",(function(){return Zs})),r.d(t,"SyncModes",(function(){return Xs})),r.d(t,"TIMING_STRATEGY_RESOLVE_ON_NEXT",(function(){return 1})),r.d(t,"TIMING_STRATEGY_FORCE_SPAWN_NEW",(function(){return 2})),r.d(t,"SNSessionManager",(function(){return Ca})),r.d(t,"SNMigrationService",(function(){return ji})),r.d(t,"SNAlertService",(function(){return Sa})),r.d(t,"SNHistoryManager",(function(){return rs})),r.d(t,"SNPrivilegesService",(function(){return ls})),r.d(t,"SNSingletonManager",(function(){return Vo})),r.d(t,"SNKeyManager",(function(){return ms})),r.d(t,"KEY_MODE_ROOT_KEY_NONE",(function(){return vs})),r.d(t,"KEY_MODE_ROOT_KEY_ONLY",(function(){return 1})),r.d(t,"KEY_MODE_ROOT_KEY_PLUS_WRAPPER",(function(){return 2})),r.d(t,"KEY_MODE_WRAPPER_ONLY",(function(){return 3})),r.d(t,"SNApiService",(function(){return Ya})),r.d(t,"findInArray",(function(){return a.g})),r.d(t,"isNullOrUndefined",(function(){return a.l})),r.d(t,"deepMerge",(function(){return a.e})),r.d(t,"extendArray",(function(){return a.f})),r.d(t,"removeFromIndex",(function(){return a.v})),r.d(t,"subtractFromArray",(function(){return a.x})),r.d(t,"arrayByDifference",(function(){return a.b})),r.d(t,"uniqCombineObjArrays",(function(){return a.z})),r.d(t,"greaterOfTwoDates",(function(){return a.i})),r.d(t,"getGlobalScope",(function(){return a.h})),r.d(t,"truncateHexString",(function(){return a.y})),r.d(t,"Uuid",(function(){return F})),r.d(t,"EncryptionIntents",(function(){return W})),r.d(t,"isLocalStorageIntent",(function(){return z})),r.d(t,"isFileIntent",(function(){return q})),r.d(t,"isDecryptedIntent",(function(){return Y})),r.d(t,"intentRequiresEncryption",(function(){return J})),r.d(t,"ContentTypes",(function(){return i})),r.d(t,"ApplicationEvents",(function(){return d})),r.d(t,"Environments",(function(){return P})),r.d(t,"Platforms",(function(){return O})),r.d(t,"isEnvironmentWebOrDesktop",(function(){return j})),r.d(t,"isEnvironmentMobile",(function(){return I})),r.d(t,"platformFromString",(function(){return _})),r.d(t,"SyncEvents",(function(){return y})),r.d(t,"SNPureItemPayload",(function(){return Lr})),r.d(t,"SNStorageItemPayload",(function(){return Wr})),r.d(t,"PayloadCollection",(function(){return u})),r.d(t,"CreateMaxPayloadFromAnyObject",(function(){return ua})),r.d(t,"CreateSourcedPayloadFromObject",(function(){return la})),r.d(t,"PayloadSources",(function(){return Ir})),r.d(t,"isPayloadSourceRetrieved",(function(){return Dr})),r.d(t,"ProtocolVersions",(function(){return V})),r.d(t,"PayloadFormats",(function(){return te})),r.d(t,"StorageKeys",(function(){return C})),r.d(t,"BaseMigration",(function(){return xi})),r.d(t,"ProtectedActions",(function(){return us})),r.d(t,"PrivilegeCredentials",(function(){return cs})),r.d(t,"PRIVILEGE_SESSION_LENGTH_NONE",(function(){return 0})),r.d(t,"PRIVILEGE_SESSION_LENGTH_FIVE_MINUTES",(function(){return 300})),r.d(t,"PRIVILEGE_SESSION_LENGTH_ONE_HOUR",(function(){return 3600})),r.d(t,"PRIVILEGE_SESSION_LENGTH_ONE_WEEK",(function(){return 604800}))}])}));
//# sourceMappingURL=snjs.js.map