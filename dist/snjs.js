!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("SNLibrary",[],t):"object"==typeof exports?exports.SNLibrary=t():e.SNLibrary=t()}(window,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/dist/",n(n.s=215)}([function(e,t,n){e.exports=n(103)},function(e,t,n){"use strict";(function(e){n.d(t,"j",(function(){return m})),n.d(t,"p",(function(){return g})),n.d(t,"i",(function(){return w})),n.d(t,"z",(function(){return k})),n.d(t,"e",(function(){return x})),n.d(t,"n",(function(){return S})),n.d(t,"l",(function(){return O})),n.d(t,"m",(function(){return P})),n.d(t,"o",(function(){return j})),n.d(t,"k",(function(){return _})),n.d(t,"E",(function(){return C})),n.d(t,"F",(function(){return D})),n.d(t,"s",(function(){return E})),n.d(t,"h",(function(){return I})),n.d(t,"C",(function(){return R})),n.d(t,"x",(function(){return A})),n.d(t,"b",(function(){return M})),n.d(t,"c",(function(){return T})),n.d(t,"y",(function(){return K})),n.d(t,"d",(function(){return L})),n.d(t,"t",(function(){return F})),n.d(t,"B",(function(){return V})),n.d(t,"r",(function(){return N})),n.d(t,"v",(function(){return U})),n.d(t,"u",(function(){return B})),n.d(t,"q",(function(){return W})),n.d(t,"a",(function(){return H})),n.d(t,"g",(function(){return z})),n.d(t,"w",(function(){return q})),n.d(t,"f",(function(){return Y})),n.d(t,"D",(function(){return J})),n.d(t,"A",(function(){return G}));var r=n(0),a=n.n(r),o=(n(29),n(26)),i=n.n(o),s=n(23),c=n.n(s),u=n(100),l=n.n(u),f=n(101),p=n.n(f),h=n(32),y=n.n(h);function d(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function v(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){d(o,r,a,i,s,"next",e)}function s(e){d(o,r,a,i,s,"throw",e)}i(void 0)}))}}function b(e){return(b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function m(){return"undefined"!=typeof window?window:void 0!==e?e:null}function g(){return null!==m()}function w(e,t,n){return e.find((function(e){return e[t]===n}))}function k(e,t){return i()(e,t)}function x(){for(var e=[],t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var a=0,o=n;a<o.length;a++){var i=o[a];e=e.concat(i)}return e}function S(e){return null!==e&&("function"==typeof e||"object"===b(e))}function O(e){return null!==e&&"function"==typeof e}function P(e){return null==e}function j(e){return"string"==typeof e||e instanceof String}function _(e,t){return e>t?e:t}function C(e,t,n){return p()(e.concat(t),(function(e,t){var r=!0,a=!1,o=void 0;try{for(var i,s=n[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var c=i.value;if(e[c]!==t[c])return!1}}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return!0}))}function D(e){return y()(e)}function E(e){return e[e.length-1]}function I(e,t){var n=!0,r=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value;e.push(s)}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}}function R(e,t){var n=!0,r=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value;e.splice(e.indexOf(s),1)}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}}function A(e,t){e.splice(e.indexOf(t),1)}function M(e,t){(function(e,t){return e.indexOf(t)>=0})(e,t)||e.push(t)}function T(e,t){return e.filter((function(e){return!t.includes(e)})).concat(t.filter((function(t){return!e.includes(t)})))}function K(e,t){e.splice(t,1)}function L(e,t){var n=e.slice();return K(n,t),n}function F(e){for(var t=[],n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];t.push(e[a])}return t}function V(e){var t=Object.keys(e).sort(),n={},r=!0,a=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var c=i.value;n[c]=e[c]}}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return H(n)}function N(e){for(var t={},n=0,r=Object.keys(e);n<r.length;n++){var a=r[n],o=void 0;try{o=JSON.parse(e[a])}catch(t){o=e[a]}t[a]=o}return t}function U(e,t){if(e){var n=!0,r=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){delete e[o.value]}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}}}function B(e,t){var n=Object.assign({},e),r=!0,a=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){delete n[i.value]}}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}function W(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.map((function(e,t){return 0===t?e.trim().replace(/[\/]*$/g,""):e.trim().replace(/(^[\/]*|[\/]*$)/g,"")})).filter((function(e){return e.length})).join("/")}function H(e){return JSON.parse(JSON.stringify(e))}function z(e,t){if(!e||!t)throw"Attempting to deepMerge with null values";return l()(e,t,(function(e,t){if(c()(e))return t})),e}function q(e,t){var n={},r=!0,a=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var c=i.value;n[c]=e[c]}}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return H(n)}function Y(e){var t=Object.getOwnPropertyNames(e),n=!0,r=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value,c=e[s];c&&"object"===b(c)&&!Object.isFrozen(c)?e[s]=Y(c):e[s]=c}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}return Object.freeze(e)}function J(e,t){var n=t/4;return e.substring(0,n)}function G(e){return Q.apply(this,arguments)}function Q(){return(Q=v(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.warn("Sleeping for",t),e.abrupt("return",new Promise((function(e,n){setTimeout((function(){e()}),t)})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}).call(this,n(41))},function(e,t,n){"use strict";n.d(t,"e",(function(){return v})),n.d(t,"d",(function(){return b})),n.d(t,"f",(function(){return m})),n.d(t,"b",(function(){return g})),n.d(t,"c",(function(){return k})),n.d(t,"a",(function(){return x}));var r=n(3),a=n(5),o=n(15),i=n(1),s=n(4),c=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash,s.a.Legacy003AuthParams,s.a.Dirty,s.a.DirtiedDate,s.a.ErrorDecrypting,s.a.ErrorDecryptingChanged,s.a.WaitingForKey,s.a.Dummy,s.a.LastSyncBegan,s.a.LastSyncEnd],u=[s.a.Uuid,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.Legacy003AuthHash,s.a.ErrorDecrypting,s.a.ErrorDecryptingChanged,s.a.WaitingForKey],l=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Legacy003AuthHash],f=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash,s.a.Legacy003AuthParams,s.a.Dirty,s.a.DirtiedDate,s.a.ErrorDecrypting,s.a.WaitingForKey],p=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash],h=[s.a.Uuid,s.a.ContentType,s.a.Content,s.a.UpdatedAt],y=[s.a.Uuid,s.a.Content,s.a.CreatedAt],d=[s.a.Uuid,s.a.ContentType,s.a.UpdatedAt,s.a.Deleted,s.a.Dirty,s.a.LastSyncEnd];function v(e,t,n,r){if(!Object(i.m)(t))throw"Use CreateSourcedPayloadFromObject if creating payload with source.";if(!Object(i.m)(n))throw"Use CreateIntentPayloadFromObject if creating payload with intent.";return w(e,c.slice(),t,r)}function b(e,t,n){return w(e,function(e){if(e===o.a.FileEncrypted||e===o.a.FileDecrypted||e===o.a.FilePreferEncrypted)return l.slice();if(e===o.a.LocalStoragePreferEncrypted||e===o.a.LocalStorageDecrypted||e===o.a.LocalStorageEncrypted)return f.slice();if(e===o.a.Sync||e===o.a.SyncDecrypted)return p.slice();throw"No payload fields found for intent ".concat(e)}(t),r.a.Constructor,n)}function m(e,t,n){return w(e,function(e){if(e===r.a.FileImport)return l.slice();if(e===r.a.SessionHistory)return h.slice();if(e===r.a.ComponentRetrieved)return y.slice();if(e===r.a.LocalRetrieved||e===r.a.LocalChanged)return f.slice();if(e===r.a.RemoteRetrieved||e===r.a.ConflictData||e===r.a.ConflictUuid)return p.slice();if(e===r.a.LocalSaved||e===r.a.RemoteSaved)return d.slice();throw"No payload fields found for source ".concat(e)}(t),t,n)}function g(e,t){return w(e,e.fields,e.source,t)}function w(e,t,n,o){var s=Object(i.w)(e,t),c=o instanceof a.l?o.fields.slice():Object.keys(o||[]),u=!0,l=!1,f=void 0;try{for(var p,h=c[Symbol.iterator]();!(u=(p=h.next()).done);u=!0){var y=p.value,d=o[y];s[y]=d?Object(i.a)(d):d}}catch(e){l=!0,f=e}finally{try{u||null==h.return||h.return()}finally{if(l)throw f}}var v=Object(i.F)(t.concat(c));return new a.l(s,v,n||r.a.Constructor)}function k(e){return w(e,Object.keys(e))}function x(e,t){return w(e,u.slice(),void 0,t)}},function(e,t,n){"use strict";var r;function a(e){return[r.RemoteRetrieved,r.ComponentRetrieved,r.RemoteActionRetrieved].includes(e)}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),function(e){e[e.RemoteRetrieved=1]="RemoteRetrieved",e[e.RemoteSaved=2]="RemoteSaved",e[e.LocalSaved=3]="LocalSaved",e[e.LocalRetrieved=4]="LocalRetrieved",e[e.LocalChanged=5]="LocalChanged",e[e.ComponentRetrieved=6]="ComponentRetrieved",e[e.DesktopInstalled=7]="DesktopInstalled",e[e.RemoteActionRetrieved=8]="RemoteActionRetrieved",e[e.FileImport=9]="FileImport",e[e.RemoteConflict=10]="RemoteConflict",e[e.ImportConflict=11]="ImportConflict",e[e.SavedOrSaving=12]="SavedOrSaving",e[e.DecryptedTransient=13]="DecryptedTransient",e[e.ConflictUuid=14]="ConflictUuid",e[e.ConflictData=15]="ConflictData",e[e.SessionHistory=16]="SessionHistory",e[e.Constructor=17]="Constructor"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.Uuid="uuid",e.ContentType="content_type",e.ItemsKeyId="items_key_id",e.EncItemKey="enc_item_key",e.Content="content",e.CreatedAt="created_at",e.UpdatedAt="updated_at",e.Deleted="deleted",e.Legacy003AuthHash="auth_hash",e.Legacy003AuthParams="auth_params",e.Dirty="dirty",e.DirtiedDate="dirtiedDate",e.WaitingForKey="waitingForKey",e.ErrorDecrypting="errorDecrypting",e.ErrorDecryptingChanged="errorDecryptingValueChanged",e.Dummy="dummy",e.LastSyncBegan="lastSyncBegan",e.LastSyncEnd="lastSyncEnd"}(r||(r={}))},function(e,t,n){"use strict";var r=n(12);n.d(t,"h",(function(){return r.a}));n(50);var a=n(2);n.d(t,"e",(function(){return a.e})),n.d(t,"c",(function(){return a.c})),n.d(t,"b",(function(){return a.b})),n.d(t,"f",(function(){return a.f})),n.d(t,"d",(function(){return a.d}));n(21);var o=n(4);n.d(t,"i",(function(){return o.a}));var i=n(3);n.d(t,"k",(function(){return i.a}));var s=n(49);n.d(t,"l",(function(){return s.a}));var c=n(11);n.d(t,"j",(function(){return c.a}));var u=n(20);n.d(t,"a",(function(){return u.a})),n.d(t,"g",(function(){return u.b}))},function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a;function o(e){var t;return(r(t={},a.Note,"note"),r(t,a.Tag,"tag"),r(t,a.SmartTag,"smart tag"),r(t,a.ActionsExtension,"action-based extension"),r(t,a.Component,"component"),r(t,a.Editor,"editor"),r(t,a.Theme,"theme"),r(t,a.ServerExtension,"server extension"),r(t,a.Mfa,"two-factor authentication setting"),r(t,a.FilesafeCredentials,"FileSafe credential"),r(t,a.FilesafeFileMetadata,"FileSafe file"),r(t,a.FilesafeIntegration,"FileSafe integration"),t)[e]}n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return o})),function(e){e.Any="*",e.Item="SF|Item",e.RootKey="SN|RootKey|NoSync",e.ItemsKey="SN|ItemsKey",e.EncryptedStorage="SN|EncryptedStorage",e.Note="Note",e.Tag="Tag",e.SmartTag="SN|SmartTag",e.Component="SN|Component",e.Editor="SN|Editor",e.ActionsExtension="Extension",e.UserPrefs="SN|UserPreferences",e.Privileges="SN|Privileges",e.HistorySession="SN|HistorySession",e.Theme="SN|Theme",e.Mfa="SF|MFA",e.ServerExtension="SF|Extension",e.FilesafeCredentials="SN|FileSafe|Credentials",e.FilesafeFileMetadata="SN|FileSafe|FileMetadata",e.FilesafeIntegration="SN|FileSafe|Integration",e.ExtensionRepo="SN|ExtensionRepo"}(a||(a={}))},function(e,t,n){"use strict";(function(e){n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"e",(function(){return o})),n.d(t,"d",(function(){return d})),n.d(t,"b",(function(){return v}));var r,a,o,i=n(2),s=n(1),c=n(19),u=n(54),l=n(5);function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function h(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),e}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.UserInteraction=1]="UserInteraction",e[e.Internal=2]="Internal",e[e.NonDirtying=3]="NonDirtying"}(r||(r={})),function(e){e.Pinned="pinned",e.Archived="archived",e.Locked="locked",e.UserModifiedDate="client_updated_at",e.DefaultEditor="defaultEditor",e.MobileRules="mobileRules",e.NotAvailableOnMobile="notAvailableOnMobile",e.MobileActive="mobileActive",e.LastSize="lastSize",e.PrefersPlainEditor="prefersPlainEditor"}(a||(a={})),function(e){e[e.KeepEarliest=1]="KeepEarliest"}(o||(o={}));var d=function(){function t(n){var r=this;if(f(this,t),y(this,"payload",void 0),!n.uuid||!n.content_type)throw Error("Cannot create item without both uuid and content_type");if(n.format===l.j.DecryptedBareObject&&(n.enc_item_key||n.items_key_id||n.auth_hash))throw Error("Creating an item from a decrypted payload should not contain enc params");this.payload=n,e((function(){Object(s.f)(r)}))}return h(t,[{key:"payloadRepresentation",value:function(e){return Object(i.b)(this.payload,e)}},{key:"hasRelationshipWithItem",value:function(e){var t;return!!(null===(t=this.payload.safeContent.references)||void 0===t?void 0:t.find((function(t){return t.uuid===e.uuid})))}},{key:"getDomainData",value:function(e){var t=this.payload.safeContent.appData;if(t)return t[e]}},{key:"getAppDomainValue",value:function(e){return this.getDomainData(t.DefaultAppDomain())[e]}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["conflict_of"]}},{key:"appDataContentKeysToIgnoreWhenCheckingEquality",value:function(){return[a.UserModifiedDate]}},{key:"getContentCopy",value:function(){return JSON.parse(JSON.stringify(this.content))}},{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?l.a.KeepLeftDuplicateRight:this.isSingleton?l.a.KeepLeft:this.deleted||e.deleted?l.a.KeepRight:Object(u.a)(this,e)?Object(u.a)(this,e,["references"])?l.a.KeepLeftDuplicateRight:l.a.KeepLeftMergeRefs:l.a.KeepRight}},{key:"isItemContentEqualWith",value:function(e){return Object(u.b)(this.payload.contentObject,e.payload.contentObject,this.contentKeysToIgnoreWhenCheckingEquality(),this.appDataContentKeysToIgnoreWhenCheckingEquality())}},{key:"satisfiesPredicate",value:function(e){return c.a.ItemSatisfiesPredicate(this,e)}},{key:"createdAtString",value:function(){if(this.created_at)return this.dateToLocalizedString(this.created_at)}},{key:"updatedAtString",value:function(){return this.dateToLocalizedString(this.userModifiedDate)}},{key:"updatedAtTimestamp",value:function(){var e;return null===(e=this.updated_at)||void 0===e?void 0:e.getTime()}},{key:"dateToLocalizedString",value:function(e){if("undefined"!=typeof Intl&&Intl.DateTimeFormat){if(!t.sharedDateFormatter){var n=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language;t.sharedDateFormatter=new Intl.DateTimeFormat(n,{year:"numeric",month:"short",day:"2-digit",weekday:"long",hour:"2-digit",minute:"2-digit"})}return t.sharedDateFormatter.format(e)}return e.toDateString()+" "+e.toLocaleTimeString()}},{key:"uuid",get:function(){return this.payload.uuid}},{key:"content",get:function(){return this.payload.content}},{key:"safeContent",get:function(){return this.payload.safeContent}},{key:"references",get:function(){return this.payload.safeContent.references||[]}},{key:"deleted",get:function(){return this.payload.deleted}},{key:"content_type",get:function(){return this.payload.content_type}},{key:"created_at",get:function(){return this.payload.created_at}},{key:"updated_at",get:function(){return this.payload.updated_at}},{key:"userModifiedDate",get:function(){var e=this.getAppDomainValue(a.UserModifiedDate);return new Date(e||this.updated_at)}},{key:"dirtiedDate",get:function(){return this.payload.dirtiedDate}},{key:"dirty",get:function(){return this.payload.dirty}},{key:"dummy",get:function(){return this.payload.dummy}},{key:"errorDecrypting",get:function(){return this.payload.errorDecrypting}},{key:"waitingForKey",get:function(){return this.payload.waitingForKey}},{key:"errorDecryptingValueChanged",get:function(){return this.payload.errorDecryptingValueChanged}},{key:"lastSyncBegan",get:function(){return this.payload.lastSyncBegan}},{key:"lastSyncEnd",get:function(){return this.payload.lastSyncEnd}},{key:"auth_hash",get:function(){return this.payload.auth_hash}},{key:"auth_params",get:function(){return this.payload.auth_params}},{key:"protected",get:function(){return this.payload.safeContent.protected}},{key:"trashed",get:function(){return this.payload.safeContent.trashed}},{key:"pinned",get:function(){return this.getAppDomainValue(a.Pinned)}},{key:"archived",get:function(){return this.getAppDomainValue(a.Archived)}},{key:"locked",get:function(){return this.getAppDomainValue(a.Locked)}},{key:"neverSynced",get:function(){return!this.updated_at||0===this.updated_at.getTime()}},{key:"isSingleton",get:function(){return!1}},{key:"singletonPredicate",get:function(){throw"Must override SNItem.singletonPredicate"}},{key:"singletonStrategy",get:function(){return o.KeepEarliest}}],[{key:"DefaultAppDomain",value:function(){return"org.standardnotes.sn"}}]),t}();y(d,"sharedDateFormatter",void 0);var v=function(){function e(t,n){f(this,e),y(this,"item",void 0),y(this,"type",void 0),y(this,"payload",void 0),y(this,"content",void 0),this.item=t,this.type=n,this.payload=t.payload,this.payload.content&&(this.content=Object(s.a)(this.payload.content))}return h(e,[{key:"getUuid",value:function(){return this.payload.uuid}},{key:"getItem",value:function(){return this.item}},{key:"getResult",value:function(){return this.type===r.NonDirtying?Object(i.b)(this.payload,{content:this.content}):(this.payload.deleted||(this.type===r.UserInteraction?this.userModifiedDate=new Date:this.item.userModifiedDate||(this.userModifiedDate=new Date(this.item.updated_at))),Object(i.b)(this.payload,{content:this.content,dirty:!0,dirtiedDate:new Date}))}},{key:"mergePayload",value:function(e){this.payload=this.payload.mergedWith(e)}},{key:"setDeleted",value:function(){this.content=void 0,this.payload=Object(i.b)(this.payload,{content:this.content,deleted:!0})}},{key:"setDomainData",value:function(e,t){this.payload.errorDecrypting||(this.content.appData||(this.content.appData={}),this.content.appData[t]=e)}},{key:"setDomainDataKey",value:function(e,t,n){if(!this.payload.errorDecrypting){this.content.appData||(this.content.appData={});var r=this.content.appData;r[n]||(r[n]={}),r[n][e]=t}}},{key:"setAppDataItem",value:function(e,t){this.setDomainDataKey(e,t,d.DefaultAppDomain())}},{key:"addItemAsRelationship",value:function(e){var t=this.content.references||[];t.find((function(t){return t.uuid===e.uuid}))||t.push({uuid:e.uuid,content_type:e.content_type}),this.content.references=t}},{key:"removeItemAsRelationship",value:function(e){var t=this.content.references||[];t=t.filter((function(t){return t.uuid!==e.uuid})),this.content.references=t}},{key:"lastSyncBegan",set:function(e){this.payload=Object(i.b)(this.payload,{content:this.content,lastSyncBegan:e})}},{key:"errorDecrypting",set:function(e){this.payload=Object(i.b)(this.payload,{content:this.content,errorDecrypting:e})}},{key:"updated_at",set:function(e){this.payload=Object(i.b)(this.payload,{updated_at:e})}},{key:"userModifiedDate",set:function(e){this.setAppDataItem(a.UserModifiedDate,e)}},{key:"protected",set:function(e){this.content.protected=e}},{key:"trashed",set:function(e){this.content.trashed=e}},{key:"pinned",set:function(e){this.setAppDataItem(a.Pinned,e)}},{key:"archived",set:function(e){this.setAppDataItem(a.Archived,e)}},{key:"locked",set:function(e){this.setAppDataItem(a.Locked,e)}}]),e}()}).call(this,n(98).setImmediate)},function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"c",(function(){return l})),n.d(t,"b",(function(){return f}));var r,a=n(7),o=n(9),i=n(6);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=(s(r={},i.a.Note,o.k),s(r,i.a.Tag,o.o),s(r,i.a.ItemsKey,o.j),s(r,i.a.SmartTag,o.n),s(r,i.a.ActionsExtension,o.f),s(r,i.a.Editor,o.h),s(r,i.a.Theme,o.p),s(r,i.a.Component,o.g),s(r,i.a.Privileges,o.m),s(r,i.a.UserPrefs,o.q),r);function u(e){return new(c[e.content_type]||o.i)(e)}function l(e){return e.map((function(e){return e.uuid}))}function f(e){return e.references||(e.references=[]),e.appData||(e.appData={}),e.appData[a.d.DefaultAppDomain()]||(e.appData[a.d.DefaultAppDomain()]={}),e}},function(e,t,n){"use strict";n.d(t,"i",(function(){return r.d})),n.d(t,"d",(function(){return r.b})),n.d(t,"r",(function(){return r.e})),n.d(t,"j",(function(){return a.b})),n.d(t,"l",(function(){return o.a})),n.d(t,"g",(function(){return i.c})),n.d(t,"h",(function(){return p})),n.d(t,"f",(function(){return h.b})),n.d(t,"a",(function(){return y.a})),n.d(t,"k",(function(){return d.b})),n.d(t,"e",(function(){return d.a})),n.d(t,"o",(function(){return v.a})),n.d(t,"q",(function(){return S})),n.d(t,"m",(function(){return O.d})),n.d(t,"n",(function(){return P.a})),n.d(t,"p",(function(){return F})),n.d(t,"b",(function(){return V.a})),n.d(t,"s",(function(){return V.b})),n.d(t,"c",(function(){return N.a}));var r=n(7),a=n(24),o=n(19),i=n(16);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?u(e):t}(this,c(t).call(this,e)),f(u(n),"notes",[]),f(u(n),"data",{}),f(u(n),"url",void 0),f(u(n),"name",void 0),f(u(n),"isDefault",void 0),f(u(n),"systemEditor",void 0),n.url=e.safeContent.url,n.name=e.safeContent.name,n.data=e.safeContent.data||{},n.isDefault=e.safeContent.default,n.systemEditor=e.safeContent.systemEditor,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,e),t}(r.d),h=n(40),y=n(51),d=n(34),v=n(35);function b(e){return(b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function w(e,t){return!t||"object"!==b(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function k(e){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function x(e,t){return(x=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var S=function(e){function t(){return m(this,t),w(this,k(t).apply(this,arguments))}var n,r,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&x(e,t)}(t,e),n=t,(r=[{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new o.a("content_type","=",this.content_type)}}])&&g(n.prototype,r),a&&g(n,a),t}(r.d),O=n(18),P=n(52),j=n(20);function _(e){return(_="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function C(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function D(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function E(e,t,n){return t&&D(e.prototype,t),n&&D(e,n),e}function I(e,t){return!t||"object"!==_(t)&&"function"!=typeof t?R(e):t}function R(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function A(e,t,n){return(A="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=M(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function M(e){return(M=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function T(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&K(e,t)}function K(e,t){return(K=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function L(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var F=function(e){function t(){var e,n;C(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return L(R(n=I(this,(e=M(t)).call.apply(e,[this].concat(a)))),"area",i.a.Themes),n}return T(t,e),E(t,[{key:"isLayerable",value:function(){return this.package_info&&this.package_info.layerable}},{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?A(M(t.prototype),"strategyWhenConflictingWithItem",this).call(this,e):j.a.KeepLeft}},{key:"getMobileRules",value:function(){return this.getAppDomainValue(r.a.MobileRules)||{constants:{},rules:{}}}},{key:"hasMobileRules",value:function(){return this.getAppDomainValue(r.a.MobileRules)}},{key:"getNotAvailOnMobile",value:function(){return this.getAppDomainValue(r.a.NotAvailableOnMobile)}},{key:"isMobileActive",value:function(){return this.getAppDomainValue(r.a.MobileActive)}}]),t}(i.c),V=(r.b,n(6)),N=n(8)},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var r=n(0),a=n.n(r),o=n(1);function i(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function s(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){s(o,r,a,i,c,"next",e)}function c(e){s(o,r,a,i,c,"throw",e)}i(void 0)}))}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"eventObservers",[]),l(this,"loggingEnabled",!1),l(this,"deviceInterface",void 0)}var t,n,r,s,f;return t=e,(n=[{key:"addEventObserver",value:function(e){var t=this;return this.eventObservers.push(e),function(){Object(o.x)(t.eventObservers,e)}}},{key:"notifyEvent",value:(f=c(a.a.mark((function e(t,n){var r,o,i,s,c,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,o=!1,i=void 0,e.prev=3,s=this.eventObservers[Symbol.iterator]();case 5:if(r=(c=s.next()).done){e.next=12;break}return u=c.value,e.next=9,u(t,n||{});case 9:r=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),o=!0,i=e.t0;case 18:e.prev=18,e.prev=19,r||null==s.return||s.return();case 21:if(e.prev=21,!o){e.next=24;break}throw i;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e,t){return f.apply(this,arguments)})},{key:"deinit",value:function(){this.eventObservers.length=0,this.deviceInterface=void 0}},{key:"handleApplicationStage",value:(s=c(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(e){return s.apply(this,arguments)})},{key:"log",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(this.loggingEnabled){var a,o=new Date,s=o.toLocaleTimeString().replace(" PM","").replace(" AM",""),c="".concat(s,".").concat(o.getMilliseconds());n?(n=n.map((function(e){return Array.isArray(e)?e.slice():e})),(a=console).log.apply(a,[c,e].concat(i(n)))):console.log(c,e)}}}])&&u(t.prototype,n),r&&u(t,r),e}()},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e[e.EncryptedString=0]="EncryptedString",e[e.DecryptedBareObject=1]="DecryptedBareObject",e[e.DecryptedBase64String=2]="DecryptedBase64String",e[e.Deleted=3]="Deleted"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return g})),n.d(t,"a",(function(){return w}));var r=n(1);function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"directMap",{}),o(this,"inverseMap",{})}var t,n,i;return t=e,(n=[{key:"makeCopy",value:function(){var t=new e;return t.directMap=Object.assign({},this.directMap),t.inverseMap=Object.assign({},this.inverseMap),t}},{key:"getDirectRelationships",value:function(e){return this.directMap[e]||[]}},{key:"getInverseRelationships",value:function(e){return this.inverseMap[e]||[]}},{key:"establishRelationship",value:function(e,t){this.establishDirectRelationship(e,t),this.establishInverseRelationship(e,t)}},{key:"deestablishRelationship",value:function(e,t){this.deestablishDirectRelationship(e,t),this.deestablishInverseRelationship(e,t)}},{key:"setAllRelationships",value:function(e,t){var n=this.directMap[e]||[];this.directMap[e]=t;var r=!0,a=!1,o=void 0;try{for(var i,s=n[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var c=i.value;this.deestablishInverseRelationship(e,c)}}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}var u=!0,l=!1,f=void 0;try{for(var p,h=t[Symbol.iterator]();!(u=(p=h.next()).done);u=!0){var y=p.value;this.establishInverseRelationship(e,y)}}catch(e){l=!0,f=e}finally{try{u||null==h.return||h.return()}finally{if(l)throw f}}}},{key:"removeFromMap",value:function(e){var t=this.directMap[e]||[],n=!0,a=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var c=i.value;Object(r.x)(this.inverseMap[c]||[],e)}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}delete this.directMap[e];var u=this.inverseMap[e]||[],l=!0,f=!1,p=void 0;try{for(var h,y=u[Symbol.iterator]();!(l=(h=y.next()).done);l=!0){var d=h.value;Object(r.x)(this.directMap[d]||[],e)}}catch(e){f=!0,p=e}finally{try{l||null==y.return||y.return()}finally{if(f)throw p}}delete this.inverseMap[e]}},{key:"establishDirectRelationship",value:function(e,t){var n=this.directMap[e]||[];Object(r.b)(n,t),this.directMap[e]=n}},{key:"establishInverseRelationship",value:function(e,t){var n=this.inverseMap[t]||[];Object(r.b)(n,e),this.inverseMap[t]=n}},{key:"deestablishDirectRelationship",value:function(e,t){var n=this.directMap[e]||[];Object(r.x)(n,t),this.directMap[e]=n}},{key:"deestablishInverseRelationship",value:function(e,t){var n=this.inverseMap[t]||[];Object(r.x)(n,e),this.inverseMap[t]=n}}])&&a(t.prototype,n),i&&a(t,i),e}(),s=n(29),c=n.n(s);function u(e){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){return!t||"object"!==u(t)&&"function"!=typeof t?p(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(e){if(null==e)throw new TypeError("Cannot destructure undefined")}function d(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function v(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function b(e,t,n){return t&&v(e.prototype,t),n&&v(e,n),e}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,c=arguments.length>5?arguments[5]:void 0;d(this,e),m(this,"map",{}),m(this,"typedMap",(y(t={}),t)),m(this,"referenceMap",void 0),m(this,"conflictMap",void 0),r?(this.map=a,this.typedMap=o,this.referenceMap=s,this.conflictMap=c):(this.referenceMap=new i,this.conflictMap=new i,this.set(n))}return b(e,[{key:"immutablePayloadCopy",value:function(){var e=Object.freeze(Object.assign({},this.map)),t=Object.freeze(Object.assign({},this.typedMap)),n=Object.freeze(this.referenceMap.makeCopy()),r=Object.freeze(this.conflictMap.makeCopy());return new w(void 0,void 0,!0,e,t,n,r)}},{key:"uuids",value:function(){return Object.keys(this.map)}},{key:"all",value:function(e){var t=this;return e?this.typedMap[e]||[]:Object.keys(this.map).map((function(e){return t.map[e]}))}},{key:"find",value:function(e){return this.map[e]}},{key:"findAll",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var c=i.value,u=this.map[c];(u||t)&&n.push(u)}}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}},{key:"set",value:function(e){e=Array.isArray(e)?e:[e];var t=!0,n=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;if(this.map[i.uuid]=i,this.setToTypedMap(i),i.deleted)this.referenceMap.removeFromMap(i.uuid);else{var s=i.safeContent.conflict_of;s&&this.conflictMap.establishRelationship(s,i.uuid),this.referenceMap.setAllRelationships(i.uuid,i.references.map((function(e){return e.uuid})))}}}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}}},{key:"discard",value:function(e){e=Array.isArray(e)?e:[e];var t=!0,n=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;this.conflictMap.removeFromMap(i.uuid),this.referenceMap.removeFromMap(i.uuid),this.deleteFromTypedMap(i),delete this.map[i.uuid]}}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}}},{key:"setToTypedMap",value:function(e){var t=this.typedMap[e.content_type]||[];c()(t,{uuid:e.uuid}),t.push(e),this.typedMap[e.content_type]=t}},{key:"deleteFromTypedMap",value:function(e){var t=this.typedMap[e.content_type]||[];c()(t,{uuid:e.uuid}),this.typedMap[e.content_type]=t}},{key:"uuidsThatReferenceUuid",value:function(e){if(!Object(r.o)(e))throw Error("Must use uuid string");return this.referenceMap.getInverseRelationships(e)}},{key:"elementsReferencingElement",value:function(e){var t=this.uuidsThatReferenceUuid(e.uuid);return this.findAll(t)}},{key:"conflictsOf",value:function(e){var t=this.conflictMap.getDirectRelationships(e);return this.findAll(t)}}]),e}(),w=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1?arguments[1]:void 0,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,s=arguments.length>5?arguments[5]:void 0,c=arguments.length>6?arguments[6]:void 0;return d(this,t),m(p(e=l(this,f(t).call(this,n,a,o,i,s,c))),"source",void 0),e.source=r,Object.freeze(p(e)),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}(t,e),b(t,[{key:"payloads",get:function(){return this.all()}}]),t}(g)},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.FullSyncCompleted="sync =full-completed",e.SingleSyncCompleted="sync =single-completed",e.SyncWillBegin="sync =will-begin",e.DownloadFirstSyncCompleted="sync =download-first-completed",e.SyncTakingTooLong="sync =taking-too-long",e.SyncError="sync =error",e.InvalidSession="sync =invalid-session",e.MajorDataChange="major-data-change",e.LocalDataIncrementalLoad="local-data-incremental-load",e.LocalDataLoaded="local-data-loaded",e.EnterOutOfSync="enter-out-of-sync",e.ExitOutOfSync="exit-out-of-sync",e.StatusChanged="status-changed",e.DatabaseWriteError="database-write-error",e.DatabaseReadError="database-read-error"}(r||(r={}))},function(e,t,n){"use strict";var r;function a(e,t){return Number(e)-Number(t)}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),function(e){e.V000Base64Decrypted="000",e.V001="001",e.V002="002",e.V003="003",e.V004="004",e[e.VersionLength=3]="VersionLength"}(r||(r={}))},function(e,t,n){"use strict";var r;function a(e){return e===r.LocalStorageEncrypted||e===r.LocalStorageDecrypted||e===r.LocalStoragePreferEncrypted}function o(e){return e===r.FileEncrypted||e===r.FileDecrypted||e===r.FilePreferEncrypted}function i(e){return e===r.SyncDecrypted||e===r.LocalStorageDecrypted||e===r.FileDecrypted}function s(e){return e===r.Sync||e===r.LocalStorageEncrypted||e===r.FileEncrypted}n.d(t,"a",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"d",(function(){return o})),n.d(t,"c",(function(){return i})),n.d(t,"b",(function(){return s})),function(e){e[e.Sync=0]="Sync",e[e.SyncDecrypted=1]="SyncDecrypted",e[e.LocalStorageEncrypted=2]="LocalStorageEncrypted",e[e.LocalStorageDecrypted=3]="LocalStorageDecrypted",e[e.LocalStoragePreferEncrypted=4]="LocalStoragePreferEncrypted",e[e.FileEncrypted=5]="FileEncrypted",e[e.FileDecrypted=6]="FileDecrypted",e[e.FilePreferEncrypted=7]="FilePreferEncrypted"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return m})),n.d(t,"b",(function(){return g}));var r,a=n(7),o=n(6),i=n(5);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e}function f(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?p(e):t}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e,t,n){return(h="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=y(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)}function v(e,t){return(v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.Editor="editor-editor",e.Themes="themes",e.EditorStack="editor-stack",e.NoteTags="note-tags",e.Rooms="rooms",e.Modal="modal",e.Any="*"}(r||(r={}));var m=function(e){function t(e){var n;return c(this,t),b(p(n=f(this,y(t).call(this,e))),"componentData",void 0),b(p(n),"disassociatedItemIds",void 0),b(p(n),"associatedItemIds",void 0),b(p(n),"local_url",void 0),b(p(n),"hosted_url",void 0),b(p(n),"offlineOnly",void 0),b(p(n),"name",void 0),b(p(n),"autoupdateDisabled",void 0),b(p(n),"package_info",void 0),b(p(n),"area",void 0),b(p(n),"permissions",[]),b(p(n),"valid_until",void 0),b(p(n),"active",void 0),b(p(n),"legacy_url",void 0),n.componentData=n.payload.safeContent.componentData||{},n.legacy_url=n.payload.safeContent.legacy_url,n.hosted_url=n.payload.safeContent.hosted_url||n.payload.safeContent.url,n.local_url=n.payload.safeContent.local_url,n.valid_until=new Date(n.payload.safeContent.valid_until),n.offlineOnly=n.payload.safeContent.offlineOnly,n.name=n.payload.safeContent.name,n.area=n.payload.safeContent.area,n.package_info=n.payload.safeContent.package_info,n.permissions=n.payload.safeContent.permissions||[],n.active=n.payload.safeContent.active,n.autoupdateDisabled=n.payload.safeContent.autoupdateDisabled,n.disassociatedItemIds=n.payload.safeContent.disassociatedItemIds||[],n.associatedItemIds=n.payload.safeContent.associatedItemIds||[],n.legacy_url=n.payload.safeContent.hosted_url?void 0:n.payload.safeContent.url,n}return d(t,e),l(t,[{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?h(y(t.prototype),"strategyWhenConflictingWithItem",this).call(this,e):i.a.KeepLeft}},{key:"isEditor",value:function(){return this.area===r.Editor}},{key:"isTheme",value:function(){return this.content_type===o.a.Theme||this.area===r.Themes}},{key:"isDefaultEditor",value:function(){return!0===this.getAppDomainValue(a.a.DefaultEditor)}},{key:"getLastSize",value:function(){return this.getAppDomainValue(a.a.LastSize)}},{key:"acceptsThemes",value:function(){var e;return null===(e=this.payload.safeContent.package_info)||void 0===e?void 0:e.acceptsThemes}},{key:"getClientDataKey",value:function(){return this.legacy_url?this.legacy_url:this.uuid}},{key:"hasValidHostedUrl",value:function(){return this.hosted_url||this.legacy_url}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["active","disassociatedItemIds","associatedItemIds"].concat(h(y(t.prototype),"contentKeysToIgnoreWhenCheckingEquality",this).call(this))}},{key:"isAssociative",value:function(){return t.associativeAreas().includes(this.area)}},{key:"isExplicitlyEnabledForItem",value:function(e){return-1!==this.associatedItemIds.indexOf(e.uuid)}},{key:"isExplicitlyDisabledForItem",value:function(e){return-1!==this.disassociatedItemIds.indexOf(e.uuid)}}],[{key:"associativeAreas",value:function(){return[r.Editor]}}]),t}(a.d),g=function(e){function t(){return c(this,t),f(this,y(t).apply(this,arguments))}return d(t,e),l(t,[{key:"associateWithItem",value:function(e){this.content.associatedItemIds.push(e.uuid)}},{key:"setLastSize",value:function(e){this.setAppDataItem("lastSize",e)}},{key:"active",set:function(e){this.content.active=e}},{key:"componentData",set:function(e){this.content.componentData=e}}]),t}(a.b)},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var r=n(0),a=n.n(r),o=n(1);function i(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r,c,u;return t=e,n=null,r=[{key:"SetGenerators",value:function(e,t){this.syncUuidFunc=e,this.asyncUuidFunc=t}},{key:"canGenSync",value:function(){return!Object(o.m)(this.syncUuidFunc)}},{key:"GenerateUuid",value:(c=a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.syncUuidFunc){e.next=4;break}return e.abrupt("return",this.syncUuidFunc());case 4:return e.abrupt("return",this.asyncUuidFunc());case 5:case"end":return e.stop()}}),e,this)})),u=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=c.apply(e,t);function o(e){i(a,n,r,o,s,"next",e)}function s(e){i(a,n,r,o,s,"throw",e)}o(void 0)}))},function(){return u.apply(this,arguments)})},{key:"GenerateUuidSynchronously",value:function(){return this.syncUuidFunc()}}],n&&s(t.prototype,n),r&&s(t,r),e}();c(u,"syncUuidFunc",void 0),c(u,"asyncUuidFunc",void 0)},function(e,t,n){"use strict";n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"d",(function(){return g})),n.d(t,"b",(function(){return w}));var r,a,o=n(1),i=n(7),s=n(19);function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t,n){return(u="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=y(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function p(e,t,n){return t&&f(e.prototype,t),n&&f(e,n),e}function h(e,t){return!t||"object"!==c(t)&&"function"!=typeof t?d(e):t}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&b(e,t)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.ManageExtensions="ActionManageExtensions",e.ManageBackups="ActionManageBackups",e.ViewProtectedNotes="ActionViewProtectedNotes",e.ManagePrivileges="ActionManagePrivileges",e.ManagePasscode="ActionManagePasscode",e.DeleteNote="ActionDeleteNote"}(r||(r={})),function(e){e.AccountPassword="CredentialAccountPassword",e.LocalPasscode="CredentialLocalPasscode"}(a||(a={}));var g=function(e){function t(e){var n;return l(this,t),m(d(n=h(this,y(t).call(this,e))),"privilegeMap",{}),n.privilegeMap=e.safeContent.desktopPrivileges||{},n}return v(t,e),p(t,[{key:"getCredentialsForAction",value:function(e){return this.privilegeMap[e]||[]}},{key:"isCredentialRequiredForAction",value:function(e,t){return this.getCredentialsForAction(e).includes(t)}},{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new s.a("content_type","=",this.content_type)}}]),t}(i.d),w=function(e){function t(e,n){var r;return l(this,t),m(d(r=h(this,y(t).call(this,e,n))),"privileges",void 0),m(d(r),"privilegeMap",{}),r.privileges=e,r.privilegeMap=Object(o.a)(r.payload.safeContent.desktopPrivileges||{}),r}return v(t,e),p(t,[{key:"getResult",value:function(){return this.content&&(this.content.desktopPrivileges=this.privilegeMap),u(y(t.prototype),"getResult",this).call(this)}},{key:"setCredentialsForAction",value:function(e,t){this.privilegeMap[e]=t}},{key:"toggleCredentialForAction",value:function(e,t){this.privileges.isCredentialRequiredForAction(e,t)?this.removeCredentialForAction(e,t):this.addCredentialForAction(e,t)}},{key:"removeCredentialForAction",value:function(e,t){Object(o.x)(this.privilegeMap[e],t)}},{key:"addCredentialForAction",value:function(e,t){var n=this.privileges.getCredentialsForAction(e).slice();n.push(t),this.setCredentialsForAction(e,n)}}]),t}(i.b)},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(1);function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"keypath",void 0),o(this,"operator",void 0),o(this,"value",void 0),this.keypath=t,this.operator=n,this.value=r,this.isRecursive()){var a=this.value;this.value=a.map((function(t){return Array.isArray(t)?e.FromArray(t):t}))}else"true"!==this.value&&"false"!==this.value||(this.value=JSON.parse(this.value))}var t,n,i;return t=e,i=[{key:"FromJson",value:function(t){return new e(t.keypath,t.operator,t.value)}},{key:"FromArray",value:function(t){return new e(t[0],t[1],t[2])}},{key:"CompoundPredicate",value:function(t){return new e("ignored","and",t)}},{key:"ObjectSatisfiesPredicate",value:function(e,t){if(Array.isArray(t)&&(t=this.FromArray(t)),t.isRecursive()){if("and"===t.operator){var n=!0,r=!1,a=void 0;try{for(var o,i=t.valueAsArray()[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value;if(!this.ObjectSatisfiesPredicate(e,s))return!1}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}return!0}if("or"===t.operator){var c=!0,u=!1,l=void 0;try{for(var f,p=t.valueAsArray()[Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var h=f.value;if(this.ObjectSatisfiesPredicate(e,h))return!0}}catch(e){u=!0,l=e}finally{try{c||null==p.return||p.return()}finally{if(u)throw l}}return!1}}var y=t.value;"string"==typeof y&&y.includes(".ago")&&(y=this.DateFromString(y));var d=t.keypath.split(".").reduce((function(e,t){return e&&e[t]}),e),v=[!1,"",null,void 0,NaN];return void 0===d?"!="===t.operator?!v.includes(t.value):v.includes(t.value):"="===t.operator?Array.isArray(d)?JSON.stringify(d)===JSON.stringify(y):d===y:"!="===t.operator?Array.isArray(d)?JSON.stringify(d)!==JSON.stringify(y):d!==y:"<"===t.operator?d<y:">"===t.operator?d>y:"<="===t.operator?d<=y:">="===t.operator?d>=y:"startsWith"===t.operator?d.startsWith(y):"in"===t.operator?-1!==y.indexOf(d):"includes"===t.operator?this.resolveIncludesPredicate(d,y):"matches"===t.operator&&new RegExp(y).test(d)}},{key:"resolveIncludesPredicate",value:function(t,n){if(Object(r.o)(n))return t.includes(n);var a;a=Array.isArray(n)?e.FromArray(n):n;var o=!0,i=!1,s=void 0;try{for(var c,u=t[Symbol.iterator]();!(o=(c=u.next()).done);o=!0){var l=c.value;if(this.ObjectSatisfiesPredicate(l,a))return!0}}catch(e){i=!0,s=e}finally{try{o||null==u.return||u.return()}finally{if(i)throw s}}return!1}},{key:"ItemSatisfiesPredicate",value:function(t,n){return Array.isArray(n)&&(n=e.FromArray(n)),this.ObjectSatisfiesPredicate(t,n)}},{key:"ItemSatisfiesPredicates",value:function(e,t){var n=!0,r=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value;if(!this.ItemSatisfiesPredicate(e,s))return!1}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}return!0}},{key:"DateFromString",value:function(e){var t=e.split("."),n=t[1],r=new Date,a=parseInt(t[0]);return"days"===n?r.setDate(r.getDate()-a):"hours"===n&&r.setHours(r.getHours()-a),r}}],(n=[{key:"isRecursive",value:function(){return["and","or"].includes(this.operator)}},{key:"arrayRepresentation",value:function(){return[this.keypath,this.operator,this.value]}},{key:"valueAsArray",value:function(){return this.value}}])&&a(t.prototype,n),i&&a(t,i),e}()},function(e,t,n){"use strict";n.d(t,"b",(function(){return F})),n.d(t,"c",(function(){return q})),n.d(t,"d",(function(){return te})),n.d(t,"e",(function(){return ue})),n.d(t,"f",(function(){return be})),n.d(t,"a",(function(){return f}));var r=n(0),a=n.n(r),o=n(2);function i(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),c(this,"baseCollection",void 0),c(this,"applyCollection",void 0),c(this,"relatedCollectionSet",void 0),this.baseCollection=t,this.applyCollection=n,this.relatedCollectionSet=r}var t,n,r,o,u;return t=e,(n=[{key:"resultingCollection",value:(o=a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override PayloadDelta.resultingCollection.";case 1:case"end":return e.stop()}}),e)})),u=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=o.apply(e,t);function s(e){i(a,n,r,s,c,"next",e)}function c(e){i(a,n,r,s,c,"throw",e)}s(void 0)}))},function(){return u.apply(this,arguments)})},{key:"findBasePayload",value:function(e){return this.baseCollection.find(e)}},{key:"findRelatedPayload",value:function(e,t){var n,r=null===(n=this.relatedCollectionSet)||void 0===n?void 0:n.collectionForSource(t);return null==r?void 0:r.find(e)}}])&&s(t.prototype,n),r&&s(t,r),e}();function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f,p=function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"baseCollection",void 0),l(this,"basePayload",void 0),l(this,"applyPayload",void 0),l(this,"source",void 0),this.baseCollection=t,this.basePayload=n,this.applyPayload=r,this.source=a},h=n(8),y=n(12);!function(e){e[e.KeepLeft=1]="KeepLeft",e[e.KeepRight=2]="KeepRight",e[e.KeepLeftDuplicateRight=3]="KeepLeftDuplicateRight",e[e.DuplicateLeftKeepRight=4]="DuplicateLeftKeepRight",e[e.KeepLeftMergeRefs=5]="KeepLeftMergeRefs"}(f||(f={}));var d=n(21),v=n(1);function b(e){return(b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function m(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?m(Object(n),!0).forEach((function(t){w(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):m(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function x(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){k(o,r,a,i,s,"next",e)}function s(e){k(o,r,a,i,s,"throw",e)}i(void 0)}))}}function S(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function O(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function P(e,t){return!t||"object"!==b(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function j(e){return(j=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _(e,t){return(_=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var C=function(e){function t(){return S(this,t),P(this,j(t).apply(this,arguments))}var n,r,i,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(c=x(a.a.mark((function e(){var t,n,r,o;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(h.a)(this.basePayload),n=Object(h.a)(this.applyPayload),r=t.strategyWhenConflictingWithItem(n),e.next=5,this.payloadsByHandlingStrategy(r);case 5:return o=e.sent,e.abrupt("return",new y.a(o,this.source));case 7:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"payloadsByHandlingStrategy",value:(s=x(a.a.mark((function e(t){var n,r,i,s,c,u,l,p;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==f.KeepLeft){e.next=2;break}return e.abrupt("return",[this.basePayload]);case 2:if(t!==f.KeepRight){e.next=4;break}return e.abrupt("return",[this.applyPayload]);case 4:if(t!==f.KeepLeftDuplicateRight){e.next=11;break}return n=Object(v.k)(this.basePayload.updated_at,this.applyPayload.updated_at),r=Object(o.b)(this.basePayload,{updated_at:n,dirty:!0,dirtiedDate:new Date}),e.next=9,Object(d.c)(this.applyPayload,this.baseCollection,!0);case 9:return i=e.sent,e.abrupt("return",[r].concat(i));case 11:if(t!==f.DuplicateLeftKeepRight){e.next=17;break}return e.next=14,Object(d.c)(this.basePayload,this.baseCollection,!0);case 14:return s=e.sent,c=this.applyPayload,e.abrupt("return",s.concat([c]));case 17:if(t!==f.KeepLeftMergeRefs){e.next=22;break}return u=Object(v.E)(this.basePayload.contentObject.references,this.applyPayload.contentObject.references,["uuid","content_type"]),l=Object(v.k)(this.basePayload.updated_at,this.applyPayload.updated_at),p=Object(o.b)(this.basePayload,{updated_at:l,dirty:!0,dirtiedDate:new Date,content:g({},this.basePayload.safeContent,{references:u})}),e.abrupt("return",[p]);case 22:throw"Unhandled strategy";case 23:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})}])&&O(n.prototype,r),i&&O(n,i),t}(p),D=n(3);function E(e){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function I(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function R(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){I(o,r,a,i,s,"next",e)}function s(e){I(o,r,a,i,s,"throw",e)}i(void 0)}))}}function A(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function M(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function T(e,t){return!t||"object"!==E(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function K(e){return(K=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function L(e,t){return(L=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var F=function(e){function t(){return A(this,t),T(this,K(t).apply(this,arguments))}var n,r,i,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&L(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(c=R(a.a.mark((function e(){var t,n,r,i,s,c,u,l,f;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=!0,r=!1,i=void 0,e.prev=4,s=this.applyCollection.all()[Symbol.iterator]();case 6:if(n=(c=s.next()).done){e.next=16;break}return u=c.value,e.next=10,this.payloadsByHandlingPayload(u,t);case 10:l=e.sent,f=l.map((function(e){return Object(o.b)(e,{dirty:!0,dirtiedDate:new Date,deleted:!1})})),Object(v.h)(t,f);case 13:n=!0,e.next=6;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(4),r=!0,i=e.t0;case 22:e.prev=22,e.prev=23,n||null==s.return||s.return();case 25:if(e.prev=25,!r){e.next=28;break}throw i;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return e.abrupt("return",new y.a(t,D.a.FileImport));case 31:case"end":return e.stop()}}),e,this,[[4,18,22,30],[23,,25,29]])}))),function(){return c.apply(this,arguments)})},{key:"payloadsByHandlingPayload",value:(s=R(a.a.mark((function e(t,n){var r,o,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=n.find((function(e){return e.contentObject.conflict_of===t.uuid})))||(r=n.find((function(e){return e.uuid===t.uuid}))),r||(r=this.findBasePayload(t.uuid)),r){e.next=5;break}return e.abrupt("return",[t]);case 5:return o=new C(this.baseCollection,r,t,D.a.FileImport),e.next=8,o.resultingCollection();case 8:return i=e.sent,e.abrupt("return",i.all());case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})}])&&M(n.prototype,r),i&&M(n,i),t}(u);function V(e){return(V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function N(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function U(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function B(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function W(e,t){return!t||"object"!==V(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function H(e){return(H=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function z(e,t){return(z=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var q=function(e){function t(){return U(this,t),W(this,H(t).apply(this,arguments))}var n,r,o,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&z(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(i=a.a.mark((function e(){var t,n,r,o,i,s,c,u,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=!0,r=!1,o=void 0,e.prev=4,i=this.applyCollection.all()[Symbol.iterator]();case 6:if(n=(s=i.next()).done){e.next=22;break}if(c=s.value,t.push(c),u=this.findBasePayload(c.uuid)){e.next=12;break}return e.abrupt("continue",19);case 12:if(!Object(d.a)(c,u)){e.next=15;break}return e.abrupt("continue",19);case 15:return e.next=17,Object(d.c)(u,this.baseCollection,!0);case 17:l=e.sent,Object(v.h)(t,l);case 19:n=!0,e.next=6;break;case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(4),r=!0,o=e.t0;case 28:e.prev=28,e.prev=29,n||null==i.return||i.return();case 31:if(e.prev=31,!r){e.next=34;break}throw o;case 34:return e.finish(31);case 35:return e.finish(28);case 36:return e.abrupt("return",new y.a(t,D.a.RemoteRetrieved));case 37:case"end":return e.stop()}}),e,this,[[4,24,28,36],[29,,31,35]])})),s=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=i.apply(e,t);function o(e){N(a,n,r,o,s,"next",e)}function s(e){N(a,n,r,o,s,"throw",e)}o(void 0)}))},function(){return s.apply(this,arguments)})}])&&B(n.prototype,r),o&&B(n,o),t}(u);function Y(e){return(Y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function J(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function G(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){J(o,r,a,i,s,"next",e)}function s(e){J(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Q(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function $(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function X(e,t){return!t||"object"!==Y(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Z(e){return(Z=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ee(e,t){return(ee=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var te=function(e){function t(){return Q(this,t),X(this,Z(t).apply(this,arguments))}var n,r,o,i,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ee(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(c=G(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.applyCollection.source!==D.a.ConflictUuid){e.next=4;break}return e.abrupt("return",this.collectionsByHandlingUuidConflicts());case 4:if(this.applyCollection.source!==D.a.ConflictData){e.next=8;break}return e.abrupt("return",this.collectionsByHandlingDataConflicts());case 8:throw"Unhandled conflict type ".concat(this.applyCollection.source);case 9:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"collectionsByHandlingDataConflicts",value:(s=G(a.a.mark((function e(){var t,n,r,o,i,s,c,u,l,f,p,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=!0,r=!1,o=void 0,e.prev=4,i=this.applyCollection.all()[Symbol.iterator]();case 6:if(n=(s=i.next()).done){e.next=27;break}if(c=s.value,u=this.findBasePayload(c.uuid)){e.next=12;break}return t.push(c),e.abrupt("continue",24);case 12:if(l=this.findRelatedPayload(c.uuid,D.a.DecryptedTransient)){e.next=18;break}if(c.deleted){e.next=16;break}throw"Unable to find decrypted counterpart for data conflict.";case 16:return t.push(c),e.abrupt("continue",24);case 18:return f=new C(this.baseCollection,u,l,D.a.ConflictData),e.next=21,f.resultingCollection();case 21:p=e.sent,h=p.all(),Object(v.h)(t,h);case 24:n=!0,e.next=6;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(4),r=!0,o=e.t0;case 33:e.prev=33,e.prev=34,n||null==i.return||i.return();case 36:if(e.prev=36,!r){e.next=39;break}throw o;case 39:return e.finish(36);case 40:return e.finish(33);case 41:return e.abrupt("return",new y.a(t,D.a.RemoteRetrieved));case 42:case"end":return e.stop()}}),e,this,[[4,29,33,41],[34,,36,40]])}))),function(){return s.apply(this,arguments)})},{key:"collectionsByHandlingUuidConflicts",value:(i=G(a.a.mark((function e(){var t,n,r,o,i,s,c,u,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=!0,r=!1,o=void 0,e.prev=4,i=this.applyCollection.all()[Symbol.iterator]();case 6:if(n=(s=i.next()).done){e.next=16;break}return c=s.value,u=this.findRelatedPayload(c.uuid,D.a.DecryptedTransient),e.next=11,Object(d.b)(u,this.baseCollection);case 11:l=e.sent,Object(v.h)(t,l);case 13:n=!0,e.next=6;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(4),r=!0,o=e.t0;case 22:e.prev=22,e.prev=23,n||null==i.return||i.return();case 25:if(e.prev=25,!r){e.next=28;break}throw o;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return e.abrupt("return",new y.a(t,D.a.RemoteRetrieved));case 31:case"end":return e.stop()}}),e,this,[[4,18,22,30],[23,,25,29]])}))),function(){return i.apply(this,arguments)})}])&&$(n.prototype,r),o&&$(n,o),t}(u);function ne(e){return(ne="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function re(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ae(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function oe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ie(e,t){return!t||"object"!==ne(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function se(e){return(se=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ce(e,t){return(ce=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ue=function(e){function t(){return ae(this,t),ie(this,se(t).apply(this,arguments))}var n,r,o,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ce(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(i=a.a.mark((function e(){var t,n,r,o,i,s,c,u,l,f,p,h,b,m,g,w,k,x,S;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=[],r=!0,o=!1,i=void 0,e.prev=5,s=this.applyCollection.all()[Symbol.iterator]();case 7:if(r=(c=s.next()).done){e.next=27;break}if(u=c.value,l=this.findRelatedPayload(u.uuid,D.a.SavedOrSaving),f=this.findRelatedPayload(u.uuid,D.a.DecryptedTransient)){e.next=16;break}if(u.deleted){e.next=14;break}throw"Cannot find decrypted for non-deleted payload.";case 14:return t.push(u),e.abrupt("continue",24);case 16:if(!l){e.next=19;break}return n.push(f),e.abrupt("continue",24);case 19:if(!(p=this.findBasePayload(u.uuid))||!p.dirty){e.next=23;break}return n.push(f),e.abrupt("continue",24);case 23:t.push(f);case 24:r=!0,e.next=7;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(5),o=!0,i=e.t0;case 33:e.prev=33,e.prev=34,r||null==s.return||s.return();case 36:if(e.prev=36,!o){e.next=39;break}throw i;case 39:return e.finish(36);case 40:return e.finish(33);case 41:h=[],b=0,m=n;case 43:if(!(b<m.length)){e.next=63;break}if(g=m[b],w=this.findRelatedPayload(g.uuid,D.a.DecryptedTransient)){e.next=48;break}return e.abrupt("continue",60);case 48:if(k=this.findBasePayload(g.uuid)){e.next=51;break}return e.abrupt("continue",60);case 51:if(k.compareContentFields(w)){e.next=60;break}if(!(x=this.findConflictOf(g.uuid))||!x.compareContentFields(w)){e.next=56;break}return e.abrupt("continue",60);case 56:return e.next=58,Object(d.c)(w,this.baseCollection,!0);case 58:S=e.sent,Object(v.h)(h,S);case 60:b++,e.next=43;break;case 63:return e.abrupt("return",new y.a(t.concat(h),D.a.RemoteRetrieved));case 64:case"end":return e.stop()}}),e,this,[[5,29,33,41],[34,,36,40]])})),s=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=i.apply(e,t);function o(e){re(a,n,r,o,s,"next",e)}function s(e){re(a,n,r,o,s,"throw",e)}o(void 0)}))},function(){return s.apply(this,arguments)})},{key:"findConflictOf",value:function(e){return this.baseCollection.conflictsOf(e)[0]}}])&&oe(n.prototype,r),o&&oe(n,o),t}(u);function le(e){return(le="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function fe(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function pe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function he(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ye(e,t){return!t||"object"!==le(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function de(e){return(de=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ve(e,t){return(ve=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var be=function(e){function t(){return pe(this,t),ye(this,de(t).apply(this,arguments))}var n,r,i,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ve(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(s=a.a.mark((function e(){var t,n,r,i,s,c,u,l,f,p;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t=[],n=!0,r=!1,i=void 0,e.prev=4,s=this.applyCollection.all()[Symbol.iterator]();!(n=(c=s.next()).done);n=!0)u=c.value,l=this.findBasePayload(u.uuid),f=l?l.deleted:u.deleted,p=Object(o.f)(u,D.a.RemoteSaved,{lastSyncEnd:new Date,deleted:f}),t.push(p);e.next=12;break;case 8:e.prev=8,e.t0=e.catch(4),r=!0,i=e.t0;case 12:e.prev=12,e.prev=13,n||null==s.return||s.return();case 15:if(e.prev=15,!r){e.next=18;break}throw i;case 18:return e.finish(15);case 19:return e.finish(12);case 20:return e.abrupt("return",new y.a(t,D.a.RemoteSaved));case 21:case"end":return e.stop()}}),e,this,[[4,8,12,20],[13,,15,19]])})),c=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=s.apply(e,t);function o(e){fe(a,n,r,o,i,"next",e)}function i(e){fe(a,n,r,o,i,"throw",e)}o(void 0)}))},function(){return c.apply(this,arguments)})}])&&he(n.prototype,r),i&&he(n,i),t}(u)},function(e,t,n){"use strict";n.d(t,"a",(function(){return v})),n.d(t,"c",(function(){return b})),n.d(t,"b",(function(){return g}));var r=n(0),a=n.n(r),o=n(8),i=n(29),s=n.n(i),c=n(2),u=n(1),l=n(17);function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?f(Object(n),!0).forEach((function(t){h(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function y(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function d(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){y(o,r,a,i,s,"next",e)}function s(e){y(o,r,a,i,s,"throw",e)}i(void 0)}))}}function v(e,t){var n=Object(o.a)(e),r=Object(o.a)(t);return n.isItemContentEqualWith(r)}function b(e,t,n){return m.apply(this,arguments)}function m(){return(m=d(a.a.mark((function e(t,n,r){var o,i,s,f,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=[],e.next=3,l.a.GenerateUuid();case 3:return e.t0=e.sent,e.t1=new Date,i={uuid:e.t0,dirty:!0,dirtiedDate:e.t1,lastSyncBegan:null,lastSyncEnd:null},r&&(i.content=p({},t.safeContent,{conflict_of:t.uuid})),s=Object(c.b)(t,i),o.push(s),f=n.elementsReferencingElement(t),e.next=12,k(f,[{uuid:s.uuid,content_type:s.content_type}]);case 12:return h=e.sent,Object(u.h)(o,h),e.abrupt("return",o);case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e,t){return w.apply(this,arguments)}function w(){return(w=d(a.a.mark((function e(t,n){var r,o,i,s,f;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],e.t0=c.b,e.t1=t,e.next=5,l.a.GenerateUuid();case 5:return e.t2=e.sent,e.t3=new Date,e.t4={uuid:e.t2,dirty:!0,dirtiedDate:e.t3,lastSyncBegan:null,lastSyncEnd:null},o=(0,e.t0)(e.t1,e.t4),r.push(o),i=n.elementsReferencingElement(t),e.next=13,k(i,[{uuid:o.uuid,content_type:o.content_type}],[t.uuid]);case 13:return s=e.sent,Object(u.h)(r,s),f=Object(c.b)(t,{deleted:!0,dirty:!1,content:void 0}),r.push(f),e.abrupt("return",r);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function k(e,t,n){return x.apply(this,arguments)}function x(){return(x=d(a.a.mark((function e(t,n,r){var o,i,u,l,f,h,y,d,v,b,m,g,w,k,x,S,O,P,j,_,C;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=[],i=!0,u=!1,l=void 0,e.prev=4,f=t[Symbol.iterator]();case 6:if(i=(h=f.next()).done){e.next=54;break}if(y=h.value,d=y.contentObject.references.slice(),!n){e.next=29;break}for(v=!0,b=!1,m=void 0,e.prev=13,g=n[Symbol.iterator]();!(v=(w=g.next()).done);v=!0)k=w.value,d.push(k);e.next=21;break;case 17:e.prev=17,e.t0=e.catch(13),b=!0,m=e.t0;case 21:e.prev=21,e.prev=22,v||null==g.return||g.return();case 24:if(e.prev=24,!b){e.next=27;break}throw m;case 27:return e.finish(24);case 28:return e.finish(21);case 29:if(!r){e.next=49;break}for(x=!0,S=!1,O=void 0,e.prev=33,P=r[Symbol.iterator]();!(x=(j=P.next()).done);x=!0)_=j.value,s()(d,{uuid:_});e.next=41;break;case 37:e.prev=37,e.t1=e.catch(33),S=!0,O=e.t1;case 41:e.prev=41,e.prev=42,x||null==P.return||P.return();case 44:if(e.prev=44,!S){e.next=47;break}throw O;case 47:return e.finish(44);case 48:return e.finish(41);case 49:C=Object(c.b)(y,{dirty:!0,dirtiedDate:new Date,content:p({},y.safeContent,{references:d})}),o.push(C);case 51:i=!0,e.next=6;break;case 54:e.next=60;break;case 56:e.prev=56,e.t2=e.catch(4),u=!0,l=e.t2;case 60:e.prev=60,e.prev=61,i||null==f.return||f.return();case 63:if(e.prev=63,!u){e.next=66;break}throw l;case 66:return e.finish(63);case 67:return e.finish(60);case 68:return e.abrupt("return",o);case 69:case"end":return e.stop()}}),e,null,[[4,56,60,68],[13,17,21,29],[22,,24,28],[33,37,41,49],[42,,44,48],[61,,63,67]])})))).apply(this,arguments)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return i}));var r,a=n(13);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e){var t;return(t={},o(t,a.a.FullSyncCompleted,r.CompletedSync),o(t,a.a.SyncError,r.FailedSync),o(t,a.a.SyncTakingTooLong,r.HighLatencySync),o(t,a.a.EnterOutOfSync,r.EnteredOutOfSync),o(t,a.a.ExitOutOfSync,r.ExitedOutOfSync),o(t,a.a.LocalDataLoaded,r.LocalDataLoaded),o(t,a.a.MajorDataChange,r.MajorDataChange),o(t,a.a.LocalDataIncrementalLoad,r.LocalDataIncrementalLoad),o(t,a.a.StatusChanged,r.SyncStatusChanged),o(t,a.a.SyncWillBegin,r.WillSync),o(t,a.a.InvalidSession,r.InvalidSyncSession),o(t,a.a.DatabaseReadError,r.LocalDatabaseReadError),o(t,a.a.DatabaseWriteError,r.LocalDatabaseWriteError),t)[e]}n.d(t,"b",(function(){return a.a})),function(e){e[e.SignedIn=2]="SignedIn",e[e.SignedOut=3]="SignedOut",e[e.CompletedSync=5]="CompletedSync",e[e.FailedSync=6]="FailedSync",e[e.HighLatencySync=7]="HighLatencySync",e[e.EnteredOutOfSync=8]="EnteredOutOfSync",e[e.ExitedOutOfSync=9]="ExitedOutOfSync",e[e.Started=10]="Started",e[e.Launched=11]="Launched",e[e.LocalDataLoaded=12]="LocalDataLoaded",e[e.KeyStatusChanged=13]="KeyStatusChanged",e[e.MajorDataChange=14]="MajorDataChange",e[e.CompletedRestart=15]="CompletedRestart",e[e.LocalDataIncrementalLoad=16]="LocalDataIncrementalLoad",e[e.SyncStatusChanged=17]="SyncStatusChanged",e[e.WillSync=18]="WillSync",e[e.InvalidSyncSession=19]="InvalidSyncSession",e[e.LocalDatabaseReadError=20]="LocalDatabaseReadError",e[e.LocalDatabaseWriteError=21]="LocalDatabaseWriteError"}(r||(r={}))},function(e,t){var n=Array.isArray;e.exports=n},function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return v}));var r=n(7),a=n(5),o=n(14);function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t&&c(e.prototype,t),n&&c(e,n),e}function l(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function f(e,t,n){return(f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=p(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&y(e,t)}function y(e,t){return(y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var d=function(e){function t(){return s(this,t),l(this,p(t).apply(this,arguments))}return h(t,e),u(t,[{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?f(p(t.prototype),"strategyWhenConflictingWithItem",this).call(this,e):a.a.KeepLeft}},{key:"version",get:function(){return this.payload.safeContent.version}},{key:"isItemsKey",get:function(){return!0}},{key:"isDefault",get:function(){return this.payload.safeContent.isDefault}},{key:"itemsKey",get:function(){return this.payload.safeContent.itemsKey}},{key:"dataAuthenticationKey",get:function(){if(this.version===o.a.V004)throw"Attempting to access legacy data authentication key.";return this.payload.safeContent.dataAuthenticationKey}}]),t}(r.d),v=function(e){function t(){return s(this,t),l(this,p(t).apply(this,arguments))}return h(t,e),u(t,[{key:"isDefault",set:function(e){this.content.isDefault=e}}]),t}(r.b)},function(e,t,n){(function(e){var n,r,a,o;function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}window,o=function(){return function(e){function t(t){for(var n,a,o=t[0],i=t[1],s=0,c=[];s<o.length;s++)a=o[s],Object.prototype.hasOwnProperty.call(r,a)&&r[a]&&c.push(r[a][0]),r[a]=0;for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n]);for(u&&u(t);c.length;)c.shift()()}var n={},r={1:0,2:0};function a(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,a),r.l=!0,r.exports}a.e=function(e){var t=[],n=r[e];if(0!==n)if(n)t.push(n[2]);else{var o=new Promise((function(t,a){n=r[e]=[t,a]}));t.push(n[2]=o);var i,s=document.createElement("script");s.charset="utf-8",s.timeout=120,a.nc&&s.setAttribute("nonce",a.nc),s.src=function(e){return a.p+""+({0:"libsodium",3:"vendors~libsodium"}[e]||e)+".bundle.js"}(e);var c=new Error;i=function(t){s.onerror=s.onload=null,clearTimeout(u);var n=r[e];if(0!==n){if(n){var a=t&&("load"===t.type?"missing":t.type),o=t&&t.target&&t.target.src;c.message="Loading chunk "+e+" failed.\n("+a+": "+o+")",c.name="ChunkLoadError",c.type=a,c.request=o,n[1](c)}r[e]=void 0}};var u=setTimeout((function(){i({type:"timeout",target:s})}),12e4);s.onerror=s.onload=i,document.head.appendChild(s)}return Promise.all(t)},a.m=e,a.c=n,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==i(e)&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/dist/",a.oe=function(e){throw console.error(e),e};var o=window.webpackJsonpSNCrypto=window.webpackJsonpSNCrypto||[],s=o.push.bind(o);o.push=t,o=o.slice();for(var c=0;c<o.length;c++)t(o[c]);var u=s;return a(a.s=11)}([function(e,t,n){e.exports=n(6)},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return c})),n.d(t,"j",(function(){return u})),n.d(t,"o",(function(){return l})),n.d(t,"k",(function(){return f})),n.d(t,"i",(function(){return p})),n.d(t,"n",(function(){return h})),n.d(t,"p",(function(){return y})),n.d(t,"d",(function(){return v})),n.d(t,"c",(function(){return m})),n.d(t,"l",(function(){return w})),n.d(t,"g",(function(){return x})),n.d(t,"b",(function(){return O})),n.d(t,"m",(function(){return j})),n.d(t,"h",(function(){return C})),n.d(t,"f",(function(){return E})),n.d(t,"e",(function(){return I})),n.d(t,"q",(function(){return R}));var r=n(0),a=n.n(r);function o(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function i(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function s(e){o(i,r,a,s,c,"next",e)}function c(e){o(i,r,a,s,c,"throw",e)}s(void 0)}))}}var s=n(7),c=n(2).Buffer;function u(){return"undefined"!=typeof window?window:void 0!==e?e:null}function l(){return!("undefined"!=typeof document&&document.documentMode||/Edge/.test(navigator.userAgent))&&u().crypto&&!!u().crypto.subtle}function f(){return u().crypto?u().crypto.subtle:null}function p(){var e=u(),t=e.crypto||e.msCrypto;if(t){var n=new Uint32Array(4);t.getRandomValues(n);var r=-1;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){r++;var t=n[r>>3]>>r%8*4&15;return("x"===e?t:3&t|8).toString(16)}))}var a=(new Date).getTime();return e.performance&&"function"==typeof e.performance.now&&(a+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===e?t:3&t|8).toString(16)}))}function h(e){return"string"==typeof e||e instanceof String}function y(e){return d.apply(this,arguments)}function d(){return(d=i(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){var r=new Blob([t]),a=new FileReader;a.onload=function(t){e(t.target.result)},a.readAsArrayBuffer(r)})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function v(e){return b.apply(this,arguments)}function b(){return(b=i(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){var r=new Blob([t]),a=new FileReader;a.onload=function(t){e(t.target.result)},a.readAsText(r)})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e){return g.apply(this,arguments)}function g(){return(g=i(a.a.mark((function e(t){var n,r,o,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(n=new Uint8Array(t),r="",i=0;i<n.byteLength;i++)(o=n[i].toString(16)).length<2&&(o="0"+o),r+=o;return e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function w(e){return k.apply(this,arguments)}function k(){return(k=i(a.a.mark((function e(t){var n,r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(n=[],r=0;r<t.length;r+=2)n.push(parseInt(t.substr(r,2),16));return e.abrupt("return",new Uint8Array(n));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e){return S.apply(this,arguments)}function S(){return(S=i(a.a.mark((function e(t){var n,r,o,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,I(t);case 2:for(n=e.sent,r=n.length,o=new Uint8Array(r),i=0;i<r;i++)o[i]=n.charCodeAt(i);return e.abrupt("return",o.buffer);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function O(e){return P.apply(this,arguments)}function P(){return(P=i(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){var r=new Blob([t],{type:"application/octet-binary"}),a=new FileReader;a.onload=function(t){var n=t.target.result;e(n.substr(n.indexOf(",")+1))},a.readAsDataURL(r)})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function j(e){return _.apply(this,arguments)}function _(){return(_=i(a.a.mark((function e(t){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.from(t,"hex"),e.abrupt("return",n.toString("base64"));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function C(e){return D.apply(this,arguments)}function D(){return(D=i(a.a.mark((function e(t){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.from(t,"base64"),e.abrupt("return",n.toString("hex"));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function E(e){return u().btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)})))}function I(e){return u().atob(e)}function R(e){return A.apply(this,arguments)}function A(){return(A=i(a.a.mark((function e(t){var n,r=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:"binary",!c.isBuffer(t)){e.next=5;break}return e.abrupt("return",t);case 5:if(null!==t){e.next=9;break}return e.abrupt("return",null);case 9:if("string"!=typeof t){e.next=13;break}return e.abrupt("return",c.from(t,n));case 13:if(!(t instanceof Uint8Array)){e.next=17;break}return e.abrupt("return",s(t));case 17:if(!(t instanceof Promise)){e.next=21;break}return e.abrupt("return",t);case 21:throw new TypeError("Invalid type; string or buffer expected");case 22:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}).call(this,n(3))},function(e,t,n){"use strict";(function(e){
/*!
       * The buffer module from node.js, for the browser.
       *
       * @author   Feross Aboukhadijeh <http://feross.org>
       * @license  MIT
       */
var r=n(8),a=n(9),o=n(5);function i(){return c.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function s(e,t){if(i()<t)throw new RangeError("Invalid typed array length");return c.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=c.prototype:(null===e&&(e=new c(t)),e.length=t),e}function c(e,t,n){if(!(c.TYPED_ARRAY_SUPPORT||this instanceof c))return new c(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return f(this,e)}return u(this,e,t,n)}function u(e,t,n,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,r){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");return t=void 0===n&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,n):new Uint8Array(t,n,r),c.TYPED_ARRAY_SUPPORT?(e=t).__proto__=c.prototype:e=p(e,t),e}(e,t,n,r):"string"==typeof t?function(e,t,n){if("string"==typeof n&&""!==n||(n="utf8"),!c.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|y(t,n),a=(e=s(e,r)).write(t,n);return a!==r&&(e=e.slice(0,a)),e}(e,t,n):function(e,t){if(c.isBuffer(t)){var n=0|h(t.length);return 0===(e=s(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?s(e,0):p(e,t);if("Buffer"===t.type&&o(t.data))return p(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function f(e,t){if(l(t),e=s(e,t<0?0:0|h(t)),!c.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function p(e,t){var n=t.length<0?0:0|h(t.length);e=s(e,n);for(var r=0;r<n;r+=1)e[r]=255&t[r];return e}function h(e){if(e>=i())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i().toString(16)+" bytes");return 0|e}function y(e,t){if(c.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return N(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return U(e).length;default:if(r)return N(e).length;t=(""+t).toLowerCase(),r=!0}}function d(e,t,n){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return D(this,t,n);case"utf8":case"utf-8":return j(this,t,n);case"ascii":return _(this,t,n);case"latin1":case"binary":return C(this,t,n);case"base64":return P(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function v(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function b(e,t,n,r,a){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=a?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(a)return-1;n=e.length-1}else if(n<0){if(!a)return-1;n=0}if("string"==typeof t&&(t=c.from(t,r)),c.isBuffer(t))return 0===t.length?-1:m(e,t,n,r,a);if("number"==typeof t)return t&=255,c.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?a?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):m(e,[t],n,r,a);throw new TypeError("val must be string, number or Buffer")}function m(e,t,n,r,a){var o,i=1,s=e.length,c=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;i=2,s/=2,c/=2,n/=2}function u(e,t){return 1===i?e[t]:e.readUInt16BE(t*i)}if(a){var l=-1;for(o=n;o<s;o++)if(u(e,o)===u(t,-1===l?0:o-l)){if(-1===l&&(l=o),o-l+1===c)return l*i}else-1!==l&&(o-=o-l),l=-1}else for(n+c>s&&(n=s-c),o=n;o>=0;o--){for(var f=!0,p=0;p<c;p++)if(u(e,o+p)!==u(t,p)){f=!1;break}if(f)return o}return-1}function g(e,t,n,r){n=Number(n)||0;var a=e.length-n;r?(r=Number(r))>a&&(r=a):r=a;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");r>o/2&&(r=o/2);for(var i=0;i<r;++i){var s=parseInt(t.substr(2*i,2),16);if(isNaN(s))return i;e[n+i]=s}return i}function w(e,t,n,r){return B(N(t,e.length-n),e,n,r)}function k(e,t,n,r){return B(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function x(e,t,n,r){return k(e,t,n,r)}function S(e,t,n,r){return B(U(t),e,n,r)}function O(e,t,n,r){return B(function(e,t){for(var n,r,a,o=[],i=0;i<e.length&&!((t-=2)<0);++i)r=(n=e.charCodeAt(i))>>8,a=n%256,o.push(a),o.push(r);return o}(t,e.length-n),e,n,r)}function P(e,t,n){return 0===t&&n===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,n))}function j(e,t,n){n=Math.min(e.length,n);for(var r=[],a=t;a<n;){var o,i,s,c,u=e[a],l=null,f=u>239?4:u>223?3:u>191?2:1;if(a+f<=n)switch(f){case 1:u<128&&(l=u);break;case 2:128==(192&(o=e[a+1]))&&(c=(31&u)<<6|63&o)>127&&(l=c);break;case 3:o=e[a+1],i=e[a+2],128==(192&o)&&128==(192&i)&&(c=(15&u)<<12|(63&o)<<6|63&i)>2047&&(c<55296||c>57343)&&(l=c);break;case 4:o=e[a+1],i=e[a+2],s=e[a+3],128==(192&o)&&128==(192&i)&&128==(192&s)&&(c=(15&u)<<18|(63&o)<<12|(63&i)<<6|63&s)>65535&&c<1114112&&(l=c)}null===l?(l=65533,f=1):l>65535&&(l-=65536,r.push(l>>>10&1023|55296),l=56320|1023&l),r.push(l),a+=f}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);for(var n="",r=0;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=4096));return n}(r)}function _(e,t,n){var r="";n=Math.min(e.length,n);for(var a=t;a<n;++a)r+=String.fromCharCode(127&e[a]);return r}function C(e,t,n){var r="";n=Math.min(e.length,n);for(var a=t;a<n;++a)r+=String.fromCharCode(e[a]);return r}function D(e,t,n){var r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);for(var a="",o=t;o<n;++o)a+=V(e[o]);return a}function E(e,t,n){for(var r=e.slice(t,n),a="",o=0;o<r.length;o+=2)a+=String.fromCharCode(r[o]+256*r[o+1]);return a}function I(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function R(e,t,n,r,a,o){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>a||t<o)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function A(e,t,n,r){t<0&&(t=65535+t+1);for(var a=0,o=Math.min(e.length-n,2);a<o;++a)e[n+a]=(t&255<<8*(r?a:1-a))>>>8*(r?a:1-a)}function M(e,t,n,r){t<0&&(t=4294967295+t+1);for(var a=0,o=Math.min(e.length-n,4);a<o;++a)e[n+a]=t>>>8*(r?a:3-a)&255}function T(e,t,n,r,a,o){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function K(e,t,n,r,o){return o||T(e,0,n,4),a.write(e,t,n,r,23,4),n+4}function L(e,t,n,r,o){return o||T(e,0,n,8),a.write(e,t,n,r,52,8),n+8}t.Buffer=c,t.SlowBuffer=function(e){return+e!=e&&(e=0),c.alloc(+e)},t.INSPECT_MAX_BYTES=50,c.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=i(),c.poolSize=8192,c._augment=function(e){return e.__proto__=c.prototype,e},c.from=function(e,t,n){return u(null,e,t,n)},c.TYPED_ARRAY_SUPPORT&&(c.prototype.__proto__=Uint8Array.prototype,c.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&c[Symbol.species]===c&&Object.defineProperty(c,Symbol.species,{value:null,configurable:!0})),c.alloc=function(e,t,n){return function(e,t,n,r){return l(t),t<=0?s(e,t):void 0!==n?"string"==typeof r?s(e,t).fill(n,r):s(e,t).fill(n):s(e,t)}(null,e,t,n)},c.allocUnsafe=function(e){return f(null,e)},c.allocUnsafeSlow=function(e){return f(null,e)},c.isBuffer=function(e){return!(null==e||!e._isBuffer)},c.compare=function(e,t){if(!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,r=t.length,a=0,o=Math.min(n,r);a<o;++a)if(e[a]!==t[a]){n=e[a],r=t[a];break}return n<r?-1:r<n?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!o(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=c.allocUnsafe(t),a=0;for(n=0;n<e.length;++n){var i=e[n];if(!c.isBuffer(i))throw new TypeError('"list" argument must be an Array of Buffers');i.copy(r,a),a+=i.length}return r},c.byteLength=y,c.prototype._isBuffer=!0,c.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)v(this,t,t+1);return this},c.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)v(this,t,t+3),v(this,t+1,t+2);return this},c.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)v(this,t,t+7),v(this,t+1,t+6),v(this,t+2,t+5),v(this,t+3,t+4);return this},c.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?j(this,0,e):d.apply(this,arguments)},c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(e+=" ... ")),"<Buffer "+e+">"},c.prototype.compare=function(e,t,n,r,a){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===a&&(a=this.length),t<0||n>e.length||r<0||a>this.length)throw new RangeError("out of range index");if(r>=a&&t>=n)return 0;if(r>=a)return-1;if(t>=n)return 1;if(this===e)return 0;for(var o=(a>>>=0)-(r>>>=0),i=(n>>>=0)-(t>>>=0),s=Math.min(o,i),u=this.slice(r,a),l=e.slice(t,n),f=0;f<s;++f)if(u[f]!==l[f]){o=u[f],i=l[f];break}return o<i?-1:i<o?1:0},c.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},c.prototype.indexOf=function(e,t,n){return b(this,e,t,n,!0)},c.prototype.lastIndexOf=function(e,t,n){return b(this,e,t,n,!1)},c.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var a=this.length-t;if((void 0===n||n>a)&&(n=a),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return g(this,e,t,n);case"utf8":case"utf-8":return w(this,e,t,n);case"ascii":return k(this,e,t,n);case"latin1":case"binary":return x(this,e,t,n);case"base64":return S(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return O(this,e,t,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},c.prototype.slice=function(e,t){var n,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),c.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=c.prototype;else{var a=t-e;n=new c(a,void 0);for(var o=0;o<a;++o)n[o]=this[o+e]}return n},c.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||I(e,t,this.length);for(var r=this[e],a=1,o=0;++o<t&&(a*=256);)r+=this[e+o]*a;return r},c.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||I(e,t,this.length);for(var r=this[e+--t],a=1;t>0&&(a*=256);)r+=this[e+--t]*a;return r},c.prototype.readUInt8=function(e,t){return t||I(e,1,this.length),this[e]},c.prototype.readUInt16LE=function(e,t){return t||I(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUInt16BE=function(e,t){return t||I(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUInt32LE=function(e,t){return t||I(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUInt32BE=function(e,t){return t||I(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||I(e,t,this.length);for(var r=this[e],a=1,o=0;++o<t&&(a*=256);)r+=this[e+o]*a;return r>=(a*=128)&&(r-=Math.pow(2,8*t)),r},c.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||I(e,t,this.length);for(var r=t,a=1,o=this[e+--r];r>0&&(a*=256);)o+=this[e+--r]*a;return o>=(a*=128)&&(o-=Math.pow(2,8*t)),o},c.prototype.readInt8=function(e,t){return t||I(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){t||I(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt16BE=function(e,t){t||I(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt32LE=function(e,t){return t||I(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return t||I(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readFloatLE=function(e,t){return t||I(e,4,this.length),a.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return t||I(e,4,this.length),a.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return t||I(e,8,this.length),a.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return t||I(e,8,this.length),a.read(this,e,!1,52,8)},c.prototype.writeUIntLE=function(e,t,n,r){e=+e,t|=0,n|=0,r||R(this,e,t,n,Math.pow(2,8*n)-1,0);var a=1,o=0;for(this[t]=255&e;++o<n&&(a*=256);)this[t+o]=e/a&255;return t+n},c.prototype.writeUIntBE=function(e,t,n,r){e=+e,t|=0,n|=0,r||R(this,e,t,n,Math.pow(2,8*n)-1,0);var a=n-1,o=1;for(this[t+a]=255&e;--a>=0&&(o*=256);)this[t+a]=e/o&255;return t+n},c.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,1,255,0),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},c.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):A(this,e,t,!0),t+2},c.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):A(this,e,t,!1),t+2},c.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):M(this,e,t,!0),t+4},c.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):M(this,e,t,!1),t+4},c.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t|=0,!r){var a=Math.pow(2,8*n-1);R(this,e,t,n,a-1,-a)}var o=0,i=1,s=0;for(this[t]=255&e;++o<n&&(i*=256);)e<0&&0===s&&0!==this[t+o-1]&&(s=1),this[t+o]=(e/i>>0)-s&255;return t+n},c.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t|=0,!r){var a=Math.pow(2,8*n-1);R(this,e,t,n,a-1,-a)}var o=n-1,i=1,s=0;for(this[t+o]=255&e;--o>=0&&(i*=256);)e<0&&0===s&&0!==this[t+o+1]&&(s=1),this[t+o]=(e/i>>0)-s&255;return t+n},c.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,1,127,-128),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):A(this,e,t,!0),t+2},c.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):A(this,e,t,!1),t+2},c.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,4,2147483647,-2147483648),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):M(this,e,t,!0),t+4},c.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):M(this,e,t,!1),t+4},c.prototype.writeFloatLE=function(e,t,n){return K(this,e,t,!0,n)},c.prototype.writeFloatBE=function(e,t,n){return K(this,e,t,!1,n)},c.prototype.writeDoubleLE=function(e,t,n){return L(this,e,t,!0,n)},c.prototype.writeDoubleBE=function(e,t,n){return L(this,e,t,!1,n)},c.prototype.copy=function(e,t,n,r){if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var a,o=r-n;if(this===e&&n<t&&t<r)for(a=o-1;a>=0;--a)e[a+t]=this[a+n];else if(o<1e3||!c.TYPED_ARRAY_SUPPORT)for(a=0;a<o;++a)e[a+t]=this[a+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+o),t);return o},c.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===e.length){var a=e.charCodeAt(0);a<256&&(e=a)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!c.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var o;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(o=t;o<n;++o)this[o]=e;else{var i=c.isBuffer(e)?e:N(new c(e,r).toString()),s=i.length;for(o=0;o<n-t;++o)this[o+t]=i[o%s]}return this};var F=/[^+\/0-9A-Za-z-_]/g;function V(e){return e<16?"0"+e.toString(16):e.toString(16)}function N(e,t){var n;t=t||1/0;for(var r=e.length,a=null,o=[],i=0;i<r;++i){if((n=e.charCodeAt(i))>55295&&n<57344){if(!a){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(i+1===r){(t-=3)>-1&&o.push(239,191,189);continue}a=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),a=n;continue}n=65536+(a-55296<<10|n-56320)}else a&&(t-=3)>-1&&o.push(239,191,189);if(a=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function U(e){return r.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(F,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function B(e,t,n,r){for(var a=0;a<r&&!(a+n>=t.length||a>=e.length);++a)t[a+n]=e[a];return a}}).call(this,n(3))},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==i(Symbol.iterator)?function(e){return i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":i(e)})(e)}var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":n(window))&&(r=window)}e.exports=r},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},function(e,t,n){(function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==i(Symbol.iterator)?function(e){return i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":i(e)})(e)}var n=function(e){"use strict";var n=Object.prototype,r=n.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function c(e,t,n,r){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new S(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(a,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===a)throw o;return{value:void 0,done:!0}}for(n.method=a,n.arg=o;;){var i=n.delegate;if(i){var s=w(i,n);if(s){if(s===l)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var c=u(e,t,n);if("normal"===c.type){if(r=n.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r="completed",n.method="throw",n.arg=c.arg)}}}(e,n,i),o}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function h(){}var y={};y[o]=function(){return this};var d=Object.getPrototypeOf,v=d&&d(d(O([])));v&&v!==n&&r.call(v,o)&&(y=v);var b=h.prototype=f.prototype=Object.create(y);function m(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function g(e,n){var a;this._invoke=function(o,i){function s(){return new n((function(a,s){!function a(o,i,s,c){var l=u(e[o],e,i);if("throw"!==l.type){var f=l.arg,p=f.value;return p&&"object"===t(p)&&r.call(p,"__await")?n.resolve(p.__await).then((function(e){a("next",e,s,c)}),(function(e){a("throw",e,s,c)})):n.resolve(p).then((function(e){f.value=e,s(f)}),(function(e){return a("throw",e,s,c)}))}c(l.arg)}(o,i,a,s)}))}return a=a?a.then(s,s):s()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=u(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var a=r.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:P}}function P(){return{value:void 0,done:!0}}return p.prototype=b.constructor=h,h.constructor=p,h[s]=p.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},m(g.prototype),g.prototype[i]=function(){return this},e.AsyncIterator=g,e.async=function(t,n,r,a,o){void 0===o&&(o=Promise);var i=new g(c(t,n,r,a),o);return e.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},m(b),b[s]="Generator",b[o]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=O,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return i.type="throw",i.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),x(n),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;x(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:O(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},e}("object"===t(e)?e.exports:{});try{regeneratorRuntime=n}catch(e){Function("r","regeneratorRuntime = r")(n)}}).call(this,n(4)(e))},function(e,t,n){(function(t){var r=n(10).strict;e.exports=function(e){if(r(e)){var n=t.from(e.buffer);return e.byteLength!==e.buffer.byteLength&&(n=n.slice(e.byteOffset,e.byteOffset+e.byteLength)),n}return t.from(e)}}).call(this,n(2).Buffer)},function(e,t,n){"use strict";t.byteLength=function(e){var t=u(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,r=u(e),i=r[0],s=r[1],c=new o(function(e,t,n){return 3*(t+n)/4-n}(0,i,s)),l=0,f=s>0?i-4:i;for(n=0;n<f;n+=4)t=a[e.charCodeAt(n)]<<18|a[e.charCodeAt(n+1)]<<12|a[e.charCodeAt(n+2)]<<6|a[e.charCodeAt(n+3)],c[l++]=t>>16&255,c[l++]=t>>8&255,c[l++]=255&t;return 2===s&&(t=a[e.charCodeAt(n)]<<2|a[e.charCodeAt(n+1)]>>4,c[l++]=255&t),1===s&&(t=a[e.charCodeAt(n)]<<10|a[e.charCodeAt(n+1)]<<4|a[e.charCodeAt(n+2)]>>2,c[l++]=t>>8&255,c[l++]=255&t),c},t.fromByteArray=function(e){for(var t,n=e.length,a=n%3,o=[],i=0,s=n-a;i<s;i+=16383)o.push(l(e,i,i+16383>s?s:i+16383));return 1===a?(t=e[n-1],o.push(r[t>>2]+r[t<<4&63]+"==")):2===a&&(t=(e[n-2]<<8)+e[n-1],o.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"=")),o.join("")};for(var r=[],a=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,c=i.length;s<c;++s)r[s]=i[s],a[i.charCodeAt(s)]=s;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function l(e,t,n){for(var a,o,i=[],s=t;s<n;s+=3)a=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(255&e[s+2]),i.push(r[(o=a)>>18&63]+r[o>>12&63]+r[o>>6&63]+r[63&o]);return i.join("")}a["-".charCodeAt(0)]=62,a["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,n,r,a){var o,i,s=8*a-r-1,c=(1<<s)-1,u=c>>1,l=-7,f=n?a-1:0,p=n?-1:1,h=e[t+f];for(f+=p,o=h&(1<<-l)-1,h>>=-l,l+=s;l>0;o=256*o+e[t+f],f+=p,l-=8);for(i=o&(1<<-l)-1,o>>=-l,l+=r;l>0;i=256*i+e[t+f],f+=p,l-=8);if(0===o)o=1-u;else{if(o===c)return i?NaN:1/0*(h?-1:1);i+=Math.pow(2,r),o-=u}return(h?-1:1)*i*Math.pow(2,o-r)},t.write=function(e,t,n,r,a,o){var i,s,c,u=8*o-a-1,l=(1<<u)-1,f=l>>1,p=23===a?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:o-1,y=r?1:-1,d=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,i=l):(i=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-i))<1&&(i--,c*=2),(t+=i+f>=1?p/c:p*Math.pow(2,1-f))*c>=2&&(i++,c/=2),i+f>=l?(s=0,i=l):i+f>=1?(s=(t*c-1)*Math.pow(2,a),i+=f):(s=t*Math.pow(2,f-1)*Math.pow(2,a),i=0));a>=8;e[n+h]=255&s,h+=y,s/=256,a-=8);for(i=i<<a|s,u+=a;u>0;e[n+h]=255&i,h+=y,i/=256,u-=8);e[n+h-y]|=128*d}},function(e,t){e.exports=a,a.strict=o,a.loose=i;var n=Object.prototype.toString,r={"[object Int8Array]":!0,"[object Int16Array]":!0,"[object Int32Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Uint16Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0};function a(e){return o(e)||i(e)}function o(e){return e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array}function i(e){return r[n.call(e)]}},function(e,t,n){"use strict";n.r(t),n.d(t,"SNPureCrypto",(function(){return u})),n.d(t,"SNWebCrypto",(function(){return x})),n.d(t,"isWebCryptoAvailable",(function(){return o.o})),n.d(t,"Buffer",(function(){return o.a})),n.d(t,"base64Encode",(function(){return o.f})),n.d(t,"base64Decode",(function(){return o.e})),n.d(t,"base64ToHex",(function(){return o.h})),n.d(t,"hexToBase64",(function(){return o.m}));var r=n(0),a=n.n(r),o=n(1);function s(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r,i;return t=e,(n=[{key:"generateUUIDSync",value:function(){return Object(o.i)()}},{key:"generateUUID",value:(r=a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(o.i)());case 1:case"end":return e.stop()}}),e)})),i=function(){var e=this,t=arguments;return new Promise((function(n,a){var o=r.apply(e,t);function i(e){s(o,n,a,i,c,"next",e)}function c(e){s(o,n,a,i,c,"throw",e)}i(void 0)}))},function(){return i.apply(this,arguments)})},{key:"timingSafeEqual",value:function(e,t){var n=String(e),r=String(t),a=n.length,o=0;a!==r.length&&(r=n,o=1);for(var i=0;i<a;i++)o|=n.charCodeAt(i)^r.charCodeAt(i);return 0===o}}])&&c(t.prototype,n),e}();function l(e){return(l="function"==typeof Symbol&&"symbol"==i(Symbol.iterator)?function(e){return i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":i(e)})(e)}function f(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function p(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){f(o,r,a,i,s,"next",e)}function s(e){f(o,r,a,i,s,"throw",e)}i(void 0)}))}}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t){return!t||"object"!==l(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function v(e,t){return(v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var b=o.k(),m="AES-CBC",g="SHA-256",w="PBKDF2",k="HMAC",x=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=y(this,d(t).call(this))).ready=Promise.all([n.e(3),n.e(0)]).then(n.bind(null,168)).then((function(t){return e.sodium=t,e.sodium.ready})),e}var r,i,s,c,u,l,f,x,S,O,P,j,_,C;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)}(t,e),r=t,(i=[{key:"pbkdf2",value:(C=p(a.a.mark((function e(t,n,r,o){var i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.webCryptoImportKey(t,w,["deriveBits"]);case 2:if(i=e.sent){e.next=6;break}return console.error("Key is null, unable to continue"),e.abrupt("return",null);case 6:return e.abrupt("return",this.webCryptoDeriveBits(i,n,r,o));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return C.apply(this,arguments)})},{key:"generateRandomKey",value:(_=p(a.a.mark((function e(t){var n,r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t/8,r=o.j().crypto.getRandomValues(new Uint8Array(n)),e.abrupt("return",o.c(r));case 3:case"end":return e.stop()}}),e)}))),function(e){return _.apply(this,arguments)})},{key:"aes256CbcEncrypt",value:(j=p(a.a.mark((function e(t,n,r){var i,s,c,u,l,f,p;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.l(r);case 2:return i=e.sent,e.next=5,o.l(n);case 5:return s=e.sent,c={name:m,iv:s},e.next=9,this.webCryptoImportKey(i,c.name,["encrypt"]);case 9:return u=e.sent,e.next=12,o.p(t);case 12:return l=e.sent,e.next=15,crypto.subtle.encrypt(c,u,l);case 15:return f=e.sent,e.next=18,o.b(f);case 18:return p=e.sent,e.abrupt("return",p);case 20:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return j.apply(this,arguments)})},{key:"aes256CbcDecrypt",value:(P=p(a.a.mark((function e(t,n,r){var i,s,c,u,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.l(r);case 2:return i=e.sent,e.next=5,o.l(n);case 5:return s=e.sent,c={name:m,iv:s},e.next=9,this.webCryptoImportKey(i,c.name,["decrypt"]);case 9:return u=e.sent,e.next=12,o.g(t);case 12:return l=e.sent,e.abrupt("return",crypto.subtle.decrypt(c,u,l).then(function(){var e=p(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",o.d(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){return console.error("Error performing AES-CBC decryption:",e),null})));case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return P.apply(this,arguments)})},{key:"hmac256",value:(O=p(a.a.mark((function e(t,n){var r,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.l(n);case 2:return r=e.sent,e.next=5,this.webCryptoImportKey(r,k,["sign"],{name:g});case 5:return i=e.sent,e.next=8,o.p(t);case 8:return s=e.sent,e.abrupt("return",crypto.subtle.sign({name:k},i,s).then((function(e){return o.c(e)})).catch((function(e){return console.error("Error computing HMAC:",e),null})));case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return O.apply(this,arguments)})},{key:"sha256",value:(S=p(a.a.mark((function e(t){var n,r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.p(t);case 2:return n=e.sent,e.next=5,crypto.subtle.digest(g,n);case 5:return r=e.sent,e.abrupt("return",o.c(r));case 7:case"end":return e.stop()}}),e)}))),function(e){return S.apply(this,arguments)})},{key:"unsafeSha1",value:(x=p(a.a.mark((function e(t){var n,r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.p(t);case 2:return n=e.sent,e.next=5,crypto.subtle.digest("SHA-1",n);case 5:return r=e.sent,e.abrupt("return",o.c(r));case 7:case"end":return e.stop()}}),e)}))),function(e){return x.apply(this,arguments)})},{key:"webCryptoImportKey",value:(f=p(a.a.mark((function e(t,n,r,i){var s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!o.n(t)){e.next=6;break}return e.next=3,o.p(t);case 3:e.t0=e.sent,e.next=7;break;case 6:e.t0=t;case 7:return s=e.t0,e.abrupt("return",b.importKey("raw",s,{name:n,hash:i},!1,r).then((function(e){return e})).catch((function(e){return console.error(e),null})));case 9:case"end":return e.stop()}}),e)}))),function(e,t,n,r){return f.apply(this,arguments)})},{key:"webCryptoDeriveBits",value:(l=p(a.a.mark((function e(t,n,r,i){var s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=w,e.next=3,o.p(n);case 3:return e.t1=e.sent,e.t2=r,e.t3={name:"SHA-512"},s={name:e.t0,salt:e.t1,iterations:e.t2,hash:e.t3},e.abrupt("return",b.deriveBits(s,t,i).then((function(e){return o.c(new Uint8Array(e))})).catch((function(e){return console.error(e),null})));case 8:case"end":return e.stop()}}),e)}))),function(e,t,n,r){return l.apply(this,arguments)})},{key:"argon2",value:(u=p(a.a.mark((function e(t,n,r,i,s){var c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready;case 2:return e.t0=this.sodium,e.t1=s,e.next=6,o.q(t,"binary");case 6:return e.t2=e.sent,e.next=9,o.q(n,"hex");case 9:return e.t3=e.sent,e.t4=r,e.t5=i,e.t6=this.sodium.crypto_pwhash_ALG_DEFAULT,c=e.t0.crypto_pwhash.call(e.t0,e.t1,e.t2,e.t3,e.t4,e.t5,e.t6,"hex"),e.abrupt("return",c);case 15:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return u.apply(this,arguments)})},{key:"xchacha20Encrypt",value:(c=p(a.a.mark((function e(t,n,r,i){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready;case 2:if(48===n.length){e.next=4;break}throw"Nonce must be 24 bytes";case 4:return e.t0=this.sodium,e.next=7,o.q(t);case 7:return e.t1=e.sent,e.next=10,o.q(i);case 10:return e.t2=e.sent,e.next=13,o.q(n,"hex");case 13:return e.t3=e.sent,e.next=16,o.q(r,"hex");case 16:return e.t4=e.sent,e.abrupt("return",e.t0.crypto_aead_xchacha20poly1305_ietf_encrypt.call(e.t0,e.t1,e.t2,null,e.t3,e.t4,"base64"));case 18:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return c.apply(this,arguments)})},{key:"xchacha20Decrypt",value:(s=p(a.a.mark((function e(t,n,r,i){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready;case 2:if(48===n.length){e.next=4;break}throw"Nonce must be 24 bytes";case 4:return e.prev=4,e.t0=this.sodium,e.next=8,o.q(t,"base64");case 8:return e.t1=e.sent,e.next=11,o.q(i);case 11:return e.t2=e.sent,e.next=14,o.q(n,"hex");case 14:return e.t3=e.sent,e.next=17,o.q(r,"hex");case 17:return e.t4=e.sent,e.abrupt("return",e.t0.crypto_aead_xchacha20poly1305_ietf_decrypt.call(e.t0,null,e.t1,e.t2,e.t3,e.t4,"text"));case 21:return e.prev=21,e.t5=e.catch(4),e.abrupt("return",null);case 24:case"end":return e.stop()}}),e,this,[[4,21]])}))),function(e,t,n,r){return s.apply(this,arguments)})}])&&h(r.prototype,i),t}(u)}])},"object"==i(t)&&"object"==i(e)?e.exports=o():(r=[],void 0===(a="function"==typeof(n=o)?n.apply(t,r):n)||(e.exports=a))}).call(this,n(36)(e))},function(e,t,n){var r=n(177)(n(178));e.exports=r},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(72),o="object"==("undefined"==typeof self?"undefined":r(self))&&self&&self.Object===Object&&self,i=a||o||Function("return this")();e.exports=i},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=n(e);return null!=e&&("object"==t||"function"==t)}},function(e,t,n){var r=n(55),a=n(172);e.exports=function(e,t){var n=[];if(!e||!e.length)return n;var o=-1,i=[],s=e.length;for(t=r(t,3);++o<s;){var c=e[o];t(c,o,e)&&(n.push(c),i.push(o))}return a(e,i),n}},function(e,t,n){var r=n(116),a=n(121);e.exports=function(e,t){var n=a(e,t);return r(n)?n:void 0}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){return null!=e&&"object"==n(e)}},function(e,t,n){var r=n(96);e.exports=function(e){return e&&e.length?r(e):[]}},function(e,t,n){var r=n(44),a=n(117),o=n(118),i=r?r.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?a(e):o(e)}},function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return v}));var r=n(1),a=n(7);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function u(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?f(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d=function(e){function t(e){var n;return i(this,t),y(f(n=u(this,l(t).call(this,e))),"title",void 0),y(f(n),"text",""),y(f(n),"mobilePrefersPlainEditor",void 0),n.title=n.payload.safeContent.title,n.text=n.payload.safeContent.text,Object(r.m)(n.payload.safeContent.mobilePrefersPlainEditor)||(n.mobilePrefersPlainEditor=n.payload.safeContent.mobilePrefersPlainEditor),n}return p(t,e),c(t,[{key:"safeText",value:function(){return this.text||""}},{key:"safeTitle",value:function(){return this.title||""}}],[{key:"filterDummyNotes",value:function(e){return e.filter((function(e){return!e.dummy}))}}]),t}(a.d),v=function(e){function t(){return i(this,t),u(this,l(t).apply(this,arguments))}return p(t,e),c(t,[{key:"title",set:function(e){this.content.title=e}},{key:"text",set:function(e){this.content.text=e}}]),t}(a.b)},function(e,t,n){"use strict";n.d(t,"a",(function(){return y})),n.d(t,"b",(function(){return d}));var r=n(7),a=n(6);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function u(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?f(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var y=function(e){function t(e){var n,r,a,o;return i(this,t),n=u(this,l(t).call(this,e)),r=f(n),o=void 0,(a="title")in r?Object.defineProperty(r,a,{value:o,enumerable:!0,configurable:!0,writable:!0}):r[a]=o,n.title=n.payload.safeContent.title,n}return p(t,e),c(t,[{key:"isSmartTag",value:function(){return this.content_type===a.a.SmartTag}},{key:"noteCount",get:function(){return this.payload.safeReferences.length}}],[{key:"arrayToDisplayString",value:function(e){return e.sort((function(e,t){return e.title>t.title?1:-1})).map((function(e){return"#"+e.title})).join(" ")}}]),t}(r.d),d=function(e){function t(){return i(this,t),u(this,l(t).apply(this,arguments))}return p(t,e),c(t,[{key:"title",set:function(e){this.content.title=e}}]),t}(r.b)},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){e.exports=function(e,t){return e===t||e!=e&&t!=t}},function(e,t,n){var r=n(58),a=n(65);e.exports=function(e){return null!=e&&a(e.length)&&!r(e)}},function(e,t,n){var r=n(48);e.exports=function(e){if("string"==typeof e||r(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return v}));var r=n(7),a=n(51);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function u(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?f(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d=function(e){function t(e){var n;return i(this,t),y(f(n=u(this,l(t).call(this,e))),"actions",[]),y(f(n),"description",void 0),y(f(n),"name",void 0),y(f(n),"url",void 0),y(f(n),"package_info",void 0),y(f(n),"supported_types",void 0),n.description=e.safeContent.description,n.url=e.safeContent.url,n.name=e.safeContent.name,n.package_info=e.safeContent.package_info,n.supported_types=e.safeContent.supported_types,e.safeContent.actions&&(n.actions=e.safeContent.actions.map((function(e){return new a.a(e)}))),n}return p(t,e),c(t,[{key:"actionsWithContextForItem",value:function(e){return this.actions.filter((function(t){return t.context===e.content_type||"Item"===t.context}))}}]),t}(r.d),v=function(e){function t(){return i(this,t),u(this,l(t).apply(this,arguments))}return p(t,e),c(t,[{key:"description",set:function(e){this.content.description=e}},{key:"supported_types",set:function(e){this.content.supported_types=e}},{key:"actions",set:function(e){this.content.actions=e}}]),t}(r.b)},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":n(window))&&(r=window)}e.exports=r},function(e,t,n){var r=n(106),a=n(107),o=n(108),i=n(109),s=n(110);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,n){var r=n(37);e.exports=function(e,t){for(var n=e.length;n--;)if(r(e[n][0],t))return n;return-1}},function(e,t,n){var r=n(27).Symbol;e.exports=r},function(e,t,n){var r=n(30)(Object,"create");e.exports=r},function(e,t,n){var r=n(130);e.exports=function(e,t){var n=e.__data__;return r(t)?n["string"==typeof t?"string":"hash"]:n.map}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r=/^(?:0|[1-9]\d*)$/;e.exports=function(e,t){var a=n(e);return!!(t=null==t?9007199254740991:t)&&("number"==a||"symbol"!=a&&r.test(e))&&e>-1&&e%1==0&&e<t}},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(33),o=n(31);e.exports=function(e){return"symbol"==r(e)||o(e)&&"[object Symbol]"==a(e)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var r=n(3),a=n(5),o=n(8),i=n(14),s=n(1),c=n(2),u=n(11);function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){function e(t,n,c){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),f(this,"fields",void 0),f(this,"source",void 0),f(this,"uuid",void 0),f(this,"content_type",void 0),f(this,"content",void 0),f(this,"deleted",void 0),f(this,"items_key_id",void 0),f(this,"enc_item_key",void 0),f(this,"created_at",void 0),f(this,"updated_at",void 0),f(this,"dirtiedDate",void 0),f(this,"dirty",void 0),f(this,"dummy",void 0),f(this,"errorDecrypting",void 0),f(this,"waitingForKey",void 0),f(this,"errorDecryptingValueChanged",void 0),f(this,"lastSyncBegan",void 0),f(this,"lastSyncEnd",void 0),f(this,"auth_hash",void 0),f(this,"auth_params",void 0),f(this,"format",void 0),f(this,"version",void 0),this.fields=n||Object.keys(t),this.source=c||r.a.Constructor,this.uuid=t.uuid,!this.uuid&&this.fields.includes(a.i.Uuid))throw Error("uuid is null, yet this payloads fields indicate it shouldnt be.");this.content_type=t.content_type,t.content&&(Object(s.n)(t.content)?this.content=Object(o.b)(t.content):this.content=t.content),this.deleted=t.deleted,this.items_key_id=t.items_key_id,this.enc_item_key=t.enc_item_key,this.created_at=new Date(t.created_at||new Date),this.updated_at=new Date(t.updated_at||new Date(0)),this.dirtiedDate=new Date(t.dirtiedDate),this.dirty=t.dirty,this.dummy=t.dummy,this.errorDecrypting=t.errorDecrypting,this.waitingForKey=t.waitingForKey,this.errorDecryptingValueChanged=t.errorDecryptingValueChanged,this.lastSyncBegan=t.lastSyncBegan?new Date(t.lastSyncBegan):void 0,this.lastSyncEnd=t.lastSyncEnd?new Date(t.lastSyncEnd):void 0,this.auth_hash=t.auth_hash,this.auth_params=t.auth_params,Object(s.o)(this.content)?this.content.startsWith(i.a.V000Base64Decrypted)?this.format=u.a.DecryptedBase64String:this.format=u.a.EncryptedString:Object(s.n)(this.content)?this.format=u.a.DecryptedBareObject:this.format=u.a.Deleted,Object(s.o)(this.content)?this.version=this.content.substring(0,i.a.VersionLength):this.content&&(this.version=this.content.version),Object(s.f)(this)}var t,n,p;return t=e,(n=[{key:"mergedWith",value:function(e){var t={},n=!0,r=!1,a=void 0;try{for(var o,i=e.fields[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value;t[s]=e[s]}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}return Object(c.b)(this,t)}},{key:"compareContentFields",value:function(e){var t=Object(o.a)(this),n=Object(o.a)(e);return t.isItemContentEqualWith(n)}},{key:"safeContent",get:function(){return this.format===u.a.DecryptedBareObject?this.content:{}}},{key:"references",get:function(){return this.safeReferences}},{key:"safeReferences",get:function(){return this.safeContent.references||[]}},{key:"contentObject",get:function(){if(this.format!==u.a.DecryptedBareObject)throw Error("Attempting to access non-object content as object");return this.content}},{key:"contentString",get:function(){if(this.format===u.a.DecryptedBareObject)throw Error("Attempting to access non-string content as string");return this.content}},{key:"discardable",get:function(){return this.deleted&&!this.dirty}}])&&l(t.prototype,n),p&&l(t,p),e}()},function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}n.d(t,"a",(function(){return a}));var a=function(){function e(t){var n,r,a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a=void 0,(r="collections")in(n=this)?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,this.collections=t,Object.freeze(this)}var t,n,a;return t=e,(n=[{key:"collectionForSource",value:function(e){return this.collections.find((function(t){return t.source===e}))}}])&&r(t.prototype,n),a&&r(t,a),e}()},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(53),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"running",void 0),o(this,"error",void 0),o(this,"lastExecuted",void 0),o(this,"context",void 0),o(this,"verb",void 0),o(this,"url",void 0),o(this,"access_type",void 0),a()(this,t),this.running=!1,this.error=!1,this.lastExecuted&&(this.lastExecuted=new Date(this.lastExecuted))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var r=n(8),a=n(35),o=n(6),i=n(19),s=n(2);function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t){return!t||"object"!==c(t)&&"function"!=typeof t?f(e):t}(this,l(t).call(this,e)),h(f(n),"predicate",void 0),h(f(n),"isTrashTag",void 0),e.safeContent.predicate&&(n.predicate=i.a.FromJson(e.safeContent.predicate)),n.isTrashTag=e.safeContent.isTrashTag,n}var n,a,y;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(t,e),n=t,y=[{key:"systemSmartTags",value:function(){var e=Object(s.e)({uuid:"all-notes",content_type:o.a.SmartTag,dummy:!0,content:Object(r.b)({title:"All notes",isSystemTag:!0,isAllTag:!0,predicate:i.a.FromArray(["content_type","=",o.a.Note])})}),t=Object(s.e)({uuid:"archived-notes",content_type:o.a.SmartTag,dummy:!0,content:Object(r.b)({title:"Archived",isSystemTag:!0,isArchiveTag:!0,predicate:i.a.FromArray(["archived","=",JSON.stringify(!0)])})}),n=Object(s.e)({uuid:"trashed-notes",content_type:o.a.SmartTag,dummy:!0,content:Object(r.b)({title:"Trash",isSystemTag:!0,isTrashTag:!0,predicate:i.a.FromArray(["content.trashed","=",JSON.stringify(!0)])})});return[Object(r.a)(e),Object(r.a)(t),Object(r.a)(n)]}}],(a=null)&&u(n.prototype,a),y&&u(n,y),t}(a.a)},function(e,t,n){var r=n(87),a=n(94)((function(e,t,n){r(e,t,n)}));e.exports=a},function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return i}));var r=n(7),a=n(1);function o(e,t,n,o){if((e=Object(a.B)(e)).appData){var i=e.appData[r.d.DefaultAppDomain()];Object(a.v)(i,o),i?0===Object.keys(i).length&&delete e.appData:delete e.appData}if(Object(a.v)(e,n),(t=Object(a.B)(t)).appData){var s=t.appData[r.d.DefaultAppDomain()];Object(a.v)(s,o),s?0===Object.keys(s).length&&delete t.appData:delete t.appData}return Object(a.v)(t,n),JSON.stringify(e)===JSON.stringify(t)}function i(e,t,n){return n||(n=[]),!o(e.content,t.content,e.contentKeysToIgnoreWhenCheckingEquality().concat(n),e.appDataContentKeysToIgnoreWhenCheckingEquality())}},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(104),o=n(159),i=n(70),s=n(23),c=n(169);e.exports=function(e){return"function"==typeof e?e:null==e?i:"object"==r(e)?s(e)?o(e[0],e[1]):a(e):c(e)}},function(e,t,n){var r=n(42),a=n(111),o=n(112),i=n(113),s=n(114),c=n(115);function u(e){var t=this.__data__=new r(e);this.size=t.size}u.prototype.clear=a,u.prototype.delete=o,u.prototype.get=i,u.prototype.has=s,u.prototype.set=c,e.exports=u},function(e,t,n){var r=n(30)(n(27),"Map");e.exports=r},function(e,t,n){var r=n(33),a=n(28);e.exports=function(e){if(!a(e))return!1;var t=r(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},function(e,t,n){var r=n(122),a=n(129),o=n(131),i=n(132),s=n(133);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t){e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}},function(e,t,n){var r=n(79),a=n(152),o=n(38);e.exports=function(e){return o(e)?r(e):a(e)}},function(e,t,n){var r=n(148),a=n(31),o=Object.prototype,i=o.hasOwnProperty,s=o.propertyIsEnumerable,c=r(function(){return arguments}())?r:function(e){return a(e)&&i.call(e,"callee")&&!s.call(e,"callee")};e.exports=c},function(e,t,n){(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(27),o=n(149),i="object"==r(t)&&t&&!t.nodeType&&t,s=i&&"object"==r(e)&&e&&!e.nodeType&&e,c=s&&s.exports===i?a.Buffer:void 0,u=(c?c.isBuffer:void 0)||o;e.exports=u}).call(this,n(36)(e))},function(e,t,n){var r=n(150),a=n(80),o=n(151),i=o&&o.isTypedArray,s=i?a(i):r;e.exports=s},function(e,t){e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},function(e,t){var n=Object.prototype;e.exports=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||n)}},function(e,t,n){var r=n(68),a=n(39);e.exports=function(e,t){for(var n=0,o=(t=r(t,e)).length;null!=e&&n<o;)e=e[a(t[n++])];return n&&n==o?e:void 0}},function(e,t,n){var r=n(23),a=n(69),o=n(161),i=n(164);e.exports=function(e,t){return r(e)?e:a(e,t)?[e]:o(i(e))}},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(23),o=n(48),i=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,s=/^\w*$/;e.exports=function(e,t){if(a(e))return!1;var n=r(e);return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!o(e))||(s.test(e)||!i.test(e)||null!=t&&e in Object(t))}},function(e,t){e.exports=function(e){return e}},function(e,t,n){var r=n(89);e.exports=function(e,t,n){"__proto__"==t&&r?r(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}},function(e,t,n){(function(t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r="object"==(void 0===t?"undefined":n(t))&&t&&t.Object===Object&&t;e.exports=r}).call(this,n(41))},function(e,t){var n=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return n.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},function(e,t,n){var r=n(134),a=n(31);e.exports=function e(t,n,o,i,s){return t===n||(null==t||null==n||!a(t)&&!a(n)?t!=t&&n!=n:r(t,n,o,i,e,s))}},function(e,t,n){var r=n(76),a=n(137),o=n(77);e.exports=function(e,t,n,i,s,c){var u=1&n,l=e.length,f=t.length;if(l!=f&&!(u&&f>l))return!1;var p=c.get(e);if(p&&c.get(t))return p==t;var h=-1,y=!0,d=2&n?new r:void 0;for(c.set(e,t),c.set(t,e);++h<l;){var v=e[h],b=t[h];if(i)var m=u?i(b,v,h,t,e,c):i(v,b,h,e,t,c);if(void 0!==m){if(m)continue;y=!1;break}if(d){if(!a(t,(function(e,t){if(!o(d,t)&&(v===e||s(v,e,n,i,c)))return d.push(t)}))){y=!1;break}}else if(v!==b&&!s(v,b,n,i,c)){y=!1;break}}return c.delete(e),c.delete(t),y}},function(e,t,n){var r=n(59),a=n(135),o=n(136);function i(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new r;++t<n;)this.add(e[t])}i.prototype.add=i.prototype.push=a,i.prototype.has=o,e.exports=i},function(e,t){e.exports=function(e,t){return e.has(t)}},function(e,t,n){var r=n(27).Uint8Array;e.exports=r},function(e,t,n){var r=n(147),a=n(62),o=n(23),i=n(63),s=n(47),c=n(64),u=Object.prototype.hasOwnProperty;e.exports=function(e,t){var n=o(e),l=!n&&a(e),f=!n&&!l&&i(e),p=!n&&!l&&!f&&c(e),h=n||l||f||p,y=h?r(e.length,String):[],d=y.length;for(var v in e)!t&&!u.call(e,v)||h&&("length"==v||f&&("offset"==v||"parent"==v)||p&&("buffer"==v||"byteLength"==v||"byteOffset"==v)||s(v,d))||y.push(v);return y}},function(e,t){e.exports=function(e){return function(t){return e(t)}}},function(e,t){e.exports=function(e,t){return function(n){return e(t(n))}}},function(e,t,n){var r=n(30)(n(27),"Set");e.exports=r},function(e,t,n){var r=n(28);e.exports=function(e){return e==e&&!r(e)}},function(e,t){e.exports=function(e,t){return function(n){return null!=n&&(n[e]===t&&(void 0!==t||e in Object(n)))}}},function(e,t){e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length,a=Array(r);++n<r;)a[n]=t(e[n],n,e);return a}},function(e,t){e.exports=function(e,t,n,r){for(var a=e.length,o=n+(r?1:-1);r?o--:++o<a;)if(t(e[o],o,e))return o;return-1}},function(e,t,n){var r=n(56),a=n(88),o=n(182),i=n(184),s=n(28),c=n(93),u=n(92);e.exports=function e(t,n,l,f,p){t!==n&&o(n,(function(o,c){if(p||(p=new r),s(o))i(t,n,c,l,e,f,p);else{var h=f?f(u(t,c),o,c+"",t,n,p):void 0;void 0===h&&(h=o),a(t,c,h)}}),c)}},function(e,t,n){var r=n(71),a=n(37);e.exports=function(e,t,n){(void 0===n||a(e[t],n))&&(void 0!==n||t in e)||r(e,t,n)}},function(e,t,n){var r=n(30),a=function(){try{var e=r(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=a},function(e,t){e.exports=function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}},function(e,t,n){var r=n(81)(Object.getPrototypeOf,Object);e.exports=r},function(e,t){e.exports=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}},function(e,t,n){var r=n(79),a=n(195),o=n(38);e.exports=function(e){return o(e)?r(e,!0):a(e)}},function(e,t,n){var r=n(95),a=n(203);e.exports=function(e){return r((function(t,n){var r=-1,o=n.length,i=o>1?n[o-1]:void 0,s=o>2?n[2]:void 0;for(i=e.length>3&&"function"==typeof i?(o--,i):void 0,s&&a(n[0],n[1],s)&&(i=o<3?void 0:i,o=1),t=Object(t);++r<o;){var c=n[r];c&&e(t,c,r,i)}return t}))}},function(e,t,n){var r=n(70),a=n(197),o=n(199);e.exports=function(e,t){return o(a(e,t,r),e+"")}},function(e,t,n){var r=n(76),a=n(204),o=n(207),i=n(77),s=n(208),c=n(60);e.exports=function(e,t,n){var u=-1,l=a,f=e.length,p=!0,h=[],y=h;if(n)p=!1,l=o;else if(f>=200){var d=t?null:s(e);if(d)return c(d);p=!1,l=i,y=new r}else y=t?[]:h;e:for(;++u<f;){var v=e[u],b=t?t(v):v;if(v=n||0!==v?v:0,p&&b==b){for(var m=y.length;m--;)if(y[m]===b)continue e;t&&y.push(b),h.push(v)}else l(y,b,n)||(y!==h&&y.push(b),h.push(v))}return h}},function(e,t,n){var r=n(86),a=n(205),o=n(206);e.exports=function(e,t,n){return t==t?o(e,t,n):r(e,a,n)}},function(e,t,n){(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,a=Function.prototype.apply;function o(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new o(a.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new o(a.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},n(210),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(41))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return v}));var r=n(0),a=n.n(r),o=n(10),i=n(22);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function u(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){c(o,r,a,i,s,"next",e)}function s(e){c(o,r,a,i,s,"throw",e)}i(void 0)}))}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t,n){return(p="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function y(e,t){return(y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(t){function n(t){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),r=function(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?f(e):t}(this,h(n).call(this)),d(f(r),"application",void 0),d(f(r),"unsubApp",void 0),r.application=t,e((function(){r.addAppEventObserver()})),r}var r,o,c,v,b,m;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&y(e,t)}(n,t),r=n,(o=[{key:"deinit",value:function(){this.application=void 0,this.unsubApp(),this.unsubApp=void 0,p(h(n.prototype),"deinit",this).call(this)}},{key:"addAppEventObserver",value:function(){var e=this;this.application.isStarted()&&this.onAppStart(),this.application.isLaunched()&&this.onAppLaunch(),this.unsubApp=this.application.addEventObserver(function(){var t=u(a.a.mark((function t(n){return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.onAppEvent(n),n!==i.a.Started){t.next=6;break}return t.next=4,e.onAppStart();case 4:t.next=12;break;case 6:if(n!==i.a.Launched){t.next=11;break}return t.next=9,e.onAppLaunch();case 9:t.next=12;break;case 11:n===i.a.CompletedSync?e.onAppSync():n===i.a.KeyStatusChanged&&e.onAppKeyChange();case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"onAppEvent",value:function(e){}},{key:"onAppStart",value:(m=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return m.apply(this,arguments)})},{key:"onAppLaunch",value:(b=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return b.apply(this,arguments)})},{key:"onAppKeyChange",value:(v=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return v.apply(this,arguments)})},{key:"onAppSync",value:function(){}}])&&l(r.prototype,o),c&&l(r,c),n}(o.a)}).call(this,n(98).setImmediate)},function(e,t,n){var r=n(87),a=n(94)((function(e,t,n,a){r(e,t,n,a)}));e.exports=a},function(e,t,n){var r=n(96);e.exports=function(e,t){return t="function"==typeof t?t:void 0,e&&e.length?r(e,void 0,t):[]}},function(e,t,n){var r=n(95)(n(212));e.exports=r},function(e,t,n){(function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n=function(e){"use strict";var n=Object.prototype,r=n.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function c(e,t,n,r){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new S(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(a,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===a)throw o;return P()}for(n.method=a,n.arg=o;;){var i=n.delegate;if(i){var s=w(i,n);if(s){if(s===l)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var c=u(e,t,n);if("normal"===c.type){if(r=n.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r="completed",n.method="throw",n.arg=c.arg)}}}(e,n,i),o}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function h(){}var y={};y[o]=function(){return this};var d=Object.getPrototypeOf,v=d&&d(d(O([])));v&&v!==n&&r.call(v,o)&&(y=v);var b=h.prototype=f.prototype=Object.create(y);function m(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function g(e,n){var a;this._invoke=function(o,i){function s(){return new n((function(a,s){!function a(o,i,s,c){var l=u(e[o],e,i);if("throw"!==l.type){var f=l.arg,p=f.value;return p&&"object"===t(p)&&r.call(p,"__await")?n.resolve(p.__await).then((function(e){a("next",e,s,c)}),(function(e){a("throw",e,s,c)})):n.resolve(p).then((function(e){f.value=e,s(f)}),(function(e){return a("throw",e,s,c)}))}c(l.arg)}(o,i,a,s)}))}return a=a?a.then(s,s):s()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=u(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var a=r.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:P}}function P(){return{value:void 0,done:!0}}return p.prototype=b.constructor=h,h.constructor=p,h[s]=p.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},m(g.prototype),g.prototype[i]=function(){return this},e.AsyncIterator=g,e.async=function(t,n,r,a,o){void 0===o&&(o=Promise);var i=new g(c(t,n,r,a),o);return e.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},m(b),b[s]="Generator",b[o]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=O,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return i.type="throw",i.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),x(n),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;x(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:O(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},e}("object"===t(e)?e.exports:{});try{regeneratorRuntime=n}catch(e){Function("r","regeneratorRuntime = r")(n)}}).call(this,n(36)(e))},function(e,t,n){var r=n(105),a=n(158),o=n(84);e.exports=function(e){var t=a(e);return 1==t.length&&t[0][2]?o(t[0][0],t[0][1]):function(n){return n===e||r(n,e,t)}}},function(e,t,n){var r=n(56),a=n(74);e.exports=function(e,t,n,o){var i=n.length,s=i,c=!o;if(null==e)return!s;for(e=Object(e);i--;){var u=n[i];if(c&&u[2]?u[1]!==e[u[0]]:!(u[0]in e))return!1}for(;++i<s;){var l=(u=n[i])[0],f=e[l],p=u[1];if(c&&u[2]){if(void 0===f&&!(l in e))return!1}else{var h=new r;if(o)var y=o(f,p,l,e,t,h);if(!(void 0===y?a(p,f,3,o,h):y))return!1}}return!0}},function(e,t){e.exports=function(){this.__data__=[],this.size=0}},function(e,t,n){var r=n(43),a=Array.prototype.splice;e.exports=function(e){var t=this.__data__,n=r(t,e);return!(n<0)&&(n==t.length-1?t.pop():a.call(t,n,1),--this.size,!0)}},function(e,t,n){var r=n(43);e.exports=function(e){var t=this.__data__,n=r(t,e);return n<0?void 0:t[n][1]}},function(e,t,n){var r=n(43);e.exports=function(e){return r(this.__data__,e)>-1}},function(e,t,n){var r=n(43);e.exports=function(e,t){var n=this.__data__,a=r(n,e);return a<0?(++this.size,n.push([e,t])):n[a][1]=t,this}},function(e,t,n){var r=n(42);e.exports=function(){this.__data__=new r,this.size=0}},function(e,t){e.exports=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}},function(e,t){e.exports=function(e){return this.__data__.get(e)}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t,n){var r=n(42),a=n(57),o=n(59);e.exports=function(e,t){var n=this.__data__;if(n instanceof r){var i=n.__data__;if(!a||i.length<199)return i.push([e,t]),this.size=++n.size,this;n=this.__data__=new o(i)}return n.set(e,t),this.size=n.size,this}},function(e,t,n){var r=n(58),a=n(119),o=n(28),i=n(73),s=/^\[object .+?Constructor\]$/,c=Function.prototype,u=Object.prototype,l=c.toString,f=u.hasOwnProperty,p=RegExp("^"+l.call(f).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!o(e)||a(e))&&(r(e)?p:s).test(i(e))}},function(e,t,n){var r=n(44),a=Object.prototype,o=a.hasOwnProperty,i=a.toString,s=r?r.toStringTag:void 0;e.exports=function(e){var t=o.call(e,s),n=e[s];try{e[s]=void 0;var r=!0}catch(e){}var a=i.call(e);return r&&(t?e[s]=n:delete e[s]),a}},function(e,t){var n=Object.prototype.toString;e.exports=function(e){return n.call(e)}},function(e,t,n){var r,a=n(120),o=(r=/[^.]+$/.exec(a&&a.keys&&a.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"";e.exports=function(e){return!!o&&o in e}},function(e,t,n){var r=n(27)["__core-js_shared__"];e.exports=r},function(e,t){e.exports=function(e,t){return null==e?void 0:e[t]}},function(e,t,n){var r=n(123),a=n(42),o=n(57);e.exports=function(){this.size=0,this.__data__={hash:new r,map:new(o||a),string:new r}}},function(e,t,n){var r=n(124),a=n(125),o=n(126),i=n(127),s=n(128);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,n){var r=n(45);e.exports=function(){this.__data__=r?r(null):{},this.size=0}},function(e,t){e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},function(e,t,n){var r=n(45),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(r){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return a.call(t,e)?t[e]:void 0}},function(e,t,n){var r=n(45),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return r?void 0!==t[e]:a.call(t,e)}},function(e,t,n){var r=n(45);e.exports=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=r&&void 0===t?"__lodash_hash_undefined__":t,this}},function(e,t,n){var r=n(46);e.exports=function(e){var t=r(this,e).delete(e);return this.size-=t?1:0,t}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=n(e);return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},function(e,t,n){var r=n(46);e.exports=function(e){return r(this,e).get(e)}},function(e,t,n){var r=n(46);e.exports=function(e){return r(this,e).has(e)}},function(e,t,n){var r=n(46);e.exports=function(e,t){var n=r(this,e),a=n.size;return n.set(e,t),this.size+=n.size==a?0:1,this}},function(e,t,n){var r=n(56),a=n(75),o=n(138),i=n(140),s=n(154),c=n(23),u=n(63),l=n(64),f="[object Object]",p=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,h,y,d){var v=c(e),b=c(t),m=v?"[object Array]":s(e),g=b?"[object Array]":s(t),w=(m="[object Arguments]"==m?f:m)==f,k=(g="[object Arguments]"==g?f:g)==f,x=m==g;if(x&&u(e)){if(!u(t))return!1;v=!0,w=!1}if(x&&!w)return d||(d=new r),v||l(e)?a(e,t,n,h,y,d):o(e,t,m,n,h,y,d);if(!(1&n)){var S=w&&p.call(e,"__wrapped__"),O=k&&p.call(t,"__wrapped__");if(S||O){var P=S?e.value():e,j=O?t.value():t;return d||(d=new r),y(P,j,n,h,d)}}return!!x&&(d||(d=new r),i(e,t,n,h,y,d))}},function(e,t){e.exports=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t){e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}},function(e,t,n){var r=n(44),a=n(78),o=n(37),i=n(75),s=n(139),c=n(60),u=r?r.prototype:void 0,l=u?u.valueOf:void 0;e.exports=function(e,t,n,r,u,f,p){switch(n){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!f(new a(e),new a(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return o(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var h=s;case"[object Set]":var y=1&r;if(h||(h=c),e.size!=t.size&&!y)return!1;var d=p.get(e);if(d)return d==t;r|=2,p.set(e,t);var v=i(h(e),h(t),r,u,f,p);return p.delete(e),v;case"[object Symbol]":if(l)return l.call(e)==l.call(t)}return!1}},function(e,t){e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}},function(e,t,n){var r=n(141),a=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,o,i,s){var c=1&n,u=r(e),l=u.length;if(l!=r(t).length&&!c)return!1;for(var f=l;f--;){var p=u[f];if(!(c?p in t:a.call(t,p)))return!1}var h=s.get(e);if(h&&s.get(t))return h==t;var y=!0;s.set(e,t),s.set(t,e);for(var d=c;++f<l;){var v=e[p=u[f]],b=t[p];if(o)var m=c?o(b,v,p,t,e,s):o(v,b,p,e,t,s);if(!(void 0===m?v===b||i(v,b,n,o,s):m)){y=!1;break}d||(d="constructor"==p)}if(y&&!d){var g=e.constructor,w=t.constructor;g!=w&&"constructor"in e&&"constructor"in t&&!("function"==typeof g&&g instanceof g&&"function"==typeof w&&w instanceof w)&&(y=!1)}return s.delete(e),s.delete(t),y}},function(e,t,n){var r=n(142),a=n(144),o=n(61);e.exports=function(e){return r(e,o,a)}},function(e,t,n){var r=n(143),a=n(23);e.exports=function(e,t,n){var o=t(e);return a(e)?o:r(o,n(e))}},function(e,t){e.exports=function(e,t){for(var n=-1,r=t.length,a=e.length;++n<r;)e[a+n]=t[n];return e}},function(e,t,n){var r=n(145),a=n(146),o=Object.prototype.propertyIsEnumerable,i=Object.getOwnPropertySymbols,s=i?function(e){return null==e?[]:(e=Object(e),r(i(e),(function(t){return o.call(e,t)})))}:a;e.exports=s},function(e,t){e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length,a=0,o=[];++n<r;){var i=e[n];t(i,n,e)&&(o[a++]=i)}return o}},function(e,t){e.exports=function(){return[]}},function(e,t){e.exports=function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}},function(e,t,n){var r=n(33),a=n(31);e.exports=function(e){return a(e)&&"[object Arguments]"==r(e)}},function(e,t){e.exports=function(){return!1}},function(e,t,n){var r=n(33),a=n(65),o=n(31),i={};i["[object Float32Array]"]=i["[object Float64Array]"]=i["[object Int8Array]"]=i["[object Int16Array]"]=i["[object Int32Array]"]=i["[object Uint8Array]"]=i["[object Uint8ClampedArray]"]=i["[object Uint16Array]"]=i["[object Uint32Array]"]=!0,i["[object Arguments]"]=i["[object Array]"]=i["[object ArrayBuffer]"]=i["[object Boolean]"]=i["[object DataView]"]=i["[object Date]"]=i["[object Error]"]=i["[object Function]"]=i["[object Map]"]=i["[object Number]"]=i["[object Object]"]=i["[object RegExp]"]=i["[object Set]"]=i["[object String]"]=i["[object WeakMap]"]=!1,e.exports=function(e){return o(e)&&a(e.length)&&!!i[r(e)]}},function(e,t,n){(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(72),o="object"==r(t)&&t&&!t.nodeType&&t,i=o&&"object"==r(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o&&a.process,c=function(){try{var e=i&&i.require&&i.require("util").types;return e||s&&s.binding&&s.binding("util")}catch(e){}}();e.exports=c}).call(this,n(36)(e))},function(e,t,n){var r=n(66),a=n(153),o=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return a(e);var t=[];for(var n in Object(e))o.call(e,n)&&"constructor"!=n&&t.push(n);return t}},function(e,t,n){var r=n(81)(Object.keys,Object);e.exports=r},function(e,t,n){var r=n(155),a=n(57),o=n(156),i=n(82),s=n(157),c=n(33),u=n(73),l=u(r),f=u(a),p=u(o),h=u(i),y=u(s),d=c;(r&&"[object DataView]"!=d(new r(new ArrayBuffer(1)))||a&&"[object Map]"!=d(new a)||o&&"[object Promise]"!=d(o.resolve())||i&&"[object Set]"!=d(new i)||s&&"[object WeakMap]"!=d(new s))&&(d=function(e){var t=c(e),n="[object Object]"==t?e.constructor:void 0,r=n?u(n):"";if(r)switch(r){case l:return"[object DataView]";case f:return"[object Map]";case p:return"[object Promise]";case h:return"[object Set]";case y:return"[object WeakMap]"}return t}),e.exports=d},function(e,t,n){var r=n(30)(n(27),"DataView");e.exports=r},function(e,t,n){var r=n(30)(n(27),"Promise");e.exports=r},function(e,t,n){var r=n(30)(n(27),"WeakMap");e.exports=r},function(e,t,n){var r=n(83),a=n(61);e.exports=function(e){for(var t=a(e),n=t.length;n--;){var o=t[n],i=e[o];t[n]=[o,i,r(i)]}return t}},function(e,t,n){var r=n(74),a=n(160),o=n(166),i=n(69),s=n(83),c=n(84),u=n(39);e.exports=function(e,t){return i(e)&&s(t)?c(u(e),t):function(n){var i=a(n,e);return void 0===i&&i===t?o(n,e):r(t,i,3)}}},function(e,t,n){var r=n(67);e.exports=function(e,t,n){var a=null==e?void 0:r(e,t);return void 0===a?n:a}},function(e,t,n){var r=n(162),a=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,o=/\\(\\)?/g,i=r((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(a,(function(e,n,r,a){t.push(r?a.replace(o,"$1"):n||e)})),t}));e.exports=i},function(e,t,n){var r=n(163);e.exports=function(e){var t=r(e,(function(e){return 500===n.size&&n.clear(),e})),n=t.cache;return t}},function(e,t,n){var r=n(59);function a(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function n(){var r=arguments,a=t?t.apply(this,r):r[0],o=n.cache;if(o.has(a))return o.get(a);var i=e.apply(this,r);return n.cache=o.set(a,i)||o,i};return n.cache=new(a.Cache||r),n}a.Cache=r,e.exports=a},function(e,t,n){var r=n(165);e.exports=function(e){return null==e?"":r(e)}},function(e,t,n){var r=n(44),a=n(85),o=n(23),i=n(48),s=r?r.prototype:void 0,c=s?s.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(o(t))return a(t,e)+"";if(i(t))return c?c.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n}},function(e,t,n){var r=n(167),a=n(168);e.exports=function(e,t){return null!=e&&a(e,t,r)}},function(e,t){e.exports=function(e,t){return null!=e&&t in Object(e)}},function(e,t,n){var r=n(68),a=n(62),o=n(23),i=n(47),s=n(65),c=n(39);e.exports=function(e,t,n){for(var u=-1,l=(t=r(t,e)).length,f=!1;++u<l;){var p=c(t[u]);if(!(f=null!=e&&n(e,p)))break;e=e[p]}return f||++u!=l?f:!!(l=null==e?0:e.length)&&s(l)&&i(p,l)&&(o(e)||a(e))}},function(e,t,n){var r=n(170),a=n(171),o=n(69),i=n(39);e.exports=function(e){return o(e)?r(i(e)):a(e)}},function(e,t){e.exports=function(e){return function(t){return null==t?void 0:t[e]}}},function(e,t,n){var r=n(67);e.exports=function(e){return function(t){return r(t,e)}}},function(e,t,n){var r=n(173),a=n(47),o=Array.prototype.splice;e.exports=function(e,t){for(var n=e?t.length:0,i=n-1;n--;){var s=t[n];if(n==i||s!==c){var c=s;a(s)?o.call(e,s,1):r(e,s)}}return e}},function(e,t,n){var r=n(68),a=n(174),o=n(175),i=n(39);e.exports=function(e,t){return t=r(t,e),null==(e=o(e,t))||delete e[i(a(t))]}},function(e,t){e.exports=function(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}},function(e,t,n){var r=n(67),a=n(176);e.exports=function(e,t){return t.length<2?e:r(e,a(t,0,-1))}},function(e,t){e.exports=function(e,t,n){var r=-1,a=e.length;t<0&&(t=-t>a?0:a+t),(n=n>a?a:n)<0&&(n+=a),a=t>n?0:n-t>>>0,t>>>=0;for(var o=Array(a);++r<a;)o[r]=e[r+t];return o}},function(e,t,n){var r=n(55),a=n(38),o=n(61);e.exports=function(e){return function(t,n,i){var s=Object(t);if(!a(t)){var c=r(n,3);t=o(t),n=function(e){return c(s[e],e,s)}}var u=e(t,n,i);return u>-1?s[c?t[u]:u]:void 0}}},function(e,t,n){var r=n(86),a=n(55),o=n(179),i=Math.max;e.exports=function(e,t,n){var s=null==e?0:e.length;if(!s)return-1;var c=null==n?0:o(n);return c<0&&(c=i(s+c,0)),r(e,a(t,3),c)}},function(e,t,n){var r=n(180);e.exports=function(e){var t=r(e),n=t%1;return t==t?n?t-n:t:0}},function(e,t,n){var r=n(181);e.exports=function(e){return e?(e=r(e))===1/0||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},function(e,t,n){var r=n(28),a=n(48),o=/^\s+|\s+$/g,i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,c=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(a(e))return NaN;if(r(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=r(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(o,"");var n=s.test(e);return n||c.test(e)?u(e.slice(2),n?2:8):i.test(e)?NaN:+e}},function(e,t,n){var r=n(183)();e.exports=r},function(e,t){e.exports=function(e){return function(t,n,r){for(var a=-1,o=Object(t),i=r(t),s=i.length;s--;){var c=i[e?s:++a];if(!1===n(o[c],c,o))break}return t}}},function(e,t,n){var r=n(88),a=n(185),o=n(186),i=n(90),s=n(188),c=n(62),u=n(23),l=n(190),f=n(63),p=n(58),h=n(28),y=n(191),d=n(64),v=n(92),b=n(192);e.exports=function(e,t,n,m,g,w,k){var x=v(e,n),S=v(t,n),O=k.get(S);if(O)r(e,n,O);else{var P=w?w(x,S,n+"",e,t,k):void 0,j=void 0===P;if(j){var _=u(S),C=!_&&f(S),D=!_&&!C&&d(S);P=S,_||C||D?u(x)?P=x:l(x)?P=i(x):C?(j=!1,P=a(S,!0)):D?(j=!1,P=o(S,!0)):P=[]:y(S)||c(S)?(P=x,c(x)?P=b(x):h(x)&&!p(x)||(P=s(S))):j=!1}j&&(k.set(S,P),g(P,S,m,w,k),k.delete(S)),r(e,n,P)}}},function(e,t,n){(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(27),o="object"==r(t)&&t&&!t.nodeType&&t,i=o&&"object"==r(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o?a.Buffer:void 0,c=s?s.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,r=c?c(n):new e.constructor(n);return e.copy(r),r}}).call(this,n(36)(e))},function(e,t,n){var r=n(187);e.exports=function(e,t){var n=t?r(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}},function(e,t,n){var r=n(78);e.exports=function(e){var t=new e.constructor(e.byteLength);return new r(t).set(new r(e)),t}},function(e,t,n){var r=n(189),a=n(91),o=n(66);e.exports=function(e){return"function"!=typeof e.constructor||o(e)?{}:r(a(e))}},function(e,t,n){var r=n(28),a=Object.create,o=function(){function e(){}return function(t){if(!r(t))return{};if(a)return a(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();e.exports=o},function(e,t,n){var r=n(38),a=n(31);e.exports=function(e){return a(e)&&r(e)}},function(e,t,n){var r=n(33),a=n(91),o=n(31),i=Function.prototype,s=Object.prototype,c=i.toString,u=s.hasOwnProperty,l=c.call(Object);e.exports=function(e){if(!o(e)||"[object Object]"!=r(e))return!1;var t=a(e);if(null===t)return!0;var n=u.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&c.call(n)==l}},function(e,t,n){var r=n(193),a=n(93);e.exports=function(e){return r(e,a(e))}},function(e,t,n){var r=n(194),a=n(71);e.exports=function(e,t,n,o){var i=!n;n||(n={});for(var s=-1,c=t.length;++s<c;){var u=t[s],l=o?o(n[u],e[u],u,n,e):void 0;void 0===l&&(l=e[u]),i?a(n,u,l):r(n,u,l)}return n}},function(e,t,n){var r=n(71),a=n(37),o=Object.prototype.hasOwnProperty;e.exports=function(e,t,n){var i=e[t];o.call(e,t)&&a(i,n)&&(void 0!==n||t in e)||r(e,t,n)}},function(e,t,n){var r=n(28),a=n(66),o=n(196),i=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return o(e);var t=a(e),n=[];for(var s in e)("constructor"!=s||!t&&i.call(e,s))&&n.push(s);return n}},function(e,t){e.exports=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t}},function(e,t,n){var r=n(198),a=Math.max;e.exports=function(e,t,n){return t=a(void 0===t?e.length-1:t,0),function(){for(var o=arguments,i=-1,s=a(o.length-t,0),c=Array(s);++i<s;)c[i]=o[t+i];i=-1;for(var u=Array(t+1);++i<t;)u[i]=o[i];return u[t]=n(c),r(e,this,u)}}},function(e,t){e.exports=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}},function(e,t,n){var r=n(200),a=n(202)(r);e.exports=a},function(e,t,n){var r=n(201),a=n(89),o=n(70),i=a?function(e,t){return a(e,"toString",{configurable:!0,enumerable:!1,value:r(t),writable:!0})}:o;e.exports=i},function(e,t){e.exports=function(e){return function(){return e}}},function(e,t){var n=Date.now;e.exports=function(e){var t=0,r=0;return function(){var a=n(),o=16-(a-r);if(r=a,o>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(37),o=n(38),i=n(47),s=n(28);e.exports=function(e,t,n){if(!s(n))return!1;var c=r(t);return!!("number"==c?o(n)&&i(t,n.length):"string"==c&&t in n)&&a(n[t],e)}},function(e,t,n){var r=n(97);e.exports=function(e,t){return!!(null==e?0:e.length)&&r(e,t,0)>-1}},function(e,t){e.exports=function(e){return e!=e}},function(e,t){e.exports=function(e,t,n){for(var r=n-1,a=e.length;++r<a;)if(e[r]===t)return r;return-1}},function(e,t){e.exports=function(e,t,n){for(var r=-1,a=null==e?0:e.length;++r<a;)if(n(t,e[r]))return!0;return!1}},function(e,t,n){var r=n(82),a=n(209),o=n(60),i=r&&1/o(new r([,-0]))[1]==1/0?function(e){return new r(e)}:a;e.exports=i},function(e,t){e.exports=function(){}},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var r,a,o,i,s,c=1,u={},l=!1,f=e.document,p=Object.getPrototypeOf&&Object.getPrototypeOf(e);p=p&&p.setTimeout?p:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick((function(){y(e)}))}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((o=new MessageChannel).port1.onmessage=function(e){y(e.data)},r=function(e){o.port2.postMessage(e)}):f&&"onreadystatechange"in f.createElement("script")?(a=f.documentElement,r=function(e){var t=f.createElement("script");t.onreadystatechange=function(){y(e),t.onreadystatechange=null,a.removeChild(t),t=null},a.appendChild(t)}):r=function(e){setTimeout(y,0,e)}:(i="setImmediate$"+Math.random()+"$",s=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(i)&&y(+t.data.slice(i.length))},e.addEventListener?e.addEventListener("message",s,!1):e.attachEvent("onmessage",s),r=function(t){e.postMessage(i+t,"*")}),p.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var a={callback:e,args:t};return u[c]=a,r(c),c++},p.clearImmediate=h}function h(e){delete u[e]}function y(e){if(l)setTimeout(y,0,e);else{var t=u[e];if(t){l=!0;try{!function(e){var t=e.callback,n=e.args;switch(n.length){case 0:t();break;case 1:t(n[0]);break;case 2:t(n[0],n[1]);break;case 3:t(n[0],n[1],n[2]);break;default:t.apply(void 0,n)}}(t)}finally{h(e),l=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(41),n(211))},function(e,t){var n,r,a=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function s(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:i}catch(e){r=i}}();var c,u=[],l=!1,f=-1;function p(){l&&c&&(l=!1,c.length?u=c.concat(u):f=-1,u.length&&h())}function h(){if(!l){var e=s(p);l=!0;for(var t=u.length;t;){for(c=u,u=[];++f<t;)c&&c[f].run();f=-1,t=u.length}c=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===i||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function y(e,t){this.fun=e,this.array=t}function d(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new y(e,t)),1!==u.length||l||s(h)},y.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=d,a.addListener=d,a.once=d,a.off=d,a.removeListener=d,a.removeAllListeners=d,a.emit=d,a.prependListener=d,a.prependOnceListener=d,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},function(e,t,n){var r=n(213);e.exports=function(e,t){return e&&e.length&&t&&t.length?r(e,t):e}},function(e,t,n){var r=n(85),a=n(97),o=n(214),i=n(80),s=n(90),c=Array.prototype.splice;e.exports=function(e,t,n,u){var l=u?o:a,f=-1,p=t.length,h=e;for(e===t&&(t=s(t)),n&&(h=r(e,i(n)));++f<p;)for(var y=0,d=t[f],v=n?n(d):d;(y=l(h,v,y,u))>-1;)h!==e&&c.call(h,y,1),c.call(e,y,1);return e}},function(e,t){e.exports=function(e,t,n,r){for(var a=n-1,o=e.length;++a<o;)if(r(e[a],t))return a;return-1}},function(e,t,n){"use strict";n.r(t),n.d(t,"SNApplication",(function(){return bi})),n.d(t,"SNProtocolService",(function(){return Xr})),n.d(t,"KeyMode",(function(){return Nr})),n.d(t,"SNProtocolOperator001",(function(){return Mn})),n.d(t,"SNProtocolOperator002",(function(){return Hn})),n.d(t,"SNProtocolOperator003",(function(){return Zn})),n.d(t,"SNProtocolOperator004",(function(){return ur})),n.d(t,"DeviceInterface",(function(){return ki})),n.d(t,"SNItem",(function(){return ze.i})),n.d(t,"ItemMutator",(function(){return ze.d})),n.d(t,"SNItemsKey",(function(){return ze.j})),n.d(t,"SNPredicate",(function(){return ze.l})),n.d(t,"SNNote",(function(){return ze.k})),n.d(t,"NoteMutator",(function(){return ze.e})),n.d(t,"SNTag",(function(){return ze.o})),n.d(t,"SNSmartTag",(function(){return ze.n})),n.d(t,"SNActionsExtension",(function(){return ze.f})),n.d(t,"Action",(function(){return ze.a})),n.d(t,"SNTheme",(function(){return ze.p})),n.d(t,"SNComponent",(function(){return ze.g})),n.d(t,"SNEditor",(function(){return ze.h})),n.d(t,"SNComponentManager",(function(){return ot})),n.d(t,"ComponentAction",(function(){return nt})),n.d(t,"HistorySession",(function(){return ya})),n.d(t,"ItemHistory",(function(){return fa})),n.d(t,"ItemHistoryEntry",(function(){return ta})),n.d(t,"SNPrivileges",(function(){return Da.d})),n.d(t,"ProtectedAction",(function(){return Da.c})),n.d(t,"PrivilegeCredential",(function(){return Da.a})),n.d(t,"SNWebCrypto",(function(){return dn.SNWebCrypto})),n.d(t,"PayloadManager",(function(){return _t})),n.d(t,"ItemManager",(function(){return no})),n.d(t,"SNHttpService",(function(){return yt})),n.d(t,"ChallengeService",(function(){return pi})),n.d(t,"PureService",(function(){return L.a})),n.d(t,"ApplicationService",(function(){return xi.a})),n.d(t,"SNStorageService",(function(){return J})),n.d(t,"StoragePersistencePolicies",(function(){return R})),n.d(t,"StorageEncryptionPolicies",(function(){return A})),n.d(t,"StorageValueModes",(function(){return M})),n.d(t,"ValueModesKeys",(function(){return T})),n.d(t,"Challenge",(function(){return _})),n.d(t,"ChallengeReason",(function(){return c})),n.d(t,"ChallengeResponse",(function(){return D})),n.d(t,"ChallengeType",(function(){return s})),n.d(t,"challengeTypeToString",(function(){return E})),n.d(t,"ChallengeValue",(function(){return C})),n.d(t,"SNSyncService",(function(){return $o})),n.d(t,"SyncSources",(function(){return Qo})),n.d(t,"SyncModes",(function(){return Go})),n.d(t,"SyncQueueStrategy",(function(){return Jo})),n.d(t,"SNSessionManager",(function(){return Se})),n.d(t,"SNMigrationService",(function(){return Ur})),n.d(t,"SNAlertService",(function(){return re})),n.d(t,"SNHistoryManager",(function(){return _a})),n.d(t,"SNPrivilegesService",(function(){return Ua})),n.d(t,"SNSingletonManager",(function(){return Ft})),n.d(t,"SNApiService",(function(){return Le})),n.d(t,"findInArray",(function(){return p.i})),n.d(t,"isNullOrUndefined",(function(){return p.m})),n.d(t,"deepMerge",(function(){return p.g})),n.d(t,"extendArray",(function(){return p.h})),n.d(t,"removeFromIndex",(function(){return p.y})),n.d(t,"subtractFromArray",(function(){return p.C})),n.d(t,"arrayByDifference",(function(){return p.c})),n.d(t,"uniqCombineObjArrays",(function(){return p.E})),n.d(t,"greaterOfTwoDates",(function(){return p.k})),n.d(t,"getGlobalScope",(function(){return p.j})),n.d(t,"removeFromArray",(function(){return p.x})),n.d(t,"truncateHexString",(function(){return p.D})),n.d(t,"jsonParseEmbeddedKeys",(function(){return p.r})),n.d(t,"Uuid",(function(){return f.a})),n.d(t,"EncryptionIntent",(function(){return K.a})),n.d(t,"isLocalStorageIntent",(function(){return K.e})),n.d(t,"isFileIntent",(function(){return K.d})),n.d(t,"isDecryptedIntent",(function(){return K.c})),n.d(t,"intentRequiresEncryption",(function(){return K.b})),n.d(t,"ContentType",(function(){return h.a})),n.d(t,"CreateItemFromPayload",(function(){return v.a})),n.d(t,"Uuids",(function(){return v.c})),n.d(t,"ApplicationEvents",(function(){return b.a})),n.d(t,"Environment",(function(){return o})),n.d(t,"Platform",(function(){return i})),n.d(t,"isEnvironmentWebOrDesktop",(function(){return w})),n.d(t,"isEnvironmentMobile",(function(){return k})),n.d(t,"platformFromString",(function(){return g})),n.d(t,"SyncEvents",(function(){return Ct.a})),n.d(t,"MutableCollection",(function(){return dt.b})),n.d(t,"ImmutablePayloadCollection",(function(){return dt.a})),n.d(t,"CreateMaxPayloadFromAnyObject",(function(){return y.e})),n.d(t,"CreateSourcedPayloadFromObject",(function(){return y.f})),n.d(t,"CreateIntentPayloadFromObject",(function(){return y.d})),n.d(t,"CreateEncryptionParameters",(function(){return y.c})),n.d(t,"CopyPayload",(function(){return y.b})),n.d(t,"PayloadSource",(function(){return d.a})),n.d(t,"isPayloadSourceRetrieved",(function(){return d.b})),n.d(t,"ProtocolVersion",(function(){return en.a})),n.d(t,"PayloadFormat",(function(){return yn.a})),n.d(t,"PurePayload",(function(){return Si.a})),n.d(t,"PayloadField",(function(){return Lo.a})),n.d(t,"StorageKey",(function(){return j})),n.d(t,"BaseMigration",(function(){return Er})),n.d(t,"PrivilegeSessionLength",(function(){return ja}));var r={};n.r(r),n.d(r,"Migration20200115",(function(){return kr}));var a,o,i,s,c,u=n(0),l=n.n(u),f=n(17),p=n(1),h=n(6),y=n(2),d=n(3),v=n(8),b=n(22);function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(e){return{"mac-web":i.MacWeb,"mac-desktop":i.MacDesktop,"linux-web":i.LinuxWeb,"linux-desktop":i.LinuxDesktop,"windows-web":i.WindowsWeb,"windows-desktop":i.WindowsDesktop,ios:i.Ios,android:i.Android}[e]}function w(e){return e===o.Web||e===o.Desktop}function k(e){return e===o.Mobile}function x(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function S(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function O(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.PreparingForLaunch_0=0]="PreparingForLaunch_0",e[e.ReadyForLaunch_05=.5]="ReadyForLaunch_05",e[e.StorageDecrypted_09=.9]="StorageDecrypted_09",e[e.Launched_10=1]="Launched_10",e[e.LoadingDatabase_11=1.1]="LoadingDatabase_11",e[e.LoadedDatabase_12=1.2]="LoadedDatabase_12",e[e.FullSyncCompleted_13=1.3]="FullSyncCompleted_13",e[e.SignedIn_30=3]="SignedIn_30"}(a||(a={})),function(e){e[e.Web=1]="Web",e[e.Desktop=2]="Desktop",e[e.Mobile=3]="Mobile"}(o||(o={})),function(e){e[e.Ios=1]="Ios",e[e.Android=2]="Android",e[e.MacWeb=3]="MacWeb",e[e.MacDesktop=4]="MacDesktop",e[e.WindowsWeb=5]="WindowsWeb",e[e.WindowsDesktop=6]="WindowsDesktop",e[e.LinuxWeb=7]="LinuxWeb",e[e.LinuxDesktop=8]="LinuxDesktop"}(i||(i={})),function(e){e[e.LocalPasscode=1]="LocalPasscode",e[e.AccountPassword=2]="AccountPassword",e[e.Biometric=3]="Biometric"}(s||(s={})),function(e){e[e.ApplicationUnlock=1]="ApplicationUnlock",e[e.ResaveRootKey=2]="ResaveRootKey",e[e.ProtocolUpgrade=3]="ProtocolUpgrade",e[e.Migration=4]="Migration"}(c||(c={}));var P,j,_=function e(t,n){S(this,e),O(this,"types",void 0),O(this,"reason",void 0),O(this,"id",void 0),this.types=t,this.reason=n,this.id=(new Date).getTime(),Object.freeze(this)},C=function e(t,n){S(this,e),O(this,"type",void 0),O(this,"value",void 0),this.type=t,this.value=n,Object.freeze(this)},D=function(){function e(t,n,r){S(this,e),O(this,"challenge",void 0),O(this,"values",void 0),O(this,"artifacts",void 0),this.challenge=t,this.values=n,this.artifacts=r,Object.freeze(this)}var t,n,r;return t=e,(n=[{key:"getValueForType",value:function(e){return this.values.find((function(t){return t.type===e}))}}])&&x(t.prototype,n),r&&x(t,r),e}();function E(e){var t;return(O(t={},s.LocalPasscode,"application passcode"),O(t,s.AccountPassword,"account password"),O(t,s.Biometric,"biometrics"),t)[e]}function I(e,t){return e?"".concat(e,"-").concat(t):t}!function(e){e.StorageObject="storage",e.LastMigrationTimestamp="last_migration_timestamp"}(P||(P={})),function(e){e.RootKeyParams="ROOT_KEY_PARAMS",e.WrappedRootKey="WRAPPED_ROOT_KEY",e.RootKeyWrapperKeyParams="ROOT_KEY_WRAPPER_KEY_PARAMS",e.Session="session",e.User="user",e.ServerHost="server",e.LegacyUuid="uuid",e.LastSyncToken="syncToken",e.PaginationToken="cursorToken",e.BiometricPrefs="biometrics_prefs",e.MobilePasscodeTiming="passcode_timing",e.PrivilegesExpirey="SessionExpiresAtKey",e.PrivilegesSessionLength="SessionLengthKey",e.SessionHistoryPersistable="sessionHistory_persist",e.SessionHistoryRevisions="sessionHistory_revisions",e.SessionHistoryOptimize="sessionHistory_autoOptimize"}(j||(j={}));var R,A,M,T,K=n(15),L=n(10),F=n(5);function V(e){return(V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function N(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function U(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){N(o,r,a,i,s,"next",e)}function s(e){N(o,r,a,i,s,"throw",e)}i(void 0)}))}}function B(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function W(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function H(e,t,n){return(H="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=z(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function z(e){return(z=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function q(e,t){return(q=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.Default=1]="Default",e[e.Ephemeral=2]="Ephemeral"}(R||(R={})),function(e){e[e.Default=1]="Default",e[e.Disabled=2]="Disabled"}(A||(A={})),function(e){e[e.Default=1]="Default",e[e.Nonwrapped=2]="Nonwrapped"}(M||(M={})),function(e){e.Wrapped="wrapped",e.Unwrapped="unwrapped",e.Nonwrapped="nonwrapped"}(T||(T={}));var J=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==V(t)&&"function"!=typeof t?W(e):t}(this,z(t).call(this)),Y(W(r),"encryptionDelegate",void 0),Y(W(r),"namespace",void 0),Y(W(r),"storagePersistable",!1),Y(W(r),"persistencePolicy",void 0),Y(W(r),"encryptionPolicy",void 0),Y(W(r),"values",void 0),r.deviceInterface=e,r.namespace=n,r.setPersistencePolicy(R.Default),r.setEncryptionPolicy(A.Default),r}var n,r,o,i,s,c,u,y,d,v,b,m,g,w,k,x,S,O,j,_,C,D,E,L;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&q(e,t)}(t,e),n=t,r=[{key:"deinit",value:function(){this.deviceInterface=void 0,this.encryptionDelegate=void 0,H(z(t.prototype),"deinit",this).call(this)}},{key:"handleApplicationStage",value:(L=U(l.a.mark((function e(n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,H(z(t.prototype),"handleApplicationStage",this).call(this,n);case 2:n===a.Launched_10&&(this.storagePersistable=!0);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return L.apply(this,arguments)})},{key:"setPersistencePolicy",value:(E=U(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy=t,this.persistencePolicy!==R.Ephemeral){e.next=6;break}return e.next=4,this.deviceInterface.removeAllRawStorageValues();case 4:return e.next=6,this.clearAllPayloads();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"setEncryptionPolicy",value:(D=U(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.encryptionPolicy=t;case 1:case"end":return e.stop()}}),e,this)}))),function(e){return D.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.persistencePolicy===R.Ephemeral}},{key:"initializeFromDisk",value:(C=U(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getRawStorageValue(this.getPersistenceKey());case 2:t=e.sent,n=t?JSON.parse(t):null,this.setInitialValues(n);case 5:case"end":return e.stop()}}),e,this)}))),function(){return C.apply(this,arguments)})},{key:"persistAsValueToDisk",value:(_=U(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.setRawStorageValue(this.getPersistenceKey(),JSON.stringify(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"setInitialValues",value:function(e){e||(e=this.defaultValuesObject()),e[T.Unwrapped]||(e[T.Unwrapped]={}),this.values=e}},{key:"isStorageWrapped",value:function(){var e=this.values[T.Wrapped];return!Object(p.m)(e)&&Object.keys(e).length>0}},{key:"canDecryptWithKey",value:(j=U(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.values[T.Wrapped],e.next=3,this.decryptWrappedValue(n,t);case 3:return r=e.sent,e.abrupt("return",!r.errorDecrypting);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return j.apply(this,arguments)})},{key:"decryptWrappedValue",value:(O=U(l.a.mark((function e(t,n){var r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.content_type){e.next=2;break}throw"Attempting to decrypt nonexistent wrapped value";case 2:return r=Object(F.e)(t,void 0,void 0,{content_type:h.a.EncryptedStorage}),e.next=5,this.encryptionDelegate.payloadByDecryptingPayload(r,n);case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return O.apply(this,arguments)})},{key:"decryptStorage",value:(S=U(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.values[T.Wrapped],e.next=3,this.decryptWrappedValue(t);case 3:if(!(n=e.sent).errorDecrypting){e.next=6;break}throw"Unable to decrypt storage.";case 6:this.values[T.Unwrapped]=Object(p.a)(n.contentObject),delete this.values[T.Wrapped];case 8:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"generatePersistenceValue",value:(x=U(l.a.mark((function e(){var t,n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object.assign({},this.values),n=t[T.Unwrapped],e.t0=F.e,e.next=5,f.a.GenerateUuid();case 5:return e.t1=e.sent,e.t2=n,e.t3=h.a.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},r=(0,e.t0)(e.t4),e.next=12,this.encryptionDelegate.payloadByEncryptingPayload(r,K.a.LocalStoragePreferEncrypted);case 12:return a=e.sent,t[T.Wrapped]=a,t[T.Unwrapped]=void 0,e.abrupt("return",t);case 16:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"repersistToDisk",value:(k=U(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.storagePersistable){e.next=2;break}return e.abrupt("return");case 2:if(this.persistencePolicy!==R.Ephemeral){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,this.generatePersistenceValue();case 6:return t=e.sent,this.values[T.Wrapped]=t[T.Wrapped],e.abrupt("return",this.persistAsValueToDisk(t));case 9:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"setValue",value:(w=U(l.a.mark((function e(t,n){var r,a=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>2&&void 0!==a[2]?a[2]:M.Default,this.values){e.next=3;break}throw"Attempting to set storage key ".concat(t," before loading local storage.");case 3:return this.values[this.domainKeyForMode(r)][t]=n,e.abrupt("return",this.repersistToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return w.apply(this,arguments)})},{key:"getValue",value:(g=U(l.a.mark((function e(t){var n,r=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:M.Default,this.values){e.next=3;break}throw"Attempting to get storage key ".concat(t," before loading local storage.");case 3:if(this.values[this.domainKeyForMode(n)]){e.next=5;break}throw"Storage domain mode not available ".concat(n," for key ").concat(t);case 5:return e.abrupt("return",this.values[this.domainKeyForMode(n)][t]);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"removeValue",value:(m=U(l.a.mark((function e(t){var n,r=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:M.Default,this.values){e.next=3;break}throw"Attempting to remove storage key ".concat(t," before loading local storage.");case 3:return delete this.values[this.domainKeyForMode(n)][t],e.abrupt("return",this.repersistToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"getPersistenceKey",value:function(){return I(this.namespace,P.StorageObject)}},{key:"defaultValuesObject",value:function(e,n,r){return t.defaultValuesObject(e,n,r)}},{key:"domainKeyForMode",value:function(e){if(e===M.Default)return T.Unwrapped;if(e===M.Nonwrapped)return T.Nonwrapped;throw"Invalid mode"}},{key:"clearValues",value:(b=U(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setInitialValues(),e.next=3,this.repersistToDisk();case 3:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"getAllRawPayloads",value:(v=U(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.getAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"savePayload",value:(d=U(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.savePayloads([t]));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"savePayloads",value:(y=U(l.a.mark((function e(t){var n,r,a,o,i,s,c,u,f;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy!==R.Ephemeral){e.next=2;break}return e.abrupt("return");case 2:n=[],r=[],a=!0,o=!1,i=void 0,e.prev=7,s=t[Symbol.iterator]();case 9:if(a=(c=s.next()).done){e.next=24;break}if(!(u=c.value).discardable){e.next=15;break}n.push(u),e.next=21;break;case 15:if(u.uuid){e.next=17;break}throw Error("Attempting to persist payload with no uuid");case 17:return e.next=19,this.encryptionDelegate.payloadByEncryptingPayload(u,this.encryptionPolicy===A.Default?K.a.LocalStoragePreferEncrypted:K.a.LocalStorageDecrypted);case 19:f=e.sent,r.push(f);case 21:a=!0,e.next=9;break;case 24:e.next=30;break;case 26:e.prev=26,e.t0=e.catch(7),o=!0,i=e.t0;case 30:e.prev=30,e.prev=31,a||null==s.return||s.return();case 33:if(e.prev=33,!o){e.next=36;break}throw i;case 36:return e.finish(33);case 37:return e.finish(30);case 38:if(!(n.length>0)){e.next=41;break}return e.next=41,this.deletePayloads(n);case 41:return e.next=43,this.deviceInterface.saveRawDatabasePayloads(r);case 43:case"end":return e.stop()}}),e,this,[[7,26,30,38],[31,,33,37]])}))),function(e){return y.apply(this,arguments)})},{key:"deletePayloads",value:(u=U(l.a.mark((function e(t){var n,r,a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,r=!1,a=void 0,e.prev=3,o=t[Symbol.iterator]();case 5:if(n=(i=o.next()).done){e.next=12;break}return s=i.value,e.next=9,this.deletePayloadWithId(s.uuid);case 9:n=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,a=e.t0;case 18:e.prev=18,e.prev=19,n||null==o.return||o.return();case 21:if(e.prev=21,!r){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return u.apply(this,arguments)})},{key:"deletePayloadWithId",value:(c=U(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.removeRawDatabasePayloadWithId(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"clearAllPayloads",value:(s=U(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.removeAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"clearAllData",value:(i=U(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([this.clearValues(),this.clearAllPayloads()]));case 1:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})}],o=[{key:"defaultValuesObject",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return Y(e={},T.Wrapped,t),Y(e,T.Unwrapped,n),Y(e,T.Nonwrapped,r),e}}],r&&B(n.prototype,r),o&&B(n,o),t}(L.a);function G(e){return(G="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Q(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function $(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Q(o,r,a,i,s,"next",e)}function s(e){Q(o,r,a,i,s,"throw",e)}i(void 0)}))}}function X(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Z(e,t){return!t||"object"!==G(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ee(e,t,n){return(ee="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=te(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function te(e){return(te=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ne(e,t){return(ne=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var re=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=Z(this,te(t).call(this))).deviceInterface=e,n}var n,r,a,o,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ne(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.deviceInterface=void 0,ee(te(t.prototype),"deinit",this).call(this)}},{key:"alert",value:(i=$(l.a.mark((function e(t,n,r,a){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){window.alert(t),e()})));case 1:case"end":return e.stop()}}),e)}))),function(e,t,n,r){return i.apply(this,arguments)})},{key:"confirm",value:(o=$(l.a.mark((function e(t,n,r,a,o,i,s){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){window.confirm(t)?e():n()})));case 1:case"end":return e.stop()}}),e)}))),function(e,t,n,r,a,i,s){return o.apply(this,arguments)})}])&&X(n.prototype,r),a&&X(n,a),t}(L.a);function ae(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var oe=function(){var e,t,n;function r(e){var t,n,a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),a=void 0,(n="token")in(t=this)?Object.defineProperty(t,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[n]=a,this.token=e}return e=r,n=[{key:"FromRaw",value:function(e){return new r(e.token)}}],(t=null)&&ae(e.prototype,t),n&&ae(e,n),r}(),ie="This version of the application does not support your\n                                                      newer account type. Please upgrade to the latest version\n                                                      of Standard Notes to sign in.",se="The protocol version associated with your account is\n                                                      outdated and no longer supported by this application.\n                                                      Please visit standardnotes.org/help/security for more\n                                                      information.",ce="The encryption version for your account is outdated and\n                                                      requires upgrade. You may proceed with login, but are\n                                                      advised to perform a security update using the web or\n                                                      desktop application. Please visit\n                                                      standardnotes.org/help/security for more information.",ue="Your account was created on a platform with higher security\n                                                      capabilities than this browser supports. If we attempted\n                                                      to generate your login keys here, it would take hours. Please\n                                                      use a browser with more up to date security capabilities,\n                                                      like Google Chrome or Firefox, to log in.",le="Unable to login due to insecure password parameters.\n                                                      Please visit standardnotes.org/help/security for\n                                                      more information.";function fe(e){return"\n          Your password must be at least ".concat(e," characters in length.\n          For your security, please choose a longer password or,\n          ideally, a passphrase, and try again.\n         ")}function pe(e,t){return"\n          Strict Sign In has refused the server's sign-in parameters.\n          The latest account version is ".concat(t,", but the server is reporting a \n          version of ").concat(e," for your account. If you'd like to proceed\n          with sign in anyway, please disable Strict Sign In and try again.\n          ")}function he(e){return(he="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ye(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function de(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ye(o,r,a,i,s,"next",e)}function s(e){ye(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ve(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function be(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function me(e,t,n){return(me="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ge(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ge(e){return(ge=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function we(e,t){return(we=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ke(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var xe,Se=function(e){function t(e,n,r,a){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),o=function(e,t){return!t||"object"!==he(t)&&"function"!=typeof t?be(e):t}(this,ge(t).call(this)),ke(be(o),"storageService",void 0),ke(be(o),"apiService",void 0),ke(be(o),"alertService",void 0),ke(be(o),"protocolService",void 0),ke(be(o),"user",void 0),ke(be(o),"session",void 0),o.protocolService=a,o.storageService=e,o.apiService=n,o.alertService=r,o}var n,r,a,o,i,s,c,u,f,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&we(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.alertService=void 0,this.user=void 0,this.session=void 0,me(ge(t.prototype),"deinit",this).call(this)}},{key:"initializeFromDisk",value:(h=de(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(j.User);case 2:if(this.user=e.sent,this.user){e.next=8;break}return e.next=6,this.storageService.getValue(j.LegacyUuid);case 6:(t=e.sent)&&(this.user={uuid:t});case 8:return e.next=10,this.storageService.getValue(j.Session);case 10:if(!(n=e.sent)){e.next=14;break}return e.next=14,this.setSession(oe.FromRaw(n));case 14:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"setSession",value:(f=de(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.session=t,this.apiService.setSession(this.session);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"online",value:function(){return!this.offline()}},{key:"offline",value:function(){return Object(p.m)(this.session)}},{key:"getUser",value:function(){return this.user}},{key:"signOut",value:(u=de(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.user=void 0,this.session=void 0;case 2:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"register",value:(c=de(l.a.mark((function e(t,n){var r,a,o,i,s=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n.length<8)){e.next=2;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(fe(8))});case 2:return e.next=4,this.protocolService.createRootKey(t,n);case 4:return r=e.sent,a=r.key.serverPassword,o=r.keyParams,i=r.key,e.abrupt("return",this.apiService.register(t,a,o).then(function(){var e=de(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:o,rootKey:i});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"signIn",value:(s=de(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f,p,h,y,d,v=this,b=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=b.length>2&&void 0!==b[2]&&b[2],a=b.length>3?b[3]:void 0,o=b.length>4?b[4]:void 0,e.next=5,this.apiService.getAccountKeyParams(t,a,o);case 5:if(!(i=e.sent).error){e.next=8;break}return e.abrupt("return",{response:i});case 8:if(s={pw_cost:i.pw_cost,pw_nonce:i.pw_nonce,identifier:i.identifier,email:i.email,pw_salt:i.pw_salt,version:i.version},(c=this.protocolService.createKeyParams(s))&&c.version){e.next=12;break}return e.abrupt("return",{response:this.apiService.createErrorResponse("Invalid email or password.")});case 12:if(this.protocolService.supportedVersions().includes(c.version)){e.next=18;break}if(!this.protocolService.isVersionNewerThanLibraryVersion(c.version)){e.next=17;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(ie)});case 17:return e.abrupt("return",{response:this.apiService.createErrorResponse(se)});case 18:if(!this.protocolService.isProtocolVersionOutdated(c.version)){e.next=29;break}if(u=this.protocolService.costMinimumForVersion(c.version),!(c.kdfIterations<u)){e.next=22;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(le)});case 22:return f=ce,e.next=26,this.alertService.confirm(f,"Update Recommended","Sign In").catch((function(){}));case 26:if(e.sent){e.next=29;break}return e.abrupt("return",{response:this.apiService.createErrorResponse("Invalid email or password.")});case 29:if(this.protocolService.platformSupportsKeyDerivation(c)){e.next=31;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(ue)});case 31:if(!r){e.next=35;break}if(p=this.protocolService.getLatestVersion(),c.version===p){e.next=35;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(pe(c.version,p))});case 35:return e.next=37,this.protocolService.computeRootKey(n,c).then((function(e){return{rootKey:e,serverPassword:e.serverPassword}}));case 37:return h=e.sent,y=h.rootKey,d=h.serverPassword,e.abrupt("return",this.apiService.signIn(t,d,a,o).then(function(){var e=de(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:c,rootKey:y});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 41:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"changePassword",value:(i=de(l.a.mark((function e(t,n,r){var a,o,i,s,c,u,f=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r.length<8)){e.next=2;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(fe(8))});case 2:return e.next=4,this.protocolService.computeRootKey(t,n).then((function(e){return e.serverPassword}));case 4:return a=e.sent,o=this.user.email,e.next=8,this.protocolService.createRootKey(o,r).then((function(e){return{newRootKey:e.key,newServerPassword:e.key.serverPassword,newKeyParams:e.keyParams}}));case 8:return i=e.sent,s=i.newServerPassword,c=i.newRootKey,u=i.newKeyParams,e.abrupt("return",this.apiService.changePassword(a,s,u).then(function(){var e=de(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:u,rootKey:c});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return i.apply(this,arguments)})},{key:"handleAuthResponse",value:(o=de(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.error){e.next=2;break}return e.abrupt("return");case 2:return n=t.user,this.user=n,e.next=6,this.storageService.setValue(j.User,n);case 6:return r=new oe(t.token),e.next=9,this.storageService.setValue(j.Session,r);case 9:return e.next=11,this.setSession(r);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})}])&&ve(n.prototype,r),a&&ve(n,a),t}(L.a),Oe=n(53),Pe=n.n(Oe);function je(e){return(je="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ce(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_e(Object(n),!0).forEach((function(t){Ke(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_e(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function De(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ee(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){De(o,r,a,i,s,"next",e)}function s(e){De(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Ie(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Re(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ae(e,t,n){return(Ae="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Me(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Me(e){return(Me=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Te(e,t){return(Te=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ke(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.LastSyncToken="sync_token",e.PaginationToken="cursor_token",e.IntegrityCheck="compute_integrity",e.IntegrityResult="integrity_hash",e.SyncDlLimit="limit",e.SyncPayloads="items",e.ApiVersion="api"}(xe||(xe={}));var Le=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==je(t)&&"function"!=typeof t?Re(e):t}(this,Me(t).call(this)),Ke(Re(r),"httpService",void 0),Ke(Re(r),"storageService",void 0),Ke(Re(r),"host",void 0),Ke(Re(r),"session",void 0),Ke(Re(r),"registering",!1),Ke(Re(r),"authenticating",!1),Ke(Re(r),"changing",!1),r.httpService=e,r.storageService=n,r}var n,r,a,o,i,s,c,u,f,h,y,d;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Te(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.httpService=void 0,this.storageService=void 0,this.host=void 0,this.session=void 0,Ae(Me(t.prototype),"deinit",this).call(this)}},{key:"loadHost",value:(d=Ee(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(j.ServerHost);case 2:t=e.sent,this.host=t||window._default_sync_server;case 4:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"setHost",value:(y=Ee(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.host=t,e.next=3,this.storageService.setValue(j.ServerHost,t);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"getHost",value:(h=Ee(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.host);case 1:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"setSession",value:function(e){this.session=e}},{key:"path",value:(f=Ee(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getHost();case 2:if(n=e.sent){e.next=5;break}throw"Attempting to build path ".concat(t," with no host.");case 5:if(t){e.next=7;break}throw"Attempting to build path with null path.";case 7:return e.abrupt("return",Object(p.q)(n,t));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"params",value:function(e){var t=Pe()(e,Ke({},xe.ApiVersion,"20200115"));return t}},{key:"createErrorResponse",value:function(e){return{error:{message:e}}}},{key:"errorResponseWithFallbackMessage",value:function(e,t){return e.error.message||(e.error.message=t),e}},{key:"getAccountKeyParams",value:(u=Ee(l.a.mark((function e(t,n,r){var a,o,i,s=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.path("/auth/params");case 2:return a=e.sent,o=this.params({email:t}),n&&(o[n]=r),e.next=7,this.httpService.getAbsolute(a,o).catch((function(e){return s.errorResponseWithFallbackMessage(e,"A server error occurred while trying to sign in. Please try again.")}));case 7:return i=e.sent,e.abrupt("return",i);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"register",value:(c=Ee(l.a.mark((function e(t,n,r){var a,o,i,s=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.registering){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing registration request is already in progress."));case 2:return this.registering=!0,e.next=5,this.path("/auth");case 5:return a=e.sent,o=this.params(Ce({password:n,email:t},r.getPortableValue())),e.next=9,this.httpService.postAbsolute(a,o).catch((function(e){return s.errorResponseWithFallbackMessage(e,"A server error occurred while trying to register. Please try again.")}));case 9:return i=e.sent,this.registering=!1,e.abrupt("return",i);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"signIn",value:(s=Ee(l.a.mark((function e(t,n,r,a){var o,i,s,c=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.authenticating){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing sign in request is already in progress."));case 2:return this.authenticating=!0,e.next=5,this.path("/auth/sign_in");case 5:return o=e.sent,i=this.params({email:t,password:n}),r&&(i[r]=a),e.next=10,this.httpService.postAbsolute(o,i).catch((function(e){return c.errorResponseWithFallbackMessage(e,"A server error occurred while trying to sign in. Please try again.")}));case 10:return s=e.sent,this.authenticating=!1,e.abrupt("return",s);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return s.apply(this,arguments)})},{key:"changePassword",value:(i=Ee(l.a.mark((function e(t,n,r){var a,o,i,s=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.changing){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing change password request is already in progress."));case 2:return this.changing=!0,e.next=5,this.path("/auth/change_pw");case 5:return a=e.sent,o=Ce({current_password:t,new_password:n},r.getPortableValue()),e.next=9,this.httpService.postAbsolute(a,o,this.session.token).catch((function(e){return s.errorResponseWithFallbackMessage(e,"Something went wrong while changing your password.\n                                                      Your password was not changed. Please try again.")}));case 9:return i=e.sent,this.changing=!1,e.abrupt("return",i);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return i.apply(this,arguments)})},{key:"sync",value:(o=Ee(l.a.mark((function e(t,n,r,a){var o,i,s,c,u,f,p,h=this,y=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=y.length>4&&void 0!==y[4]&&y[4],s=y.length>5?y[5]:void 0,c=y.length>6?y[6]:void 0,e.next=5,this.path("/items/sync");case 5:return u=e.sent,f=this.params((Ke(o={},xe.SyncPayloads,t),Ke(o,xe.LastSyncToken,n),Ke(o,xe.PaginationToken,r),Ke(o,xe.IntegrityCheck,i),Ke(o,xe.SyncDlLimit,a),Ke(o,"content_type",s),Ke(o,"event",c),o)),e.next=9,this.httpService.postAbsolute(u,f,this.session.token).catch((function(e){return h.errorResponseWithFallbackMessage(e,"Could not connect to server.")}));case 9:return p=e.sent,e.abrupt("return",p);case 11:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return o.apply(this,arguments)})}])&&Ie(n.prototype,r),a&&Ie(n,a),t}(L.a),Fe=n(7),Ve=n(26),Ne=n.n(Ve),Ue=n(32),Be=n.n(Ue),We=n(29),He=n.n(We),ze=n(9),qe=n(16);function Ye(e){return(Ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Je(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ge(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Je(o,r,a,i,s,"next",e)}function s(e){Je(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Qe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function $e(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Xe(e,t,n){return(Xe="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ze(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ze(e){return(Ze=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function et(e,t){return(et=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function tt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var nt;!function(e){e.SetSize="set-size",e.StreamItems="stream-items",e.StreamContextItem="stream-context-item",e.SaveItems="save-items",e.SelectItem="select-item",e.AssociateItem="associate-item",e.DeassociateItem="deassociate-item",e.ClearSelection="clear-selection",e.CreateItem="create-item",e.CreateItems="create-items",e.DeleteItems="delete-items",e.SetComponentData="set-component-data",e.InstallLocalComponent="install-local-component",e.ToggleActivateComponent="toggle-activate-component",e.RequestPermissions="request-permissions",e.PresentConflictResolution="present-conflict-resolution",e.DuplicateItem="duplicate-item",e.ComponentRegistered="component-registered",e.ActivateThemes="themes",e.Reply="reply",e.SaveSuccess="save-success",e.SaveError="save-error"}(nt||(nt={}));var rt,at="org.standardnotes.sn.components",ot=function(e){function t(e,n,r,a,i,s,c){var u;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u=function(e,t){return!t||"object"!==Ye(t)&&"function"!=typeof t?$e(e):t}(this,Ze(t).call(this)),tt($e(u),"itemManager",void 0),tt($e(u),"modelManager",void 0),tt($e(u),"syncService",void 0),tt($e(u),"alertService",void 0),tt($e(u),"environment",void 0),tt($e(u),"platform",void 0),tt($e(u),"timeout",void 0),tt($e(u),"desktopManager",void 0),tt($e(u),"componentState",{}),tt($e(u),"removeItemObserver",void 0),tt($e(u),"streamObservers",[]),tt($e(u),"contextStreamObservers",[]),tt($e(u),"activeComponents",[]),tt($e(u),"permissionDialogs",[]),tt($e(u),"handlers",[]),tt($e(u),"detectFocusChange",(function(){var e=!0,t=!1,n=void 0;try{for(var r,a=function(){var e=r.value;if(document.activeElement===u.iframeForComponent(e))return u.timeout((function(){u.focusChangedForComponent(e)})),"break"},o=u.activeComponents[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){if("break"===a())break}}catch(e){t=!0,n=e}finally{try{e||null==o.return||o.return()}finally{if(t)throw n}}})),tt($e(u),"onWindowMessage",(function(e){u.log("Web app: received message",e),e.data.sessionKey&&u.handleMessage(u.componentForSessionKey(e.data.sessionKey),e.data)})),u.timeout=c||setTimeout.bind(window),u.itemManager=e,u.modelManager=n,u.syncService=r,u.alertService=a,u.environment=i,u.platform=s,u.configureForGeneralUsage(),i!==o.Mobile&&u.configureForNonMobileUsage(),u}var n,r,a,s,c,u,h,y,d,v,b;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&et(e,t)}(t,e),n=t,(r=[{key:"componentsForArea",value:function(e){return this.components.filter((function(t){return t.area===e}))}},{key:"deinit",value:function(){Xe(Ze(t.prototype),"deinit",this).call(this),this.streamObservers.length=0,this.contextStreamObservers.length=0,this.activeComponents.length=0,this.permissionDialogs.length=0,this.handlers.length=0,this.itemManager=void 0,this.modelManager=void 0,this.syncService=void 0,this.alertService=void 0,this.removeItemObserver(),this.removeItemObserver=null,window&&(window.removeEventListener("focus",this.detectFocusChange,!0),window.removeEventListener("blur",this.detectFocusChange,!0),window.removeEventListener("message",this.onWindowMessage))}},{key:"setDesktopManager",value:function(e){this.desktopManager=e,this.configureForDesktop()}},{key:"configureForGeneralUsage",value:function(){var e=this;this.removeItemObserver=this.itemManager.addObserver(ze.b.Any,function(){var t=Ge(l.a.mark((function t(n,r,a,o,i){var s,c,u,f,h,y,d,v,b;return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:s=Object(p.e)(n,r,a),(c=s.filter((function(e){return e.content_type===ze.b.Component||e.content_type===ze.b.Theme}))).length>0&&o!==F.k.RemoteSaved&&e.isDesktop&&e.desktopManager.syncComponentsInstallation(c),u=!0,f=!1,h=void 0,t.prev=6,y=c[Symbol.iterator]();case 8:if(u=(d=y.next()).done){t.next=22;break}if(v=d.value,b=Ne()(e.activeComponents,{uuid:v.uuid}),!v.active||v.deleted||b){t.next=16;break}return t.next=14,e.activateComponent(v);case 14:t.next=19;break;case 16:if(v.active||!b){t.next=19;break}return t.next=19,e.deactivateComponent(v);case 19:u=!0,t.next=8;break;case 22:t.next=28;break;case 24:t.prev=24,t.t0=t.catch(6),f=!0,h=t.t0;case 28:t.prev=28,t.prev=29,u||null==y.return||y.return();case 31:if(t.prev=31,!f){t.next=34;break}throw h;case 34:return t.finish(31);case 35:return t.finish(28);case 36:o!==F.k.LocalChanged&&e.notifyStreamObservers(s,o,i);case 37:case"end":return t.stop()}}),t,null,[[6,24,28,36],[29,,31,35]])})));return function(e,n,r,a,o){return t.apply(this,arguments)}}())}},{key:"notifyStreamObservers",value:function(e,t,n){var r=this,a=!0,o=!1,i=void 0;try{for(var s,c=function(){var t=s.value;if(n&&n===t.component.uuid)return"continue";var a=e.filter((function(e){return-1!==t.contentTypes.indexOf(e.content_type)}));if(0===a.length)return"continue";var o=[{name:nt.StreamItems,content_types:t.contentTypes.sort()}];r.runWithPermissions(t.component,o,(function(){r.sendItemsInReply(t.component,a,t.originalMessage)}))},u=this.streamObservers[Symbol.iterator]();!(a=(s=u.next()).done);a=!0)c()}catch(e){o=!0,i=e}finally{try{a||null==u.return||u.return()}finally{if(o)throw i}}var l=[{name:nt.StreamContextItem}],f=!0,p=!1,h=void 0;try{for(var y,d=function(){var a=y.value;if(n&&n===a.component.uuid)return"continue";var o=!0,i=!1,s=void 0;try{for(var c,u=r.handlers[Symbol.iterator]();!(o=(c=u.next()).done);o=!0){var f=c.value;if((f.areas.includes(a.component.area)||f.areas.includes(qe.a.Any))&&f.contextRequestHandler){var p=f.contextRequestHandler(a.component);if(p&&"continue"===function(){var n=Ne()(e,{uuid:p.uuid});if(n){if(n.deleted)return"continue";r.runWithPermissions(a.component,l,(function(){r.sendContextItemInReply(a.component,n,a.originalMessage,t)}))}}())continue}}}catch(e){i=!0,s=e}finally{try{o||null==u.return||u.return()}finally{if(i)throw s}}},v=this.contextStreamObservers[Symbol.iterator]();!(f=(y=v.next()).done);f=!0)d()}catch(e){p=!0,h=e}finally{try{f||null==v.return||v.return()}finally{if(p)throw h}}}},{key:"isNativeExtension",value:function(e){var t=[window._extensions_manager_location,window._batch_manager_location],n=e.hosted_url,r=e.local_url&&e.local_url.replace("sn://","");return t.includes(n)||t.includes(r)}},{key:"configureForNonMobileUsage",value:function(){window.addEventListener?window.addEventListener("focus",this.detectFocusChange,!0):window.attachEvent("onfocusout",this.detectFocusChange),window.addEventListener?window.addEventListener("blur",this.detectFocusChange,!0):window.attachEvent("onblur",this.detectFocusChange),window.addEventListener("message",this.onWindowMessage)}},{key:"configureForDesktop",value:function(){var e=this;this.desktopManager.registerUpdateObserver((function(t){t.active&&t.isTheme()&&e.postActiveThemesToAllComponents()}))}},{key:"postActiveThemesToAllComponents",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,a=this.components[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=r.value,i=this.findOrCreateDataForComponent(o);!o.isTheme()&&o.active&&i.window&&this.postActiveThemesToComponent(o)}}catch(e){t=!0,n=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw n}}}},{key:"getActiveThemes",value:function(){return this.componentsForArea(qe.a.Themes).filter((function(e){return e.active}))}},{key:"urlsForActiveThemes",value:function(){var e=this.getActiveThemes(),t=[],n=!0,r=!1,a=void 0;try{for(var o,i=e[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value,c=this.urlForComponent(s);c&&t.push(c)}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}return t}},{key:"postActiveThemesToComponent",value:function(e){var t={themes:this.urlsForActiveThemes()},n={action:nt.ActivateThemes,data:t};this.sendMessageToComponent(e,n)}},{key:"contextItemDidChangeInArea",value:function(e){var t=!0,n=!1,r=void 0;try{for(var a,o=this.handlers[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;if(!1!==i.areas.includes(e)||i.areas.includes(qe.a.Any)){var s=this.contextStreamObservers.filter((function(t){return t.component.area===e})),c=!0,u=!1,l=void 0;try{for(var f,p=s[Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var h=f.value;if(i.contextRequestHandler){var y=i.contextRequestHandler(h.component);y&&this.sendContextItemInReply(h.component,y,h.originalMessage)}}}catch(e){u=!0,l=e}finally{try{c||null==p.return||p.return()}finally{if(u)throw l}}}}}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}}},{key:"setComponentHidden",value:function(e,t){var n=this.findOrCreateDataForComponent(e);if(t)n.hidden=!0;else if(n.hidden){n.hidden=!1;var r=Ne()(this.contextStreamObservers,{identifier:e.uuid});r&&this.handleStreamContextItemMessage(e,r.originalMessage);var a=Ne()(this.streamObservers,{identifier:e.uuid});a&&this.handleStreamItemsMessage(e,a.originalMessage)}}},{key:"jsonForItem",value:function(e,t,n){var r=n===F.k.RemoteSaved||n===F.k.LocalSaved,a=(e.getDomainData(at)||{})[t.getClientDataKey()],o={uuid:e.uuid,content_type:e.content_type,created_at:e.created_at,updated_at:e.updated_at,deleted:e.deleted,isMetadataUpdate:r,content:e.content,clientData:a};return this.removePrivatePropertiesFromResponseItems([o],t),o}},{key:"sendItemsInReply",value:function(e,t,n,r){var a=this;this.log("Web|componentManager|sendItemsInReply",e,t,n);var o={},i=t.map((function(t){return a.jsonForItem(t,e,r)}));o.items=i,this.replyToMessage(e,n,o)}},{key:"sendContextItemInReply",value:function(e,t,n,r){this.log("Web|componentManager|sendContextItemInReply",e,t,n);var a={item:this.jsonForItem(t,e,r)};this.replyToMessage(e,n,a)}},{key:"replyToMessage",value:function(e,t,n){var r={action:nt.Reply,original:t,data:n};this.sendMessageToComponent(e,r)}},{key:"sendMessageToComponent",value:function(e,t){var n=[nt.ComponentRegistered,nt.ActivateThemes],r=this.findOrCreateDataForComponent(e);if(!r.hidden||n.includes(t.action)){this.log("Web|sendMessageToComponent",e,t);var a=this.urlForComponent(e);a&&r.window||this.alertService.alert("Standard Notes is trying to communicate with ".concat(e.name,", \n        but an error is occurring. Please restart this extension and try again.")),a.startsWith("http")||a.startsWith("file")||(a=window.location.href+a),r.window.postMessage(this.isMobile?JSON.stringify(t):t,a)}else this.log("Component disabled for current item, ignoring messages.",e.name)}},{key:"urlForComponent",value:function(e){if(e.offlineOnly&&!this.isDesktop)return null;if(e.offlineOnly||this.isDesktop&&e.local_url)return e.local_url&&e.local_url.replace("sn://",this.desktopManager.getExtServerHost());var t=e.hosted_url||e.legacy_url;if(this.isMobile){var n=this.platform===i.Ios?"localhost":"10.0.2.2";t=t.replace("localhost",n).replace("sn.local",n)}return t}},{key:"componentForUrl",value:function(e){return this.components.filter((function(t){return t.hosted_url===e||t.legacy_url===e}))[0]}},{key:"componentForSessionKey",value:function(e){for(var t,n=this,r=function(){var r=o[a],i=n.componentState[r];if((null==i?void 0:i.sessionKey)===e)return t=n.components.find((function(e){return e.uuid===r})),"break"},a=0,o=Object.keys(this.componentState);a<o.length&&"break"!==r();a++);if(!t){var i=!0,s=!1,c=void 0;try{for(var u,l=this.handlers[Symbol.iterator]();!(i=(u=l.next()).done);i=!0){var f=u.value;if(f.componentForSessionKeyHandler&&(t=f.componentForSessionKeyHandler(e)))break}}catch(e){s=!0,c=e}finally{try{i||null==l.return||l.return()}finally{if(s)throw c}}}return t}},{key:"handleMessage",value:function(e,t){var n=this;if(!e)return this.log("Component not defined for message, returning",t),void this.alertService.alert("An extension is trying to communicate with Standard Notes,but there is an error establishing a bridge. Please restart the app and try again.");var r=[nt.SaveItems,nt.AssociateItem,nt.DeassociateItem,nt.CreateItem,nt.CreateItems,nt.DeleteItems,nt.SetComponentData];if(this.getReadonlyStateForComponent(e).readonly&&r.includes(t.action))this.alertService.alert("The extension ".concat(e.name," is trying to save, but it is in a locked state and cannot accept changes."));else{if(t.action===nt.StreamItems)this.handleStreamItemsMessage(e,t);else if(t.action===nt.StreamContextItem)this.handleStreamContextItemMessage(e,t);else if(t.action===nt.SetComponentData)this.handleSetComponentDataMessage(e,t);else if(t.action===nt.DeleteItems)this.handleDeleteItemsMessage(e,t);else if(t.action===nt.CreateItems||t.action===nt.CreateItem)this.handleCreateItemsMessage(e,t);else if(t.action===nt.SaveItems)this.handleSaveItemsMessage(e,t);else if(t.action===nt.ToggleActivateComponent){var a=this.itemManager.findItem(t.data.uuid);this.handleToggleComponentMessage(a,t)}else t.action===nt.RequestPermissions?this.handleRequestPermissionsMessage(e,t):t.action===nt.InstallLocalComponent?this.handleInstallLocalComponentMessage(e,t):t.action===nt.DuplicateItem&&this.handleDuplicateItemMessage(e,t);var o=!0,i=!1,s=void 0;try{for(var c,u=function(){var r=c.value;r.actionHandler&&(r.areas.includes(e.area)||r.areas.includes(qe.a.Any))&&n.timeout((function(){r.actionHandler(e,t.action,t.data)}))},l=this.handlers[Symbol.iterator]();!(o=(c=l.next()).done);o=!0)u()}catch(e){i=!0,s=e}finally{try{o||null==l.return||l.return()}finally{if(i)throw s}}}}},{key:"removePrivatePropertiesFromResponseItems",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t||!this.isNativeExtension(t)){var r=["autoupdateDisabled","permissions","active"];n&&(r=r.concat(["url","hosted_url","local_url"]));var a=!0,o=!1,i=void 0;try{for(var s,c=e[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var u=s.value,l=!0,f=!1,p=void 0;try{for(var h,y=r[Symbol.iterator]();!(l=(h=y.next()).done);l=!0){var d=h.value;delete u.content[d]}}catch(e){f=!0,p=e}finally{try{l||null==y.return||y.return()}finally{if(f)throw p}}}}catch(e){o=!0,i=e}finally{try{a||null==c.return||c.return()}finally{if(o)throw i}}}}},{key:"handleStreamItemsMessage",value:function(e,t){var n=this,r=[{name:nt.StreamItems,content_types:t.data.content_types.sort()}];this.runWithPermissions(e,r,(function(){Ne()(n.streamObservers,{identifier:e.uuid})||n.streamObservers.push({identifier:e.uuid,component:e,originalMessage:t,contentTypes:t.data.content_types});var r=[],a=!0,o=!1,i=void 0;try{for(var s,c=t.data.content_types[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var u=s.value;Object(p.h)(r,r.concat(n.itemManager.validItemsForContentType(u)))}}catch(e){o=!0,i=e}finally{try{a||null==c.return||c.return()}finally{if(o)throw i}}n.sendItemsInReply(e,r,t)}))}},{key:"handleStreamContextItemMessage",value:function(e,t){var n=this,r=[{name:nt.StreamContextItem}];this.runWithPermissions(e,r,(function(){Ne()(n.contextStreamObservers,{identifier:e.uuid})||n.contextStreamObservers.push({identifier:e.uuid,component:e,originalMessage:t});var r=!0,a=!1,o=void 0;try{for(var i,s=n.handlersForArea(e.area)[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var c=i.value;if(c.contextRequestHandler){var u=c.contextRequestHandler(e);u&&n.sendContextItemInReply(e,u,t)}}}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}}))}},{key:"isItemIdWithinComponentContextJurisdiction",value:function(e,t){return this.itemIdsInContextJurisdictionForComponent(t).includes(e)}},{key:"itemIdsInContextJurisdictionForComponent",value:function(e){var t=[],n=!0,r=!1,a=void 0;try{for(var o,i=this.handlersForArea(e.area)[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value;if(s.contextRequestHandler){var c=s.contextRequestHandler(e);c&&t.push(c.uuid)}}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}return t}},{key:"handlersForArea",value:function(e){return this.handlers.filter((function(t){return t.areas.includes(e)}))}},{key:"handleSaveItemsMessage",value:(b=Ge(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f,h,y,d,v=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=n.data.items,a=[],o=this.itemIdsInContextJurisdictionForComponent(t),i=r.slice(),s=!0,c=!1,u=void 0,e.prev=7,f=r.slice()[Symbol.iterator]();case 9:if(s=(h=f.next()).done){e.next=18;break}if(y=h.value,!o.includes(y.uuid)){e.next=15;break}return a.push({name:nt.StreamContextItem}),Object(p.x)(i,y),e.abrupt("break",18);case 15:s=!0,e.next=9;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(7),c=!0,u=e.t0;case 24:e.prev=24,e.prev=25,s||null==f.return||f.return();case 27:if(e.prev=27,!c){e.next=30;break}throw u;case 30:return e.finish(27);case 31:return e.finish(24);case 32:i.length>0&&(d=Be()(i.map((function(e){return e.content_type}))).sort(),a.push({name:nt.StreamItems,content_types:d})),this.runWithPermissions(t,a,Ge(l.a.mark((function e(){var a,o,i,s,c,u;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(v.removePrivatePropertiesFromResponseItems(r,t,!0),a=r.map((function(e){return e.uuid})),o=v.itemManager.findItems(a,!0),i=0,o.forEach((function(e,n){if(e)e.locked&&(He()(r,{uuid:e.uuid}),i++);else{var a=r[n];v.alertService.alert("The extension ".concat(t.name," is trying to save an item with type ")+"".concat(a.content_type,", but that item does not exist .")+"Please restart this extension and try again.")}})),!(i>0)){e.next=10;break}return s=1===i?"item":"items",c=1===i?"is":"are",v.alertService.alert("".concat(i," ").concat(s," you are attempting to save ").concat(c," locked and cannot be edited."),"Items Locked"),e.abrupt("return");case 10:return u=r.map((function(e){return Object(F.f)(e,F.k.ComponentRetrieved)})),e.next=13,v.itemManager.changeItems(a,(function(e){var n=Object(p.z)(r,{uuid:e.getUuid()}),a=Object(p.z)(u,{uuid:e.getUuid()});if(e.mergePayload(a),n.clientData){var o=e.getItem().getDomainData(at);o[t.getClientDataKey()]=n.clientData,e.setDomainData(o,at)}}),Fe.c.UserInteraction,F.k.ComponentRetrieved,t.uuid);case 13:v.syncService.sync().then((function(){var e=Object.assign({},n);e.action=nt.SaveSuccess,v.replyToMessage(t,n,{}),v.handleMessage(t,e)})).catch((function(){var e=Object.assign({},n);e.action=nt.SaveError,v.replyToMessage(t,n,{error:nt.SaveError}),v.handleMessage(t,e)}));case 14:case"end":return e.stop()}}),e)}))));case 34:case"end":return e.stop()}}),e,this,[[7,20,24,32],[25,,27,31]])}))),function(e,t){return b.apply(this,arguments)})},{key:"handleDuplicateItemMessage",value:function(e,t){var n=this,r=t.data.item,a=this.itemManager.findItem(r.uuid),o=[{name:nt.StreamItems,content_types:[a.content_type]}];this.runWithPermissions(e,o,Ge(l.a.mark((function r(){var o;return l.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.itemManager.duplicateItem(a.uuid);case 2:o=r.sent,n.syncService.sync(),n.replyToMessage(e,t,{item:n.jsonForItem(o,e)});case 5:case"end":return r.stop()}}),r)}))))}},{key:"handleCreateItemsMessage",value:function(e,t){var n=this,r=t.data.item?[t.data.item]:t.data.items,a=Be()(r.map((function(e){return e.content_type}))),o=[{name:nt.StreamItems,content_types:a}];this.runWithPermissions(e,o,Ge(l.a.mark((function a(){var o,i,s,c,u,f,p,h;return l.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:n.removePrivatePropertiesFromResponseItems(r,e),o=[],i=!0,s=!1,c=void 0,a.prev=5,u=l.a.mark((function t(){var r,a,i,s;return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=p.value,a=Object(F.f)(r,F.k.RemoteRetrieved),i=Object(ze.c)(a),t.next=5,n.itemManager.insertItem(i);case 5:return s=t.sent,t.next=8,n.itemManager.changeItem(s.uuid,(function(t){if(r.clientData){var n=s.getDomainData(at);n[e.getClientDataKey()]=r.clientData,t.setDomainData(n,at)}}),Fe.c.UserInteraction,F.k.ComponentRetrieved,e.uuid);case 8:o.push(s);case 9:case"end":return t.stop()}}),t)})),f=r[Symbol.iterator]();case 8:if(i=(p=f.next()).done){a.next=13;break}return a.delegateYield(u(),"t0",10);case 10:i=!0,a.next=8;break;case 13:a.next=19;break;case 15:a.prev=15,a.t1=a.catch(5),s=!0,c=a.t1;case 19:a.prev=19,a.prev=20,i||null==f.return||f.return();case 22:if(a.prev=22,!s){a.next=25;break}throw c;case 25:return a.finish(22);case 26:return a.finish(19);case 27:n.syncService.sync(),h=t.action===nt.CreateItem?{item:n.jsonForItem(o[0],e)}:{items:o.map((function(t){return n.jsonForItem(t,e)}))},n.replyToMessage(e,t,h);case 30:case"end":return a.stop()}}),a,null,[[5,15,19,27],[20,,22,26]])}))))}},{key:"handleDeleteItemsMessage",value:function(e,t){var n=this,r=Be()(t.data.items.map((function(e){return e.content_type}))).sort(),a=[{name:nt.StreamItems,content_types:r}];this.runWithPermissions(e,a,Ge(l.a.mark((function r(){var a,o,i,s,c,u,f,p,h,y,d;return l.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=t.data.items,o=1===a.length?"item":"items",i=null,s=!0,r.next=6,n.alertService.confirm("Are you sure you want to delete ".concat(a.length," ").concat(o,"?")).catch((function(){s=!1}));case 6:if(!s){r.next=44;break}c=!0,u=!1,f=void 0,r.prev=10,p=a[Symbol.iterator]();case 12:if(c=(h=p.next()).done){r.next=26;break}if(y=h.value,d=n.itemManager.findItem(y.uuid)){r.next=18;break}return n.alertService.alert("The item you are trying to delete cannot be found."),r.abrupt("continue",23);case 18:if(![ze.b.Component,ze.b.Theme].includes(d.content_type)){r.next=21;break}return r.next=21,n.deactivateComponent(d,!0);case 21:return r.next=23,n.itemManager.setItemToBeDeleted(d.uuid);case 23:c=!0,r.next=12;break;case 26:r.next=32;break;case 28:r.prev=28,r.t0=r.catch(10),u=!0,f=r.t0;case 32:r.prev=32,r.prev=33,c||null==p.return||p.return();case 35:if(r.prev=35,!u){r.next=38;break}throw f;case 38:return r.finish(35);case 39:return r.finish(32);case 40:n.syncService.sync(),i={deleted:!0},r.next=45;break;case 44:i={deleted:!1};case 45:n.replyToMessage(e,t,i);case 46:case"end":return r.stop()}}),r,null,[[10,28,32,40],[33,,35,39]])}))))}},{key:"handleRequestPermissionsMessage",value:function(e,t){var n=this;this.runWithPermissions(e,t.data.permissions,(function(){n.replyToMessage(e,t,{approved:!0})}))}},{key:"handleSetComponentDataMessage",value:function(e,t){var n=this;this.runWithPermissions(e,[],Ge(l.a.mark((function r(){return l.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.itemManager.changeComponent(e.uuid,(function(e){e.componentData=t.data.componentData}));case 2:n.syncService.sync();case 3:case"end":return r.stop()}}),r)}))))}},{key:"handleToggleComponentMessage",value:function(e,t){this.toggleComponent(e)}},{key:"toggleComponent",value:(v=Ge(l.a.mark((function e(t){var n,r,a=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.area!==qe.a.Modal){e.next=4;break}this.openModalComponent(t),e.next=19;break;case 4:if(!t.active){e.next=9;break}return e.next=7,this.deactivateComponent(t);case 7:e.next=19;break;case 9:if(t.content_type!==ze.b.Theme){e.next=17;break}return n=t,r=this.getActiveThemes(),e.next=14,this.activateComponent(t);case 14:n.isLayerable()||setTimeout(Ge(l.a.mark((function e(){var t,n,o,i,s,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,n=!1,o=void 0,e.prev=3,i=r[Symbol.iterator]();case 5:if(t=(s=i.next()).done){e.next=13;break}if(!(c=s.value)||c.isLayerable()){e.next=10;break}return e.next=10,a.deactivateComponent(c);case 10:t=!0,e.next=5;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(3),n=!0,o=e.t0;case 19:e.prev=19,e.prev=20,t||null==i.return||i.return();case 22:if(e.prev=22,!n){e.next=25;break}throw o;case 25:return e.finish(22);case 26:return e.finish(19);case 27:case"end":return e.stop()}}),e,null,[[3,15,19,27],[20,,22,26]])}))),10),e.next=19;break;case 17:return e.next=19,this.activateComponent(t);case 19:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"handleInstallLocalComponentMessage",value:function(e,t){if(this.isNativeExtension(e)){var n=this.itemManager.findItem(t.data.uuid);this.desktopManager.installComponent(n)}}},{key:"runWithPermissions",value:function(e,t,n){t=Object(p.a)(t);var r=e.permissions,a=!0,o=!1,i=void 0;try{for(var s,c=function(){var e=s.value,n=r.find((function(t){return t.name===e.name}));if(!n)return"continue";var a=e.content_types;if(!a)return Object(p.x)(t,e),"continue";var o=!0,i=!1,c=void 0;try{for(var u,l=n.content_types[Symbol.iterator]();!(o=(u=l.next()).done);o=!0){var f=u.value;Object(p.x)(a,f)}}catch(e){i=!0,c=e}finally{try{o||null==l.return||l.return()}finally{if(i)throw c}}0===a.length&&Object(p.x)(t,e)},u=t.slice()[Symbol.iterator]();!(a=(s=u.next()).done);a=!0)c()}catch(e){o=!0,i=e}finally{try{a||null==u.return||u.return()}finally{if(o)throw i}}t.length>0?this.promptForPermissions(e,t,function(){var e=Ge(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t&&n();case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()):n()}},{key:"promptForPermissions",value:function(e,t,n){var r,a=this,o={component:e,permissions:t,permissionsString:this.permissionsStringForPermissions(t,e),actionBlock:n,callback:(r=Ge(l.a.mark((function n(r){var i,s,c,u,f,p;return l.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!r){n.next=24;break}for(i=!0,s=!1,c=void 0,n.prev=4,u=function(){var t=p.value,n=e.permissions.find((function(e){return e.name===t.name}));if(n){var r=n.content_types||[];n.content_types=Be()(r.concat(t.content_types))}else e.permissions.push(t)},f=t[Symbol.iterator]();!(i=(p=f.next()).done);i=!0)u();n.next=13;break;case 9:n.prev=9,n.t0=n.catch(4),s=!0,c=n.t0;case 13:n.prev=13,n.prev=14,i||null==f.return||f.return();case 16:if(n.prev=16,!s){n.next=19;break}throw c;case 19:return n.finish(16);case 20:return n.finish(13);case 21:return n.next=23,a.itemManager.setItemDirty(e.uuid);case 23:a.syncService.sync();case 24:a.permissionDialogs=a.permissionDialogs.filter((function(n){return n===o?(n.actionBlock&&n.actionBlock(r),!1):!!(n.component!==e||n.permissions!==t&&(a=t,n.permissions.some((function(e){return!a.find((function(t){return JSON.stringify(t)===JSON.stringify(e)}))}))))||(r&&n.actionBlock&&n.actionBlock(r),!1);var a})),a.permissionDialogs.length>0&&a.presentPermissionsDialog(a.permissionDialogs[0]);case 26:case"end":return n.stop()}}),n,null,[[4,9,13,21],[14,,16,20]])}))),function(e){return r.apply(this,arguments)})},i=Ne()(this.permissionDialogs,{component:e});this.permissionDialogs.push(o),i?this.log("Existing dialog, not presenting."):this.presentPermissionsDialog(o)}},{key:"presentPermissionsDialog",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"openModalComponent",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"registerHandler",value:function(e){var t=this;return this.handlers.push(e),function(){var n=Ne()(t.handlers,{identifier:e.identifier});n?Object(p.x)(t.handlers,n):t.log("Attempting to deregister non-existing handler")}}},{key:"findOrCreateDataForComponent",value:function(e){var t=this.componentState[e.uuid];return t||(t={},this.componentState[e.uuid]=t),t}},{key:"setReadonlyStateForComponent",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.findOrCreateDataForComponent(e);r.readonly=t,r.lockReadonly=n}},{key:"getReadonlyStateForComponent",value:function(e){var t=this.findOrCreateDataForComponent(e);return{readonly:t.readonly,lockReadonly:t.lockReadonly}}},{key:"registerComponentWindow",value:(d=Ge(l.a.mark((function e(t,n){var r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=this.findOrCreateDataForComponent(t)).window===n&&this.log("Web|componentManager","attempting to re-register same component window."),this.log("Web|componentManager|registerComponentWindow",t),r.window=n,e.next=6,f.a.GenerateUuid();case 6:r.sessionKey=e.sent,this.sendMessageToComponent(t,{action:nt.ComponentRegistered,sessionKey:r.sessionKey,componentData:t.componentData,data:{uuid:t.uuid,environment:(c=this.environment,u=void 0,(m(u={},o.Web,"web"),m(u,o.Desktop,"desktop"),m(u,o.Mobile,"mobile"),u)[c]),platform:(a=this.platform,s=void 0,(m(s={},i.MacWeb,"mac-web"),m(s,i.MacDesktop,"mac-desktop"),m(s,i.LinuxWeb,"linux-web"),m(s,i.LinuxDesktop,"linux-desktop"),m(s,i.WindowsWeb,"windows-web"),m(s,i.WindowsDesktop,"windows-desktop"),m(s,i.Ios,"ios"),m(s,i.Android,"android"),s)[a]),activeThemeUrls:this.urlsForActiveThemes()}}),this.postActiveThemesToComponent(t),this.desktopManager&&this.desktopManager.notifyComponentActivation(t);case 10:case"end":return e.stop()}var a,s,c,u}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"markComponentActive",value:(y=Ge(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case 1:case"end":return e.stop()}}),e)}))),function(e,t){return y.apply(this,arguments)})},{key:"registerComponent",value:function(e){this.activeComponents.includes(e)||this.activeComponents.push(e);var t=!0,n=!1,r=void 0;try{for(var a,o=this.handlers[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;(i.areas.includes(e.area)||i.areas.includes(qe.a.Any))&&i.activationHandler&&i.activationHandler(e)}}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}e.area===qe.a.Themes&&this.postActiveThemesToAllComponents()}},{key:"activateComponent",value:(h=Ge(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.active){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.itemManager.changeComponent(t.uuid,(function(e){e.active=!0}));case 4:this.syncService.sync();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"deregisterComponent",value:function(e){Object(p.x)(this.activeComponents,e);var t=!0,n=!1,r=void 0;try{for(var a,o=this.handlers[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;(i.areas.includes(e.area)||i.areas.includes(qe.a.Any))&&i.activationHandler&&i.activationHandler(e)}}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}this.streamObservers=this.streamObservers.filter((function(t){return t.component!==e})),this.contextStreamObservers=this.contextStreamObservers.filter((function(t){return t.component!==e})),e.area===qe.a.Themes&&this.postActiveThemesToAllComponents()}},{key:"deactivateComponent",value:(u=Ge(l.a.mark((function e(t){var n=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.length>1&&void 0!==n[1]&&n[1],t.active){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,this.itemManager.changeComponent(t.uuid,(function(e){e.active=!1}));case 5:this.findOrCreateDataForComponent(t).sessionKey=void 0,this.deregisterComponent(t),this.syncService.sync();case 8:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"reloadComponent",value:(c=Ge(l.a.mark((function e(t){var n=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.changeComponent(t.uuid,(function(e){e.active=!1}));case 2:return this.deregisterComponent(t),e.abrupt("return",new Promise((function(e){n.timeout(Ge(l.a.mark((function r(){return l.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.itemManager.changeComponent(t.uuid,(function(e){e.active=!0}));case 2:n.registerComponent(t),e();case 4:case"end":return r.stop()}}),r)}))))})));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"deleteComponent",value:(s=Ge(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.setItemToBeDeleted(t.uuid);case 2:this.syncService.sync();case 3:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"isComponentActive",value:function(e){return e.active}},{key:"iframeForComponent",value:function(e){for(var t=0,n=Array.from(document.getElementsByTagName("iframe"));t<n.length;t++){var r=n[t];if(r.dataset.componentId===e.uuid)return r}}},{key:"focusChangedForComponent",value:function(e){var t=document.activeElement===this.iframeForComponent(e),n=!0,r=!1,a=void 0;try{for(var o,i=this.handlers[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value;s.focusHandler&&s.focusHandler(e,t)}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}}},{key:"handleSetSizeEvent",value:function(e,t){var n=function(e,n){var r=Object(p.o)(n.width)?n.width:"".concat(t.width,"px"),a=Object(p.o)(n.height)?n.height:"".concat(t.height,"px");e&&e.setAttribute("style","width:".concat(r,"; height:").concat(a,";"))};if(e.area===qe.a.Rooms||e.area===qe.a.Modal){var r=e.area===qe.a.Rooms?"inner":"outer",a=document.getElementById("component-content-".concat(r,"-").concat(e.uuid));a&&n(a,t)}else{var o=this.iframeForComponent(e);if(!o)return;if(n(o,t),e.area===qe.a.EditorStack){var i=o.parentElement;i&&n(i,t)}}}},{key:"editorForNote",value:function(e){var t=this.componentsForArea(qe.a.Editor),n=!0,r=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value;if(s.isExplicitlyEnabledForItem(e))return s}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}if(this.isMobile){if(!e.mobilePrefersPlainEditor)return this.getDefaultEditor()}else if(!e.getAppDomainValue(Fe.a.PrefersPlainEditor))return t.filter((function(e){return e.isDefaultEditor()}))[0]}},{key:"getDefaultEditor",value:function(){throw"Must override"}},{key:"permissionsStringForPermissions",value:function(e,t){var n="",r=e.length,a=function(e,t){return e>0?e===t-1?2===t?" and ":", and ":", ":""};return e.forEach((function(e,o){if(e.name===nt.StreamItems){for(var i=e.content_types.map((function(e){var t=Object(ze.s)(e);return t?t+"s":"items of type "+e})),s="",c=0;c<i.length;c++){var u=i[c];s+=a(c,i.length+r-o-1),s+=u}n+=a(o,r),n+=s,i.length>=2&&o<r-1&&(n+=", ")}else if(e.name===nt.StreamContextItem){var l,f=(tt(l={},qe.a.EditorStack,"working note"),tt(l,qe.a.NoteTags,"working note"),tt(l,qe.a.Editor,"working note"),l);n+=a(o,r),n+=f[t.area]}})),n+"."}},{key:"isDesktop",get:function(){return this.environment===o.Desktop}},{key:"isMobile",get:function(){return this.environment===o.Mobile}},{key:"components",get:function(){return this.itemManager.getItems([ze.b.Component,ze.b.Theme])}}])&&Qe(n.prototype,r),a&&Qe(n,a),t}(L.a);function it(e){return(it="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function st(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ct(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){st(o,r,a,i,s,"next",e)}function s(e){st(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ut(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function lt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ft(e,t){return!t||"object"!==it(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function pt(e){return(pt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ht(e,t){return(ht=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}!function(e){e.Get="get",e.Post="post",e.Patch="patch"}(rt||(rt={}));var yt=function(e){function t(){return ut(this,t),ft(this,pt(t).apply(this,arguments))}var n,r,a,o,i,s,c,u;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ht(e,t)}(t,e),n=t,(r=[{key:"getAbsolute",value:(u=ct(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp(rt.Get,t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"postAbsolute",value:(c=ct(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp(rt.Post,t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"patchAbsolute",value:(s=ct(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp(rt.Patch,t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"runHttp",value:(i=ct(l.a.mark((function e(t,n,r,a){var o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.createRequest(t,n,r,a),e.abrupt("return",this.runRequest(o,t,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return i.apply(this,arguments)})},{key:"createRequest",value:function(e,t,n,r){var a=new XMLHttpRequest;return n&&e===rt.Get&&Object.keys(n).length>0&&(t=this.urlForUrlAndParams(t,n)),a.open(e,t,!0),a.setRequestHeader("Content-type","application/json"),r&&a.setRequestHeader("Authorization","Bearer "+r),a}},{key:"runRequest",value:(o=ct(l.a.mark((function e(t,n,r){var a=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,o){t.onreadystatechange=function(){a.stateChangeHandlerForRequest(t,e,o)},n===rt.Post||n===rt.Patch?t.send(JSON.stringify(r)):t.send()})));case 1:case"end":return e.stop()}}),e)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"stateChangeHandlerForRequest",value:function(e,t,n){if(4===e.readyState){var r=e.status,a={status:r};try{var o=JSON.parse(e.responseText);Object.assign(a,o)}catch(e){}r>=200&&r<=299?t(a):(a.error||(a.error={status:r}),n(a))}}},{key:"urlForUrlAndParams",value:function(e,t){var n=Object.keys(t).map((function(e){return e+"="+encodeURIComponent(t[e])})).join("&");return e.includes("?")?e+"&"+n:e+"?"+n}}])&&lt(n.prototype,r),a&&lt(n,a),t}(L.a),dt=n(12),vt=n(102),bt=n.n(vt);function mt(e){return(mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function gt(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function wt(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){gt(o,r,a,i,s,"next",e)}function s(e){gt(o,r,a,i,s,"throw",e)}i(void 0)}))}}function kt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function xt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function St(e,t,n){return(St="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ot(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ot(e){return(Ot=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Pt(e,t){return(Pt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function jt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _t=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=function(e,t){return!t||"object"!==mt(t)&&"function"!=typeof t?xt(e):t}(this,Ot(t).call(this)),jt(xt(e),"changeObservers",[]),jt(xt(e),"collection",void 0),e.collection=new dt.b,e}var n,r,a,o,i,s,c,u,f;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Pt(e,t)}(t,e),n=t,(r=[{key:"getMasterCollection",value:function(){return this.collection.immutablePayloadCopy()}},{key:"deinit",value:function(){St(Ot(t.prototype),"deinit",this).call(this),this.changeObservers.length=0,this.resetState()}},{key:"resetState",value:function(){this.collection=new dt.b}},{key:"find",value:function(e){return this.collection.findAll(e)}},{key:"emitCollection",value:(f=wt(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.emitPayloads(t.all(),t.source,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"emitPayload",value:(u=wt(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.emitPayloads([t],n,r);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"emitPayloads",value:(c=wt(l.a.mark((function e(t,n,r){var a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.mergePayloadsOntoMaster(t);case 2:return a=e.sent,o=a.changed,i=a.inserted,s=a.discarded,e.next=8,this.notifyChangeObservers(o,i,s,n,r);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"mergePayloadsOntoMaster",value:(s=wt(l.a.mark((function e(t){var n,r,a,o,i,s,c,u,f,p,h;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],r=[],a=[],o=!0,i=!1,s=void 0,e.prev=6,c=t[Symbol.iterator]();case 8:if(o=(u=c.next()).done){e.next=19;break}if((f=u.value).uuid&&f.content_type){e.next=13;break}return console.error("Payload is corrupt:",f),e.abrupt("continue",16);case 13:p=this.collection.find(f.uuid),(h=p?p.mergedWith(f):f).discardable?(this.collection.discard(h),a.push(h)):(this.collection.set(h),p?n.push(h):r.push(h));case 16:o=!0,e.next=8;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(6),i=!0,s=e.t0;case 25:e.prev=25,e.prev=26,o||null==c.return||c.return();case 28:if(e.prev=28,!i){e.next=31;break}throw s;case 31:return e.finish(28);case 32:return e.finish(25);case 33:return e.abrupt("return",{changed:n,inserted:r,discarded:a});case 34:case"end":return e.stop()}}),e,this,[[6,21,25,33],[26,,28,32]])}))),function(e){return s.apply(this,arguments)})},{key:"addChangeObserver",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;Array.isArray(e)||(e=[e]);var a={types:e,priority:r,callback:t};return this.changeObservers.push(a),function(){bt()(n.changeObservers,a)}}},{key:"notifyChangeObservers",value:(i=wt(l.a.mark((function e(t,n,r,a,o){var i,s,c,u,f,p,h,y;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=this.changeObservers.sort((function(e,t){return e.priority<t.priority?-1:1})),s=function(e,t){return t.includes(ze.b.Any)?e:e.filter((function(e){return t.includes(e.content_type)}))},c=!0,u=!1,f=void 0,e.prev=5,p=i[Symbol.iterator]();case 7:if(c=(h=p.next()).done){e.next=14;break}return y=h.value,e.next=11,y.callback(s(t,y.types),s(n,y.types),s(r,y.types),a,o);case 11:c=!0,e.next=7;break;case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(5),u=!0,f=e.t0;case 20:e.prev=20,e.prev=21,c||null==p.return||p.return();case 23:if(e.prev=23,!u){e.next=26;break}throw f;case 26:return e.finish(23);case 27:return e.finish(20);case 28:case"end":return e.stop()}}),e,this,[[5,16,20,28],[21,,23,27]])}))),function(e,t,n,r,a){return i.apply(this,arguments)})},{key:"importPayloads",value:(o=wt(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new F.g(this.getMasterCollection(),new F.h(t,F.k.FileImport)),e.next=3,n.resultingCollection();case 3:return r=e.sent,e.abrupt("return",this.emitCollection(r));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"removePayloadLocally",value:function(e){this.collection.discard(e)}}])&&kt(n.prototype,r),a&&kt(n,a),t}(L.a),Ct=n(13);function Dt(e){return(Dt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Et(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function It(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Et(o,r,a,i,s,"next",e)}function s(e){Et(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Rt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function At(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Mt(e,t,n){return(Mt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Tt(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Tt(e){return(Tt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Kt(e,t){return(Kt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Lt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ft=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==Dt(t)&&"function"!=typeof t?At(e):t}(this,Tt(t).call(this)),Lt(At(r),"itemManager",void 0),Lt(At(r),"syncService",void 0),Lt(At(r),"resolveQueue",[]),Lt(At(r),"registeredPredicates",[]),Lt(At(r),"removeItemObserver",void 0),Lt(At(r),"removeSyncObserver",void 0),r.itemManager=e,r.syncService=n,r.addObservers(),r}var n,r,a,o,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Kt(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.syncService=void 0,this.itemManager=void 0,this.resolveQueue.length=0,this.registeredPredicates.length=0,this.removeItemObserver(),this.removeItemObserver=void 0,this.removeSyncObserver(),this.removeSyncObserver=void 0,Mt(Tt(t.prototype),"deinit",this).call(this)}},{key:"popResolveQueue",value:function(){var e=this.resolveQueue.slice();return this.resolveQueue=[],e}},{key:"addObservers",value:function(){var e=this;this.removeItemObserver=this.itemManager.addObserver(ze.b.Any,function(){var t=It(l.a.mark((function t(n,r){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r.length>0&&(e.resolveQueue=e.resolveQueue.concat(r));case 1:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}()),this.removeSyncObserver=this.syncService.addEventObserver(function(){var t=It(l.a.mark((function t(n){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==Ct.a.DownloadFirstSyncCompleted&&n!==Ct.a.FullSyncCompleted){t.next=3;break}return t.next=3,e.resolveSingletonsForItems(e.popResolveQueue(),n);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"registerPredicate",value:function(e){this.registeredPredicates.push(e)}},{key:"validItemsMatchingPredicate",value:function(e){return this.itemManager.itemsMatchingPredicate(e).filter((function(e){return!e.errorDecrypting}))}},{key:"resolveSingletonsForItems",value:(s=It(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f,h,y,d,v=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=function(e){var t=!0,n=!1,r=void 0;try{for(var a,o=v.registeredPredicates[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;if(e.satisfiesPredicate(i))return v.validItemsMatchingPredicate(i)}}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}},a=function(e){return e.isSingleton?v.validItemsMatchingPredicate(e.singletonPredicate):null},o=function(e){var t=a(e);return t&&t.length>0?t:r(e)},i=[],s=!0,c=!1,u=void 0,e.prev=7,f=t[Symbol.iterator]();case 9:if(s=(h=f.next()).done){e.next=22;break}if(y=h.value,!i.includes(y)){e.next=13;break}return e.abrupt("continue",19);case 13:if(d=o(y),Object(p.h)(i,d||[]),d&&!(d.length<=1)){e.next=17;break}return e.abrupt("continue",19);case 17:return e.next=19,this.handleStrategy(d,y.singletonStrategy);case 19:s=!0,e.next=9;break;case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(7),c=!0,u=e.t0;case 28:e.prev=28,e.prev=29,s||null==f.return||f.return();case 31:if(e.prev=31,!c){e.next=34;break}throw u;case 34:return e.finish(31);case 35:return e.finish(28);case 36:i.length>0&&n===Ct.a.FullSyncCompleted&&setTimeout((function(){v.syncService.sync()}));case 37:case"end":return e.stop()}}),e,this,[[7,24,28,36],[29,,31,35]])}))),function(e,t){return s.apply(this,arguments)})},{key:"handleStrategy",value:(i=It(l.a.mark((function e(t,n){var r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n===ze.r.KeepEarliest){e.next=2;break}throw"Unhandled singleton strategy";case 2:return r=t.sort((function(e,t){return e.errorDecrypting?1:t.errorDecrypting||e.created_at<t.created_at?-1:1})),a=Object(p.d)(r,0),e.next=6,this.itemManager.setItemsToBeDeleted(Object(v.c)(a));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"findOrCreateSingleton",value:(o=It(l.a.mark((function e(t,n,r){var a,o,i,s,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((a=this.validItemsMatchingPredicate(t)).length>0)){e.next=3;break}return e.abrupt("return",a[0]);case 3:if(this.syncService.getLastSyncDate()){e.next=6;break}return e.next=6,this.syncService.sync();case 6:if(!((o=this.validItemsMatchingPredicate(t)).length>0)){e.next=9;break}return e.abrupt("return",o[0]);case 9:return i=this.itemManager.itemsMatchingPredicate(t).filter((function(e){return e.errorDecrypting})),e.next=12,this.itemManager.setItemsToBeDeleted(Object(v.c)(i));case 12:return e.t0=y.e,e.next=15,f.a.GenerateUuid();case 15:return e.t1=e.sent,e.t2=n,e.t3=r,e.t4=new Date,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:!0,dirtiedDate:e.t4},s=(0,e.t0)(e.t5),e.next=23,this.itemManager.emitItemFromPayload(s);case 23:return c=e.sent,e.next=26,this.syncService.sync();case 26:return e.abrupt("return",c);case 27:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})}])&&Rt(n.prototype,r),a&&Rt(n,a),t}(L.a);function Vt(e){return(Vt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Nt(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ut(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Nt(o,r,a,i,s,"next",e)}function s(e){Nt(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Bt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Wt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ht(e,t,n){return(Ht="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=zt(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function zt(e){return(zt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function qt(e,t){return(qt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Yt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Jt=function(e){function t(e,n,r,a,o,i,s){var c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c=function(e,t){return!t||"object"!==Vt(t)&&"function"!=typeof t?Wt(e):t}(this,zt(t).call(this)),Yt(Wt(c),"alertService",void 0),Yt(Wt(c),"httpService",void 0),Yt(Wt(c),"modelManager",void 0),Yt(Wt(c),"itemManager",void 0),Yt(Wt(c),"protocolService",void 0),Yt(Wt(c),"syncService",void 0),Yt(Wt(c),"previousPasswords",[]),c.itemManager=e,c.alertService=n,c.deviceInterface=r,c.httpService=a,c.modelManager=o,c.protocolService=i,c.syncService=s,c.previousPasswords=[],c}var n,r,a,o,i,s,c,u,f,p,h,v;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qt(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.itemManager=void 0,this.alertService=void 0,this.deviceInterface=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.syncService=void 0,this.previousPasswords.length=0,Ht(zt(t.prototype),"deinit",this).call(this)}},{key:"getExtensions",value:function(){return this.itemManager.validItemsForContentType(ze.b.ActionsExtension)}},{key:"extensionsInContextOfItem",value:function(e){return this.getExtensions().filter((function(t){return t.supported_types.includes(e.content_type)||t.actionsWithContextForItem(e).length>0}))}},{key:"loadExtensionInContextOfItem",value:(v=Ut(l.a.mark((function e(t,n){var r,a=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={content_type:n.content_type,item_uuid:n.uuid},e.abrupt("return",this.httpService.getAbsolute(t.url,r).then((function(e){var n=e.description||t.description,r=e.supported_types||t.supported_types,o=e.actions?e.actions.map((function(e){return new ze.a(e)})):[];return a.itemManager.changeActionsExtension(t.uuid,(function(e){e.description=n,e.supported_types=r,e.actions=o})),t})).catch((function(e){return console.error("Error loading extension",e),null})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return v.apply(this,arguments)})},{key:"runAction",value:(h=Ut(l.a.mark((function e(t,n,r){var a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.running=!0,e.t0=t.verb,e.next="get"===e.t0?4:"render"===e.t0?8:"show"===e.t0?12:"post"===e.t0?16:20;break;case 4:return e.next=6,this.handleGetAction(t,r);case 6:return a=e.sent,e.abrupt("break",21);case 8:return e.next=10,this.handleRenderAction(t,r);case 10:return a=e.sent,e.abrupt("break",21);case 12:return e.next=14,this.handleShowAction(t);case 14:return a=e.sent,e.abrupt("break",21);case 16:return e.next=18,this.handlePostAction(t,n);case 18:return a=e.sent,e.abrupt("break",21);case 20:return e.abrupt("break",21);case 21:return t.lastExecuted=new Date,t.running=!1,e.abrupt("return",a);case 24:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return h.apply(this,arguments)})},{key:"handleGetAction",value:(p=Ut(l.a.mark((function e(t,n){var r=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,a){r.alertService.confirm("Are you sure you want to replace the current note contents with this action's results?",void 0,void 0,void 0,(function(){r.runConfirmedGetAction(t,n).then(e)}))})));case 1:case"end":return e.stop()}}),e)}))),function(e,t){return p.apply(this,arguments)})},{key:"runConfirmedGetAction",value:(f=Ut(l.a.mark((function e(t,n){var r,a,o=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.httpService.getAbsolute(t.url).catch((function(e){var n=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return o.alertService.alert(n.message),t.error=!0,{error:n}}));case 2:if(!(r=e.sent).error){e.next=5;break}return e.abrupt("return",r);case 5:return t.error=!1,e.next=8,this.payloadByDecryptingResponse(r,n);case 8:return a=e.sent,e.next=11,this.modelManager.emitPayload(Object(y.b)(a,{dirty:!0,dirtiedDate:new Date}),d.a.RemoteActionRetrieved);case 11:return this.syncService.sync(),e.abrupt("return",{response:r,item:r.item});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"handleRenderAction",value:(u=Ut(l.a.mark((function e(t,n){var r=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.httpService.getAbsolute(t.url).then(function(){var e=Ut(l.a.mark((function e(a){var o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.error=!1,e.next=3,r.payloadByDecryptingResponse(a,n);case 3:if(!(o=e.sent)){e.next=7;break}return i=r.itemManager.createItem(o.content_type,o.contentObject),e.abrupt("return",{response:a,item:i});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){var n=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return r.alertService.alert(n.message),t.error=!0,{error:n}})));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"payloadByDecryptingResponse",value:(c=Ut(l.a.mark((function e(t,n,r){var a,o,i,s,c,u,f,p,h,d,v,b;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(y.e)(t.item),e.next=3,this.protocolService.payloadByDecryptingPayload(a,r);case 3:if((o=e.sent).errorDecrypting){e.next=6;break}return e.abrupt("return",o);case 6:if(t.auth_params){e.next=9;break}return this.alertService.alert("We were unable to decrypt this revision using your current keys, \n        and this revision is missing metadata that would allow us to try different \n        keys to decrypt it. This can likely be fixed with some manual intervention. \n        Please email hello@standardnotes.org for assistance."),e.abrupt("return",void 0);case 9:i=[],s=!0,c=!1,u=void 0,e.prev=13,f=this.previousPasswords[Symbol.iterator]();case 15:if(s=(p=f.next()).done){e.next=33;break}if(h=p.value,!i.includes(h)){e.next=19;break}return e.abrupt("continue",30);case 19:return i.push(h),e.next=22,this.protocolService.computeRootKey(h,t.auth_params);case 22:if(d=e.sent){e.next=25;break}return e.abrupt("continue",30);case 25:return e.next=27,this.payloadByDecryptingResponse(t,n,d);case 27:if(!(v=e.sent)){e.next=30;break}return e.abrupt("return",v);case 30:s=!0,e.next=15;break;case 33:e.next=39;break;case 35:e.prev=35,e.t0=e.catch(13),c=!0,u=e.t0;case 39:e.prev=39,e.prev=40,s||null==f.return||f.return();case 42:if(e.prev=42,!c){e.next=45;break}throw u;case 45:return e.finish(42);case 46:return e.finish(39);case 47:return e.next=49,n();case 49:return b=e.sent,this.previousPasswords.push(b),e.abrupt("return",this.payloadByDecryptingResponse(t,n,r));case 52:case"end":return e.stop()}}),e,this,[[13,35,39,47],[40,,42,46]])}))),function(e,t,n){return c.apply(this,arguments)})},{key:"handlePostAction",value:(s=Ut(l.a.mark((function e(t,n){var r,a,o,i=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="decrypted"===t.access_type,e.next=3,this.outgoingPayloadForItem(n,r);case 3:return a=e.sent,o={items:[a]},e.abrupt("return",this.httpService.postAbsolute(t.url,o).then((function(e){return t.error=!1,{response:e}})).catch((function(e){return t.error=!0,console.error("Action error response:",e),i.alertService.alert("An issue occurred while processing this action. Please try again."),{response:e}})));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"handleShowAction",value:(i=Ut(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.deviceInterface.openUrl(t.url),e.abrupt("return",{response:null});case 2:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"outgoingPayloadForItem",value:(o=Ut(l.a.mark((function e(t){var n,r,a=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]&&a[1],r=n?K.a.FileDecrypted:K.a.FileEncrypted,e.abrupt("return",this.protocolService.payloadByEncryptingPayload(t.payloadRepresentation(),r));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})}])&&Bt(n.prototype,r),a&&Bt(n,a),t}(L.a);function Gt(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Qt(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Gt(o,r,a,i,s,"next",e)}function s(e){Gt(o,r,a,i,s,"throw",e)}i(void 0)}))}}function $t(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Xt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Zt=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Xt(this,"services",void 0),Xt(this,"challengeResponder",void 0),Xt(this,"stageHandlers",{}),Xt(this,"onDoneHandler",void 0),this.services=t,this.challengeResponder=n,this.registerStageHandlers()}var t,n,r,a,o;return t=e,n=[{key:"registerStageHandler",value:function(e,t){this.stageHandlers[e]=t}},{key:"markDone",value:function(){this.onDoneHandler&&this.onDoneHandler(),this.onDoneHandler=void 0}},{key:"onDone",value:function(e){this.onDoneHandler=e}},{key:"handleStage",value:(o=Qt(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.stageHandlers[t])){e.next=4;break}return e.next=4,n();case 4:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"requestChallengeResponse",value:(a=Qt(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.challengeResponder(t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)})}],r=[{key:"timestamp",value:function(){throw"Must override"}}],n&&$t(t.prototype,n),r&&$t(t,r),e}(),en=n(14);function tn(e){return(tn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function nn(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function rn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function an(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function on(e,t){return!t||"object"!==tn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function sn(e){return(sn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function cn(e,t){return(cn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var un=function(e){function t(){return rn(this,t),on(this,sn(t).apply(this,arguments))}var n,r,a,o,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&cn(e,t)}(t,e),n=t,r=[{key:"compare",value:function(e){if(this.version!==e.version)return!1;var t=this.serverPassword&&e.serverPassword;return this.masterKey===e.masterKey&&(!t||this.serverPassword===e.serverPassword)}},{key:"getPersistableValue",value:function(){var e={version:this.version};return this.masterKey&&(e.masterKey=this.masterKey),this.dataAuthenticationKey&&(e.dataAuthenticationKey=this.dataAuthenticationKey),e}},{key:"version",get:function(){if(!this.payload.safeContent.version)throw"Attempting to create key without version.";return this.payload.safeContent.version}},{key:"isRootKey",get:function(){return!0}},{key:"itemsKey",get:function(){return this.masterKey}},{key:"masterKey",get:function(){return this.payload.safeContent.masterKey}},{key:"serverPassword",get:function(){return this.payload.safeContent.serverPassword}},{key:"dataAuthenticationKey",get:function(){return this.payload.safeContent.dataAuthenticationKey}}],a=[{key:"Create",value:(o=l.a.mark((function e(n,r){var a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=4;break}return e.next=3,f.a.GenerateUuid();case 3:r=e.sent;case 4:return n.version||(n.dataAuthenticationKey?n.version=en.a.V002:n.version=en.a.V001),a=Object(y.e)({uuid:r,content_type:h.a.RootKey,content:Object(v.b)(n)}),e.abrupt("return",new t(a));case 7:case"end":return e.stop()}}),e)})),i=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=o.apply(e,t);function i(e){nn(a,n,r,i,s,"next",e)}function s(e){nn(a,n,r,i,s,"throw",e)}i(void 0)}))},function(e,t){return i.apply(this,arguments)})}],r&&an(n.prototype,r),a&&an(n,a),t}(Fe.d);function ln(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function fn(e){return new pn(e)}var pn=function(){function e(t){var n,r,a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a=void 0,(r="content")in(n=this)?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,this.content=t}var t,n,r;return t=e,(n=[{key:"getPortableValue",value:function(){return Object(en.b)(this.version,en.a.V003)>=0?Object(p.u)(this.content,["pw_cost"]):this.content}},{key:"isKeyParamsObject",get:function(){return!0}},{key:"kdfIterations",get:function(){return this.content.pw_cost}},{key:"seed",get:function(){return this.content.pw_nonce}},{key:"identifier",get:function(){return this.content.identifier||this.content.email}},{key:"salt",get:function(){return this.content.pw_salt}},{key:"version",get:function(){return this.content.version}}])&&ln(t.prototype,n),r&&ln(t,r),e}(),hn=n(24),yn=n(11),dn=n(25);function vn(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function bn(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){vn(o,r,a,i,s,"next",e)}function s(e){vn(o,r,a,i,s,"throw",e)}i(void 0)}))}}function mn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var gn,wn,kn,xn,Sn=function(){function e(t){var n,r,a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a=void 0,(r="crypto")in(n=this)?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,this.crypto=t}var t,n,r,a,o,i,s,c;return t=e,(n=[{key:"firstHalfOfKey",value:(c=bn(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(0,t.length/2));case 1:case"end":return e.stop()}}),e)}))),function(e){return c.apply(this,arguments)})},{key:"secondHalfOfKey",value:(s=bn(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(t.length/2,t.length));case 1:case"end":return e.stop()}}),e)}))),function(e){return s.apply(this,arguments)})},{key:"splitKey",value:function(e,t){for(var n=e.length/t,r=[],a=0;a<t;a++){var o=e.slice(n*a,n*(a+1));r.push(o)}return r}},{key:"createItemsKey",value:(i=bn(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateNewItemsKeyContent();case 2:return t=e.sent,e.t0=y.e,e.next=6,f.a.GenerateUuid();case 6:return e.t1=e.sent,e.t2=ze.b.ItemsKey,e.t3=Object(v.b)(t),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},n=(0,e.t0)(e.t4),e.abrupt("return",Object(v.a)(n));case 12:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(o=bn(l.a.mark((function e(t,n,r){var a,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==yn.a.DecryptedBareObject){e.next=4;break}return e.abrupt("return",Object(y.c)({content:t.content}));case 4:if(n!==yn.a.DecryptedBase64String){e.next=13;break}return a=JSON.stringify(t.content),e.next=8,Object(dn.base64Encode)(a);case 8:return o=e.sent,i=en.a.V000Base64Decrypted+o,e.abrupt("return",Object(y.c)({content:i}));case 13:throw"Must override generateEncryptedParameters to handle format ".concat(n,".");case 14:case"end":return e.stop()}}),e)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(a=bn(l.a.mark((function e(t,n){var r,a,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==yn.a.DecryptedBareObject){e.next=5;break}return e.abrupt("return",t);case 5:if(r!==yn.a.DecryptedBase64String){e.next=20;break}return a=t.contentString.substring(en.a.VersionLength,t.contentString.length),e.prev=7,e.next=10,Object(dn.base64Decode)(a);case 10:i=e.sent,o=JSON.parse(i),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(7),o=t.content;case 17:return e.abrupt("return",Object(y.a)(t,{content:o}));case 20:throw"Must override generateDecryptedParameters to handle format ".concat(r,".");case 21:case"end":return e.stop()}}),e,null,[[7,14]])}))),function(e,t){return a.apply(this,arguments)})}])&&mn(t.prototype,n),r&&mn(t,r),e}();function On(e){return(On="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Pn(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function jn(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Pn(o,r,a,i,s,"next",e)}function s(e){Pn(o,r,a,i,s,"throw",e)}i(void 0)}))}}function _n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Cn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Dn(e,t){return!t||"object"!==On(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function En(e,t,n){return(En="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=In(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function In(e){return(In=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Rn(e,t){return(Rn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}!function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=512]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength"}(gn||(gn={})),function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(wn||(wn={})),function(e){e[e.SaltSeedLength=256]="SaltSeedLength",e[e.PbkdfCost=11e4]="PbkdfCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(kn||(kn={})),function(e){e[e.ArgonSaltSeedLength=256]="ArgonSaltSeedLength",e[e.ArgonSaltLength=128]="ArgonSaltLength",e[e.ArgonIterations=5]="ArgonIterations",e[e.ArgonMemLimit=67108864]="ArgonMemLimit",e[e.ArgonOutputKeyBytes=64]="ArgonOutputKeyBytes",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionNonceLength=192]="EncryptionNonceLength"}(xn||(xn={}));var An="00000000000000000000000000000000",Mn=function(e){function t(){return _n(this,t),Dn(this,In(t).apply(this,arguments))}var n,r,a,o,i,s,c,u,f,p,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Rn(e,t)}(t,e),n=t,(r=[{key:"generateNewItemsKeyContent",value:(h=jn(l.a.mark((function e(){var t,n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=gn.EncryptionKeyLength,e.next=3,this.crypto.generateRandomKey(t);case 3:return n=e.sent,r={itemsKey:n,version:this.version},e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"createRootKey",value:(p=jn(l.a.mark((function e(t,n){var r,a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=gn.PbkdfMinCost,e.next=3,this.crypto.generateRandomKey(gn.SaltSeedLength);case 3:return a=e.sent,e.next=6,this.crypto.unsafeSha1(t+"SN"+a);case 6:return o=e.sent,e.next=9,this.deriveKey(n,o,r);case 9:return i=e.sent,s=fn({email:t,pw_cost:r,pw_nonce:a,pw_salt:o,version:this.version}),e.abrupt("return",{key:i,keyParams:s});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"computeRootKey",value:(f=jn(l.a.mark((function e(t,n){var r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deriveKey(t,n.salt,n.kdfIterations);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"decryptString",value:(u=jn(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,An,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"encryptString",value:(c=jn(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,An,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(s=jn(l.a.mark((function e(n,r,a){var o,i,s,c,u,f,p;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r!==yn.a.DecryptedBareObject&&r!==yn.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",En(In(t.prototype),"generateEncryptedParameters",this).call(this,n,r,a));case 2:if(r===yn.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(r);case 4:if(a){e.next=6;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 6:return e.next=8,this.crypto.generateRandomKey(2*gn.EncryptionKeyLength);case 8:return o=e.sent,e.next=11,this.encryptString(o,a.itemsKey);case 11:return i=e.sent,e.next=14,this.firstHalfOfKey(o);case 14:return s=e.sent,e.next=17,this.secondHalfOfKey(o);case 17:return c=e.sent,e.next=20,this.encryptString(JSON.stringify(n.content),s);case 20:return u=e.sent,f=a.version+u,e.next=24,this.crypto.hmac256(f,c);case 24:return p=e.sent,e.abrupt("return",Object(y.c)({uuid:n.uuid,items_key_id:a instanceof hn.b?a.uuid:void 0,content:f,enc_item_key:i,auth_hash:p}));case 26:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(i=jn(l.a.mark((function e(n,r){var a,o,i,s,c,u,f;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((a=n.format)!==yn.a.DecryptedBareObject&&a!==yn.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",En(In(t.prototype),"generateDecryptedParameters",this).call(this,n,r));case 3:if(n.enc_item_key){e.next=6;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",n);case 6:return o=n.enc_item_key,o=this.version+o,i=this.encryptionComponentsFromString(o,r.itemsKey),e.next=11,this.decryptString(i.ciphertext,i.key);case 11:if(s=e.sent){e.next=15;break}return console.error("Error decrypting parameters",n),e.abrupt("return",Object(y.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 15:return e.next=17,this.firstHalfOfKey(s);case 17:return c=e.sent,u=this.encryptionComponentsFromString(n.contentString,c),e.next=21,this.decryptString(u.ciphertext,u.key);case 21:if(f=e.sent){e.next=26;break}return e.abrupt("return",Object(y.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 26:return e.abrupt("return",Object(y.a)(n,{content:JSON.parse(f),items_key_id:void 0,enc_item_key:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===n.errorDecrypting,waitingForKey:!1}));case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"encryptionComponentsFromString",value:function(e,t){var n=e.substring(0,en.a.VersionLength);return{ciphertext:e.substring(en.a.VersionLength,e.length),version:n,key:t}}},{key:"deriveKey",value:(o=jn(l.a.mark((function e(t,n,r){var a,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.pbkdf2(t,n,r,gn.PbkdfOutputLength);case 2:return a=e.sent,e.next=5,this.splitKey(a,2);case 5:return o=e.sent,e.next=8,un.Create({serverPassword:o[0],masterKey:o[1],version:this.version});case 8:return i=e.sent,e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"version",get:function(){return en.a.V001}}])&&Cn(n.prototype,r),a&&Cn(n,a),t}(Sn);function Tn(e){return(Tn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Kn(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ln(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Kn(o,r,a,i,s,"next",e)}function s(e){Kn(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Fn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Vn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Nn(e,t){return!t||"object"!==Tn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Un(e,t,n){return(Un="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Bn(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Bn(e){return(Bn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Wn(e,t){return(Wn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Hn=function(e){function t(){return Fn(this,t),Nn(this,Bn(t).apply(this,arguments))}var n,r,a,o,i,s,c,u,f,p,h,d,v;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Wn(e,t)}(t,e),n=t,(r=[{key:"generateNewItemsKeyContent",value:(v=Ln(l.a.mark((function e(){var t,n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=wn.EncryptionKeyLength,e.next=3,this.crypto.generateRandomKey(t);case 3:return n=e.sent,e.next=6,this.crypto.generateRandomKey(t);case 6:return r=e.sent,a={itemsKey:n,dataAuthenticationKey:r,version:this.version},e.abrupt("return",a);case 9:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"createRootKey",value:(d=Ln(l.a.mark((function e(t,n){var r,a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=wn.PbkdfMinCost,e.next=3,this.crypto.generateRandomKey(wn.SaltSeedLength);case 3:return a=e.sent,e.next=6,this.crypto.unsafeSha1(t+":"+a);case 6:return o=e.sent,e.next=9,this.deriveKey(n,o,r);case 9:return i=e.sent,s=fn({email:t,pw_cost:r,pw_nonce:a,pw_salt:o,version:this.version}),e.abrupt("return",{key:i,keyParams:s});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"computeRootKey",value:(h=Ln(l.a.mark((function e(t,n){var r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deriveKey(t,n.salt,n.kdfIterations);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"decryptString002",value:(p=Ln(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,r,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return p.apply(this,arguments)})},{key:"encryptString002",value:(f=Ln(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,r,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"encryptTextParams",value:(u=Ln(l.a.mark((function e(t,n,r,a,o){var i,s,c,u,f;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(wn.EncryptionIvLength);case 2:return i=e.sent,e.next=5,this.encryptString002(t,n,i);case 5:return s=e.sent,c=[o,a,i,s].join(":"),e.next=9,this.crypto.hmac256(c,r);case 9:return u=e.sent,f=[o,u,a,i,s].join(":"),e.abrupt("return",f);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return u.apply(this,arguments)})},{key:"decryptTextParams",value:(c=Ln(l.a.mark((function e(t,n,r,a,o,i){var s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw"Attempting to decryptTextParams with null encryptionKey";case 2:return e.next=4,this.crypto.hmac256(t,i);case 4:if(s=e.sent,!1!==this.crypto.timingSafeEqual(o,s)){e.next=8;break}return console.error("Auth hash does not match, returning null."),e.abrupt("return",null);case 8:return e.abrupt("return",this.decryptString002(n,r,a));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a,o){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(s=Ln(l.a.mark((function e(n,r,a){var o,i,s,c,u;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r!==yn.a.DecryptedBareObject&&r!==yn.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",Un(Bn(t.prototype),"generateEncryptedParameters",this).call(this,n,r,a));case 2:if(r===yn.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(r);case 4:if(a&&a.itemsKey){e.next=6;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 6:return e.next=8,this.crypto.generateRandomKey(2*wn.EncryptionKeyLength);case 8:return o=e.sent,e.next=11,this.encryptTextParams(o,a.itemsKey,a.dataAuthenticationKey,n.uuid,a.version);case 11:return i=e.sent,e.next=14,this.firstHalfOfKey(o);case 14:return s=e.sent,e.next=17,this.secondHalfOfKey(o);case 17:return c=e.sent,e.next=20,this.encryptTextParams(JSON.stringify(n.content),s,c,n.uuid,a.version);case 20:return u=e.sent,e.abrupt("return",Object(y.c)({uuid:n.uuid,items_key_id:a instanceof hn.b?a.uuid:void 0,content:u,enc_item_key:i}));case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(i=Ln(l.a.mark((function e(n,r){var a,o,i,s,c,u,f,p,h;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((a=n.format)!==yn.a.DecryptedBareObject&&a!==yn.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",Un(Bn(t.prototype),"generateDecryptedParameters",this).call(this,n,r));case 3:if(n.enc_item_key){e.next=6;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",n);case 6:if(r&&r.itemsKey){e.next=8;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 8:return o=n.enc_item_key,i=this.encryptionComponentsFromString002(o,r.itemsKey,r.dataAuthenticationKey),e.next=12,this.decryptTextParams(i.ciphertextToAuth,i.contentCiphertext,i.encryptionKey,i.iv,i.authHash,i.authKey);case 12:if(s=e.sent){e.next=16;break}return console.error("Error decrypting item_key parameters",n),e.abrupt("return",Object(y.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 16:return e.next=18,this.firstHalfOfKey(s);case 18:return c=e.sent,e.next=21,this.secondHalfOfKey(s);case 21:return u=e.sent,f=this.encryptionComponentsFromString002(n.contentString,c,u),e.next=25,this.decryptTextParams(f.ciphertextToAuth,f.contentCiphertext,f.encryptionKey,f.iv,f.authHash,f.authKey);case 25:if(p=e.sent){e.next=30;break}return e.abrupt("return",Object(y.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 30:return e.prev=30,e.t0=JSON,e.next=34,Object(dn.base64Decode)(f.authParams);case 34:e.t1=e.sent,h=e.t0.parse.call(e.t0,e.t1),e.next=40;break;case 38:e.prev=38,e.t2=e.catch(30);case 40:return e.abrupt("return",Object(y.a)(n,{content:JSON.parse(p),items_key_id:void 0,enc_item_key:void 0,auth_params:h,errorDecrypting:!1,errorDecryptingValueChanged:!0===n.errorDecrypting,waitingForKey:!1}));case 41:case"end":return e.stop()}}),e,this,[[30,38]])}))),function(e,t){return i.apply(this,arguments)})},{key:"deriveKey",value:(o=Ln(l.a.mark((function e(t,n,r){var a,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.pbkdf2(t,n,r,wn.PbkdfOutputLength);case 2:return a=e.sent,e.next=5,this.splitKey(a,3);case 5:return o=e.sent,e.next=8,un.Create({serverPassword:o[0],masterKey:o[1],dataAuthenticationKey:o[2],version:this.version});case 8:return i=e.sent,e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"encryptionComponentsFromString002",value:function(e,t,n){var r=e.split(":");return{encryptionVersion:r[0],authHash:r[1],uuid:r[2],iv:r[3],contentCiphertext:r[4],authParams:r[5],ciphertextToAuth:[r[0],r[2],r[3],r[4]].join(":"),encryptionKey:t,authKey:n}}},{key:"version",get:function(){return en.a.V002}}])&&Vn(n.prototype,r),a&&Vn(n,a),t}(Mn);function zn(e){return(zn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function qn(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Yn(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){qn(o,r,a,i,s,"next",e)}function s(e){qn(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Jn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Gn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Qn(e,t){return!t||"object"!==zn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function $n(e){return($n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Xn(e,t){return(Xn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Zn=function(e){function t(){return Jn(this,t),Qn(this,$n(t).apply(this,arguments))}var n,r,a,o,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Xn(e,t)}(t,e),n=t,(r=[{key:"computeRootKey",value:(s=Yn(l.a.mark((function e(t,n){var r,a,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=kn.PbkdfCost,a=this.version,e.next=4,this.generateSalt(n.identifier,a,r,n.seed);case 4:return o=e.sent,e.next=7,this.deriveKey(t,o,r);case 7:return i=e.sent,e.abrupt("return",i);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"createRootKey",value:(i=Yn(l.a.mark((function e(t,n){var r,a,o,i,s,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.version,a=kn.PbkdfCost,e.next=4,this.crypto.generateRandomKey(kn.SaltSeedLength);case 4:return o=e.sent,e.next=7,this.generateSalt(t,r,a,o);case 7:return i=e.sent,e.next=10,this.deriveKey(n,i,a);case 10:return s=e.sent,c=fn({identifier:t,pw_cost:a,pw_nonce:o,version:r}),e.abrupt("return",{key:s,keyParams:c});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"generateSalt",value:(o=Yn(l.a.mark((function e(t,n,r,a){var o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.sha256([t,"SF",n,r,a].join(":"));case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return o.apply(this,arguments)})},{key:"version",get:function(){return en.a.V003}}])&&Gn(n.prototype,r),a&&Gn(n,a),t}(Hn);function er(e){return(er="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function tr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function nr(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){tr(o,r,a,i,s,"next",e)}function s(e){tr(o,r,a,i,s,"throw",e)}i(void 0)}))}}function rr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ar(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function or(e,t){return!t||"object"!==er(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ir(e,t,n){return(ir="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=sr(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function sr(e){return(sr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function cr(e,t){return(cr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ur=function(e){function t(){return rr(this,t),or(this,sr(t).apply(this,arguments))}var n,r,a,o,i,s,c,u,f,h,d,v,b;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&cr(e,t)}(t,e),n=t,(r=[{key:"generateNewItemsKeyContent",value:(b=nr(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(xn.EncryptionKeyLength);case 2:return t=e.sent,n={itemsKey:t,version:this.version},e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"generateSalt004",value:(v=nr(l.a.mark((function e(t,n){var r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.sha256([t,n].join(":"));case 2:return r=e.sent,e.abrupt("return",Object(p.D)(r,xn.ArgonSaltLength));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return v.apply(this,arguments)})},{key:"computeRootKey",value:(d=nr(l.a.mark((function e(t,n){var r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateSalt004(n.identifier,n.seed);case 2:return r=e.sent,e.next=5,this.deriveKey(t,r,xn.ArgonIterations);case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"createRootKey",value:(h=nr(l.a.mark((function e(t,n){var r,a,o,i,s,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.version,a=xn.ArgonIterations,e.next=4,this.crypto.generateRandomKey(xn.ArgonSaltSeedLength);case 4:return o=e.sent,e.next=7,this.generateSalt004(t,o);case 7:return i=e.sent,e.next=10,this.deriveKey(n,i,a);case 10:return s=e.sent,c=fn({identifier:t,pw_cost:a,pw_nonce:o,version:r}),e.abrupt("return",{key:s,keyParams:c});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"encryptString004",value:(f=nr(l.a.mark((function e(t,n,r,a){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw"encryptString null nonce";case 2:if(n){e.next=4;break}throw"encryptString null rawKey";case 4:return e.abrupt("return",this.crypto.xchacha20Encrypt(t,r,n,JSON.stringify(a)));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return f.apply(this,arguments)})},{key:"decryptString004",value:(u=nr(l.a.mark((function e(t,n,r,a){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.xchacha20Decrypt(t,r,n,JSON.stringify(a)));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return u.apply(this,arguments)})},{key:"generateEncryptedProtocolString",value:(c=nr(l.a.mark((function e(t,n,r){var a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(xn.EncryptionNonceLength);case 2:return a=e.sent,o=this.version,e.next=6,this.encryptString004(t,n,a,{u:r,v:o});case 6:return i=e.sent,s=[o,a,i].join(":"),e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(s=nr(l.a.mark((function e(n,r,a){var o,i,s,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r!==yn.a.DecryptedBareObject&&r!==yn.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",ir(sr(t.prototype),"generateEncryptedParameters",this).call(this,n,r,a));case 2:if(r===yn.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(r);case 4:if(n.uuid){e.next=6;break}throw"payload.uuid cannot be null";case 6:if(a&&a.itemsKey){e.next=8;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 8:return e.next=10,this.crypto.generateRandomKey(xn.EncryptionKeyLength);case 10:return o=e.sent,i=JSON.stringify(n.content),e.next=14,this.generateEncryptedProtocolString(i,o,n.uuid);case 14:return s=e.sent,e.next=17,this.generateEncryptedProtocolString(o,a.itemsKey,n.uuid);case 17:return c=e.sent,e.abrupt("return",Object(y.c)({uuid:n.uuid,items_key_id:a instanceof hn.b?a.uuid:void 0,content:s,enc_item_key:c}));case 19:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(i=nr(l.a.mark((function e(n,r){var a,o,i,s,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((a=n.format)!==yn.a.DecryptedBareObject&&a!==yn.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",ir(sr(t.prototype),"generateDecryptedParameters",this).call(this,n,r));case 3:if(n.uuid){e.next=5;break}throw"encryptedParameters.uuid cannot be null";case 5:if(r&&r.itemsKey){e.next=7;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 7:return o=this.deconstructEncryptedPayloadString(n.enc_item_key),e.next=10,this.decryptString004(o.ciphertext,r.itemsKey,o.nonce,{u:n.uuid,v:o.version});case 10:if(i=e.sent){e.next=14;break}return console.error("Error decrypting itemKey parameters",n),e.abrupt("return",Object(y.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 14:return s=this.deconstructEncryptedPayloadString(n.contentString),e.next=17,this.decryptString004(s.ciphertext,i,s.nonce,{u:n.uuid,v:s.version});case 17:if(c=e.sent){e.next=22;break}return e.abrupt("return",Object(y.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 22:return e.abrupt("return",Object(y.a)(n,{content:JSON.parse(c),items_key_id:void 0,enc_item_key:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===n.errorDecrypting,waitingForKey:!1}));case 23:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"deconstructEncryptedPayloadString",value:function(e){var t=e.split(":");return{version:t[0],nonce:t[1],ciphertext:t[2]}}},{key:"deriveKey",value:(o=nr(l.a.mark((function e(t,n,r){var a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.argon2(t,n,r,xn.ArgonMemLimit,xn.ArgonOutputKeyBytes);case 2:return a=e.sent,o=this.splitKey(a,2),i=o[0],s=o[1],e.abrupt("return",un.Create({masterKey:i,serverPassword:s,version:this.version}));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"version",get:function(){return en.a.V004}}])&&ar(n.prototype,r),a&&ar(n,a),t}(Zn);function lr(e){return(lr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function fr(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function pr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function hr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function yr(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){hr(o,r,a,i,s,"next",e)}function s(e){hr(o,r,a,i,s,"throw",e)}i(void 0)}))}}function dr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function vr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function br(e,t){return!t||"object"!==lr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function mr(e){return(mr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function gr(e,t){return(gr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wr={WebPasscodeParamsKey:"offlineParams",MobilePasscodeParamsKey:"pc_params",AllAccountKeyParamsKey:"auth_params",WebEncryptedStorageKey:"encryptedStorage",MobileWrappedRootKeyKey:"encrypted_account_keys",AllMigrations:"migrations"},kr=function(e){function t(){return dr(this,t),br(this,mr(t).apply(this,arguments))}var n,r,o,i,u,h,y,b,m,g,x,S,O;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&gr(e,t)}(t,e),n=t,r=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(a.PreparingForLaunch_0,yr(l.a.mark((function t(){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!w(e.services.environment)){t.next=4;break}return t.abrupt("return",e.migrateStorageStructureForWebDesktop());case 4:if(!k(e.services.environment)){t.next=6;break}return t.abrupt("return",e.migrateStorageStructureForMobile());case 6:case"end":return t.stop()}}),t)})))),this.registerStageHandler(a.StorageDecrypted_09,yr(l.a.mark((function t(){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateArbitraryRawStorageToManagedStorageAllPlatforms();case 2:return t.next=4,e.migrateSessionStorage();case 4:return t.next=6,e.deleteLegacyStorageValues();case 6:case"end":return t.stop()}}),t)})))),this.registerStageHandler(a.LoadingDatabase_11,yr(l.a.mark((function t(){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.createDefaultItemsKeyForAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateStorageStructureForWebDesktop",value:(O=yr(l.a.mark((function e(){var t,n,r,a,o,i,s,c,u,f,h,y,d,v,b,m,g,w,k;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.services.deviceInterface,pr(t={},T.Wrapped,{}),pr(t,T.Unwrapped,{}),pr(t,T.Nonwrapped,{}),r=t,e.next=4,n.getJsonParsedStorageValue(wr.AllAccountKeyParamsKey);case 4:return(a=e.sent)&&(r.nonwrapped[j.RootKeyParams]=a),e.next=8,n.getJsonParsedStorageValue(wr.WebEncryptedStorageKey);case 8:if(!(o=e.sent)){e.next=36;break}return i=Object(F.e)(o),e.next=13,this.webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage(i);case 13:if(s=e.sent,c=s.key,u=s.decryptedStoragePayload,f=s.keyParams,r.nonwrapped[j.RootKeyWrapperKeyParams]=f.getPortableValue(),h=Object(p.a)(u.contentObject.storage),y=Object(p.r)(h),r.nonwrapped[j.RootKeyParams]=y[wr.AllAccountKeyParamsKey],d=c,Object(p.m)(y.mk)){e.next=31;break}return e.next=26,this.webDesktopHelperExtractAndWrapAccountKeysFromValueStore(c,y);case 26:v=e.sent,b=v.accountKey,m=v.wrappedKey,d=b,r.nonwrapped[j.WrappedRootKey]=m;case 31:return e.next=33,this.webDesktopHelperEncryptStorage(d,u,y);case 33:r.wrapped=e.sent,e.next=55;break;case 36:return e.next=38,this.services.deviceInterface.getRawStorageValue("ak");case 38:return g=e.sent,w=Object(p.m)(g)?en.a.V002:en.a.V003,e.t0=un,e.next=43,this.services.deviceInterface.getRawStorageValue("mk");case 43:return e.t1=e.sent,e.next=46,this.services.deviceInterface.getRawStorageValue("pw");case 46:return e.t2=e.sent,e.t3=g,e.t4=w,e.t5={masterKey:e.t1,serverPassword:e.t2,dataAuthenticationKey:e.t3,version:e.t4},e.next=52,e.t0.Create.call(e.t0,e.t5);case 52:return k=e.sent,e.next=55,this.services.deviceInterface.setKeychainValue(k.getPersistableValue());case 55:return e.next=57,this.allPlatformHelperSetStorageStructure(r);case 57:case"end":return e.stop()}}),e,this)}))),function(){return O.apply(this,arguments)})},{key:"allPlatformHelperSetStorageStructure",value:(S=yr(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=J.defaultValuesObject(t.wrapped,t.unwrapped,t.nonwrapped))[T.Unwrapped]=void 0,e.next=4,this.services.deviceInterface.setRawStorageValue(I(this.services.namespace,P.StorageObject),JSON.stringify(n));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage",value:(x=yr(l.a.mark((function e(t){var n,r,a,o,i,u,f,p,h,y;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getJsonParsedStorageValue(wr.WebPasscodeParamsKey);case 2:n=e.sent,r=this.services.protocolService.createKeyParams(n),o=!0,u=new _([s.LocalPasscode],c.Migration);case 6:if(!o){e.next=23;break}return f={},e.next=10,this.requestChallengeResponse(u,!1,f);case 10:return p=e.sent,h=p.getValueForType(s.LocalPasscode),y=h.value,e.next=15,this.services.protocolService.computeRootKey(y,r);case 15:return i=e.sent,e.next=18,this.services.protocolService.payloadByDecryptingPayload(t,i);case 18:a=e.sent,o=a.errorDecrypting,f.orchestrator.setValidationStatus(h,!a.errorDecrypting),e.next=6;break;case 23:return e.abrupt("return",{decryptedStoragePayload:a,key:i,keyParams:r});case 24:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"webDesktopHelperExtractAndWrapAccountKeysFromValueStore",value:(g=yr(l.a.mark((function e(t,n){var r,a,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.ak?en.a.V003:en.a.V002,e.next=3,un.Create({masterKey:n.mk,serverPassword:n.pw,dataAuthenticationKey:n.ak,version:r});case 3:if(a=e.sent,delete n.mk,delete n.pw,delete n.ak,o=Object(F.e)(a),!t){e.next=12;break}return e.next=11,this.services.protocolService.payloadByEncryptingPayload(o,K.a.LocalStorageEncrypted,t);case 11:i=e.sent;case 12:return e.abrupt("return",{accountKey:a,wrappedKey:i});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)})},{key:"webDesktopHelperEncryptStorage",value:(m=yr(l.a.mark((function e(t,n,r){var a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.protocolService.payloadByEncryptingPayload(Object(F.b)(n,{content_type:ze.b.EncryptedStorage,content:r}),K.a.LocalStoragePreferEncrypted,t);case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return m.apply(this,arguments)})},{key:"migrateStorageStructureForMobile",value:(b=yr(l.a.mark((function e(){var t,n,r,a,o,i,u,h,y,d,b,m,g,w,k,x,S,O,P,C,D,E=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getJsonParsedStorageValue(wr.MobileWrappedRootKeyKey);case 2:return r=e.sent,e.next=5,this.services.deviceInterface.getJsonParsedStorageValue(wr.AllAccountKeyParamsKey);case 5:return a=e.sent,e.next=8,this.services.deviceInterface.getJsonParsedStorageValue(wr.MobilePasscodeParamsKey);case 8:return o=e.sent,pr(n={},T.Nonwrapped,(pr(t={},j.WrappedRootKey,r),pr(t,j.RootKeyWrapperKeyParams,o),pr(t,j.RootKeyParams,a),t)),pr(n,T.Unwrapped,{}),pr(n,T.Wrapped,{}),i=n,e.next=12,this.services.deviceInterface.getKeychainValue();case 12:if(u=e.sent,!o){e.next=56;break}if(h=this.services.protocolService.createKeyParams(o),y=function(){var e=yr(l.a.mark((function e(){var t,n,r,a,o,i,f;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=u.offline.pw,r=new _([s.LocalPasscode],c.Migration),a={};case 3:if(n&&n.serverPassword===t){e.next=15;break}return e.next=6,E.requestChallengeResponse(r,!1,a);case 6:return o=e.sent,i=o.getValueForType(s.LocalPasscode),f=i.value,e.next=11,E.services.protocolService.computeRootKey(f,h);case 11:n=e.sent,a.orchestrator.setValidationStatus(i,n.serverPassword===t),e.next=3;break;case 15:return e.abrupt("return",n);case 16:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),d=u.offline.timing,i.unwrapped[j.MobilePasscodeTiming]=d,!r){e.next=36;break}return e.next=21,y();case 21:return b=e.sent,e.next=24,this.services.protocolService.payloadByDecryptingPayload(Object(F.e)(r),b);case 24:return m=e.sent,g=m.contentObject.accountKeys,w=Object(p.m)(g.ak)?en.a.V002:en.a.V003,k=Object(F.b)(m,{content:{masterKey:g.mk,serverPassword:g.pw,dataAuthenticationKey:g.ak,version:g.version||w,accountKeys:null}}),e.next=30,this.services.protocolService.payloadByEncryptingPayload(k,K.a.LocalStoragePreferEncrypted,b);case 30:return x=e.sent,i.nonwrapped[j.WrappedRootKey]=x,e.next=34,this.services.deviceInterface.clearKeychainValue();case 34:e.next=54;break;case 36:if(r){e.next=54;break}return e.next=39,y();case 39:return S=e.sent,e.t0=F.e,e.next=43,f.a.GenerateUuid();case 43:return e.t1=e.sent,e.t2=Object(v.b)(i.unwrapped),e.t3=ze.b.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},O=(0,e.t0)(e.t4),e.next=50,this.services.protocolService.payloadByEncryptingPayload(O,K.a.LocalStoragePreferEncrypted,S);case 50:return P=e.sent,i.wrapped=P,e.next=54,this.services.deviceInterface.clearKeychainValue();case 54:e.next=64;break;case 56:if(!u||!u.mk){e.next=64;break}return C=Object(p.m)(u.ak)?en.a.V002:en.a.V003,e.next=61,un.Create({masterKey:u.mk,serverPassword:u.pw,dataAuthenticationKey:u.ak,version:u.version||C});case 61:return D=e.sent,e.next=64,this.services.deviceInterface.setKeychainValue(D.getPersistableValue());case 64:return e.next=66,this.allPlatformHelperSetStorageStructure(i);case 66:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"migrateArbitraryRawStorageToManagedStorageAllPlatforms",value:(y=yr(l.a.mark((function e(){var t,n,r,a,o,i,s,c,u,f,h,y,d,v;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getAllRawStorageKeyValues();case 2:t=e.sent,n=Object(p.t)(wr),r=function(e){try{return JSON.parse(e)}catch(t){return e}},a=this.services.namespace,o=!0,i=!1,s=void 0,e.prev=9,c=t[Symbol.iterator]();case 11:if(o=(u=c.next()).done){e.next=25;break}if(f=u.value,h=f.key,y=f.value,d=a&&a.length>0&&h.startsWith(a),!n.includes(h)&&!d){e.next=18;break}return e.abrupt("continue",22);case 18:if(Object(p.m)(y)){e.next=22;break}return v=r(y),e.next=22,this.services.storageService.setValue(h,v);case 22:o=!0,e.next=11;break;case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(9),i=!0,s=e.t0;case 31:e.prev=31,e.prev=32,o||null==c.return||c.return();case 34:if(e.prev=34,!i){e.next=37;break}throw s;case 37:return e.finish(34);case 38:return e.finish(31);case 39:case"end":return e.stop()}}),e,this,[[9,27,31,39],[32,,34,38]])}))),function(){return y.apply(this,arguments)})},{key:"deleteLegacyStorageValues",value:(h=yr(l.a.mark((function e(){var t,n,r,a,o,i,s,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=["mk","ak","jwt","ephemeral","cachedThemes"],n=[].concat(fr(Object(p.t)(j)),fr(Object(p.t)(wr)),t),r=!0,a=!1,o=void 0,e.prev=5,i=n[Symbol.iterator]();case 7:if(r=(s=i.next()).done){e.next=14;break}return c=s.value,e.next=11,this.services.deviceInterface.removeRawStorageValue(c);case 11:r=!0,e.next=7;break;case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(5),a=!0,o=e.t0;case 20:e.prev=20,e.prev=21,r||null==i.return||i.return();case 23:if(e.prev=23,!a){e.next=26;break}throw o;case 26:return e.finish(23);case 27:return e.finish(20);case 28:case"end":return e.stop()}}),e,this,[[5,16,20,28],[21,,23,27]])}))),function(){return h.apply(this,arguments)})},{key:"migrateSessionStorage",value:(u=yr(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,this.services.storageService.getValue("jwt");case 3:if(t=e.sent){e.next=6;break}return e.abrupt("return");case 6:return n=new oe(t),e.next=9,this.services.storageService.setValue(j.Session,n);case 9:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"createDefaultItemsKeyForAllPlatforms",value:(i=yr(l.a.mark((function e(){var t,n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.protocolService.getRootKey();case 2:if(!(t=e.sent)){e.next=19;break}return e.next=6,this.services.protocolService.getRootKeyParams();case 6:return n=e.sent,e.t0=F.e,e.next=10,f.a.GenerateUuid();case 10:return e.t1=e.sent,e.t2=ze.b.ItemsKey,e.t3=Object(v.b)({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:n.version}),e.t4=new Date,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:!0,dirtiedDate:e.t4},r=(0,e.t0)(e.t5),a=Object(ze.c)(r),e.next=19,this.services.itemManager.emitItemFromPayload(a.payloadRepresentation(),d.a.LocalChanged);case 19:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})}],o=[{key:"timestamp",value:function(){return new Date("2020-01-15").getTime()}}],r&&vr(n.prototype,r),o&&vr(n,o),t}(Zt);function xr(e){return(xr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Sr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Or(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Sr(o,r,a,i,s,"next",e)}function s(e){Sr(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Pr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function jr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _r(e,t){return!t||"object"!==xr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Cr(e){return(Cr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Dr(e,t){return(Dr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Er=function(e){function t(){return Pr(this,t),_r(this,Cr(t).apply(this,arguments))}var n,r,o,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Dr(e,t)}(t,e),n=t,r=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(a.PreparingForLaunch_0,Or(l.a.mark((function t(){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateMigrationTimestampAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateMigrationTimestampAllPlatforms",value:(i=Or(l.a.mark((function e(){var t,n,r,a,o,i,s,c,u;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!1,n=0,r=["migrations","ephemeral","user","cachedThemes","syncToken","encryptedStorage"];case 3:if(!(n<r.length)){e.next=14;break}return a=r[n],e.next=7,this.services.deviceInterface.getRawStorageValue(a);case 7:if(!e.sent){e.next=11;break}return t=!0,e.abrupt("break",14);case 11:n++,e.next=3;break;case 14:return o=I(this.services.namespace,P.LastMigrationTimestamp),e.next=17,this.services.deviceInterface.getRawStorageValue(o);case 17:if(i=e.sent,(s=!Object(p.m)(i))||!t){e.next=25;break}return c=new Date(0).getTime(),e.next=23,this.services.deviceInterface.setRawStorageValue(o,c);case 23:e.next=32;break;case 25:if(s||t){e.next=31;break}return u=(new Date).getTime(),e.next=29,this.services.deviceInterface.setRawStorageValue(o,u);case 29:e.next=32;break;case 31:case 32:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})}],o=[{key:"timestamp",value:function(){return new Date("2020-01-01").getTime()}}],r&&jr(n.prototype,r),o&&jr(n,o),t}(Zt);function Ir(e){return(Ir="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Rr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ar(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Rr(o,r,a,i,s,"next",e)}function s(e){Rr(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Mr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Tr(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Kr(e,t,n){return(Kr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Lr(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Lr(e){return(Lr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Fr(e,t){return(Fr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Vr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Nr,Ur=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==Ir(t)&&"function"!=typeof t?Tr(e):t}(this,Lr(t).call(this)),Vr(Tr(r),"challengeResponder",void 0),Vr(Tr(r),"activeMigrations",void 0),Vr(Tr(r),"services",void 0),Vr(Tr(r),"handledFullSyncStage",!1),r.services=e,r.challengeResponder=n,r}var n,o,i,s,c,u,f,h,y,d,v;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Fr(e,t)}(t,e),n=t,(o=[{key:"deinit",value:function(){this.services=void 0,this.challengeResponder=void 0,this.activeMigrations&&(this.activeMigrations.length=0),Kr(Lr(t.prototype),"deinit",this).call(this)}},{key:"initialize",value:(v=Ar(l.a.mark((function e(){var t,n=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.runBaseMigration();case 2:return e.next=4,this.getRequiredMigrations();case 4:this.activeMigrations=e.sent,this.activeMigrations.length>0&&(t=Object(p.s)(this.activeMigrations)).onDone(Ar(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.saveLastMigrationTimestamp(t.constructor.timestamp());case 2:case"end":return e.stop()}}),e)}))));case 6:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"handleApplicationStage",value:(d=Ar(l.a.mark((function e(n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Kr(Lr(t.prototype),"handleApplicationStage",this).call(this,n);case 2:return e.next=4,this.handleStage(n);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"handleApplicationEvent",value:(y=Ar(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==b.a.SignedIn){e.next=5;break}return e.next=3,this.handleStage(a.SignedIn_30);case 3:e.next=10;break;case 5:if(t!==b.a.CompletedSync){e.next=10;break}if(this.handledFullSyncStage){e.next=10;break}return this.handledFullSyncStage=!0,e.next=10,this.handleStage(a.FullSyncCompleted_13);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"runBaseMigration",value:(h=Ar(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Er(this.services),e.next=3,t.handleStage(a.PreparingForLaunch_0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"getRequiredMigrations",value:(f=Ar(l.a.mark((function e(){var t,n,a,o,i,s,c,u,f;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLastMigrationTimestamp();case 2:for(t=e.sent,n=[],a=Object.keys(r).map((function(e){return r[e]})).sort((function(e,t){var n=e.timestamp(),r=t.timestamp();return n<r?-1:n>r?1:0})),o=!0,i=!1,s=void 0,e.prev=8,c=a[Symbol.iterator]();!(o=(u=c.next()).done);o=!0)(f=u.value).timestamp()>t&&n.push(new f(this.services,this.challengeResponder));e.next=16;break;case 12:e.prev=12,e.t0=e.catch(8),i=!0,s=e.t0;case 16:e.prev=16,e.prev=17,o||null==c.return||c.return();case 19:if(e.prev=19,!i){e.next=22;break}throw s;case 22:return e.finish(19);case 23:return e.finish(16);case 24:return e.abrupt("return",n);case 25:case"end":return e.stop()}}),e,this,[[8,12,16,24],[17,,19,23]])}))),function(){return f.apply(this,arguments)})},{key:"getTimeStampKey",value:function(){return I(this.services.namespace,P.LastMigrationTimestamp)}},{key:"getLastMigrationTimestamp",value:(u=Ar(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getRawStorageValue(this.getTimeStampKey());case 2:if(t=e.sent,!Object(p.m)(t)){e.next=5;break}throw"Timestamp should not be null. Be sure to run base migration first.";case 5:return e.abrupt("return",JSON.parse(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"saveLastMigrationTimestamp",value:(c=Ar(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.setRawStorageValue(this.getTimeStampKey(),JSON.stringify(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"handleStage",value:(s=Ar(l.a.mark((function e(t){var n,r,a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,r=!1,a=void 0,e.prev=3,o=this.activeMigrations[Symbol.iterator]();case 5:if(n=(i=o.next()).done){e.next=12;break}return s=i.value,e.next=9,s.handleStage(t);case 9:n=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,a=e.t0;case 18:e.prev=18,e.prev=19,n||null==o.return||o.return();case 21:if(e.prev=21,!r){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return s.apply(this,arguments)})}])&&Mr(n.prototype,o),i&&Mr(n,i),t}(L.a);function Br(e){return(Br="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Wr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Hr(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Wr(o,r,a,i,s,"next",e)}function s(e){Wr(o,r,a,i,s,"throw",e)}i(void 0)}))}}function zr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function qr(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Yr(e,t,n){return(Yr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Jr(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Jr(e){return(Jr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Gr(e,t){return(Gr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Qr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.RootKeyNone=0]="RootKeyNone",e[e.RootKeyOnly=1]="RootKeyOnly",e[e.RootKeyPlusWrapper=2]="RootKeyPlusWrapper",e[e.WrapperOnly=3]="WrapperOnly"}(Nr||(Nr={}));var $r=en.a.V003,Xr=function(e){function t(e,n,r,a,o){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),i=function(e,t){return!t||"object"!==Br(t)&&"function"!=typeof t?qr(e):t}(this,Jr(t).call(this)),Qr(qr(i),"itemManager",void 0),Qr(qr(i),"modelManager",void 0),Qr(qr(i),"storageService",void 0),Qr(qr(i),"crypto",void 0),Qr(qr(i),"operators",{}),Qr(qr(i),"keyMode",Nr.RootKeyNone),Qr(qr(i),"keyObservers",[]),Qr(qr(i),"rootKey",void 0),Qr(qr(i),"removeMappingObserver",void 0),i.itemManager=e,i.modelManager=n,i.deviceInterface=r,i.storageService=a,i.crypto=o,!i.crypto&&Object(p.p)()&&Object(dn.isWebCryptoAvailable)()&&(i.crypto=new dn.SNWebCrypto),f.a.SetGenerators(i.crypto.generateUUIDSync,i.crypto.generateUUID),Object.defineProperty(qr(i),"rootKey",{enumerable:!1,writable:!0}),i.removeMappingObserver=i.modelManager.addChangeObserver([h.a.ItemsKey],function(){var e=Hr(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n.length>0)){e.next=3;break}return e.next=3,i.decryptErroredItems();case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()),i}var n,r,a,o,i,s,c,u,y,d,m,g,w,k,x,S,O,P,_,C,D,E,I,R,A,T,L,V,N,U,B,W,H,z,q,Y,J,G,Q,$,X,Z,ee,te,ne,re;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Gr(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.itemManager=void 0,this.modelManager=void 0,this.deviceInterface=void 0,this.storageService=void 0,this.crypto.deinit(),this.crypto=void 0,this.operators={},this.keyObservers.length=0,this.removeMappingObserver(),this.removeMappingObserver=null,this.rootKey=void 0,Yr(Jr(t.prototype),"deinit",this).call(this)}},{key:"initialize",value:(re=Hr(l.a.mark((function e(){var t,n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKey();case 2:return t=e.sent,e.next=5,this.getAccountKeyParams();case 5:return n=e.sent,e.next=8,this.hasRootKeyWrapper();case 8:if(r=e.sent,a=!Object(p.m)(t)||!Object(p.m)(n),!r||!a){e.next=14;break}this.keyMode=Nr.RootKeyPlusWrapper,e.next=27;break;case 14:if(!r||a){e.next=18;break}this.keyMode=Nr.WrapperOnly,e.next=27;break;case 18:if(r||!a){e.next=22;break}this.keyMode=Nr.RootKeyOnly,e.next=27;break;case 22:if(r||a){e.next=26;break}this.keyMode=Nr.RootKeyNone,e.next=27;break;case 26:throw"Invalid key mode condition";case 27:if(this.keyMode!==Nr.RootKeyOnly){e.next=33;break}return e.next=30,this.getRootKeyFromKeychain();case 30:return this.rootKey=e.sent,e.next=33,this.notifyObserversOfKeyChange();case 33:case"end":return e.stop()}}),e,this)}))),function(){return re.apply(this,arguments)})},{key:"getLatestVersion",value:function(){return en.a.V004}},{key:"getUserVersion",value:(ne=Hr(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getAccountKeyParams();case 2:return t=e.sent,e.abrupt("return",t&&t.version);case 4:case"end":return e.stop()}}),e,this)}))),function(){return ne.apply(this,arguments)})},{key:"upgradeAvailable",value:(te=Hr(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.accountUpgradeAvailable();case 2:return t=e.sent,e.next=5,this.passcodeUpgradeAvailable();case 5:return n=e.sent,e.abrupt("return",t||n);case 7:case"end":return e.stop()}}),e,this)}))),function(){return te.apply(this,arguments)})},{key:"accountUpgradeAvailable",value:(ee=Hr(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getUserVersion();case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.abrupt("return",t!==this.getLatestVersion());case 6:case"end":return e.stop()}}),e,this)}))),function(){return ee.apply(this,arguments)})},{key:"passcodeUpgradeAvailable",value:(Z=Hr(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.abrupt("return",t.version!==this.getLatestVersion());case 6:case"end":return e.stop()}}),e,this)}))),function(){return Z.apply(this,arguments)})},{key:"platformSupportsKeyDerivation",value:function(e){return Object(en.b)(e.version,en.a.V004)>=0||!!Object(dn.isWebCryptoAvailable)()}},{key:"supportedVersions",value:function(){return[en.a.V001,en.a.V002,en.a.V003,en.a.V004]}},{key:"isVersionNewerThanLibraryVersion",value:function(e){var t=this.getLatestVersion();return 1===Object(en.b)(e,t)}},{key:"isProtocolVersionOutdated",value:function(e){var t,n=(Qr(t={},en.a.V001,Date.parse("2018-01-01")),Qr(t,en.a.V002,Date.parse("2020-01-01")),t)[e];return!!n&&(new Date).getTime()>n}},{key:"costMinimumForVersion",value:function(e){if(Object(en.b)(e,en.a.V003)>=0)throw"Cost minimums only apply to versions <= 002";if(e===en.a.V001)return gn.PbkdfMinCost;if(e===en.a.V002)return wn.PbkdfMinCost;throw"Invalid version for cost minimum: ".concat(e)}},{key:"createOperatorForLatestVersion",value:function(){return this.createOperatorForVersion(this.getLatestVersion())}},{key:"createOperatorForVersion",value:function(e){if(e===en.a.V001)return new Mn(this.crypto);if(e===en.a.V002)return new Hn(this.crypto);if(e===en.a.V003)return new Zn(this.crypto);if(e===en.a.V004)return new ur(this.crypto);if(e===en.a.V000Base64Decrypted)return this.createOperatorForLatestVersion();throw"Unable to find operator for version ".concat(e)}},{key:"operatorForVersion",value:function(e){var t=e,n=this.operators[t];return n||(n=this.createOperatorForVersion(e),this.operators[t]=n),n}},{key:"defaultOperator",value:function(){return this.operatorForVersion(this.getLatestVersion())}},{key:"computeRootKey",value:(X=Hr(l.a.mark((function e(t,n){var r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.version,a=this.operatorForVersion(r),e.abrupt("return",a.computeRootKey(t,n));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return X.apply(this,arguments)})},{key:"createRootKey",value:($=Hr(l.a.mark((function e(t,n){var r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.defaultOperator(),e.abrupt("return",r.createRootKey(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return $.apply(this,arguments)})},{key:"payloadContentFormatForIntent",value:function(e,t){if(t){if(e===K.a.Sync||e===K.a.FileEncrypted||e===K.a.FilePreferEncrypted||e===K.a.LocalStorageEncrypted||e===K.a.LocalStoragePreferEncrypted)return F.j.EncryptedString;throw"Unhandled encrypted case in protocolService.payloadContentFormatForIntent."}if(e===K.a.LocalStorageDecrypted||e===K.a.LocalStoragePreferEncrypted||e===K.a.FileDecrypted||e===K.a.FilePreferEncrypted)return F.j.DecryptedBareObject;if(e===K.a.SyncDecrypted)return F.j.DecryptedBase64String;throw"Unhandled decrypted case in protocolService.payloadContentFormatForIntent."}},{key:"payloadByEncryptingPayload",value:(Q=Hr(l.a.mark((function e(t,n,r){var a,o,i,s,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.errorDecrypting){e.next=2;break}return e.abrupt("return",t);case 2:if(!t.deleted){e.next=4;break}return e.abrupt("return",t);case 4:if(!Object(p.m)(n)){e.next=6;break}throw"Attempting to encrypt payload with null intent";case 6:if(r||Object(K.c)(n)){e.next=10;break}return e.next=9,this.keyToUseForEncryptionOfPayload(t,n);case 9:r=e.sent;case 10:if(r||!Object(K.b)(n)){e.next=12;break}throw"Attempting to generate encrypted payload with no key.";case 12:if(t.format===F.j.DecryptedBareObject){e.next=14;break}throw"Attempting to encrypt already encrypted payload.";case 14:if(t.content){e.next=16;break}throw"Attempting to encrypt payload with no content.";case 16:if(t.uuid){e.next=18;break}throw"Attempting to encrypt payload with no uuid.";case 18:return a=r?r.version:this.getLatestVersion(),o=this.payloadContentFormatForIntent(n,r),i=this.operatorForVersion(a),e.next=23,i.generateEncryptedParameters(t,o,r);case 23:if(s=e.sent){e.next=26;break}throw"Unable to generate encryption parameters";case 26:return c=Object(F.d)(t,n,s),e.abrupt("return",c);case 28:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return Q.apply(this,arguments)})},{key:"payloadsByEncryptingPayloads",value:(G=Hr(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f,h;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a=!0,o=!1,i=void 0,e.prev=4,s=t[Symbol.iterator]();case 6:if(a=(c=s.next()).done){e.next=16;break}return u=c.value,f=Object(p.l)(n)?n(u):n,e.next=11,this.payloadByEncryptingPayload(u,f);case 11:h=e.sent,r.push(h);case 13:a=!0,e.next=6;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(4),o=!0,i=e.t0;case 22:e.prev=22,e.prev=23,a||null==s.return||s.return();case 25:if(e.prev=25,!o){e.next=28;break}throw i;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return e.abrupt("return",r);case 31:case"end":return e.stop()}}),e,this,[[4,18,22,30],[23,,25,29]])}))),function(e,t){return G.apply(this,arguments)})},{key:"payloadByDecryptingPayload",value:(J=Hr(l.a.mark((function e(t,n){var r,a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.content){e.next=2;break}throw"Attempting to decrypt payload that has no content.";case 2:if((r=t.format)!==F.j.DecryptedBareObject){e.next=5;break}return e.abrupt("return",t);case 5:if(n||r!==F.j.EncryptedString){e.next=11;break}return e.next=8,this.keyToUseForDecryptionOfPayload(t);case 8:if(n=e.sent){e.next=11;break}return e.abrupt("return",Object(F.e)(t,void 0,void 0,{waitingForKey:!0,errorDecrypting:!0}));case 11:return a=t.version,o=this.operatorForVersion(a),i=Object(F.c)(t),e.next=16,o.generateDecryptedParameters(i,n);case 16:return s=e.sent,e.abrupt("return",Object(F.e)(t,void 0,void 0,s));case 18:case"end":return e.stop()}}),e,this)}))),function(e,t){return J.apply(this,arguments)})},{key:"payloadsByDecryptingPayloads",value:(Y=Hr(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a=!0,o=!1,i=void 0,e.prev=4,s=t[Symbol.iterator]();case 6:if(a=(c=s.next()).done){e.next=32;break}if(u=c.value){e.next=11;break}return r.push(u),e.abrupt("continue",29);case 11:if(!0!==u.deleted||!Object(p.m)(u.content)){e.next=14;break}return r.push(u),e.abrupt("continue",29);case 14:if(Object(p.o)(u.content)){e.next=18;break}return r.push(u),e.abrupt("continue",29);case 18:return e.prev=18,e.next=21,this.payloadByDecryptingPayload(u,n);case 21:f=e.sent,r.push(f),e.next=29;break;case 25:e.prev=25,e.t0=e.catch(18),r.push(Object(F.e)(u,void 0,void 0,{errorDecrypting:!0,errorDecryptingValueChanged:!u.errorDecrypting})),console.error("Error decrypting payload",u,e.t0);case 29:a=!0,e.next=6;break;case 32:e.next=38;break;case 34:e.prev=34,e.t1=e.catch(4),o=!0,i=e.t1;case 38:e.prev=38,e.prev=39,a||null==s.return||s.return();case 41:if(e.prev=41,!o){e.next=44;break}throw i;case 44:return e.finish(41);case 45:return e.finish(38);case 46:return e.abrupt("return",r);case 47:case"end":return e.stop()}}),e,this,[[4,34,38,46],[18,25],[39,,41,45]])}))),function(e,t){return Y.apply(this,arguments)})},{key:"decryptErroredItems",value:(q=Hr(l.a.mark((function e(){var t,n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(t=this.itemManager.items.filter((function(e){return e.waitingForKey||e.errorDecrypting}))).length){e.next=3;break}return e.abrupt("return");case 3:return n=t.map((function(e){return e.payloadRepresentation()})),e.next=6,this.payloadsByDecryptingPayloads(n);case 6:return r=e.sent,e.next=9,this.modelManager.emitPayloads(r,F.k.LocalChanged);case 9:case"end":return e.stop()}}),e,this)}))),function(){return q.apply(this,arguments)})},{key:"payloadsByDecryptingBackupFile",value:(z=Hr(l.a.mark((function e(t,n){var r,a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.keyParams||t.auth_params,a=t.items,o=a.map((function(e){return Object(F.f)(e,F.k.FileImport)})),!r){e.next=12;break}return e.next=6,this.computeRootKey(n,r);case 6:return s=e.sent,e.next=9,this.payloadsByDecryptingPayloads(o,s);case 9:i=e.sent,e.next=13;break;case 12:i=o;case 13:return e.abrupt("return",i);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return z.apply(this,arguments)})},{key:"createKeyParams",value:function(e){return e.version||(e.version=en.a.V002),fn(e)}},{key:"createBackupFile",value:(H=Hr(l.a.mark((function e(t){var n,r,a,o,i,s,c,u,f=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=f.length>1&&void 0!==f[1]?f[1]:K.a.FilePreferEncrypted,r=f.length>2&&void 0!==f[2]&&f[2],a=t||this.itemManager.items,!r||0!==a.length){e.next=5;break}return e.abrupt("return",null);case 5:return o=a.map((function(e){return Object(F.e)(e)})),e.next=8,this.payloadsByEncryptingPayloads(o,n);case 8:return i=e.sent,s={items:i},e.next=12,this.getRootKeyParams();case 12:return(c=e.sent)&&n!==K.a.FileDecrypted&&(s.keyParams=c.getPortableValue()),u=2,e.abrupt("return",JSON.stringify(s,null,u));case 16:case"end":return e.stop()}}),e,this)}))),function(e){return H.apply(this,arguments)})},{key:"onKeyStatusChange",value:function(e){var t=this;return this.keyObservers.push(e),function(){Object(p.x)(t.keyObservers,e)}}},{key:"notifyObserversOfKeyChange",value:(W=Hr(l.a.mark((function e(){var t,n,r,a,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,n=!1,r=void 0,e.prev=3,a=this.keyObservers[Symbol.iterator]();case 5:if(t=(o=a.next()).done){e.next=12;break}return i=o.value,e.next=9,i();case 9:t=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),n=!0,r=e.t0;case 18:e.prev=18,e.prev=19,t||null==a.return||a.return();case 21:if(e.prev=21,!n){e.next=24;break}throw r;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(){return W.apply(this,arguments)})},{key:"getRootKeyFromKeychain",value:(B=Hr(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getKeychainValue();case 2:if(t=e.sent,!Object(p.m)(t)){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.next=7,un.Create(t);case 7:return n=e.sent,e.abrupt("return",n);case 9:case"end":return e.stop()}}),e,this)}))),function(){return B.apply(this,arguments)})},{key:"saveRootKeyToKeychain",value:(U=Hr(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(p.m)(this.rootKey)){e.next=2;break}throw"Attempting to non-existent root key to the keychain.";case 2:if(this.keyMode===Nr.RootKeyOnly){e.next=4;break}throw"Should not be persisting wrapped key to keychain.";case 4:return t=this.rootKey.getPersistableValue(),e.next=7,this.deviceInterface.setKeychainValue(t);case 7:case"end":return e.stop()}}),e,this)}))),function(){return U.apply(this,arguments)})},{key:"hasRootKeyWrapper",value:(N=Hr(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return t=e.sent,e.abrupt("return",!Object(p.m)(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return N.apply(this,arguments)})},{key:"hasPasscode",value:function(){return this.keyMode===Nr.WrapperOnly||this.keyMode===Nr.RootKeyPlusWrapper}},{key:"rootKeyNeedsUnwrapping",value:(V=Hr(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.hasRootKeyWrapper();case 2:if(e.t0=e.sent,!e.t0){e.next=5;break}e.t0=Object(p.m)(this.rootKey);case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}}),e,this)}))),function(){return V.apply(this,arguments)})},{key:"getRootKeyWrapperKeyParams",value:(L=Hr(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(j.RootKeyWrapperKeyParams,M.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.abrupt("return",this.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return L.apply(this,arguments)})},{key:"getWrappedRootKey",value:(T=Hr(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(j.WrappedRootKey,M.Nonwrapped));case 1:case"end":return e.stop()}}),e,this)}))),function(){return T.apply(this,arguments)})},{key:"getRootKeyParams",value:(A=Hr(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==Nr.WrapperOnly){e.next=4;break}return e.abrupt("return",this.getRootKeyWrapperKeyParams());case 4:if(this.keyMode!==Nr.RootKeyOnly&&this.keyMode!==Nr.RootKeyPlusWrapper){e.next=8;break}return e.abrupt("return",this.getAccountKeyParams());case 8:throw"Unhandled key mode for getRootKeyParams ".concat(this.keyMode);case 9:case"end":return e.stop()}}),e,this)}))),function(){return A.apply(this,arguments)})},{key:"getAccountKeyParams",value:(R=Hr(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(j.RootKeyParams,M.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.abrupt("return",this.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return R.apply(this,arguments)})},{key:"validateWrappingKey",value:(I=Hr(l.a.mark((function e(t){var n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKey();case 2:if(n=e.sent,this.keyMode!==Nr.WrapperOnly){e.next=7;break}return e.abrupt("return",this.storageService.canDecryptWithKey(t));case 7:if(this.keyMode!==Nr.RootKeyOnly&&this.keyMode!==Nr.RootKeyPlusWrapper){e.next=15;break}return r=Object(F.e)(n),e.next=11,this.payloadByDecryptingPayload(r,t);case 11:return a=e.sent,e.abrupt("return",!a.errorDecrypting);case 15:throw"Unhandled case in validateWrappingKey";case 16:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"computeWrappingKey",value:(E=Hr(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:return r=e.sent,e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"unwrapRootKey",value:(D=Hr(l.a.mark((function e(t){var n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==Nr.WrapperOnly){e.next=3;break}return this.rootKey=t,e.abrupt("return");case 3:if(this.keyMode===Nr.RootKeyPlusWrapper){e.next=5;break}throw"Invalid key mode condition for unwrapping.";case 5:return e.next=7,this.getWrappedRootKey();case 7:return n=e.sent,r=Object(F.e)(n),e.next=11,this.payloadByDecryptingPayload(r,t);case 11:if(!(a=e.sent).errorDecrypting){e.next=16;break}throw Error("Unable to decrypt root key with provided wrapping key.");case 16:return e.next=18,un.Create(a.contentObject,a.uuid);case 18:return this.rootKey=e.sent,e.next=21,this.notifyObserversOfKeyChange();case 21:case"end":return e.stop()}}),e,this)}))),function(e){return D.apply(this,arguments)})},{key:"setNewRootKeyWrapper",value:(C=Hr(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==Nr.RootKeyNone){e.next=4;break}this.keyMode=Nr.WrapperOnly,e.next=9;break;case 4:if(this.keyMode!==Nr.RootKeyOnly){e.next=8;break}this.keyMode=Nr.RootKeyPlusWrapper,e.next=9;break;case 8:throw"Attempting to set wrapper on already wrapped key.";case 9:return e.next=11,this.deviceInterface.clearKeychainValue();case 11:if(this.keyMode!==Nr.WrapperOnly&&this.keyMode!==Nr.RootKeyPlusWrapper){e.next=26;break}if(this.keyMode!==Nr.WrapperOnly){e.next=18;break}return this.rootKey=t,e.next=16,this.reencryptItemsKeys();case 16:e.next=20;break;case 18:return e.next=20,this.wrapAndPersistRootKey(t);case 20:return e.next=22,this.storageService.setValue(j.RootKeyWrapperKeyParams,n.getPortableValue(),M.Nonwrapped);case 22:return e.next=24,this.notifyObserversOfKeyChange();case 24:e.next=27;break;case 26:throw"Invalid keyMode on setNewRootKeyWrapper";case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return C.apply(this,arguments)})},{key:"wrapAndPersistRootKey",value:(_=Hr(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(F.e)(this.rootKey,void 0,void 0,{content:this.rootKey.getPersistableValue()}),e.next=3,this.payloadByEncryptingPayload(n,K.a.LocalStorageEncrypted,t);case 3:return r=e.sent,e.next=6,this.storageService.setValue(j.WrappedRootKey,r,M.Nonwrapped);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"removeRootKeyWrapper",value:(P=Hr(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode===Nr.WrapperOnly||this.keyMode===Nr.RootKeyPlusWrapper){e.next=2;break}throw"Attempting to remove root key wrapper on unwrapped key.";case 2:return this.keyMode===Nr.WrapperOnly?(this.keyMode=Nr.RootKeyNone,this.rootKey=void 0):this.keyMode===Nr.RootKeyPlusWrapper&&(this.keyMode=Nr.RootKeyOnly),e.next=5,this.storageService.removeValue(j.WrappedRootKey,M.Nonwrapped);case 5:return e.next=7,this.storageService.removeValue(j.RootKeyWrapperKeyParams,M.Nonwrapped);case 7:if(this.keyMode!==Nr.RootKeyOnly){e.next=10;break}return e.next=10,this.saveRootKeyToKeychain();case 10:return e.next=12,this.notifyObserversOfKeyChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return P.apply(this,arguments)})},{key:"setNewRootKey",value:(O=Hr(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}throw"keyParams must be supplied if setting root key.";case 2:if(this.rootKey!==t){e.next=4;break}throw"Attempting to set root key as same current value.";case 4:if(this.keyMode!==Nr.WrapperOnly){e.next=8;break}this.keyMode=Nr.RootKeyPlusWrapper,e.next=16;break;case 8:if(this.keyMode!==Nr.RootKeyNone){e.next=12;break}this.keyMode=Nr.RootKeyOnly,e.next=16;break;case 12:if(this.keyMode!==Nr.RootKeyOnly&&this.keyMode!==Nr.RootKeyPlusWrapper){e.next=15;break}e.next=16;break;case 15:throw"Unhandled key mode for setNewRootKey ".concat(this.keyMode);case 16:return this.rootKey=t,e.next=19,this.storageService.setValue(j.RootKeyParams,n.getPortableValue(),M.Nonwrapped);case 19:if(this.keyMode!==Nr.RootKeyOnly){e.next=24;break}return e.next=22,this.saveRootKeyToKeychain();case 22:e.next=29;break;case 24:if(this.keyMode!==Nr.RootKeyPlusWrapper){e.next=29;break}if(r){e.next=27;break}throw Error("wrappingKey must be supplied");case 27:return e.next=29,this.wrapAndPersistRootKey(r);case 29:return e.next=31,this.notifyObserversOfKeyChange();case 31:return e.next=33,this.reencryptItemsKeys();case 33:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return O.apply(this,arguments)})},{key:"getRootKey",value:(S=Hr(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rootKey);case 1:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"clearLocalKeyState",value:(x=Hr(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.clearKeychainValue();case 2:return e.next=4,this.storageService.removeValue(j.WrappedRootKey,M.Nonwrapped);case 4:return e.next=6,this.storageService.removeValue(j.RootKeyWrapperKeyParams,M.Nonwrapped);case 6:return e.next=8,this.storageService.removeValue(j.RootKeyParams,M.Nonwrapped);case 8:return this.keyMode=Nr.RootKeyNone,this.rootKey=void 0,e.next=12,this.notifyObserversOfKeyChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"validateAccountPassword",value:(k=Hr(l.a.mark((function e(t){var n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:if(r=e.sent,!(a=r.compare(this.rootKey))){e.next=11;break}return e.abrupt("return",{valid:a,artifacts:{rootKey:r}});case 11:return e.abrupt("return",{valid:!1});case 12:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"validatePasscode",value:(w=Hr(l.a.mark((function e(t){var n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:return r=e.sent,e.next=8,this.validateWrappingKey(r);case 8:if(!(a=e.sent)){e.next=13;break}return e.abrupt("return",{valid:a,artifacts:{wrappingKey:r}});case 13:return e.abrupt("return",{valid:!1});case 14:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"contentTypeUsesRootKeyEncryption",value:function(e){return e===h.a.ItemsKey||e===h.a.EncryptedStorage}},{key:"keyToUseForEncryptionOfPayload",value:(g=Hr(l.a.mark((function e(t,n){var r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(p.m)(n)){e.next=2;break}throw"Intent must be supplied when looking up key for encryption of item.";case 2:if(!this.contentTypeUsesRootKeyEncryption(t.content_type)){e.next=15;break}return e.next=5,this.getRootKey();case 5:if(r=e.sent){e.next=12;break}if(!Object(K.b)(n)){e.next=11;break}throw"Root key encryption is required but no root key is available.";case 11:return e.abrupt("return",void 0);case 12:return e.abrupt("return",r);case 15:return e.abrupt("return",this.getDefaultItemsKey());case 16:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)})},{key:"keyToUseForDecryptionOfPayload",value:(m=Hr(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.contentTypeUsesRootKeyEncryption(t.content_type)){e.next=2;break}return e.abrupt("return",this.getRootKey());case 2:if(!t.items_key_id){e.next=5;break}return n=this.itemsKeyForPayload(t),e.abrupt("return",n);case 5:if((r=t.version)!==this.getLatestVersion()){e.next=8;break}throw"No associated key found for item encrypted with latest protocol version.";case 8:return e.abrupt("return",this.defaultItemsKeyForItemVersion(r));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"onSyncEvent",value:(d=Hr(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==b.b.FullSyncCompleted){e.next=3;break}return e.next=3,this.handleFullSyncCompletion();case 3:if(t!==b.b.DownloadFirstSyncCompleted){e.next=6;break}return e.next=6,this.handleDownloadFirstSyncCompletion();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"handleDownloadFirstSyncCompletion",value:(y=Hr(l.a.mark((function e(){var t,n,r,a,o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.itemsKeys,n=t.filter((function(e){return e.neverSynced})),r=t.find((function(e){return!e.neverSynced&&e.isDefault})),Object(p.m)(r)){e.next=9;break}return e.next=7,this.itemManager.setItemsToBeDeleted(Object(v.c)(n));case 7:e.next=20;break;case 9:return e.next=11,this.getRootKey();case 11:if(!(a=e.sent)){e.next=20;break}if(!((o=n.filter((function(e){return e.version!==a.version}))).length>0)){e.next=17;break}return e.next=17,this.itemManager.setItemsToBeDeleted(Object(v.c)(o));case 17:if(0!==t.length){e.next=20;break}return e.next=20,this.createNewDefaultItemsKey();case 20:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"handleFullSyncCompletion",value:(u=Hr(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.getDefaultItemsKey()){e.next=6;break}return e.next=4,this.createNewDefaultItemsKey();case 4:if(this.keyMode!==Nr.WrapperOnly){e.next=6;break}return e.abrupt("return",this.repersistAllItems());case 6:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"repersistAllItems",value:(c=Hr(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.items,n=t.map((function(e){return Object(F.e)(e)})),e.abrupt("return",this.storageService.savePayloads(n));case 3:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"itemsKeyForPayload",value:function(e){return this.itemsKeys.find((function(t){return t.uuid===e.items_key_id}))}},{key:"getDefaultItemsKey",value:function(){return 1===this.itemsKeys.length?this.itemsKeys[0]:this.itemsKeys.find((function(e){return e.isDefault}))}},{key:"reencryptItemsKeys",value:(s=Hr(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((t=this.itemsKeys).length>0)){e.next=4;break}return e.next=4,this.itemManager.setItemsDirty(Object(v.c)(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"defaultItemsKeyForItemVersion",value:(i=Hr(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemsKeys.find((function(e){return e.version===t})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"createNewDefaultItemsKey",value:(o=Hr(l.a.mark((function e(){var t,n,r,a,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKey();case 2:if(t=e.sent,n=t?t.version:this.getLatestVersion(),!(Object(en.b)(n,$r)<=0)){e.next=16;break}return e.t0=F.e,e.next=8,f.a.GenerateUuid();case 8:e.t1=e.sent,e.t2=h.a.ItemsKey,e.t3=Object(v.b)({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:n}),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},a=(0,e.t0)(e.t4),r=Object(v.a)(a),e.next=19;break;case 16:return e.next=18,this.operatorForVersion(n).createItemsKey();case 18:r=e.sent;case 19:if(!(o=this.getDefaultItemsKey())){e.next=23;break}return e.next=23,this.itemManager.changeItemsKey(o.uuid,(function(e){e.isDefault=!1}));case 23:return e.next=25,this.itemManager.insertItem(r);case 25:return i=e.sent,e.next=28,this.itemManager.changeItemsKey(i.uuid,(function(e){e.isDefault=!0}));case 28:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"itemsKeys",get:function(){return this.itemManager.itemsKeys}}])&&zr(n.prototype,r),a&&zr(n,a),t}(L.a);function Zr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ea(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ta=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ea(this,"payload",void 0),ea(this,"defaultContentKeyToDiffOn","text"),ea(this,"textCharDiffLength",0),ea(this,"hasPreviousEntry",!1);var n=t.updated_at;Object(p.o)(n)&&(n=new Date(n)),this.payload=Object(y.b)(t,{updated_at:n})}var t,n,r;return t=e,(n=[{key:"setPreviousEntry",value:function(e){this.hasPreviousEntry=null!=e,this.payload.contentObject[this.defaultContentKeyToDiffOn]&&(this.textCharDiffLength=e?this.payload.contentObject[this.defaultContentKeyToDiffOn].length-e.payload.contentObject[this.defaultContentKeyToDiffOn].length:this.payload.contentObject[this.defaultContentKeyToDiffOn].length)}},{key:"operationVector",value:function(){return void 0!==this.textCharDiffLength?this.hasPreviousEntry&&0!==this.textCharDiffLength?this.textCharDiffLength<0?-1:1:0:1}},{key:"deltaSize",value:function(){return void 0!==this.textCharDiffLength?Math.abs(this.textCharDiffLength):1}},{key:"isSameAsEntry",value:function(e){if(!e)return!1;var t=Object(ze.c)(this.payload),n=Object(ze.c)(e.payload);return t.isItemContentEqualWith(n)}}])&&Zr(t.prototype,n),r&&Zr(t,r),e}();function na(e){return(na="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ra(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function aa(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function oa(e,t){return!t||"object"!==na(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ia(e){return(ia=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function sa(e,t){return(sa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ca=function(e){function t(){return ra(this,t),oa(this,ia(t).apply(this,arguments))}var n,r,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&sa(e,t)}(t,e),n=t,(r=[{key:"previewTitle",value:function(){return this.payload.updated_at.toLocaleString()}},{key:"previewSubTitle",value:function(){return this.hasPreviousEntry?this.textCharDiffLength<0?"".concat(-1*this.textCharDiffLength," characters removed"):this.textCharDiffLength>0?"".concat(this.textCharDiffLength," characters added"):"Title or metadata changed":"".concat(this.textCharDiffLength," characters loaded")}}])&&aa(n.prototype,r),a&&aa(n,a),t}(ta);function ua(e){var t,n,r,a=(t={},n=h.a.Note,r=ca,n in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t)[e[F.i.ContentType]];if(!a)throw"Invalid item history class";return new a(e)}function la(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var fa=function(){function e(t){var n,r,a;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a=[],(r="entries")in(n=this)?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,t){var o=!0,i=!1,s=void 0;try{for(var c,u=t[Symbol.iterator]();!(o=(c=u.next()).done);o=!0){var l=c.value;l.setPreviousEntry(this.getLastEntry()),this.entries.push(l)}}catch(e){i=!0,s=e}finally{try{o||null==u.return||u.return()}finally{if(i)throw s}}}}var t,n,r;return t=e,r=[{key:"FromJson",value:function(t){return new e(t.entries.map((function(e){return ua(e.payload)})))}}],(n=[{key:"getLastEntry",value:function(){return this.entries[this.entries.length-1]}},{key:"addHistoryEntryForItem",value:function(e){var t=ua(e),n=this.getLastEntry();if(t.setPreviousEntry(n),!t.isSameAsEntry(n))return this.entries.push(t),t}},{key:"clear",value:function(){this.entries.length=0}},{key:"optimize",value:function(){var e=this,t=[],n=function(e){return e.deltaSize()>15},r=function(r,a,o){if(o)t.push(r);else{var i=t.indexOf(r);-1!==i&&t.splice(i,1)}if(o&&n(r)&&-1===r.operationVector()){var s=e.entries[a-1];s&&t.push(s)}};this.entries.forEach((function(t,a){if(0===a||a===e.entries.length-1)r(t,a,!0);else{var o=n(t);r(t,a,o)}})),this.entries=this.entries.filter((function(e,n){return-1!==t.indexOf(e)}))}}])&&la(t.prototype,n),r&&la(t,r),e}();function pa(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ha(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ya=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ha(this,"content",void 0),ha(this,"itemRevisionThreshold",60),this.content=t,this.content||(this.content={itemUUIDToItemHistoryMapping:{}})}var t,n,r;return t=e,r=[{key:"FromJson",value:function(t){if(t){var n=t.content;return Object.keys(n.itemUUIDToItemHistoryMapping).forEach((function(e){var t=n.itemUUIDToItemHistoryMapping[e];n.itemUUIDToItemHistoryMapping[e]=fa.FromJson(t)})),new e(n)}return new e}}],(n=[{key:"addEntryForPayload",value:function(e){return this.historyForItem(e.uuid).addHistoryEntryForItem(e)}},{key:"historyForItem",value:function(e){var t=this.content.itemUUIDToItemHistoryMapping[e];return t||(t=new fa,this.content.itemUUIDToItemHistoryMapping[e]=t),t}},{key:"clearItemHistory",value:function(e){this.historyForItem(e.uuid).clear()}},{key:"clearAllHistory",value:function(){this.content.itemUUIDToItemHistoryMapping={}}},{key:"setItemRevisionThreshold",value:function(e){this.itemRevisionThreshold=e}},{key:"optimizeHistoryForItem",value:function(e){var t=this.historyForItem(e);t.entries.length>this.itemRevisionThreshold&&t.optimize()}}])&&pa(t.prototype,n),r&&pa(t,r),e}();function da(e){return(da="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function va(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ba(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){va(o,r,a,i,s,"next",e)}function s(e){va(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ma(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ga(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function wa(e,t,n){return(wa="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ka(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ka(e){return(ka=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function xa(e,t){return(xa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Sa(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Oa,Pa,ja,_a=function(e){function t(e,n,r,a){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),o=function(e,t){return!t||"object"!==da(t)&&"function"!=typeof t?ga(e):t}(this,ka(t).call(this)),Sa(ga(o),"itemManager",void 0),Sa(ga(o),"storageService",void 0),Sa(ga(o),"contentTypes",[]),Sa(ga(o),"timeout",void 0),Sa(ga(o),"historySession",void 0),Sa(ga(o),"removeChangeObserver",void 0),Sa(ga(o),"persistable",!1),Sa(ga(o),"autoOptimize",!1),Sa(ga(o),"saveTimeout",void 0),o.itemManager=e,o.storageService=n,o.contentTypes=r,o.timeout=a,o}var n,r,a,o,i,s,c,u,f,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&xa(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.itemManager=void 0,this.storageService=void 0,this.contentTypes.length=0,this.historySession=void 0,this.timeout=null,this.removeChangeObserver&&(this.removeChangeObserver(),this.removeChangeObserver=null),wa(ka(t.prototype),"deinit",this).call(this)}},{key:"initializeFromDisk",value:(h=ba(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(j.SessionHistoryPersistable);case 2:return this.persistable=e.sent,e.next=5,this.storageService.getValue(j.SessionHistoryRevisions).then((function(e){return ya.FromJson(e)}));case 5:return this.historySession=e.sent,e.next=8,this.storageService.getValue(j.SessionHistoryOptimize);case 8:t=e.sent,Object(p.m)(t)?this.autoOptimize=!0:this.autoOptimize=t,this.addChangeObserver();case 11:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"addChangeObserver",value:function(){var e=this;this.removeChangeObserver=this.itemManager.addObserver(this.contentTypes,function(){var t=ba(l.a.mark((function t(n,r,a,o){var i,s,c,u,f,h,y;return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=Object(p.e)(n,r,a),o!==d.a.LocalChanged){t.next=3;break}return t.abrupt("return");case 3:for(s=!0,c=!1,u=void 0,t.prev=6,f=i[Symbol.iterator]();!(s=(h=f.next()).done);s=!0){y=h.value;try{y.deleted||y.errorDecrypting||e.addHistoryEntryForItem(y)}catch(e){console.error("Unable to add item history entry:",e)}}t.next=14;break;case 10:t.prev=10,t.t0=t.catch(6),c=!0,u=t.t0;case 14:t.prev=14,t.prev=15,s||null==f.return||f.return();case 17:if(t.prev=17,!c){t.next=20;break}throw u;case 20:return t.finish(17);case 21:return t.finish(14);case 22:case"end":return t.stop()}}),t,null,[[6,10,14,22],[15,,17,21]])})));return function(e,n,r,a){return t.apply(this,arguments)}}())}},{key:"isDiskEnabled",value:function(){return this.persistable}},{key:"isAutoOptimizeEnabled",value:function(){return this.autoOptimize}},{key:"saveToDisk",value:(f=ba(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable){e.next=2;break}return e.abrupt("return");case 2:this.storageService.setValue(j.SessionHistoryRevisions,this.historySession);case 3:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"setSessionItemRevisionThreshold",value:function(e){this.historySession.setItemRevisionThreshold(e)}},{key:"addHistoryEntryForItem",value:(u=ba(l.a.mark((function e(t){var n,r,a=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Object(y.f)(t,d.a.SessionHistory),r=this.historySession.addEntryForPayload(n),this.autoOptimize&&this.historySession.optimizeHistoryForItem(t.uuid),r&&this.persistable&&(this.saveTimeout&&(this.timeout.hasOwnProperty("cancel")?this.timeout.cancel(this.saveTimeout):clearTimeout(this.saveTimeout)),this.saveTimeout=this.timeout((function(){a.saveToDisk()}),2e3));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"historyForItem",value:function(e){return this.historySession.historyForItem(e.uuid)}},{key:"clearHistoryForItem",value:(c=ba(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearItemHistory(t),e.abrupt("return",this.saveToDisk());case 2:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"clearAllHistory",value:(s=ba(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearAllHistory(),e.abrupt("return",this.storageService.removeValue(j.SessionHistoryRevisions));case 2:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"toggleDiskSaving",value:(i=ba(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable=!this.persistable,!this.persistable){e.next=6;break}this.storageService.setValue(j.SessionHistoryPersistable,!0),this.saveToDisk(),e.next=8;break;case 6:return this.storageService.setValue(j.SessionHistoryPersistable,!1),e.abrupt("return",this.storageService.removeValue(j.SessionHistoryRevisions));case 8:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"toggleAutoOptimize",value:(o=ba(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.autoOptimize=!this.autoOptimize,this.autoOptimize?this.storageService.setValue(j.SessionHistoryOptimize,!0):this.storageService.setValue(j.SessionHistoryOptimize,!1);case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})}])&&ma(n.prototype,r),a&&ma(n,a),t}(L.a),Ca=n(19),Da=n(18);function Ea(e){return(Ea="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ia(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ra(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Ia(o,r,a,i,s,"next",e)}function s(e){Ia(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Aa(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ma(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ta(e,t,n){return(Ta="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ka(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ka(e){return(Ka=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function La(e,t){return(La=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Fa(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.None=0]="None",e[e.FiveMinutes=300]="FiveMinutes",e[e.OneHour=3600]="OneHour",e[e.OneWeek=604800]="OneWeek"}(ja||(ja={}));var Va=(Fa(Oa={},Da.a.AccountPassword,{label:"Account Password",prompt:"Please enter your account password."}),Fa(Oa,Da.a.LocalPasscode,{label:"Local Passcode",prompt:"Please enter your local passcode."}),Oa),Na=(Fa(Pa={},Da.c.ManageExtensions,{label:"Manage Extensions"}),Fa(Pa,Da.c.ManageBackups,{label:"Download/Import Backups"}),Fa(Pa,Da.c.ViewProtectedNotes,{label:"View Protected Notes"}),Fa(Pa,Da.c.ManagePrivileges,{label:"Manage Privileges"}),Fa(Pa,Da.c.ManagePasscode,{label:"Manage Passcode"}),Fa(Pa,Da.c.DeleteNote,{label:"Delete Notes"}),Pa),Ua=function(e){function t(e,n,r,a,o,i){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s=function(e,t){return!t||"object"!==Ea(t)&&"function"!=typeof t?Ma(e):t}(this,Ka(t).call(this)),Fa(Ma(s),"itemManager",void 0),Fa(Ma(s),"syncService",void 0),Fa(Ma(s),"singletonManager",void 0),Fa(Ma(s),"protocolService",void 0),Fa(Ma(s),"storageService",void 0),Fa(Ma(s),"sessionManager",void 0),Fa(Ma(s),"availableActions",[]),Fa(Ma(s),"availableCredentials",[]),Fa(Ma(s),"sessionLengths",[]),s.itemManager=e,s.syncService=n,s.singletonManager=r,s.protocolService=a,s.storageService=o,s.sessionManager=i,s.loadDefaults(),s}var n,r,a,o,i,s,c,u,f,p,h,y,d,b;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&La(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.itemManager=void 0,this.syncService=void 0,this.singletonManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.sessionManager=void 0,Ta(Ka(t.prototype),"deinit",this).call(this)}},{key:"loadDefaults",value:function(){this.availableActions=Object.keys(Da.c).map((function(e){return Da.c[e]})),this.availableCredentials=[Da.a.AccountPassword,Da.a.LocalPasscode],this.sessionLengths=[ja.None,ja.FiveMinutes,ja.OneHour,ja.OneWeek]}},{key:"getAvailableActions",value:function(){return this.availableActions}},{key:"getAvailableCredentials",value:function(){return this.availableCredentials}},{key:"netCredentialsForAction",value:(b=Ra(l.a.mark((function e(t){var n,r,a,o,i,s,c,u,f;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getPrivileges();case 2:n=e.sent,r=n.getCredentialsForAction(t),a=[],o=!0,i=!1,s=void 0,e.prev=8,c=r[Symbol.iterator]();case 10:if(o=(u=c.next()).done){e.next=27;break}if((f=u.value)!==Da.a.AccountPassword){e.next=19;break}return e.next=15,this.sessionManager.online();case 15:e.sent&&a.push(f),e.next=24;break;case 19:if(f!==Da.a.LocalPasscode){e.next=24;break}return e.next=22,this.protocolService.hasRootKeyWrapper();case 22:e.sent&&a.push(f);case 24:o=!0,e.next=10;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(8),i=!0,s=e.t0;case 33:e.prev=33,e.prev=34,o||null==c.return||c.return();case 36:if(e.prev=36,!i){e.next=39;break}throw s;case 39:return e.finish(36);case 40:return e.finish(33);case 41:return e.abrupt("return",a);case 42:case"end":return e.stop()}}),e,this,[[8,29,33,41],[34,,36,40]])}))),function(e){return b.apply(this,arguments)})},{key:"getPrivileges",value:(d=Ra(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=ze.b.Privileges,n=new Ca.a("content_type","=",t),e.abrupt("return",this.singletonManager.findOrCreateSingleton(n,t,Object(v.b)({})));case 3:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"savePrivileges",value:(y=Ra(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getPrivileges();case 2:return t=e.sent,e.next=5,this.itemManager.setItemDirty(t.uuid);case 5:return e.abrupt("return",this.syncService.sync());case 6:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"setSessionLength",value:(h=Ra(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t,a=void 0,(a=new Date).setSeconds(a.getSeconds()+r),n=a,e.next=4,this.storageService.setValue(j.PrivilegesExpirey,n);case 4:return e.next=6,this.storageService.setValue(j.PrivilegesSessionLength,t);case 6:case"end":return e.stop()}var r,a}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"clearSession",value:(p=Ra(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setSessionLength(ja.None));case 1:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"getSelectedSessionLength",value:(f=Ra(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(j.PrivilegesSessionLength);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",t);case 7:return e.abrupt("return",ja.None);case 8:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"getSessionExpirey",value:(u=Ra(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(j.PrivilegesExpirey);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",new Date(t));case 7:return e.abrupt("return",new Date);case 8:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"actionHasPrivilegesConfigured",value:(c=Ra(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:return e.t0=e.sent.length,e.abrupt("return",e.t0>0);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"actionRequiresPrivilege",value:(s=Ra(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSessionExpirey();case 2:if(!(e.sent>new Date)){e.next=5;break}return e.abrupt("return",!1);case 5:return e.next=7,this.netCredentialsForAction(t);case 7:return n=e.sent,e.abrupt("return",n.length>0);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"authenticateAction",value:(i=Ra(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f,p;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:r=e.sent,a=[],o=[],i=!0,s=!1,c=void 0,e.prev=8,u=r[Symbol.iterator]();case 10:if(i=(f=u.next()).done){e.next=19;break}return p=f.value,e.next=14,this.verifyAuthenticationParameters(p,n[p]);case 14:e.sent?a.push(p):o.push(p);case 16:i=!0,e.next=10;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(8),s=!0,c=e.t0;case 25:e.prev=25,e.prev=26,i||null==u.return||u.return();case 28:if(e.prev=28,!s){e.next=31;break}throw c;case 31:return e.finish(28);case 32:return e.finish(25);case 33:return e.abrupt("return",{success:0===o.length,successfulCredentials:a,failedCredentials:o});case 34:case"end":return e.stop()}}),e,this,[[8,21,25,33],[26,,28,32]])}))),function(e,t){return i.apply(this,arguments)})},{key:"verifyAuthenticationParameters",value:(o=Ra(l.a.mark((function e(t,n){var r,a,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==Da.a.AccountPassword){e.next=8;break}return e.next=3,this.protocolService.validateAccountPassword(n);case 3:return r=e.sent,a=r.valid,e.abrupt("return",a);case 8:if(t!==Da.a.LocalPasscode){e.next=14;break}return e.next=11,this.protocolService.validatePasscode(n);case 11:return o=e.sent,i=o.valid,e.abrupt("return",i);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"displayInfoForCredential",value:function(e){return Va[e]}},{key:"displayInfoForAction",value:function(e){return Na[e]}},{key:"getSessionLengthOptions",value:function(){return[{value:ja.None,label:"Don't Remember"},{value:ja.FiveMinutes,label:"5 Minutes"},{value:ja.OneHour,label:"1 Hour"},{value:ja.OneWeek,label:"1 Week"}]}}])&&Aa(n.prototype,r),a&&Aa(n,a),t}(L.a),Ba=n(35),Wa=n(34),Ha=n(40),za=n(52),qa=n(21);function Ya(e){return(Ya="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ja(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ga(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Ja(o,r,a,i,s,"next",e)}function s(e){Ja(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Qa(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function $a(e){return($a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Xa(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Za(e,t){return(Za=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function eo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var to=function(e){return e.filter((function(e){return!e.deleted}))},no=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t){return!t||"object"!==Ya(t)&&"function"!=typeof t?Xa(e):t}(this,$a(t).call(this)),eo(Xa(n),"modelManager",void 0),eo(Xa(n),"unsubChangeObserver",void 0),eo(Xa(n),"observers",[]),eo(Xa(n),"collection",void 0),eo(Xa(n),"systemSmartTags",void 0),n.modelManager=e,n.collection=new dt.b,n.unsubChangeObserver=n.modelManager.addChangeObserver(h.a.Any,n.onPayloadChange.bind(Xa(n))),n.systemSmartTags=za.a.systemSmartTags(),n}var n,r,a,o,i,s,c,u,b,m,g,w,k,x,S,O,P,j,_,C,D,E,I,R,A,M;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Za(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.unsubChangeObserver(),this.unsubChangeObserver=void 0,this.modelManager=void 0,this.resetState()}},{key:"resetState",value:function(){this.collection=new dt.b}},{key:"findItem",value:function(e){return this.collection.find(e)}},{key:"findItems",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.collection.findAll(e,t)}},{key:"addObserver",value:function(e,t){var n=this;Array.isArray(e)||(e=[e]);var r={contentType:e,callback:t};return this.observers.push(r),function(){Object(p.x)(n.observers,r)}}},{key:"itemsReferencingItem",value:function(e){if(!Object(p.o)(e))throw Error("Must use uuid string");var t=this.collection.uuidsThatReferenceUuid(e);return this.findItems(t)}},{key:"referencesForItem",value:function(e){if(!Object(p.o)(e))throw Error("Must use uuid string");var t=this.findItem(e).references.map((function(e){return e.uuid}));return this.findItems(t)}},{key:"onPayloadChange",value:(M=Ga(l.a.mark((function e(t,n,r,a,o){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setPayloads(t,n,r,a,o));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return M.apply(this,arguments)})},{key:"setPayloads",value:(A=Ga(l.a.mark((function e(t,n,r,a,o){var i,s,c,u,f,p,h,y,d,b;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(i=t.map((function(e){return Object(v.a)(e)})),s=n.map((function(e){return Object(v.a)(e)})),c=i.concat(s),this.collection.set(c),u=r.map((function(e){return Object(v.a)(e)})),f=!0,p=!1,h=void 0,e.prev=8,y=u[Symbol.iterator]();!(f=(d=y.next()).done);f=!0)b=d.value,this.collection.discard(b);e.next=16;break;case 12:e.prev=12,e.t0=e.catch(8),p=!0,h=e.t0;case 16:e.prev=16,e.prev=17,f||null==y.return||y.return();case 19:if(e.prev=19,!p){e.next=22;break}throw h;case 22:return e.finish(19);case 23:return e.finish(16);case 24:return e.next=26,this.notifyObservers(i,s,u,a,o);case 26:case"end":return e.stop()}}),e,this,[[8,12,16,24],[17,,19,23]])}))),function(e,t,n,r,a){return A.apply(this,arguments)})},{key:"notifyObservers",value:(R=Ga(l.a.mark((function e(t,n,r,a,o){var i,s,c,u,f,p,y;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=!0,s=!1,c=void 0,e.prev=3,u=this.observers[Symbol.iterator]();case 5:if(i=(f=u.next()).done){e.next=13;break}return p=f.value,y=function(e,t){return e.filter((function(e){return t.includes(h.a.Any)||t.includes(e.content_type)}))},e.next=10,p.callback(y(t,p.contentType),y(n,p.contentType),y(r,p.contentType),a,o);case 10:i=!0,e.next=5;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(3),s=!0,c=e.t0;case 19:e.prev=19,e.prev=20,i||null==u.return||u.return();case 22:if(e.prev=22,!s){e.next=25;break}throw c;case 25:return e.finish(22);case 26:return e.finish(19);case 27:case"end":return e.stop()}}),e,this,[[3,15,19,27],[20,,22,26]])}))),function(e,t,n,r,a){return R.apply(this,arguments)})},{key:"changeItem",value:(I=Ga(l.a.mark((function e(t,n){var r,a,o,i,s=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.length>2&&void 0!==s[2]?s[2]:Fe.c.UserInteraction,a=s.length>3&&void 0!==s[3]?s[3]:d.a.LocalChanged,o=s.length>4?s[4]:void 0,Object(p.o)(t)){e.next=5;break}throw Error("Invalid uuid for changeItem");case 5:return e.next=7,this.changeItems([t],n,r,a,o);case 7:return i=e.sent,e.abrupt("return",i[0]);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return I.apply(this,arguments)})},{key:"createMutatorForItem",value:function(e,t){return e.content_type===h.a.Note?new Wa.a(e,t):e.content_type===h.a.Tag?new Ba.b(e,t):e.content_type===h.a.Component?new qe.b(e,t):e.content_type===h.a.ActionsExtension?new Ha.a(e,t):e.content_type===h.a.ItemsKey?new hn.a(e,t):e.content_type===h.a.Privileges?new Da.b(e,t):new Fe.b(e,t)}},{key:"changeItems",value:(E=Ga(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f,p,h,y,v,b,m,g=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=g.length>2&&void 0!==g[2]?g[2]:Fe.c.UserInteraction,a=g.length>3&&void 0!==g[3]?g[3]:d.a.LocalChanged,o=g.length>4?g[4]:void 0,i=this.findItems(t,!0),s=[],c=!0,u=!1,f=void 0,e.prev=8,p=i[Symbol.iterator]();case 10:if(c=(h=p.next()).done){e.next=21;break}if(y=h.value){e.next=14;break}throw Error("Attempting to change non-existant item");case 14:v=this.createMutatorForItem(y,r),n&&n(v),b=v.getResult(),s.push(b);case 18:c=!0,e.next=10;break;case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(8),u=!0,f=e.t0;case 27:e.prev=27,e.prev=28,c||null==p.return||p.return();case 30:if(e.prev=30,!u){e.next=33;break}throw f;case 33:return e.finish(30);case 34:return e.finish(27);case 35:return e.next=37,this.modelManager.emitPayloads(s,a,o);case 37:return m=this.findItems(s.map((function(e){return e.uuid}))),e.abrupt("return",m);case 39:case"end":return e.stop()}}),e,this,[[8,23,27,35],[28,,30,34]])}))),function(e,t){return E.apply(this,arguments)})},{key:"changeNote",value:(D=Ga(l.a.mark((function e(t,n){var r,a,o,i,s,c=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]?c[2]:Fe.c.UserInteraction,a=c.length>3&&void 0!==c[3]?c[3]:d.a.LocalChanged,o=c.length>4?c[4]:void 0,i=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant note");case 6:return s=new Wa.a(i,r),e.abrupt("return",this.applyTransform(s,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return D.apply(this,arguments)})},{key:"changeComponent",value:(C=Ga(l.a.mark((function e(t,n){var r,a,o,i,s,c=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]?c[2]:Fe.c.UserInteraction,a=c.length>3&&void 0!==c[3]?c[3]:d.a.LocalChanged,o=c.length>4?c[4]:void 0,i=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant component");case 6:return s=new qe.b(i,r),e.abrupt("return",this.applyTransform(s,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return C.apply(this,arguments)})},{key:"changeActionsExtension",value:(_=Ga(l.a.mark((function e(t,n){var r,a,o,i,s,c=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]?c[2]:Fe.c.UserInteraction,a=c.length>3&&void 0!==c[3]?c[3]:d.a.LocalChanged,o=c.length>4?c[4]:void 0,i=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant extension");case 6:return s=new Ha.a(i,r),e.abrupt("return",this.applyTransform(s,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return _.apply(this,arguments)})},{key:"changeItemsKey",value:(j=Ga(l.a.mark((function e(t,n){var r,a,o,i,s,c=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]?c[2]:Fe.c.UserInteraction,a=c.length>3&&void 0!==c[3]?c[3]:d.a.LocalChanged,o=c.length>4?c[4]:void 0,i=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant itemsKey");case 6:return s=new hn.a(i,r),e.abrupt("return",this.applyTransform(s,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return j.apply(this,arguments)})},{key:"applyTransform",value:(P=Ga(l.a.mark((function e(t,n){var r,a,o,i=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>2&&void 0!==i[2]?i[2]:d.a.LocalChanged,a=i.length>3?i[3]:void 0,n(t),o=t.getResult(),e.abrupt("return",this.modelManager.emitPayload(o,r,a));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return P.apply(this,arguments)})},{key:"setItemDirty",value:(O=Ga(l.a.mark((function e(t){var n,r,a=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=a.length>1&&void 0!==a[1]&&a[1],Object(p.o)(t)){e.next=3;break}throw Error("Must use uuid when setting item dirty");case 3:return e.next=5,this.setItemsDirty([t],n);case 5:return r=e.sent,e.abrupt("return",r[0]);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return O.apply(this,arguments)})},{key:"setItemsDirty",value:(S=Ga(l.a.mark((function e(t){var n,r=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]&&r[1],Object(p.o)(t[0])){e.next=3;break}throw Error("Must use uuid when setting item dirty");case 3:return e.abrupt("return",this.changeItems(t,void 0,n?Fe.c.UserInteraction:Fe.c.Internal));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"getDirtyItems",value:function(){return this.items.filter((function(e){return e.dirty&&!e.dummy&&(!e.errorDecrypting||e.deleted)}))}},{key:"insertItem",value:(x=Ga(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.payload,e.next=3,this.emitItemFromPayload(n);case 3:return r=e.sent,e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"duplicateItem",value:(k=Ga(l.a.mark((function e(t){var n,r,a,o,i,s=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=s.length>1&&void 0!==s[1]&&s[1],r=this.findItem(t),a=Object(y.e)(r),e.next=5,Object(qa.c)(a,this.modelManager.getMasterCollection(),n);case 5:return o=e.sent,e.next=8,this.modelManager.emitPayloads(o,d.a.LocalChanged);case 8:return i=this.findItem(o[0].uuid),e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"createItem",value:(w=Ga(l.a.mark((function e(t,n){var r,a,o,i=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=i.length>2&&void 0!==i[2]&&i[2],a=i.length>3?i[3]:void 0,t){e.next=4;break}throw"Attempting to create item with no contentType";case 4:return e.t0=y.e,e.next=7,f.a.GenerateUuid();case 7:return e.t1=e.sent,e.t2=t,e.t3=n?Object(v.b)(n):void 0,e.t4=r,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:e.t4},e.t6=void 0,e.t7=void 0,e.t8=a,o=(0,e.t0)(e.t5,e.t6,e.t7,e.t8),e.next=18,this.modelManager.emitPayload(o,d.a.Constructor);case 18:return e.abrupt("return",this.findItem(o.uuid));case 19:case"end":return e.stop()}}),e,this)}))),function(e,t){return w.apply(this,arguments)})},{key:"createTemplateItem",value:(g=Ga(l.a.mark((function e(t,n){var r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=y.e,e.next=3,f.a.GenerateUuid();case 3:return e.t1=e.sent,e.t2=t,e.t3=n?Object(v.b)(n):void 0,e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},r=(0,e.t0)(e.t4),e.abrupt("return",Object(v.a)(r));case 9:case"end":return e.stop()}}),e)}))),function(e,t){return g.apply(this,arguments)})},{key:"emitItemFromPayload",value:(m=Ga(l.a.mark((function e(t){var n,r=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:d.a.Constructor,e.next=3,this.modelManager.emitPayload(t,n);case 3:return e.abrupt("return",this.findItem(t.uuid));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"emitItemsFromPayloads",value:(b=Ga(l.a.mark((function e(t){var n,r,a=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:d.a.Constructor,e.next=3,this.modelManager.emitPayloads(t,n);case 3:return r=Object(v.c)(t),e.abrupt("return",this.findItems(r));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"setItemToBeDeleted",value:(u=Ga(l.a.mark((function e(t){var n,r,a,o,i,s,c,u,f,p;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.collection.uuidsThatReferenceUuid(t),r=this.findItem(t),e.next=4,this.changeItem(t,(function(e){e.setDeleted()}));case 4:a=e.sent,o=!0,i=!1,s=void 0,e.prev=8,c=n[Symbol.iterator]();case 10:if(o=(u=c.next()).done){e.next=19;break}if(f=u.value,!(p=this.findItem(f))){e.next=16;break}return e.next=16,this.changeItem(p.uuid,(function(e){e.removeItemAsRelationship(r)}));case 16:o=!0,e.next=10;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(8),i=!0,s=e.t0;case 25:e.prev=25,e.prev=26,o||null==c.return||c.return();case 28:if(e.prev=28,!i){e.next=31;break}throw s;case 31:return e.finish(28);case 32:return e.finish(25);case 33:return e.abrupt("return",a);case 34:case"end":return e.stop()}}),e,this,[[8,21,25,33],[26,,28,32]])}))),function(e){return u.apply(this,arguments)})},{key:"setItemsToBeDeleted",value:(c=Ga(l.a.mark((function e(t){var n,r,a,o,i,s,c,u;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],r=!0,a=!1,o=void 0,e.prev=4,i=t[Symbol.iterator]();case 6:if(r=(s=i.next()).done){e.next=15;break}return c=s.value,e.next=10,this.setItemToBeDeleted(c);case 10:u=e.sent,n.push(u);case 12:r=!0,e.next=6;break;case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(4),a=!0,o=e.t0;case 21:e.prev=21,e.prev=22,r||null==i.return||i.return();case 24:if(e.prev=24,!a){e.next=27;break}throw o;case 27:return e.finish(24);case 28:return e.finish(21);case 29:return e.abrupt("return",n);case 30:case"end":return e.stop()}}),e,this,[[4,17,21,29],[22,,24,28]])}))),function(e){return c.apply(this,arguments)})},{key:"getItems",value:function(e){return Array.isArray(e)?this.items.filter((function(t){return!t.dummy&&e.includes(t.content_type)})):this.collection.all(e)}},{key:"invalidItems",value:function(){return this.items.filter((function(e){return e.errorDecrypting}))}},{key:"validItemsForContentType",value:function(e){return this.collection.all(e).filter((function(e){return!e.errorDecrypting}))}},{key:"itemsMatchingPredicate",value:function(e){return this.itemsMatchingPredicates([e])}},{key:"itemsMatchingPredicates",value:function(e){return this.filterItemsWithPredicates(this.items,e)}},{key:"filterItemsWithPredicates",value:function(e,t){return e.filter((function(e){if(e.deleted)return!1;var n=!0,r=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value;if(!e.satisfiesPredicate(s))return!1}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}return!0}))}},{key:"findTagByTitle",value:function(e){return Object(p.z)(this.tags,{title:e})}},{key:"findOrCreateTagByTitle",value:(s=Ga(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.findTagByTitle(t),e.t0=n,e.t0){e.next=6;break}return e.next=5,this.createItem(h.a.Tag,Object(v.b)({title:t}),!0);case 5:e.t0=e.sent;case 6:return e.abrupt("return",e.t0);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"notesMatchingSmartTag",value:function(e){var t=[new Ca.a("content_type","=",h.a.Note),e.predicate];if(!e.isTrashTag){var n=new Ca.a("content.trashed","=",!1);t.push(n)}return this.itemsMatchingPredicates(t)}},{key:"emptyTrash",value:(i=Ga(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.trashedItems,e.abrupt("return",this.setItemsToBeDeleted(Object(v.c)(t)));case 2:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"getSmartTags",value:function(){var e=this.validItemsForContentType(h.a.SmartTag).sort((function(e,t){return e.title<t.title?-1:1}));return this.systemSmartTags.concat(e)}},{key:"removeAllItemsFromMemory",value:(o=Ga(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(v.c)(this.items),e.next=3,this.changeItems(t,(function(e){e.setDeleted()}));case 3:this.resetState(),this.modelManager.resetState();case 5:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"removeItemLocally",value:function(e){this.collection.discard(e),this.modelManager.removePayloadLocally(e.payload)}},{key:"itemsKeys",get:function(){return to(this.collection.all(h.a.ItemsKey))}},{key:"notes",get:function(){return to(this.collection.all(h.a.Note))}},{key:"tags",get:function(){return to(this.collection.all(h.a.Tag))}},{key:"components",get:function(){return to(this.collection.all(h.a.Component))}},{key:"items",get:function(){return this.collection.all()}},{key:"allNondummyItems",get:function(){return this.items.filter((function(e){return!e.dummy}))}},{key:"nonDeletedItems",get:function(){return this.items.filter((function(e){return!e.dummy&&!e.deleted}))}},{key:"trashSmartTag",get:function(){return this.systemSmartTags.find((function(e){return e.isTrashTag}))}},{key:"trashedItems",get:function(){return this.notesMatchingSmartTag(this.trashSmartTag)}},{key:"noteCount",get:function(){return this.notes.filter((function(e){return!e.dummy})).length}}])&&Qa(n.prototype,r),a&&Qa(n,a),t}(L.a);function ro(e,t){return e.sort((function(e,n){var r=new Date(n.updated_at).getTime()-new Date(e.updated_at).getTime(),a=0,o=0;return t&&(a=t.indexOf(e.content_type),o=t.indexOf(n.content_type),-1===a&&(a=t.length),-1===o&&(o=t.length)),a===o?r:a<o?-1:1}))}function ao(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function oo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var io=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),oo(this,"interval",void 0),oo(this,"receiver",void 0),oo(this,"inProgress",!1),oo(this,"completedUpload",0),oo(this,"totalUpload",0),oo(this,"downloaded",0),oo(this,"databaseLoadCurrent",0),oo(this,"databaseLoadTotal",0),oo(this,"databaseLoadDone",!1),oo(this,"syncing",!1),oo(this,"syncStart",void 0),oo(this,"syncEnd",void 0),oo(this,"timingMonitor",void 0),oo(this,"error",void 0),this.interval=t,this.receiver=n}var t,n,r;return t=e,(n=[{key:"deinit",value:function(){this.stopTimingMonitor()}},{key:"setSyncInProgress",value:function(e){this.inProgress=!0}},{key:"setUploadStatus",value:function(e,t){this.completedUpload=e,this.totalUpload=t,this.receiver(Ct.a.StatusChanged)}},{key:"setDownloadStatus",value:function(e){this.downloaded+=e,this.receiver(Ct.a.StatusChanged)}},{key:"setDatabaseLoadStatus",value:function(e,t,n){this.databaseLoadCurrent=e,this.databaseLoadTotal=t,this.databaseLoadDone=n,n?this.receiver(Ct.a.LocalDataLoaded):this.receiver(Ct.a.LocalDataIncrementalLoad)}},{key:"getStats",value:function(){return{uploadCompletionCount:this.completedUpload,uploadTotalCount:this.totalUpload,downloadCount:this.downloaded,localDataDone:this.databaseLoadDone,localDataCurrent:this.databaseLoadCurrent,localDataTotal:this.databaseLoadTotal}}},{key:"setDidBegin",value:function(){this.syncing=!0,this.syncStart=new Date}},{key:"setDidEnd",value:function(){this.syncing=!1,this.syncEnd=new Date}},{key:"startTimingMonitor",value:function(){var e=this;this.timingMonitor&&this.stopTimingMonitor(),this.timingMonitor=this.interval((function(){e.secondsSinceSyncStart>5&&(e.receiver(Ct.a.SyncTakingTooLong),e.stopTimingMonitor())}),500)}},{key:"stopTimingMonitor",value:function(){Object.prototype.hasOwnProperty.call(this.interval,"cancel")?this.interval.cancel(this.timingMonitor):clearInterval(this.timingMonitor),this.timingMonitor=null}},{key:"hasError",value:function(){return!!this.error}},{key:"setError",value:function(e){this.error=e}},{key:"clearError",value:function(){this.error=null}},{key:"reset",value:function(){this.downloaded=0,this.completedUpload=0,this.totalUpload=0,this.inProgress=!1,this.syncing=!1,this.error=null,this.stopTimingMonitor(),this.receiver(Ct.a.StatusChanged)}},{key:"syncInProgress",get:function(){return!0===this.syncing}},{key:"secondsSinceSyncStart",get:function(){return((new Date).getTime()-this.syncStart.getTime())/1e3}}])&&ao(t.prototype,n),r&&ao(t,r),e}();function so(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function co(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function uo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var lo=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),uo(this,"lastPreSyncSave",void 0),uo(this,"lastSyncDate",void 0),uo(this,"receiver",void 0),uo(this,"discordance",0),uo(this,"maxDiscordance",void 0),uo(this,"outOfSync",!1),uo(this,"lastClientHash",void 0),uo(this,"lastServerHash",void 0),this.receiver=t,this.maxDiscordance=n,this.reset()}var t,n,r,a,o;return t=e,(n=[{key:"isOutOfSync",value:function(){return this.outOfSync}},{key:"reset",value:function(){this.lastPreSyncSave=void 0,this.lastSyncDate=void 0,this.discordance=0,this.outOfSync=!1}},{key:"getLastClientIntegrityHash",value:function(){return this.lastClientHash}},{key:"clearIntegrityHashes",value:function(){this.lastClientHash=void 0,this.lastServerHash=void 0}},{key:"setIntegrityHashes",value:(a=l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.lastClientHash=t,this.lastServerHash=n,n&&0!==n.length&&t&&t!==n?(this.discordance++,this.discordance>=this.maxDiscordance&&!this.outOfSync&&(this.outOfSync=!0,this.receiver(Ct.a.EnterOutOfSync))):(this.outOfSync&&(this.outOfSync=!1,this.receiver(Ct.a.ExitOutOfSync)),this.discordance=0);case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){so(o,n,r,i,s,"next",e)}function s(e){so(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e,t){return o.apply(this,arguments)})},{key:"needsSync",get:function(){return this.discordance>0&&this.discordance<this.maxDiscordance}}])&&co(t.prototype,n),r&&co(t,r),e}();function fo(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function po(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ho(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var yo=function(){function e(t,n,r,a,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ho(this,"apiService",void 0),ho(this,"protocolService",void 0),ho(this,"contentType",void 0),ho(this,"customEvent",void 0),ho(this,"limit",void 0),ho(this,"progress",void 0),this.apiService=t,this.protocolService=n,this.contentType=r,this.customEvent=a,this.limit=o,this.progress={retrievedPayloads:[]}}var t,n,r,a,o;return t=e,(n=[{key:"run",value:(a=l.a.mark((function e(){var t,n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.apiService.sync([],this.progress.lastSyncToken,this.progress.paginationToken,this.limit||500,!1,this.contentType,this.customEvent);case 2:return t=e.sent,n=t.retrieved_items.map((function(e){return Object(y.f)(e,d.a.RemoteRetrieved)})),e.next=6,this.protocolService.payloadsByDecryptingPayloads(n);case 6:if(r=e.sent,this.progress.retrievedPayloads=this.progress.retrievedPayloads.concat(r),this.progress.lastSyncToken=t.sync_token,this.progress.paginationToken=t.cursor_token,!t.cursor_token){e.next=14;break}return e.abrupt("return",this.run());case 14:return e.abrupt("return",this.progress.retrievedPayloads);case 15:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){fo(o,n,r,i,s,"next",e)}function s(e){fo(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&po(t.prototype,n),r&&po(t,r),e}(),vo=n(20);function bo(e){return e===d.a.RemoteRetrieved?vo.e:e===d.a.RemoteSaved?vo.f:e===d.a.ConflictData||e===d.a.ConflictUuid?vo.d:void 0}var mo=n(50);function go(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function wo(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){go(o,r,a,i,s,"next",e)}function s(e){go(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ko(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function xo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var So,Oo=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),xo(this,"response",void 0),xo(this,"baseCollection",void 0),xo(this,"relatedCollectionSet",void 0),this.response=t,this.baseCollection=r,this.relatedCollectionSet=new mo.a([new dt.a(n,d.a.DecryptedTransient),new dt.a(a,d.a.SavedOrSaving)])}var t,n,r,a,o;return t=e,(n=[{key:"collectionsByProcessingResponse",value:(o=wo(l.a.mark((function e(){var t,n,r,a,o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,this.collectionByProcessingPayloads(this.response.retrievedPayloads,d.a.RemoteRetrieved);case 3:return(n=e.sent).all().length>0&&t.push(n),e.next=7,this.collectionByProcessingPayloads(this.response.savedPayloads,d.a.RemoteSaved);case 7:if((r=e.sent).all().length>0&&t.push(r),!(this.response.uuidConflictPayloads.length>0)){e.next=14;break}return e.next=12,this.collectionByProcessingPayloads(this.response.uuidConflictPayloads,d.a.ConflictUuid);case 12:(a=e.sent).all().length>0&&t.push(a);case 14:if(!(this.response.dataConflictPayloads.length>0)){e.next=19;break}return e.next=17,this.collectionByProcessingPayloads(this.response.dataConflictPayloads,d.a.ConflictData);case 17:(o=e.sent).all().length>0&&t.push(o);case 19:return e.abrupt("return",t);case 20:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"collectionByProcessingPayloads",value:(a=wo(l.a.mark((function e(t,n){var r,a,o,i,s,c=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new dt.a(t,n),a=bo(n),o=new a(this.baseCollection,r,this.relatedCollectionSet),e.next=5,o.resultingCollection();case 5:return i=e.sent,s=i.all().map((function(e){var t=c.finalDirtyStateForPayload(e);return Object(y.b)(e,{dirty:t,dirtiedDate:t?new Date:void 0})})),e.abrupt("return",new dt.a(s,n));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"finalDirtyStateForPayload",value:function(e){var t=this.baseCollection.find(e.uuid);return t?e.dirtiedDate&&e.dirtiedDate>t.dirtiedDate?e.dirty:t.dirtiedDate>t.lastSyncBegan:e.dirty}}])&&ko(t.prototype,n),r&&ko(t,r),e}();function Po(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function jo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.ConflictingData="sync_conflict",e.UuidConflict="uuid_conflict"}(So||(So={}));var _o,Co=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),jo(this,"rawResponse",void 0),jo(this,"savedPayloads",void 0),jo(this,"retrievedPayloads",void 0),jo(this,"uuidConflictPayloads",void 0),jo(this,"dataConflictPayloads",void 0),jo(this,"deletedPayloads",void 0),this.rawResponse=t,this.savedPayloads=this.filterRawItemArray(t.saved_items).map((function(e){return Object(y.f)(e,d.a.RemoteSaved)})),this.retrievedPayloads=this.filterRawItemArray(t.retrieved_items).map((function(e){return Object(y.f)(e,d.a.RemoteRetrieved)})),this.dataConflictPayloads=this.filterRawItemArray(this.rawDataConflictItems).map((function(e){return Object(y.f)(e,d.a.ConflictData)})),this.uuidConflictPayloads=this.filterRawItemArray(this.rawUuidConflictItems).map((function(e){return Object(y.f)(e,d.a.ConflictUuid)})),this.deletedPayloads=this.allProcessedPayloads.filter((function(e){return e.discardable})),Object(p.f)(this)}var t,n,r;return t=e,(n=[{key:"filterRawItemArray",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter((function(e){return!!e.uuid}))}},{key:"error",get:function(){return this.rawResponse.error}},{key:"status",get:function(){return this.rawResponse.status}},{key:"lastSyncToken",get:function(){return this.rawResponse[xe.LastSyncToken]}},{key:"paginationToken",get:function(){return this.rawResponse[xe.PaginationToken]}},{key:"integrityHash",get:function(){return this.rawResponse[xe.IntegrityResult]}},{key:"checkIntegrity",get:function(){return this.integrityHash&&!this.paginationToken}},{key:"numberOfItemsInvolved",get:function(){return this.allProcessedPayloads.length}},{key:"allProcessedPayloads",get:function(){return this.savedPayloads.concat(this.retrievedPayloads).concat(this.dataConflictPayloads).concat(this.uuidConflictPayloads)}},{key:"rawUuidConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return e.type===So.UuidConflict})).map((function(e){return e.unsaved_item||e.item}))}},{key:"rawDataConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return e.type===So.ConflictingData})).map((function(e){return e.server_item||e.item}))}},{key:"rawConflictObjects",get:function(){var e=this.rawResponse.conflicts||[],t=this.rawResponse.unsaved||[];return e.concat(t)}},{key:"hasError",get:function(){return!Object(p.m)(this.rawResponse.error)}}])&&Po(t.prototype,n),r&&Po(t,r),e}();function Do(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Eo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Io(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.Response=1]="Response",e[e.StatusChanged=2]="StatusChanged"}(_o||(_o={}));var Ro=function(){function e(t,n,r,a,o,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Io(this,"payloads",void 0),Io(this,"receiver",void 0),Io(this,"lastSyncToken",void 0),Io(this,"paginationToken",void 0),Io(this,"checkIntegrity",void 0),Io(this,"apiService",void 0),Io(this,"pendingPayloads",void 0),Io(this,"responses",[]),this.payloads=t,this.lastSyncToken=r,this.paginationToken=a,this.checkIntegrity=o,this.apiService=i,this.receiver=n,this.pendingPayloads=t}var t,n,r,a,o;return t=e,(n=[{key:"popPayloads",value:function(e){var t=this.pendingPayloads.slice(0,e);return Object(p.C)(this.pendingPayloads,t),t}},{key:"run",value:(a=l.a.mark((function e(){var t,n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.popPayloads(this.upLimit),e.next=3,this.apiService.sync(t,this.lastSyncToken,this.paginationToken,this.downLimit,this.checkIntegrity,void 0,void 0);case 3:return n=e.sent,r=new Co(n),this.responses.push(r),this.lastSyncToken=r.lastSyncToken,this.paginationToken=r.paginationToken,e.next=10,this.receiver(_o.Response,r);case 10:if(this.done){e.next=12;break}return e.abrupt("return",this.run());case 12:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Do(o,n,r,i,s,"next",e)}function s(e){Do(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})},{key:"pendingUploadCount",value:function(){return this.pendingPayloads.length}},{key:"totalUploadCount",value:function(){return this.payloads.length}},{key:"payloadsSavedOrSaving",get:function(){return Object(p.c)(this.payloads,this.pendingPayloads)}},{key:"done",get:function(){return 0===this.pendingPayloads.length&&!this.paginationToken}},{key:"upLimit",get:function(){return 150}},{key:"downLimit",get:function(){return 150}},{key:"numberOfItemsInvolved",get:function(){var e=0,t=!0,n=!1,r=void 0;try{for(var a,o=this.responses[Symbol.iterator]();!(t=(a=o.next()).done);t=!0)e+=a.value.numberOfItemsInvolved}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}return e}}])&&Eo(t.prototype,n),r&&Eo(t,r),e}();function Ao(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Mo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function To(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ko=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),To(this,"payloads",void 0),To(this,"receiver",void 0),this.payloads=t,this.receiver=n}var t,n,r,a,o;return t=e,(n=[{key:"run",value:(a=l.a.mark((function e(){var t,n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.payloads.map((function(e){return Object(y.f)(e,d.a.LocalSaved,{dirty:!1,lastSyncEnd:new Date})})),n=Object(p.a)(t),r=new Co({saved_items:n}),e.next=5,this.receiver(_o.Response,r);case 5:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Ao(o,n,r,i,s,"next",e)}function s(e){Ao(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&Mo(t.prototype,n),r&&Mo(t,r),e}(),Lo=n(4);function Fo(e){return(Fo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Vo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function No(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Uo(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){No(o,r,a,i,s,"next",e)}function s(e){No(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Bo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Wo(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ho(e,t,n){return(Ho="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=zo(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function zo(e){return(zo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function qo(e,t){return(qo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Yo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Jo,Go,Qo;!function(e){e[e.ResolveOnNext=1]="ResolveOnNext",e[e.ForceSpawnNew=2]="ForceSpawnNew"}(Jo||(Jo={})),function(e){e[e.Default=1]="Default",e[e.DownloadFirst=2]="DownloadFirst"}(Go||(Go={})),function(e){e[e.External=1]="External",e[e.SpawnQueue=2]="SpawnQueue",e[e.ResolveQueue=3]="ResolveQueue",e[e.MoreDirtyItems=4]="MoreDirtyItems",e[e.AfterDownloadFirst=5]="AfterDownloadFirst",e[e.IntegrityCheck=6]="IntegrityCheck",e[e.ResolveOutOfSync=7]="ResolveOutOfSync"}(Qo||(Qo={}));var $o=function(e){function t(e,n,r,a,o,i,s){var c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c=function(e,t){return!t||"object"!==Fo(t)&&"function"!=typeof t?Wo(e):t}(this,zo(t).call(this)),Yo(Wo(c),"sessionManager",void 0),Yo(Wo(c),"protocolService",void 0),Yo(Wo(c),"storageService",void 0),Yo(Wo(c),"modelManager",void 0),Yo(Wo(c),"itemManager",void 0),Yo(Wo(c),"apiService",void 0),Yo(Wo(c),"interval",void 0),Yo(Wo(c),"state",void 0),Yo(Wo(c),"opStatus",void 0),Yo(Wo(c),"resolveQueue",[]),Yo(Wo(c),"spawnQueue",[]),Yo(Wo(c),"completedOnlineDownloadFirstSync",!1),Yo(Wo(c),"majorChangeThreshold",15),Yo(Wo(c),"maxDiscordance",5),Yo(Wo(c),"locked",!1),Yo(Wo(c),"databaseLoaded",!1),Yo(Wo(c),"syncToken",void 0),Yo(Wo(c),"cursorToken",void 0),Yo(Wo(c),"syncLock",void 0),Yo(Wo(c),"_simulate_latency",void 0),Yo(Wo(c),"localLoadPriorty",[h.a.ItemsKey,h.a.UserPrefs,h.a.Privileges,h.a.Component,h.a.Theme]),Yo(Wo(c),"nonEncryptedTypes",[h.a.Mfa,h.a.ServerExtension]),c.itemManager=e,c.sessionManager=n,c.protocolService=r,c.modelManager=o,c.storageService=a,c.apiService=i,c.interval=s,c.initializeStatus(),c.initializeState(),c}var n,r,a,o,i,s,c,u,f,m,g,w,k,x,S,O,P,_,C,D,E,I,R,A,M,T,L,F;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qo(e,t)}(t,e),n=t,(r=[{key:"onNewDatabaseCreated",value:(F=Uo(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLastSyncToken();case 2:if(!e.sent){e.next=5;break}return e.next=5,this.clearSyncPositionTokens();case 5:case"end":return e.stop()}}),e,this)}))),function(){return F.apply(this,arguments)})},{key:"deinit",value:function(){this.sessionManager=void 0,this.itemManager=void 0,this.protocolService=void 0,this.modelManager=void 0,this.storageService=void 0,this.apiService=void 0,this.interval=void 0,this.state.reset(),this.opStatus.reset(),this.state=void 0,this.opStatus=void 0,this.resolveQueue.length=0,this.spawnQueue.length=0,Ho(zo(t.prototype),"deinit",this).call(this)}},{key:"initializeStatus",value:function(){var e=this;this.opStatus=new io(this.interval,(function(t){e.notifyEvent(t)}))}},{key:"initializeState",value:function(){var e=this;this.state=new lo((function(t){t===b.b.EnterOutOfSync?e.notifyEvent(b.b.EnterOutOfSync):t===b.b.ExitOutOfSync&&e.notifyEvent(b.b.ExitOutOfSync)}),this.maxDiscordance)}},{key:"lockSyncing",value:function(){this.locked=!0}},{key:"unlockSyncing",value:function(){this.locked=!1}},{key:"isOutOfSync",value:function(){return this.state.isOutOfSync()}},{key:"getLastSyncDate",value:function(){return this.state.lastSyncDate}},{key:"getStatus",value:function(){return this.opStatus}},{key:"resetSyncState",value:function(){this.state.reset()}},{key:"isDatabaseLoaded",value:function(){return this.databaseLoaded}},{key:"getDatabasePayloads",value:(L=Uo(l.a.mark((function e(){var t=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getAllRawPayloads().catch((function(e){throw t.notifyEvent(b.b.DatabaseReadError,e),e})));case 1:case"end":return e.stop()}}),e,this)}))),function(){return L.apply(this,arguments)})},{key:"loadDatabasePayloads",value:(T=Uo(l.a.mark((function e(t){var n,r,a,o,i,s,c,u,f,v,m;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.databaseLoaded){e.next=2;break}throw"Attempting to initialize already initialized local database.";case 2:return n=t.map((function(e){return Object(y.e)(e)})),r=ro(n,this.localLoadPriorty),a=r.filter((function(e){return e.content_type===h.a.ItemsKey})),Object(p.C)(r,a),e.next=8,this.protocolService.payloadsByDecryptingPayloads(a);case 8:return o=e.sent,e.next=11,this.modelManager.emitPayloads(o,d.a.LocalRetrieved);case 11:i=r.length,s=100,c=Math.ceil(i/s),u=0;case 15:if(!(u<c)){e.next=28;break}return f=u*s,v=r.slice(f,f+s),e.next=20,this.protocolService.payloadsByDecryptingPayloads(v);case 20:return m=e.sent,e.next=23,this.modelManager.emitPayloads(m,d.a.LocalRetrieved);case 23:this.notifyEvent(b.b.LocalDataIncrementalLoad),this.opStatus.setDatabaseLoadStatus(f,i,!1);case 25:u++,e.next=15;break;case 28:this.databaseLoaded=!0,this.opStatus.setDatabaseLoadStatus(0,0,!0);case 30:case"end":return e.stop()}}),e,this)}))),function(e){return T.apply(this,arguments)})},{key:"setLastSyncToken",value:(M=Uo(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=t,e.abrupt("return",this.storageService.setValue(j.LastSyncToken,t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return M.apply(this,arguments)})},{key:"setPaginationToken",value:(A=Uo(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken=t,!t){e.next=5;break}return e.abrupt("return",this.storageService.setValue(j.PaginationToken,t));case 5:return e.abrupt("return",this.storageService.removeValue(j.PaginationToken));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return A.apply(this,arguments)})},{key:"getLastSyncToken",value:(R=Uo(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.syncToken){e.next=4;break}return e.next=3,this.storageService.getValue(j.LastSyncToken);case 3:this.syncToken=e.sent;case 4:return e.abrupt("return",this.syncToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return R.apply(this,arguments)})},{key:"getPaginationToken",value:(I=Uo(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken){e.next=4;break}return e.next=3,this.storageService.getValue(j.PaginationToken);case 3:this.cursorToken=e.sent;case 4:return e.abrupt("return",this.cursorToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return I.apply(this,arguments)})},{key:"clearSyncPositionTokens",value:(E=Uo(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=void 0,this.cursorToken=void 0,e.next=4,this.storageService.removeValue(j.LastSyncToken);case 4:return e.next=6,this.storageService.removeValue(j.PaginationToken);case 6:case"end":return e.stop()}}),e,this)}))),function(){return E.apply(this,arguments)})},{key:"itemsNeedingSync",value:(D=Uo(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.getDirtyItems(),e.abrupt("return",t);case 2:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"alternateUuidForItem",value:(C=Uo(l.a.mark((function e(t){var n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.itemManager.findItem(t),r=Object(y.e)(n),e.next=4,Object(qa.b)(r,this.modelManager.getMasterCollection());case 4:return a=e.sent,e.next=7,this.modelManager.emitPayloads(a,d.a.LocalChanged);case 7:return e.next=9,this.persistPayloads(a);case 9:return e.abrupt("return",this.itemManager.findItem(a[0].uuid));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"markAllItemsAsNeedingSync",value:(_=Uo(l.a.mark((function e(t){var n,r,a,o,i,s,c,u,f;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Marking all items as needing sync"),!t){e.next=29;break}n=this.itemManager.allNondummyItems.filter((function(e){return!e.errorDecrypting})).slice(),r=!0,a=!1,o=void 0,e.prev=6,i=n[Symbol.iterator]();case 8:if(r=(s=i.next()).done){e.next=15;break}return c=s.value,e.next=12,this.alternateUuidForItem(c.uuid);case 12:r=!0,e.next=8;break;case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(6),a=!0,o=e.t0;case 21:e.prev=21,e.prev=22,r||null==i.return||i.return();case 24:if(e.prev=24,!a){e.next=27;break}throw o;case 27:return e.finish(24);case 28:return e.finish(21);case 29:return u=this.itemManager.allNondummyItems,f=u.map((function(e){return Object(y.e)(e,void 0,void 0,{dirty:!0,dirtiedDate:new Date})})),e.next=33,this.modelManager.emitPayloads(f,d.a.LocalChanged);case 33:return e.next=35,this.persistPayloads(f);case 35:case"end":return e.stop()}}),e,this,[[6,17,21,29],[22,,24,28]])}))),function(e){return _.apply(this,arguments)})},{key:"popPayloadsNeedingPreSyncSave",value:(P=Uo(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.state.lastPreSyncSave){e.next=3;break}return e.abrupt("return",t);case 3:return r=t.filter((function(e){return!e.dirtiedDate||e.dirtiedDate>n})),this.state.lastPreSyncSave=new Date,e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return P.apply(this,arguments)})},{key:"queueStrategyResolveOnNext",value:function(){var e=this;return new Promise((function(t,n){e.resolveQueue.push({resolve:t,reject:n})}))}},{key:"queueStrategyForceSpawnNew",value:function(e){var t=this;return new Promise((function(n,r){t.spawnQueue.push({resolve:n,reject:r,options:e})}))}},{key:"popSpawnQueue",value:function(){if(0===this.spawnQueue.length)return null;var e=this.spawnQueue[0];return Object(p.y)(this.spawnQueue,0),this.log("Syncing again from spawn queue"),this.sync(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Vo(Object(n),!0).forEach((function(t){Yo(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Vo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({queueStrategy:Jo.ForceSpawnNew,source:Qo.SpawnQueue},e.options)).then((function(){e.resolve()})).catch((function(){e.reject()}))}},{key:"payloadsByPreparingForServer",value:function(e){var t=this;return this.protocolService.payloadsByEncryptingPayloads(e,(function(e){return t.nonEncryptedTypes.includes(e.content_type)?K.a.SyncDecrypted:K.a.Sync}))}},{key:"sync",value:(O=Uo(l.a.mark((function e(){var t,n,r,a,o,i,s,c,u,f,h,y,d,m,g,w,k,x,S,O,P,j,_,C,D,E=this,I=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=I.length>0&&void 0!==I[0]?I[0]:{},!this.locked){e.next=4;break}return this.log("Sync Locked"),e.abrupt("return");case 4:return n=function(){return E.syncLock},r=function(){E.syncLock=!0},a=function(){E.syncLock=!1},o=this.opStatus.syncInProgress,i=this.databaseLoaded,(s=!n())&&i&&!o&&r(),t.source||(t.source=Qo.External),e.next=14,this.itemsNeedingSync();case 14:return c=e.sent,u=c.filter((function(e){return e.neverSynced&&e.deleted})),Object(p.C)(c,u),f=c.map((function(e){return e.payloadRepresentation()})),e.next=20,this.popPayloadsNeedingPreSyncSave(f);case 20:return h=e.sent,e.next=23,this.persistPayloads(h);case 23:if(y=this.resolveQueue.slice(),d=Object(p.m)(t.queueStrategy)?Jo.ResolveOnNext:t.queueStrategy,!o&&i&&s){e.next=36;break}if(this.log(s?o?"Attempting to sync while existing sync in progress.":"Attempting to sync before local database has loaded.":"Another function call has begun preparing for sync."),d!==Jo.ResolveOnNext){e.next=31;break}return e.abrupt("return",this.queueStrategyResolveOnNext());case 31:if(d!==Jo.ForceSpawnNew){e.next=35;break}return e.abrupt("return",this.queueStrategyForceSpawnNew({mode:t.mode,checkIntegrity:t.checkIntegrity,source:t.source}));case 35:throw"Unhandled timing strategy ".concat(d);case 36:return this.opStatus.setDidBegin(),this.notifyEvent(b.b.SyncWillBegin),Object(p.C)(this.resolveQueue,y),m=new Date,e.next=42,this.itemManager.changeItems(Object(v.c)(c),(function(e){e.lastSyncBegan=m}),Fe.c.NonDirtying);case 42:if(g=this.sessionManager.online(),l=t.mode,w=g&&!E.completedOnlineDownloadFirstSync?Go.DownloadFirst:Object(p.m)(l)?Go.Default:l,k=[],w!==Go.Default){e.next=57;break}if(!g||this.completedOnlineDownloadFirstSync){e.next=48;break}throw"Attempting to default mode sync without having completed initial.";case 48:if(!g){e.next=54;break}return e.next=51,this.payloadsByPreparingForServer(f);case 51:k=e.sent,e.next=55;break;case 54:k=f;case 55:e.next=58;break;case 57:w===Go.DownloadFirst&&(k=[]);case 58:if(!g){e.next=64;break}return e.next=61,this.syncOnlineOperation(k,t.checkIntegrity,t.source,w);case 61:x=e.sent,e.next=67;break;case 64:return e.next=66,this.syncOfflineOperation(k,t.source,w);case 66:x=e.sent;case 67:return e.next=69,x.run();case 69:if(this.opStatus.setDidEnd(),a(),!this.opStatus.hasError()){e.next=73;break}return e.abrupt("return");case 73:return this.opStatus.reset(),this.state.lastSyncDate=new Date,x instanceof Ro&&x.numberOfItemsInvolved>=this.majorChangeThreshold&&this.notifyEvent(b.b.MajorDataChange),e.next=78,this.handleNeverSyncedDeleted(u);case 78:if(w===Go.DownloadFirst){e.next=81;break}return e.next=81,this.notifyEvent(b.b.FullSyncCompleted,{source:t.source});case 81:if(w!==Go.DownloadFirst){e.next=89;break}return g&&(this.completedOnlineDownloadFirstSync=!0),e.next=85,this.notifyEvent(b.b.DownloadFirstSyncCompleted);case 85:return e.next=87,this.sync({source:Qo.AfterDownloadFirst,checkIntegrity:!0});case 87:e.next=115;break;case 89:if(this.popSpawnQueue()||!(this.resolveQueue.length>0)){e.next=97;break}if(this.log("Syncing again from resolve queue"),S=this.sync({source:Qo.ResolveQueue}),!t.awaitAll){e.next=95;break}return e.next=95,S;case 95:e.next=115;break;case 97:return e.next=99,this.itemsNeedingSync();case 99:if(e.t0=e.sent.length,!(e.t0>0)){e.next=105;break}return e.next=103,this.sync({source:Qo.MoreDirtyItems});case 103:e.next=115;break;case 105:if(!(x instanceof Ro&&x.checkIntegrity)){e.next=114;break}if(!this.state.needsSync||!x.done){e.next=112;break}if(this.log("Syncing again from integrity check"),O=this.sync({checkIntegrity:!0,queueStrategy:Jo.ForceSpawnNew,source:Qo.IntegrityCheck}),!t.awaitAll){e.next=112;break}return e.next=112,O;case 112:e.next=115;break;case 114:this.state.clearIntegrityHashes();case 115:for(P=!0,j=!1,_=void 0,e.prev=118,C=y[Symbol.iterator]();!(P=(D=C.next()).done);P=!0)D.value.resolve();e.next=126;break;case 122:e.prev=122,e.t1=e.catch(118),j=!0,_=e.t1;case 126:e.prev=126,e.prev=127,P||null==C.return||C.return();case 129:if(e.prev=129,!j){e.next=132;break}throw _;case 132:return e.finish(129);case 133:return e.finish(126);case 134:case"end":return e.stop()}var l}),e,this,[[118,122,126,134],[127,,129,133]])}))),function(){return O.apply(this,arguments)})},{key:"syncOnlineOperation",value:(S=Uo(l.a.mark((function e(t,n,r,a){var o,i=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Syncing online user","source:",r,"mode:",a,"payloads:",t),e.t0=Ro,e.t1=t,e.t2=function(){var e=Uo(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==_o.Response){e.next=10;break}if(!n.hasError){e.next=6;break}return e.next=4,i.handleErrorServerResponse(n);case 4:e.next=8;break;case 6:return e.next=8,i.handleSuccessServerResponse(o,n);case 8:e.next=13;break;case 10:if(t!==_o.StatusChanged){e.next=13;break}return e.next=13,i.handleStatusChange(o);case 13:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),e.next=6,this.getLastSyncToken();case 6:return e.t3=e.sent,e.next=9,this.getPaginationToken();case 9:return e.t4=e.sent,e.t5=n,e.t6=this.apiService,o=new e.t0(e.t1,e.t2,e.t3,e.t4,e.t5,e.t6),e.abrupt("return",o);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return S.apply(this,arguments)})},{key:"syncOfflineOperation",value:(x=Uo(l.a.mark((function e(t,n,r){var a,o=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Syncing offline user","source:",n,"mode:",r,"payloads:",t),a=new Ko(t,function(){var e=Uo(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==_o.Response){e.next=3;break}return e.next=3,o.handleOfflineResponse(n);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()),e.abrupt("return",a);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return x.apply(this,arguments)})},{key:"handleStatusChange",value:(k=Uo(l.a.mark((function e(t){var n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.pendingUploadCount(),r=t.totalUploadCount(),a=r-n,this.opStatus.setUploadStatus(a,r);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"handleOfflineResponse",value:(w=Uo(l.a.mark((function e(t){var n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Offline Sync Response",t.rawResponse),n=t.savedPayloads,e.next=4,this.modelManager.emitPayloads(n,d.a.LocalSaved);case 4:return r=this.modelManager.find(Object(v.c)(n)),e.next=7,this.persistPayloads(r);case 7:if(!((a=t.deletedPayloads).length>0)){e.next=11;break}return e.next=11,this.deletePayloads(a);case 11:return this.opStatus.clearError(),this.opStatus.setDownloadStatus(t.retrievedPayloads.length),e.next=15,this.notifyEvent(b.b.SingleSyncCompleted,t);case 15:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"handleErrorServerResponse",value:(g=Uo(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.log("Sync Error",t),401===t.status&&this.notifyEvent(b.b.InvalidSession),this.opStatus.setError(t.error),this.notifyEvent(b.b.SyncError,t.error);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"handleSuccessServerResponse",value:(m=Uo(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f,h,y,d,v,m,g,w,k,x,S,O,P;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._simulate_latency){e.next=3;break}return e.next=3,Object(p.A)(this._simulate_latency.latency);case 3:this.log("Online Sync Response",n.rawResponse),this.setLastSyncToken(n.lastSyncToken),this.setPaginationToken(n.paginationToken),this.opStatus.clearError(),this.opStatus.setDownloadStatus(n.retrievedPayloads.length),r=[],a=!0,o=!1,i=void 0,e.prev=12,s=n.allProcessedPayloads[Symbol.iterator]();case 14:if(a=(c=s.next()).done){e.next=25;break}if(!(u=c.value).deleted&&u.fields.includes(Lo.a.Content)){e.next=18;break}return e.abrupt("continue",22);case 18:return e.next=20,this.protocolService.payloadByDecryptingPayload(u);case 20:f=e.sent,r.push(f);case 22:a=!0,e.next=14;break;case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(12),o=!0,i=e.t0;case 31:e.prev=31,e.prev=32,a||null==s.return||s.return();case 34:if(e.prev=34,!o){e.next=37;break}throw i;case 37:return e.finish(34);case 38:return e.finish(31);case 39:return h=this.modelManager.getMasterCollection(),y=new Oo(n,r,h,t.payloadsSavedOrSaving),e.next=43,y.collectionsByProcessingResponse();case 43:d=e.sent,v=!0,m=!1,g=void 0,e.prev=47,w=d[Symbol.iterator]();case 49:if(v=(k=w.next()).done){e.next=59;break}return x=k.value,e.next=53,this.modelManager.emitCollection(x);case 53:return S=this.modelManager.find(x.uuids()),e.next=56,this.persistPayloads(S);case 56:v=!0,e.next=49;break;case 59:e.next=65;break;case 61:e.prev=61,e.t1=e.catch(47),m=!0,g=e.t1;case 65:e.prev=65,e.prev=66,v||null==w.return||w.return();case 68:if(e.prev=68,!m){e.next=71;break}throw g;case 71:return e.finish(68);case 72:return e.finish(65);case 73:if(!((O=n.deletedPayloads).length>0)){e.next=77;break}return e.next=77,this.deletePayloads(O);case 77:return e.next=79,this.notifyEvent(b.b.SingleSyncCompleted,n);case 79:if(!n.checkIntegrity){e.next=85;break}return e.next=82,this.computeDataIntegrityHash();case 82:return P=e.sent,e.next=85,this.state.setIntegrityHashes(P,n.integrityHash);case 85:case"end":return e.stop()}}),e,this,[[12,27,31,39],[32,,34,38],[47,61,65,73],[66,,68,72]])}))),function(e,t){return m.apply(this,arguments)})},{key:"handleNeverSyncedDeleted",value:(f=Uo(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.map((function(e){return e.payloadRepresentation({dirty:!1})})),e.next=3,this.modelManager.emitPayloads(n,d.a.LocalChanged);case 3:return e.next=5,this.persistPayloads(n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"persistPayloads",value:(u=Uo(l.a.mark((function e(t){var n=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return");case 2:return e.abrupt("return",this.storageService.savePayloads(t).catch((function(e){throw n.notifyEvent(b.b.DatabaseWriteError,e),e})));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"deletePayloads",value:(c=Uo(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.persistPayloads(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"computeDataIntegrityHash",value:(s=Uo(l.a.mark((function e(){var t,n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.itemManager.nonDeletedItems.sort((function(e,t){return t.updated_at.getTime()-e.updated_at.getTime()})),n=t.map((function(e){return e.updatedAtTimestamp()})),r=n.join(","),e.abrupt("return",this.protocolService.crypto.sha256(r));case 7:return e.prev=7,e.t0=e.catch(0),console.error("Error computing data integrity hash",e.t0),e.abrupt("return",void 0);case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(){return s.apply(this,arguments)})},{key:"resolveOutOfSync",value:(i=Uo(l.a.mark((function e(){var t,n,r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new yo(this.apiService,this.protocolService,void 0,"resolve-out-of-sync"),e.next=3,t.run();case 3:return n=e.sent,r=new vo.c(this.modelManager.getMasterCollection(),new dt.a(n,d.a.RemoteRetrieved)),e.next=7,r.resultingCollection();case 7:return a=e.sent,e.next=10,this.modelManager.emitCollection(a);case 10:return e.next=12,this.persistPayloads(a.payloads);case 12:return e.abrupt("return",this.sync({checkIntegrity:!0,source:Qo.ResolveOutOfSync}));case 13:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"statelessDownloadAllItems",value:(o=Uo(l.a.mark((function e(t,n){var r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new yo(this.apiService,this.protocolService,t,n),e.next=3,r.run();case 3:return a=e.sent,e.abrupt("return",a.map((function(e){return Object(v.a)(e)})));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"ut_setDatabaseLoaded",value:function(e){this.databaseLoaded=e}},{key:"ut_clearLastSyncDate",value:function(){this.state.lastSyncDate=void 0}},{key:"ut_beginLatencySimulator",value:function(e){this._simulate_latency={latency:e||1e3,enabled:!0}}},{key:"ut_endLatencySimulator",value:function(){this._simulate_latency=null}}])&&Bo(n.prototype,r),a&&Bo(n,a),t}(L.a);function Xo(e){return(Xo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Zo(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ei(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Zo(o,r,a,i,s,"next",e)}function s(e){Zo(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ti(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ni(e,t,n){return(ni="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ri(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ri(e){return(ri=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ai(e,t){return(ai=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function oi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ii(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function si(e,t,n){return t&&ii(e.prototype,t),n&&ii(e,n),e}function ci(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ui=function(){function e(t,n,r,a){oi(this,e),ci(this,"setClientFunctions",void 0),ci(this,"submitValues",void 0),ci(this,"setValidationStatus",void 0),ci(this,"cancel",void 0),this.setClientFunctions=t,this.submitValues=n,this.setValidationStatus=r,this.cancel=a}return si(e,[{key:"setCallbacks",value:function(e,t,n,r){this.setClientFunctions(e,t,n,r)}}]),e}(),li=function e(t,n,r,a){oi(this,e),ci(this,"onValidValue",void 0),ci(this,"onInvalidValue",void 0),ci(this,"onComplete",void 0),ci(this,"onCancel",void 0),this.onValidValue=t||function(e){},this.onInvalidValue=n||function(e){},this.onComplete=r||function(){},this.onCancel=a||function(){}},fi=function(){function e(t,n){oi(this,e),ci(this,"challenge",void 0),ci(this,"validate",void 0),ci(this,"validValues",[]),ci(this,"invalidValues",[]),ci(this,"artifacts",{}),ci(this,"client",void 0),ci(this,"resolve",void 0),ci(this,"orchestrator",void 0),this.challenge=t,this.validate=n}return si(e,[{key:"setResolver",value:function(e){this.resolve=e}},{key:"complete",value:function(e){var t;e||(e=new D(this.challenge,this.validValues,this.artifacts)),this.resolve(e),null===(t=this.client)||void 0===t||t.onComplete()}},{key:"cancel",value:function(){var e;this.resolve(null),null===(e=this.client)||void 0===e||e.onCancel()}},{key:"isFinished",value:function(){return this.validValues.length===this.challenge.types.length}},{key:"setOrchestratorFunctions",value:function(e,t,n,r){this.orchestrator=new ui(e,n,t,r)}},{key:"setValueStatus",value:function(e,t,n){var r,a,o=t?this.validValues:this.invalidValues,i=o.find((function(t){return t.type===e.type}));(i&&Object(p.x)(o,i),o.push(e),t?this.validValues=o:this.invalidValues=o,Object.assign(this.artifacts,n),this.isFinished())?this.complete():t?null===(r=this.client)||void 0===r||r.onValidValue(e):null===(a=this.client)||void 0===a||a.onInvalidValue(e)}}]),e}(),pi=function(e){function t(e,n){var r;return oi(this,t),r=function(e,t){return!t||"object"!==Xo(t)&&"function"!=typeof t?ti(e):t}(this,ri(t).call(this)),ci(ti(r),"storageService",void 0),ci(ti(r),"protocolService",void 0),ci(ti(r),"challengeOperations",{}),ci(ti(r),"challengeHandler",void 0),r.storageService=e,r.protocolService=n,r}var n,r,a,o,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ai(e,t)}(t,e),si(t,[{key:"deinit",value:function(){this.storageService=void 0,this.protocolService=void 0,this.challengeHandler=void 0,ni(ri(t.prototype),"deinit",this).call(this)}},{key:"promptForChallengeResponse",value:(i=ei(l.a.mark((function e(t){var n,r,a,o,i=this,s=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=!(s.length>1&&void 0!==s[1])||s[1],r=s.length>2?s[2]:void 0,a=this.getChallengeOperation(t),o=!a,a||(a=this.createChallengeOperation(t,n)),r&&(r.orchestrator=a.orchestrator),e.abrupt("return",new Promise((function(e){a.setResolver(e),o&&i.challengeHandler(t,a.orchestrator)})));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"validateChallengeValue",value:(o=ei(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.type!==s.LocalPasscode){e.next=4;break}return e.abrupt("return",this.protocolService.validatePasscode(t.value));case 4:if(t.type!==s.AccountPassword){e.next=8;break}return e.abrupt("return",this.protocolService.validateAccountPassword(t.value));case 8:if(t.type!==s.Biometric){e.next=10;break}return e.abrupt("return",{valid:!0===t.value});case 10:throw"Cannot validate challenge type ".concat(t.type);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"getLaunchChallenge",value:(a=ei(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],this.protocolService.hasPasscode()&&t.push(s.LocalPasscode),e.next=5,this.storageService.getValue(j.BiometricPrefs,M.Nonwrapped);case 5:if((n=e.sent)&&n.enabled&&t.push(s.Biometric),!(t.length>0)){e.next=12;break}return e.abrupt("return",new _(t,c.ApplicationUnlock));case 12:return e.abrupt("return",null);case 13:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"isPasscodeLocked",value:function(){return this.protocolService.rootKeyNeedsUnwrapping()}},{key:"enableBiometrics",value:(r=ei(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setValue(j.BiometricPrefs,{enabled:!0},M.Nonwrapped);case 2:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"createChallengeOperation",value:function(e,t){var n=this,r=new fi(e,t);return r.setOrchestratorFunctions((function(e,t,n,a){var o=new li(e,t,n,a);r.client=o}),(function(t,r,a){n.setValidationStatusForChallenge(e,t,r,a)}),(function(t){n.submitValuesForChallenge(e,t)}),(function(){n.cancelChallenge(e)})),this.setChallengeOperation(r),r}},{key:"getChallengeOperation",value:function(e){return this.challengeOperations[e.id]}},{key:"setChallengeOperation",value:function(e){this.challengeOperations[e.challenge.id]=e}},{key:"deleteChallengeOperation",value:function(e){delete this.challengeOperations[e.challenge.id]}},{key:"cancelChallenge",value:function(e){var t=this.challengeOperations[e.id];t.cancel(),this.deleteChallengeOperation(t)}},{key:"submitValuesForChallenge",value:(n=ei(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f,p,h,y;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=this.getChallengeOperation(t)).validate){e.next=34;break}a=!0,o=!1,i=void 0,e.prev=5,s=n[Symbol.iterator]();case 7:if(a=(c=s.next()).done){e.next=18;break}return u=c.value,e.next=11,this.validateChallengeValue(u);case 11:f=e.sent,p=f.valid,h=f.artifacts,this.setValidationStatusForChallenge(t,u,p,h);case 15:a=!0,e.next=7;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(5),o=!0,i=e.t0;case 24:e.prev=24,e.prev=25,a||null==s.return||s.return();case 27:if(e.prev=27,!o){e.next=30;break}throw i;case 30:return e.finish(27);case 31:return e.finish(24);case 32:e.next=36;break;case 34:y=new D(t,n),r.complete(y);case 36:case"end":return e.stop()}}),e,this,[[5,20,24,32],[25,,27,31]])}))),function(e,t){return n.apply(this,arguments)})},{key:"setValidationStatusForChallenge",value:function(e,t,n,r){var a=this.getChallengeOperation(e);a.setValueStatus(t,n,r),a.isFinished()&&this.deleteChallengeOperation(a)}}]),t}(L.a);function hi(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function yi(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){hi(o,r,a,i,s,"next",e)}function s(e){hi(o,r,a,i,s,"throw",e)}i(void 0)}))}}function di(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function vi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var bi=function(){function e(t,n,r,a,o,i,s){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),vi(this,"environment",void 0),vi(this,"platform",void 0),vi(this,"namespace",void 0),vi(this,"swapClasses",void 0),vi(this,"skipClasses",void 0),vi(this,"crypto",void 0),vi(this,"deviceInterface",void 0),vi(this,"migrationService",void 0),vi(this,"alertService",void 0),vi(this,"httpService",void 0),vi(this,"modelManager",void 0),vi(this,"protocolService",void 0),vi(this,"storageService",void 0),vi(this,"apiService",void 0),vi(this,"sessionManager",void 0),vi(this,"syncService",void 0),vi(this,"challengeService",void 0),vi(this,"singletonManager",void 0),vi(this,"componentManager",void 0),vi(this,"privilegesService",void 0),vi(this,"actionsManager",void 0),vi(this,"historyManager",void 0),vi(this,"itemManager",void 0),vi(this,"eventHandlers",[]),vi(this,"services",[]),vi(this,"streamRemovers",[]),vi(this,"serviceObservers",[]),vi(this,"managedSubscribers",[]),vi(this,"autoSyncInterval",void 0),vi(this,"createdNewDatabase",!1),vi(this,"started",!1),vi(this,"launched",!1),vi(this,"dealloced",!1),!r)throw"Device Interface must be supplied.";if(!t)throw"Environment must be supplied when creating an application.";if(!n)throw"Platform must be supplied when creating an application.";this.environment=t,this.platform=n,this.namespace=a||"",this.deviceInterface=r,this.crypto=o,this.swapClasses=i,this.skipClasses=s,this.constructServices()}var t,n,r,o,i,u,m,g,w,k,x,S,O,P,j,C,D,E,I,A,M,T,K,L,F,V,N,U,B,W,H,z,q,Y,G,Q,$,X,Z,ee,te,ne,ae,oe,ie,se,ce,ue,le,fe;return t=e,(n=[{key:"prepareForLaunch",value:(fe=yi(l.a.mark((function e(t){var n,r=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setLaunchCallback(t),e.next=3,this.deviceInterface.openDatabase().catch((function(e){r.notifyEvent(b.a.LocalDatabaseReadError,e)}));case 3:return n=e.sent,this.createdNewDatabase=(null==n?void 0:n.isNewDatabase)||!1,e.next=7,this.migrationService.initialize();case 7:return e.next=9,this.handleStage(a.PreparingForLaunch_0);case 9:return e.next=11,this.storageService.initializeFromDisk();case 11:return e.next=13,this.protocolService.initialize();case 13:return e.next=15,this.handleStage(a.ReadyForLaunch_05);case 15:return this.started=!0,e.next=18,this.notifyEvent(b.a.Started);case 18:case"end":return e.stop()}}),e,this)}))),function(e){return fe.apply(this,arguments)})},{key:"setLaunchCallback",value:function(e){this.challengeService.challengeHandler=e.receiveChallenge}},{key:"launch",value:(le=yi(l.a.mark((function e(){var t,n,r,o,i,s=this,c=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=c.length>0&&void 0!==c[0]&&c[0],this.launched=!1,e.next=4,this.challengeService.getLaunchChallenge();case 4:if(!(n=e.sent)){e.next=11;break}return e.next=8,this.challengeService.promptForChallengeResponse(n);case 8:return r=e.sent,e.next=11,this.handleLaunchChallengeResponse(r);case 11:if(!this.storageService.isStorageWrapped()){e.next=14;break}return e.next=14,this.storageService.decryptStorage();case 14:return e.next=16,this.handleStage(a.StorageDecrypted_09);case 16:return e.next=18,this.apiService.loadHost();case 18:return e.next=20,this.sessionManager.initializeFromDisk();case 20:return this.historyManager.initializeFromDisk(),this.launched=!0,e.next=24,this.notifyEvent(b.a.Launched);case 24:return e.next=26,this.handleStage(a.Launched_10);case 26:return e.next=28,this.syncService.getDatabasePayloads();case 28:return o=e.sent,e.next=31,this.handleStage(a.LoadingDatabase_11);case 31:if(!this.createdNewDatabase){e.next=34;break}return e.next=34,this.syncService.onNewDatabaseCreated();case 34:if(i=this.syncService.loadDatabasePayloads(o).then(yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s.dealloced){e.next=2;break}throw"Application has been destroyed.";case 2:return e.next=4,s.handleStage(a.LoadedDatabase_12);case 4:return s.beginAutoSyncTimer(),e.abrupt("return",s.syncService.sync({mode:Go.DownloadFirst}));case 6:case"end":return e.stop()}}),e)})))),!t){e.next=38;break}return e.next=38,i;case 38:case"end":return e.stop()}}),e,this)}))),function(){return le.apply(this,arguments)})},{key:"handleLaunchChallengeResponse",value:(ue=yi(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.challenge.types.includes(s.LocalPasscode)){e.next=9;break}if(n=t.artifacts.wrappingKey){e.next=7;break}return r=t.getValueForType(s.LocalPasscode),e.next=6,this.protocolService.computeWrappingKey(r.value);case 6:n=e.sent;case 7:return e.next=9,this.protocolService.unwrapRootKey(n);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return ue.apply(this,arguments)})},{key:"beginAutoSyncTimer",value:function(){var e=this;this.autoSyncInterval=this.deviceInterface.interval((function(){e.syncService.log("Syncing from autosync"),e.sync()}),3e4)}},{key:"getMigrationChallengeResponder",value:function(){var e=this;return(function(){var t=yi(l.a.mark((function t(n,r,a){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.challengeService.promptForChallengeResponse(n,r,a));case 1:case"end":return t.stop()}}),t)})));return function(e,n,r){return t.apply(this,arguments)}}())}},{key:"handleStage",value:(ce=yi(l.a.mark((function e(t){var n,r,a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,r=!1,a=void 0,e.prev=3,o=this.services[Symbol.iterator]();case 5:if(n=(i=o.next()).done){e.next=12;break}return s=i.value,e.next=9,s.handleApplicationStage(t);case 9:n=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,a=e.t0;case 18:e.prev=18,e.prev=19,n||null==o.return||o.return();case 21:if(e.prev=21,!r){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return ce.apply(this,arguments)})},{key:"addEventObserver",value:function(e,t){var n=this,r={callback:e,singleEvent:t};return this.eventHandlers.push(r),function(){Object(p.x)(n.eventHandlers,r)}}},{key:"addSingleEventObserver",value:function(e,t){var n=function(){var n=yi(l.a.mark((function n(r){return l.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r===e&&t(e);case 1:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}();return this.addEventObserver(n,e)}},{key:"notifyEvent",value:(se=yi(l.a.mark((function e(t,n){var r,a,o,i,s,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,a=!1,o=void 0,e.prev=3,i=this.eventHandlers.slice()[Symbol.iterator]();case 5:if(r=(s=i.next()).done){e.next=18;break}if(!(c=s.value).singleEvent||c.singleEvent!==t){e.next=12;break}return e.next=10,c.callback(t,n||{});case 10:e.next=15;break;case 12:if(c.singleEvent){e.next=15;break}return e.next=15,c.callback(t,n||{});case 15:r=!0,e.next=5;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(3),a=!0,o=e.t0;case 24:e.prev=24,e.prev=25,r||null==i.return||i.return();case 27:if(e.prev=27,!a){e.next=30;break}throw o;case 30:return e.finish(27);case 31:return e.finish(24);case 32:this.migrationService.handleApplicationEvent(t);case 33:case"end":return e.stop()}}),e,this,[[3,20,24,32],[25,,27,31]])}))),function(e,t){return se.apply(this,arguments)})},{key:"isDatabaseLoaded",value:function(){return this.syncService.isDatabaseLoaded()}},{key:"savePayload",value:(ie=yi(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(y.b)(t,{dirty:!0,dirtiedDate:new Date}),e.next=3,this.modelManager.emitPayload(n,d.a.LocalChanged);case 3:return e.next=5,this.syncService.sync();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return ie.apply(this,arguments)})},{key:"findItem",value:function(e){return this.itemManager.findItem(e)}},{key:"findItems",value:function(e){return this.itemManager.itemsMatchingPredicate(e)}},{key:"mergeItem",value:(oe=yi(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.emitItemFromPayload(t.payloadRepresentation(),n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return oe.apply(this,arguments)})},{key:"createManagedItem",value:(ae=yi(l.a.mark((function e(t,n){var r,a,o,i=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>2&&void 0!==i[2]&&i[2],a=i.length>3?i[3]:void 0,e.next=4,this.itemManager.createItem(t,n,r,a);case 4:return o=e.sent,e.abrupt("return",o);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return ae.apply(this,arguments)})},{key:"createTemplateItem",value:(ne=yi(l.a.mark((function e(t,n){var r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.createTemplateItem(t,n);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return ne.apply(this,arguments)})},{key:"createItemFromPayload",value:function(e){return Object(v.a)(e)}},{key:"createPayloadFromObject",value:function(e){return Object(y.e)(e)}},{key:"getLastSyncDate",value:function(){return this.syncService.getLastSyncDate()}},{key:"getSyncStatus",value:function(){return this.syncService.getStatus()}},{key:"setItemNeedsSync",value:(te=yi(l.a.mark((function e(t){var n,r=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],e.abrupt("return",this.itemManager.setItemDirty(t.uuid,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return te.apply(this,arguments)})},{key:"setItemsNeedsSync",value:(ee=yi(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.setItemsDirty(Object(v.c)(t)));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return ee.apply(this,arguments)})},{key:"deleteItem",value:(Z=yi(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.setItemToBeDeleted(t.uuid);case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return Z.apply(this,arguments)})},{key:"deleteItemLocally",value:(X=yi(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.itemManager.removeItemLocally(t);case 1:case"end":return e.stop()}}),e,this)}))),function(e){return X.apply(this,arguments)})},{key:"emptyTrash",value:($=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.emptyTrash();case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),e,this)}))),function(){return $.apply(this,arguments)})},{key:"getTrashedItems",value:function(){return this.itemManager.trashedItems}},{key:"insertItem",value:(Q=yi(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.insertItem(t);case 2:return n=e.sent,e.next=5,this.itemManager.changeItems([n.uuid]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return Q.apply(this,arguments)})},{key:"saveItem",value:(G=yi(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.itemManager.findItem(t)){e.next=3;break}throw Error("Attempting to save non-inserted item");case 3:if(n.dirty){e.next=6;break}return e.next=6,this.itemManager.changeItem(t);case 6:return e.next=8,this.syncService.sync();case 8:case"end":return e.stop()}}),e,this)}))),function(e){return G.apply(this,arguments)})},{key:"changeAndSaveItem",value:(Y=yi(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(p.o)(t)){e.next=2;break}throw Error("Must use uuid to change item");case 2:return e.next=4,this.itemManager.changeItems([t],n);case 4:return e.next=6,this.syncService.sync();case 6:return e.abrupt("return",this.findItem(t));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return Y.apply(this,arguments)})},{key:"getItems",value:function(e){return this.itemManager.getItems(e)}},{key:"getDisplayableItems",value:function(e){return this.itemManager.validItemsForContentType(e)}},{key:"getNotesMatchingSmartTag",value:function(e){return this.itemManager.notesMatchingSmartTag(e)}},{key:"findTag",value:function(e){return this.itemManager.findTagByTitle(e)}},{key:"findOrCreateTag",value:(q=yi(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.findOrCreateTagByTitle(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return q.apply(this,arguments)})},{key:"getSmartTags",value:function(){return this.itemManager.getSmartTags()}},{key:"getNoteCount",value:function(){return this.itemManager.noteCount}},{key:"streamItems",value:function(e,t){var n=this,r=this.itemManager.addObserver(e,function(){var e=yi(l.a.mark((function e(n,r,a,o){var i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=n.concat(r).concat(a),t(i,o);case 2:case"end":return e.stop()}}),e)})));return function(t,n,r,a){return e.apply(this,arguments)}}());return this.streamRemovers.push(r),function(){r(),Object(p.x)(n.streamRemovers,r)}}},{key:"setHost",value:(z=yi(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.setHost(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return z.apply(this,arguments)})},{key:"getHost",value:(H=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.getHost());case 1:case"end":return e.stop()}}),e,this)}))),function(){return H.apply(this,arguments)})},{key:"getUser",value:function(){if(!this.launched)throw"Attempting to access user before application unlocked";return this.sessionManager.getUser()}},{key:"getUserVersion",value:(W=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.getUserVersion());case 1:case"end":return e.stop()}}),e,this)}))),function(){return W.apply(this,arguments)})},{key:"protocolUpgradeAvailable",value:(B=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.upgradeAvailable());case 1:case"end":return e.stop()}}),e,this)}))),function(){return B.apply(this,arguments)})},{key:"isEncryptionAvailable",value:(U=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!Object(p.m)(this.getUser())||this.hasPasscode());case 1:case"end":return e.stop()}}),e,this)}))),function(){return U.apply(this,arguments)})},{key:"upgradeProtocolVersion",value:(N=yi(l.a.mark((function e(){var t,n,r,a,o,i,u,f,p,h,y;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.hasPasscode(),n=!this.noAccount(),r=[],t&&r.push(s.LocalPasscode),n&&r.push(s.AccountPassword),a=new _(r,c.ProtocolUpgrade),e.next=8,this.challengeService.promptForChallengeResponse(a);case 8:if(o=e.sent){e.next=11;break}return e.abrupt("return");case 11:if(i=[],!t){e.next=17;break}return f=o.getValueForType(s.LocalPasscode),u=f.value,e.next=17,this.changePasscode(u);case 17:if(!n){e.next=24;break}return p=o.getValueForType(s.AccountPassword),h=p.value,e.next=22,this.changePassword(h,h,u);case 22:(null==(y=e.sent)?void 0:y.error)&&i.push(y.error);case 24:return e.abrupt("return",i);case 25:case"end":return e.stop()}}),e,this)}))),function(){return N.apply(this,arguments)})},{key:"noAccount",value:function(){var e=this.getUser();return Object(p.m)(e)}},{key:"importData",value:(V=yi(l.a.mark((function e(t,n){var r,a,o,i,s,c=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=c.length>2&&void 0!==c[2]&&c[2],e.next=3,this.protocolService.payloadsByDecryptingBackupFile(t,n);case 3:return a=e.sent,o=a.filter((function(e){return!e.errorDecrypting})),e.next=7,this.modelManager.importPayloads(o);case 7:if(i=e.sent,s=this.sync(),!r){e.next=12;break}return e.next=12,s;case 12:return e.abrupt("return",{affectedItems:i,errorCount:a.length-o.length});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return V.apply(this,arguments)})},{key:"createBackupFile",value:(F=yi(l.a.mark((function e(t,n){var r,a=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]&&a[2],e.abrupt("return",this.protocolService.createBackupFile(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return F.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.storageService.isEphemeralSession()}},{key:"lockSyncing",value:function(){this.syncService.lockSyncing()}},{key:"unlockSyncing",value:function(){this.syncService.unlockSyncing()}},{key:"sync",value:(L=yi(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.sync(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return L.apply(this,arguments)})},{key:"resolveOutOfSync",value:(K=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.resolveOutOfSync());case 1:case"end":return e.stop()}}),e,this)}))),function(){return K.apply(this,arguments)})},{key:"setValue",value:(T=yi(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.setValue(t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return T.apply(this,arguments)})},{key:"getValue",value:(M=yi(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(t,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return M.apply(this,arguments)})},{key:"removeValue",value:(A=yi(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.removeValue(t,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return A.apply(this,arguments)})},{key:"clearDatabase",value:(I=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.clearAllPayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return I.apply(this,arguments)})},{key:"rewriteItemsKeys",value:(E=yi(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.protocolService.itemsKeys,n=t.map((function(e){return e.payloadRepresentation()})),e.next=4,this.storageService.deletePayloads(n);case 4:return e.next=6,this.syncService.persistPayloads(n);case 6:case"end":return e.stop()}}),e,this)}))),function(){return E.apply(this,arguments)})},{key:"deinit",value:function(){clearInterval(this.autoSyncInterval);var e=!0,t=!1,n=void 0;try{for(var r,a=this.serviceObservers[Symbol.iterator]();!(e=(r=a.next()).done);e=!0)(0,r.value)()}catch(e){t=!0,n=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw n}}var o=!0,i=!1,s=void 0;try{for(var c,u=this.managedSubscribers[Symbol.iterator]();!(o=(c=u.next()).done);o=!0)(0,c.value)()}catch(e){i=!0,s=e}finally{try{o||null==u.return||u.return()}finally{if(i)throw s}}var l=!0,f=!1,p=void 0;try{for(var h,y=this.services[Symbol.iterator]();!(l=(h=y.next()).done);l=!0)h.value.deinit()}catch(e){f=!0,p=e}finally{try{l||null==y.return||y.return()}finally{if(f)throw p}}this.deviceInterface.deinit(),this.deviceInterface=void 0,this.crypto=void 0,this.createdNewDatabase=!1,this.services.length=0,this.serviceObservers.length=0,this.managedSubscribers.length=0,this.streamRemovers.length=0,this.clearServices(),this.dealloced=!0,this.started=!1}},{key:"getWrappingKeyIfNecessary",value:(D=yi(l.a.mark((function e(t){var n,r,a,o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasPasscode()){e.next=2;break}return e.abrupt("return",{});case 2:if(t){e.next=11;break}return n=new _([s.LocalPasscode],c.ResaveRootKey),e.next=6,this.challengeService.promptForChallengeResponse(n);case 6:if(r=e.sent){e.next=9;break}return e.abrupt("return",{canceled:!0});case 9:a=r.getValueForType(s.LocalPasscode),t=a.value;case 11:return e.next=13,this.protocolService.computeWrappingKey(t);case 13:return o=e.sent,e.abrupt("return",{wrappingKey:o});case 15:case"end":return e.stop()}}),e,this)}))),function(e){return D.apply(this,arguments)})},{key:"register",value:(C=yi(l.a.mark((function e(t,n){var r,a,o,i,s,c=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=c.length>2&&void 0!==c[2]&&c[2],a=!(c.length>3&&void 0!==c[3])||c[3],e.next=4,this.getWrappingKeyIfNecessary();case 4:if(o=e.sent,i=o.wrappingKey,!o.canceled){e.next=9;break}return e.abrupt("return");case 9:return this.lockSyncing(),e.next=12,this.sessionManager.register(t,n);case 12:if((s=e.sent).response.error){e.next=35;break}return e.next=16,this.protocolService.setNewRootKey(s.rootKey,s.keyParams,i);case 16:return this.syncService.resetSyncState(),e.next=19,this.storageService.setPersistencePolicy(r?R.Ephemeral:R.Default);case 19:if(!a){e.next=24;break}return e.next=22,this.syncService.markAllItemsAsNeedingSync(!0);case 22:e.next=27;break;case 24:return this.itemManager.removeAllItemsFromMemory(),e.next=27,this.clearDatabase();case 27:return e.next=29,this.notifyEvent(b.a.SignedIn);case 29:return this.unlockSyncing(),e.next=32,this.syncService.sync({mode:Go.DownloadFirst,queueStrategy:Jo.ForceSpawnNew});case 32:this.protocolService.decryptErroredItems(),e.next=36;break;case 35:this.unlockSyncing();case 36:return e.abrupt("return",s.response);case 37:case"end":return e.stop()}}),e,this)}))),function(e,t){return C.apply(this,arguments)})},{key:"signIn",value:(j=yi(l.a.mark((function e(t,n){var r,a,o,i,s,c,u,f,p,h,y=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=y.length>2&&void 0!==y[2]&&y[2],a=y.length>3&&void 0!==y[3]&&y[3],o=y.length>4?y[4]:void 0,i=y.length>5?y[5]:void 0,s=!(y.length>6&&void 0!==y[6])||y[6],c=y.length>7&&void 0!==y[7]&&y[7],e.next=8,this.getWrappingKeyIfNecessary();case 8:if(u=e.sent,f=u.wrappingKey,!u.canceled){e.next=13;break}return e.abrupt("return");case 13:return this.lockSyncing(),e.next=16,this.sessionManager.signIn(t,n,r,o,i);case 16:if((p=e.sent).response.error){e.next=41;break}return e.next=20,this.protocolService.setNewRootKey(p.rootKey,p.keyParams,f);case 20:return this.syncService.resetSyncState(),e.next=23,this.storageService.setPersistencePolicy(a?R.Ephemeral:R.Default);case 23:if(!s){e.next=28;break}return e.next=26,this.syncService.markAllItemsAsNeedingSync(!0);case 26:e.next=31;break;case 28:return this.itemManager.removeAllItemsFromMemory(),e.next=31,this.clearDatabase();case 31:return e.next=33,this.notifyEvent(b.a.SignedIn);case 33:if(this.unlockSyncing(),h=this.syncService.sync({mode:Go.DownloadFirst,checkIntegrity:!0,queueStrategy:Jo.ForceSpawnNew}),!c){e.next=38;break}return e.next=38,h;case 38:this.protocolService.decryptErroredItems(),e.next=42;break;case 41:this.unlockSyncing();case 42:return e.abrupt("return",p.response);case 43:case"end":return e.stop()}}),e,this)}))),function(e,t){return j.apply(this,arguments)})},{key:"changePassword",value:(P=yi(l.a.mark((function e(t,n,r){var a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappingKeyIfNecessary(r);case 2:if(a=e.sent,o=a.wrappingKey,!a.canceled){e.next=7;break}return e.abrupt("return");case 7:return e.next=9,this.protocolService.getRootKeyParams();case 9:return i=e.sent,this.lockSyncing(),e.next=13,this.sessionManager.changePassword(t,i,n);case 13:if((s=e.sent).response.error){e.next=24;break}return e.next=17,this.protocolService.setNewRootKey(s.rootKey,s.keyParams,o);case 17:return e.next=19,this.protocolService.createNewDefaultItemsKey();case 19:return this.unlockSyncing(),e.next=22,this.syncService.sync();case 22:e.next=25;break;case 24:this.unlockSyncing();case 25:return e.abrupt("return",s.response);case 26:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return P.apply(this,arguments)})},{key:"signOut",value:(O=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionManager.signOut();case 2:return e.next=4,this.protocolService.clearLocalKeyState();case 4:return e.next=6,this.storageService.clearAllData();case 6:return e.next=8,this.notifyEvent(b.a.SignedOut);case 8:this.deinit();case 9:case"end":return e.stop()}}),e,this)}))),function(){return O.apply(this,arguments)})},{key:"validateAccountPassword",value:(S=yi(l.a.mark((function e(t){var n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.protocolService.validateAccountPassword(t);case 2:return n=e.sent,r=n.valid,e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"isStarted",value:function(){return this.started}},{key:"isLaunched",value:function(){return this.launched}},{key:"hasPasscode",value:function(){return this.protocolService.hasPasscode()}},{key:"isLocked",value:(x=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.started){e.next=2;break}return e.abrupt("return",!0);case 2:return e.abrupt("return",this.challengeService.isPasscodeLocked());case 3:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"lock",value:(k=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deinit());case 1:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"setPasscode",value:(w=yi(l.a.mark((function e(t){var n,r,a,o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateUuid();case 2:return n=e.sent,e.next=5,this.protocolService.createRootKey(n,t);case 5:return r=e.sent,a=r.key,o=r.keyParams,e.next=10,this.protocolService.setNewRootKeyWrapper(a,o);case 10:return e.next=12,this.rewriteItemsKeys();case 12:return e.next=14,this.syncService.sync();case 14:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"removePasscode",value:(g=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.protocolService.removeRootKeyWrapper();case 2:return e.next=4,this.rewriteItemsKeys();case 4:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"changePasscode",value:(m=yi(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.removePasscode();case 2:return e.abrupt("return",this.setPasscode(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"setStorageEncryptionPolicy",value:(u=yi(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setEncryptionPolicy(t);case 2:return e.abrupt("return",this.protocolService.repersistAllItems());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"generateUuid",value:(i=yi(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",f.a.GenerateUuid());case 1:case"end":return e.stop()}}),e)}))),function(){return i.apply(this,arguments)})},{key:"changeDeviceInterface",value:(o=yi(l.a.mark((function e(t){var n,r,a,o,i,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(this.deviceInterface=t,n=!0,r=!1,a=void 0,e.prev=4,o=this.services[Symbol.iterator]();!(n=(i=o.next()).done);n=!0)(s=i.value).deviceInterface&&(s.deviceInterface=t);e.next=12;break;case 8:e.prev=8,e.t0=e.catch(4),r=!0,a=e.t0;case 12:e.prev=12,e.prev=13,n||null==o.return||o.return();case 15:if(e.prev=15,!r){e.next=18;break}throw a;case 18:return e.finish(15);case 19:return e.finish(12);case 20:case"end":return e.stop()}}),e,this,[[4,8,12,20],[13,,15,19]])}))),function(e){return o.apply(this,arguments)})},{key:"constructServices",value:function(){this.createModelManager(),this.createItemManager(),this.createStorageManager(),this.createProtocolService();var e={payloadByEncryptingPayload:this.protocolService.payloadByEncryptingPayload.bind(this.protocolService),payloadByDecryptingPayload:this.protocolService.payloadByDecryptingPayload.bind(this.protocolService)};this.storageService.encryptionDelegate=e,this.createMigrationService(),this.createAlertManager(),this.createHttpManager(),this.createApiService(),this.createSessionManager(),this.createSyncManager(),this.createChallengeService(),this.createSingletonManager(),this.createComponentManager(),this.createPrivilegesService(),this.createHistoryManager(),this.createActionsManager()}},{key:"clearServices",value:function(){this.migrationService=void 0,this.alertService=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.sessionManager=void 0,this.syncService=void 0,this.challengeService=void 0,this.singletonManager=void 0,this.componentManager=void 0,this.privilegesService=void 0,this.actionsManager=void 0,this.historyManager=void 0,this.itemManager=void 0,this.services=[]}},{key:"createMigrationService",value:function(){this.migrationService=new Ur({protocolService:this.protocolService,deviceInterface:this.deviceInterface,storageService:this.storageService,itemManager:this.itemManager,environment:this.environment,namespace:this.namespace},this.getMigrationChallengeResponder()),this.services.push(this.migrationService)}},{key:"createAlertManager",value:function(){this.shouldSkipClass(re)||(this.alertService=new(this.getClass(re))(this.deviceInterface),this.services.push(this.alertService))}},{key:"createApiService",value:function(){this.apiService=new Le(this.httpService,this.storageService),this.services.push(this.apiService)}},{key:"createItemManager",value:function(){this.itemManager=new no(this.modelManager),this.services.push(this.itemManager)}},{key:"createComponentManager",value:function(){this.shouldSkipClass(ot)||(this.componentManager=new ot(this.itemManager,this.modelManager,this.syncService,this.alertService,this.environment,this.platform,this.deviceInterface.timeout),this.services.push(this.componentManager))}},{key:"createHttpManager",value:function(){this.httpService=new yt,this.services.push(this.httpService)}},{key:"createModelManager",value:function(){this.modelManager=new _t,this.services.push(this.modelManager)}},{key:"createSingletonManager",value:function(){this.singletonManager=new Ft(this.itemManager,this.syncService),this.services.push(this.singletonManager)}},{key:"createStorageManager",value:function(){this.storageService=new J(this.deviceInterface,this.namespace),this.services.push(this.storageService)}},{key:"createProtocolService",value:function(){var e=this;this.protocolService=new Xr(this.itemManager,this.modelManager,this.deviceInterface,this.storageService,this.crypto),this.protocolService.onKeyStatusChange(yi(l.a.mark((function t(){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.notifyEvent(b.a.KeyStatusChanged);case 2:case"end":return t.stop()}}),t)})))),this.services.push(this.protocolService)}},{key:"createSessionManager",value:function(){this.sessionManager=new Se(this.storageService,this.apiService,this.alertService,this.protocolService),this.services.push(this.sessionManager)}},{key:"createSyncManager",value:function(){var e=this;this.syncService=new $o(this.itemManager,this.sessionManager,this.protocolService,this.storageService,this.modelManager,this.apiService,this.deviceInterface.interval);var t=function(){var t=yi(l.a.mark((function t(n){var r;return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r=Object(b.c)(n))){t.next=4;break}return t.next=4,e.notifyEvent(r);case 4:return t.next=6,e.protocolService.onSyncEvent(n);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),n=this.syncService.addEventObserver(t);this.serviceObservers.push(n),this.services.push(this.syncService)}},{key:"createChallengeService",value:function(){this.challengeService=new pi(this.storageService,this.protocolService),this.services.push(this.challengeService)}},{key:"createPrivilegesService",value:function(){this.privilegesService=new Ua(this.itemManager,this.syncService,this.singletonManager,this.protocolService,this.storageService,this.sessionManager),this.services.push(this.privilegesService)}},{key:"createHistoryManager",value:function(){this.historyManager=new _a(this.itemManager,this.storageService,[h.a.Note],this.deviceInterface.timeout),this.services.push(this.historyManager)}},{key:"createActionsManager",value:function(){this.actionsManager=new Jt(this.itemManager,this.alertService,this.deviceInterface,this.httpService,this.modelManager,this.protocolService,this.syncService),this.services.push(this.actionsManager)}},{key:"shouldSkipClass",value:function(e){return this.skipClasses&&this.skipClasses.includes(e)}},{key:"getClass",value:function(e){var t=this.swapClasses&&this.swapClasses.find((function(t){return t.swap===e}));return t?t.with:e}}])&&di(t.prototype,n),r&&di(t,r),e}();function mi(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function gi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function wi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ki=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),wi(this,"timeout",void 0),wi(this,"interval",void 0),wi(this,"namespace",void 0),this.namespace=t,this.timeout=n||setTimeout.bind(Object(p.j)()),this.interval=r||setInterval.bind(Object(p.j)())}var t,n,r,a,o;return t=e,(n=[{key:"deinit",value:function(){this.timeout=null,this.interval=null}},{key:"getJsonParsedStorageValue",value:(a=l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRawStorageValue(t);case 2:return n=e.sent,e.abrupt("return",n?JSON.parse(n):n);case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){mi(o,n,r,i,s,"next",e)}function s(e){mi(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e){return o.apply(this,arguments)})}])&&gi(t.prototype,n),r&&gi(t,r),e}(),xi=n(99),Si=n(49)}])}));
//# sourceMappingURL=snjs.js.map