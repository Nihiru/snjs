!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("SNLibrary",[],t):"object"==typeof exports?exports.SNLibrary=t():e.SNLibrary=t()}(window,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/dist/",n(n.s=195)}([function(e,t,n){e.exports=n(81)},function(e,t,n){"use strict";(function(e){n.d(t,"m",(function(){return w})),n.d(t,"i",(function(){return k})),n.d(t,"t",(function(){return x})),n.d(t,"r",(function(){return S})),n.d(t,"l",(function(){return O})),n.d(t,"D",(function(){return P})),n.d(t,"f",(function(){return j})),n.d(t,"q",(function(){return _})),n.d(t,"o",(function(){return C})),n.d(t,"p",(function(){return D})),n.d(t,"s",(function(){return I})),n.d(t,"n",(function(){return E})),n.d(t,"J",(function(){return M})),n.d(t,"K",(function(){return R})),n.d(t,"w",(function(){return T})),n.d(t,"j",(function(){return A})),n.d(t,"G",(function(){return K})),n.d(t,"B",(function(){return F})),n.d(t,"b",(function(){return L})),n.d(t,"k",(function(){return V})),n.d(t,"c",(function(){return N})),n.d(t,"e",(function(){return W})),n.d(t,"C",(function(){return U})),n.d(t,"d",(function(){return B})),n.d(t,"x",(function(){return H})),n.d(t,"F",(function(){return z})),n.d(t,"H",(function(){return q})),n.d(t,"v",(function(){return J})),n.d(t,"z",(function(){return G})),n.d(t,"y",(function(){return Q})),n.d(t,"u",(function(){return $})),n.d(t,"a",(function(){return Y})),n.d(t,"h",(function(){return X})),n.d(t,"A",(function(){return Z})),n.d(t,"g",(function(){return ee})),n.d(t,"I",(function(){return te})),n.d(t,"E",(function(){return ne}));var r=n(0),a=n.n(r),i=n(20),o=n.n(i),s=n(18),c=n.n(s),u=n(16),l=n.n(u),f=n(79),p=n.n(f),h=n(80),y=n.n(h),d=n(23),v=n.n(d);function b(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function m(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){b(i,r,a,o,s,"next",e)}function s(e){b(i,r,a,o,s,"throw",e)}o(void 0)}))}}function g(e){return(g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function w(){return"undefined"!=typeof window?window:void 0!==e?e:null}function k(e){return Object.keys(e).map((function(t){return e[t]}))}function x(){return null!==w()&&!(document&&document.documentMode)||/Edge/.test(navigator.userAgent)&&window.crypto&&!!window.crypto.subtle}function S(){return"undefined"!=typeof navigator&&"ReactNative"===navigator.product}function O(e,t,n){return e.find((function(e){return e[t]===n}))}function P(e,t){return c()(e,t)}function j(){for(var e=[],t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var a=0,i=n;a<i.length;a++){var o=i[a];e=e.concat(o)}return e}function _(e){return null!==e&&("function"==typeof e||"object"===g(e))}function C(e){return null!==e&&"function"==typeof e}function D(e){return null==e}function I(e){return"string"==typeof e||e instanceof String}function E(e,t){return e>t?e:t}function M(e,t,n){return y()(e.concat(t),(function(e,t){var r=!0,a=!1,i=void 0;try{for(var o,s=n[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value;if(e[c]!==t[c])return!1}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return!0}))}function R(e){return v()(e)}function T(e){return e[e.length-1]}function A(e,t){var n=!0,r=!1,a=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;e.push(s)}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}}function K(e,t){var n=!0,r=!1,a=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){F(e,i.value)}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}}function F(e,t){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}function L(e,t){e.includes(t)||e.push(t)}function V(e,t){o()(e,t)}function N(e,t){return e.filter((function(e){return!t.includes(e)})).concat(t.filter((function(t){return!e.includes(t)})))}function W(e,t){return!(e&&!t||!e&&t)&&(e instanceof Date&&t instanceof Date?e.getTime()===t.getTime():e instanceof String&&t instanceof String?e===t:q(e,t))}function U(e,t){e.splice(t,1)}function B(e,t){var n=e.slice();return U(n,t),n}function H(e){for(var t=[],n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];t.push(e[a])}return t}function z(e){var t=Object.keys(e).sort(),n={},r=!0,a=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value;n[c]=e[c]}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return Y(n)}function q(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var a=0,i=n;a<i.length;a++){var o=i[a];if(e[o]!==t[o])return!1}return!0}function J(e){for(var t={},n=0,r=Object.keys(e);n<r.length;n++){var a=r[n],i=void 0;try{i=JSON.parse(e[a])}catch(t){i=e[a]}t[a]=i}return t}function G(e,t){if(e){var n=!0,r=!1,a=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){delete e[i.value]}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}}}function Q(e,t){var n=Object.assign({},e),r=!0,a=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){delete n[o.value]}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}function $(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.map((function(e,t){return 0===t?e.trim().replace(/[\/]*$/g,""):e.trim().replace(/(^[\/]*|[\/]*$)/g,"")})).filter((function(e){return e.length})).join("/")}function Y(e){return e instanceof Date?new Date(e):_(e)?JSON.parse(JSON.stringify(e)):e}function X(e,t){if(!e||!t)throw"Attempting to deepMerge with null values";return p()(e,t,(function(e,t){if(l()(e))return t})),e}function Z(e,t){var n={},r=!0,a=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value;n[c]=e[c]}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return Y(n)}function ee(e){var t=Object.getOwnPropertyNames(e),n=!0,r=!1,a=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value,c=e[s];c&&"object"===g(c)&&!Object.isFrozen(c)?e[s]=ee(c):e[s]=c}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}return Object.freeze(e)}function te(e,t){var n=t/4;return e.substring(0,n)}function ne(e){return re.apply(this,arguments)}function re(){return(re=m(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.warn("Sleeping for",t),e.abrupt("return",new Promise((function(e,n){setTimeout((function(){e()}),t)})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}).call(this,n(30))},function(e,t,n){"use strict";n.d(t,"e",(function(){return b})),n.d(t,"g",(function(){return m})),n.d(t,"d",(function(){return g})),n.d(t,"f",(function(){return w})),n.d(t,"b",(function(){return k})),n.d(t,"c",(function(){return S})),n.d(t,"a",(function(){return O}));var r=n(28),a=n(3),i=n(9),o=n(1),s=n(5),c=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash,s.a.Legacy003AuthParams,s.a.Dirty,s.a.DirtiedDate,s.a.ErrorDecrypting,s.a.ErrorDecryptingChanged,s.a.WaitingForKey,s.a.LastSyncBegan,s.a.LastSyncEnd],u=[s.a.Uuid,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.Legacy003AuthHash,s.a.ErrorDecrypting,s.a.ErrorDecryptingChanged,s.a.WaitingForKey],l=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Legacy003AuthHash],f=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash,s.a.Legacy003AuthParams,s.a.Dirty,s.a.DirtiedDate,s.a.ErrorDecrypting,s.a.WaitingForKey],p=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash],h=[s.a.Uuid,s.a.ContentType,s.a.Content,s.a.UpdatedAt],y=[s.a.Uuid,s.a.Content,s.a.CreatedAt],d=[s.a.Uuid,s.a.Content,s.a.ContentType,s.a.CreatedAt],v=[s.a.Uuid,s.a.ContentType,s.a.UpdatedAt,s.a.Deleted,s.a.Dirty,s.a.LastSyncEnd];function b(e,t){return x(e,c.slice(),void 0,t)}function m(e,t,n,r){var a={},i=n||t.fields,o=!0,s=!1,c=void 0;try{for(var u,l=i[Symbol.iterator]();!(o=(u=l.next()).done);o=!0){var f=u.value;a[f]=t[f]}}catch(e){s=!0,c=e}finally{try{o||null==l.return||l.return()}finally{if(s)throw c}}if(r)for(var p=0,h=Object.keys(r);p<h.length;p++){var y=h[p];a[y]=r[y]}return k(e,a)}function g(e,t,n){return x(e,function(e){if(e===i.a.FileEncrypted||e===i.a.FileDecrypted||e===i.a.FilePreferEncrypted)return l.slice();if(e===i.a.LocalStoragePreferEncrypted||e===i.a.LocalStorageDecrypted||e===i.a.LocalStorageEncrypted)return f.slice();if(e===i.a.Sync||e===i.a.SyncDecrypted)return p.slice();throw"No payload fields found for intent ".concat(e)}(t),a.a.Constructor,n)}function w(e,t,n){return x(e,function(e){if(e===a.a.FileImport)return l.slice();if(e===a.a.SessionHistory)return h.slice();if(e===a.a.ComponentRetrieved)return y.slice();if(e===a.a.ComponentCreated)return d.slice();if(e===a.a.LocalRetrieved||e===a.a.LocalChanged)return f.slice();if(e===a.a.RemoteRetrieved||e===a.a.ConflictData||e===a.a.ConflictUuid)return p.slice();if(e===a.a.LocalSaved||e===a.a.RemoteSaved)return v.slice();throw"No payload fields found for source ".concat(e)}(t),t,n)}function k(e,t){return x(e,e.fields,e.source,t)}function x(e,t,n,i){var s=Object(o.A)(e,t),c=i instanceof r.a?i.fields.slice():Object.keys(i||[]),u=!0,l=!1,f=void 0;try{for(var p,h=c[Symbol.iterator]();!(u=(p=h.next()).done);u=!0){var y=p.value,d=i[y];s[y]=d?Object(o.a)(d):d}}catch(e){l=!0,f=e}finally{try{u||null==h.return||h.return()}finally{if(l)throw f}}var v=Object(o.K)(t.concat(c));return new r.a(s,v,n||a.a.Constructor)}function S(e){return x(e,Object.keys(e))}function O(e,t){return x(e,u.slice(),void 0,t)}},function(e,t,n){"use strict";var r;function a(e){return[r.RemoteRetrieved,r.ComponentRetrieved,r.RemoteActionRetrieved].includes(e)}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),function(e){e[e.RemoteRetrieved=1]="RemoteRetrieved",e[e.RemoteSaved=2]="RemoteSaved",e[e.LocalSaved=3]="LocalSaved",e[e.LocalRetrieved=4]="LocalRetrieved",e[e.LocalChanged=5]="LocalChanged",e[e.ComponentRetrieved=6]="ComponentRetrieved",e[e.DesktopInstalled=7]="DesktopInstalled",e[e.RemoteActionRetrieved=8]="RemoteActionRetrieved",e[e.FileImport=9]="FileImport",e[e.RemoteConflict=10]="RemoteConflict",e[e.ImportConflict=11]="ImportConflict",e[e.SavedOrSaving=12]="SavedOrSaving",e[e.DecryptedTransient=13]="DecryptedTransient",e[e.ConflictUuid=14]="ConflictUuid",e[e.ConflictData=15]="ConflictData",e[e.SessionHistory=16]="SessionHistory",e[e.Constructor=17]="Constructor",e[e.ComponentCreated=18]="ComponentCreated",e[e.PreSyncSave=19]="PreSyncSave"}(r||(r={}))},function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return o}));var a,i="org.standardnotes.sn";function o(e){var t;return(r(t={},a.Note,"note"),r(t,a.Tag,"tag"),r(t,a.SmartTag,"smart tag"),r(t,a.ActionsExtension,"action-based extension"),r(t,a.Component,"component"),r(t,a.Editor,"editor"),r(t,a.Theme,"theme"),r(t,a.ServerExtension,"server extension"),r(t,a.Mfa,"two-factor authentication setting"),r(t,a.FilesafeCredentials,"FileSafe credential"),r(t,a.FilesafeFileMetadata,"FileSafe file"),r(t,a.FilesafeIntegration,"FileSafe integration"),t)[e]}!function(e){e.Any="*",e.Item="SF|Item",e.RootKey="SN|RootKey|NoSync",e.ItemsKey="SN|ItemsKey",e.EncryptedStorage="SN|EncryptedStorage",e.Note="Note",e.Tag="Tag",e.SmartTag="SN|SmartTag",e.Component="SN|Component",e.Editor="SN|Editor",e.ActionsExtension="Extension",e.UserPrefs="SN|UserPreferences",e.Privileges="SN|Privileges",e.HistorySession="SN|HistorySession",e.Theme="SN|Theme",e.Mfa="SF|MFA",e.ServerExtension="SF|Extension",e.FilesafeCredentials="SN|FileSafe|Credentials",e.FilesafeFileMetadata="SN|FileSafe|FileMetadata",e.FilesafeIntegration="SN|FileSafe|Integration",e.ExtensionRepo="SN|ExtensionRepo"}(a||(a={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.Uuid="uuid",e.ContentType="content_type",e.ItemsKeyId="items_key_id",e.EncItemKey="enc_item_key",e.Content="content",e.CreatedAt="created_at",e.UpdatedAt="updated_at",e.Deleted="deleted",e.Legacy003AuthHash="auth_hash",e.Legacy003AuthParams="auth_params",e.Dirty="dirty",e.DirtiedDate="dirtiedDate",e.WaitingForKey="waitingForKey",e.ErrorDecrypting="errorDecrypting",e.ErrorDecryptingChanged="errorDecryptingValueChanged",e.LastSyncBegan="lastSyncBegan",e.LastSyncEnd="lastSyncEnd"}(r||(r={}))},function(e,t,n){"use strict";(function(e){n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"e",(function(){return i})),n.d(t,"d",(function(){return v})),n.d(t,"b",(function(){return b}));var r,a,i,o=n(10),s=n(14),c=n(2),u=n(1),l=n(15),f=n(4);function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),e}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.UserInteraction=1]="UserInteraction",e[e.Internal=2]="Internal",e[e.NonDirtying=3]="NonDirtying"}(r||(r={})),function(e){e.Pinned="pinned",e.Archived="archived",e.Locked="locked",e.UserModifiedDate="client_updated_at",e.DefaultEditor="defaultEditor",e.MobileRules="mobileRules",e.NotAvailableOnMobile="notAvailableOnMobile",e.MobileActive="mobileActive",e.LastSize="lastSize",e.PrefersPlainEditor="prefersPlainEditor",e.ComponentInstallError="installError"}(a||(a={})),function(e){e[e.KeepEarliest=1]="KeepEarliest"}(i||(i={}));var v=function(){function t(n){var r=this;if(p(this,t),d(this,"payload",void 0),d(this,"conflictOf",void 0),d(this,"createdAtString",void 0),d(this,"updatedAtString",void 0),d(this,"protected",!1),d(this,"trashed",!1),d(this,"pinned",!1),d(this,"archived",!1),d(this,"locked",!1),!n.uuid||!n.content_type)throw Error("Cannot create item without both uuid and content_type");if(n.format===o.a.DecryptedBareObject&&(n.enc_item_key||n.items_key_id||n.auth_hash))throw Error("Creating an item from a decrypted payload should not contain enc params");this.payload=n,this.conflictOf=n.safeContent.conflict_of,this.createdAtString=this.created_at&&this.dateToLocalizedString(this.created_at),n.format===o.a.DecryptedBareObject&&(this.updatedAtString=this.dateToLocalizedString(this.userModifiedDate),this.protected=this.payload.safeContent.protected,this.trashed=this.payload.safeContent.trashed,this.pinned=this.getAppDomainValue(a.Pinned),this.archived=this.getAppDomainValue(a.Archived),this.locked=this.getAppDomainValue(a.Locked)),e((function(){Object(u.g)(r)}))}return y(t,[{key:"payloadRepresentation",value:function(e){return Object(c.b)(this.payload,e)}},{key:"hasRelationshipWithItem",value:function(e){var t;return!!(null===(t=this.payload.safeContent.references)||void 0===t?void 0:t.find((function(t){return t.uuid===e.uuid})))}},{key:"getDomainData",value:function(e){var t=this.payload.safeContent.appData;if(t)return t[e]}},{key:"getAppDomainValue",value:function(e){return this.getDomainData(t.DefaultAppDomain())[e]}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["conflict_of"]}},{key:"appDataContentKeysToIgnoreWhenCheckingEquality",value:function(){return[a.UserModifiedDate]}},{key:"getContentCopy",value:function(){return JSON.parse(JSON.stringify(this.content))}},{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?s.a.KeepLeftDuplicateRight:this.isSingleton?s.a.KeepLeft:this.deleted||e.deleted?s.a.KeepRight:m(this,e)?m(this,e,["references"])?s.a.KeepLeftDuplicateRight:s.a.KeepLeftMergeRefs:s.a.KeepRight}},{key:"isItemContentEqualWith",value:function(e){return g(this.payload.contentObject,e.payload.contentObject,this.contentKeysToIgnoreWhenCheckingEquality(),this.appDataContentKeysToIgnoreWhenCheckingEquality())}},{key:"satisfiesPredicate",value:function(e){return l.a.ItemSatisfiesPredicate(this,e)}},{key:"updatedAtTimestamp",value:function(){var e;return null===(e=this.updated_at)||void 0===e?void 0:e.getTime()}},{key:"dateToLocalizedString",value:function(e){if("undefined"!=typeof Intl&&Intl.DateTimeFormat){if(!t.sharedDateFormatter){var n=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language;t.sharedDateFormatter=new Intl.DateTimeFormat(n,{year:"numeric",month:"short",day:"2-digit",weekday:"long",hour:"2-digit",minute:"2-digit"})}return t.sharedDateFormatter.format(e)}return e.toDateString()+" "+e.toLocaleTimeString()}},{key:"uuid",get:function(){return this.payload.uuid}},{key:"content",get:function(){return this.payload.content}},{key:"safeContent",get:function(){return this.payload.safeContent}},{key:"references",get:function(){return this.payload.safeContent.references||[]}},{key:"deleted",get:function(){return this.payload.deleted}},{key:"content_type",get:function(){return this.payload.content_type}},{key:"created_at",get:function(){return this.payload.created_at}},{key:"updated_at",get:function(){return this.payload.updated_at}},{key:"userModifiedDate",get:function(){var e=this.getAppDomainValue(a.UserModifiedDate);return new Date(e||this.updated_at)}},{key:"dirtiedDate",get:function(){return this.payload.dirtiedDate}},{key:"dirty",get:function(){return this.payload.dirty}},{key:"errorDecrypting",get:function(){return this.payload.errorDecrypting}},{key:"waitingForKey",get:function(){return this.payload.waitingForKey}},{key:"errorDecryptingValueChanged",get:function(){return this.payload.errorDecryptingValueChanged}},{key:"lastSyncBegan",get:function(){return this.payload.lastSyncBegan}},{key:"lastSyncEnd",get:function(){return this.payload.lastSyncEnd}},{key:"auth_hash",get:function(){return this.payload.auth_hash}},{key:"auth_params",get:function(){return this.payload.auth_params}},{key:"neverSynced",get:function(){return!this.updated_at||0===this.updated_at.getTime()}},{key:"isSingleton",get:function(){return!1}},{key:"singletonPredicate",get:function(){throw"Must override SNItem.singletonPredicate"}},{key:"singletonStrategy",get:function(){return i.KeepEarliest}}],[{key:"DefaultAppDomain",value:function(){return f.b}}]),t}();d(v,"sharedDateFormatter",void 0);var b=function(){function e(t,n){p(this,e),d(this,"item",void 0),d(this,"type",void 0),d(this,"payload",void 0),d(this,"content",void 0),this.item=t,this.type=n,this.payload=t.payload,this.payload.content&&(this.content=Object(u.a)(this.payload.content))}return y(e,[{key:"getUuid",value:function(){return this.payload.uuid}},{key:"getItem",value:function(){return this.item}},{key:"getResult",value:function(){if(this.type===r.NonDirtying)return Object(c.b)(this.payload,{content:this.content});this.payload.deleted||(this.type===r.UserInteraction?this.userModifiedDate=new Date:this.item.userModifiedDate||(this.userModifiedDate=new Date(this.item.updated_at)));return Object(c.b)(this.payload,{content:this.content,dirty:!0,dirtiedDate:new Date})}},{key:"mergePayload",value:function(e){this.payload=Object(c.g)(this.payload,e),this.payload.content?this.content=Object(u.a)(this.payload.safeContent):this.content=void 0}},{key:"setContent",value:function(e){this.content=Object(u.a)(e)}},{key:"setDeleted",value:function(){this.content=void 0,this.payload=Object(c.b)(this.payload,{content:this.content,deleted:!0})}},{key:"setDomainData",value:function(e,t){this.payload.errorDecrypting||(this.content.appData||(this.content.appData={}),this.content.appData[t]=e)}},{key:"setDomainDataKey",value:function(e,t,n){if(!this.payload.errorDecrypting){this.content.appData||(this.content.appData={});var r=this.content.appData;r[n]||(r[n]={}),r[n][e]=t}}},{key:"setAppDataItem",value:function(e,t){this.setDomainDataKey(e,t,v.DefaultAppDomain())}},{key:"addItemAsRelationship",value:function(e){var t=this.content.references||[];t.find((function(t){return t.uuid===e.uuid}))||t.push({uuid:e.uuid,content_type:e.content_type}),this.content.references=t}},{key:"removeItemAsRelationship",value:function(e){var t=this.content.references||[];t=t.filter((function(t){return t.uuid!==e.uuid})),this.content.references=t}},{key:"lastSyncBegan",set:function(e){this.payload=Object(c.b)(this.payload,{content:this.content,lastSyncBegan:e})}},{key:"errorDecrypting",set:function(e){this.payload=Object(c.b)(this.payload,{content:this.content,errorDecrypting:e})}},{key:"updated_at",set:function(e){this.payload=Object(c.b)(this.payload,{updated_at:e})}},{key:"userModifiedDate",set:function(e){this.setAppDataItem(a.UserModifiedDate,e)}},{key:"conflictOf",set:function(e){this.content.conflict_of=e}},{key:"protected",set:function(e){this.content.protected=e}},{key:"trashed",set:function(e){this.content.trashed=e}},{key:"pinned",set:function(e){this.setAppDataItem(a.Pinned,e)}},{key:"archived",set:function(e){this.setAppDataItem(a.Archived,e)}},{key:"locked",set:function(e){this.setAppDataItem(a.Locked,e)}}]),e}();function m(e,t,n){return n||(n=[]),!g(e.content,t.content,e.contentKeysToIgnoreWhenCheckingEquality().concat(n),e.appDataContentKeysToIgnoreWhenCheckingEquality())}function g(e,t,n,r){if((e=Object(u.F)(e)).appData){var a=e.appData[f.b];Object(u.z)(a,r),a?0===Object.keys(a).length&&delete e.appData:delete e.appData}if(Object(u.z)(e,n),(t=Object(u.F)(t)).appData){var i=t.appData[f.b];Object(u.z)(i,r),i?0===Object.keys(i).length&&delete t.appData:delete t.appData}return Object(u.z)(t,n),JSON.stringify(e)===JSON.stringify(t)}}).call(this,n(77).setImmediate)},function(e,t,n){"use strict";var r;function a(e,t){return Number(e)-Number(t)}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),function(e){e.V000Base64Decrypted="000",e.V001="001",e.V002="002",e.V003="003",e.V004="004",e[e.VersionLength=3]="VersionLength"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.FullSyncCompleted="sync =full-completed",e.SingleSyncCompleted="sync =single-completed",e.SyncWillBegin="sync =will-begin",e.DownloadFirstSyncCompleted="sync =download-first-completed",e.SyncTakingTooLong="sync =taking-too-long",e.SyncError="sync =error",e.InvalidSession="sync =invalid-session",e.MajorDataChange="major-data-change",e.LocalDataIncrementalLoad="local-data-incremental-load",e.LocalDataLoaded="local-data-loaded",e.EnterOutOfSync="enter-out-of-sync",e.ExitOutOfSync="exit-out-of-sync",e.StatusChanged="status-changed",e.DatabaseWriteError="database-write-error",e.DatabaseReadError="database-read-error"}(r||(r={}))},function(e,t,n){"use strict";var r;function a(e){return e===r.LocalStorageEncrypted||e===r.LocalStorageDecrypted||e===r.LocalStoragePreferEncrypted}function i(e){return e===r.FileEncrypted||e===r.FileDecrypted||e===r.FilePreferEncrypted}function o(e){return e===r.SyncDecrypted||e===r.LocalStorageDecrypted||e===r.FileDecrypted}function s(e){return e===r.Sync||e===r.LocalStorageEncrypted||e===r.FileEncrypted}n.d(t,"a",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"d",(function(){return i})),n.d(t,"c",(function(){return o})),n.d(t,"b",(function(){return s})),function(e){e[e.Sync=0]="Sync",e[e.SyncDecrypted=1]="SyncDecrypted",e[e.LocalStorageEncrypted=2]="LocalStorageEncrypted",e[e.LocalStorageDecrypted=3]="LocalStorageDecrypted",e[e.LocalStoragePreferEncrypted=4]="LocalStoragePreferEncrypted",e[e.FileEncrypted=5]="FileEncrypted",e[e.FileDecrypted=6]="FileDecrypted",e[e.FilePreferEncrypted=7]="FilePreferEncrypted"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e[e.EncryptedString=0]="EncryptedString",e[e.DecryptedBareObject=1]="DecryptedBareObject",e[e.DecryptedBase64String=2]="DecryptedBase64String",e[e.Deleted=3]="Deleted"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return i}));var r=n(4);function a(e){return e.map((function(e){return e.uuid}))}function i(e){return e.references||(e.references=[]),e.appData||(e.appData={}),e.appData[r.b]||(e.appData[r.b]={}),e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var r=n(0),a=n.n(r),i=n(1);function o(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function s(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){s(i,r,a,o,c,"next",e)}function c(e){s(i,r,a,o,c,"throw",e)}o(void 0)}))}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"eventObservers",[]),l(this,"loggingEnabled",!1),l(this,"deviceInterface",void 0),l(this,"criticalPromises",[])}var t,n,r,s,f,p,h;return t=e,(n=[{key:"addEventObserver",value:function(e){var t=this;return this.eventObservers.push(e),function(){Object(i.B)(t.eventObservers,e)}}},{key:"notifyEvent",value:(h=c(a.a.mark((function e(t,n){var r,i,o,s,c,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,i=!1,o=void 0,e.prev=3,s=this.eventObservers[Symbol.iterator]();case 5:if(r=(c=s.next()).done){e.next=12;break}return u=c.value,e.next=9,u(t,n||{});case 9:r=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),i=!0,o=e.t0;case 18:e.prev=18,e.prev=19,r||null==s.return||s.return();case 21:if(e.prev=21,!i){e.next=24;break}throw o;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e,t){return h.apply(this,arguments)})},{key:"blockDeinit",value:(p=c(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(this.criticalPromises);case 2:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"deinit",value:function(){this.eventObservers.length=0,this.deviceInterface=void 0}},{key:"executeCriticalFunction",value:(f=c(a.a.mark((function e(t){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t(),this.criticalPromises.push(n),e.abrupt("return",n);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"handleApplicationStage",value:(s=c(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(e){return s.apply(this,arguments)})},{key:"log",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(this.loggingEnabled){var a,i=new Date,s=i.toLocaleTimeString().replace(" PM","").replace(" AM",""),c="".concat(s,".").concat(i.getMilliseconds());n?(n=n.map((function(e){return Array.isArray(e)?e.slice():e})),(a=console).log.apply(a,[c,e].concat(o(n)))):console.log(c,e)}}}])&&u(t.prototype,n),r&&u(t,r),e}()},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return o}));var r,a=n(8);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e){var t;return(t={},i(t,a.a.FullSyncCompleted,r.CompletedFullSync),i(t,a.a.SingleSyncCompleted,r.CompletedIncrementalSync),i(t,a.a.SyncError,r.FailedSync),i(t,a.a.SyncTakingTooLong,r.HighLatencySync),i(t,a.a.EnterOutOfSync,r.EnteredOutOfSync),i(t,a.a.ExitOutOfSync,r.ExitedOutOfSync),i(t,a.a.LocalDataLoaded,r.LocalDataLoaded),i(t,a.a.MajorDataChange,r.MajorDataChange),i(t,a.a.LocalDataIncrementalLoad,r.LocalDataIncrementalLoad),i(t,a.a.StatusChanged,r.SyncStatusChanged),i(t,a.a.SyncWillBegin,r.WillSync),i(t,a.a.InvalidSession,r.InvalidSyncSession),i(t,a.a.DatabaseReadError,r.LocalDatabaseReadError),i(t,a.a.DatabaseWriteError,r.LocalDatabaseWriteError),t)[e]}n.d(t,"b",(function(){return a.a})),function(e){e[e.SignedIn=2]="SignedIn",e[e.SignedOut=3]="SignedOut",e[e.CompletedFullSync=5]="CompletedFullSync",e[e.FailedSync=6]="FailedSync",e[e.HighLatencySync=7]="HighLatencySync",e[e.EnteredOutOfSync=8]="EnteredOutOfSync",e[e.ExitedOutOfSync=9]="ExitedOutOfSync",e[e.Started=10]="Started",e[e.Launched=11]="Launched",e[e.LocalDataLoaded=12]="LocalDataLoaded",e[e.KeyStatusChanged=13]="KeyStatusChanged",e[e.MajorDataChange=14]="MajorDataChange",e[e.CompletedRestart=15]="CompletedRestart",e[e.LocalDataIncrementalLoad=16]="LocalDataIncrementalLoad",e[e.SyncStatusChanged=17]="SyncStatusChanged",e[e.WillSync=18]="WillSync",e[e.InvalidSyncSession=19]="InvalidSyncSession",e[e.LocalDatabaseReadError=20]="LocalDatabaseReadError",e[e.LocalDatabaseWriteError=21]="LocalDatabaseWriteError",e[e.CompletedIncrementalSync=22]="CompletedIncrementalSync"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e[e.KeepLeft=1]="KeepLeft",e[e.KeepRight=2]="KeepRight",e[e.KeepLeftDuplicateRight=3]="KeepLeftDuplicateRight",e[e.DuplicateLeftKeepRight=4]="DuplicateLeftKeepRight",e[e.KeepLeftMergeRefs=5]="KeepLeftMergeRefs"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(1);function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i(this,"keypath",void 0),i(this,"operator",void 0),i(this,"value",void 0),this.keypath=t,this.operator=n,this.value=r,this.isRecursive()){var a=this.value;this.value=a.map((function(t){return Array.isArray(t)?e.FromArray(t):t}))}else"true"!==this.value&&"false"!==this.value||(this.value=JSON.parse(this.value))}var t,n,o;return t=e,o=[{key:"FromJson",value:function(t){return new e(t.keypath,t.operator,t.value)}},{key:"FromArray",value:function(t){return new e(t[0],t[1],t[2])}},{key:"CompoundPredicate",value:function(t){return new e("ignored","and",t)}},{key:"ObjectSatisfiesPredicate",value:function(e,t){if(Array.isArray(t)&&(t=this.FromArray(t)),t.isRecursive()){if("and"===t.operator){var n=!0,r=!1,a=void 0;try{for(var i,o=t.valueAsArray()[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;if(!this.ObjectSatisfiesPredicate(e,s))return!1}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}return!0}if("or"===t.operator){var c=!0,u=!1,l=void 0;try{for(var f,p=t.valueAsArray()[Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var h=f.value;if(this.ObjectSatisfiesPredicate(e,h))return!0}}catch(e){u=!0,l=e}finally{try{c||null==p.return||p.return()}finally{if(u)throw l}}return!1}}var y=t.value;"string"==typeof y&&y.includes(".ago")&&(y=this.DateFromString(y));var d=t.keypath.split(".").reduce((function(e,t){return e&&e[t]}),e),v=[!1,"",null,void 0,NaN];return void 0===d?"!="===t.operator?!v.includes(t.value):v.includes(t.value):"="===t.operator?Array.isArray(d)?JSON.stringify(d)===JSON.stringify(y):d===y:"!="===t.operator?Array.isArray(d)?JSON.stringify(d)!==JSON.stringify(y):d!==y:"<"===t.operator?d<y:">"===t.operator?d>y:"<="===t.operator?d<=y:">="===t.operator?d>=y:"startsWith"===t.operator?d.startsWith(y):"in"===t.operator?-1!==y.indexOf(d):"includes"===t.operator?this.resolveIncludesPredicate(d,y):"matches"===t.operator&&new RegExp(y).test(d)}},{key:"resolveIncludesPredicate",value:function(t,n){if(Object(r.s)(n))return t.includes(n);var a;a=Array.isArray(n)?e.FromArray(n):n;var i=!0,o=!1,s=void 0;try{for(var c,u=t[Symbol.iterator]();!(i=(c=u.next()).done);i=!0){var l=c.value;if(this.ObjectSatisfiesPredicate(l,a))return!0}}catch(e){o=!0,s=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw s}}return!1}},{key:"ItemSatisfiesPredicate",value:function(t,n){return Array.isArray(n)&&(n=e.FromArray(n)),this.ObjectSatisfiesPredicate(t,n)}},{key:"ItemSatisfiesPredicates",value:function(e,t){var n=!0,r=!1,a=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;if(!this.ItemSatisfiesPredicate(e,s))return!1}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}return!0}},{key:"DateFromString",value:function(e){var t=e.split("."),n=t[1],r=new Date,a=parseInt(t[0]);return"days"===n?r.setDate(r.getDate()-a):"hours"===n&&r.setHours(r.getHours()-a),r}}],(n=[{key:"isRecursive",value:function(){return["and","or"].includes(this.operator)}},{key:"arrayRepresentation",value:function(){return[this.keypath,this.operator,this.value]}},{key:"valueAsArray",value:function(){return this.value}}])&&a(t.prototype,n),o&&a(t,o),e}()},function(e,t){var n=Array.isArray;e.exports=n},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(56),i="object"==("undefined"==typeof self?"undefined":r(self))&&self&&self.Object===Object&&self,o=a||i||Function("return this")();e.exports=o},function(e,t,n){var r=n(157)(n(158));e.exports=r},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=n(e);return null!=e&&("object"==t||"function"==t)}},function(e,t,n){var r=n(39),a=n(152);e.exports=function(e,t){var n=[];if(!e||!e.length)return n;var i=-1,o=[],s=e.length;for(t=r(t,3);++i<s;){var c=e[i];t(c,i,e)&&(n.push(c),o.push(i))}return a(e,o),n}},function(e,t,n){var r=n(94),a=n(99);e.exports=function(e,t){var n=a(e,t);return r(n)?n:void 0}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){return null!=e&&"object"==n(e)}},function(e,t,n){var r=n(76);e.exports=function(e){return e&&e.length?r(e):[]}},function(e,t,n){var r=n(33),a=n(95),i=n(96),o=r?r.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":o&&o in Object(e)?a(e):i(e)}},function(e,t){e.exports=function(e,t){return e===t||e!=e&&t!=t}},function(e,t,n){var r=n(42),a=n(49);e.exports=function(e){return null!=e&&a(e.length)&&!r(e)}},function(e,t,n){var r=n(37);e.exports=function(e){if("string"==typeof e||r(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var r=n(11),a=n(5),i=n(3),o=n(7),s=n(1),c=n(10);function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){function e(t,n,u){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"fields",void 0),l(this,"source",void 0),l(this,"uuid",void 0),l(this,"content_type",void 0),l(this,"content",void 0),l(this,"deleted",void 0),l(this,"items_key_id",void 0),l(this,"enc_item_key",void 0),l(this,"created_at",void 0),l(this,"updated_at",void 0),l(this,"dirtiedDate",void 0),l(this,"dirty",void 0),l(this,"errorDecrypting",void 0),l(this,"waitingForKey",void 0),l(this,"errorDecryptingValueChanged",void 0),l(this,"lastSyncBegan",void 0),l(this,"lastSyncEnd",void 0),l(this,"auth_hash",void 0),l(this,"auth_params",void 0),l(this,"format",void 0),l(this,"version",void 0),this.fields=n||Object.keys(t),this.source=u||i.a.Constructor,this.uuid=t.uuid,!this.uuid&&this.fields.includes(a.a.Uuid))throw Error("uuid is null, yet this payloads fields indicate it shouldnt be.");this.content_type=t.content_type,t.content&&(Object(s.q)(t.content)?this.content=Object(r.a)(t.content):this.content=t.content),this.deleted=t.deleted,this.items_key_id=t.items_key_id,this.enc_item_key=t.enc_item_key,this.created_at=new Date(t.created_at||new Date),this.updated_at=new Date(t.updated_at||new Date(0)),this.dirtiedDate=new Date(t.dirtiedDate),this.dirty=t.dirty,this.errorDecrypting=t.errorDecrypting,this.waitingForKey=t.waitingForKey,this.errorDecryptingValueChanged=t.errorDecryptingValueChanged,this.lastSyncBegan=t.lastSyncBegan?new Date(t.lastSyncBegan):void 0,this.lastSyncEnd=t.lastSyncEnd?new Date(t.lastSyncEnd):void 0,this.auth_hash=t.auth_hash,this.auth_params=t.auth_params,Object(s.s)(this.content)?this.content.startsWith(o.a.V000Base64Decrypted)?this.format=c.a.DecryptedBase64String:this.format=c.a.EncryptedString:Object(s.q)(this.content)?this.format=c.a.DecryptedBareObject:this.format=c.a.Deleted,Object(s.s)(this.content)?this.version=this.content.substring(0,o.a.VersionLength):this.content&&(this.version=this.content.version),Object(s.g)(this)}var t,n,f;return t=e,(n=[{key:"ejected",value:function(){var e=[a.a.Legacy003AuthHash,a.a.Deleted],t=[a.a.DirtiedDate,a.a.ErrorDecrypting,a.a.ErrorDecryptingChanged,a.a.WaitingForKey,a.a.LastSyncBegan,a.a.LastSyncEnd],n={},r=!0,i=!1,o=void 0;try{for(var c,u=this.fields[Symbol.iterator]();!(r=(c=u.next()).done);r=!0){var l=c.value;if(!t.includes(l)){var f=this[l];Object(s.p)(f)&&e.includes(l)||(n[l]=f)}}}catch(e){i=!0,o=e}finally{try{r||null==u.return||u.return()}finally{if(i)throw o}}return n}},{key:"safeContent",get:function(){return this.format===c.a.DecryptedBareObject?this.content:{}}},{key:"references",get:function(){return this.safeReferences}},{key:"safeReferences",get:function(){return this.safeContent.references||[]}},{key:"contentObject",get:function(){if(this.format!==c.a.DecryptedBareObject)throw Error("Attempting to access non-object content as object");return this.content}},{key:"contentString",get:function(){if(this.format===c.a.DecryptedBareObject)throw Error("Attempting to access non-string content as string");return this.content}},{key:"discardable",get:function(){return this.deleted&&!this.dirty}}])&&u(t.prototype,n),f&&u(t,f),e}()},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":n(window))&&(r=window)}e.exports=r},function(e,t,n){var r=n(84),a=n(85),i=n(86),o=n(87),s=n(88);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=i,c.prototype.has=o,c.prototype.set=s,e.exports=c},function(e,t,n){var r=n(25);e.exports=function(e,t){for(var n=e.length;n--;)if(r(e[n][0],t))return n;return-1}},function(e,t,n){var r=n(17).Symbol;e.exports=r},function(e,t,n){var r=n(21)(Object,"create");e.exports=r},function(e,t,n){var r=n(108);e.exports=function(e,t){var n=e.__data__;return r(t)?n["string"==typeof t?"string":"hash"]:n.map}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r=/^(?:0|[1-9]\d*)$/;e.exports=function(e,t){var a=n(e);return!!(t=null==t?9007199254740991:t)&&("number"==a||"symbol"!=a&&r.test(e))&&e>-1&&e%1==0&&e<t}},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(24),i=n(22);e.exports=function(e){return"symbol"==r(e)||i(e)&&"[object Symbol]"==a(e)}},function(e,t,n){var r=n(69),a=n(75)((function(e,t,n){r(e,t,n)}));e.exports=a},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(82),i=n(138),o=n(54),s=n(16),c=n(149);e.exports=function(e){return"function"==typeof e?e:null==e?o:"object"==r(e)?s(e)?i(e[0],e[1]):a(e):c(e)}},function(e,t,n){var r=n(31),a=n(89),i=n(90),o=n(91),s=n(92),c=n(93);function u(e){var t=this.__data__=new r(e);this.size=t.size}u.prototype.clear=a,u.prototype.delete=i,u.prototype.get=o,u.prototype.has=s,u.prototype.set=c,e.exports=u},function(e,t,n){var r=n(21)(n(17),"Map");e.exports=r},function(e,t,n){var r=n(24),a=n(19);e.exports=function(e){if(!a(e))return!1;var t=r(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},function(e,t,n){var r=n(100),a=n(107),i=n(109),o=n(110),s=n(111);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=i,c.prototype.has=o,c.prototype.set=s,e.exports=c},function(e,t){e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}},function(e,t,n){var r=n(63),a=n(131),i=n(26);e.exports=function(e){return i(e)?r(e):a(e)}},function(e,t,n){var r=n(126),a=n(22),i=Object.prototype,o=i.hasOwnProperty,s=i.propertyIsEnumerable,c=r(function(){return arguments}())?r:function(e){return a(e)&&o.call(e,"callee")&&!s.call(e,"callee")};e.exports=c},function(e,t,n){(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(17),i=n(127),o="object"==r(t)&&t&&!t.nodeType&&t,s=o&&"object"==r(e)&&e&&!e.nodeType&&e,c=s&&s.exports===o?a.Buffer:void 0,u=(c?c.isBuffer:void 0)||i;e.exports=u}).call(this,n(29)(e))},function(e,t,n){var r=n(128),a=n(129),i=n(130),o=i&&i.isTypedArray,s=o?a(o):r;e.exports=s},function(e,t){e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},function(e,t){var n=Object.prototype;e.exports=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||n)}},function(e,t,n){var r=n(52),a=n(27);e.exports=function(e,t){for(var n=0,i=(t=r(t,e)).length;null!=e&&n<i;)e=e[a(t[n++])];return n&&n==i?e:void 0}},function(e,t,n){var r=n(16),a=n(53),i=n(140),o=n(143);e.exports=function(e,t){return r(e)?e:a(e,t)?[e]:i(o(e))}},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(16),i=n(37),o=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,s=/^\w*$/;e.exports=function(e,t){if(a(e))return!1;var n=r(e);return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!i(e))||(s.test(e)||!o.test(e)||null!=t&&e in Object(t))}},function(e,t){e.exports=function(e){return e}},function(e,t,n){var r=n(71);e.exports=function(e,t,n){"__proto__"==t&&r?r(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}},function(e,t,n){(function(t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r="object"==(void 0===t?"undefined":n(t))&&t&&t.Object===Object&&t;e.exports=r}).call(this,n(30))},function(e,t){var n=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return n.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},function(e,t,n){var r=n(112),a=n(22);e.exports=function e(t,n,i,o,s){return t===n||(null==t||null==n||!a(t)&&!a(n)?t!=t&&n!=n:r(t,n,i,o,e,s))}},function(e,t,n){var r=n(60),a=n(115),i=n(61);e.exports=function(e,t,n,o,s,c){var u=1&n,l=e.length,f=t.length;if(l!=f&&!(u&&f>l))return!1;var p=c.get(e);if(p&&c.get(t))return p==t;var h=-1,y=!0,d=2&n?new r:void 0;for(c.set(e,t),c.set(t,e);++h<l;){var v=e[h],b=t[h];if(o)var m=u?o(b,v,h,t,e,c):o(v,b,h,e,t,c);if(void 0!==m){if(m)continue;y=!1;break}if(d){if(!a(t,(function(e,t){if(!i(d,t)&&(v===e||s(v,e,n,o,c)))return d.push(t)}))){y=!1;break}}else if(v!==b&&!s(v,b,n,o,c)){y=!1;break}}return c.delete(e),c.delete(t),y}},function(e,t,n){var r=n(43),a=n(113),i=n(114);function o(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new r;++t<n;)this.add(e[t])}o.prototype.add=o.prototype.push=a,o.prototype.has=i,e.exports=o},function(e,t){e.exports=function(e,t){return e.has(t)}},function(e,t,n){var r=n(17).Uint8Array;e.exports=r},function(e,t,n){var r=n(125),a=n(46),i=n(16),o=n(47),s=n(36),c=n(48),u=Object.prototype.hasOwnProperty;e.exports=function(e,t){var n=i(e),l=!n&&a(e),f=!n&&!l&&o(e),p=!n&&!l&&!f&&c(e),h=n||l||f||p,y=h?r(e.length,String):[],d=y.length;for(var v in e)!t&&!u.call(e,v)||h&&("length"==v||f&&("offset"==v||"parent"==v)||p&&("buffer"==v||"byteLength"==v||"byteOffset"==v)||s(v,d))||y.push(v);return y}},function(e,t){e.exports=function(e,t){return function(n){return e(t(n))}}},function(e,t,n){var r=n(21)(n(17),"Set");e.exports=r},function(e,t,n){var r=n(19);e.exports=function(e){return e==e&&!r(e)}},function(e,t){e.exports=function(e,t){return function(n){return null!=n&&(n[e]===t&&(void 0!==t||e in Object(n)))}}},function(e,t){e.exports=function(e,t,n,r){for(var a=e.length,i=n+(r?1:-1);r?i--:++i<a;)if(t(e[i],i,e))return i;return-1}},function(e,t,n){var r=n(40),a=n(70),i=n(162),o=n(164),s=n(19),c=n(74),u=n(73);e.exports=function e(t,n,l,f,p){t!==n&&i(n,(function(i,c){if(p||(p=new r),s(i))o(t,n,c,l,e,f,p);else{var h=f?f(u(t,c),i,c+"",t,n,p):void 0;void 0===h&&(h=i),a(t,c,h)}}),c)}},function(e,t,n){var r=n(55),a=n(25);e.exports=function(e,t,n){(void 0===n||a(e[t],n))&&(void 0!==n||t in e)||r(e,t,n)}},function(e,t,n){var r=n(21),a=function(){try{var e=r(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=a},function(e,t,n){var r=n(64)(Object.getPrototypeOf,Object);e.exports=r},function(e,t){e.exports=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}},function(e,t,n){var r=n(63),a=n(176),i=n(26);e.exports=function(e){return i(e)?r(e,!0):a(e)}},function(e,t,n){var r=n(178),a=n(185);e.exports=function(e){return r((function(t,n){var r=-1,i=n.length,o=i>1?n[i-1]:void 0,s=i>2?n[2]:void 0;for(o=e.length>3&&"function"==typeof o?(i--,o):void 0,s&&a(n[0],n[1],s)&&(o=i<3?void 0:o,i=1),t=Object(t);++r<i;){var c=n[r];c&&e(t,c,r,o)}return t}))}},function(e,t,n){var r=n(60),a=n(186),i=n(190),o=n(61),s=n(191),c=n(44);e.exports=function(e,t,n){var u=-1,l=a,f=e.length,p=!0,h=[],y=h;if(n)p=!1,l=i;else if(f>=200){var d=t?null:s(e);if(d)return c(d);p=!1,l=o,y=new r}else y=t?[]:h;e:for(;++u<f;){var v=e[u],b=t?t(v):v;if(v=n||0!==v?v:0,p&&b==b){for(var m=y.length;m--;)if(y[m]===b)continue e;t&&y.push(b),h.push(v)}else l(y,b,n)||(y!==h&&y.push(b),h.push(v))}return h}},function(e,t,n){(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,a=Function.prototype.apply;function i(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new i(a.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new i(a.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},i.prototype.unref=i.prototype.ref=function(){},i.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},n(193),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(30))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return v}));var r=n(0),a=n.n(r),i=n(12),o=n(13);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function u(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){c(i,r,a,o,s,"next",e)}function s(e){c(i,r,a,o,s,"throw",e)}o(void 0)}))}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t,n){return(p="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function y(e,t){return(y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(t){function n(t){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),r=function(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?f(e):t}(this,h(n).call(this)),d(f(r),"application",void 0),d(f(r),"unsubApp",void 0),r.application=t,e((function(){r.addAppEventObserver()})),r}var r,i,c,v,b,m;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&y(e,t)}(n,t),r=n,(i=[{key:"deinit",value:function(){this.application=void 0,this.unsubApp(),this.unsubApp=void 0,p(h(n.prototype),"deinit",this).call(this)}},{key:"addAppEventObserver",value:function(){var e=this;this.application.isStarted()&&this.onAppStart(),this.application.isLaunched()&&this.onAppLaunch(),this.unsubApp=this.application.addEventObserver(function(){var t=u(a.a.mark((function t(n){return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.onAppEvent(n),n!==o.a.Started){t.next=6;break}return t.next=4,e.onAppStart();case 4:t.next=12;break;case 6:if(n!==o.a.Launched){t.next=11;break}return t.next=9,e.onAppLaunch();case 9:t.next=12;break;case 11:n===o.a.CompletedFullSync?e.onAppFullSync():n===o.a.CompletedIncrementalSync?e.onAppIncrementalSync():n===o.a.KeyStatusChanged&&e.onAppKeyChange();case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"onAppEvent",value:function(e){}},{key:"onAppStart",value:(m=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return m.apply(this,arguments)})},{key:"onAppLaunch",value:(b=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return b.apply(this,arguments)})},{key:"onAppKeyChange",value:(v=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return v.apply(this,arguments)})},{key:"onAppIncrementalSync",value:function(){}},{key:"onAppFullSync",value:function(){}}])&&l(r.prototype,i),c&&l(r,c),n}(i.a)}).call(this,n(77).setImmediate)},function(e,t,n){var r=n(69),a=n(75)((function(e,t,n,a){r(e,t,n,a)}));e.exports=a},function(e,t,n){var r=n(76);e.exports=function(e,t){return t="function"==typeof t?t:void 0,e&&e.length?r(e,void 0,t):[]}},function(e,t,n){(function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n=function(e){"use strict";var n=Object.prototype,r=n.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",o=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function c(e,t,n,r){var a=t&&t.prototype instanceof f?t:f,i=Object.create(a.prototype),o=new S(r||[]);return i._invoke=function(e,t,n){var r="suspendedStart";return function(a,i){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===a)throw i;return P()}for(n.method=a,n.arg=i;;){var o=n.delegate;if(o){var s=w(o,n);if(s){if(s===l)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var c=u(e,t,n);if("normal"===c.type){if(r=n.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r="completed",n.method="throw",n.arg=c.arg)}}}(e,n,o),i}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function h(){}var y={};y[i]=function(){return this};var d=Object.getPrototypeOf,v=d&&d(d(O([])));v&&v!==n&&r.call(v,i)&&(y=v);var b=h.prototype=f.prototype=Object.create(y);function m(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function g(e,n){var a;this._invoke=function(i,o){function s(){return new n((function(a,s){!function a(i,o,s,c){var l=u(e[i],e,o);if("throw"!==l.type){var f=l.arg,p=f.value;return p&&"object"===t(p)&&r.call(p,"__await")?n.resolve(p.__await).then((function(e){a("next",e,s,c)}),(function(e){a("throw",e,s,c)})):n.resolve(p).then((function(e){f.value=e,s(f)}),(function(e){return a("throw",e,s,c)}))}c(l.arg)}(i,o,a,s)}))}return a=a?a.then(s,s):s()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=u(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var a=r.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:P}}function P(){return{value:void 0,done:!0}}return p.prototype=b.constructor=h,h.constructor=p,h[s]=p.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},m(g.prototype),g.prototype[o]=function(){return this},e.AsyncIterator=g,e.async=function(t,n,r,a,i){void 0===i&&(i=Promise);var o=new g(c(t,n,r,a),i);return e.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},m(b),b[s]="Generator",b[i]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=O,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return o.type="throw",o.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var s=r.call(i,"catchLoc"),c=r.call(i,"finallyLoc");if(s&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,l):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),x(n),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;x(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:O(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},e}("object"===t(e)?e.exports:{});try{regeneratorRuntime=n}catch(e){Function("r","regeneratorRuntime = r")(n)}}).call(this,n(29)(e))},function(e,t,n){var r=n(83),a=n(137),i=n(67);e.exports=function(e){var t=a(e);return 1==t.length&&t[0][2]?i(t[0][0],t[0][1]):function(n){return n===e||r(n,e,t)}}},function(e,t,n){var r=n(40),a=n(58);e.exports=function(e,t,n,i){var o=n.length,s=o,c=!i;if(null==e)return!s;for(e=Object(e);o--;){var u=n[o];if(c&&u[2]?u[1]!==e[u[0]]:!(u[0]in e))return!1}for(;++o<s;){var l=(u=n[o])[0],f=e[l],p=u[1];if(c&&u[2]){if(void 0===f&&!(l in e))return!1}else{var h=new r;if(i)var y=i(f,p,l,e,t,h);if(!(void 0===y?a(p,f,3,i,h):y))return!1}}return!0}},function(e,t){e.exports=function(){this.__data__=[],this.size=0}},function(e,t,n){var r=n(32),a=Array.prototype.splice;e.exports=function(e){var t=this.__data__,n=r(t,e);return!(n<0)&&(n==t.length-1?t.pop():a.call(t,n,1),--this.size,!0)}},function(e,t,n){var r=n(32);e.exports=function(e){var t=this.__data__,n=r(t,e);return n<0?void 0:t[n][1]}},function(e,t,n){var r=n(32);e.exports=function(e){return r(this.__data__,e)>-1}},function(e,t,n){var r=n(32);e.exports=function(e,t){var n=this.__data__,a=r(n,e);return a<0?(++this.size,n.push([e,t])):n[a][1]=t,this}},function(e,t,n){var r=n(31);e.exports=function(){this.__data__=new r,this.size=0}},function(e,t){e.exports=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}},function(e,t){e.exports=function(e){return this.__data__.get(e)}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t,n){var r=n(31),a=n(41),i=n(43);e.exports=function(e,t){var n=this.__data__;if(n instanceof r){var o=n.__data__;if(!a||o.length<199)return o.push([e,t]),this.size=++n.size,this;n=this.__data__=new i(o)}return n.set(e,t),this.size=n.size,this}},function(e,t,n){var r=n(42),a=n(97),i=n(19),o=n(57),s=/^\[object .+?Constructor\]$/,c=Function.prototype,u=Object.prototype,l=c.toString,f=u.hasOwnProperty,p=RegExp("^"+l.call(f).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!i(e)||a(e))&&(r(e)?p:s).test(o(e))}},function(e,t,n){var r=n(33),a=Object.prototype,i=a.hasOwnProperty,o=a.toString,s=r?r.toStringTag:void 0;e.exports=function(e){var t=i.call(e,s),n=e[s];try{e[s]=void 0;var r=!0}catch(e){}var a=o.call(e);return r&&(t?e[s]=n:delete e[s]),a}},function(e,t){var n=Object.prototype.toString;e.exports=function(e){return n.call(e)}},function(e,t,n){var r,a=n(98),i=(r=/[^.]+$/.exec(a&&a.keys&&a.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"";e.exports=function(e){return!!i&&i in e}},function(e,t,n){var r=n(17)["__core-js_shared__"];e.exports=r},function(e,t){e.exports=function(e,t){return null==e?void 0:e[t]}},function(e,t,n){var r=n(101),a=n(31),i=n(41);e.exports=function(){this.size=0,this.__data__={hash:new r,map:new(i||a),string:new r}}},function(e,t,n){var r=n(102),a=n(103),i=n(104),o=n(105),s=n(106);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=i,c.prototype.has=o,c.prototype.set=s,e.exports=c},function(e,t,n){var r=n(34);e.exports=function(){this.__data__=r?r(null):{},this.size=0}},function(e,t){e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},function(e,t,n){var r=n(34),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(r){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return a.call(t,e)?t[e]:void 0}},function(e,t,n){var r=n(34),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return r?void 0!==t[e]:a.call(t,e)}},function(e,t,n){var r=n(34);e.exports=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=r&&void 0===t?"__lodash_hash_undefined__":t,this}},function(e,t,n){var r=n(35);e.exports=function(e){var t=r(this,e).delete(e);return this.size-=t?1:0,t}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=n(e);return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},function(e,t,n){var r=n(35);e.exports=function(e){return r(this,e).get(e)}},function(e,t,n){var r=n(35);e.exports=function(e){return r(this,e).has(e)}},function(e,t,n){var r=n(35);e.exports=function(e,t){var n=r(this,e),a=n.size;return n.set(e,t),this.size+=n.size==a?0:1,this}},function(e,t,n){var r=n(40),a=n(59),i=n(116),o=n(118),s=n(133),c=n(16),u=n(47),l=n(48),f="[object Object]",p=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,h,y,d){var v=c(e),b=c(t),m=v?"[object Array]":s(e),g=b?"[object Array]":s(t),w=(m="[object Arguments]"==m?f:m)==f,k=(g="[object Arguments]"==g?f:g)==f,x=m==g;if(x&&u(e)){if(!u(t))return!1;v=!0,w=!1}if(x&&!w)return d||(d=new r),v||l(e)?a(e,t,n,h,y,d):i(e,t,m,n,h,y,d);if(!(1&n)){var S=w&&p.call(e,"__wrapped__"),O=k&&p.call(t,"__wrapped__");if(S||O){var P=S?e.value():e,j=O?t.value():t;return d||(d=new r),y(P,j,n,h,d)}}return!!x&&(d||(d=new r),o(e,t,n,h,y,d))}},function(e,t){e.exports=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t){e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}},function(e,t,n){var r=n(33),a=n(62),i=n(25),o=n(59),s=n(117),c=n(44),u=r?r.prototype:void 0,l=u?u.valueOf:void 0;e.exports=function(e,t,n,r,u,f,p){switch(n){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!f(new a(e),new a(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return i(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var h=s;case"[object Set]":var y=1&r;if(h||(h=c),e.size!=t.size&&!y)return!1;var d=p.get(e);if(d)return d==t;r|=2,p.set(e,t);var v=o(h(e),h(t),r,u,f,p);return p.delete(e),v;case"[object Symbol]":if(l)return l.call(e)==l.call(t)}return!1}},function(e,t){e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}},function(e,t,n){var r=n(119),a=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,i,o,s){var c=1&n,u=r(e),l=u.length;if(l!=r(t).length&&!c)return!1;for(var f=l;f--;){var p=u[f];if(!(c?p in t:a.call(t,p)))return!1}var h=s.get(e);if(h&&s.get(t))return h==t;var y=!0;s.set(e,t),s.set(t,e);for(var d=c;++f<l;){var v=e[p=u[f]],b=t[p];if(i)var m=c?i(b,v,p,t,e,s):i(v,b,p,e,t,s);if(!(void 0===m?v===b||o(v,b,n,i,s):m)){y=!1;break}d||(d="constructor"==p)}if(y&&!d){var g=e.constructor,w=t.constructor;g!=w&&"constructor"in e&&"constructor"in t&&!("function"==typeof g&&g instanceof g&&"function"==typeof w&&w instanceof w)&&(y=!1)}return s.delete(e),s.delete(t),y}},function(e,t,n){var r=n(120),a=n(122),i=n(45);e.exports=function(e){return r(e,i,a)}},function(e,t,n){var r=n(121),a=n(16);e.exports=function(e,t,n){var i=t(e);return a(e)?i:r(i,n(e))}},function(e,t){e.exports=function(e,t){for(var n=-1,r=t.length,a=e.length;++n<r;)e[a+n]=t[n];return e}},function(e,t,n){var r=n(123),a=n(124),i=Object.prototype.propertyIsEnumerable,o=Object.getOwnPropertySymbols,s=o?function(e){return null==e?[]:(e=Object(e),r(o(e),(function(t){return i.call(e,t)})))}:a;e.exports=s},function(e,t){e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length,a=0,i=[];++n<r;){var o=e[n];t(o,n,e)&&(i[a++]=o)}return i}},function(e,t){e.exports=function(){return[]}},function(e,t){e.exports=function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}},function(e,t,n){var r=n(24),a=n(22);e.exports=function(e){return a(e)&&"[object Arguments]"==r(e)}},function(e,t){e.exports=function(){return!1}},function(e,t,n){var r=n(24),a=n(49),i=n(22),o={};o["[object Float32Array]"]=o["[object Float64Array]"]=o["[object Int8Array]"]=o["[object Int16Array]"]=o["[object Int32Array]"]=o["[object Uint8Array]"]=o["[object Uint8ClampedArray]"]=o["[object Uint16Array]"]=o["[object Uint32Array]"]=!0,o["[object Arguments]"]=o["[object Array]"]=o["[object ArrayBuffer]"]=o["[object Boolean]"]=o["[object DataView]"]=o["[object Date]"]=o["[object Error]"]=o["[object Function]"]=o["[object Map]"]=o["[object Number]"]=o["[object Object]"]=o["[object RegExp]"]=o["[object Set]"]=o["[object String]"]=o["[object WeakMap]"]=!1,e.exports=function(e){return i(e)&&a(e.length)&&!!o[r(e)]}},function(e,t){e.exports=function(e){return function(t){return e(t)}}},function(e,t,n){(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(56),i="object"==r(t)&&t&&!t.nodeType&&t,o=i&&"object"==r(e)&&e&&!e.nodeType&&e,s=o&&o.exports===i&&a.process,c=function(){try{var e=o&&o.require&&o.require("util").types;return e||s&&s.binding&&s.binding("util")}catch(e){}}();e.exports=c}).call(this,n(29)(e))},function(e,t,n){var r=n(50),a=n(132),i=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return a(e);var t=[];for(var n in Object(e))i.call(e,n)&&"constructor"!=n&&t.push(n);return t}},function(e,t,n){var r=n(64)(Object.keys,Object);e.exports=r},function(e,t,n){var r=n(134),a=n(41),i=n(135),o=n(65),s=n(136),c=n(24),u=n(57),l=u(r),f=u(a),p=u(i),h=u(o),y=u(s),d=c;(r&&"[object DataView]"!=d(new r(new ArrayBuffer(1)))||a&&"[object Map]"!=d(new a)||i&&"[object Promise]"!=d(i.resolve())||o&&"[object Set]"!=d(new o)||s&&"[object WeakMap]"!=d(new s))&&(d=function(e){var t=c(e),n="[object Object]"==t?e.constructor:void 0,r=n?u(n):"";if(r)switch(r){case l:return"[object DataView]";case f:return"[object Map]";case p:return"[object Promise]";case h:return"[object Set]";case y:return"[object WeakMap]"}return t}),e.exports=d},function(e,t,n){var r=n(21)(n(17),"DataView");e.exports=r},function(e,t,n){var r=n(21)(n(17),"Promise");e.exports=r},function(e,t,n){var r=n(21)(n(17),"WeakMap");e.exports=r},function(e,t,n){var r=n(66),a=n(45);e.exports=function(e){for(var t=a(e),n=t.length;n--;){var i=t[n],o=e[i];t[n]=[i,o,r(o)]}return t}},function(e,t,n){var r=n(58),a=n(139),i=n(146),o=n(53),s=n(66),c=n(67),u=n(27);e.exports=function(e,t){return o(e)&&s(t)?c(u(e),t):function(n){var o=a(n,e);return void 0===o&&o===t?i(n,e):r(t,o,3)}}},function(e,t,n){var r=n(51);e.exports=function(e,t,n){var a=null==e?void 0:r(e,t);return void 0===a?n:a}},function(e,t,n){var r=n(141),a=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,i=/\\(\\)?/g,o=r((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(a,(function(e,n,r,a){t.push(r?a.replace(i,"$1"):n||e)})),t}));e.exports=o},function(e,t,n){var r=n(142);e.exports=function(e){var t=r(e,(function(e){return 500===n.size&&n.clear(),e})),n=t.cache;return t}},function(e,t,n){var r=n(43);function a(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function n(){var r=arguments,a=t?t.apply(this,r):r[0],i=n.cache;if(i.has(a))return i.get(a);var o=e.apply(this,r);return n.cache=i.set(a,o)||i,o};return n.cache=new(a.Cache||r),n}a.Cache=r,e.exports=a},function(e,t,n){var r=n(144);e.exports=function(e){return null==e?"":r(e)}},function(e,t,n){var r=n(33),a=n(145),i=n(16),o=n(37),s=r?r.prototype:void 0,c=s?s.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(i(t))return a(t,e)+"";if(o(t))return c?c.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n}},function(e,t){e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length,a=Array(r);++n<r;)a[n]=t(e[n],n,e);return a}},function(e,t,n){var r=n(147),a=n(148);e.exports=function(e,t){return null!=e&&a(e,t,r)}},function(e,t){e.exports=function(e,t){return null!=e&&t in Object(e)}},function(e,t,n){var r=n(52),a=n(46),i=n(16),o=n(36),s=n(49),c=n(27);e.exports=function(e,t,n){for(var u=-1,l=(t=r(t,e)).length,f=!1;++u<l;){var p=c(t[u]);if(!(f=null!=e&&n(e,p)))break;e=e[p]}return f||++u!=l?f:!!(l=null==e?0:e.length)&&s(l)&&o(p,l)&&(i(e)||a(e))}},function(e,t,n){var r=n(150),a=n(151),i=n(53),o=n(27);e.exports=function(e){return i(e)?r(o(e)):a(e)}},function(e,t){e.exports=function(e){return function(t){return null==t?void 0:t[e]}}},function(e,t,n){var r=n(51);e.exports=function(e){return function(t){return r(t,e)}}},function(e,t,n){var r=n(153),a=n(36),i=Array.prototype.splice;e.exports=function(e,t){for(var n=e?t.length:0,o=n-1;n--;){var s=t[n];if(n==o||s!==c){var c=s;a(s)?i.call(e,s,1):r(e,s)}}return e}},function(e,t,n){var r=n(52),a=n(154),i=n(155),o=n(27);e.exports=function(e,t){return t=r(t,e),null==(e=i(e,t))||delete e[o(a(t))]}},function(e,t){e.exports=function(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}},function(e,t,n){var r=n(51),a=n(156);e.exports=function(e,t){return t.length<2?e:r(e,a(t,0,-1))}},function(e,t){e.exports=function(e,t,n){var r=-1,a=e.length;t<0&&(t=-t>a?0:a+t),(n=n>a?a:n)<0&&(n+=a),a=t>n?0:n-t>>>0,t>>>=0;for(var i=Array(a);++r<a;)i[r]=e[r+t];return i}},function(e,t,n){var r=n(39),a=n(26),i=n(45);e.exports=function(e){return function(t,n,o){var s=Object(t);if(!a(t)){var c=r(n,3);t=i(t),n=function(e){return c(s[e],e,s)}}var u=e(t,n,o);return u>-1?s[c?t[u]:u]:void 0}}},function(e,t,n){var r=n(68),a=n(39),i=n(159),o=Math.max;e.exports=function(e,t,n){var s=null==e?0:e.length;if(!s)return-1;var c=null==n?0:i(n);return c<0&&(c=o(s+c,0)),r(e,a(t,3),c)}},function(e,t,n){var r=n(160);e.exports=function(e){var t=r(e),n=t%1;return t==t?n?t-n:t:0}},function(e,t,n){var r=n(161);e.exports=function(e){return e?(e=r(e))===1/0||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},function(e,t,n){var r=n(19),a=n(37),i=/^\s+|\s+$/g,o=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,c=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(a(e))return NaN;if(r(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=r(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(i,"");var n=s.test(e);return n||c.test(e)?u(e.slice(2),n?2:8):o.test(e)?NaN:+e}},function(e,t,n){var r=n(163)();e.exports=r},function(e,t){e.exports=function(e){return function(t,n,r){for(var a=-1,i=Object(t),o=r(t),s=o.length;s--;){var c=o[e?s:++a];if(!1===n(i[c],c,i))break}return t}}},function(e,t,n){var r=n(70),a=n(165),i=n(166),o=n(168),s=n(169),c=n(46),u=n(16),l=n(171),f=n(47),p=n(42),h=n(19),y=n(172),d=n(48),v=n(73),b=n(173);e.exports=function(e,t,n,m,g,w,k){var x=v(e,n),S=v(t,n),O=k.get(S);if(O)r(e,n,O);else{var P=w?w(x,S,n+"",e,t,k):void 0,j=void 0===P;if(j){var _=u(S),C=!_&&f(S),D=!_&&!C&&d(S);P=S,_||C||D?u(x)?P=x:l(x)?P=o(x):C?(j=!1,P=a(S,!0)):D?(j=!1,P=i(S,!0)):P=[]:y(S)||c(S)?(P=x,c(x)?P=b(x):h(x)&&!p(x)||(P=s(S))):j=!1}j&&(k.set(S,P),g(P,S,m,w,k),k.delete(S)),r(e,n,P)}}},function(e,t,n){(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(17),i="object"==r(t)&&t&&!t.nodeType&&t,o=i&&"object"==r(e)&&e&&!e.nodeType&&e,s=o&&o.exports===i?a.Buffer:void 0,c=s?s.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,r=c?c(n):new e.constructor(n);return e.copy(r),r}}).call(this,n(29)(e))},function(e,t,n){var r=n(167);e.exports=function(e,t){var n=t?r(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}},function(e,t,n){var r=n(62);e.exports=function(e){var t=new e.constructor(e.byteLength);return new r(t).set(new r(e)),t}},function(e,t){e.exports=function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}},function(e,t,n){var r=n(170),a=n(72),i=n(50);e.exports=function(e){return"function"!=typeof e.constructor||i(e)?{}:r(a(e))}},function(e,t,n){var r=n(19),a=Object.create,i=function(){function e(){}return function(t){if(!r(t))return{};if(a)return a(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();e.exports=i},function(e,t,n){var r=n(26),a=n(22);e.exports=function(e){return a(e)&&r(e)}},function(e,t,n){var r=n(24),a=n(72),i=n(22),o=Function.prototype,s=Object.prototype,c=o.toString,u=s.hasOwnProperty,l=c.call(Object);e.exports=function(e){if(!i(e)||"[object Object]"!=r(e))return!1;var t=a(e);if(null===t)return!0;var n=u.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&c.call(n)==l}},function(e,t,n){var r=n(174),a=n(74);e.exports=function(e){return r(e,a(e))}},function(e,t,n){var r=n(175),a=n(55);e.exports=function(e,t,n,i){var o=!n;n||(n={});for(var s=-1,c=t.length;++s<c;){var u=t[s],l=i?i(n[u],e[u],u,n,e):void 0;void 0===l&&(l=e[u]),o?a(n,u,l):r(n,u,l)}return n}},function(e,t,n){var r=n(55),a=n(25),i=Object.prototype.hasOwnProperty;e.exports=function(e,t,n){var o=e[t];i.call(e,t)&&a(o,n)&&(void 0!==n||t in e)||r(e,t,n)}},function(e,t,n){var r=n(19),a=n(50),i=n(177),o=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return i(e);var t=a(e),n=[];for(var s in e)("constructor"!=s||!t&&o.call(e,s))&&n.push(s);return n}},function(e,t){e.exports=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t}},function(e,t,n){var r=n(54),a=n(179),i=n(181);e.exports=function(e,t){return i(a(e,t,r),e+"")}},function(e,t,n){var r=n(180),a=Math.max;e.exports=function(e,t,n){return t=a(void 0===t?e.length-1:t,0),function(){for(var i=arguments,o=-1,s=a(i.length-t,0),c=Array(s);++o<s;)c[o]=i[t+o];o=-1;for(var u=Array(t+1);++o<t;)u[o]=i[o];return u[t]=n(c),r(e,this,u)}}},function(e,t){e.exports=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}},function(e,t,n){var r=n(182),a=n(184)(r);e.exports=a},function(e,t,n){var r=n(183),a=n(71),i=n(54),o=a?function(e,t){return a(e,"toString",{configurable:!0,enumerable:!1,value:r(t),writable:!0})}:i;e.exports=o},function(e,t){e.exports=function(e){return function(){return e}}},function(e,t){var n=Date.now;e.exports=function(e){var t=0,r=0;return function(){var a=n(),i=16-(a-r);if(r=a,i>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(25),i=n(26),o=n(36),s=n(19);e.exports=function(e,t,n){if(!s(n))return!1;var c=r(t);return!!("number"==c?i(n)&&o(t,n.length):"string"==c&&t in n)&&a(n[t],e)}},function(e,t,n){var r=n(187);e.exports=function(e,t){return!!(null==e?0:e.length)&&r(e,t,0)>-1}},function(e,t,n){var r=n(68),a=n(188),i=n(189);e.exports=function(e,t,n){return t==t?i(e,t,n):r(e,a,n)}},function(e,t){e.exports=function(e){return e!=e}},function(e,t){e.exports=function(e,t,n){for(var r=n-1,a=e.length;++r<a;)if(e[r]===t)return r;return-1}},function(e,t){e.exports=function(e,t,n){for(var r=-1,a=null==e?0:e.length;++r<a;)if(n(t,e[r]))return!0;return!1}},function(e,t,n){var r=n(65),a=n(192),i=n(44),o=r&&1/i(new r([,-0]))[1]==1/0?function(e){return new r(e)}:a;e.exports=o},function(e,t){e.exports=function(){}},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var r,a,i,o,s,c=1,u={},l=!1,f=e.document,p=Object.getPrototypeOf&&Object.getPrototypeOf(e);p=p&&p.setTimeout?p:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick((function(){y(e)}))}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((i=new MessageChannel).port1.onmessage=function(e){y(e.data)},r=function(e){i.port2.postMessage(e)}):f&&"onreadystatechange"in f.createElement("script")?(a=f.documentElement,r=function(e){var t=f.createElement("script");t.onreadystatechange=function(){y(e),t.onreadystatechange=null,a.removeChild(t),t=null},a.appendChild(t)}):r=function(e){setTimeout(y,0,e)}:(o="setImmediate$"+Math.random()+"$",s=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(o)&&y(+t.data.slice(o.length))},e.addEventListener?e.addEventListener("message",s,!1):e.attachEvent("onmessage",s),r=function(t){e.postMessage(o+t,"*")}),p.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var a={callback:e,args:t};return u[c]=a,r(c),c++},p.clearImmediate=h}function h(e){delete u[e]}function y(e){if(l)setTimeout(y,0,e);else{var t=u[e];if(t){l=!0;try{!function(e){var t=e.callback,n=e.args;switch(n.length){case 0:t();break;case 1:t(n[0]);break;case 2:t(n[0],n[1]);break;case 3:t(n[0],n[1],n[2]);break;default:t.apply(void 0,n)}}(t)}finally{h(e),l=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(30),n(194))},function(e,t){var n,r,a=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function s(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{r="function"==typeof clearTimeout?clearTimeout:o}catch(e){r=o}}();var c,u=[],l=!1,f=-1;function p(){l&&c&&(l=!1,c.length?u=c.concat(u):f=-1,u.length&&h())}function h(){if(!l){var e=s(p);l=!0;for(var t=u.length;t;){for(c=u,u=[];++f<t;)c&&c[f].run();f=-1,t=u.length}c=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===o||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function y(e,t){this.fun=e,this.array=t}function d(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new y(e,t)),1!==u.length||l||s(h)},y.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=d,a.addListener=d,a.once=d,a.off=d,a.removeListener=d,a.removeAllListeners=d,a.emit=d,a.prependListener=d,a.prependOnceListener=d,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},function(e,t,n){"use strict";n.r(t),n.d(t,"SNApplication",(function(){return rl})),n.d(t,"SNProtocolService",(function(){return ns})),n.d(t,"KeyMode",(function(){return Ho})),n.d(t,"SNProtocolOperator001",(function(){return yo})),n.d(t,"SNProtocolOperator002",(function(){return Po})),n.d(t,"SNProtocolOperator003",(function(){return To})),n.d(t,"SNProtocolOperator004",(function(){return zo})),n.d(t,"DeviceInterface",(function(){return sl})),n.d(t,"SNItem",(function(){return v.d})),n.d(t,"ItemMutator",(function(){return v.b})),n.d(t,"AppDataField",(function(){return v.a})),n.d(t,"SNItemsKey",(function(){return Kt})),n.d(t,"SNPredicate",(function(){return C.a})),n.d(t,"SNNote",(function(){return St})),n.d(t,"NoteMutator",(function(){return Ot})),n.d(t,"SNTag",(function(){return it})),n.d(t,"SNSmartTag",(function(){return ft})),n.d(t,"SNActionsExtension",(function(){return Ge})),n.d(t,"Action",(function(){return Fe})),n.d(t,"SNTheme",(function(){return _e})),n.d(t,"SNComponent",(function(){return ye})),n.d(t,"ComponentAction",(function(){return Z})),n.d(t,"ComponentMutator",(function(){return de})),n.d(t,"SNEditor",(function(){return Re})),n.d(t,"SNUserPrefs",(function(){return V})),n.d(t,"UserPrefsMutator",(function(){return N})),n.d(t,"WebPrefKey",(function(){return O})),n.d(t,"MutationType",(function(){return v.c})),n.d(t,"ComponentArea",(function(){return X})),n.d(t,"LiveItem",(function(){return fl})),n.d(t,"SNComponentManager",(function(){return Dr})),n.d(t,"HistorySession",(function(){return ms})),n.d(t,"ItemHistory",(function(){return ds})),n.d(t,"ItemHistoryEntry",(function(){return is})),n.d(t,"SNPrivileges",(function(){return ee})),n.d(t,"ProtectedAction",(function(){return F})),n.d(t,"PrivilegeCredential",(function(){return L})),n.d(t,"PayloadManager",(function(){return Ka})),n.d(t,"ItemManager",(function(){return uc})),n.d(t,"SNHttpService",(function(){return Gn})),n.d(t,"ChallengeService",(function(){return $u})),n.d(t,"ChallengeOrchestrator",(function(){return Ju})),n.d(t,"PureService",(function(){return Qt.a})),n.d(t,"ApplicationService",(function(){return pl.a})),n.d(t,"SNStorageService",(function(){return on})),n.d(t,"StoragePersistencePolicies",(function(){return Ht})),n.d(t,"StorageEncryptionPolicies",(function(){return zt})),n.d(t,"StorageValueModes",(function(){return qt})),n.d(t,"ValueModesKeys",(function(){return Jt})),n.d(t,"Challenge",(function(){return w})),n.d(t,"ChallengeReason",(function(){return d})),n.d(t,"ChallengeResponse",(function(){return x})),n.d(t,"ChallengeType",(function(){return y})),n.d(t,"challengeTypeToString",(function(){return S})),n.d(t,"ChallengeValue",(function(){return k})),n.d(t,"SNSyncService",(function(){return Au})),n.d(t,"SyncSources",(function(){return Tu})),n.d(t,"SyncModes",(function(){return Ru})),n.d(t,"SyncQueueStrategy",(function(){return Mu})),n.d(t,"SortPayloadsByRecentAndContentPriority",(function(){return lc})),n.d(t,"SNSessionManager",(function(){return Ln})),n.d(t,"SNMigrationService",(function(){return Ji})),n.d(t,"SNAlertService",(function(){return dn})),n.d(t,"SNHistoryManager",(function(){return Es})),n.d(t,"SNPrivilegesService",(function(){return Hs})),n.d(t,"SNSingletonManager",(function(){return Ja})),n.d(t,"SNApiService",(function(){return cr})),n.d(t,"Copy",(function(){return u.a})),n.d(t,"findInArray",(function(){return u.l})),n.d(t,"isNullOrUndefined",(function(){return u.p})),n.d(t,"deepMerge",(function(){return u.h})),n.d(t,"extendArray",(function(){return u.j})),n.d(t,"removeFromIndex",(function(){return u.C})),n.d(t,"subtractFromArray",(function(){return u.G})),n.d(t,"arrayByDifference",(function(){return u.c})),n.d(t,"uniqCombineObjArrays",(function(){return u.J})),n.d(t,"greaterOfTwoDates",(function(){return u.n})),n.d(t,"getGlobalScope",(function(){return u.m})),n.d(t,"removeFromArray",(function(){return u.B})),n.d(t,"addIfUnique",(function(){return u.b})),n.d(t,"dictToArray",(function(){return u.i})),n.d(t,"truncateHexString",(function(){return u.I})),n.d(t,"jsonParseEmbeddedKeys",(function(){return u.v})),n.d(t,"topLevelCompare",(function(){return u.H})),n.d(t,"Uuid",(function(){return h})),n.d(t,"EncryptionIntent",(function(){return Gt.a})),n.d(t,"isLocalStorageIntent",(function(){return Gt.e})),n.d(t,"isFileIntent",(function(){return Gt.d})),n.d(t,"isDecryptedIntent",(function(){return Gt.c})),n.d(t,"intentRequiresEncryption",(function(){return Gt.b})),n.d(t,"ContentType",(function(){return P.a})),n.d(t,"CreateItemFromPayload",(function(){return Ut})),n.d(t,"Uuids",(function(){return s.b})),n.d(t,"FillItemContent",(function(){return s.a})),n.d(t,"ApplicationEvent",(function(){return c.a})),n.d(t,"Environment",(function(){return or})),n.d(t,"Platform",(function(){return sr})),n.d(t,"isEnvironmentWebOrDesktop",(function(){return br})),n.d(t,"isEnvironmentMobile",(function(){return mr})),n.d(t,"platformFromString",(function(){return vr})),n.d(t,"SyncEvent",(function(){return Fa.a})),n.d(t,"MutableCollection",(function(){return Wr})),n.d(t,"ImmutablePayloadCollection",(function(){return $r})),n.d(t,"ItemCollection",(function(){return ec})),n.d(t,"CollectionSort",(function(){return Ws})),n.d(t,"CreateMaxPayloadFromAnyObject",(function(){return j.e})),n.d(t,"CreateSourcedPayloadFromObject",(function(){return j.f})),n.d(t,"CreateIntentPayloadFromObject",(function(){return j.d})),n.d(t,"CreateEncryptionParameters",(function(){return j.c})),n.d(t,"PayloadByMerging",(function(){return j.g})),n.d(t,"CopyPayload",(function(){return j.b})),n.d(t,"PayloadSource",(function(){return _.a})),n.d(t,"isPayloadSourceRetrieved",(function(){return _.b})),n.d(t,"ProtocolVersion",(function(){return Pt.a})),n.d(t,"PayloadFormat",(function(){return pt.a})),n.d(t,"PurePayload",(function(){return hl.a})),n.d(t,"PayloadField",(function(){return la.a})),n.d(t,"StorageKey",(function(){return Nt})),n.d(t,"BaseMigration",(function(){return Fi})),n.d(t,"PrivilegeSessionLength",(function(){return Is}));var r={};n.r(r),n.d(r,"Migration20200115",(function(){return Ci}));var a,i=n(0),o=n.n(i),s=n(11);!function(e){e[e.PreparingForLaunch_0=0]="PreparingForLaunch_0",e[e.ReadyForLaunch_05=.5]="ReadyForLaunch_05",e[e.StorageDecrypted_09=.9]="StorageDecrypted_09",e[e.Launched_10=1]="Launched_10",e[e.LoadingDatabase_11=1.1]="LoadingDatabase_11",e[e.LoadedDatabase_12=1.2]="LoadedDatabase_12",e[e.FullSyncCompleted_13=1.3]="FullSyncCompleted_13",e[e.SignedIn_30=3]="SignedIn_30"}(a||(a={}));var c=n(13),u=n(1);function l(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r,a,i;return t=e,n=null,r=[{key:"SetGenerators",value:function(e,t){this.syncUuidFunc=t,this.asyncUuidFunc=e}},{key:"canGenSync",value:function(){return!Object(u.p)(this.syncUuidFunc)}},{key:"GenerateUuid",value:(a=o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.syncUuidFunc){e.next=4;break}return e.abrupt("return",this.syncUuidFunc());case 4:return e.abrupt("return",this.asyncUuidFunc());case 5:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){l(i,n,r,o,s,"next",e)}function s(e){l(i,n,r,o,s,"throw",e)}o(void 0)}))},function(){return i.apply(this,arguments)})},{key:"GenerateUuidSynchronously",value:function(){return this.syncUuidFunc()}}],n&&f(t.prototype,n),r&&f(t,r),e}();p(h,"syncUuidFunc",void 0),p(h,"asyncUuidFunc",void 0);var y,d,v=n(6);function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.LocalPasscode=1]="LocalPasscode",e[e.AccountPassword=2]="AccountPassword",e[e.Biometric=3]="Biometric"}(y||(y={})),function(e){e[e.ApplicationUnlock=1]="ApplicationUnlock",e[e.ResaveRootKey=2]="ResaveRootKey",e[e.ProtocolUpgrade=3]="ProtocolUpgrade",e[e.Migration=4]="Migration"}(d||(d={}));var w=function e(t,n){m(this,e),g(this,"types",void 0),g(this,"reason",void 0),g(this,"id",void 0),this.types=t,this.reason=n,this.id=(new Date).getTime(),Object.freeze(this)},k=function e(t,n){m(this,e),g(this,"type",void 0),g(this,"value",void 0),this.type=t,this.value=n,Object.freeze(this)},x=function(){function e(t,n,r){m(this,e),g(this,"challenge",void 0),g(this,"values",void 0),g(this,"artifacts",void 0),this.challenge=t,this.values=n,this.artifacts=r,Object.freeze(this)}var t,n,r;return t=e,(n=[{key:"getValueForType",value:function(e){return this.values.find((function(t){return t.type===e}))}}])&&b(t.prototype,n),r&&b(t,r),e}();function S(e){var t;return(g(t={},y.LocalPasscode,"application passcode"),g(t,y.AccountPassword,"account password"),g(t,y.Biometric,"biometrics"),t)[e]}var O,P=n(4),j=n(2),_=n(3),C=n(15);function D(e){return(D="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function I(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function E(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function M(e,t,n){return t&&E(e.prototype,t),n&&E(e,n),e}function R(e,t){return!t||"object"!==D(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function T(e){return(T=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function A(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&K(e,t)}function K(e,t){return(K=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}!function(e){e.TagsPanelWidth="tagsPanelWidth",e.NotesPanelWidth="notesPanelWidth",e.EditorWidth="editorWidth",e.EditorLeft="editorLeft",e.EditorMonospaceEnabled="monospaceFont",e.EditorSpellcheck="spellcheck",e.EditorResizersEnabled="marginResizersEnabled",e.SortNotesBy="sortBy",e.SortNotesReverse="sortReverse",e.NotesShowArchived="showArchived",e.NotesHidePinned="hidePinned",e.NotesHideNotePreview="hideNotePreview",e.NotesHideDate="hideDate"}(O||(O={}));var F,L,V=function(e){function t(){return I(this,t),R(this,T(t).apply(this,arguments))}return A(t,e),M(t,[{key:"getPref",value:function(e){return this.getAppDomainValue(e)}},{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new C.a("content_type","=",this.content_type)}}]),t}(v.d),N=function(e){function t(){return I(this,t),R(this,T(t).apply(this,arguments))}return A(t,e),M(t,[{key:"setWebPref",value:function(e,t){this.setAppDataItem(e,t)}}]),t}(v.b);function W(e){return(W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function U(e,t,n){return(U="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=J(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function B(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function z(e,t,n){return t&&H(e.prototype,t),n&&H(e,n),e}function q(e,t){return!t||"object"!==W(t)&&"function"!=typeof t?G(e):t}function J(e){return(J=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function G(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Q(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&$(e,t)}function $(e,t){return($=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.ManageExtensions="ActionManageExtensions",e.ManageBackups="ActionManageBackups",e.ViewProtectedNotes="ActionViewProtectedNotes",e.ManagePrivileges="ActionManagePrivileges",e.ManagePasscode="ActionManagePasscode",e.DeleteNote="ActionDeleteNote"}(F||(F={})),function(e){e.AccountPassword="CredentialAccountPassword",e.LocalPasscode="CredentialLocalPasscode"}(L||(L={}));var X,Z,ee=function(e){function t(e){var n;return B(this,t),Y(G(n=q(this,J(t).call(this,e))),"privilegeMap",{}),n.privilegeMap=e.safeContent.desktopPrivileges||{},n}return Q(t,e),z(t,[{key:"getCredentialsForAction",value:function(e){return this.privilegeMap[e]||[]}},{key:"isCredentialRequiredForAction",value:function(e,t){return this.getCredentialsForAction(e).includes(t)}},{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new C.a("content_type","=",this.content_type)}}]),t}(v.d),te=function(e){function t(e,n){var r;return B(this,t),Y(G(r=q(this,J(t).call(this,e,n))),"privileges",void 0),Y(G(r),"privilegeMap",{}),r.privileges=e,r.privilegeMap=Object(u.a)(r.payload.safeContent.desktopPrivileges||{}),r}return Q(t,e),z(t,[{key:"getResult",value:function(){return this.content&&(this.content.desktopPrivileges=this.privilegeMap),U(J(t.prototype),"getResult",this).call(this)}},{key:"setCredentialsForAction",value:function(e,t){this.privilegeMap[e]=t}},{key:"toggleCredentialForAction",value:function(e,t){this.privileges.isCredentialRequiredForAction(e,t)?this.removeCredentialForAction(e,t):this.addCredentialForAction(e,t)}},{key:"removeCredentialForAction",value:function(e,t){Object(u.B)(this.privilegeMap[e],t)}},{key:"addCredentialForAction",value:function(e,t){var n=this.privileges.getCredentialsForAction(e).slice();n.push(t),this.setCredentialsForAction(e,n)}}]),t}(v.b),ne=n(14);function re(e){return(re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ae(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ie(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function oe(e,t,n){return t&&ie(e.prototype,t),n&&ie(e,n),e}function se(e,t){return!t||"object"!==re(t)&&"function"!=typeof t?ce(e):t}function ce(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ue(e,t,n){return(ue="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=le(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function le(e){return(le=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function fe(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&pe(e,t)}function pe(e,t){return(pe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function he(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.Editor="editor-editor",e.Themes="themes",e.TagsList="tags-list",e.EditorStack="editor-stack",e.NoteTags="note-tags",e.Rooms="rooms",e.Modal="modal",e.Any="*"}(X||(X={})),function(e){e.SetSize="set-size",e.StreamItems="stream-items",e.StreamContextItem="stream-context-item",e.SaveItems="save-items",e.SelectItem="select-item",e.AssociateItem="associate-item",e.DeassociateItem="deassociate-item",e.ClearSelection="clear-selection",e.CreateItem="create-item",e.CreateItems="create-items",e.DeleteItems="delete-items",e.SetComponentData="set-component-data",e.InstallLocalComponent="install-local-component",e.ToggleActivateComponent="toggle-activate-component",e.RequestPermissions="request-permissions",e.PresentConflictResolution="present-conflict-resolution",e.DuplicateItem="duplicate-item",e.ComponentRegistered="component-registered",e.ActivateThemes="themes",e.Reply="reply",e.SaveSuccess="save-success",e.SaveError="save-error"}(Z||(Z={}));var ye=function(e){function t(e){var n;return ae(this,t),he(ce(n=se(this,le(t).call(this,e))),"componentData",void 0),he(ce(n),"disassociatedItemIds",void 0),he(ce(n),"associatedItemIds",void 0),he(ce(n),"local_url",void 0),he(ce(n),"hosted_url",void 0),he(ce(n),"offlineOnly",void 0),he(ce(n),"name",void 0),he(ce(n),"autoupdateDisabled",void 0),he(ce(n),"package_info",void 0),he(ce(n),"area",void 0),he(ce(n),"permissions",[]),he(ce(n),"valid_until",void 0),he(ce(n),"active",void 0),he(ce(n),"legacy_url",void 0),he(ce(n),"isMobileDefault",void 0),n.componentData=n.payload.safeContent.componentData||{},n.legacy_url=n.payload.safeContent.legacy_url,n.hosted_url=n.payload.safeContent.hosted_url||n.payload.safeContent.url,n.local_url=n.payload.safeContent.local_url,n.valid_until=new Date(n.payload.safeContent.valid_until),n.offlineOnly=n.payload.safeContent.offlineOnly,n.name=n.payload.safeContent.name,n.area=n.payload.safeContent.area,n.package_info=n.payload.safeContent.package_info,n.permissions=n.payload.safeContent.permissions||[],n.active=n.payload.safeContent.active,n.autoupdateDisabled=n.payload.safeContent.autoupdateDisabled,n.disassociatedItemIds=n.payload.safeContent.disassociatedItemIds||[],n.associatedItemIds=n.payload.safeContent.associatedItemIds||[],n.isMobileDefault=n.payload.safeContent.isMobileDefault,n.legacy_url=n.payload.safeContent.hosted_url?void 0:n.payload.safeContent.url,n}return fe(t,e),oe(t,[{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?ue(le(t.prototype),"strategyWhenConflictingWithItem",this).call(this,e):ne.a.KeepLeft}},{key:"isEditor",value:function(){return this.area===X.Editor}},{key:"isTheme",value:function(){return this.content_type===P.a.Theme||this.area===X.Themes}},{key:"isDefaultEditor",value:function(){return!0===this.getAppDomainValue(v.a.DefaultEditor)}},{key:"getLastSize",value:function(){return this.getAppDomainValue(v.a.LastSize)}},{key:"acceptsThemes",value:function(){var e;return null===(e=this.payload.safeContent.package_info)||void 0===e?void 0:e.acceptsThemes}},{key:"getClientDataKey",value:function(){return this.legacy_url?this.legacy_url:this.uuid}},{key:"hasValidHostedUrl",value:function(){return this.hosted_url||this.legacy_url}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["active","disassociatedItemIds","associatedItemIds"].concat(ue(le(t.prototype),"contentKeysToIgnoreWhenCheckingEquality",this).call(this))}},{key:"isAssociative",value:function(){return t.associativeAreas().includes(this.area)}},{key:"isExplicitlyEnabledForItem",value:function(e){return-1!==this.associatedItemIds.indexOf(e)}},{key:"isExplicitlyDisabledForItem",value:function(e){return-1!==this.disassociatedItemIds.indexOf(e)}}],[{key:"associativeAreas",value:function(){return[X.Editor]}}]),t}(v.d),de=function(e){function t(){return ae(this,t),se(this,le(t).apply(this,arguments))}return fe(t,e),oe(t,[{key:"associateWithItem",value:function(e){var t=this.typedContent.associatedItemIds||[];Object(u.b)(t,e),this.typedContent.associatedItemIds=t}},{key:"disassociateWithItem",value:function(e){var t=this.typedContent.disassociatedItemIds||[];Object(u.b)(t,e),this.typedContent.disassociatedItemIds=t}},{key:"removeAssociatedItemId",value:function(e){Object(u.B)(this.typedContent.associatedItemIds||[],e)}},{key:"removeDisassociatedItemId",value:function(e){Object(u.B)(this.typedContent.disassociatedItemIds||[],e)}},{key:"setLastSize",value:function(e){this.setAppDataItem(v.a.LastSize,e)}},{key:"typedContent",get:function(){return this.content}},{key:"active",set:function(e){this.typedContent.active=e}},{key:"defaultEditor",set:function(e){this.setAppDataItem(v.a.DefaultEditor,e)}},{key:"componentData",set:function(e){this.typedContent.componentData=e}},{key:"package_info",set:function(e){this.typedContent.package_info=e}},{key:"local_url",set:function(e){this.typedContent.local_url=e}},{key:"hosted_url",set:function(e){this.typedContent.hosted_url=e}},{key:"permissions",set:function(e){this.typedContent.permissions=e}}]),t}(v.b);function ve(e){return(ve="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function be(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function me(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ge(e,t,n){return t&&me(e.prototype,t),n&&me(e,n),e}function we(e,t){return!t||"object"!==ve(t)&&"function"!=typeof t?ke(e):t}function ke(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function xe(e,t,n){return(xe="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Se(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Se(e){return(Se=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Oe(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Pe(e,t)}function Pe(e,t){return(Pe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function je(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _e=function(e){function t(){var e,n;be(this,t);for(var r=arguments.length,a=new Array(r),i=0;i<r;i++)a[i]=arguments[i];return je(ke(n=we(this,(e=Se(t)).call.apply(e,[this].concat(a)))),"area",X.Themes),n}return Oe(t,e),ge(t,[{key:"isLayerable",value:function(){return this.package_info&&this.package_info.layerable}},{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?xe(Se(t.prototype),"strategyWhenConflictingWithItem",this).call(this,e):ne.a.KeepLeft}},{key:"getMobileRules",value:function(){return this.getAppDomainValue(v.a.MobileRules)||{constants:{},rules:{}}}},{key:"hasMobileRules",value:function(){return this.getAppDomainValue(v.a.MobileRules)}},{key:"getNotAvailOnMobile",value:function(){return this.getAppDomainValue(v.a.NotAvailableOnMobile)}},{key:"isMobileActive",value:function(){return this.getAppDomainValue(v.a.MobileActive)}}]),t}(ye);v.b;function Ce(e){return(Ce="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function De(e){return(De=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ie(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ee(e,t){return(Ee=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Me(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Re=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t){return!t||"object"!==Ce(t)&&"function"!=typeof t?Ie(e):t}(this,De(t).call(this,e)),Me(Ie(n),"notes",[]),Me(Ie(n),"data",{}),Me(Ie(n),"url",void 0),Me(Ie(n),"name",void 0),Me(Ie(n),"isDefault",void 0),Me(Ie(n),"systemEditor",void 0),n.url=e.safeContent.url,n.name=e.safeContent.name,n.data=e.safeContent.data||{},n.isDefault=e.safeContent.default,n.systemEditor=e.safeContent.systemEditor,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ee(e,t)}(t,e),t}(v.d),Te=n(38),Ae=n.n(Te);function Ke(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Fe=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ke(this,"label",void 0),Ke(this,"desc",void 0),Ke(this,"running",void 0),Ke(this,"error",void 0),Ke(this,"lastExecuted",void 0),Ke(this,"context",void 0),Ke(this,"verb",void 0),Ke(this,"url",void 0),Ke(this,"access_type",void 0),Ke(this,"subactions",void 0),Ke(this,"subrows",void 0),Ae()(this,t),this.running=!1,this.error=!1,this.lastExecuted&&(this.lastExecuted=new Date(this.lastExecuted))};function Le(e){return(Le="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ve(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ne(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function We(e,t,n){return t&&Ne(e.prototype,t),n&&Ne(e,n),e}function Ue(e,t){return!t||"object"!==Le(t)&&"function"!=typeof t?He(e):t}function Be(e){return(Be=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function He(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ze(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qe(e,t)}function qe(e,t){return(qe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Je(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ge=function(e){function t(e){var n;return Ve(this,t),Je(He(n=Ue(this,Be(t).call(this,e))),"actions",[]),Je(He(n),"description",void 0),Je(He(n),"name",void 0),Je(He(n),"url",void 0),Je(He(n),"package_info",void 0),Je(He(n),"supported_types",void 0),n.description=e.safeContent.description,n.url=e.safeContent.url,n.name=e.safeContent.name,n.package_info=e.safeContent.package_info,n.supported_types=e.safeContent.supported_types,e.safeContent.actions&&(n.actions=e.safeContent.actions.map((function(e){return new Fe(e)}))),n}return ze(t,e),We(t,[{key:"actionsWithContextForItem",value:function(e){return this.actions.filter((function(t){return t.context===e.content_type||"Item"===t.context}))}}]),t}(v.d),Qe=function(e){function t(){return Ve(this,t),Ue(this,Be(t).apply(this,arguments))}return ze(t,e),We(t,[{key:"description",set:function(e){this.content.description=e}},{key:"supported_types",set:function(e){this.content.supported_types=e}},{key:"actions",set:function(e){this.content.actions=e}}]),t}(v.b);function $e(e){return($e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ye(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Xe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ze(e,t,n){return t&&Xe(e.prototype,t),n&&Xe(e,n),e}function et(e,t){return!t||"object"!==$e(t)&&"function"!=typeof t?nt(e):t}function tt(e){return(tt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function nt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function rt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&at(e,t)}function at(e,t){return(at=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var it=function(e){function t(e){var n,r,a,i;return Ye(this,t),n=et(this,tt(t).call(this,e)),r=nt(n),i=void 0,(a="title")in r?Object.defineProperty(r,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[a]=i,n.title=n.payload.safeContent.title,n}return rt(t,e),Ze(t,[{key:"isSmartTag",value:function(){return this.content_type===P.a.SmartTag}},{key:"noteCount",get:function(){return this.payload.safeReferences.length}},{key:"isAllTag",get:function(){return this.payload.safeContent.isAllTag}},{key:"isTrashTag",get:function(){return this.payload.safeContent.isTrashTag}},{key:"isArchiveTag",get:function(){return this.payload.safeContent.isArchiveTag}}],[{key:"arrayToDisplayString",value:function(e){return e.sort((function(e,t){return e.title>t.title?1:-1})).map((function(e){return"#"+e.title})).join(" ")}}]),t}(v.d),ot=function(e){function t(){return Ye(this,t),et(this,tt(t).apply(this,arguments))}return rt(t,e),Ze(t,[{key:"title",set:function(e){this.content.title=e}}]),t}(v.b);function st(e){return(st="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ct(e){return(ct=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ut(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function lt(e,t){return(lt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ft=function(e){function t(e){var n,r,a,i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t){return!t||"object"!==st(t)&&"function"!=typeof t?ut(e):t}(this,ct(t).call(this,e)),r=ut(n),i=void 0,(a="predicate")in r?Object.defineProperty(r,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[a]=i,e.safeContent.predicate&&(n.predicate=C.a.FromJson(e.safeContent.predicate)),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&lt(e,t)}(t,e),t}(it),pt=n(10);function ht(e){return(ht="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function yt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function dt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function vt(e,t,n){return t&&dt(e.prototype,t),n&&dt(e,n),e}function bt(e,t){return!t||"object"!==ht(t)&&"function"!=typeof t?gt(e):t}function mt(e){return(mt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function gt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function wt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&kt(e,t)}function kt(e,t){return(kt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function xt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var St=function(e){function t(e){var n;return yt(this,t),xt(gt(n=bt(this,mt(t).call(this,e))),"title",void 0),xt(gt(n),"text",""),xt(gt(n),"mobilePrefersPlainEditor",void 0),xt(gt(n),"hidePreview",!1),xt(gt(n),"preview_plain",void 0),xt(gt(n),"preview_html",void 0),xt(gt(n),"prefersPlainEditor",void 0),n.title=n.payload.safeContent.title,n.text=n.payload.safeContent.text,n.preview_plain=n.payload.safeContent.preview_plain,n.preview_html=n.payload.safeContent.preview_html,n.hidePreview=n.payload.safeContent.hidePreview,e.format===pt.a.DecryptedBareObject&&(n.prefersPlainEditor=n.getAppDomainValue(v.a.PrefersPlainEditor)),Object(u.p)(n.payload.safeContent.mobilePrefersPlainEditor)||(n.mobilePrefersPlainEditor=n.payload.safeContent.mobilePrefersPlainEditor),n}return wt(t,e),vt(t,[{key:"safeText",value:function(){return this.text||""}},{key:"safeTitle",value:function(){return this.title||""}}]),t}(v.d),Ot=function(e){function t(){return yt(this,t),bt(this,mt(t).apply(this,arguments))}return wt(t,e),vt(t,[{key:"typedContent",get:function(){return this.content}},{key:"title",set:function(e){this.typedContent.title=e}},{key:"text",set:function(e){this.typedContent.text=e}},{key:"hidePreview",set:function(e){this.typedContent.hidePreview=e}},{key:"preview_plain",set:function(e){this.typedContent.preview_plain=e}},{key:"preview_html",set:function(e){this.typedContent.preview_html=e}},{key:"prefersPlainEditor",set:function(e){this.setAppDataItem(v.a.PrefersPlainEditor,e)}}]),t}(v.b),Pt=n(7);function jt(e){return(jt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ct(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Dt(e,t,n){return t&&Ct(e.prototype,t),n&&Ct(e,n),e}function It(e,t){return!t||"object"!==jt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Et(e,t,n){return(Et="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Mt(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Mt(e){return(Mt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Rt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Tt(e,t)}function Tt(e,t){return(Tt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var At,Kt=function(e){function t(){return _t(this,t),It(this,Mt(t).apply(this,arguments))}return Rt(t,e),Dt(t,[{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?Et(Mt(t.prototype),"strategyWhenConflictingWithItem",this).call(this,e):ne.a.KeepLeft}},{key:"version",get:function(){return this.payload.safeContent.version}},{key:"isItemsKey",get:function(){return!0}},{key:"isDefault",get:function(){return this.payload.safeContent.isDefault}},{key:"itemsKey",get:function(){return this.payload.safeContent.itemsKey}},{key:"dataAuthenticationKey",get:function(){if(this.version===Pt.a.V004)throw"Attempting to access legacy data authentication key.";return this.payload.safeContent.dataAuthenticationKey}}]),t}(v.d),Ft=function(e){function t(){return _t(this,t),It(this,Mt(t).apply(this,arguments))}return Rt(t,e),Dt(t,[{key:"isDefault",set:function(e){this.content.isDefault=e}}]),t}(v.b);function Lt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Vt,Nt,Wt=(Lt(At={},P.a.Note,St),Lt(At,P.a.Tag,it),Lt(At,P.a.ItemsKey,Kt),Lt(At,P.a.SmartTag,ft),Lt(At,P.a.ActionsExtension,Ge),Lt(At,P.a.Editor,Re),Lt(At,P.a.Theme,_e),Lt(At,P.a.Component,ye),Lt(At,P.a.Privileges,ee),Lt(At,P.a.UserPrefs,V),At);function Ut(e){return new(Wt[e.content_type]||v.d)(e)}function Bt(e,t){return e?"".concat(e,"-").concat(t):t}!function(e){e.StorageObject="storage",e.LastMigrationTimestamp="last_migration_timestamp"}(Vt||(Vt={})),function(e){e.RootKeyParams="ROOT_KEY_PARAMS",e.WrappedRootKey="WRAPPED_ROOT_KEY",e.RootKeyWrapperKeyParams="ROOT_KEY_WRAPPER_KEY_PARAMS",e.Session="session",e.User="user",e.ServerHost="server",e.LegacyUuid="uuid",e.LastSyncToken="syncToken",e.PaginationToken="cursorToken",e.BiometricPrefs="biometrics_prefs",e.MobilePasscodeTiming="passcode_timing",e.PrivilegesExpirey="SessionExpiresAtKey",e.PrivilegesSessionLength="SessionLengthKey",e.SessionHistoryPersistable="sessionHistory_persist",e.SessionHistoryRevisions="sessionHistory_revisions",e.SessionHistoryOptimize="sessionHistory_autoOptimize"}(Nt||(Nt={}));var Ht,zt,qt,Jt,Gt=n(9),Qt=n(12);function $t(e){return($t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Yt(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Xt(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Yt(i,r,a,o,s,"next",e)}function s(e){Yt(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Zt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function en(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function tn(e,t,n){return(tn="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=nn(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function nn(e){return(nn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function rn(e,t){return(rn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function an(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.Default=1]="Default",e[e.Ephemeral=2]="Ephemeral"}(Ht||(Ht={})),function(e){e[e.Default=1]="Default",e[e.Disabled=2]="Disabled"}(zt||(zt={})),function(e){e[e.Default=1]="Default",e[e.Nonwrapped=2]="Nonwrapped"}(qt||(qt={})),function(e){e.Wrapped="wrapped",e.Unwrapped="unwrapped",e.Nonwrapped="nonwrapped"}(Jt||(Jt={}));var on=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==$t(t)&&"function"!=typeof t?en(e):t}(this,nn(t).call(this)),an(en(r),"encryptionDelegate",void 0),an(en(r),"namespace",void 0),an(en(r),"storagePersistable",!1),an(en(r),"persistencePolicy",void 0),an(en(r),"encryptionPolicy",void 0),an(en(r),"values",void 0),r.deviceInterface=e,r.namespace=n,r.setPersistencePolicy(Ht.Default),r.setEncryptionPolicy(zt.Default),r}var n,r,i,s,c,l,f,p,y,d,v,b,m,g,w,k,x,S,O,_,C,D,I;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&rn(e,t)}(t,e),n=t,r=[{key:"deinit",value:function(){this.deviceInterface=void 0,this.encryptionDelegate=void 0,tn(nn(t.prototype),"deinit",this).call(this)}},{key:"handleApplicationStage",value:(I=Xt(o.a.mark((function e(n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,tn(nn(t.prototype),"handleApplicationStage",this).call(this,n);case 2:n===a.Launched_10&&(this.storagePersistable=!0);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"setPersistencePolicy",value:(D=Xt(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy=t,this.persistencePolicy!==Ht.Ephemeral){e.next=6;break}return e.next=4,this.deviceInterface.removeAllRawStorageValues();case 4:return e.next=6,this.clearAllPayloads();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return D.apply(this,arguments)})},{key:"setEncryptionPolicy",value:(C=Xt(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.encryptionPolicy=t;case 1:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.persistencePolicy===Ht.Ephemeral}},{key:"initializeFromDisk",value:(_=Xt(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getRawStorageValue(this.getPersistenceKey());case 2:t=e.sent,n=t?JSON.parse(t):null,this.setInitialValues(n);case 5:case"end":return e.stop()}}),e,this)}))),function(){return _.apply(this,arguments)})},{key:"setInitialValues",value:function(e){e||(e=this.defaultValuesObject()),e[Jt.Unwrapped]||(e[Jt.Unwrapped]={}),this.values=e}},{key:"isStorageWrapped",value:function(){var e=this.values[Jt.Wrapped];return!Object(u.p)(e)&&Object.keys(e).length>0}},{key:"canDecryptWithKey",value:(O=Xt(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.values[Jt.Wrapped],e.next=3,this.decryptWrappedValue(n,t);case 3:return r=e.sent,e.abrupt("return",!r.errorDecrypting);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return O.apply(this,arguments)})},{key:"decryptWrappedValue",value:(S=Xt(o.a.mark((function e(t,n){var r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.content_type){e.next=2;break}throw"Attempting to decrypt nonexistent wrapped value";case 2:return r=Object(j.e)(t,{content_type:P.a.EncryptedStorage}),e.next=5,this.encryptionDelegate.payloadByDecryptingPayload(r,n);case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return S.apply(this,arguments)})},{key:"decryptStorage",value:(x=Xt(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.values[Jt.Wrapped],e.next=3,this.decryptWrappedValue(t);case 3:if(!(n=e.sent).errorDecrypting){e.next=6;break}throw"Unable to decrypt storage.";case 6:this.values[Jt.Unwrapped]=Object(u.a)(n.contentObject),delete this.values[Jt.Wrapped];case 8:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"generatePersistenceValue",value:(k=Xt(o.a.mark((function e(){var t,n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object.assign({},this.values),n=t[Jt.Unwrapped],e.t0=j.e,e.next=5,h.GenerateUuid();case 5:return e.t1=e.sent,e.t2=n,e.t3=P.a.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},r=(0,e.t0)(e.t4),e.next=12,this.encryptionDelegate.payloadByEncryptingPayload(r,Gt.a.LocalStoragePreferEncrypted);case 12:return a=e.sent,t[Jt.Wrapped]=a.ejected(),t[Jt.Unwrapped]=void 0,e.abrupt("return",t);case 16:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"repersistToDisk",value:(w=Xt(o.a.mark((function e(){var t=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.storagePersistable){e.next=2;break}return e.abrupt("return");case 2:if(this.persistencePolicy!==Ht.Ephemeral){e.next=4;break}return e.abrupt("return");case 4:return e.abrupt("return",this.executeCriticalFunction(Xt(o.a.mark((function e(){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.generatePersistenceValue();case 2:return n=e.sent,t.values[Jt.Wrapped]=n[Jt.Wrapped],e.abrupt("return",t.deviceInterface.setRawStorageValue(t.getPersistenceKey(),JSON.stringify(n)));case 5:case"end":return e.stop()}}),e)})))));case 5:case"end":return e.stop()}}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"setValue",value:(g=Xt(o.a.mark((function e(t,n){var r,a=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>2&&void 0!==a[2]?a[2]:qt.Default,this.values){e.next=3;break}throw"Attempting to set storage key ".concat(t," before loading local storage.");case 3:return this.values[this.domainKeyForMode(r)][t]=n,e.abrupt("return",this.repersistToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)})},{key:"getValue",value:(m=Xt(o.a.mark((function e(t){var n,r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:qt.Default,this.values){e.next=3;break}throw"Attempting to get storage key ".concat(t," before loading local storage.");case 3:if(this.values[this.domainKeyForMode(n)]){e.next=5;break}throw"Storage domain mode not available ".concat(n," for key ").concat(t);case 5:return e.abrupt("return",this.values[this.domainKeyForMode(n)][t]);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"removeValue",value:(b=Xt(o.a.mark((function e(t){var n,r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:qt.Default,this.values){e.next=3;break}throw"Attempting to remove storage key ".concat(t," before loading local storage.");case 3:return delete this.values[this.domainKeyForMode(n)][t],e.abrupt("return",this.repersistToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"getPersistenceKey",value:function(){return Bt(this.namespace,Vt.StorageObject)}},{key:"defaultValuesObject",value:function(e,n,r){return t.defaultValuesObject(e,n,r)}},{key:"domainKeyForMode",value:function(e){if(e===qt.Default)return Jt.Unwrapped;if(e===qt.Nonwrapped)return Jt.Nonwrapped;throw"Invalid mode"}},{key:"clearValues",value:(v=Xt(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setInitialValues(),e.next=3,this.repersistToDisk();case 3:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"getAllRawPayloads",value:(d=Xt(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.getAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"savePayload",value:(y=Xt(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.savePayloads([t]));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"savePayloads",value:(p=Xt(o.a.mark((function e(t){var n,r,a,i,s,c,u,l,f=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy!==Ht.Ephemeral){e.next=2;break}return e.abrupt("return");case 2:n=[],r=!0,a=!1,i=void 0,e.prev=6,s=t[Symbol.iterator]();case 8:if(r=(c=s.next()).done){e.next=24;break}if(!(u=c.value).discardable){e.next=15;break}return e.next=13,this.deletePayloadWithId(u.uuid);case 13:e.next=21;break;case 15:if(u.uuid){e.next=17;break}throw Error("Attempting to persist payload with no uuid");case 17:return e.next=19,this.encryptionDelegate.payloadByEncryptingPayload(u,this.encryptionPolicy===zt.Default?Gt.a.LocalStoragePreferEncrypted:Gt.a.LocalStorageDecrypted);case 19:l=e.sent,n.push(l.ejected());case 21:r=!0,e.next=8;break;case 24:e.next=30;break;case 26:e.prev=26,e.t0=e.catch(6),a=!0,i=e.t0;case 30:e.prev=30,e.prev=31,r||null==s.return||s.return();case 33:if(e.prev=33,!a){e.next=36;break}throw i;case 36:return e.finish(33);case 37:return e.finish(30);case 38:return e.abrupt("return",this.executeCriticalFunction(Xt(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",f.deviceInterface.saveRawDatabasePayloads(n));case 1:case"end":return e.stop()}}),e)})))));case 39:case"end":return e.stop()}}),e,this,[[6,26,30,38],[31,,33,37]])}))),function(e){return p.apply(this,arguments)})},{key:"deletePayloads",value:(f=Xt(o.a.mark((function e(t){var n,r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,r=!1,a=void 0,e.prev=3,i=t[Symbol.iterator]();case 5:if(n=(s=i.next()).done){e.next=12;break}return c=s.value,e.next=9,this.deletePayloadWithId(c.uuid);case 9:n=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,a=e.t0;case 18:e.prev=18,e.prev=19,n||null==i.return||i.return();case 21:if(e.prev=21,!r){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return f.apply(this,arguments)})},{key:"deletePayloadWithId",value:(l=Xt(o.a.mark((function e(t){var n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeCriticalFunction(Xt(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n.deviceInterface.removeRawDatabasePayloadWithId(t));case 1:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"clearAllPayloads",value:(c=Xt(o.a.mark((function e(){var t=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeCriticalFunction(Xt(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.deviceInterface.removeAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"clearAllData",value:(s=Xt(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([this.clearValues(),this.clearAllPayloads()]));case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})}],i=[{key:"defaultValuesObject",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return an(e={},Jt.Wrapped,t),an(e,Jt.Unwrapped,n),an(e,Jt.Nonwrapped,r),e}}],r&&Zt(n.prototype,r),i&&Zt(n,i),t}(Qt.a);function sn(e){return(sn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function cn(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function un(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){cn(i,r,a,o,s,"next",e)}function s(e){cn(i,r,a,o,s,"throw",e)}o(void 0)}))}}function ln(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function fn(e,t){return!t||"object"!==sn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function pn(e,t,n){return(pn="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=hn(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function hn(e){return(hn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function yn(e,t){return(yn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var dn=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=fn(this,hn(t).call(this))).deviceInterface=e,n}var n,r,a,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&yn(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.deviceInterface=void 0,pn(hn(t.prototype),"deinit",this).call(this)}},{key:"alert",value:(s=un(o.a.mark((function e(t,n){var r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>2&&void 0!==r[2]&&r[2],r.length>3&&r[3],e.abrupt("return",new Promise((function(e,n){window.alert(t),e()})));case 3:case"end":return e.stop()}}),e)}))),function(e,t){return s.apply(this,arguments)})},{key:"confirm",value:(i=un(o.a.mark((function e(t,n){var r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>2&&void 0!==r[2]&&r[2],r.length>3&&void 0!==r[3]&&r[3],r.length>4&&r[4],r.length>5&&r[5],r.length>6&&void 0!==r[6]&&r[6],e.abrupt("return",new Promise((function(e,n){window.confirm(t)?e():n()})));case 6:case"end":return e.stop()}}),e)}))),function(e,t){return i.apply(this,arguments)})}])&&ln(n.prototype,r),a&&ln(n,a),t}(Qt.a);function vn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function bn(e,t,n){return t&&vn(e.prototype,t),n&&vn(e,n),e}function mn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var gn=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),mn(this,"accessToken",void 0),mn(this,"expireAt",void 0),mn(this,"refreshToken",void 0),mn(this,"validUntil",void 0),this.accessToken=t,this.expireAt=n,this.refreshToken=r,this.validUntil=a}return bn(e,null,[{key:"FromRaw",value:function(t){return new e(t.accessToken,t.expireAt,t.refreshToken,t.validUntil)}},{key:"FromResponse",value:function(t){var n,r,a;return new e(t.token,null===(n=t.session)||void 0===n?void 0:n.expire_at,null===(r=t.session)||void 0===r?void 0:r.refresh_token,null===(a=t.session)||void 0===a?void 0:a.valid_until)}}]),bn(e,[{key:"getExpireAt",value:function(){return this.expireAt||0}},{key:"canExpire",value:function(){return this.getExpireAt()>0}},{key:"isExpired",value:function(){return!!this.canExpire()&&this.getExpireAt()<Date.now()}}]),e}(),wn="Your account session is being renewed with the server. Please try your request again.",kn="This version of the application does not support your\n                                                      newer account type. Please upgrade to the latest version\n                                                      of Standard Notes to sign in.",xn="The protocol version associated with your account is\n                                                      outdated and no longer supported by this application.\n                                                      Please visit standardnotes.org/help/security for more\n                                                      information.",Sn="The encryption version for your account is outdated and\n                                                      requires upgrade. You may proceed with login, but are\n                                                      advised to perform a security update using the web or\n                                                      desktop application. Please visit\n                                                      standardnotes.org/help/security for more information.",On="Your account was created on a platform with higher security\n                                                      capabilities than this browser supports. If we attempted\n                                                      to generate your login keys here, it would take hours. Please\n                                                      use a browser with more up to date security capabilities,\n                                                      like Google Chrome or Firefox, to log in.",Pn="Unable to login due to insecure password parameters.\n                                                      Please visit standardnotes.org/help/security for\n                                                      more information.";function jn(e){return"\n          Your password must be at least ".concat(e," characters in length.\n          For your security, please choose a longer password or,\n          ideally, a passphrase, and try again.\n         ")}function _n(e,t){return"\n          Strict Sign In has refused the server's sign-in parameters.\n          The latest account version is ".concat(t,", but the server is reporting a \n          version of ").concat(e," for your account. If you'd like to proceed\n          with sign in anyway, please disable Strict Sign In and try again.\n          ")}function Cn(e){return(Cn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Dn(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function In(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Dn(i,r,a,o,s,"next",e)}function s(e){Dn(i,r,a,o,s,"throw",e)}o(void 0)}))}}function En(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Mn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Rn(e,t,n){return(Rn="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Tn(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Tn(e){return(Tn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function An(e,t){return(An=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Kn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Fn,Ln=function(e){function t(e,n,r,a){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),i=function(e,t){return!t||"object"!==Cn(t)&&"function"!=typeof t?Mn(e):t}(this,Tn(t).call(this)),Kn(Mn(i),"storageService",void 0),Kn(Mn(i),"apiService",void 0),Kn(Mn(i),"alertService",void 0),Kn(Mn(i),"protocolService",void 0),Kn(Mn(i),"user",void 0),i.protocolService=a,i.storageService=e,i.apiService=n,i.alertService=r,i}var n,r,a,i,s,c,l,f,p,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&An(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.alertService=void 0,this.user=void 0,Rn(Tn(t.prototype),"deinit",this).call(this)}},{key:"initializeFromDisk",value:(h=In(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Nt.User);case 2:if(this.user=e.sent,this.user){e.next=8;break}return e.next=6,this.storageService.getValue(Nt.LegacyUuid);case 6:(t=e.sent)&&(this.user={uuid:t});case 8:return e.next=10,this.storageService.getValue(Nt.Session);case 10:if(!(n=e.sent)){e.next=14;break}return e.next=14,this.setSession(gn.FromRaw(n),!1);case 14:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"setSession",value:(p=In(o.a.mark((function e(t){var n,r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=!(r.length>1&&void 0!==r[1])||r[1],e.next=3,this.apiService.setSession(t,n);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"online",value:function(){return!this.offline()}},{key:"offline",value:function(){return Object(u.p)(this.apiService.getSession())}},{key:"getUser",value:function(){return this.user}},{key:"signOut",value:(f=In(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.user=void 0,e.next=3,this.apiService.getSession();case 3:(t=e.sent)&&t.canExpire()&&this.apiService.signOut();case 5:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"register",value:(l=In(o.a.mark((function e(t,n){var r,a,i,s,c=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n.length<8)){e.next=2;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(jn(8))});case 2:return e.next=4,this.protocolService.createRootKey(t,n);case 4:return r=e.sent,a=r.key.serverPassword,i=r.keyParams,s=r.key,e.abrupt("return",this.apiService.register(t,a,i).then(function(){var e=In(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:i,rootKey:s});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"signIn",value:(c=In(o.a.mark((function e(t,n){var r,a,i,s,c,u,l,f,p,h,y,d,v=this,b=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=b.length>2&&void 0!==b[2]&&b[2],a=b.length>3?b[3]:void 0,i=b.length>4?b[4]:void 0,e.next=5,this.apiService.getAccountKeyParams(t,a,i);case 5:if(!(s=e.sent).error){e.next=8;break}return e.abrupt("return",{response:s});case 8:if(c={pw_cost:s.pw_cost,pw_nonce:s.pw_nonce,identifier:s.identifier,email:s.email,pw_salt:s.pw_salt,version:s.version},(u=this.protocolService.createKeyParams(c))&&u.version){e.next=12;break}return e.abrupt("return",{response:this.apiService.createErrorResponse("Invalid email or password.")});case 12:if(this.protocolService.supportedVersions().includes(u.version)){e.next=18;break}if(!this.protocolService.isVersionNewerThanLibraryVersion(u.version)){e.next=17;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(kn)});case 17:return e.abrupt("return",{response:this.apiService.createErrorResponse(xn)});case 18:if(!this.protocolService.isProtocolVersionOutdated(u.version)){e.next=29;break}if(l=this.protocolService.costMinimumForVersion(u.version),!(u.kdfIterations<l)){e.next=22;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(Pn)});case 22:return f=Sn,e.next=26,this.alertService.confirm(f,"Update Recommended","Sign In").catch((function(){}));case 26:if(e.sent){e.next=29;break}return e.abrupt("return",{response:this.apiService.createErrorResponse("Invalid email or password.")});case 29:if(this.protocolService.platformSupportsKeyDerivation(u)){e.next=31;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(On)});case 31:if(!r){e.next=35;break}if(p=this.protocolService.getLatestVersion(),u.version===p){e.next=35;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(_n(u.version,p))});case 35:return e.next=37,this.protocolService.computeRootKey(n,u).then((function(e){return{rootKey:e,serverPassword:e.serverPassword}}));case 37:return h=e.sent,y=h.rootKey,d=h.serverPassword,e.abrupt("return",this.apiService.signIn(t,d,a,i).then(function(){var e=In(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:u,rootKey:y});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 41:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"changePassword",value:(s=In(o.a.mark((function e(t,n,r){var a,i,s,c,u,l,f=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r.length<8)){e.next=2;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(jn(8))});case 2:return e.next=4,this.protocolService.computeRootKey(t,n).then((function(e){return e.serverPassword}));case 4:return a=e.sent,i=this.user.email,e.next=8,this.protocolService.createRootKey(i,r).then((function(e){return{newRootKey:e.key,newServerPassword:e.key.serverPassword,newKeyParams:e.keyParams}}));case 8:return s=e.sent,c=s.newServerPassword,u=s.newRootKey,l=s.newKeyParams,e.abrupt("return",this.apiService.changePassword(a,c,l).then(function(){var e=In(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:l,rootKey:u});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"handleAuthResponse",value:(i=In(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.error){e.next=2;break}return e.abrupt("return");case 2:return n=t.user,this.user=n,e.next=6,this.storageService.setValue(Nt.User,n);case 6:if(!t.token){e.next=10;break}return r=gn.FromResponse(t),e.next=10,this.setSession(r);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})}])&&En(n.prototype,r),a&&En(n,a),t}(Qt.a);function Vn(e){return(Vn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Nn(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Wn(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Nn(i,r,a,o,s,"next",e)}function s(e){Nn(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Un(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Bn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Hn(e,t){return!t||"object"!==Vn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function zn(e){return(zn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function qn(e,t){return(qn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}!function(e){e.Get="get",e.Post="post",e.Patch="patch"}(Fn||(Fn={}));var Jn,Gn=function(e){function t(){return Un(this,t),Hn(this,zn(t).apply(this,arguments))}var n,r,a,i,s,c,u,l;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qn(e,t)}(t,e),n=t,(r=[{key:"getAbsolute",value:(l=Wn(o.a.mark((function e(t,n,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp({url:t,params:n,verb:Fn.Get,authentication:r}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"postAbsolute",value:(u=Wn(o.a.mark((function e(t,n,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp({url:t,params:n,verb:Fn.Post,authentication:r}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"patchAbsolute",value:(c=Wn(o.a.mark((function e(t,n,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp({url:t,params:n,verb:Fn.Patch,authentication:r}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"runHttp",value:(s=Wn(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.createXmlRequest(t),e.abrupt("return",this.runRequest(n,t.verb,t.params));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"createXmlRequest",value:function(e){var t=new XMLHttpRequest;return e.params&&e.verb===Fn.Get&&Object.keys(e.params).length>0&&(e.url=this.urlForUrlAndParams(e.url,e.params)),t.open(e.verb,e.url,!0),t.setRequestHeader("Content-type","application/json"),e.authentication&&t.setRequestHeader("Authorization","Bearer "+e.authentication),t}},{key:"runRequest",value:(i=Wn(o.a.mark((function e(t,n,r){var a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,i){t.onreadystatechange=function(){a.stateChangeHandlerForRequest(t,e,i)},n===Fn.Post||n===Fn.Patch?t.send(JSON.stringify(r)):t.send()})));case 1:case"end":return e.stop()}}),e)}))),function(e,t,n){return i.apply(this,arguments)})},{key:"stateChangeHandlerForRequest",value:function(e,t,n){if(4===e.readyState){var r=e.status,a={status:r};try{var i=JSON.parse(e.responseText);Object.assign(a,i)}catch(e){}r>=200&&r<=299?t(a):(a.error||(a.error={status:r}),n(a))}}},{key:"urlForUrlAndParams",value:function(e,t){var n=Object.keys(t).map((function(e){return e+"="+encodeURIComponent(t[e])})).join("&");return e.includes("?")?e+"&"+n:e+"?"+n}},{key:"isErrorResponseExpiredToken",value:function(e){return 498===e.status}}])&&Bn(n.prototype,r),a&&Bn(n,a),t}(Qt.a);function Qn(e){return(Qn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function $n(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Yn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$n(Object(n),!0).forEach((function(t){ir(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$n(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Xn(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Zn(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Xn(i,r,a,o,s,"next",e)}function s(e){Xn(i,r,a,o,s,"throw",e)}o(void 0)}))}}function er(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function tr(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function nr(e,t,n){return(nr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=rr(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function rr(e){return(rr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ar(e,t){return(ar=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ir(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.LastSyncToken="sync_token",e.PaginationToken="cursor_token",e.IntegrityCheck="compute_integrity",e.IntegrityResult="integrity_hash",e.SyncDlLimit="limit",e.SyncPayloads="items",e.ApiVersion="api"}(Jn||(Jn={}));var or,sr,cr=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==Qn(t)&&"function"!=typeof t?tr(e):t}(this,rr(t).call(this)),ir(tr(r),"httpService",void 0),ir(tr(r),"storageService",void 0),ir(tr(r),"host",void 0),ir(tr(r),"session",void 0),ir(tr(r),"registering",!1),ir(tr(r),"authenticating",!1),ir(tr(r),"changing",!1),ir(tr(r),"refreshingSession",!1),r.httpService=e,r.storageService=n,r}var n,r,a,i,s,c,l,f,p,h,y,d,v,b,m,g;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ar(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.httpService=void 0,this.storageService=void 0,this.host=void 0,this.session=void 0,nr(rr(t.prototype),"deinit",this).call(this)}},{key:"loadHost",value:(g=Zn(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Nt.ServerHost);case 2:t=e.sent,this.host=t||window._default_sync_server;case 4:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"setHost",value:(m=Zn(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.host=t,e.next=3,this.storageService.setValue(Nt.ServerHost,t);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"getHost",value:(b=Zn(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.host);case 1:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"setSession",value:(v=Zn(o.a.mark((function e(t){var n,r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=!(r.length>1&&void 0!==r[1])||r[1],this.session=t,!n){e.next=5;break}return e.next=5,this.storageService.setValue(Nt.Session,t);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"getSession",value:function(){return this.session}},{key:"path",value:(d=Zn(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getHost();case 2:if(n=e.sent){e.next=5;break}throw"Attempting to build path ".concat(t," with no host.");case 5:if(t){e.next=7;break}throw"Attempting to build path with null path.";case 7:return e.abrupt("return",Object(u.u)(n,t));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"params",value:function(e){var t=Ae()(e,ir({},Jn.ApiVersion,"20200115"));return t}},{key:"createErrorResponse",value:function(e){return{error:{message:e}}}},{key:"errorResponseWithFallbackMessage",value:function(e,t){return e.error.message||(e.error.message=t),e}},{key:"getAccountKeyParams",value:(y=Zn(o.a.mark((function e(t,n,r){var a,i,s,c=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.path("/auth/params");case 2:return a=e.sent,i=this.params({email:t}),n&&(i[n]=r),e.next=7,this.httpService.getAbsolute(a,i).catch((function(e){return c.errorResponseWithFallbackMessage(e,"A server error occurred while trying to sign in. Please try again.")}));case 7:return s=e.sent,e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return y.apply(this,arguments)})},{key:"register",value:(h=Zn(o.a.mark((function e(t,n,r){var a,i,s,c=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.registering){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing registration request is already in progress."));case 2:return this.registering=!0,e.next=5,this.path("/auth");case 5:return a=e.sent,i=this.params(Yn({password:n,email:t},r.getPortableValue())),e.next=9,this.httpService.postAbsolute(a,i).catch((function(e){return c.errorResponseWithFallbackMessage(e,"A server error occurred while trying to register. Please try again.")}));case 9:return s=e.sent,this.registering=!1,e.abrupt("return",s);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return h.apply(this,arguments)})},{key:"signIn",value:(p=Zn(o.a.mark((function e(t,n,r,a){var i,s,c,u=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.authenticating){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing sign in request is already in progress."));case 2:return this.authenticating=!0,e.next=5,this.path("/auth/sign_in");case 5:return i=e.sent,s=this.params({email:t,password:n}),r&&(s[r]=a),e.next=10,this.httpService.postAbsolute(i,s).catch((function(e){return u.errorResponseWithFallbackMessage(e,"A server error occurred while trying to sign in. Please try again.")}));case 10:return c=e.sent,this.authenticating=!1,e.abrupt("return",c);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return p.apply(this,arguments)})},{key:"signOut",value:(f=Zn(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.path("/auth/sign_out");case 2:return t=e.sent,e.abrupt("return",this.httpService.postAbsolute(t,void 0,this.session.accessToken));case 4:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"changePassword",value:(l=Zn(o.a.mark((function e(t,n,r){var a,i,s,c=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.changing){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing change password request is already in progress."));case 2:if(!this.refreshingSession){e.next=4;break}return e.abrupt("return",this.createErrorResponse(wn));case 4:return this.changing=!0,e.next=7,this.path("/auth/change_pw");case 7:return a=e.sent,i=this.params(Yn({current_password:t,new_password:n},r.getPortableValue())),e.next=11,this.httpService.postAbsolute(a,i,this.session.accessToken).catch(function(){var e=Zn(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!c.httpService.isErrorResponseExpiredToken(t)){e.next=2;break}return e.abrupt("return",c.refreshSessionThenRetryRequest({verb:Fn.Post,url:a,params:i}));case 2:return e.abrupt("return",c.errorResponseWithFallbackMessage(t,"Something went wrong while changing your password.\n                                                      Your password was not changed. Please try again."));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:return s=e.sent,this.changing=!1,e.abrupt("return",s);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"sync",value:(c=Zn(o.a.mark((function e(t,n,r,a){var i,s,c,u,l,f,p,h=this,y=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=y.length>4&&void 0!==y[4]&&y[4],c=y.length>5?y[5]:void 0,u=y.length>6?y[6]:void 0,!this.refreshingSession){e.next=5;break}return e.abrupt("return",this.createErrorResponse(wn));case 5:return e.next=7,this.path("/items/sync");case 7:return l=e.sent,f=this.params((ir(i={},Jn.SyncPayloads,t.map((function(e){return e.ejected()}))),ir(i,Jn.LastSyncToken,n),ir(i,Jn.PaginationToken,r),ir(i,Jn.IntegrityCheck,s),ir(i,Jn.SyncDlLimit,a),ir(i,"content_type",c),ir(i,"event",u),i)),e.next=11,this.httpService.postAbsolute(l,f,this.session.accessToken).catch(function(){var e=Zn(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!h.httpService.isErrorResponseExpiredToken(t)){e.next=2;break}return e.abrupt("return",h.refreshSessionThenRetryRequest({verb:Fn.Post,url:l,params:f}));case 2:return e.abrupt("return",h.errorResponseWithFallbackMessage(t,"Could not connect to server."));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:return p=e.sent,e.abrupt("return",p);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return c.apply(this,arguments)})},{key:"refreshSessionThenRetryRequest",value:(s=Zn(o.a.mark((function e(t){var n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.refreshSession().then((function(e){return(null==e?void 0:e.error)?e:n.httpService.runHttp(Yn({},t,{authentication:n.session.accessToken}))})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"refreshSession",value:(i=Zn(o.a.mark((function e(){var t,n,r,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.refreshingSession){e.next=2;break}return e.abrupt("return",this.createErrorResponse(wn));case 2:return this.refreshingSession=!0,e.next=5,this.path("/session/refresh");case 5:return t=e.sent,n=this.params({access_token:this.session.accessToken,refresh_token:this.session.refreshToken}),e.next=9,this.httpService.postAbsolute(t,n).then(function(){var e=Zn(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=gn.FromResponse(t),e.next=3,a.setSession(n);case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){return a.errorResponseWithFallbackMessage(e,"A server error occurred while trying to refresh your session.\n                                                      Please try again.")}));case 9:return r=e.sent,this.refreshingSession=!1,e.abrupt("return",r);case 12:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})}])&&er(n.prototype,r),a&&er(n,a),t}(Qt.a),ur=n(18),lr=n.n(ur),fr=n(23),pr=n.n(fr),hr=n(20),yr=n.n(hr);function dr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function vr(e){return{"mac-web":sr.MacWeb,"mac-desktop":sr.MacDesktop,"linux-web":sr.LinuxWeb,"linux-desktop":sr.LinuxDesktop,"windows-web":sr.WindowsWeb,"windows-desktop":sr.WindowsDesktop,ios:sr.Ios,android:sr.Android}[e]}function br(e){return e===or.Web||e===or.Desktop}function mr(e){return e===or.Mobile}function gr(e){return(gr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function wr(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function kr(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){wr(i,r,a,o,s,"next",e)}function s(e){wr(i,r,a,o,s,"throw",e)}o(void 0)}))}}function xr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Sr(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Or(e,t,n){return(Or="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Pr(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Pr(e){return(Pr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function jr(e,t){return(jr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.Web=1]="Web",e[e.Desktop=2]="Desktop",e[e.Mobile=3]="Mobile"}(or||(or={})),function(e){e[e.Ios=1]="Ios",e[e.Android=2]="Android",e[e.MacWeb=3]="MacWeb",e[e.MacDesktop=4]="MacDesktop",e[e.WindowsWeb=5]="WindowsWeb",e[e.WindowsDesktop=6]="WindowsDesktop",e[e.LinuxWeb=7]="LinuxWeb",e[e.LinuxDesktop=8]="LinuxDesktop"}(sr||(sr={}));var Cr="org.standardnotes.sn.components",Dr=function(e){function t(e,n,r,a,i,o){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s=function(e,t){return!t||"object"!==gr(t)&&"function"!=typeof t?Sr(e):t}(this,Pr(t).call(this)),_r(Sr(s),"itemManager",void 0),_r(Sr(s),"syncService",void 0),_r(Sr(s),"alertService",void 0),_r(Sr(s),"environment",void 0),_r(Sr(s),"platform",void 0),_r(Sr(s),"timeout",void 0),_r(Sr(s),"desktopManager",void 0),_r(Sr(s),"componentState",{}),_r(Sr(s),"removeItemObserver",void 0),_r(Sr(s),"streamObservers",[]),_r(Sr(s),"contextStreamObservers",[]),_r(Sr(s),"activeComponents",[]),_r(Sr(s),"permissionDialogs",[]),_r(Sr(s),"handlers",[]),_r(Sr(s),"detectFocusChange",(function(){var e=s.itemManager.findItems(s.activeComponents),t=!0,n=!1,r=void 0;try{for(var a,i=function(){var e=a.value;if(document.activeElement===s.iframeForComponent(e.uuid))return s.timeout((function(){s.focusChangedForComponent(e)})),"break"},o=e[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){if("break"===i())break}}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}})),_r(Sr(s),"onWindowMessage",(function(e){e.data.sessionKey&&(s.log("Component manager received message",e.data),s.handleMessage(s.componentForSessionKey(e.data.sessionKey),e.data))})),s.timeout=o||setTimeout.bind(window),s.itemManager=e,s.syncService=n,s.alertService=r,s.environment=a,s.platform=i,s.configureForGeneralUsage(),a!==or.Mobile&&s.configureForNonMobileUsage(),s}var n,r,a,i,c,l,f,p,y,d;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&jr(e,t)}(t,e),n=t,(r=[{key:"componentsForArea",value:function(e){return this.components.filter((function(t){return t.area===e}))}},{key:"deinit",value:function(){Or(Pr(t.prototype),"deinit",this).call(this),this.streamObservers.length=0,this.contextStreamObservers.length=0,this.activeComponents.length=0,this.permissionDialogs.length=0,this.handlers.length=0,this.itemManager=void 0,this.syncService=void 0,this.alertService=void 0,this.removeItemObserver(),this.removeItemObserver=null,window&&(window.removeEventListener("focus",this.detectFocusChange,!0),window.removeEventListener("blur",this.detectFocusChange,!0),window.removeEventListener("message",this.onWindowMessage))}},{key:"setDesktopManager",value:function(e){this.desktopManager=e,this.configureForDesktop()}},{key:"configureForGeneralUsage",value:function(){var e=this;this.removeItemObserver=this.itemManager.addObserver(P.a.Any,(function(t,n,r,a,i){var o=Object(u.f)(t,n,r),s=o.filter((function(e){return e.content_type===P.a.Component||e.content_type===P.a.Theme}));s.length>0&&a!==_.a.RemoteSaved&&e.isDesktop&&e.desktopManager.syncComponentsInstallation(s);var c=!0,l=!1,f=void 0;try{for(var p,h=s[Symbol.iterator]();!(c=(p=h.next()).done);c=!0){var y=p.value,d=e.activeComponents.includes(y.uuid);!y.active||y.deleted||d?!y.active&&d&&e.deactivateComponent(y.uuid):e.activateComponent(y.uuid)}}catch(e){l=!0,f=e}finally{try{c||null==h.return||h.return()}finally{if(l)throw f}}a!==_.a.LocalChanged&&e.notifyStreamObservers(o,a,i)}))}},{key:"notifyStreamObservers",value:function(e,t,n){var r=this,a=!0,i=!1,o=void 0;try{for(var s,c=function(){var t=s.value;if(n&&n===t.componentUuid)return"continue";var a=e.filter((function(e){return-1!==t.contentTypes.indexOf(e.content_type)}));if(0===a.length)return"continue";var i=[{name:Z.StreamItems,content_types:t.contentTypes.sort()}];r.runWithPermissions(t.componentUuid,i,(function(){r.sendItemsInReply(t.componentUuid,a,t.originalMessage)}))},u=this.streamObservers[Symbol.iterator]();!(a=(s=u.next()).done);a=!0)c()}catch(e){i=!0,o=e}finally{try{a||null==u.return||u.return()}finally{if(i)throw o}}var l=[{name:Z.StreamContextItem}],f=!0,p=!1,h=void 0;try{for(var y,d=function(){var a=y.value;if(n&&n===a.componentUuid)return"continue";var i=!0,o=!1,s=void 0;try{for(var c,u=r.handlers[Symbol.iterator]();!(i=(c=u.next()).done);i=!0){var f=c.value;if((f.areas.includes(a.area)||f.areas.includes(X.Any))&&f.contextRequestHandler){var p=f.contextRequestHandler(a.componentUuid);if(p&&"continue"===function(){var n=lr()(e,{uuid:p.uuid});if(n){if(n.deleted)return"continue";r.runWithPermissions(a.componentUuid,l,(function(){r.sendContextItemInReply(a.componentUuid,n,a.originalMessage,t)}))}}())continue}}}catch(e){o=!0,s=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw s}}},v=this.contextStreamObservers[Symbol.iterator]();!(f=(y=v.next()).done);f=!0)d()}catch(e){p=!0,h=e}finally{try{f||null==v.return||v.return()}finally{if(p)throw h}}}},{key:"isNativeExtension",value:function(e){var t=[window._extensions_manager_location,window._batch_manager_location],n=e.hosted_url,r=e.local_url&&e.local_url.replace("sn://","");return t.includes(n)||t.includes(r)}},{key:"configureForNonMobileUsage",value:function(){window.addEventListener?window.addEventListener("focus",this.detectFocusChange,!0):window.attachEvent("onfocusout",this.detectFocusChange),window.addEventListener?window.addEventListener("blur",this.detectFocusChange,!0):window.attachEvent("onblur",this.detectFocusChange),window.addEventListener("message",this.onWindowMessage)}},{key:"configureForDesktop",value:function(){var e=this;this.desktopManager.registerUpdateObserver((function(t){t.active&&t.isTheme()&&e.postActiveThemesToAllComponents()}))}},{key:"postActiveThemesToAllComponents",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,a=this.components[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var i=r.value,o=this.findOrCreateDataForComponent(i);!i.isTheme()&&i.active&&o.window&&this.postActiveThemesToComponent(i)}}catch(e){t=!0,n=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw n}}}},{key:"getActiveThemes",value:function(){return this.componentsForArea(X.Themes).filter((function(e){return e.active}))}},{key:"urlsForActiveThemes",value:function(){var e=this.getActiveThemes(),t=[],n=!0,r=!1,a=void 0;try{for(var i,o=e[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value,c=this.urlForComponent(s);c&&t.push(c)}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}return t}},{key:"postActiveThemesToComponent",value:function(e){var t={themes:this.urlsForActiveThemes()},n={action:Z.ActivateThemes,data:t};this.sendMessageToComponent(e,n)}},{key:"contextItemDidChangeInArea",value:function(e){var t=!0,n=!1,r=void 0;try{for(var a,i=this.handlers[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var o=a.value;if(o.areas.includes(e)||o.areas.includes(X.Any)){var s=this.contextStreamObservers.filter((function(t){return t.area===e})),c=!0,u=!1,l=void 0;try{for(var f,p=s[Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var h=f.value;if(o.contextRequestHandler){var y=o.contextRequestHandler(h.componentUuid);y&&this.sendContextItemInReply(h.componentUuid,y,h.originalMessage)}}}catch(e){u=!0,l=e}finally{try{c||null==p.return||p.return()}finally{if(u)throw l}}}}}catch(e){n=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(n)throw r}}}},{key:"isComponentHidden",value:function(e){return this.findOrCreateDataForComponent(e).hidden}},{key:"setComponentHidden",value:function(e,t){var n=this.findOrCreateDataForComponent(e);if(t)n.hidden=!0;else if(n.hidden){n.hidden=!1;var r=lr()(this.contextStreamObservers,{identifier:e.uuid});r&&this.handleStreamContextItemMessage(e,r.originalMessage);var a=lr()(this.streamObservers,{identifier:e.uuid});a&&this.handleStreamItemsMessage(e,a.originalMessage)}}},{key:"jsonForItem",value:function(e,t,n){var r=n===_.a.RemoteSaved||n===_.a.LocalSaved,a=(e.getDomainData(Cr)||{})[t.getClientDataKey()]||{},i={uuid:e.uuid,content_type:e.content_type,created_at:e.created_at,updated_at:e.updated_at,deleted:e.deleted,isMetadataUpdate:r,content:e.content,clientData:a};return this.removePrivatePropertiesFromResponseItems([i],t),i}},{key:"sendItemsInReply",value:function(e,t,n,r){var a=this,i=this.itemManager.findItem(e);this.log("Component manager send items in reply",i,t,n);var o={},s=t.map((function(e){return a.jsonForItem(e,i,r)}));o.items=s,this.replyToMessage(i,n,o)}},{key:"sendContextItemInReply",value:function(e,t,n,r){var a=this.itemManager.findItem(e);this.log("Component manager send context item in reply",a,t,n);var i={item:this.jsonForItem(t,a,r)};this.replyToMessage(a,n,i)}},{key:"replyToMessage",value:function(e,t,n){var r={action:Z.Reply,original:t,data:n};this.sendMessageToComponent(e,r)}},{key:"sendMessageToComponent",value:function(e,t){var n=[Z.ComponentRegistered,Z.ActivateThemes],r=this.findOrCreateDataForComponent(e);if(!r.hidden||n.includes(t.action)){this.log("Component manager send message to component",e,t);var a=this.urlForComponent(e);a&&r.window||this.alertService.alert("Standard Notes is trying to communicate with ".concat(e.name,", \n        but an error is occurring. Please restart this extension and try again.")),a.startsWith("http")||a.startsWith("file")||(a=window.location.href+a),r.window.postMessage(this.isMobile?JSON.stringify(t):t,a)}else this.log("Component disabled for current item, ignoring messages.",e.name)}},{key:"urlForComponent",value:function(e){if(e.offlineOnly&&!this.isDesktop)return null;if(e.offlineOnly||this.isDesktop&&e.local_url)return e.local_url&&e.local_url.replace("sn://",this.desktopManager.getExtServerHost());var t=e.hosted_url||e.legacy_url;if(this.isMobile){var n=this.platform===sr.Ios?"localhost":"10.0.2.2";t=t.replace("localhost",n).replace("sn.local",n)}return t}},{key:"componentForUrl",value:function(e){return this.components.filter((function(t){return t.hosted_url===e||t.legacy_url===e}))[0]}},{key:"sessionKeyForComponent",value:function(e){return this.findOrCreateDataForComponent(e).sessionKey}},{key:"componentForSessionKey",value:function(e){for(var t,n=this,r=function(){var r=i[a],o=n.componentState[r];if((null==o?void 0:o.sessionKey)===e)return t=n.components.find((function(e){return e.uuid===r})),"break"},a=0,i=Object.keys(this.componentState);a<i.length&&"break"!==r();a++);if(!t){var o=!0,s=!1,c=void 0;try{for(var u,l=this.handlers[Symbol.iterator]();!(o=(u=l.next()).done);o=!0){var f=u.value;if(f.componentForSessionKeyHandler&&(t=f.componentForSessionKeyHandler(e)))break}}catch(e){s=!0,c=e}finally{try{o||null==l.return||l.return()}finally{if(s)throw c}}}return t}},{key:"handleMessage",value:function(e,t){var n=this;if(!e)return this.log("Component not defined for message, returning",t),void this.alertService.alert("An extension is trying to communicate with Standard Notes,but there is an error establishing a bridge. Please restart the app and try again.");var r=[Z.SaveItems,Z.AssociateItem,Z.DeassociateItem,Z.CreateItem,Z.CreateItems,Z.DeleteItems,Z.SetComponentData];if(this.getReadonlyStateForComponent(e).readonly&&r.includes(t.action))this.alertService.alert("The extension ".concat(e.name," is trying to save, but it is in a locked state and cannot accept changes."));else{if(t.action===Z.StreamItems)this.handleStreamItemsMessage(e,t);else if(t.action===Z.StreamContextItem)this.handleStreamContextItemMessage(e,t);else if(t.action===Z.SetComponentData)this.handleSetComponentDataMessage(e,t);else if(t.action===Z.DeleteItems)this.handleDeleteItemsMessage(e,t);else if(t.action===Z.CreateItems||t.action===Z.CreateItem)this.handleCreateItemsMessage(e,t);else if(t.action===Z.SaveItems)this.handleSaveItemsMessage(e,t);else if(t.action===Z.ToggleActivateComponent){var a=this.itemManager.findItem(t.data.uuid);this.handleToggleComponentMessage(a,t)}else t.action===Z.RequestPermissions?this.handleRequestPermissionsMessage(e,t):t.action===Z.InstallLocalComponent?this.handleInstallLocalComponentMessage(e,t):t.action===Z.DuplicateItem&&this.handleDuplicateItemMessage(e,t);var i=!0,o=!1,s=void 0;try{for(var c,u=function(){var r=c.value;r.actionHandler&&(r.areas.includes(e.area)||r.areas.includes(X.Any))&&n.timeout((function(){r.actionHandler(e,t.action,t.data)}))},l=this.handlers[Symbol.iterator]();!(i=(c=l.next()).done);i=!0)u()}catch(e){o=!0,s=e}finally{try{i||null==l.return||l.return()}finally{if(o)throw s}}}}},{key:"removePrivatePropertiesFromResponseItems",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t||!this.isNativeExtension(t)){var r=["autoupdateDisabled","permissions","active"];n&&(r=r.concat(["url","hosted_url","local_url"]));var a=!0,i=!1,o=void 0;try{for(var s,c=e[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var u=s.value,l=!0,f=!1,p=void 0;try{for(var h,y=r[Symbol.iterator]();!(l=(h=y.next()).done);l=!0){var d=h.value;delete u.content[d]}}catch(e){f=!0,p=e}finally{try{l||null==y.return||y.return()}finally{if(f)throw p}}}}catch(e){i=!0,o=e}finally{try{a||null==c.return||c.return()}finally{if(i)throw o}}}}},{key:"handleStreamItemsMessage",value:function(e,t){var n=this,r=[{name:Z.StreamItems,content_types:t.data.content_types.sort()}];this.runWithPermissions(e.uuid,r,(function(){lr()(n.streamObservers,{identifier:e.uuid})||n.streamObservers.push({identifier:e.uuid,componentUuid:e.uuid,area:e.area,originalMessage:t,contentTypes:t.data.content_types});var r=[],a=!0,i=!1,o=void 0;try{for(var s,c=t.data.content_types[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var l=s.value;Object(u.j)(r,n.itemManager.nonErroredItemsForContentType(l))}}catch(e){i=!0,o=e}finally{try{a||null==c.return||c.return()}finally{if(i)throw o}}n.sendItemsInReply(e.uuid,r,t)}))}},{key:"handleStreamContextItemMessage",value:function(e,t){var n=this,r=[{name:Z.StreamContextItem}];this.runWithPermissions(e.uuid,r,(function(){lr()(n.contextStreamObservers,{identifier:e.uuid})||n.contextStreamObservers.push({identifier:e.uuid,componentUuid:e.uuid,area:e.area,originalMessage:t});var r=!0,a=!1,i=void 0;try{for(var o,s=n.handlersForArea(e.area)[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value;if(c.contextRequestHandler){var u=c.contextRequestHandler(e.uuid);u&&n.sendContextItemInReply(e.uuid,u,t)}}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}}))}},{key:"isItemIdWithinComponentContextJurisdiction",value:function(e,t){return this.itemIdsInContextJurisdictionForComponent(t).includes(e)}},{key:"itemIdsInContextJurisdictionForComponent",value:function(e){var t=[],n=!0,r=!1,a=void 0;try{for(var i,o=this.handlersForArea(e.area)[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;if(s.contextRequestHandler){var c=s.contextRequestHandler(e.uuid);c&&t.push(c.uuid)}}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}return t}},{key:"handlersForArea",value:function(e){return this.handlers.filter((function(t){return t.areas.includes(e)}))}},{key:"handleSaveItemsMessage",value:(d=kr(o.a.mark((function e(t,n){var r,a,i,c,l,f,p,h,y,d,b,m=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=n.data.items,a=[],i=this.itemIdsInContextJurisdictionForComponent(t),c=r.slice(),l=!0,f=!1,p=void 0,e.prev=7,h=r.slice()[Symbol.iterator]();case 9:if(l=(y=h.next()).done){e.next=18;break}if(d=y.value,!i.includes(d.uuid)){e.next=15;break}return a.push({name:Z.StreamContextItem}),Object(u.B)(c,d),e.abrupt("break",18);case 15:l=!0,e.next=9;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(7),f=!0,p=e.t0;case 24:e.prev=24,e.prev=25,l||null==h.return||h.return();case 27:if(e.prev=27,!f){e.next=30;break}throw p;case 30:return e.finish(27);case 31:return e.finish(24);case 32:c.length>0&&(b=pr()(c.map((function(e){return e.content_type}))).sort(),a.push({name:Z.StreamItems,content_types:b})),this.runWithPermissions(t.uuid,a,kr(o.a.mark((function e(){var a,i,c,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(m.removePrivatePropertiesFromResponseItems(r,t,!0),a=Object(s.b)(r),i=m.itemManager.findItems(a,!0),c=0,i.forEach((function(e,n){if(e)e.locked&&(yr()(r,{uuid:e.uuid}),c++);else{var a=r[n];m.alertService.alert("The extension ".concat(t.name," is trying to save an item with type ")+"".concat(a.content_type,", but that item does not exist .")+"Please restart this extension and try again.")}})),!(c>0)){e.next=10;break}return l=1===c?"item":"items",f=1===c?"is":"are",m.alertService.alert("".concat(c," ").concat(l," you are attempting to save ").concat(f," locked and cannot be edited."),"Items Locked"),e.abrupt("return");case 10:return p=r.map((function(e){return Object(j.f)(e,_.a.ComponentRetrieved)})),e.next=13,m.itemManager.changeItems(a,(function(e){var n=Object(u.D)(p,{uuid:e.getUuid()});e.mergePayload(n);var a=Object(u.D)(r,{uuid:e.getUuid()});if(a.clientData){var i=Object(u.a)(e.getItem().getDomainData(Cr)||{});i[t.getClientDataKey()]=a.clientData,e.setDomainData(i,Cr)}}),v.c.UserInteraction,_.a.ComponentRetrieved,t.uuid);case 13:m.syncService.sync().then((function(){var e=Object.assign({},n);e.action=Z.SaveSuccess,m.replyToMessage(t,n,{}),m.handleMessage(t,e)})).catch((function(){var e=Object.assign({},n);e.action=Z.SaveError,m.replyToMessage(t,n,{error:Z.SaveError}),m.handleMessage(t,e)}));case 14:case"end":return e.stop()}}),e)}))));case 34:case"end":return e.stop()}}),e,this,[[7,20,24,32],[25,,27,31]])}))),function(e,t){return d.apply(this,arguments)})},{key:"handleDuplicateItemMessage",value:function(e,t){var n=this,r=t.data.item,a=this.itemManager.findItem(r.uuid),i=[{name:Z.StreamItems,content_types:[a.content_type]}];this.runWithPermissions(e.uuid,i,kr(o.a.mark((function r(){var i;return o.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.itemManager.duplicateItem(a.uuid);case 2:i=r.sent,n.syncService.sync(),n.replyToMessage(e,t,{item:n.jsonForItem(i,e)});case 5:case"end":return r.stop()}}),r)}))))}},{key:"handleCreateItemsMessage",value:function(e,t){var n=this,r=t.data.item?[t.data.item]:t.data.items,a=pr()(r.map((function(e){return e.content_type}))),i=[{name:Z.StreamItems,content_types:a}];this.runWithPermissions(e.uuid,i,kr(o.a.mark((function a(){var i,s,c,l,f,p,y,d;return o.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:n.removePrivatePropertiesFromResponseItems(r,e),i=[],s=!0,c=!1,l=void 0,a.prev=5,f=o.a.mark((function t(){var r,a,s,c;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((r=y.value).uuid){t.next=5;break}return t.next=4,h.GenerateUuid();case 4:r.uuid=t.sent;case 5:return a=Object(j.f)(r,_.a.ComponentCreated),s=Ut(a),t.next=9,n.itemManager.insertItem(s);case 9:return c=t.sent,t.next=12,n.itemManager.changeItem(c.uuid,(function(t){if(r.clientData){var n=Object(u.a)(c.getDomainData(Cr)||{});n[e.getClientDataKey()]=r.clientData,t.setDomainData(n,Cr)}}),v.c.UserInteraction,_.a.ComponentCreated,e.uuid);case 12:i.push(c);case 13:case"end":return t.stop()}}),t)})),p=r[Symbol.iterator]();case 8:if(s=(y=p.next()).done){a.next=13;break}return a.delegateYield(f(),"t0",10);case 10:s=!0,a.next=8;break;case 13:a.next=19;break;case 15:a.prev=15,a.t1=a.catch(5),c=!0,l=a.t1;case 19:a.prev=19,a.prev=20,s||null==p.return||p.return();case 22:if(a.prev=22,!c){a.next=25;break}throw l;case 25:return a.finish(22);case 26:return a.finish(19);case 27:n.syncService.sync(),d=t.action===Z.CreateItem?{item:n.jsonForItem(i[0],e)}:{items:i.map((function(t){return n.jsonForItem(t,e)}))},n.replyToMessage(e,t,d);case 30:case"end":return a.stop()}}),a,null,[[5,15,19,27],[20,,22,26]])}))))}},{key:"handleDeleteItemsMessage",value:function(e,t){var n=this,r=pr()(t.data.items.map((function(e){return e.content_type}))).sort(),a=[{name:Z.StreamItems,content_types:r}];this.runWithPermissions(e.uuid,a,kr(o.a.mark((function r(){var a,i,s,c,u,l,f,p,h,y,d;return o.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=t.data.items,i=1===a.length?"item":"items",s=null,c=!0,r.next=6,n.alertService.confirm("Are you sure you want to delete ".concat(a.length," ").concat(i,"?")).catch((function(){c=!1}));case 6:if(!c){r.next=44;break}u=!0,l=!1,f=void 0,r.prev=10,p=a[Symbol.iterator]();case 12:if(u=(h=p.next()).done){r.next=26;break}if(y=h.value,d=n.itemManager.findItem(y.uuid)){r.next=18;break}return n.alertService.alert("The item you are trying to delete cannot be found."),r.abrupt("continue",23);case 18:if(![P.a.Component,P.a.Theme].includes(d.content_type)){r.next=21;break}return r.next=21,n.deactivateComponent(d.uuid);case 21:return r.next=23,n.itemManager.setItemToBeDeleted(d.uuid);case 23:u=!0,r.next=12;break;case 26:r.next=32;break;case 28:r.prev=28,r.t0=r.catch(10),l=!0,f=r.t0;case 32:r.prev=32,r.prev=33,u||null==p.return||p.return();case 35:if(r.prev=35,!l){r.next=38;break}throw f;case 38:return r.finish(35);case 39:return r.finish(32);case 40:n.syncService.sync(),s={deleted:!0},r.next=45;break;case 44:s={deleted:!1};case 45:n.replyToMessage(e,t,s);case 46:case"end":return r.stop()}}),r,null,[[10,28,32,40],[33,,35,39]])}))))}},{key:"handleRequestPermissionsMessage",value:function(e,t){var n=this;this.runWithPermissions(e.uuid,t.data.permissions,(function(){n.replyToMessage(e,t,{approved:!0})}))}},{key:"handleSetComponentDataMessage",value:function(e,t){var n=this;this.runWithPermissions(e.uuid,[],kr(o.a.mark((function r(){return o.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.itemManager.changeComponent(e.uuid,(function(e){e.componentData=t.data.componentData}));case 2:n.syncService.sync();case 3:case"end":return r.stop()}}),r)}))))}},{key:"handleToggleComponentMessage",value:function(e,t){this.toggleComponent(e)}},{key:"toggleComponent",value:(y=kr(o.a.mark((function e(t){var n,r,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.area!==X.Modal){e.next=4;break}this.openModalComponent(t),e.next=19;break;case 4:if(!t.active){e.next=9;break}return e.next=7,this.deactivateComponent(t.uuid);case 7:e.next=19;break;case 9:if(t.content_type!==P.a.Theme){e.next=17;break}return n=t,r=this.getActiveThemes(),e.next=14,this.activateComponent(t.uuid);case 14:n.isLayerable()||setTimeout(kr(o.a.mark((function e(){var t,n,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,n=!1,i=void 0,e.prev=3,s=r[Symbol.iterator]();case 5:if(t=(c=s.next()).done){e.next=13;break}if(!(u=c.value)||u.isLayerable()){e.next=10;break}return e.next=10,a.deactivateComponent(u.uuid);case 10:t=!0,e.next=5;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(3),n=!0,i=e.t0;case 19:e.prev=19,e.prev=20,t||null==s.return||s.return();case 22:if(e.prev=22,!n){e.next=25;break}throw i;case 25:return e.finish(22);case 26:return e.finish(19);case 27:case"end":return e.stop()}}),e,null,[[3,15,19,27],[20,,22,26]])}))),10),e.next=19;break;case 17:return e.next=19,this.activateComponent(t.uuid);case 19:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"handleInstallLocalComponentMessage",value:function(e,t){if(this.isNativeExtension(e)){var n=this.itemManager.findItem(t.data.uuid);this.desktopManager.installComponent(n)}}},{key:"runWithPermissions",value:function(e,t,n){var r=this.itemManager.findItem(e);t=Object(u.a)(t);var a=r.permissions,i=!0,s=!1,c=void 0;try{for(var l,f=function(){var e=l.value,n=a.find((function(t){return t.name===e.name}));if(!n)return"continue";var r=e.content_types;if(!r)return Object(u.k)(t,e),"continue";var i=!0,o=!1,s=void 0;try{for(var c,f=n.content_types[Symbol.iterator]();!(i=(c=f.next()).done);i=!0){var p=c.value;Object(u.B)(r,p)}}catch(e){o=!0,s=e}finally{try{i||null==f.return||f.return()}finally{if(o)throw s}}0===r.length&&Object(u.k)(t,e)},p=t.slice()[Symbol.iterator]();!(i=(l=p.next()).done);i=!0)f()}catch(e){s=!0,c=e}finally{try{i||null==p.return||p.return()}finally{if(s)throw c}}t.length>0?this.promptForPermissions(r,t,function(){var e=kr(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t&&n();case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()):n()}},{key:"promptForPermissions",value:function(e,t,n){var r,a=this,i={component:e,permissions:t,permissionsString:this.permissionsStringForPermissions(t,e),actionBlock:n,callback:(r=kr(o.a.mark((function n(r){return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!r){n.next=5;break}return a.log("Changing component to expand permissions",e),n.next=4,a.itemManager.changeItem(e.uuid,(function(n){var r=Object(u.a)(e.permissions),a=!0,i=!1,o=void 0;try{for(var s,c=function(){var e=s.value,t=r.find((function(t){return t.name===e.name}));if(t){var n=t.content_types||[];t.content_types=pr()(n.concat(e.content_types))}else r.push(e)},l=t[Symbol.iterator]();!(a=(s=l.next()).done);a=!0)c()}catch(e){i=!0,o=e}finally{try{a||null==l.return||l.return()}finally{if(i)throw o}}n.permissions=r}));case 4:a.syncService.sync();case 5:a.permissionDialogs=a.permissionDialogs.filter((function(n){return n===i?(n.actionBlock&&n.actionBlock(r),!1):!!(n.component!==e||n.permissions!==t&&(a=t,n.permissions.some((function(e){return!a.find((function(t){return JSON.stringify(t)===JSON.stringify(e)}))}))))||(r&&n.actionBlock&&n.actionBlock(r),!1);var a})),a.permissionDialogs.length>0&&a.presentPermissionsDialog(a.permissionDialogs[0]);case 7:case"end":return n.stop()}}),n)}))),function(e){return r.apply(this,arguments)})},s=lr()(this.permissionDialogs,{component:e});this.permissionDialogs.push(i),s?this.log("Existing dialog, not presenting."):this.presentPermissionsDialog(i)}},{key:"presentPermissionsDialog",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"openModalComponent",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"registerHandler",value:function(e){var t=this;return this.handlers.push(e),function(){var n=lr()(t.handlers,{identifier:e.identifier});n?Object(u.B)(t.handlers,n):t.log("Attempting to deregister non-existing handler")}}},{key:"findOrCreateDataForComponent",value:function(e){var t=this.componentState[e.uuid];return t||(t={},this.componentState[e.uuid]=t),t}},{key:"setReadonlyStateForComponent",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.findOrCreateDataForComponent(e);r.readonly=t,r.lockReadonly=n}},{key:"getReadonlyStateForComponent",value:function(e){var t=this.findOrCreateDataForComponent(e);return{readonly:t.readonly,lockReadonly:t.lockReadonly}}},{key:"registerComponentWindow",value:(p=kr(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Register component window",t),(r=this.findOrCreateDataForComponent(t)).window===n&&this.log("Web|componentManager","attempting to re-register same component window."),this.log("Web|componentManager|registerComponentWindow",t),r.window=n,e.next=7,h.GenerateUuid();case 7:r.sessionKey=e.sent,this.sendMessageToComponent(t,{action:Z.ComponentRegistered,sessionKey:r.sessionKey,componentData:t.componentData,data:{uuid:t.uuid,environment:(o=this.environment,s=void 0,(dr(s={},or.Web,"web"),dr(s,or.Desktop,"desktop"),dr(s,or.Mobile,"mobile"),s)[o]),platform:(a=this.platform,i=void 0,(dr(i={},sr.MacWeb,"mac-web"),dr(i,sr.MacDesktop,"mac-desktop"),dr(i,sr.LinuxWeb,"linux-web"),dr(i,sr.LinuxDesktop,"linux-desktop"),dr(i,sr.WindowsWeb,"windows-web"),dr(i,sr.WindowsDesktop,"windows-desktop"),dr(i,sr.Ios,"ios"),dr(i,sr.Android,"android"),i)[a]),activeThemeUrls:this.urlsForActiveThemes()}}),this.postActiveThemesToComponent(t),this.desktopManager&&this.desktopManager.notifyComponentActivation(t);case 11:case"end":return e.stop()}var a,i,o,s}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"registerComponent",value:function(e){this.log("Registering component",e),Object(u.b)(this.activeComponents,e);var t=this.itemManager.findItem(e),n=!0,r=!1,a=void 0;try{for(var i,o=this.handlers[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;(s.areas.includes(t.area)||s.areas.includes(X.Any))&&s.activationHandler&&s.activationHandler(t)}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}t.area===X.Themes&&this.postActiveThemesToAllComponents()}},{key:"activateComponent",value:(f=kr(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Activating component",t),(n=this.itemManager.findItem(t)).active){e.next=5;break}return e.next=5,this.itemManager.changeComponent(n.uuid,(function(e){e.active=!0}));case 5:this.registerComponent(t),this.syncService.sync();case 7:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"deregisterComponent",value:function(e){this.log("Degregistering component",e);var t=this.itemManager.findItem(e);Object(u.B)(this.activeComponents,e),delete this.componentState[t.uuid];var n=!0,r=!1,a=void 0;try{for(var i,o=this.handlers[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;(s.areas.includes(t.area)||s.areas.includes(X.Any))&&s.activationHandler&&s.activationHandler(t)}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}this.streamObservers=this.streamObservers.filter((function(t){return t.componentUuid!==e})),this.contextStreamObservers=this.contextStreamObservers.filter((function(t){return t.componentUuid!==e})),t.area===X.Themes&&this.postActiveThemesToAllComponents()}},{key:"deactivateComponent",value:(l=kr(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Deactivating component",t),!(r=null===(n=this.itemManager)||void 0===n?void 0:n.findItem(t)).active){e.next=5;break}return e.next=5,this.itemManager.changeComponent(r.uuid,(function(e){e.active=!1}));case 5:this.findOrCreateDataForComponent(r).sessionKey=void 0,this.deregisterComponent(t),this.syncService.sync();case 8:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"reloadComponent",value:(c=kr(o.a.mark((function e(t){var n,r,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Reloading component",t),r=null===(n=this.itemManager)||void 0===n?void 0:n.findItem(t),e.next=4,this.itemManager.changeComponent(r.uuid,(function(e){e.active=!1}));case 4:return this.deregisterComponent(r.uuid),e.abrupt("return",new Promise((function(e){a.timeout(kr(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a.itemManager.changeComponent(r.uuid,(function(e){e.active=!0}));case 2:a.registerComponent(r.uuid),e();case 4:case"end":return t.stop()}}),t)}))))})));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"deleteComponent",value:(i=kr(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.setItemToBeDeleted(t);case 2:this.syncService.sync();case 3:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"isComponentActive",value:function(e){return e.active}},{key:"iframeForComponent",value:function(e){for(var t=0,n=Array.from(document.getElementsByTagName("iframe"));t<n.length;t++){var r=n[t];if(r.dataset.componentId===e)return r}}},{key:"focusChangedForComponent",value:function(e){var t=document.activeElement===this.iframeForComponent(e.uuid),n=!0,r=!1,a=void 0;try{for(var i,o=this.handlers[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;s.focusHandler&&s.focusHandler(e,t)}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}}},{key:"handleSetSizeEvent",value:function(e,t){var n=function(e,n){var r=Object(u.s)(n.width)?n.width:"".concat(t.width,"px"),a=Object(u.s)(n.height)?n.height:"".concat(t.height,"px");e&&e.setAttribute("style","width:".concat(r,"; height:").concat(a,";"))};if(e.area===X.Rooms||e.area===X.Modal){var r=e.area===X.Rooms?"inner":"outer",a=document.getElementById("component-content-".concat(r,"-").concat(e.uuid));a&&n(a,t)}else{var i=this.iframeForComponent(e.uuid);if(!i)return;if(n(i,t),e.area===X.EditorStack){var o=i.parentElement;o&&n(o,t)}}}},{key:"editorForNote",value:function(e){var t,n=this.componentsForArea(X.Editor),r=!0,a=!1,i=void 0;try{for(var o,s=n[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value;if(c.isExplicitlyEnabledForItem(e.uuid))return c}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return this.isMobile?e.mobilePrefersPlainEditor||(t=this.getDefaultEditor()):e.prefersPlainEditor||(t=this.getDefaultEditor()),t&&!t.isExplicitlyDisabledForItem(e.uuid)?t:void 0}},{key:"getDefaultEditor",value:function(){var e=this.componentsForArea(X.Editor);return this.isMobile?e.filter((function(e){return e.isMobileDefault}))[0]:e.filter((function(e){return e.isDefaultEditor()}))[0]}},{key:"permissionsStringForPermissions",value:function(e,t){var n="",r=e.length,a=function(e,t){return e>0?e===t-1?2===t?" and ":", and ":", ":""};return e.forEach((function(e,i){if(e.name===Z.StreamItems){for(var o=e.content_types.map((function(e){var t=Object(P.c)(e);return t?t+"s":"items of type "+e})),s="",c=0;c<o.length;c++){var u=o[c];s+=a(c,o.length+r-i-1),s+=u}n+=a(i,r),n+=s,o.length>=2&&i<r-1&&(n+=", ")}else if(e.name===Z.StreamContextItem){var l,f=(_r(l={},X.EditorStack,"working note"),_r(l,X.NoteTags,"working note"),_r(l,X.Editor,"working note"),l);n+=a(i,r),n+=f[t.area]}})),n+"."}},{key:"isDesktop",get:function(){return this.environment===or.Desktop}},{key:"isMobile",get:function(){return this.environment===or.Mobile}},{key:"components",get:function(){return this.itemManager.getItems([P.a.Component,P.a.Theme])}}])&&xr(n.prototype,r),a&&xr(n,a),t}(Qt.a);function Ir(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Er(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Mr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Rr=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Mr(this,"baseCollection",void 0),Mr(this,"applyCollection",void 0),Mr(this,"relatedCollectionSet",void 0),this.baseCollection=t,this.applyCollection=n,this.relatedCollectionSet=r}var t,n,r,a,i;return t=e,(n=[{key:"resultingCollection",value:(a=o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override PayloadDelta.resultingCollection.";case 1:case"end":return e.stop()}}),e)})),i=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){Ir(i,n,r,o,s,"next",e)}function s(e){Ir(i,n,r,o,s,"throw",e)}o(void 0)}))},function(){return i.apply(this,arguments)})},{key:"findBasePayload",value:function(e){return this.baseCollection.find(e)}},{key:"findRelatedPayload",value:function(e,t){var n,r=null===(n=this.relatedCollectionSet)||void 0===n?void 0:n.collectionForSource(t);return null==r?void 0:r.find(e)}}])&&Er(t.prototype,n),r&&Er(t,r),e}();function Tr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ar(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Kr=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ar(this,"directMap",{}),Ar(this,"inverseMap",{})}var t,n,r;return t=e,(n=[{key:"makeCopy",value:function(){var t=new e;return t.directMap=Object.assign({},this.directMap),t.inverseMap=Object.assign({},this.inverseMap),t}},{key:"getDirectRelationships",value:function(e){return this.directMap[e]||[]}},{key:"getInverseRelationships",value:function(e){return this.inverseMap[e]||[]}},{key:"establishRelationship",value:function(e,t){this.establishDirectRelationship(e,t),this.establishInverseRelationship(e,t)}},{key:"deestablishRelationship",value:function(e,t){this.deestablishDirectRelationship(e,t),this.deestablishInverseRelationship(e,t)}},{key:"setAllRelationships",value:function(e,t){var n=this.directMap[e]||[];this.directMap[e]=t;var r=!0,a=!1,i=void 0;try{for(var o,s=n[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value;this.deestablishInverseRelationship(e,c)}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}var u=!0,l=!1,f=void 0;try{for(var p,h=t[Symbol.iterator]();!(u=(p=h.next()).done);u=!0){var y=p.value;this.establishInverseRelationship(e,y)}}catch(e){l=!0,f=e}finally{try{u||null==h.return||h.return()}finally{if(l)throw f}}}},{key:"removeFromMap",value:function(e){var t=this.directMap[e]||[],n=!0,r=!1,a=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;Object(u.B)(this.inverseMap[s]||[],e)}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}delete this.directMap[e];var c=this.inverseMap[e]||[],l=!0,f=!1,p=void 0;try{for(var h,y=c[Symbol.iterator]();!(l=(h=y.next()).done);l=!0){var d=h.value;Object(u.B)(this.directMap[d]||[],e)}}catch(e){f=!0,p=e}finally{try{l||null==y.return||y.return()}finally{if(f)throw p}}delete this.inverseMap[e]}},{key:"establishDirectRelationship",value:function(e,t){var n=this.directMap[e]||[];Object(u.b)(n,t),this.directMap[e]=n}},{key:"establishInverseRelationship",value:function(e,t){var n=this.inverseMap[t]||[];Object(u.b)(n,e),this.inverseMap[t]=n}},{key:"deestablishDirectRelationship",value:function(e,t){var n=this.directMap[e]||[];Object(u.B)(n,t),this.directMap[e]=n}},{key:"deestablishInverseRelationship",value:function(e,t){var n=this.inverseMap[t]||[];Object(u.B)(n,e),this.inverseMap[t]=n}}])&&Tr(t.prototype,n),r&&Tr(t,r),e}();function Fr(e){if(null==e)throw new TypeError("Cannot destructure undefined")}function Lr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Vr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Nr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Wr=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length>1?arguments[1]:void 0,a=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;Lr(this,e),Nr(this,"map",{}),Nr(this,"typedMap",(Fr(t={}),t)),Nr(this,"dirtyIndex",new Set),Nr(this,"invalidsIndex",new Set),Nr(this,"nondeletedIndex",new Set),Nr(this,"referenceMap",void 0),Nr(this,"conflictMap",void 0),n?(this.map=r,this.typedMap=a,this.referenceMap=i,this.conflictMap=o):(this.referenceMap=new Kr,this.conflictMap=new Kr)}var t,n,r;return t=e,(n=[{key:"uuids",value:function(){return Object.keys(this.map)}},{key:"all",value:function(e){var t=this;if(e){if(Array.isArray(e)){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value;Object(u.j)(n,this.typedMap[c]||[])}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}var l;return(null===(l=this.typedMap[e])||void 0===l?void 0:l.slice())||[]}return Object.keys(this.map).map((function(e){return t.map[e]}))}},{key:"find",value:function(e){return this.map[e]}},{key:"dirtyElements",value:function(){var e=Array.from(this.dirtyIndex);return this.findAll(e)}},{key:"invalidElements",value:function(){var e=Array.from(this.invalidsIndex);return this.findAll(e)}},{key:"nondeletedElements",value:function(){var e=Array.from(this.nondeletedIndex);return this.findAll(e)}},{key:"findAll",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=[],r=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value,u=this.map[c];(u||t)&&n.push(u)}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}},{key:"set",value:function(e){if(0!==(e=Array.isArray(e)?e:[e]).length){var t=!0,n=!1,r=void 0;try{for(var a,i=e[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var o=a.value;if(this.map[o.uuid]=o,this.setToTypedMap(o),o.dirty?this.dirtyIndex.add(o.uuid):this.dirtyIndex.delete(o.uuid),o.errorDecrypting||o.waitingForKey?this.invalidsIndex.add(o.uuid):this.invalidsIndex.delete(o.uuid),o.deleted)this.referenceMap.removeFromMap(o.uuid),this.nondeletedIndex.delete(o.uuid);else{this.nondeletedIndex.add(o.uuid);var s=o.safeContent.conflict_of;s&&this.conflictMap.establishRelationship(s,o.uuid),this.referenceMap.setAllRelationships(o.uuid,o.references.map((function(e){return e.uuid})))}}}catch(e){n=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(n)throw r}}}else console.warn("Attempting to set 0 elements onto collection")}},{key:"discard",value:function(e){e=Array.isArray(e)?e:[e];var t=!0,n=!1,r=void 0;try{for(var a,i=e[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var o=a.value;this.conflictMap.removeFromMap(o.uuid),this.referenceMap.removeFromMap(o.uuid),this.deleteFromTypedMap(o),delete this.map[o.uuid]}}catch(e){n=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(n)throw r}}}},{key:"setToTypedMap",value:function(e){var t=this.typedMap[e.content_type]||[];yr()(t,{uuid:e.uuid}),t.push(e),this.typedMap[e.content_type]=t}},{key:"deleteFromTypedMap",value:function(e){var t=this.typedMap[e.content_type]||[];yr()(t,{uuid:e.uuid}),this.typedMap[e.content_type]=t}},{key:"uuidsThatReferenceUuid",value:function(e){if(!Object(u.s)(e))throw Error("Must use uuid string");return this.referenceMap.getInverseRelationships(e)}},{key:"elementsReferencingElement",value:function(e){var t=this.uuidsThatReferenceUuid(e.uuid);return this.findAll(t)}},{key:"conflictsOf",value:function(e){var t=this.conflictMap.getDirectRelationships(e);return this.findAll(t)}}])&&Vr(t.prototype,n),r&&Vr(t,r),e}();function Ur(e){return(Ur="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Br(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Hr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function zr(e,t){return!t||"object"!==Ur(t)&&"function"!=typeof t?Jr(e):t}function qr(e){return(qr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Jr(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Gr(e,t){return(Gr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Qr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var $r=function(e){function t(){var e,n;Br(this,t);for(var r=arguments.length,a=new Array(r),i=0;i<r;i++)a[i]=arguments[i];return Qr(Jr(n=zr(this,(e=qr(t)).call.apply(e,[this].concat(a)))),"source",void 0),n}var n,r,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Gr(e,t)}(t,e),n=t,a=[{key:"WithPayloads",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0,r=new t;return r.source=n,e.length>0&&r.set(e),Object.freeze(r),r}},{key:"FromCollection",value:function(e){var n=new t(!0,Object.freeze(Object.assign({},e.map)),Object.freeze(Object.assign({},e.typedMap)),Object.freeze(e.referenceMap.makeCopy()),Object.freeze(e.conflictMap.makeCopy()));return Object.freeze(n),n}}],(r=[{key:"payloads",get:function(){return this.all()}}])&&Hr(n.prototype,r),a&&Hr(n,a),t}(Wr);function Yr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Xr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Yr(Object(n),!0).forEach((function(t){ta(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Yr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Zr(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ea(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Zr(i,r,a,o,s,"next",e)}function s(e){Zr(i,r,a,o,s,"throw",e)}o(void 0)}))}}function ta(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var na=ta({},P.a.Note,(function(e,t,n){var r=n.all(P.a.Component).map((function(e){return Ut(e)})).filter((function(e){return e.area===X.Editor})).find((function(t){return t.isExplicitlyEnabledForItem(e.uuid)}));if(r){var a=new de(r,v.c.Internal);return a.associateWithItem(t.uuid),[a.getResult()]}}));function ra(e,t,n){return aa.apply(this,arguments)}function aa(){return(aa=ea(o.a.mark((function e(t,n,r){var a,i,s,c,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=[],e.next=3,h.GenerateUuid();case 3:return e.t0=e.sent,e.t1=new Date,i={uuid:e.t0,dirty:!0,dirtiedDate:e.t1,lastSyncBegan:null,lastSyncEnd:null},r&&(i.content=Xr({},t.safeContent,{conflict_of:t.uuid})),s=Object(j.b)(t,i),a.push(s),c=n.elementsReferencingElement(t),e.next=12,sa(c,[{uuid:s.uuid,content_type:s.content_type}]);case 12:return l=e.sent,Object(u.j)(a,l),(f=na[t.content_type])&&(p=f(t,s,n))&&Object(u.j)(a,p),e.abrupt("return",a);case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ia(e,t){return oa.apply(this,arguments)}function oa(){return(oa=ea(o.a.mark((function e(t,n){var r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],e.t0=j.b,e.t1=t,e.next=5,h.GenerateUuid();case 5:return e.t2=e.sent,e.t3=new Date,e.t4={uuid:e.t2,dirty:!0,dirtiedDate:e.t3,lastSyncBegan:null,lastSyncEnd:null},a=(0,e.t0)(e.t1,e.t4),r.push(a),i=n.elementsReferencingElement(t),e.next=13,sa(i,[{uuid:a.uuid,content_type:a.content_type}],[t.uuid]);case 13:return s=e.sent,Object(u.j)(r,s),c=Object(j.b)(t,{deleted:!0,dirty:!1,content:void 0}),r.push(c),e.abrupt("return",r);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function sa(e,t,n){return ca.apply(this,arguments)}function ca(){return(ca=ea(o.a.mark((function e(t,n,r){var a,i,s,c,u,l,f,p,h,y,d,v,b,m,g,w,k,x,S,O,P;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=[],i=!0,s=!1,c=void 0,e.prev=4,u=t[Symbol.iterator]();case 6:if(i=(l=u.next()).done){e.next=54;break}if(f=l.value,p=f.contentObject.references.slice(),!n){e.next=29;break}for(h=!0,y=!1,d=void 0,e.prev=13,v=n[Symbol.iterator]();!(h=(b=v.next()).done);h=!0)m=b.value,p.push(m);e.next=21;break;case 17:e.prev=17,e.t0=e.catch(13),y=!0,d=e.t0;case 21:e.prev=21,e.prev=22,h||null==v.return||v.return();case 24:if(e.prev=24,!y){e.next=27;break}throw d;case 27:return e.finish(24);case 28:return e.finish(21);case 29:if(!r){e.next=49;break}for(g=!0,w=!1,k=void 0,e.prev=33,x=r[Symbol.iterator]();!(g=(S=x.next()).done);g=!0)O=S.value,yr()(p,{uuid:O});e.next=41;break;case 37:e.prev=37,e.t1=e.catch(33),w=!0,k=e.t1;case 41:e.prev=41,e.prev=42,g||null==x.return||x.return();case 44:if(e.prev=44,!w){e.next=47;break}throw k;case 47:return e.finish(44);case 48:return e.finish(41);case 49:P=Object(j.b)(f,{dirty:!0,dirtiedDate:new Date,content:Xr({},f.safeContent,{references:p})}),a.push(P);case 51:i=!0,e.next=6;break;case 54:e.next=60;break;case 56:e.prev=56,e.t2=e.catch(4),s=!0,c=e.t2;case 60:e.prev=60,e.prev=61,i||null==u.return||u.return();case 63:if(e.prev=63,!s){e.next=66;break}throw c;case 66:return e.finish(63);case 67:return e.finish(60);case 68:return e.abrupt("return",a);case 69:case"end":return e.stop()}}),e,null,[[4,56,60,68],[13,17,21,29],[22,,24,28],[33,37,41,49],[42,,44,48],[61,,63,67]])})))).apply(this,arguments)}function ua(e,t){var n=Ut(e),r=Ut(t);return n.isItemContentEqualWith(r)}var la=n(5);function fa(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function pa(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?fa(Object(n),!0).forEach((function(t){va(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fa(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ha(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ya(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){ha(i,r,a,o,s,"next",e)}function s(e){ha(i,r,a,o,s,"throw",e)}o(void 0)}))}}function da(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function va(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ba=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),va(this,"baseCollection",void 0),va(this,"basePayload",void 0),va(this,"applyPayload",void 0),va(this,"source",void 0),this.baseCollection=t,this.basePayload=n,this.applyPayload=r,this.source=a}var t,n,r,a,i;return t=e,(n=[{key:"resultingCollection",value:(i=ya(o.a.mark((function e(){var t,n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Ut(this.basePayload),n=Ut(this.applyPayload),r=t.strategyWhenConflictingWithItem(n),e.next=5,this.payloadsByHandlingStrategy(r);case 5:return a=e.sent,e.abrupt("return",$r.WithPayloads(a,this.source));case 7:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"payloadsByHandlingStrategy",value:(a=ya(o.a.mark((function e(t){var n,r,a,i,s,c,l,f,p,h,y,d;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.baseCollection.conflictsOf(this.applyPayload.uuid)[0])||!ua(n,this.applyPayload)){e.next=3;break}return e.abrupt("return",[]);case 3:if(t!==ne.a.KeepLeft){e.next=7;break}return r=Object(u.n)(this.basePayload.updated_at,this.applyPayload.updated_at),a=Object(j.b)(this.basePayload,{updated_at:r,dirty:!0,dirtiedDate:new Date}),e.abrupt("return",[a]);case 7:if(t!==ne.a.KeepRight){e.next=10;break}return i=Object(j.g)(this.applyPayload,this.basePayload,[la.a.LastSyncBegan],{lastSyncEnd:new Date}),e.abrupt("return",[i]);case 10:if(t!==ne.a.KeepLeftDuplicateRight){e.next=17;break}return s=Object(u.n)(this.basePayload.updated_at,this.applyPayload.updated_at),c=Object(j.b)(this.basePayload,{updated_at:s,dirty:!0,dirtiedDate:new Date}),e.next=15,ra(this.applyPayload,this.baseCollection,!0);case 15:return l=e.sent,e.abrupt("return",[c].concat(l));case 17:if(t!==ne.a.DuplicateLeftKeepRight){e.next=23;break}return e.next=20,ra(this.basePayload,this.baseCollection,!0);case 20:return f=e.sent,p=Object(j.g)(this.applyPayload,this.basePayload,[la.a.LastSyncBegan],{lastSyncEnd:new Date}),e.abrupt("return",f.concat([p]));case 23:if(t!==ne.a.KeepLeftMergeRefs){e.next=28;break}return h=Object(u.J)(this.basePayload.contentObject.references,this.applyPayload.contentObject.references,["uuid","content_type"]),y=Object(u.n)(this.basePayload.updated_at,this.applyPayload.updated_at),d=Object(j.b)(this.basePayload,{updated_at:y,dirty:!0,dirtiedDate:new Date,content:pa({},this.basePayload.safeContent,{references:h})}),e.abrupt("return",[d]);case 28:throw"Unhandled strategy";case 29:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})}])&&da(t.prototype,n),r&&da(t,r),e}();function ma(e){return(ma="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ga(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function wa(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){ga(i,r,a,o,s,"next",e)}function s(e){ga(i,r,a,o,s,"throw",e)}o(void 0)}))}}function ka(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function xa(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Sa(e,t){return!t||"object"!==ma(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Oa(e){return(Oa=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Pa(e,t){return(Pa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ja=function(e){function t(){return ka(this,t),Sa(this,Oa(t).apply(this,arguments))}var n,r,a,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Pa(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(s=wa(o.a.mark((function e(){var t,n,r,a,i,s,c,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=!0,r=!1,a=void 0,e.prev=4,i=this.applyCollection.all()[Symbol.iterator]();case 6:if(n=(s=i.next()).done){e.next=16;break}return c=s.value,e.next=10,this.payloadsByHandlingPayload(c,t);case 10:l=e.sent,f=l.map((function(e){return Object(j.b)(e,{dirty:!0,dirtiedDate:new Date,deleted:!1})})),Object(u.j)(t,f);case 13:n=!0,e.next=6;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(4),r=!0,a=e.t0;case 22:e.prev=22,e.prev=23,n||null==i.return||i.return();case 25:if(e.prev=25,!r){e.next=28;break}throw a;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return e.abrupt("return",$r.WithPayloads(t,_.a.FileImport));case 31:case"end":return e.stop()}}),e,this,[[4,18,22,30],[23,,25,29]])}))),function(){return s.apply(this,arguments)})},{key:"payloadsByHandlingPayload",value:(i=wa(o.a.mark((function e(t,n){var r,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=n.find((function(e){return e.contentObject.conflict_of===t.uuid})))||(r=n.find((function(e){return e.uuid===t.uuid}))),r||(r=this.findBasePayload(t.uuid)),r){e.next=5;break}return e.abrupt("return",[t]);case 5:return a=new ba(this.baseCollection,r,t,_.a.FileImport),e.next=8,a.resultingCollection();case 8:return i=e.sent,e.abrupt("return",i.all());case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})}])&&xa(n.prototype,r),a&&xa(n,a),t}(Rr);function _a(e){return(_a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ca(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Da(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Ca(i,r,a,o,s,"next",e)}function s(e){Ca(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Ia(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ea(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ma(e,t,n){return(Ma="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ra(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ra(e){return(Ra=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ta(e,t){return(Ta=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Aa(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ka=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=function(e,t){return!t||"object"!==_a(t)&&"function"!=typeof t?Ea(e):t}(this,Ra(t).call(this)),Aa(Ea(e),"changeObservers",[]),Aa(Ea(e),"collection",void 0),Aa(Ea(e),"emitQueue",[]),e.collection=new Wr,e}var n,r,a,i,c,l,f,p;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ta(e,t)}(t,e),n=t,(r=[{key:"getMasterCollection",value:function(){return $r.FromCollection(this.collection)}},{key:"deinit",value:function(){Ma(Ra(t.prototype),"deinit",this).call(this),this.changeObservers.length=0,this.resetState()}},{key:"resetState",value:function(){this.collection=new Wr}},{key:"find",value:function(e){return this.collection.findAll(e)}},{key:"emitCollection",value:(p=Da(o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.emitPayloads(t.all(),t.source,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"emitPayload",value:(f=Da(o.a.mark((function e(t,n,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.emitPayloads([t],n,r);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"emitPayloads",value:(l=Da(o.a.mark((function e(t,n,r){var a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return 0===t.length&&console.warn("Attempting to emit 0 payloads."),e.abrupt("return",new Promise((function(e){a.emitQueue.push({payloads:t,source:n,sourceKey:r,resolve:e}),1===a.emitQueue.length&&a.popQueue()})));case 2:case"end":return e.stop()}}),e)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"popQueue",value:(c=Da(o.a.mark((function e(){var t,n,r,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.emitQueue[0],n=this.mergePayloadsOntoMaster(t.payloads),r=n.changed,a=n.inserted,i=n.discarded,this.notifyChangeObservers(r,a,i,t.source,t.sourceKey),Object(u.B)(this.emitQueue,t),t.resolve(),this.emitQueue.length>0&&this.popQueue();case 6:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"mergePayloadsOntoMaster",value:function(e){var t=[],n=[],r=[],a=!0,i=!1,o=void 0;try{for(var s,c=e[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var u=s.value;if(u.uuid&&u.content_type){var l=this.collection.find(u.uuid),f=l?Object(j.g)(l,u):u;f.discardable?(this.collection.discard(f),r.push(f)):(this.collection.set(f),l?t.push(f):n.push(f))}else console.error("Payload is corrupt:",u)}}catch(e){i=!0,o=e}finally{try{a||null==c.return||c.return()}finally{if(i)throw o}}return{changed:t,inserted:n,discarded:r}}},{key:"addObserver",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;Array.isArray(e)||(e=[e]);var a={types:e,priority:r,callback:t};return this.changeObservers.push(a),function(){Object(u.B)(n.changeObservers,a)}}},{key:"notifyChangeObservers",value:function(e,t,n,r,a){var i=this.changeObservers.slice().sort((function(e,t){return e.priority<t.priority?-1:1})),o=function(e,t){return t.includes(P.a.Any)?e.slice():e.slice().filter((function(e){return t.includes(e.content_type)}))},s=!0,c=!1,u=void 0;try{for(var l,f=i[Symbol.iterator]();!(s=(l=f.next()).done);s=!0){var p=l.value;p.callback(o(e,p.types),o(t,p.types),o(n,p.types),r,a)}}catch(e){c=!0,u=e}finally{try{s||null==f.return||f.return()}finally{if(c)throw u}}}},{key:"importPayloads",value:(i=Da(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new ja(this.getMasterCollection(),$r.WithPayloads(t,_.a.FileImport)),e.next=3,n.resultingCollection();case 3:return r=e.sent,e.next=6,this.emitCollection(r);case 6:return e.abrupt("return",Object(s.b)(r.payloads));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"removePayloadLocally",value:function(e){this.collection.discard(e)}}])&&Ia(n.prototype,r),a&&Ia(n,a),t}(Qt.a),Fa=n(8);function La(e){return(La="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Va(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Na(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Va(i,r,a,o,s,"next",e)}function s(e){Va(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Wa(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ua(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ba(e,t,n){return(Ba="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ha(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ha(e){return(Ha=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function za(e,t){return(za=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function qa(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ja=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==La(t)&&"function"!=typeof t?Ua(e):t}(this,Ha(t).call(this)),qa(Ua(r),"itemManager",void 0),qa(Ua(r),"syncService",void 0),qa(Ua(r),"resolveQueue",[]),qa(Ua(r),"registeredPredicates",[]),qa(Ua(r),"removeItemObserver",void 0),qa(Ua(r),"removeSyncObserver",void 0),r.itemManager=e,r.syncService=n,r.addObservers(),r}var n,r,a,i,c,l;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&za(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.syncService=void 0,this.itemManager=void 0,this.resolveQueue.length=0,this.registeredPredicates.length=0,this.removeItemObserver(),this.removeItemObserver=void 0,this.removeSyncObserver(),this.removeSyncObserver=void 0,Ba(Ha(t.prototype),"deinit",this).call(this)}},{key:"popResolveQueue",value:function(){var e=this.resolveQueue.slice();return this.resolveQueue=[],e}},{key:"addObservers",value:function(){var e=this;this.removeItemObserver=this.itemManager.addObserver(P.a.Any,(function(t,n){n.length>0&&(e.resolveQueue=e.resolveQueue.concat(n))})),this.removeSyncObserver=this.syncService.addEventObserver(function(){var t=Na(o.a.mark((function t(n){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==Fa.a.DownloadFirstSyncCompleted&&n!==Fa.a.FullSyncCompleted){t.next=3;break}return t.next=3,e.resolveSingletonsForItems(e.popResolveQueue(),n);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"registerPredicate",value:function(e){this.registeredPredicates.push(e)}},{key:"validItemsMatchingPredicate",value:function(e){return this.itemManager.itemsMatchingPredicate(e).filter((function(e){return!e.errorDecrypting}))}},{key:"resolveSingletonsForItems",value:(l=Na(o.a.mark((function e(t,n){var r,a,i,s,c,l,f,p,h,y,d,v=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=function(e){var t=!0,n=!1,r=void 0;try{for(var a,i=v.registeredPredicates[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var o=a.value;if(e.satisfiesPredicate(o))return v.validItemsMatchingPredicate(o)}}catch(e){n=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(n)throw r}}},a=function(e){return e.isSingleton?v.validItemsMatchingPredicate(e.singletonPredicate):null},i=function(e){var t=a(e);return t&&t.length>0?t:r(e)},s=[],c=!0,l=!1,f=void 0,e.prev=7,p=t[Symbol.iterator]();case 9:if(c=(h=p.next()).done){e.next=22;break}if(y=h.value,!s.includes(y)){e.next=13;break}return e.abrupt("continue",19);case 13:if(d=i(y),Object(u.j)(s,d||[]),d&&!(d.length<=1)){e.next=17;break}return e.abrupt("continue",19);case 17:return e.next=19,this.handleStrategy(d,y.singletonStrategy);case 19:c=!0,e.next=9;break;case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(7),l=!0,f=e.t0;case 28:e.prev=28,e.prev=29,c||null==p.return||p.return();case 31:if(e.prev=31,!l){e.next=34;break}throw f;case 34:return e.finish(31);case 35:return e.finish(28);case 36:s.length>0&&n===Fa.a.FullSyncCompleted&&setTimeout((function(){v.syncService.sync()}));case 37:case"end":return e.stop()}}),e,this,[[7,24,28,36],[29,,31,35]])}))),function(e,t){return l.apply(this,arguments)})},{key:"handleStrategy",value:(c=Na(o.a.mark((function e(t,n){var r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n===v.e.KeepEarliest){e.next=2;break}throw"Unhandled singleton strategy";case 2:return r=t.sort((function(e,t){return e.errorDecrypting?1:t.errorDecrypting||e.created_at<t.created_at?-1:1})),a=Object(u.d)(r,0),e.next=6,this.itemManager.setItemsToBeDeleted(Object(s.b)(a));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"findOrCreateSingleton",value:(i=Na(o.a.mark((function e(t,n,r){var a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=Na(o.a.mark((function e(i){var c,u,l,f,p,y,d;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((c=a.validItemsMatchingPredicate(t)).length>0)){e.next=3;break}return e.abrupt("return",i(c[0]));case 3:if(a.syncService.getLastSyncDate()){e.next=14;break}return u=!1,l=a.itemManager.addObserver(n,(function(e,n){if(n.length>0){var r=a.itemManager.subItemsMatchingPredicates(n,[t]);r.length>0&&(u=!0,i(r[0]))}})),e.next=8,a.syncService.sync();case 8:if(l(),!u){e.next=11;break}return e.abrupt("return");case 11:if(!((f=a.validItemsMatchingPredicate(t)).length>0)){e.next=14;break}return e.abrupt("return",i(f[0]));case 14:return p=a.itemManager.itemsMatchingPredicate(t).filter((function(e){return e.errorDecrypting})),e.next=17,a.itemManager.setItemsToBeDeleted(Object(s.b)(p));case 17:return e.t0=j.e,e.next=20,h.GenerateUuid();case 20:return e.t1=e.sent,e.t2=n,e.t3=r,e.t4=new Date,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:!0,dirtiedDate:e.t4},y=(0,e.t0)(e.t5),e.next=28,a.itemManager.emitItemFromPayload(y);case 28:if(d=e.sent){e.next=31;break}throw Error("Created singleton item should not be null ".concat(n));case 31:return e.next=33,a.syncService.sync();case 33:return e.abrupt("return",i(d));case 34:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),function(e,t,n){return i.apply(this,arguments)})}])&&Wa(n.prototype,r),a&&Wa(n,a),t}(Qt.a);function Ga(e){return(Ga="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Qa(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function $a(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Qa(i,r,a,o,s,"next",e)}function s(e){Qa(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Ya(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Xa(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Za(e,t,n){return(Za="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ei(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ei(e){return(ei=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ti(e,t){return(ti=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ni(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ri=function(e){function t(e,n,r,a,i,o,s){var c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c=function(e,t){return!t||"object"!==Ga(t)&&"function"!=typeof t?Xa(e):t}(this,ei(t).call(this)),ni(Xa(c),"alertService",void 0),ni(Xa(c),"httpService",void 0),ni(Xa(c),"modelManager",void 0),ni(Xa(c),"itemManager",void 0),ni(Xa(c),"protocolService",void 0),ni(Xa(c),"syncService",void 0),ni(Xa(c),"previousPasswords",[]),c.itemManager=e,c.alertService=n,c.deviceInterface=r,c.httpService=a,c.modelManager=i,c.protocolService=o,c.syncService=s,c.previousPasswords=[],c}var n,r,a,i,s,c,u,l,f,p,h,y;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ti(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.itemManager=void 0,this.alertService=void 0,this.deviceInterface=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.syncService=void 0,this.previousPasswords.length=0,Za(ei(t.prototype),"deinit",this).call(this)}},{key:"getExtensions",value:function(){return this.itemManager.nonErroredItemsForContentType(P.a.ActionsExtension)}},{key:"extensionsInContextOfItem",value:function(e){return this.getExtensions().filter((function(t){return t.supported_types.includes(e.content_type)||t.actionsWithContextForItem(e).length>0}))}},{key:"loadExtensionInContextOfItem",value:(y=$a(o.a.mark((function e(t,n){var r,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={content_type:n.content_type,item_uuid:n.uuid},e.abrupt("return",this.httpService.getAbsolute(t.url,r).then((function(e){var n=e.description||t.description,r=e.supported_types||t.supported_types,i=e.actions?e.actions.map((function(e){return new Fe(e)})):[];return a.itemManager.changeActionsExtension(t.uuid,(function(e){e.description=n,e.supported_types=r,e.actions=i})),t})).catch((function(e){return console.error("Error loading extension",e),null})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"runAction",value:(h=$a(o.a.mark((function e(t,n,r){var a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.running=!0,e.t0=t.verb,e.next="get"===e.t0?4:"render"===e.t0?8:"show"===e.t0?12:"post"===e.t0?16:20;break;case 4:return e.next=6,this.handleGetAction(t,r);case 6:return a=e.sent,e.abrupt("break",21);case 8:return e.next=10,this.handleRenderAction(t,r);case 10:return a=e.sent,e.abrupt("break",21);case 12:return e.next=14,this.handleShowAction(t);case 14:return a=e.sent,e.abrupt("break",21);case 16:return e.next=18,this.handlePostAction(t,n);case 18:return a=e.sent,e.abrupt("break",21);case 20:return e.abrupt("break",21);case 21:return t.lastExecuted=new Date,t.running=!1,e.abrupt("return",a);case 24:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return h.apply(this,arguments)})},{key:"handleGetAction",value:(p=$a(o.a.mark((function e(t,n){var r=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){r.alertService.confirm("Are you sure you want to replace the current note contents with this action's results?",void 0,void 0,void 0,(function(){r.runConfirmedGetAction(t,n).then((function(t){e(t)}))}))})));case 1:case"end":return e.stop()}}),e)}))),function(e,t){return p.apply(this,arguments)})},{key:"runConfirmedGetAction",value:(f=$a(o.a.mark((function e(t,n){var r,a,i=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.httpService.getAbsolute(t.url).catch((function(e){var n=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return i.alertService.alert(n.message),t.error=!0,{error:n}}));case 2:if(!(r=e.sent).error){e.next=5;break}return e.abrupt("return",{response:r});case 5:return t.error=!1,e.next=8,this.payloadByDecryptingResponse(r,n);case 8:return a=e.sent,e.next=11,this.modelManager.emitPayload(Object(j.b)(a,{dirty:!0,dirtiedDate:new Date}),_.a.RemoteActionRetrieved);case 11:return this.syncService.sync(),e.abrupt("return",{response:r,item:r.item});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"handleRenderAction",value:(l=$a(o.a.mark((function e(t,n){var r,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.httpService.getAbsolute(t.url).then(function(){var e=$a(o.a.mark((function e(r){var i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.error=!1,e.next=3,a.payloadByDecryptingResponse(r,n);case 3:if(!(i=e.sent)){e.next=7;break}return s=a.itemManager.createItem(i.content_type,i.contentObject),e.abrupt("return",{response:r,item:s});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){var n=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return a.alertService.alert(n.message),t.error=!0,{error:n}}));case 2:return r=e.sent,e.abrupt("return",{response:r});case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"payloadByDecryptingResponse",value:(u=$a(o.a.mark((function e(t,n,r){var a,i,s,c,u,l,f,p,h,y,d,v;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(j.e)(t.item),e.next=3,this.protocolService.payloadByDecryptingPayload(a,r);case 3:if((i=e.sent).errorDecrypting){e.next=6;break}return e.abrupt("return",i);case 6:if(t.auth_params){e.next=9;break}return this.alertService.alert("We were unable to decrypt this revision using your current keys, \n        and this revision is missing metadata that would allow us to try different \n        keys to decrypt it. This can likely be fixed with some manual intervention. \n        Please email hello@standardnotes.org for assistance."),e.abrupt("return",void 0);case 9:s=[],c=!0,u=!1,l=void 0,e.prev=13,f=this.previousPasswords[Symbol.iterator]();case 15:if(c=(p=f.next()).done){e.next=33;break}if(h=p.value,!s.includes(h)){e.next=19;break}return e.abrupt("continue",30);case 19:return s.push(h),e.next=22,this.protocolService.computeRootKey(h,t.auth_params);case 22:if(y=e.sent){e.next=25;break}return e.abrupt("continue",30);case 25:return e.next=27,this.payloadByDecryptingResponse(t,n,y);case 27:if(!(d=e.sent)){e.next=30;break}return e.abrupt("return",d);case 30:c=!0,e.next=15;break;case 33:e.next=39;break;case 35:e.prev=35,e.t0=e.catch(13),u=!0,l=e.t0;case 39:e.prev=39,e.prev=40,c||null==f.return||f.return();case 42:if(e.prev=42,!u){e.next=45;break}throw l;case 45:return e.finish(42);case 46:return e.finish(39);case 47:return e.next=49,n();case 49:return v=e.sent,this.previousPasswords.push(v),e.abrupt("return",this.payloadByDecryptingResponse(t,n,r));case 52:case"end":return e.stop()}}),e,this,[[13,35,39,47],[40,,42,46]])}))),function(e,t,n){return u.apply(this,arguments)})},{key:"handlePostAction",value:(c=$a(o.a.mark((function e(t,n){var r,a,i,s=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="decrypted"===t.access_type,e.next=3,this.outgoingPayloadForItem(n,r);case 3:return a=e.sent,i={items:[a]},e.abrupt("return",this.httpService.postAbsolute(t.url,i).then((function(e){return t.error=!1,{response:e}})).catch((function(e){return t.error=!0,console.error("Action error response:",e),s.alertService.alert("An issue occurred while processing this action. Please try again."),{response:e}})));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"handleShowAction",value:(s=$a(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.deviceInterface.openUrl(t.url),e.abrupt("return",{response:void 0});case 2:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"outgoingPayloadForItem",value:(i=$a(o.a.mark((function e(t){var n,r,a,i=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]&&i[1],r=n?Gt.a.FileDecrypted:Gt.a.FileEncrypted,e.next=4,this.protocolService.payloadByEncryptingPayload(t.payloadRepresentation(),r);case 4:return a=e.sent,e.abrupt("return",a.ejected());case 6:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})}])&&Ya(n.prototype,r),a&&Ya(n,a),t}(Qt.a);function ai(e){return(ai="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ii(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function oi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function si(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ci(e,t){return!t||"object"!==ai(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ui(e){return(ui=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function li(e,t){return(li=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var fi=function(e){function t(){return oi(this,t),ci(this,ui(t).apply(this,arguments))}var n,r,a,i,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&li(e,t)}(t,e),n=t,r=[{key:"compare",value:function(e){if(this.version!==e.version)return!1;var t=this.serverPassword&&e.serverPassword;return this.masterKey===e.masterKey&&(!t||this.serverPassword===e.serverPassword)}},{key:"getPersistableValue",value:function(){var e={version:this.version};return this.masterKey&&(e.masterKey=this.masterKey),this.dataAuthenticationKey&&(e.dataAuthenticationKey=this.dataAuthenticationKey),e}},{key:"version",get:function(){if(!this.payload.safeContent.version)throw"Attempting to create key without version.";return this.payload.safeContent.version}},{key:"isRootKey",get:function(){return!0}},{key:"itemsKey",get:function(){return this.masterKey}},{key:"masterKey",get:function(){return this.payload.safeContent.masterKey}},{key:"serverPassword",get:function(){return this.payload.safeContent.serverPassword}},{key:"dataAuthenticationKey",get:function(){return this.payload.safeContent.dataAuthenticationKey}}],a=[{key:"Create",value:(i=o.a.mark((function e(n,r){var a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=4;break}return e.next=3,h.GenerateUuid();case 3:r=e.sent;case 4:return n.version||(n.dataAuthenticationKey?n.version=Pt.a.V002:n.version=Pt.a.V001),a=Object(j.e)({uuid:r,content_type:P.a.RootKey,content:Object(s.a)(n)}),e.abrupt("return",new t(a));case 7:case"end":return e.stop()}}),e)})),c=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=i.apply(e,t);function o(e){ii(a,n,r,o,s,"next",e)}function s(e){ii(a,n,r,o,s,"throw",e)}o(void 0)}))},function(e,t){return c.apply(this,arguments)})}],r&&si(n.prototype,r),a&&si(n,a),t}(v.d);function pi(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function hi(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){pi(i,r,a,o,s,"next",e)}function s(e){pi(i,r,a,o,s,"throw",e)}o(void 0)}))}}function yi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function di(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var vi=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),di(this,"services",void 0),di(this,"challengeResponder",void 0),di(this,"stageHandlers",{}),di(this,"onDoneHandler",void 0),this.services=t,this.challengeResponder=n,this.registerStageHandlers()}var t,n,r,a,i;return t=e,n=[{key:"registerStageHandler",value:function(e,t){this.stageHandlers[e]=t}},{key:"markDone",value:function(){this.onDoneHandler&&this.onDoneHandler(),this.onDoneHandler=void 0}},{key:"onDone",value:function(e){this.onDoneHandler=e}},{key:"handleStage",value:(i=hi(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.stageHandlers[t])){e.next=4;break}return e.next=4,n();case 4:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"requestChallengeResponse",value:(a=hi(o.a.mark((function e(t,n,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.challengeResponder(t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)})}],r=[{key:"timestamp",value:function(){throw"Must override"}}],n&&yi(t.prototype,n),r&&yi(t,r),e}();function bi(e){return(bi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function mi(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function gi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function wi(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ki(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){wi(i,r,a,o,s,"next",e)}function s(e){wi(i,r,a,o,s,"throw",e)}o(void 0)}))}}function xi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Si(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Oi(e,t){return!t||"object"!==bi(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Pi(e){return(Pi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ji(e,t){return(ji=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _i={WebPasscodeParamsKey:"offlineParams",MobilePasscodeParamsKey:"pc_params",AllAccountKeyParamsKey:"auth_params",WebEncryptedStorageKey:"encryptedStorage",MobileWrappedRootKeyKey:"encrypted_account_keys",AllMigrations:"migrations"},Ci=function(e){function t(){return xi(this,t),Oi(this,Pi(t).apply(this,arguments))}var n,r,i,c,l,f,p,v,b,m,g,k,x;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ji(e,t)}(t,e),n=t,r=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(a.PreparingForLaunch_0,ki(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!br(e.services.environment)){t.next=4;break}return t.abrupt("return",e.migrateStorageStructureForWebDesktop());case 4:if(!mr(e.services.environment)){t.next=6;break}return t.abrupt("return",e.migrateStorageStructureForMobile());case 6:case"end":return t.stop()}}),t)})))),this.registerStageHandler(a.StorageDecrypted_09,ki(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateArbitraryRawStorageToManagedStorageAllPlatforms();case 2:return t.next=4,e.migrateSessionStorage();case 4:return t.next=6,e.deleteLegacyStorageValues();case 6:case"end":return t.stop()}}),t)})))),this.registerStageHandler(a.LoadingDatabase_11,ki(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.createDefaultItemsKeyForAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateStorageStructureForWebDesktop",value:(x=ki(o.a.mark((function e(){var t,n,r,a,i,s,c,l,f,p,h,y,d,v,b,m,g,w,k;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.services.deviceInterface,gi(t={},Jt.Wrapped,{}),gi(t,Jt.Unwrapped,{}),gi(t,Jt.Nonwrapped,{}),r=t,e.next=4,n.getJsonParsedStorageValue(_i.AllAccountKeyParamsKey);case 4:return(a=e.sent)&&(r.nonwrapped[Nt.RootKeyParams]=a),e.next=8,n.getJsonParsedStorageValue(_i.WebEncryptedStorageKey);case 8:if(!(i=e.sent)){e.next=36;break}return s=Object(j.e)(i),e.next=13,this.webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage(s);case 13:if(c=e.sent,l=c.key,f=c.decryptedStoragePayload,p=c.keyParams,r.nonwrapped[Nt.RootKeyWrapperKeyParams]=p.getPortableValue(),h=Object(u.a)(f.contentObject.storage),y=Object(u.v)(h),r.nonwrapped[Nt.RootKeyParams]=y[_i.AllAccountKeyParamsKey],d=l,Object(u.p)(y.mk)){e.next=31;break}return e.next=26,this.webDesktopHelperExtractAndWrapAccountKeysFromValueStore(l,y);case 26:v=e.sent,b=v.accountKey,m=v.wrappedKey,d=b,r.nonwrapped[Nt.WrappedRootKey]=m;case 31:return e.next=33,this.webDesktopHelperEncryptStorage(d,f,y);case 33:r.wrapped=e.sent,e.next=55;break;case 36:return e.next=38,this.services.deviceInterface.getRawStorageValue("ak");case 38:return g=e.sent,w=Object(u.p)(g)?Pt.a.V002:Pt.a.V003,e.t0=fi,e.next=43,this.services.deviceInterface.getRawStorageValue("mk");case 43:return e.t1=e.sent,e.next=46,this.services.deviceInterface.getRawStorageValue("pw");case 46:return e.t2=e.sent,e.t3=g,e.t4=w,e.t5={masterKey:e.t1,serverPassword:e.t2,dataAuthenticationKey:e.t3,version:e.t4},e.next=52,e.t0.Create.call(e.t0,e.t5);case 52:return k=e.sent,e.next=55,this.services.deviceInterface.setKeychainValue(k.getPersistableValue());case 55:return e.next=57,this.allPlatformHelperSetStorageStructure(r);case 57:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"allPlatformHelperSetStorageStructure",value:(k=ki(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=on.defaultValuesObject(t.wrapped,t.unwrapped,t.nonwrapped))[Jt.Unwrapped]=void 0,e.next=4,this.services.deviceInterface.setRawStorageValue(Bt(this.services.namespace,Vt.StorageObject),JSON.stringify(n));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage",value:(g=ki(o.a.mark((function e(t){var n,r,a,i,s,c,u,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getJsonParsedStorageValue(_i.WebPasscodeParamsKey);case 2:n=e.sent,r=this.services.protocolService.createKeyParams(n),i=!0,c=new w([y.LocalPasscode],d.Migration);case 6:if(!i){e.next=23;break}return u={},e.next=10,this.requestChallengeResponse(c,!1,u);case 10:return l=e.sent,f=l.getValueForType(y.LocalPasscode),p=f.value,e.next=15,this.services.protocolService.computeRootKey(p,r);case 15:return s=e.sent,e.next=18,this.services.protocolService.payloadByDecryptingPayload(t,s);case 18:a=e.sent,i=a.errorDecrypting,u.orchestrator.setValidationStatus(f,!a.errorDecrypting),e.next=6;break;case 23:return e.abrupt("return",{decryptedStoragePayload:a,key:s,keyParams:r});case 24:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"webDesktopHelperExtractAndWrapAccountKeysFromValueStore",value:(m=ki(o.a.mark((function e(t,n){var r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.ak?Pt.a.V003:Pt.a.V002,e.next=3,fi.Create({masterKey:n.mk,serverPassword:n.pw,dataAuthenticationKey:n.ak,version:a});case 3:if(i=e.sent,delete n.mk,delete n.pw,delete n.ak,s=Object(j.e)(i),!t){e.next=12;break}return e.next=11,this.services.protocolService.payloadByEncryptingPayload(s,Gt.a.LocalStorageEncrypted,t);case 11:c=e.sent;case 12:return e.abrupt("return",{accountKey:i,wrappedKey:null===(r=c)||void 0===r?void 0:r.ejected()});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)})},{key:"webDesktopHelperEncryptStorage",value:(b=ki(o.a.mark((function e(t,n,r){var a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.protocolService.payloadByEncryptingPayload(Object(j.b)(n,{content_type:P.a.EncryptedStorage,content:r}),Gt.a.LocalStoragePreferEncrypted,t);case 2:return a=e.sent,e.abrupt("return",a.ejected());case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return b.apply(this,arguments)})},{key:"migrateStorageStructureForMobile",value:(v=ki(o.a.mark((function e(){var t,n,r,a,i,c,l,f,p,v,b,m,g,k,x,S,O,_,C,D,I,E=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getJsonParsedStorageValue(_i.MobileWrappedRootKeyKey);case 2:return r=e.sent,e.next=5,this.services.deviceInterface.getJsonParsedStorageValue(_i.AllAccountKeyParamsKey);case 5:return a=e.sent,e.next=8,this.services.deviceInterface.getJsonParsedStorageValue(_i.MobilePasscodeParamsKey);case 8:return i=e.sent,gi(n={},Jt.Nonwrapped,(gi(t={},Nt.WrappedRootKey,r),gi(t,Nt.RootKeyWrapperKeyParams,i),gi(t,Nt.RootKeyParams,a),t)),gi(n,Jt.Unwrapped,{}),gi(n,Jt.Wrapped,{}),c=n,e.next=12,this.services.deviceInterface.getKeychainValue();case 12:if(l=e.sent,!i){e.next=56;break}if(f=this.services.protocolService.createKeyParams(i),p=function(){var e=ki(o.a.mark((function e(){var t,n,r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=l.offline.pw,r=new w([y.LocalPasscode],d.Migration),a={};case 3:if(n&&n.serverPassword===t){e.next=15;break}return e.next=6,E.requestChallengeResponse(r,!1,a);case 6:return i=e.sent,s=i.getValueForType(y.LocalPasscode),c=s.value,e.next=11,E.services.protocolService.computeRootKey(c,f);case 11:n=e.sent,a.orchestrator.setValidationStatus(s,n.serverPassword===t),e.next=3;break;case 15:return e.abrupt("return",n);case 16:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),v=l.offline.timing,c.unwrapped[Nt.MobilePasscodeTiming]=v,!r){e.next=36;break}return e.next=21,p();case 21:return b=e.sent,e.next=24,this.services.protocolService.payloadByDecryptingPayload(Object(j.e)(r),b);case 24:return m=e.sent,g=m.contentObject.accountKeys,k=Object(u.p)(g.ak)?Pt.a.V002:Pt.a.V003,x=Object(j.b)(m,{content:{masterKey:g.mk,serverPassword:g.pw,dataAuthenticationKey:g.ak,version:g.version||k,accountKeys:null}}),e.next=30,this.services.protocolService.payloadByEncryptingPayload(x,Gt.a.LocalStoragePreferEncrypted,b);case 30:return S=e.sent,c.nonwrapped[Nt.WrappedRootKey]=S.ejected(),e.next=34,this.services.deviceInterface.clearKeychainValue();case 34:e.next=54;break;case 36:if(r){e.next=54;break}return e.next=39,p();case 39:return O=e.sent,e.t0=j.e,e.next=43,h.GenerateUuid();case 43:return e.t1=e.sent,e.t2=Object(s.a)(c.unwrapped),e.t3=P.a.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},_=(0,e.t0)(e.t4),e.next=50,this.services.protocolService.payloadByEncryptingPayload(_,Gt.a.LocalStoragePreferEncrypted,O);case 50:return C=e.sent,c.wrapped=C.ejected(),e.next=54,this.services.deviceInterface.clearKeychainValue();case 54:e.next=64;break;case 56:if(!l||!l.mk){e.next=64;break}return D=Object(u.p)(l.ak)?Pt.a.V002:Pt.a.V003,e.next=61,fi.Create({masterKey:l.mk,serverPassword:l.pw,dataAuthenticationKey:l.ak,version:l.version||D});case 61:return I=e.sent,e.next=64,this.services.deviceInterface.setKeychainValue(I.getPersistableValue());case 64:return e.next=66,this.allPlatformHelperSetStorageStructure(c);case 66:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"migrateArbitraryRawStorageToManagedStorageAllPlatforms",value:(p=ki(o.a.mark((function e(){var t,n,r,a,i,s,c,l,f,p,h,y,d,v;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getAllRawStorageKeyValues();case 2:t=e.sent,n=Object(u.x)(_i),r=function(e){try{return JSON.parse(e)}catch(t){return e}},a=this.services.namespace,i=!0,s=!1,c=void 0,e.prev=9,l=t[Symbol.iterator]();case 11:if(i=(f=l.next()).done){e.next=25;break}if(p=f.value,h=p.key,y=p.value,d=a&&a.length>0&&h.startsWith(a),!n.includes(h)&&!d){e.next=18;break}return e.abrupt("continue",22);case 18:if(Object(u.p)(y)){e.next=22;break}return v=r(y),e.next=22,this.services.storageService.setValue(h,v);case 22:i=!0,e.next=11;break;case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(9),s=!0,c=e.t0;case 31:e.prev=31,e.prev=32,i||null==l.return||l.return();case 34:if(e.prev=34,!s){e.next=37;break}throw c;case 37:return e.finish(34);case 38:return e.finish(31);case 39:case"end":return e.stop()}}),e,this,[[9,27,31,39],[32,,34,38]])}))),function(){return p.apply(this,arguments)})},{key:"deleteLegacyStorageValues",value:(f=ki(o.a.mark((function e(){var t,n,r,a,i,s,c,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=["mk","ak","jwt","ephemeral","cachedThemes"],n=[].concat(mi(Object(u.x)(Nt)),mi(Object(u.x)(_i)),t),r=!0,a=!1,i=void 0,e.prev=5,s=n[Symbol.iterator]();case 7:if(r=(c=s.next()).done){e.next=14;break}return l=c.value,e.next=11,this.services.deviceInterface.removeRawStorageValue(l);case 11:r=!0,e.next=7;break;case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(5),a=!0,i=e.t0;case 20:e.prev=20,e.prev=21,r||null==s.return||s.return();case 23:if(e.prev=23,!a){e.next=26;break}throw i;case 26:return e.finish(23);case 27:return e.finish(20);case 28:case"end":return e.stop()}}),e,this,[[5,16,20,28],[21,,23,27]])}))),function(){return f.apply(this,arguments)})},{key:"migrateSessionStorage",value:(l=ki(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,this.services.storageService.getValue("jwt");case 3:if(t=e.sent){e.next=6;break}return e.abrupt("return");case 6:return n=new gn(t),e.next=9,this.services.storageService.setValue(Nt.Session,n);case 9:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"createDefaultItemsKeyForAllPlatforms",value:(c=ki(o.a.mark((function e(){var t,n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.protocolService.getRootKey();case 2:if(!(t=e.sent)){e.next=19;break}return e.next=6,this.services.protocolService.getRootKeyParams();case 6:return n=e.sent,e.t0=j.e,e.next=10,h.GenerateUuid();case 10:return e.t1=e.sent,e.t2=P.a.ItemsKey,e.t3=Object(s.a)({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:n.version}),e.t4=new Date,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:!0,dirtiedDate:e.t4},r=(0,e.t0)(e.t5),a=Ut(r),e.next=19,this.services.itemManager.emitItemFromPayload(a.payloadRepresentation(),_.a.LocalChanged);case 19:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})}],i=[{key:"timestamp",value:function(){return new Date("2020-01-15").getTime()}}],r&&Si(n.prototype,r),i&&Si(n,i),t}(vi);function Di(e){return(Di="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ii(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ei(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Ii(i,r,a,o,s,"next",e)}function s(e){Ii(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Mi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ri(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ti(e,t){return!t||"object"!==Di(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ai(e){return(Ai=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ki(e,t){return(Ki=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Fi=function(e){function t(){return Mi(this,t),Ti(this,Ai(t).apply(this,arguments))}var n,r,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ki(e,t)}(t,e),n=t,r=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(a.PreparingForLaunch_0,Ei(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateMigrationTimestampAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateMigrationTimestampAllPlatforms",value:(s=Ei(o.a.mark((function e(){var t,n,r,a,i,s,c,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!1,n=0,r=["migrations","ephemeral","user","cachedThemes","syncToken","encryptedStorage"];case 3:if(!(n<r.length)){e.next=14;break}return a=r[n],e.next=7,this.services.deviceInterface.getRawStorageValue(a);case 7:if(!e.sent){e.next=11;break}return t=!0,e.abrupt("break",14);case 11:n++,e.next=3;break;case 14:return i=Bt(this.services.namespace,Vt.LastMigrationTimestamp),e.next=17,this.services.deviceInterface.getRawStorageValue(i);case 17:if(s=e.sent,(c=!Object(u.p)(s))||!t){e.next=25;break}return l=new Date(0).getTime(),e.next=23,this.services.deviceInterface.setRawStorageValue(i,l);case 23:e.next=32;break;case 25:if(c||t){e.next=31;break}return f=(new Date).getTime(),e.next=29,this.services.deviceInterface.setRawStorageValue(i,f);case 29:e.next=32;break;case 31:case 32:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})}],i=[{key:"timestamp",value:function(){return new Date("2020-01-01").getTime()}}],r&&Ri(n.prototype,r),i&&Ri(n,i),t}(vi);function Li(e){return(Li="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Vi(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ni(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Vi(i,r,a,o,s,"next",e)}function s(e){Vi(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Wi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ui(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Bi(e,t,n){return(Bi="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Hi(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Hi(e){return(Hi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function zi(e,t){return(zi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function qi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ji=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==Li(t)&&"function"!=typeof t?Ui(e):t}(this,Hi(t).call(this)),qi(Ui(r),"challengeResponder",void 0),qi(Ui(r),"activeMigrations",void 0),qi(Ui(r),"services",void 0),qi(Ui(r),"handledFullSyncStage",!1),r.services=e,r.challengeResponder=n,r}var n,i,s,l,f,p,h,y,d,v,b;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&zi(e,t)}(t,e),n=t,(i=[{key:"deinit",value:function(){this.services=void 0,this.challengeResponder=void 0,this.activeMigrations&&(this.activeMigrations.length=0),Bi(Hi(t.prototype),"deinit",this).call(this)}},{key:"initialize",value:(b=Ni(o.a.mark((function e(){var t,n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.runBaseMigration();case 2:return e.next=4,this.getRequiredMigrations();case 4:this.activeMigrations=e.sent,this.activeMigrations.length>0&&(t=Object(u.w)(this.activeMigrations)).onDone(Ni(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.saveLastMigrationTimestamp(t.constructor.timestamp());case 2:case"end":return e.stop()}}),e)}))));case 6:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"handleApplicationStage",value:(v=Ni(o.a.mark((function e(n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Bi(Hi(t.prototype),"handleApplicationStage",this).call(this,n);case 2:return e.next=4,this.handleStage(n);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"handleApplicationEvent",value:(d=Ni(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==c.a.SignedIn){e.next=5;break}return e.next=3,this.handleStage(a.SignedIn_30);case 3:e.next=10;break;case 5:if(t!==c.a.CompletedFullSync){e.next=10;break}if(this.handledFullSyncStage){e.next=10;break}return this.handledFullSyncStage=!0,e.next=10,this.handleStage(a.FullSyncCompleted_13);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"runBaseMigration",value:(y=Ni(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Fi(this.services),e.next=3,t.handleStage(a.PreparingForLaunch_0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"getRequiredMigrations",value:(h=Ni(o.a.mark((function e(){var t,n,a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLastMigrationTimestamp();case 2:for(t=e.sent,n=[],a=Object.keys(r).map((function(e){return r[e]})).sort((function(e,t){var n=e.timestamp(),r=t.timestamp();return n<r?-1:n>r?1:0})),i=!0,s=!1,c=void 0,e.prev=8,u=a[Symbol.iterator]();!(i=(l=u.next()).done);i=!0)(f=l.value).timestamp()>t&&n.push(new f(this.services,this.challengeResponder));e.next=16;break;case 12:e.prev=12,e.t0=e.catch(8),s=!0,c=e.t0;case 16:e.prev=16,e.prev=17,i||null==u.return||u.return();case 19:if(e.prev=19,!s){e.next=22;break}throw c;case 22:return e.finish(19);case 23:return e.finish(16);case 24:return e.abrupt("return",n);case 25:case"end":return e.stop()}}),e,this,[[8,12,16,24],[17,,19,23]])}))),function(){return h.apply(this,arguments)})},{key:"getTimeStampKey",value:function(){return Bt(this.services.namespace,Vt.LastMigrationTimestamp)}},{key:"getLastMigrationTimestamp",value:(p=Ni(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getRawStorageValue(this.getTimeStampKey());case 2:if(t=e.sent,!Object(u.p)(t)){e.next=5;break}throw"Timestamp should not be null. Be sure to run base migration first.";case 5:return e.abrupt("return",JSON.parse(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"saveLastMigrationTimestamp",value:(f=Ni(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.setRawStorageValue(this.getTimeStampKey(),JSON.stringify(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"handleStage",value:(l=Ni(o.a.mark((function e(t){var n,r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,r=!1,a=void 0,e.prev=3,i=this.activeMigrations[Symbol.iterator]();case 5:if(n=(s=i.next()).done){e.next=12;break}return c=s.value,e.next=9,c.handleStage(t);case 9:n=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,a=e.t0;case 18:e.prev=18,e.prev=19,n||null==i.return||i.return();case 21:if(e.prev=21,!r){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return l.apply(this,arguments)})}])&&Wi(n.prototype,i),s&&Wi(n,s),t}(Qt.a);function Gi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Qi(e){return new eo(e)}var $i,Yi,Xi,Zi,eo=function(){function e(t){var n,r,a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a=void 0,(r="content")in(n=this)?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,this.content=t}var t,n,r;return t=e,(n=[{key:"getPortableValue",value:function(){return Object(Pt.b)(this.version,Pt.a.V003)>=0?Object(u.y)(this.content,["pw_cost"]):this.content}},{key:"isKeyParamsObject",get:function(){return!0}},{key:"kdfIterations",get:function(){return this.content.pw_cost}},{key:"seed",get:function(){return this.content.pw_nonce}},{key:"identifier",get:function(){return this.content.identifier||this.content.email}},{key:"salt",get:function(){return this.content.pw_salt}},{key:"version",get:function(){return this.content.version}}])&&Gi(t.prototype,n),r&&Gi(t,r),e}();function to(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function no(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){to(i,r,a,o,s,"next",e)}function s(e){to(i,r,a,o,s,"throw",e)}o(void 0)}))}}function ro(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ao(e){return(ao="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function io(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function oo(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){io(i,r,a,o,s,"next",e)}function s(e){io(i,r,a,o,s,"throw",e)}o(void 0)}))}}function so(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function co(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function uo(e,t){return!t||"object"!==ao(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function lo(e,t,n){return(lo="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=fo(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function fo(e){return(fo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function po(e,t){return(po=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}!function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=512]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength"}($i||($i={})),function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(Yi||(Yi={})),function(e){e[e.SaltSeedLength=256]="SaltSeedLength",e[e.PbkdfCost=11e4]="PbkdfCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(Xi||(Xi={})),function(e){e[e.ArgonSaltSeedLength=256]="ArgonSaltSeedLength",e[e.ArgonSaltLength=128]="ArgonSaltLength",e[e.ArgonIterations=5]="ArgonIterations",e[e.ArgonMemLimit=67108864]="ArgonMemLimit",e[e.ArgonOutputKeyBytes=64]="ArgonOutputKeyBytes",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionNonceLength=192]="EncryptionNonceLength"}(Zi||(Zi={}));var ho="00000000000000000000000000000000",yo=function(e){function t(){return so(this,t),uo(this,fo(t).apply(this,arguments))}var n,r,a,i,s,c,u,l,f,p,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&po(e,t)}(t,e),n=t,(r=[{key:"generateNewItemsKeyContent",value:(h=oo(o.a.mark((function e(){var t,n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=$i.EncryptionKeyLength,e.next=3,this.crypto.generateRandomKey(t);case 3:return n=e.sent,r={itemsKey:n,version:this.version},e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"createRootKey",value:(p=oo(o.a.mark((function e(t,n){var r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=$i.PbkdfMinCost,e.next=3,this.crypto.generateRandomKey($i.SaltSeedLength);case 3:return a=e.sent,e.next=6,this.crypto.unsafeSha1(t+"SN"+a);case 6:return i=e.sent,e.next=9,this.deriveKey(n,i,r);case 9:return s=e.sent,c=Qi({email:t,pw_cost:r,pw_nonce:a,pw_salt:i,version:this.version}),e.abrupt("return",{key:s,keyParams:c});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"computeRootKey",value:(f=oo(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deriveKey(t,n.salt,n.kdfIterations);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"decryptString",value:(l=oo(o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,ho,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"encryptString",value:(u=oo(o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,ho,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(c=oo(o.a.mark((function e(n,r,a){var i,s,c,u,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r!==pt.a.DecryptedBareObject&&r!==pt.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",lo(fo(t.prototype),"generateEncryptedParameters",this).call(this,n,r,a));case 2:if(r===pt.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(r);case 4:if(a){e.next=6;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 6:return e.next=8,this.crypto.generateRandomKey(2*$i.EncryptionKeyLength);case 8:return i=e.sent,e.next=11,this.encryptString(i,a.itemsKey);case 11:return s=e.sent,e.next=14,this.firstHalfOfKey(i);case 14:return c=e.sent,e.next=17,this.secondHalfOfKey(i);case 17:return u=e.sent,e.next=20,this.encryptString(JSON.stringify(n.content),c);case 20:return l=e.sent,f=a.version+l,e.next=24,this.crypto.hmac256(f,u);case 24:return p=e.sent,e.abrupt("return",Object(j.c)({uuid:n.uuid,items_key_id:a instanceof Kt?a.uuid:void 0,content:f,enc_item_key:s,auth_hash:p}));case 26:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(s=oo(o.a.mark((function e(n,r){var a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((a=n.format)!==pt.a.DecryptedBareObject&&a!==pt.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",lo(fo(t.prototype),"generateDecryptedParameters",this).call(this,n,r));case 3:if(n.enc_item_key){e.next=6;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",n);case 6:return i=n.enc_item_key,i=this.version+i,s=this.encryptionComponentsFromString(i,r.itemsKey),e.next=11,this.decryptString(s.ciphertext,s.key);case 11:if(c=e.sent){e.next=15;break}return console.error("Error decrypting parameters",n),e.abrupt("return",Object(j.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 15:return e.next=17,this.firstHalfOfKey(c);case 17:return u=e.sent,l=this.encryptionComponentsFromString(n.contentString,u),e.next=21,this.decryptString(l.ciphertext,l.key);case 21:if(f=e.sent){e.next=26;break}return e.abrupt("return",Object(j.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 26:return e.abrupt("return",Object(j.a)(n,{content:JSON.parse(f),items_key_id:void 0,enc_item_key:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===n.errorDecrypting,waitingForKey:!1}));case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"encryptionComponentsFromString",value:function(e,t){var n=e.substring(0,Pt.a.VersionLength);return{ciphertext:e.substring(Pt.a.VersionLength,e.length),version:n,key:t}}},{key:"deriveKey",value:(i=oo(o.a.mark((function e(t,n,r){var a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.pbkdf2(t,n,r,$i.PbkdfOutputLength);case 2:return a=e.sent,e.next=5,this.splitKey(a,2);case 5:return i=e.sent,e.next=8,fi.Create({serverPassword:i[0],masterKey:i[1],version:this.version});case 8:return s=e.sent,e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return i.apply(this,arguments)})},{key:"version",get:function(){return Pt.a.V001}}])&&co(n.prototype,r),a&&co(n,a),t}(function(){function e(t){var n,r,a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a=void 0,(r="crypto")in(n=this)?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,this.crypto=t}var t,n,r,a,i,c,u,l;return t=e,(n=[{key:"firstHalfOfKey",value:(l=no(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(0,t.length/2));case 1:case"end":return e.stop()}}),e)}))),function(e){return l.apply(this,arguments)})},{key:"secondHalfOfKey",value:(u=no(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(t.length/2,t.length));case 1:case"end":return e.stop()}}),e)}))),function(e){return u.apply(this,arguments)})},{key:"splitKey",value:function(e,t){for(var n=e.length/t,r=[],a=0;a<t;a++){var i=e.slice(n*a,n*(a+1));r.push(i)}return r}},{key:"createItemsKey",value:(c=no(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateNewItemsKeyContent();case 2:return t=e.sent,e.t0=j.e,e.next=6,h.GenerateUuid();case 6:return e.t1=e.sent,e.t2=P.a.ItemsKey,e.t3=Object(s.a)(t),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},n=(0,e.t0)(e.t4),e.abrupt("return",Ut(n));case 12:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(i=no(o.a.mark((function e(t,n,r){var a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==pt.a.DecryptedBareObject){e.next=4;break}return e.abrupt("return",Object(j.c)({content:t.content}));case 4:if(n!==pt.a.DecryptedBase64String){e.next=13;break}return a=JSON.stringify(t.content),e.next=8,this.crypto.base64Encode(a);case 8:return i=e.sent,s=Pt.a.V000Base64Decrypted+i,e.abrupt("return",Object(j.c)({content:s}));case 13:throw"Must override generateEncryptedParameters to handle format ".concat(n,".");case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return i.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(a=no(o.a.mark((function e(t,n){var r,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==pt.a.DecryptedBareObject){e.next=5;break}return e.abrupt("return",t);case 5:if(r!==pt.a.DecryptedBase64String){e.next=20;break}return a=t.contentString.substring(Pt.a.VersionLength,t.contentString.length),e.prev=7,e.next=10,this.crypto.base64Decode(a);case 10:s=e.sent,i=JSON.parse(s),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(7),i=t.content;case 17:return e.abrupt("return",Object(j.a)(t,{content:i}));case 20:throw"Must override generateDecryptedParameters to handle format ".concat(r,".");case 21:case"end":return e.stop()}}),e,this,[[7,14]])}))),function(e,t){return a.apply(this,arguments)})}])&&ro(t.prototype,n),r&&ro(t,r),e}());function vo(e){return(vo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function bo(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function mo(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){bo(i,r,a,o,s,"next",e)}function s(e){bo(i,r,a,o,s,"throw",e)}o(void 0)}))}}function go(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function wo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ko(e,t){return!t||"object"!==vo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function xo(e,t,n){return(xo="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=So(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function So(e){return(So=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Oo(e,t){return(Oo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Po=function(e){function t(){return go(this,t),ko(this,So(t).apply(this,arguments))}var n,r,a,i,s,c,u,l,f,p,h,y,d;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Oo(e,t)}(t,e),n=t,(r=[{key:"generateNewItemsKeyContent",value:(d=mo(o.a.mark((function e(){var t,n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Yi.EncryptionKeyLength,e.next=3,this.crypto.generateRandomKey(t);case 3:return n=e.sent,e.next=6,this.crypto.generateRandomKey(t);case 6:return r=e.sent,a={itemsKey:n,dataAuthenticationKey:r,version:this.version},e.abrupt("return",a);case 9:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"createRootKey",value:(y=mo(o.a.mark((function e(t,n){var r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Yi.PbkdfMinCost,e.next=3,this.crypto.generateRandomKey(Yi.SaltSeedLength);case 3:return a=e.sent,e.next=6,this.crypto.unsafeSha1(t+":"+a);case 6:return i=e.sent,e.next=9,this.deriveKey(n,i,r);case 9:return s=e.sent,c=Qi({email:t,pw_cost:r,pw_nonce:a,pw_salt:i,version:this.version}),e.abrupt("return",{key:s,keyParams:c});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"computeRootKey",value:(h=mo(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deriveKey(t,n.salt,n.kdfIterations);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"decryptString002",value:(p=mo(o.a.mark((function e(t,n,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,r,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return p.apply(this,arguments)})},{key:"encryptString002",value:(f=mo(o.a.mark((function e(t,n,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,r,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"encryptTextParams",value:(l=mo(o.a.mark((function e(t,n,r,a,i){var s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(Yi.EncryptionIvLength);case 2:return s=e.sent,e.next=5,this.encryptString002(t,n,s);case 5:return c=e.sent,u=[i,a,s,c].join(":"),e.next=9,this.crypto.hmac256(u,r);case 9:return l=e.sent,f=[i,l,a,s,c].join(":"),e.abrupt("return",f);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return l.apply(this,arguments)})},{key:"decryptTextParams",value:(u=mo(o.a.mark((function e(t,n,r,a,i,s){var c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw"Attempting to decryptTextParams with null encryptionKey";case 2:return e.next=4,this.crypto.hmac256(t,s);case 4:if(c=e.sent,!1!==this.crypto.timingSafeEqual(i,c)){e.next=8;break}return console.error("Auth hash does not match, returning null."),e.abrupt("return",null);case 8:return e.abrupt("return",this.decryptString002(n,r,a));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a,i){return u.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(c=mo(o.a.mark((function e(n,r,a){var i,s,c,u,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r!==pt.a.DecryptedBareObject&&r!==pt.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",xo(So(t.prototype),"generateEncryptedParameters",this).call(this,n,r,a));case 2:if(r===pt.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(r);case 4:if(a&&a.itemsKey){e.next=6;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 6:return e.next=8,this.crypto.generateRandomKey(2*Yi.EncryptionKeyLength);case 8:return i=e.sent,e.next=11,this.encryptTextParams(i,a.itemsKey,a.dataAuthenticationKey,n.uuid,a.version);case 11:return s=e.sent,e.next=14,this.firstHalfOfKey(i);case 14:return c=e.sent,e.next=17,this.secondHalfOfKey(i);case 17:return u=e.sent,e.next=20,this.encryptTextParams(JSON.stringify(n.content),c,u,n.uuid,a.version);case 20:return l=e.sent,e.abrupt("return",Object(j.c)({uuid:n.uuid,items_key_id:a instanceof Kt?a.uuid:void 0,content:l,enc_item_key:s}));case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(s=mo(o.a.mark((function e(n,r){var a,i,s,c,u,l,f,p,h;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((a=n.format)!==pt.a.DecryptedBareObject&&a!==pt.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",xo(So(t.prototype),"generateDecryptedParameters",this).call(this,n,r));case 3:if(n.enc_item_key){e.next=6;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",n);case 6:if(r&&r.itemsKey){e.next=8;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 8:return i=n.enc_item_key,s=this.encryptionComponentsFromString002(i,r.itemsKey,r.dataAuthenticationKey),e.next=12,this.decryptTextParams(s.ciphertextToAuth,s.contentCiphertext,s.encryptionKey,s.iv,s.authHash,s.authKey);case 12:if(c=e.sent){e.next=16;break}return console.error("Error decrypting item_key parameters",n),e.abrupt("return",Object(j.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 16:return e.next=18,this.firstHalfOfKey(c);case 18:return u=e.sent,e.next=21,this.secondHalfOfKey(c);case 21:return l=e.sent,f=this.encryptionComponentsFromString002(n.contentString,u,l),e.next=25,this.decryptTextParams(f.ciphertextToAuth,f.contentCiphertext,f.encryptionKey,f.iv,f.authHash,f.authKey);case 25:if(p=e.sent){e.next=30;break}return e.abrupt("return",Object(j.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 30:return e.prev=30,e.t0=JSON,e.next=34,this.crypto.base64Decode(f.authParams);case 34:e.t1=e.sent,h=e.t0.parse.call(e.t0,e.t1),e.next=40;break;case 38:e.prev=38,e.t2=e.catch(30);case 40:return e.abrupt("return",Object(j.a)(n,{content:JSON.parse(p),items_key_id:void 0,enc_item_key:void 0,auth_params:h,errorDecrypting:!1,errorDecryptingValueChanged:!0===n.errorDecrypting,waitingForKey:!1}));case 41:case"end":return e.stop()}}),e,this,[[30,38]])}))),function(e,t){return s.apply(this,arguments)})},{key:"deriveKey",value:(i=mo(o.a.mark((function e(t,n,r){var a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.pbkdf2(t,n,r,Yi.PbkdfOutputLength);case 2:return a=e.sent,e.next=5,this.splitKey(a,3);case 5:return i=e.sent,e.next=8,fi.Create({serverPassword:i[0],masterKey:i[1],dataAuthenticationKey:i[2],version:this.version});case 8:return s=e.sent,e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return i.apply(this,arguments)})},{key:"encryptionComponentsFromString002",value:function(e,t,n){var r=e.split(":");return{encryptionVersion:r[0],authHash:r[1],uuid:r[2],iv:r[3],contentCiphertext:r[4],authParams:r[5],ciphertextToAuth:[r[0],r[2],r[3],r[4]].join(":"),encryptionKey:t,authKey:n}}},{key:"version",get:function(){return Pt.a.V002}}])&&wo(n.prototype,r),a&&wo(n,a),t}(yo);function jo(e){return(jo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _o(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Co(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){_o(i,r,a,o,s,"next",e)}function s(e){_o(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Do(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Io(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Eo(e,t){return!t||"object"!==jo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Mo(e){return(Mo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ro(e,t){return(Ro=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var To=function(e){function t(){return Do(this,t),Eo(this,Mo(t).apply(this,arguments))}var n,r,a,i,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ro(e,t)}(t,e),n=t,(r=[{key:"computeRootKey",value:(c=Co(o.a.mark((function e(t,n){var r,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Xi.PbkdfCost,a=this.version,e.next=4,this.generateSalt(n.identifier,a,r,n.seed);case 4:return i=e.sent,e.next=7,this.deriveKey(t,i,r);case 7:return s=e.sent,e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"createRootKey",value:(s=Co(o.a.mark((function e(t,n){var r,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.version,a=Xi.PbkdfCost,e.next=4,this.crypto.generateRandomKey(Xi.SaltSeedLength);case 4:return i=e.sent,e.next=7,this.generateSalt(t,r,a,i);case 7:return s=e.sent,e.next=10,this.deriveKey(n,s,a);case 10:return c=e.sent,u=Qi({identifier:t,pw_cost:a,pw_nonce:i,version:r}),e.abrupt("return",{key:c,keyParams:u});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"generateSalt",value:(i=Co(o.a.mark((function e(t,n,r,a){var i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.sha256([t,"SF",n,r,a].join(":"));case 2:return i=e.sent,e.abrupt("return",i);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return i.apply(this,arguments)})},{key:"version",get:function(){return Pt.a.V003}}])&&Io(n.prototype,r),a&&Io(n,a),t}(Po);function Ao(e){return(Ao="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ko(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Fo(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Ko(i,r,a,o,s,"next",e)}function s(e){Ko(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Lo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Vo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function No(e,t){return!t||"object"!==Ao(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Wo(e,t,n){return(Wo="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Uo(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Uo(e){return(Uo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Bo(e,t){return(Bo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ho,zo=function(e){function t(){return Lo(this,t),No(this,Uo(t).apply(this,arguments))}var n,r,a,i,s,c,l,f,p,h,y,d,v;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Bo(e,t)}(t,e),n=t,(r=[{key:"generateNewItemsKeyContent",value:(v=Fo(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(Zi.EncryptionKeyLength);case 2:return t=e.sent,n={itemsKey:t,version:this.version},e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"generateSalt004",value:(d=Fo(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.sha256([t,n].join(":"));case 2:return r=e.sent,e.abrupt("return",Object(u.I)(r,Zi.ArgonSaltLength));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"computeRootKey",value:(y=Fo(o.a.mark((function e(t,n){var r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateSalt004(n.identifier,n.seed);case 2:return r=e.sent,e.next=5,this.deriveKey(t,r,Zi.ArgonIterations);case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"createRootKey",value:(h=Fo(o.a.mark((function e(t,n){var r,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.version,a=Zi.ArgonIterations,e.next=4,this.crypto.generateRandomKey(Zi.ArgonSaltSeedLength);case 4:return i=e.sent,e.next=7,this.generateSalt004(t,i);case 7:return s=e.sent,e.next=10,this.deriveKey(n,s,a);case 10:return c=e.sent,u=Qi({identifier:t,pw_cost:a,pw_nonce:i,version:r}),e.abrupt("return",{key:c,keyParams:u});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"encryptString004",value:(p=Fo(o.a.mark((function e(t,n,r,a){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw"encryptString null nonce";case 2:if(n){e.next=4;break}throw"encryptString null rawKey";case 4:return e.abrupt("return",this.crypto.xchacha20Encrypt(t,r,n,JSON.stringify(a)));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return p.apply(this,arguments)})},{key:"decryptString004",value:(f=Fo(o.a.mark((function e(t,n,r,a){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.xchacha20Decrypt(t,r,n,JSON.stringify(a)));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return f.apply(this,arguments)})},{key:"generateEncryptedProtocolString",value:(l=Fo(o.a.mark((function e(t,n,r){var a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(Zi.EncryptionNonceLength);case 2:return a=e.sent,i=this.version,e.next=6,this.encryptString004(t,n,a,{u:r,v:i});case 6:return s=e.sent,c=[i,a,s].join(":"),e.abrupt("return",c);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(c=Fo(o.a.mark((function e(n,r,a){var i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r!==pt.a.DecryptedBareObject&&r!==pt.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",Wo(Uo(t.prototype),"generateEncryptedParameters",this).call(this,n,r,a));case 2:if(r===pt.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(r);case 4:if(n.uuid){e.next=6;break}throw"payload.uuid cannot be null";case 6:if(a&&a.itemsKey){e.next=8;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 8:return e.next=10,this.crypto.generateRandomKey(Zi.EncryptionKeyLength);case 10:return i=e.sent,s=JSON.stringify(n.content),e.next=14,this.generateEncryptedProtocolString(s,i,n.uuid);case 14:return c=e.sent,e.next=17,this.generateEncryptedProtocolString(i,a.itemsKey,n.uuid);case 17:return u=e.sent,e.abrupt("return",Object(j.c)({uuid:n.uuid,items_key_id:a instanceof Kt?a.uuid:void 0,content:c,enc_item_key:u}));case 19:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(s=Fo(o.a.mark((function e(n,r){var a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((a=n.format)!==pt.a.DecryptedBareObject&&a!==pt.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",Wo(Uo(t.prototype),"generateDecryptedParameters",this).call(this,n,r));case 3:if(n.uuid){e.next=5;break}throw"encryptedParameters.uuid cannot be null";case 5:if(r&&r.itemsKey){e.next=7;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 7:return i=this.deconstructEncryptedPayloadString(n.enc_item_key),e.next=10,this.decryptString004(i.ciphertext,r.itemsKey,i.nonce,{u:n.uuid,v:i.version});case 10:if(s=e.sent){e.next=14;break}return console.error("Error decrypting itemKey parameters",n),e.abrupt("return",Object(j.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 14:return c=this.deconstructEncryptedPayloadString(n.contentString),e.next=17,this.decryptString004(c.ciphertext,s,c.nonce,{u:n.uuid,v:c.version});case 17:if(u=e.sent){e.next=22;break}return e.abrupt("return",Object(j.a)(n,{errorDecrypting:!0,errorDecryptingValueChanged:!n.errorDecrypting}));case 22:return e.abrupt("return",Object(j.a)(n,{content:JSON.parse(u),items_key_id:void 0,enc_item_key:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===n.errorDecrypting,waitingForKey:!1}));case 23:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"deconstructEncryptedPayloadString",value:function(e){var t=e.split(":");return{version:t[0],nonce:t[1],ciphertext:t[2]}}},{key:"deriveKey",value:(i=Fo(o.a.mark((function e(t,n,r){var a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.argon2(t,n,r,Zi.ArgonMemLimit,Zi.ArgonOutputKeyBytes);case 2:return a=e.sent,i=this.splitKey(a,2),s=i[0],c=i[1],e.abrupt("return",fi.Create({masterKey:s,serverPassword:c,version:this.version}));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return i.apply(this,arguments)})},{key:"version",get:function(){return Pt.a.V004}}])&&Vo(n.prototype,r),a&&Vo(n,a),t}(To);function qo(e){return(qo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Jo(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Go(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Jo(i,r,a,o,s,"next",e)}function s(e){Jo(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Qo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function $o(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Yo(e,t,n){return(Yo="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Xo(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Xo(e){return(Xo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Zo(e,t){return(Zo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function es(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.RootKeyNone=0]="RootKeyNone",e[e.RootKeyOnly=1]="RootKeyOnly",e[e.RootKeyPlusWrapper=2]="RootKeyPlusWrapper",e[e.WrapperOnly=3]="WrapperOnly"}(Ho||(Ho={}));var ts=Pt.a.V003,ns=function(e){function t(e,n,r,a,i){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),o=function(e,t){return!t||"object"!==qo(t)&&"function"!=typeof t?$o(e):t}(this,Xo(t).call(this)),es($o(o),"itemManager",void 0),es($o(o),"modelManager",void 0),es($o(o),"storageService",void 0),es($o(o),"crypto",void 0),es($o(o),"operators",{}),es($o(o),"keyMode",Ho.RootKeyNone),es($o(o),"keyObservers",[]),es($o(o),"rootKey",void 0),es($o(o),"removeItemsObserver",void 0),o.itemManager=e,o.modelManager=n,o.deviceInterface=r,o.storageService=a,o.crypto=i,Object(u.r)()?h.SetGenerators(o.crypto.generateUUID,void 0):h.SetGenerators(o.crypto.generateUUID,o.crypto.generateUUIDSync),Object.defineProperty($o(o),"rootKey",{enumerable:!1,writable:!0}),o.removeItemsObserver=o.itemManager.addObserver([P.a.ItemsKey],(function(e,t){t.length>0&&o.decryptErroredItems()})),o}var n,r,a,i,l,f,p,y,d,v,b,m,g,w,k,x,S,O,C,D,I,E,M,R,T,A,K,F,L,V,N,W,U,B,H,z,q,J,G,Q,$,Y,X,Z,ee,te;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Zo(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.itemManager=void 0,this.modelManager=void 0,this.deviceInterface=void 0,this.storageService=void 0,this.crypto.deinit(),this.crypto=void 0,this.operators={},this.keyObservers.length=0,this.removeItemsObserver(),this.removeItemsObserver=null,this.rootKey=void 0,Yo(Xo(t.prototype),"deinit",this).call(this)}},{key:"initialize",value:(te=Go(o.a.mark((function e(){var t,n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKey();case 2:return t=e.sent,e.next=5,this.getAccountKeyParams();case 5:return n=e.sent,e.next=8,this.hasRootKeyWrapper();case 8:if(r=e.sent,a=!Object(u.p)(t)||!Object(u.p)(n),!r||!a){e.next=14;break}this.keyMode=Ho.RootKeyPlusWrapper,e.next=27;break;case 14:if(!r||a){e.next=18;break}this.keyMode=Ho.WrapperOnly,e.next=27;break;case 18:if(r||!a){e.next=22;break}this.keyMode=Ho.RootKeyOnly,e.next=27;break;case 22:if(r||a){e.next=26;break}this.keyMode=Ho.RootKeyNone,e.next=27;break;case 26:throw"Invalid key mode condition";case 27:if(this.keyMode!==Ho.RootKeyOnly){e.next=33;break}return e.next=30,this.getRootKeyFromKeychain();case 30:return this.rootKey=e.sent,e.next=33,this.notifyObserversOfKeyChange();case 33:case"end":return e.stop()}}),e,this)}))),function(){return te.apply(this,arguments)})},{key:"getLatestVersion",value:function(){return Pt.a.V004}},{key:"getUserVersion",value:(ee=Go(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getAccountKeyParams();case 2:return t=e.sent,e.abrupt("return",t&&t.version);case 4:case"end":return e.stop()}}),e,this)}))),function(){return ee.apply(this,arguments)})},{key:"upgradeAvailable",value:(Z=Go(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.accountUpgradeAvailable();case 2:return t=e.sent,e.next=5,this.passcodeUpgradeAvailable();case 5:return n=e.sent,e.abrupt("return",t||n);case 7:case"end":return e.stop()}}),e,this)}))),function(){return Z.apply(this,arguments)})},{key:"accountUpgradeAvailable",value:(X=Go(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getUserVersion();case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.abrupt("return",t!==this.getLatestVersion());case 6:case"end":return e.stop()}}),e,this)}))),function(){return X.apply(this,arguments)})},{key:"passcodeUpgradeAvailable",value:(Y=Go(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.abrupt("return",t.version!==this.getLatestVersion());case 6:case"end":return e.stop()}}),e,this)}))),function(){return Y.apply(this,arguments)})},{key:"platformSupportsKeyDerivation",value:function(e){return Object(Pt.b)(e.version,Pt.a.V004)>=0||!!Object(u.t)()}},{key:"supportedVersions",value:function(){return[Pt.a.V001,Pt.a.V002,Pt.a.V003,Pt.a.V004]}},{key:"isVersionNewerThanLibraryVersion",value:function(e){var t=this.getLatestVersion();return 1===Object(Pt.b)(e,t)}},{key:"isProtocolVersionOutdated",value:function(e){var t,n=(es(t={},Pt.a.V001,Date.parse("2018-01-01")),es(t,Pt.a.V002,Date.parse("2020-01-01")),t)[e];return!!n&&(new Date).getTime()>n}},{key:"costMinimumForVersion",value:function(e){if(Object(Pt.b)(e,Pt.a.V003)>=0)throw"Cost minimums only apply to versions <= 002";if(e===Pt.a.V001)return $i.PbkdfMinCost;if(e===Pt.a.V002)return Yi.PbkdfMinCost;throw"Invalid version for cost minimum: ".concat(e)}},{key:"createOperatorForLatestVersion",value:function(){return this.createOperatorForVersion(this.getLatestVersion())}},{key:"createOperatorForVersion",value:function(e){if(e===Pt.a.V001)return new yo(this.crypto);if(e===Pt.a.V002)return new Po(this.crypto);if(e===Pt.a.V003)return new To(this.crypto);if(e===Pt.a.V004)return new zo(this.crypto);if(e===Pt.a.V000Base64Decrypted)return this.createOperatorForLatestVersion();throw"Unable to find operator for version ".concat(e)}},{key:"operatorForVersion",value:function(e){var t=e,n=this.operators[t];return n||(n=this.createOperatorForVersion(e),this.operators[t]=n),n}},{key:"defaultOperator",value:function(){return this.operatorForVersion(this.getLatestVersion())}},{key:"computeRootKey",value:($=Go(o.a.mark((function e(t,n){var r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.version,a=this.operatorForVersion(r),e.abrupt("return",a.computeRootKey(t,n));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return $.apply(this,arguments)})},{key:"createRootKey",value:(Q=Go(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.defaultOperator(),e.abrupt("return",r.createRootKey(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return Q.apply(this,arguments)})},{key:"payloadContentFormatForIntent",value:function(e,t){if(t){if(e===Gt.a.Sync||e===Gt.a.FileEncrypted||e===Gt.a.FilePreferEncrypted||e===Gt.a.LocalStorageEncrypted||e===Gt.a.LocalStoragePreferEncrypted)return pt.a.EncryptedString;throw"Unhandled encrypted case in protocolService.payloadContentFormatForIntent."}if(e===Gt.a.LocalStorageDecrypted||e===Gt.a.LocalStoragePreferEncrypted||e===Gt.a.FileDecrypted||e===Gt.a.FilePreferEncrypted)return pt.a.DecryptedBareObject;if(e===Gt.a.SyncDecrypted)return pt.a.DecryptedBase64String;throw"Unhandled decrypted case in protocolService.payloadContentFormatForIntent."}},{key:"payloadByEncryptingPayload",value:(G=Go(o.a.mark((function e(t,n,r){var a,i,s,c,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.errorDecrypting){e.next=2;break}return e.abrupt("return",t);case 2:if(!t.deleted){e.next=4;break}return e.abrupt("return",t);case 4:if(!Object(u.p)(n)){e.next=6;break}throw"Attempting to encrypt payload with null intent";case 6:if(r||Object(Gt.c)(n)){e.next=10;break}return e.next=9,this.keyToUseForEncryptionOfPayload(t,n);case 9:r=e.sent;case 10:if(r||!Object(Gt.b)(n)){e.next=12;break}throw Error("Attempting to generate encrypted payload with no key.");case 12:if(t.format===pt.a.DecryptedBareObject){e.next=14;break}throw"Attempting to encrypt already encrypted payload.";case 14:if(t.content){e.next=16;break}throw"Attempting to encrypt payload with no content.";case 16:if(t.uuid){e.next=18;break}throw"Attempting to encrypt payload with no uuid.";case 18:return a=r?r.version:this.getLatestVersion(),i=this.payloadContentFormatForIntent(n,r),s=this.operatorForVersion(a),e.next=23,s.generateEncryptedParameters(t,i,r);case 23:if(c=e.sent){e.next=26;break}throw"Unable to generate encryption parameters";case 26:return l=Object(j.d)(t,n,c),e.abrupt("return",l);case 28:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return G.apply(this,arguments)})},{key:"payloadsByEncryptingPayloads",value:(J=Go(o.a.mark((function e(t,n){var r,a,i,s,c,l,f,p,h;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a=!0,i=!1,s=void 0,e.prev=4,c=t[Symbol.iterator]();case 6:if(a=(l=c.next()).done){e.next=16;break}return f=l.value,p=Object(u.o)(n)?n(f):n,e.next=11,this.payloadByEncryptingPayload(f,p);case 11:h=e.sent,r.push(h);case 13:a=!0,e.next=6;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(4),i=!0,s=e.t0;case 22:e.prev=22,e.prev=23,a||null==c.return||c.return();case 25:if(e.prev=25,!i){e.next=28;break}throw s;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return e.abrupt("return",r);case 31:case"end":return e.stop()}}),e,this,[[4,18,22,30],[23,,25,29]])}))),function(e,t){return J.apply(this,arguments)})},{key:"payloadByDecryptingPayload",value:(q=Go(o.a.mark((function e(t,n){var r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.content){e.next=2;break}throw"Attempting to decrypt payload that has no content.";case 2:if((r=t.format)!==pt.a.DecryptedBareObject){e.next=5;break}return e.abrupt("return",t);case 5:if(n||r!==pt.a.EncryptedString){e.next=11;break}return e.next=8,this.keyToUseForDecryptionOfPayload(t);case 8:if(n=e.sent){e.next=11;break}return e.abrupt("return",Object(j.e)(t,{waitingForKey:!0,errorDecrypting:!0}));case 11:return a=t.version,i=this.operatorForVersion(a),s=Object(j.c)(t),e.next=16,i.generateDecryptedParameters(s,n);case 16:return c=e.sent,e.abrupt("return",Object(j.e)(t,c));case 18:case"end":return e.stop()}}),e,this)}))),function(e,t){return q.apply(this,arguments)})},{key:"payloadsByDecryptingPayloads",value:(z=Go(o.a.mark((function e(t,n){var r,a,i,s,c,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a=!0,i=!1,s=void 0,e.prev=4,c=t[Symbol.iterator]();case 6:if(a=(l=c.next()).done){e.next=32;break}if(f=l.value){e.next=11;break}return r.push(f),e.abrupt("continue",29);case 11:if(!0!==f.deleted||!Object(u.p)(f.content)){e.next=14;break}return r.push(f),e.abrupt("continue",29);case 14:if(Object(u.s)(f.content)){e.next=18;break}return r.push(f),e.abrupt("continue",29);case 18:return e.prev=18,e.next=21,this.payloadByDecryptingPayload(f,n);case 21:p=e.sent,r.push(p),e.next=29;break;case 25:e.prev=25,e.t0=e.catch(18),r.push(Object(j.e)(f,{errorDecrypting:!0,errorDecryptingValueChanged:!f.errorDecrypting})),console.error("Error decrypting payload",f,e.t0);case 29:a=!0,e.next=6;break;case 32:e.next=38;break;case 34:e.prev=34,e.t1=e.catch(4),i=!0,s=e.t1;case 38:e.prev=38,e.prev=39,a||null==c.return||c.return();case 41:if(e.prev=41,!i){e.next=44;break}throw s;case 44:return e.finish(41);case 45:return e.finish(38);case 46:return e.abrupt("return",r);case 47:case"end":return e.stop()}}),e,this,[[4,34,38,46],[18,25],[39,,41,45]])}))),function(e,t){return z.apply(this,arguments)})},{key:"decryptErroredItems",value:(H=Go(o.a.mark((function e(){var t,n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(t=this.itemManager.invalidItems).length){e.next=3;break}return e.abrupt("return");case 3:return n=t.map((function(e){return e.payloadRepresentation()})),e.next=6,this.payloadsByDecryptingPayloads(n);case 6:return r=e.sent,e.next=9,this.modelManager.emitPayloads(r,_.a.LocalChanged);case 9:case"end":return e.stop()}}),e,this)}))),function(){return H.apply(this,arguments)})},{key:"payloadsByDecryptingBackupFile",value:(B=Go(o.a.mark((function e(t,n){var r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.keyParams||t.auth_params,a=t.items,i=a.map((function(e){return Object(j.f)(e,_.a.FileImport)})),!r){e.next=12;break}return e.next=6,this.computeRootKey(n,r);case 6:return c=e.sent,e.next=9,this.payloadsByDecryptingPayloads(i,c);case 9:s=e.sent,e.next=13;break;case 12:s=i;case 13:return e.abrupt("return",s);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return B.apply(this,arguments)})},{key:"createKeyParams",value:function(e){return e.version||(e.version=Pt.a.V002),Qi(e)}},{key:"createBackupFile",value:(U=Go(o.a.mark((function e(t){var n,r,a,i,s,c,u,l,f,p,h,y,d,v,b,m=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=m.length>1&&void 0!==m[1]?m[1]:Gt.a.FilePreferEncrypted,r=m.length>2&&void 0!==m[2]&&m[2],a=t||this.itemManager.items,!r||0!==a.length){e.next=5;break}return e.abrupt("return",void 0);case 5:i=[],s=!0,c=!1,u=void 0,e.prev=9,l=a[Symbol.iterator]();case 11:if(s=(f=l.next()).done){e.next=25;break}if(!(p=f.value).errorDecrypting){e.next=17;break}i.push(p.payload),e.next=22;break;case 17:return h=Object(j.f)(p.payload,_.a.FileImport),e.next=20,this.payloadByEncryptingPayload(h,n);case 20:y=e.sent,i.push(y);case 22:s=!0,e.next=11;break;case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(9),c=!0,u=e.t0;case 31:e.prev=31,e.prev=32,s||null==l.return||l.return();case 34:if(e.prev=34,!c){e.next=37;break}throw u;case 37:return e.finish(34);case 38:return e.finish(31);case 39:return d={items:i.map((function(e){return e.ejected()}))},e.next=42,this.getRootKeyParams();case 42:return(v=e.sent)&&n!==Gt.a.FileDecrypted&&(d.keyParams=v.getPortableValue()),b=2,e.abrupt("return",JSON.stringify(d,null,b));case 46:case"end":return e.stop()}}),e,this,[[9,27,31,39],[32,,34,38]])}))),function(e){return U.apply(this,arguments)})},{key:"onKeyStatusChange",value:function(e){var t=this;return this.keyObservers.push(e),function(){Object(u.B)(t.keyObservers,e)}}},{key:"notifyObserversOfKeyChange",value:(W=Go(o.a.mark((function e(){var t,n,r,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,n=!1,r=void 0,e.prev=3,a=this.keyObservers[Symbol.iterator]();case 5:if(t=(i=a.next()).done){e.next=12;break}return s=i.value,e.next=9,s();case 9:t=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),n=!0,r=e.t0;case 18:e.prev=18,e.prev=19,t||null==a.return||a.return();case 21:if(e.prev=21,!n){e.next=24;break}throw r;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(){return W.apply(this,arguments)})},{key:"getRootKeyFromKeychain",value:(N=Go(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getKeychainValue();case 2:if(t=e.sent,!Object(u.p)(t)){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.next=7,fi.Create(t);case 7:return n=e.sent,e.abrupt("return",n);case 9:case"end":return e.stop()}}),e,this)}))),function(){return N.apply(this,arguments)})},{key:"saveRootKeyToKeychain",value:(V=Go(o.a.mark((function e(){var t,n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(u.p)(this.rootKey)){e.next=2;break}throw"Attempting to non-existent root key to the keychain.";case 2:if(this.keyMode===Ho.RootKeyOnly){e.next=4;break}throw"Should not be persisting wrapped key to keychain.";case 4:return t=this.rootKey.getPersistableValue(),e.abrupt("return",this.executeCriticalFunction((function(){return n.deviceInterface.setKeychainValue(t)})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return V.apply(this,arguments)})},{key:"hasRootKeyWrapper",value:(L=Go(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return t=e.sent,e.abrupt("return",!Object(u.p)(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return L.apply(this,arguments)})},{key:"hasPasscode",value:function(){return this.keyMode===Ho.WrapperOnly||this.keyMode===Ho.RootKeyPlusWrapper}},{key:"rootKeyNeedsUnwrapping",value:(F=Go(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.hasRootKeyWrapper();case 2:if(e.t0=e.sent,!e.t0){e.next=5;break}e.t0=Object(u.p)(this.rootKey);case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}}),e,this)}))),function(){return F.apply(this,arguments)})},{key:"getRootKeyWrapperKeyParams",value:(K=Go(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Nt.RootKeyWrapperKeyParams,qt.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.abrupt("return",this.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return K.apply(this,arguments)})},{key:"getWrappedRootKey",value:(A=Go(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(Nt.WrappedRootKey,qt.Nonwrapped));case 1:case"end":return e.stop()}}),e,this)}))),function(){return A.apply(this,arguments)})},{key:"getRootKeyParams",value:(T=Go(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==Ho.WrapperOnly){e.next=4;break}return e.abrupt("return",this.getRootKeyWrapperKeyParams());case 4:if(this.keyMode!==Ho.RootKeyOnly&&this.keyMode!==Ho.RootKeyPlusWrapper){e.next=8;break}return e.abrupt("return",this.getAccountKeyParams());case 8:if(this.keyMode!==Ho.RootKeyNone){e.next=12;break}return e.abrupt("return",void 0);case 12:throw"Unhandled key mode for getRootKeyParams ".concat(this.keyMode);case 13:case"end":return e.stop()}}),e,this)}))),function(){return T.apply(this,arguments)})},{key:"getAccountKeyParams",value:(R=Go(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Nt.RootKeyParams,qt.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.abrupt("return",this.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return R.apply(this,arguments)})},{key:"validateWrappingKey",value:(M=Go(o.a.mark((function e(t){var n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKey();case 2:if(n=e.sent,this.keyMode!==Ho.WrapperOnly){e.next=7;break}return e.abrupt("return",this.storageService.canDecryptWithKey(t));case 7:if(this.keyMode!==Ho.RootKeyOnly&&this.keyMode!==Ho.RootKeyPlusWrapper){e.next=15;break}return r=Object(j.e)(n),e.next=11,this.payloadByDecryptingPayload(r,t);case 11:return a=e.sent,e.abrupt("return",!a.errorDecrypting);case 15:throw"Unhandled case in validateWrappingKey";case 16:case"end":return e.stop()}}),e,this)}))),function(e){return M.apply(this,arguments)})},{key:"computeWrappingKey",value:(E=Go(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:return r=e.sent,e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"unwrapRootKey",value:(I=Go(o.a.mark((function e(t){var n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==Ho.WrapperOnly){e.next=3;break}return this.rootKey=t,e.abrupt("return");case 3:if(this.keyMode===Ho.RootKeyPlusWrapper){e.next=5;break}throw"Invalid key mode condition for unwrapping.";case 5:return e.next=7,this.getWrappedRootKey();case 7:return n=e.sent,r=Object(j.e)(n),e.next=11,this.payloadByDecryptingPayload(r,t);case 11:if(!(a=e.sent).errorDecrypting){e.next=16;break}throw Error("Unable to decrypt root key with provided wrapping key.");case 16:return e.next=18,fi.Create(a.contentObject,a.uuid);case 18:return this.rootKey=e.sent,e.next=21,this.notifyObserversOfKeyChange();case 21:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"setNewRootKeyWrapper",value:(D=Go(o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==Ho.RootKeyNone){e.next=4;break}this.keyMode=Ho.WrapperOnly,e.next=9;break;case 4:if(this.keyMode!==Ho.RootKeyOnly){e.next=8;break}this.keyMode=Ho.RootKeyPlusWrapper,e.next=9;break;case 8:throw Error("Attempting to set wrapper on already wrapped key.");case 9:return e.next=11,this.deviceInterface.clearKeychainValue();case 11:if(this.keyMode!==Ho.WrapperOnly&&this.keyMode!==Ho.RootKeyPlusWrapper){e.next=26;break}if(this.keyMode!==Ho.WrapperOnly){e.next=18;break}return this.rootKey=t,e.next=16,this.reencryptItemsKeys();case 16:e.next=20;break;case 18:return e.next=20,this.wrapAndPersistRootKey(t);case 20:return e.next=22,this.storageService.setValue(Nt.RootKeyWrapperKeyParams,n.getPortableValue(),qt.Nonwrapped);case 22:return e.next=24,this.notifyObserversOfKeyChange();case 24:e.next=27;break;case 26:throw Error("Invalid keyMode on setNewRootKeyWrapper");case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return D.apply(this,arguments)})},{key:"wrapAndPersistRootKey",value:(C=Go(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(j.e)(this.rootKey,{content:this.rootKey.getPersistableValue()}),e.next=3,this.payloadByEncryptingPayload(n,Gt.a.LocalStorageEncrypted,t);case 3:return r=e.sent,e.next=6,this.storageService.setValue(Nt.WrappedRootKey,r.ejected(),qt.Nonwrapped);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"removeRootKeyWrapper",value:(O=Go(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode===Ho.WrapperOnly||this.keyMode===Ho.RootKeyPlusWrapper){e.next=2;break}throw"Attempting to remove root key wrapper on unwrapped key.";case 2:return this.keyMode===Ho.WrapperOnly?(this.keyMode=Ho.RootKeyNone,this.rootKey=void 0):this.keyMode===Ho.RootKeyPlusWrapper&&(this.keyMode=Ho.RootKeyOnly),e.next=5,this.storageService.removeValue(Nt.WrappedRootKey,qt.Nonwrapped);case 5:return e.next=7,this.storageService.removeValue(Nt.RootKeyWrapperKeyParams,qt.Nonwrapped);case 7:if(this.keyMode!==Ho.RootKeyOnly){e.next=10;break}return e.next=10,this.saveRootKeyToKeychain();case 10:return e.next=12,this.notifyObserversOfKeyChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return O.apply(this,arguments)})},{key:"setNewRootKey",value:(S=Go(o.a.mark((function e(t,n,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}throw Error("keyParams must be supplied if setting root key.");case 2:if(this.rootKey!==t){e.next=4;break}throw Error("Attempting to set root key as same current value.");case 4:if(this.keyMode!==Ho.WrapperOnly){e.next=8;break}this.keyMode=Ho.RootKeyPlusWrapper,e.next=16;break;case 8:if(this.keyMode!==Ho.RootKeyNone){e.next=12;break}this.keyMode=Ho.RootKeyOnly,e.next=16;break;case 12:if(this.keyMode!==Ho.RootKeyOnly&&this.keyMode!==Ho.RootKeyPlusWrapper){e.next=15;break}e.next=16;break;case 15:throw Error("Unhandled key mode for setNewRootKey ".concat(this.keyMode));case 16:return this.rootKey=t,e.next=19,this.storageService.setValue(Nt.RootKeyParams,n.getPortableValue(),qt.Nonwrapped);case 19:if(this.keyMode!==Ho.RootKeyOnly){e.next=24;break}return e.next=22,this.saveRootKeyToKeychain();case 22:e.next=29;break;case 24:if(this.keyMode!==Ho.RootKeyPlusWrapper){e.next=29;break}if(r){e.next=27;break}throw Error("wrappingKey must be supplied");case 27:return e.next=29,this.wrapAndPersistRootKey(r);case 29:return e.next=31,this.notifyObserversOfKeyChange();case 31:return e.next=33,this.reencryptItemsKeys();case 33:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return S.apply(this,arguments)})},{key:"getRootKey",value:(x=Go(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rootKey);case 1:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"clearLocalKeyState",value:(k=Go(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.clearKeychainValue();case 2:return e.next=4,this.storageService.removeValue(Nt.WrappedRootKey,qt.Nonwrapped);case 4:return e.next=6,this.storageService.removeValue(Nt.RootKeyWrapperKeyParams,qt.Nonwrapped);case 6:return e.next=8,this.storageService.removeValue(Nt.RootKeyParams,qt.Nonwrapped);case 8:return this.keyMode=Ho.RootKeyNone,this.rootKey=void 0,e.next=12,this.notifyObserversOfKeyChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"validateAccountPassword",value:(w=Go(o.a.mark((function e(t){var n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:if(r=e.sent,!(a=r.compare(this.rootKey))){e.next=11;break}return e.abrupt("return",{valid:a,artifacts:{rootKey:r}});case 11:return e.abrupt("return",{valid:!1});case 12:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"validatePasscode",value:(g=Go(o.a.mark((function e(t){var n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:return r=e.sent,e.next=8,this.validateWrappingKey(r);case 8:if(!(a=e.sent)){e.next=13;break}return e.abrupt("return",{valid:a,artifacts:{wrappingKey:r}});case 13:return e.abrupt("return",{valid:!1});case 14:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"contentTypeUsesRootKeyEncryption",value:function(e){return e===P.a.ItemsKey||e===P.a.EncryptedStorage}},{key:"keyToUseForEncryptionOfPayload",value:(m=Go(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(u.p)(n)){e.next=2;break}throw"Intent must be supplied when looking up key for encryption of item.";case 2:if(!this.contentTypeUsesRootKeyEncryption(t.content_type)){e.next=15;break}return e.next=5,this.getRootKey();case 5:if(r=e.sent){e.next=12;break}if(!Object(Gt.b)(n)){e.next=11;break}throw"Root key encryption is required but no root key is available.";case 11:return e.abrupt("return",void 0);case 12:return e.abrupt("return",r);case 15:return e.abrupt("return",this.getDefaultItemsKey());case 16:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)})},{key:"keyToUseForDecryptionOfPayload",value:(b=Go(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.contentTypeUsesRootKeyEncryption(t.content_type)){e.next=2;break}return e.abrupt("return",this.getRootKey());case 2:if(!t.items_key_id){e.next=5;break}return n=this.itemsKeyForPayload(t),e.abrupt("return",n);case 5:if((r=t.version)!==this.getLatestVersion()){e.next=8;break}throw"No associated key found for item encrypted with latest protocol version.";case 8:return e.abrupt("return",this.defaultItemsKeyForItemVersion(r));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"onSyncEvent",value:(v=Go(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==c.b.FullSyncCompleted){e.next=3;break}return e.next=3,this.handleFullSyncCompletion();case 3:if(t!==c.b.DownloadFirstSyncCompleted){e.next=6;break}return e.next=6,this.handleDownloadFirstSyncCompletion();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"handleDownloadFirstSyncCompletion",value:(d=Go(o.a.mark((function e(){var t,n,r,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.latestItemsKeys(),n=t.filter((function(e){return e.neverSynced})),r=t.find((function(e){return!e.neverSynced&&e.isDefault})),Object(u.p)(r)){e.next=9;break}return e.next=7,this.itemManager.setItemsToBeDeleted(Object(s.b)(n));case 7:e.next=20;break;case 9:return e.next=11,this.getRootKey();case 11:if(!(a=e.sent)){e.next=20;break}if(!((i=n.filter((function(e){return e.version!==a.version}))).length>0)){e.next=17;break}return e.next=17,this.itemManager.setItemsToBeDeleted(Object(s.b)(i));case 17:if(0!==this.latestItemsKeys().length){e.next=20;break}return e.next=20,this.createNewDefaultItemsKey();case 20:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"handleFullSyncCompletion",value:(y=Go(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.getDefaultItemsKey()){e.next=6;break}return e.next=4,this.createNewDefaultItemsKey();case 4:if(this.keyMode!==Ho.WrapperOnly){e.next=6;break}return e.abrupt("return",this.repersistAllItems());case 6:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"repersistAllItems",value:(p=Go(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.items,n=t.map((function(e){return Object(j.e)(e)})),e.abrupt("return",this.storageService.savePayloads(n));case 3:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"latestItemsKeys",value:function(){return this.itemManager.itemsKeys()}},{key:"itemsKeyForPayload",value:function(e){return this.latestItemsKeys().find((function(t){return t.uuid===e.items_key_id}))}},{key:"getDefaultItemsKey",value:function(){var e=this.latestItemsKeys();return 1===e.length?e[0]:e.find((function(e){return e.isDefault}))}},{key:"reencryptItemsKeys",value:(f=Go(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((t=this.latestItemsKeys()).length>0)){e.next=4;break}return e.next=4,this.itemManager.setItemsDirty(Object(s.b)(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"defaultItemsKeyForItemVersion",value:(l=Go(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.latestItemsKeys().find((function(e){return e.version===t})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"createNewDefaultItemsKey",value:(i=Go(o.a.mark((function e(){var t,n,r,a,i,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKey();case 2:if(t=e.sent,n=t?t.version:this.getLatestVersion(),!(Object(Pt.b)(n,ts)<=0)){e.next=16;break}return e.t0=j.e,e.next=8,h.GenerateUuid();case 8:e.t1=e.sent,e.t2=P.a.ItemsKey,e.t3=Object(s.a)({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:n}),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},a=(0,e.t0)(e.t4),r=Ut(a),e.next=19;break;case 16:return e.next=18,this.operatorForVersion(n).createItemsKey();case 18:r=e.sent;case 19:if(!(i=this.getDefaultItemsKey())){e.next=23;break}return e.next=23,this.itemManager.changeItemsKey(i.uuid,(function(e){e.isDefault=!1}));case 23:return e.next=25,this.itemManager.insertItem(r);case 25:return c=e.sent,e.next=28,this.itemManager.changeItemsKey(c.uuid,(function(e){e.isDefault=!0}));case 28:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})}])&&Qo(n.prototype,r),a&&Qo(n,a),t}(Qt.a);function rs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function as(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var is=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),as(this,"payload",void 0),as(this,"defaultContentKeyToDiffOn","text"),as(this,"textCharDiffLength",0),as(this,"hasPreviousEntry",!1);var n=t.updated_at;Object(u.s)(n)&&(n=new Date(n)),this.payload=Object(j.b)(t,{updated_at:n})}var t,n,r;return t=e,(n=[{key:"setPreviousEntry",value:function(e){this.hasPreviousEntry=null!=e,this.payload.contentObject[this.defaultContentKeyToDiffOn]&&(this.textCharDiffLength=e?this.payload.contentObject[this.defaultContentKeyToDiffOn].length-e.payload.contentObject[this.defaultContentKeyToDiffOn].length:this.payload.contentObject[this.defaultContentKeyToDiffOn].length)}},{key:"operationVector",value:function(){return void 0!==this.textCharDiffLength?this.hasPreviousEntry&&0!==this.textCharDiffLength?this.textCharDiffLength<0?-1:1:0:1}},{key:"deltaSize",value:function(){return void 0!==this.textCharDiffLength?Math.abs(this.textCharDiffLength):1}},{key:"isSameAsEntry",value:function(e){if(!e)return!1;var t=Ut(this.payload),n=Ut(e.payload);return t.isItemContentEqualWith(n)}}])&&rs(t.prototype,n),r&&rs(t,r),e}();function os(e){return(os="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ss(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function cs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function us(e,t){return!t||"object"!==os(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ls(e){return(ls=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function fs(e,t){return(fs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ps=function(e){function t(){return ss(this,t),us(this,ls(t).apply(this,arguments))}var n,r,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&fs(e,t)}(t,e),n=t,(r=[{key:"previewTitle",value:function(){return this.payload.updated_at.toLocaleString()}},{key:"previewSubTitle",value:function(){return this.hasPreviousEntry?this.textCharDiffLength<0?"".concat(-1*this.textCharDiffLength," characters removed"):this.textCharDiffLength>0?"".concat(this.textCharDiffLength," characters added"):"Title or metadata changed":"".concat(this.textCharDiffLength," characters loaded")}}])&&cs(n.prototype,r),a&&cs(n,a),t}(is);function hs(e){var t,n,r,a=(t={},n=P.a.Note,r=ps,n in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t)[e[la.a.ContentType]];if(!a)throw"Invalid item history class";return new a(e)}function ys(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ds=function(){function e(t){var n,r,a;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a=[],(r="entries")in(n=this)?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,t){var i=!0,o=!1,s=void 0;try{for(var c,u=t[Symbol.iterator]();!(i=(c=u.next()).done);i=!0){var l=c.value;l.setPreviousEntry(this.getLastEntry()),this.entries.push(l)}}catch(e){o=!0,s=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw s}}}}var t,n,r;return t=e,r=[{key:"FromJson",value:function(t){return new e(t.entries.map((function(e){return hs(e.payload)})))}}],(n=[{key:"getLastEntry",value:function(){return this.entries[this.entries.length-1]}},{key:"addHistoryEntryForItem",value:function(e){var t=hs(e),n=this.getLastEntry();if(t.setPreviousEntry(n),!t.isSameAsEntry(n))return this.entries.push(t),t}},{key:"clear",value:function(){this.entries.length=0}},{key:"optimize",value:function(){var e=this,t=[],n=function(e){return e.deltaSize()>15},r=function(r,a,i){if(i)t.push(r);else{var o=t.indexOf(r);-1!==o&&t.splice(o,1)}if(i&&n(r)&&-1===r.operationVector()){var s=e.entries[a-1];s&&t.push(s)}};this.entries.forEach((function(t,a){if(0===a||a===e.entries.length-1)r(t,a,!0);else{var i=n(t);r(t,a,i)}})),this.entries=this.entries.filter((function(e,n){return-1!==t.indexOf(e)}))}}])&&ys(t.prototype,n),r&&ys(t,r),e}();function vs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function bs(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ms=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),bs(this,"content",void 0),bs(this,"itemRevisionThreshold",60),this.content=t,this.content||(this.content={itemUUIDToItemHistoryMapping:{}})}var t,n,r;return t=e,r=[{key:"FromJson",value:function(t){if(t){var n=t.content;return Object.keys(n.itemUUIDToItemHistoryMapping).forEach((function(e){var t=n.itemUUIDToItemHistoryMapping[e];n.itemUUIDToItemHistoryMapping[e]=ds.FromJson(t)})),new e(n)}return new e}}],(n=[{key:"addEntryForPayload",value:function(e){return this.historyForItem(e.uuid).addHistoryEntryForItem(e)}},{key:"historyForItem",value:function(e){var t=this.content.itemUUIDToItemHistoryMapping[e];return t||(t=new ds,this.content.itemUUIDToItemHistoryMapping[e]=t),t}},{key:"clearItemHistory",value:function(e){this.historyForItem(e.uuid).clear()}},{key:"clearAllHistory",value:function(){this.content.itemUUIDToItemHistoryMapping={}}},{key:"setItemRevisionThreshold",value:function(e){this.itemRevisionThreshold=e}},{key:"optimizeHistoryForItem",value:function(e){var t=this.historyForItem(e);t.entries.length>this.itemRevisionThreshold&&t.optimize()}}])&&vs(t.prototype,n),r&&vs(t,r),e}();function gs(e){return(gs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ws(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ks(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){ws(i,r,a,o,s,"next",e)}function s(e){ws(i,r,a,o,s,"throw",e)}o(void 0)}))}}function xs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ss(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Os(e,t,n){return(Os="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ps(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ps(e){return(Ps=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function js(e,t){return(js=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Cs,Ds,Is,Es=function(e){function t(e,n,r,a){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),i=function(e,t){return!t||"object"!==gs(t)&&"function"!=typeof t?Ss(e):t}(this,Ps(t).call(this)),_s(Ss(i),"itemManager",void 0),_s(Ss(i),"storageService",void 0),_s(Ss(i),"contentTypes",[]),_s(Ss(i),"timeout",void 0),_s(Ss(i),"historySession",void 0),_s(Ss(i),"removeChangeObserver",void 0),_s(Ss(i),"persistable",!1),_s(Ss(i),"autoOptimize",!1),_s(Ss(i),"saveTimeout",void 0),i.itemManager=e,i.storageService=n,i.contentTypes=r,i.timeout=a,i}var n,r,a,i,s,c,l,f,p,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&js(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.itemManager=void 0,this.storageService=void 0,this.contentTypes.length=0,this.historySession=void 0,this.timeout=null,this.removeChangeObserver&&(this.removeChangeObserver(),this.removeChangeObserver=null),Os(Ps(t.prototype),"deinit",this).call(this)}},{key:"initializeFromDisk",value:(h=ks(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Nt.SessionHistoryPersistable);case 2:return this.persistable=e.sent,e.next=5,this.storageService.getValue(Nt.SessionHistoryRevisions).then((function(e){return ms.FromJson(e)}));case 5:return this.historySession=e.sent,e.next=8,this.storageService.getValue(Nt.SessionHistoryOptimize);case 8:t=e.sent,Object(u.p)(t)?this.autoOptimize=!0:this.autoOptimize=t,this.addChangeObserver();case 11:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"addChangeObserver",value:function(){var e=this;this.removeChangeObserver=this.itemManager.addObserver(this.contentTypes,(function(t,n,r,a){var i=Object(u.f)(t,n,r);if(a!==_.a.LocalChanged){var o=!0,s=!1,c=void 0;try{for(var l,f=i[Symbol.iterator]();!(o=(l=f.next()).done);o=!0){var p=l.value;try{p.deleted||p.errorDecrypting||e.addHistoryEntryForItem(p)}catch(e){console.error("Unable to add item history entry:",e)}}}catch(e){s=!0,c=e}finally{try{o||null==f.return||f.return()}finally{if(s)throw c}}}}))}},{key:"isDiskEnabled",value:function(){return this.persistable}},{key:"isAutoOptimizeEnabled",value:function(){return this.autoOptimize}},{key:"saveToDisk",value:(p=ks(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable){e.next=2;break}return e.abrupt("return");case 2:this.storageService.setValue(Nt.SessionHistoryRevisions,this.historySession);case 3:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"setSessionItemRevisionThreshold",value:function(e){this.historySession.setItemRevisionThreshold(e)}},{key:"addHistoryEntryForItem",value:(f=ks(o.a.mark((function e(t){var n,r,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Object(j.f)(t,_.a.SessionHistory),r=this.historySession.addEntryForPayload(n),this.autoOptimize&&this.historySession.optimizeHistoryForItem(t.uuid),r&&this.persistable&&(this.saveTimeout&&(this.timeout.hasOwnProperty("cancel")?this.timeout.cancel(this.saveTimeout):clearTimeout(this.saveTimeout)),this.saveTimeout=this.timeout((function(){a.saveToDisk()}),2e3));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"historyForItem",value:function(e){return this.historySession.historyForItem(e.uuid)}},{key:"clearHistoryForItem",value:(l=ks(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearItemHistory(t),e.abrupt("return",this.saveToDisk());case 2:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"clearAllHistory",value:(c=ks(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearAllHistory(),e.abrupt("return",this.storageService.removeValue(Nt.SessionHistoryRevisions));case 2:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"toggleDiskSaving",value:(s=ks(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable=!this.persistable,!this.persistable){e.next=6;break}this.storageService.setValue(Nt.SessionHistoryPersistable,!0),this.saveToDisk(),e.next=8;break;case 6:return this.storageService.setValue(Nt.SessionHistoryPersistable,!1),e.abrupt("return",this.storageService.removeValue(Nt.SessionHistoryRevisions));case 8:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"toggleAutoOptimize",value:(i=ks(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.autoOptimize=!this.autoOptimize,this.autoOptimize?this.storageService.setValue(Nt.SessionHistoryOptimize,!0):this.storageService.setValue(Nt.SessionHistoryOptimize,!1);case 2:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})}])&&xs(n.prototype,r),a&&xs(n,a),t}(Qt.a);function Ms(e){return(Ms="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Rs(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ts(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Rs(i,r,a,o,s,"next",e)}function s(e){Rs(i,r,a,o,s,"throw",e)}o(void 0)}))}}function As(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ks(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Fs(e,t,n){return(Fs="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ls(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ls(e){return(Ls=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Vs(e,t){return(Vs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ns(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.None=0]="None",e[e.FiveMinutes=300]="FiveMinutes",e[e.OneHour=3600]="OneHour",e[e.OneWeek=604800]="OneWeek"}(Is||(Is={}));var Ws,Us=(Ns(Cs={},L.AccountPassword,{label:"Account Password",prompt:"Please enter your account password."}),Ns(Cs,L.LocalPasscode,{label:"Local Passcode",prompt:"Please enter your local passcode."}),Cs),Bs=(Ns(Ds={},F.ManageExtensions,{label:"Manage Extensions"}),Ns(Ds,F.ManageBackups,{label:"Download/Import Backups"}),Ns(Ds,F.ViewProtectedNotes,{label:"View Protected Notes"}),Ns(Ds,F.ManagePrivileges,{label:"Manage Privileges"}),Ns(Ds,F.ManagePasscode,{label:"Manage Passcode"}),Ns(Ds,F.DeleteNote,{label:"Delete Notes"}),Ds),Hs=function(e){function t(e,n,r,a,i,o){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s=function(e,t){return!t||"object"!==Ms(t)&&"function"!=typeof t?Ks(e):t}(this,Ls(t).call(this)),Ns(Ks(s),"itemManager",void 0),Ns(Ks(s),"syncService",void 0),Ns(Ks(s),"singletonManager",void 0),Ns(Ks(s),"protocolService",void 0),Ns(Ks(s),"storageService",void 0),Ns(Ks(s),"sessionManager",void 0),Ns(Ks(s),"availableActions",[]),Ns(Ks(s),"availableCredentials",[]),s.itemManager=e,s.syncService=n,s.singletonManager=r,s.protocolService=a,s.storageService=i,s.sessionManager=o,s.loadDefaults(),s}var n,r,a,i,c,u,l,f,p,h,y,d,v;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Vs(e,t)}(t,e),n=t,(r=[{key:"deinit",value:function(){this.itemManager=void 0,this.syncService=void 0,this.singletonManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.sessionManager=void 0,Fs(Ls(t.prototype),"deinit",this).call(this)}},{key:"loadDefaults",value:function(){this.availableActions=Object.keys(F).map((function(e){return F[e]})),this.availableCredentials=[L.AccountPassword,L.LocalPasscode]}},{key:"getAvailableActions",value:function(){return this.availableActions}},{key:"getAvailableCredentials",value:function(){return this.availableCredentials}},{key:"netCredentialsForAction",value:(v=Ts(o.a.mark((function e(t){var n,r,a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getPrivileges();case 2:n=e.sent,r=n.getCredentialsForAction(t),a=[],i=!0,s=!1,c=void 0,e.prev=8,u=r[Symbol.iterator]();case 10:if(i=(l=u.next()).done){e.next=27;break}if((f=l.value)!==L.AccountPassword){e.next=19;break}return e.next=15,this.sessionManager.online();case 15:e.sent&&a.push(f),e.next=24;break;case 19:if(f!==L.LocalPasscode){e.next=24;break}return e.next=22,this.protocolService.hasRootKeyWrapper();case 22:e.sent&&a.push(f);case 24:i=!0,e.next=10;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(8),s=!0,c=e.t0;case 33:e.prev=33,e.prev=34,i||null==u.return||u.return();case 36:if(e.prev=36,!s){e.next=39;break}throw c;case 39:return e.finish(36);case 40:return e.finish(33);case 41:return e.abrupt("return",a);case 42:case"end":return e.stop()}}),e,this,[[8,29,33,41],[34,,36,40]])}))),function(e){return v.apply(this,arguments)})},{key:"getPrivileges",value:(d=Ts(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=P.a.Privileges,n=new C.a("content_type","=",t),e.abrupt("return",this.singletonManager.findOrCreateSingleton(n,t,Object(s.a)({})));case 3:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"setSessionLength",value:(y=Ts(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t,a=void 0,(a=new Date).setSeconds(a.getSeconds()+r),n=a,e.next=4,this.storageService.setValue(Nt.PrivilegesExpirey,n);case 4:return e.next=6,this.storageService.setValue(Nt.PrivilegesSessionLength,t);case 6:case"end":return e.stop()}var r,a}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"clearSession",value:(h=Ts(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setSessionLength(Is.None));case 1:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"getSelectedSessionLength",value:(p=Ts(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Nt.PrivilegesSessionLength);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",t);case 7:return e.abrupt("return",Is.None);case 8:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"getSessionExpirey",value:(f=Ts(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Nt.PrivilegesExpirey);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",new Date(t));case 7:return e.abrupt("return",new Date);case 8:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"actionHasPrivilegesConfigured",value:(l=Ts(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:return e.t0=e.sent.length,e.abrupt("return",e.t0>0);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"actionRequiresPrivilege",value:(u=Ts(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSessionExpirey();case 2:if(!(e.sent>new Date)){e.next=5;break}return e.abrupt("return",!1);case 5:return e.next=7,this.netCredentialsForAction(t);case 7:return n=e.sent,e.abrupt("return",n.length>0);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"authenticateAction",value:(c=Ts(o.a.mark((function e(t,n){var r,a,i,s,c,u,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:r=e.sent,a=[],i=[],s=!0,c=!1,u=void 0,e.prev=8,l=r[Symbol.iterator]();case 10:if(s=(f=l.next()).done){e.next=19;break}return p=f.value,e.next=14,this.verifyAuthenticationParameters(p,n[p]);case 14:e.sent?a.push(p):i.push(p);case 16:s=!0,e.next=10;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(8),c=!0,u=e.t0;case 25:e.prev=25,e.prev=26,s||null==l.return||l.return();case 28:if(e.prev=28,!c){e.next=31;break}throw u;case 31:return e.finish(28);case 32:return e.finish(25);case 33:return e.abrupt("return",{success:0===i.length,successfulCredentials:a,failedCredentials:i});case 34:case"end":return e.stop()}}),e,this,[[8,21,25,33],[26,,28,32]])}))),function(e,t){return c.apply(this,arguments)})},{key:"verifyAuthenticationParameters",value:(i=Ts(o.a.mark((function e(t,n){var r,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==L.AccountPassword){e.next=8;break}return e.next=3,this.protocolService.validateAccountPassword(n);case 3:return r=e.sent,a=r.valid,e.abrupt("return",a);case 8:if(t!==L.LocalPasscode){e.next=14;break}return e.next=11,this.protocolService.validatePasscode(n);case 11:return i=e.sent,s=i.valid,e.abrupt("return",s);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"displayInfoForCredential",value:function(e){return Us[e]}},{key:"displayInfoForAction",value:function(e){return Bs[e]}},{key:"getSessionLengthOptions",value:function(){return[{value:Is.None,label:"Don't Remember"},{value:Is.FiveMinutes,label:"5 Minutes"},{value:Is.OneHour,label:"1 Hour"},{value:Is.OneWeek,label:"1 Week"}]}}])&&As(n.prototype,r),a&&As(n,a),t}(Qt.a);function zs(e){return(zs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function qs(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Js(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Gs(e,t){return!t||"object"!==zs(t)&&"function"!=typeof t?Qs(e):t}function Qs(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function $s(e,t,n){return($s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ys(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ys(e){return(Ys=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Xs(e,t){return(Xs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Zs(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.CreatedAt="created_at",e.UpdatedAt="userModifiedDate",e.Title="title"}(Ws||(Ws={}));var ec=function(e){function t(){var e,n;qs(this,t);for(var r=arguments.length,a=new Array(r),i=0;i<r;i++)a[i]=arguments[i];return Zs(Qs(n=Gs(this,(e=Ys(t)).call.apply(e,[this].concat(a)))),"displaySortBy",{}),Zs(Qs(n),"displayFilter",{}),Zs(Qs(n),"filteredMap",{}),Zs(Qs(n),"sortedMap",{}),n}var n,r,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Xs(e,t)}(t,e),n=t,(r=[{key:"set",value:function(e){e=Array.isArray(e)?e:[e],$s(Ys(t.prototype),"set",this).call(this,e),this.filterSortElements(e)}},{key:"discard",value:function(e){e=Array.isArray(e)?e:[e],$s(Ys(t.prototype),"discard",this).call(this,e),this.filterSortElements(e)}},{key:"setDisplayOptions",value:function(e,t,n,r){var a=this.displaySortBy[e],i=this.displayFilter[e];if(!a||a.key!==t||a.dir!==n||i||r){this.displaySortBy[e]=t?{key:t,dir:n}:void 0,this.displayFilter[e]=r,this.filteredMap[e]={},this.sortedMap[e]=[];var o=this.all(e);o.length>0&&this.filterSortElements(o)}}},{key:"displayElements",value:function(e){var t=this.sortedMap[e];if(!t)throw Error("Attempting to access display elements for \n        non-configured content type ".concat(e));return t.slice()}},{key:"filterSortElements",value:function(e){if(0!==Object.keys(this.displaySortBy).length){var t=new Set,n=!0,r=!1,a=void 0;try{for(var i,o=e[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value,c=s.content_type,l=this.displaySortBy[c];if(l){var f=this.displayFilter[c],p=this.filteredMap[c],h=this.sortedMap[c],y=!(s.deleted||!this.map[s.uuid])&&(!f||f(s)),d=p[s.uuid];if(y)if(Object(u.p)(d))h.push(s),t.add(c);else{var v=h[d],b=v[l.key],m=s[l.key];h[d]=s;var g=v.pinned!==s.pinned;Object(u.e)(b,m)&&!g||t.add(c)}else Object(u.p)(d)||(delete p[s.uuid],h[d]=void 0,t.add(c))}}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}var w=!0,k=!1,x=void 0;try{for(var S,O=t.values()[Symbol.iterator]();!(w=(S=O.next()).done);w=!0){var P=S.value;this.resortContentType(P)}}catch(e){k=!0,x=e}finally{try{w||null==O.return||O.return()}finally{if(k)throw x}}}}},{key:"resortContentType",value:function(e){var t=this.sortedMap[e],n=this.displaySortBy[e],r=this.filteredMap[e],a=t.sort((function(e,t){return function e(t,r){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t)return-1;if(!r)return 1;if(!a){if(t.pinned&&r.pinned)return e(t,r,!0);if(t.pinned)return-1;if(r.pinned)return 1}var i=t[n.key]||"",o=r[n.key]||"",s=1;if("asc"===n.dir&&(s*=-1),n.key===Ws.Title){if(i=i.toLowerCase(),o=o.toLowerCase(),0===i.length&&0===o.length)return 0;if(0===i.length&&0!==o.length)return 1*s;if(0!==i.length&&0===o.length)return-1*s;s*=-1}return i>o?-1*s:i<o?1*s:0}(e,t)})),i=[],o=0,s=!0,c=!1,u=void 0;try{for(var l,f=a[Symbol.iterator]();!(s=(l=f.next()).done);s=!0){var p=l.value;p&&(i.push(p),r[p.uuid]=o,o++)}}catch(e){c=!0,u=e}finally{try{s||null==f.return||f.return()}finally{if(c)throw u}}this.sortedMap[e]=i}}])&&Js(n.prototype,r),a&&Js(n,a),t}(Wr);function tc(e){return(tc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function nc(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function rc(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){nc(i,r,a,o,s,"next",e)}function s(e){nc(i,r,a,o,s,"throw",e)}o(void 0)}))}}function ac(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ic(e){return(ic=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function oc(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function sc(e,t){return(sc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function cc(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var uc=function(e){function t(e){var n,r,a,i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t){return!t||"object"!==tc(t)&&"function"!=typeof t?oc(e):t}(this,ic(t).call(this)),cc(oc(n),"modelManager",void 0),cc(oc(n),"unsubChangeObserver",void 0),cc(oc(n),"observers",[]),cc(oc(n),"collection",void 0),cc(oc(n),"systemSmartTags",void 0),n.modelManager=e,n.createCollection(),n.unsubChangeObserver=n.modelManager.addObserver(P.a.Any,n.onPayloadChange.bind(oc(n))),n.systemSmartTags=(r=Object(j.e)({uuid:"all-notes",content_type:P.a.SmartTag,content:Object(s.a)({title:"All notes",isSystemTag:!0,isAllTag:!0,predicate:C.a.FromArray(["content_type","=",P.a.Note])})}),a=Object(j.e)({uuid:"archived-notes",content_type:P.a.SmartTag,content:Object(s.a)({title:"Archived",isSystemTag:!0,isArchiveTag:!0,predicate:C.a.FromArray(["archived","=",JSON.stringify(!0)])})}),i=Object(j.e)({uuid:"trashed-notes",content_type:P.a.SmartTag,content:Object(s.a)({title:"Trash",isSystemTag:!0,isTrashTag:!0,predicate:C.a.FromArray(["trashed","=",JSON.stringify(!0)])})}),[Ut(r),Ut(a),Ut(i)]),n}var n,r,a,i,c,l,f,p,y,d,b,m,g,w,k,x,S,O,D,I,E,M,R,T,A,K;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&sc(e,t)}(t,e),n=t,(r=[{key:"setDisplayOptions",value:function(e,t,n,r){this.collection.setDisplayOptions(e,t,n,r)}},{key:"getDisplayableItems",value:function(e){return this.collection.displayElements(e)}},{key:"deinit",value:function(){this.unsubChangeObserver(),this.unsubChangeObserver=void 0,this.modelManager=void 0,this.collection=void 0}},{key:"resetState",value:function(){this.createCollection()}},{key:"createCollection",value:function(){this.collection=new ec,this.collection.setDisplayOptions(P.a.Note,Ws.CreatedAt,"dsc"),this.collection.setDisplayOptions(P.a.Tag,Ws.Title,"asc"),this.collection.setDisplayOptions(P.a.ItemsKey,Ws.CreatedAt,"asc"),this.collection.setDisplayOptions(P.a.Component,Ws.CreatedAt,"asc"),this.collection.setDisplayOptions(P.a.SmartTag,Ws.Title,"asc")}},{key:"findItem",value:function(e){return this.collection.find(e)}},{key:"findItems",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.collection.findAll(e,t)}},{key:"itemsKeys",value:function(){return this.collection.displayElements(P.a.ItemsKey)}},{key:"addObserver",value:function(e,t){var n=this;Array.isArray(e)||(e=[e]);var r={contentType:e,callback:t};return this.observers.push(r),function(){Object(u.B)(n.observers,r)}}},{key:"itemsReferencingItem",value:function(e){if(!Object(u.s)(e))throw Error("Must use uuid string");var t=this.collection.uuidsThatReferenceUuid(e);return this.findItems(t)}},{key:"referencesForItem",value:function(e){if(!Object(u.s)(e))throw Error("Must use uuid string");var t=this.findItem(e).references.map((function(e){return e.uuid}));return this.findItems(t)}},{key:"onPayloadChange",value:(K=rc(o.a.mark((function e(t,n,r,a,i){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setPayloads(t,n,r,a,i));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return K.apply(this,arguments)})},{key:"setPayloads",value:(A=rc(o.a.mark((function e(t,n,r,a,i){var s,c,u,l,f,p,h,y,d,v;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(s=t.map((function(e){return Ut(e)})),c=n.map((function(e){return Ut(e)})),(u=s.concat(c)).length>0&&this.collection.set(u),l=r.map((function(e){return Ut(e)})),f=!0,p=!1,h=void 0,e.prev=8,y=l[Symbol.iterator]();!(f=(d=y.next()).done);f=!0)v=d.value,this.collection.discard(v);e.next=16;break;case 12:e.prev=12,e.t0=e.catch(8),p=!0,h=e.t0;case 16:e.prev=16,e.prev=17,f||null==y.return||y.return();case 19:if(e.prev=19,!p){e.next=22;break}throw h;case 22:return e.finish(19);case 23:return e.finish(16);case 24:return e.next=26,this.notifyObservers(s,c,l,a,i);case 26:case"end":return e.stop()}}),e,this,[[8,12,16,24],[17,,19,23]])}))),function(e,t,n,r,a){return A.apply(this,arguments)})},{key:"notifyObservers",value:(T=rc(o.a.mark((function e(t,n,r,a,i){var s,c,u,l,f,p,h,y,d,v,b;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=function(e,t){return e.filter((function(e){return t.includes(P.a.Any)||t.includes(e.content_type)}))},c=this.observers.slice(),u=!0,l=!1,f=void 0,e.prev=5,p=c[Symbol.iterator]();case 7:if(u=(h=p.next()).done){e.next=19;break}if(y=h.value,d=s(t,y.contentType),v=s(n,y.contentType),b=s(r,y.contentType),0!==d.length||0!==v.length||0!==b.length){e.next=14;break}return e.abrupt("continue",16);case 14:return e.next=16,y.callback(d,v,b,a,i);case 16:u=!0,e.next=7;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(5),l=!0,f=e.t0;case 25:e.prev=25,e.prev=26,u||null==p.return||p.return();case 28:if(e.prev=28,!l){e.next=31;break}throw f;case 31:return e.finish(28);case 32:return e.finish(25);case 33:case"end":return e.stop()}}),e,this,[[5,21,25,33],[26,,28,32]])}))),function(e,t,n,r,a){return T.apply(this,arguments)})},{key:"changeItem",value:(R=rc(o.a.mark((function e(t,n){var r,a,i,s,c=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]?c[2]:v.c.UserInteraction,a=c.length>3&&void 0!==c[3]?c[3]:_.a.LocalChanged,i=c.length>4?c[4]:void 0,Object(u.s)(t)){e.next=5;break}throw Error("Invalid uuid for changeItem");case 5:return e.next=7,this.changeItems([t],n,r,a,i);case 7:return s=e.sent,e.abrupt("return",s[0]);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return R.apply(this,arguments)})},{key:"createMutatorForItem",value:function(e,t){return e.content_type===P.a.Note?new Ot(e,t):e.content_type===P.a.Tag?new ot(e,t):e.content_type===P.a.Component?new de(e,t):e.content_type===P.a.ActionsExtension?new Qe(e,t):e.content_type===P.a.ItemsKey?new Ft(e,t):e.content_type===P.a.Privileges?new te(e,t):e.content_type===P.a.UserPrefs?new N(e,t):new v.b(e,t)}},{key:"changeItems",value:(M=rc(o.a.mark((function e(t,n){var r,a,i,s,c,u,l,f,p,h,y,d,b,m,g=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=g.length>2&&void 0!==g[2]?g[2]:v.c.UserInteraction,a=g.length>3&&void 0!==g[3]?g[3]:_.a.LocalChanged,i=g.length>4?g[4]:void 0,s=this.findItems(t,!0),c=[],u=!0,l=!1,f=void 0,e.prev=8,p=s[Symbol.iterator]();case 10:if(u=(h=p.next()).done){e.next=21;break}if(y=h.value){e.next=14;break}throw Error("Attempting to change non-existant item");case 14:d=this.createMutatorForItem(y,r),n&&n(d),b=d.getResult(),c.push(b);case 18:u=!0,e.next=10;break;case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(8),l=!0,f=e.t0;case 27:e.prev=27,e.prev=28,u||null==p.return||p.return();case 30:if(e.prev=30,!l){e.next=33;break}throw f;case 33:return e.finish(30);case 34:return e.finish(27);case 35:return e.next=37,this.modelManager.emitPayloads(c,a,i);case 37:return m=this.findItems(c.map((function(e){return e.uuid}))),e.abrupt("return",m);case 39:case"end":return e.stop()}}),e,this,[[8,23,27,35],[28,,30,34]])}))),function(e,t){return M.apply(this,arguments)})},{key:"changeNote",value:(E=rc(o.a.mark((function e(t,n){var r,a,i,s,c,u=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:v.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:_.a.LocalChanged,i=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant note");case 6:return c=new Ot(s,r),e.abrupt("return",this.applyTransform(c,n,a,i));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return E.apply(this,arguments)})},{key:"changeComponent",value:(I=rc(o.a.mark((function e(t,n){var r,a,i,s,c,u=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:v.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:_.a.LocalChanged,i=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant component");case 6:return c=new de(s,r),e.abrupt("return",this.applyTransform(c,n,a,i));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return I.apply(this,arguments)})},{key:"changeActionsExtension",value:(D=rc(o.a.mark((function e(t,n){var r,a,i,s,c,u=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:v.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:_.a.LocalChanged,i=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant extension");case 6:return c=new Qe(s,r),e.abrupt("return",this.applyTransform(c,n,a,i));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return D.apply(this,arguments)})},{key:"changeItemsKey",value:(O=rc(o.a.mark((function e(t,n){var r,a,i,s,c,u=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:v.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:_.a.LocalChanged,i=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant itemsKey");case 6:return c=new Ft(s,r),e.abrupt("return",this.applyTransform(c,n,a,i));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return O.apply(this,arguments)})},{key:"applyTransform",value:(S=rc(o.a.mark((function e(t,n){var r,a,i,s=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]?s[2]:_.a.LocalChanged,a=s.length>3?s[3]:void 0,n(t),i=t.getResult(),e.abrupt("return",this.modelManager.emitPayload(i,r,a));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return S.apply(this,arguments)})},{key:"setItemDirty",value:(x=rc(o.a.mark((function e(t){var n,r,a=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=a.length>1&&void 0!==a[1]&&a[1],Object(u.s)(t)){e.next=3;break}throw Error("Must use uuid when setting item dirty");case 3:return e.next=5,this.setItemsDirty([t],n);case 5:return r=e.sent,e.abrupt("return",r[0]);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"setItemsDirty",value:(k=rc(o.a.mark((function e(t){var n,r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]&&r[1],Object(u.s)(t[0])){e.next=3;break}throw Error("Must use uuid when setting item dirty");case 3:return e.abrupt("return",this.changeItems(t,void 0,n?v.c.UserInteraction:v.c.Internal));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"getDirtyItems",value:function(){return this.collection.dirtyElements().filter((function(e){return!e.errorDecrypting||e.deleted}))}},{key:"insertItem",value:(w=rc(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.payload,e.next=3,this.emitItemFromPayload(n);case 3:return r=e.sent,e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"duplicateItem",value:(g=rc(o.a.mark((function e(t){var n,r,a,i,s,c=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>1&&void 0!==c[1]&&c[1],r=this.findItem(t),a=Object(j.e)(r),e.next=5,ra(a,this.modelManager.getMasterCollection(),n);case 5:return i=e.sent,e.next=8,this.modelManager.emitPayloads(i,_.a.LocalChanged);case 8:return s=this.findItem(i[0].uuid),e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"createItem",value:(m=rc(o.a.mark((function e(t,n){var r,a,i,c=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]&&c[2],a=c.length>3?c[3]:void 0,t){e.next=4;break}throw"Attempting to create item with no contentType";case 4:return e.t0=j.e,e.next=7,h.GenerateUuid();case 7:return e.t1=e.sent,e.t2=t,e.t3=n?Object(s.a)(n):void 0,e.t4=r,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:e.t4},e.t6=a,i=(0,e.t0)(e.t5,e.t6),e.next=16,this.modelManager.emitPayload(i,_.a.Constructor);case 16:return e.abrupt("return",this.findItem(i.uuid));case 17:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)})},{key:"createTemplateItem",value:(b=rc(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=j.e,e.next=3,h.GenerateUuid();case 3:return e.t1=e.sent,e.t2=t,e.t3=Object(s.a)(n||{}),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},r=(0,e.t0)(e.t4),e.abrupt("return",Ut(r));case 9:case"end":return e.stop()}}),e)}))),function(e,t){return b.apply(this,arguments)})},{key:"emitItemFromPayload",value:(d=rc(o.a.mark((function e(t){var n,r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:_.a.Constructor,e.next=3,this.modelManager.emitPayload(t,n);case 3:return e.abrupt("return",this.findItem(t.uuid));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"emitItemsFromPayloads",value:(y=rc(o.a.mark((function e(t){var n,r,a=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:_.a.Constructor,e.next=3,this.modelManager.emitPayloads(t,n);case 3:return r=Object(s.b)(t),e.abrupt("return",this.findItems(r));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"setItemToBeDeleted",value:(p=rc(o.a.mark((function e(t){var n,r,a,i,s,c,u,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.collection.uuidsThatReferenceUuid(t),r=this.findItem(t),e.next=4,this.changeItem(t,(function(e){e.setDeleted()}));case 4:a=e.sent,i=!0,s=!1,c=void 0,e.prev=8,u=n[Symbol.iterator]();case 10:if(i=(l=u.next()).done){e.next=19;break}if(f=l.value,!(p=this.findItem(f))){e.next=16;break}return e.next=16,this.changeItem(p.uuid,(function(e){e.removeItemAsRelationship(r)}));case 16:i=!0,e.next=10;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(8),s=!0,c=e.t0;case 25:e.prev=25,e.prev=26,i||null==u.return||u.return();case 28:if(e.prev=28,!s){e.next=31;break}throw c;case 31:return e.finish(28);case 32:return e.finish(25);case 33:return e.abrupt("return",a);case 34:case"end":return e.stop()}}),e,this,[[8,21,25,33],[26,,28,32]])}))),function(e){return p.apply(this,arguments)})},{key:"setItemsToBeDeleted",value:(f=rc(o.a.mark((function e(t){var n,r,a,i,s,c,u,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],r=!0,a=!1,i=void 0,e.prev=4,s=t[Symbol.iterator]();case 6:if(r=(c=s.next()).done){e.next=15;break}return u=c.value,e.next=10,this.setItemToBeDeleted(u);case 10:l=e.sent,n.push(l);case 12:r=!0,e.next=6;break;case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(4),a=!0,i=e.t0;case 21:e.prev=21,e.prev=22,r||null==s.return||s.return();case 24:if(e.prev=24,!a){e.next=27;break}throw i;case 27:return e.finish(24);case 28:return e.finish(21);case 29:return e.abrupt("return",n);case 30:case"end":return e.stop()}}),e,this,[[4,17,21,29],[22,,24,28]])}))),function(e){return f.apply(this,arguments)})},{key:"getItems",value:function(e){return this.collection.all(e)}},{key:"nonErroredItemsForContentType",value:function(e){return this.collection.all(e).filter((function(e){return!e.errorDecrypting&&!e.waitingForKey}))}},{key:"itemsMatchingPredicate",value:function(e){return this.itemsMatchingPredicates([e])}},{key:"itemsMatchingPredicates",value:function(e){return this.subItemsMatchingPredicates(this.items,e)}},{key:"subItemsMatchingPredicates",value:function(e,t){return e.filter((function(e){if(e.deleted)return!1;var n=!0,r=!1,a=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;if(!e.satisfiesPredicate(s))return!1}}catch(e){r=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw a}}return!0}))}},{key:"findTagByTitle",value:function(e){return Object(u.D)(this.tags,{title:e})}},{key:"findOrCreateTagByTitle",value:(l=rc(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.findTagByTitle(t),e.t0=n,e.t0){e.next=6;break}return e.next=5,this.createItem(P.a.Tag,Object(s.a)({title:t}),!0);case 5:e.t0=e.sent;case 6:return e.abrupt("return",e.t0);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"notesMatchingSmartTag",value:function(e){var t=[new C.a("content_type","=",P.a.Note),e.predicate];if(!e.isTrashTag){var n=new C.a("content.trashed","=",!1);t.push(n)}return this.itemsMatchingPredicates(t)}},{key:"emptyTrash",value:(c=rc(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.trashedItems,e.abrupt("return",this.setItemsToBeDeleted(Object(s.b)(t)));case 2:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"getSmartTags",value:function(){var e=this.collection.displayElements(P.a.SmartTag);return this.systemSmartTags.concat(e)}},{key:"removeAllItemsFromMemory",value:(i=rc(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(s.b)(this.items),e.next=3,this.changeItems(t,(function(e){e.setDeleted()}),v.c.NonDirtying);case 3:this.resetState(),this.modelManager.resetState();case 5:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"removeItemLocally",value:function(e){this.collection.discard(e),this.modelManager.removePayloadLocally(e.payload)}},{key:"items",get:function(){return this.collection.all()}},{key:"nonDeletedItems",get:function(){return this.collection.nondeletedElements()}},{key:"invalidItems",get:function(){return this.collection.invalidElements()}},{key:"notes",get:function(){return this.collection.displayElements(P.a.Note)}},{key:"tags",get:function(){return this.collection.displayElements(P.a.Tag)}},{key:"components",get:function(){return this.collection.displayElements(P.a.Component)}},{key:"trashSmartTag",get:function(){return this.systemSmartTags.find((function(e){return e.isTrashTag}))}},{key:"trashedItems",get:function(){return this.notesMatchingSmartTag(this.trashSmartTag)}},{key:"noteCount",get:function(){return this.collection.all(P.a.Note).length}}])&&ac(n.prototype,r),a&&ac(n,a),t}(Qt.a);function lc(e,t){return e.sort((function(e,n){var r=new Date(n.updated_at).getTime()-new Date(e.updated_at).getTime(),a=0,i=0;return t&&(a=t.indexOf(e.content_type),i=t.indexOf(n.content_type),-1===a&&(a=t.length),-1===i&&(i=t.length)),a===i?r:a<i?-1:1}))}function fc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function pc(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var hc=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),pc(this,"interval",void 0),pc(this,"receiver",void 0),pc(this,"inProgress",!1),pc(this,"completedUpload",0),pc(this,"totalUpload",0),pc(this,"downloaded",0),pc(this,"databaseLoadCurrent",0),pc(this,"databaseLoadTotal",0),pc(this,"databaseLoadDone",!1),pc(this,"syncing",!1),pc(this,"syncStart",void 0),pc(this,"syncEnd",void 0),pc(this,"timingMonitor",void 0),pc(this,"error",void 0),this.interval=t,this.receiver=n}var t,n,r;return t=e,(n=[{key:"deinit",value:function(){this.stopTimingMonitor()}},{key:"setSyncInProgress",value:function(e){this.inProgress=!0}},{key:"setUploadStatus",value:function(e,t){this.completedUpload=e,this.totalUpload=t,this.receiver(Fa.a.StatusChanged)}},{key:"setDownloadStatus",value:function(e){this.downloaded+=e,this.receiver(Fa.a.StatusChanged)}},{key:"setDatabaseLoadStatus",value:function(e,t,n){this.databaseLoadCurrent=e,this.databaseLoadTotal=t,this.databaseLoadDone=n,n?this.receiver(Fa.a.LocalDataLoaded):this.receiver(Fa.a.LocalDataIncrementalLoad)}},{key:"getStats",value:function(){return{uploadCompletionCount:this.completedUpload,uploadTotalCount:this.totalUpload,downloadCount:this.downloaded,localDataDone:this.databaseLoadDone,localDataCurrent:this.databaseLoadCurrent,localDataTotal:this.databaseLoadTotal}}},{key:"setDidBegin",value:function(){this.syncing=!0,this.syncStart=new Date}},{key:"setDidEnd",value:function(){this.syncing=!1,this.syncEnd=new Date}},{key:"startTimingMonitor",value:function(){var e=this;this.timingMonitor&&this.stopTimingMonitor(),this.timingMonitor=this.interval((function(){e.secondsSinceSyncStart>5&&(e.receiver(Fa.a.SyncTakingTooLong),e.stopTimingMonitor())}),500)}},{key:"stopTimingMonitor",value:function(){Object.prototype.hasOwnProperty.call(this.interval,"cancel")?this.interval.cancel(this.timingMonitor):clearInterval(this.timingMonitor),this.timingMonitor=null}},{key:"hasError",value:function(){return!!this.error}},{key:"setError",value:function(e){this.error=e}},{key:"clearError",value:function(){this.error=null}},{key:"reset",value:function(){this.downloaded=0,this.completedUpload=0,this.totalUpload=0,this.inProgress=!1,this.syncing=!1,this.error=null,this.stopTimingMonitor(),this.receiver(Fa.a.StatusChanged)}},{key:"syncInProgress",get:function(){return!0===this.syncing}},{key:"secondsSinceSyncStart",get:function(){return((new Date).getTime()-this.syncStart.getTime())/1e3}}])&&fc(t.prototype,n),r&&fc(t,r),e}();function yc(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function dc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function vc(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var bc=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),vc(this,"lastPreSyncSave",void 0),vc(this,"lastSyncDate",void 0),vc(this,"receiver",void 0),vc(this,"discordance",0),vc(this,"maxDiscordance",void 0),vc(this,"outOfSync",!1),vc(this,"lastClientHash",void 0),vc(this,"lastServerHash",void 0),this.receiver=t,this.maxDiscordance=n,this.reset()}var t,n,r,a,i;return t=e,(n=[{key:"isOutOfSync",value:function(){return this.outOfSync}},{key:"reset",value:function(){this.lastPreSyncSave=void 0,this.lastSyncDate=void 0,this.discordance=0,this.outOfSync=!1}},{key:"getLastClientIntegrityHash",value:function(){return this.lastClientHash}},{key:"clearIntegrityHashes",value:function(){this.lastClientHash=void 0,this.lastServerHash=void 0}},{key:"setIntegrityHashes",value:(a=o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.lastClientHash=t,this.lastServerHash=n,n&&0!==n.length&&t&&t!==n?(this.discordance++,this.discordance>=this.maxDiscordance&&!this.outOfSync&&(this.outOfSync=!0,this.receiver(Fa.a.EnterOutOfSync))):(this.outOfSync&&(this.outOfSync=!1,this.receiver(Fa.a.ExitOutOfSync)),this.discordance=0);case 4:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){yc(i,n,r,o,s,"next",e)}function s(e){yc(i,n,r,o,s,"throw",e)}o(void 0)}))},function(e,t){return i.apply(this,arguments)})},{key:"needsSync",get:function(){return this.discordance>0&&this.discordance<this.maxDiscordance}}])&&dc(t.prototype,n),r&&dc(t,r),e}();function mc(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function gc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function wc(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var kc=function(){function e(t,n,r,a,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),wc(this,"apiService",void 0),wc(this,"protocolService",void 0),wc(this,"contentType",void 0),wc(this,"customEvent",void 0),wc(this,"limit",void 0),wc(this,"progress",void 0),this.apiService=t,this.protocolService=n,this.contentType=r,this.customEvent=a,this.limit=i,this.progress={retrievedPayloads:[]}}var t,n,r,a,i;return t=e,(n=[{key:"run",value:(a=o.a.mark((function e(){var t,n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.apiService.sync([],this.progress.lastSyncToken,this.progress.paginationToken,this.limit||500,!1,this.contentType,this.customEvent);case 2:return t=e.sent,n=t.retrieved_items.map((function(e){return Object(j.f)(e,_.a.RemoteRetrieved)})),e.next=6,this.protocolService.payloadsByDecryptingPayloads(n);case 6:if(r=e.sent,this.progress.retrievedPayloads=this.progress.retrievedPayloads.concat(r),this.progress.lastSyncToken=t.sync_token,this.progress.paginationToken=t.cursor_token,!t.cursor_token){e.next=14;break}return e.abrupt("return",this.run());case 14:return e.abrupt("return",this.progress.retrievedPayloads);case 15:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){mc(i,n,r,o,s,"next",e)}function s(e){mc(i,n,r,o,s,"throw",e)}o(void 0)}))},function(){return i.apply(this,arguments)})}])&&gc(t.prototype,n),r&&gc(t,r),e}();function xc(e){return(xc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Sc(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Oc(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Sc(i,r,a,o,s,"next",e)}function s(e){Sc(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Pc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function jc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _c(e,t){return!t||"object"!==xc(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Cc(e){return(Cc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Dc(e,t){return(Dc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ic=function(e){function t(){return Pc(this,t),_c(this,Cc(t).apply(this,arguments))}var n,r,a,i,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Dc(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(c=Oc(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.applyCollection.source!==_.a.ConflictUuid){e.next=4;break}return e.abrupt("return",this.collectionsByHandlingUuidConflicts());case 4:if(this.applyCollection.source!==_.a.ConflictData){e.next=8;break}return e.abrupt("return",this.collectionsByHandlingDataConflicts());case 8:throw"Unhandled conflict type ".concat(this.applyCollection.source);case 9:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"collectionsByHandlingDataConflicts",value:(s=Oc(o.a.mark((function e(){var t,n,r,a,i,s,c,l,f,p,h,y;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=!0,r=!1,a=void 0,e.prev=4,i=this.applyCollection.all()[Symbol.iterator]();case 6:if(n=(s=i.next()).done){e.next=27;break}if(c=s.value,l=this.findBasePayload(c.uuid)){e.next=12;break}return t.push(c),e.abrupt("continue",24);case 12:if(f=this.findRelatedPayload(c.uuid,_.a.DecryptedTransient)){e.next=18;break}if(c.deleted){e.next=16;break}throw"Unable to find decrypted counterpart for data conflict.";case 16:return t.push(c),e.abrupt("continue",24);case 18:return p=new ba(this.baseCollection,l,f,_.a.ConflictData),e.next=21,p.resultingCollection();case 21:h=e.sent,y=h.all(),Object(u.j)(t,y);case 24:n=!0,e.next=6;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(4),r=!0,a=e.t0;case 33:e.prev=33,e.prev=34,n||null==i.return||i.return();case 36:if(e.prev=36,!r){e.next=39;break}throw a;case 39:return e.finish(36);case 40:return e.finish(33);case 41:return e.abrupt("return",$r.WithPayloads(t,_.a.RemoteRetrieved));case 42:case"end":return e.stop()}}),e,this,[[4,29,33,41],[34,,36,40]])}))),function(){return s.apply(this,arguments)})},{key:"collectionsByHandlingUuidConflicts",value:(i=Oc(o.a.mark((function e(){var t,n,r,a,i,s,c,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=!0,r=!1,a=void 0,e.prev=4,i=this.applyCollection.all()[Symbol.iterator]();case 6:if(n=(s=i.next()).done){e.next=16;break}return c=s.value,l=this.findRelatedPayload(c.uuid,_.a.DecryptedTransient),e.next=11,ia(l,this.baseCollection);case 11:f=e.sent,Object(u.j)(t,f);case 13:n=!0,e.next=6;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(4),r=!0,a=e.t0;case 22:e.prev=22,e.prev=23,n||null==i.return||i.return();case 25:if(e.prev=25,!r){e.next=28;break}throw a;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return e.abrupt("return",$r.WithPayloads(t,_.a.RemoteRetrieved));case 31:case"end":return e.stop()}}),e,this,[[4,18,22,30],[23,,25,29]])}))),function(){return i.apply(this,arguments)})}])&&jc(n.prototype,r),a&&jc(n,a),t}(Rr);function Ec(e){return(Ec="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Mc(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Rc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Tc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ac(e,t){return!t||"object"!==Ec(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Kc(e){return(Kc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Fc(e,t){return(Fc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Lc=function(e){function t(){return Rc(this,t),Ac(this,Kc(t).apply(this,arguments))}var n,r,a,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Fc(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(i=o.a.mark((function e(){var t,n,r,a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t=[],n=!0,r=!1,a=void 0,e.prev=4,i=this.applyCollection.all()[Symbol.iterator]();!(n=(s=i.next()).done);n=!0)c=s.value,u=this.findBasePayload(c.uuid),l=u?u.deleted:c.deleted,f=Object(j.f)(c,_.a.RemoteSaved,{lastSyncEnd:new Date,deleted:l}),t.push(f);e.next=12;break;case 8:e.prev=8,e.t0=e.catch(4),r=!0,a=e.t0;case 12:e.prev=12,e.prev=13,n||null==i.return||i.return();case 15:if(e.prev=15,!r){e.next=18;break}throw a;case 18:return e.finish(15);case 19:return e.finish(12);case 20:return e.abrupt("return",$r.WithPayloads(t,_.a.RemoteSaved));case 21:case"end":return e.stop()}}),e,this,[[4,8,12,20],[13,,15,19]])})),s=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=i.apply(e,t);function o(e){Mc(a,n,r,o,s,"next",e)}function s(e){Mc(a,n,r,o,s,"throw",e)}o(void 0)}))},function(){return s.apply(this,arguments)})}])&&Tc(n.prototype,r),a&&Tc(n,a),t}(Rr);function Vc(e){return(Vc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Nc(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Wc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Uc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Bc(e,t){return!t||"object"!==Vc(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Hc(e){return(Hc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function zc(e,t){return(zc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var qc=function(e){function t(){return Wc(this,t),Bc(this,Hc(t).apply(this,arguments))}var n,r,a,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&zc(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(i=o.a.mark((function e(){var t,n,r,a,i,s,c,l,f,p,h,y,d,v,b,m,g,w,k,x;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=[],r=!0,a=!1,i=void 0,e.prev=5,s=this.applyCollection.all()[Symbol.iterator]();case 7:if(r=(c=s.next()).done){e.next=27;break}if(l=c.value,f=this.findRelatedPayload(l.uuid,_.a.SavedOrSaving),p=this.findRelatedPayload(l.uuid,_.a.DecryptedTransient)){e.next=16;break}if(l.deleted){e.next=14;break}throw"Cannot find decrypted for non-deleted payload.";case 14:return t.push(l),e.abrupt("continue",24);case 16:if(!f){e.next=19;break}return n.push(p),e.abrupt("continue",24);case 19:if(!(h=this.findBasePayload(l.uuid))||!h.dirty){e.next=23;break}return n.push(p),e.abrupt("continue",24);case 23:t.push(p);case 24:r=!0,e.next=7;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(5),a=!0,i=e.t0;case 33:e.prev=33,e.prev=34,r||null==s.return||s.return();case 36:if(e.prev=36,!a){e.next=39;break}throw i;case 39:return e.finish(36);case 40:return e.finish(33);case 41:y=[],d=0,v=n;case 43:if(!(d<v.length)){e.next=60;break}if(b=v[d],m=this.findRelatedPayload(b.uuid,_.a.DecryptedTransient)){e.next=48;break}return e.abrupt("continue",57);case 48:if(g=this.findBasePayload(b.uuid)){e.next=51;break}return e.abrupt("continue",57);case 51:return w=new ba(this.baseCollection,g,m,_.a.ConflictData),e.next=54,w.resultingCollection();case 54:k=e.sent,x=k.all(),Object(u.j)(y,x);case 57:d++,e.next=43;break;case 60:return e.abrupt("return",$r.WithPayloads(t.concat(y),_.a.RemoteRetrieved));case 61:case"end":return e.stop()}}),e,this,[[5,29,33,41],[34,,36,40]])})),s=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=i.apply(e,t);function o(e){Nc(a,n,r,o,s,"next",e)}function s(e){Nc(a,n,r,o,s,"throw",e)}o(void 0)}))},function(){return s.apply(this,arguments)})}])&&Uc(n.prototype,r),a&&Uc(n,a),t}(Rr);function Jc(e){return e===_.a.RemoteRetrieved?qc:e===_.a.RemoteSaved?Lc:e===_.a.ConflictData||e===_.a.ConflictUuid?Ic:void 0}function Gc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Qc=function(){function e(t){var n,r,a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a=void 0,(r="collections")in(n=this)?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,this.collections=t,Object.freeze(this)}var t,n,r;return t=e,(n=[{key:"collectionForSource",value:function(e){return this.collections.find((function(t){return t.source===e}))}}])&&Gc(t.prototype,n),r&&Gc(t,r),e}();function $c(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Yc(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){$c(i,r,a,o,s,"next",e)}function s(e){$c(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Xc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Zc(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var eu,tu=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Zc(this,"response",void 0),Zc(this,"baseCollection",void 0),Zc(this,"relatedCollectionSet",void 0),this.response=t,this.baseCollection=r,this.relatedCollectionSet=new Qc([$r.WithPayloads(n,_.a.DecryptedTransient),$r.WithPayloads(a,_.a.SavedOrSaving)])}var t,n,r,a,i;return t=e,(n=[{key:"collectionsByProcessingResponse",value:(i=Yc(o.a.mark((function e(){var t,n,r,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,this.collectionByProcessingPayloads(this.response.retrievedPayloads,_.a.RemoteRetrieved);case 3:return(n=e.sent).all().length>0&&t.push(n),e.next=7,this.collectionByProcessingPayloads(this.response.savedPayloads,_.a.RemoteSaved);case 7:if((r=e.sent).all().length>0&&t.push(r),!(this.response.uuidConflictPayloads.length>0)){e.next=14;break}return e.next=12,this.collectionByProcessingPayloads(this.response.uuidConflictPayloads,_.a.ConflictUuid);case 12:(a=e.sent).all().length>0&&t.push(a);case 14:if(!(this.response.dataConflictPayloads.length>0)){e.next=19;break}return e.next=17,this.collectionByProcessingPayloads(this.response.dataConflictPayloads,_.a.ConflictData);case 17:(i=e.sent).all().length>0&&t.push(i);case 19:return e.abrupt("return",t);case 20:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"collectionByProcessingPayloads",value:(a=Yc(o.a.mark((function e(t,n){var r,a,i,s,c,u=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=$r.WithPayloads(t,n),a=Jc(n),i=new a(this.baseCollection,r,this.relatedCollectionSet),e.next=5,i.resultingCollection();case 5:return s=e.sent,c=s.all().map((function(e){var t=u.finalDirtyStateForPayload(e);return Object(j.b)(e,{dirty:t,dirtiedDate:t?new Date:void 0})})),e.abrupt("return",$r.WithPayloads(c,n));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"finalDirtyStateForPayload",value:function(e){var t=this.baseCollection.find(e.uuid);return t?e.dirtiedDate&&e.dirtiedDate>t.dirtiedDate?e.dirty:t.dirtiedDate>t.lastSyncBegan:e.dirty}}])&&Xc(t.prototype,n),r&&Xc(t,r),e}();function nu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ru(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.ConflictingData="sync_conflict",e.UuidConflict="uuid_conflict"}(eu||(eu={}));var au,iu=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ru(this,"rawResponse",void 0),ru(this,"savedPayloads",void 0),ru(this,"retrievedPayloads",void 0),ru(this,"uuidConflictPayloads",void 0),ru(this,"dataConflictPayloads",void 0),ru(this,"deletedPayloads",void 0),this.rawResponse=t,this.savedPayloads=this.filterRawItemArray(t.saved_items).map((function(e){return Object(j.f)(e,_.a.RemoteSaved)})),this.retrievedPayloads=this.filterRawItemArray(t.retrieved_items).map((function(e){return Object(j.f)(e,_.a.RemoteRetrieved)})),this.dataConflictPayloads=this.filterRawItemArray(this.rawDataConflictItems).map((function(e){return Object(j.f)(e,_.a.ConflictData)})),this.uuidConflictPayloads=this.filterRawItemArray(this.rawUuidConflictItems).map((function(e){return Object(j.f)(e,_.a.ConflictUuid)})),this.deletedPayloads=this.allProcessedPayloads.filter((function(e){return e.discardable})),Object(u.g)(this)}var t,n,r;return t=e,(n=[{key:"filterRawItemArray",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter((function(e){return!!e.uuid}))}},{key:"error",get:function(){return this.rawResponse.error}},{key:"status",get:function(){return this.rawResponse.status}},{key:"lastSyncToken",get:function(){return this.rawResponse[Jn.LastSyncToken]}},{key:"paginationToken",get:function(){return this.rawResponse[Jn.PaginationToken]}},{key:"integrityHash",get:function(){return this.rawResponse[Jn.IntegrityResult]}},{key:"checkIntegrity",get:function(){return this.integrityHash&&!this.paginationToken}},{key:"numberOfItemsInvolved",get:function(){return this.allProcessedPayloads.length}},{key:"allProcessedPayloads",get:function(){return this.savedPayloads.concat(this.retrievedPayloads).concat(this.dataConflictPayloads).concat(this.uuidConflictPayloads)}},{key:"rawUuidConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return e.type===eu.UuidConflict})).map((function(e){return e.unsaved_item||e.item}))}},{key:"rawDataConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return e.type===eu.ConflictingData})).map((function(e){return e.server_item||e.item}))}},{key:"rawConflictObjects",get:function(){var e=this.rawResponse.conflicts||[],t=this.rawResponse.unsaved||[];return e.concat(t)}},{key:"hasError",get:function(){return!Object(u.p)(this.rawResponse.error)}}])&&nu(t.prototype,n),r&&nu(t,r),e}();function ou(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function su(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function cu(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.Response=1]="Response",e[e.StatusChanged=2]="StatusChanged"}(au||(au={}));var uu=function(){function e(t,n,r,a,i,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),cu(this,"payloads",void 0),cu(this,"receiver",void 0),cu(this,"lastSyncToken",void 0),cu(this,"paginationToken",void 0),cu(this,"checkIntegrity",void 0),cu(this,"apiService",void 0),cu(this,"pendingPayloads",void 0),cu(this,"responses",[]),this.payloads=t,this.lastSyncToken=r,this.paginationToken=a,this.checkIntegrity=i,this.apiService=o,this.receiver=n,this.pendingPayloads=t}var t,n,r,a,i;return t=e,(n=[{key:"popPayloads",value:function(e){var t=this.pendingPayloads.slice(0,e);return Object(u.G)(this.pendingPayloads,t),t}},{key:"run",value:(a=o.a.mark((function e(){var t,n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.popPayloads(this.upLimit),e.next=3,this.apiService.sync(t,this.lastSyncToken,this.paginationToken,this.downLimit,this.checkIntegrity,void 0,void 0);case 3:return n=e.sent,r=new iu(n),this.responses.push(r),this.lastSyncToken=r.lastSyncToken,this.paginationToken=r.paginationToken,e.next=10,this.receiver(au.Response,r);case 10:if(this.done){e.next=12;break}return e.abrupt("return",this.run());case 12:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){ou(i,n,r,o,s,"next",e)}function s(e){ou(i,n,r,o,s,"throw",e)}o(void 0)}))},function(){return i.apply(this,arguments)})},{key:"pendingUploadCount",value:function(){return this.pendingPayloads.length}},{key:"totalUploadCount",value:function(){return this.payloads.length}},{key:"payloadsSavedOrSaving",get:function(){return Object(u.c)(this.payloads,this.pendingPayloads)}},{key:"done",get:function(){return 0===this.pendingPayloads.length&&!this.paginationToken}},{key:"upLimit",get:function(){return 150}},{key:"downLimit",get:function(){return 150}},{key:"numberOfItemsInvolved",get:function(){var e=0,t=!0,n=!1,r=void 0;try{for(var a,i=this.responses[Symbol.iterator]();!(t=(a=i.next()).done);t=!0)e+=a.value.numberOfItemsInvolved}catch(e){n=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(n)throw r}}return e}}])&&su(t.prototype,n),r&&su(t,r),e}();function lu(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function fu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function pu(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var hu=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),pu(this,"payloads",void 0),pu(this,"receiver",void 0),this.payloads=t,this.receiver=n}var t,n,r,a,i;return t=e,(n=[{key:"run",value:(a=o.a.mark((function e(){var t,n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.payloads.map((function(e){return Object(j.f)(e,_.a.LocalSaved,{dirty:!1,lastSyncEnd:new Date})})),n=Object(u.a)(t),r=new iu({saved_items:n}),e.next=5,this.receiver(au.Response,r);case 5:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){lu(i,n,r,o,s,"next",e)}function s(e){lu(i,n,r,o,s,"throw",e)}o(void 0)}))},function(){return i.apply(this,arguments)})}])&&fu(t.prototype,n),r&&fu(t,r),e}();function yu(e){return(yu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function du(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function vu(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function bu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function mu(e,t){return!t||"object"!==yu(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function gu(e){return(gu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function wu(e,t){return(wu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ku=function(e){function t(){return vu(this,t),mu(this,gu(t).apply(this,arguments))}var n,r,a,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&wu(e,t)}(t,e),n=t,(r=[{key:"resultingCollection",value:(i=o.a.mark((function e(){var t,n,r,a,i,s,c,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=!0,r=!1,a=void 0,e.prev=4,i=this.applyCollection.all()[Symbol.iterator]();case 6:if(n=(s=i.next()).done){e.next=22;break}if(c=s.value,t.push(c),l=this.findBasePayload(c.uuid)){e.next=12;break}return e.abrupt("continue",19);case 12:if(!ua(c,l)){e.next=15;break}return e.abrupt("continue",19);case 15:return e.next=17,ra(l,this.baseCollection,!0);case 17:f=e.sent,Object(u.j)(t,f);case 19:n=!0,e.next=6;break;case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(4),r=!0,a=e.t0;case 28:e.prev=28,e.prev=29,n||null==i.return||i.return();case 31:if(e.prev=31,!r){e.next=34;break}throw a;case 34:return e.finish(31);case 35:return e.finish(28);case 36:return e.abrupt("return",$r.WithPayloads(t,_.a.RemoteRetrieved));case 37:case"end":return e.stop()}}),e,this,[[4,24,28,36],[29,,31,35]])})),s=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=i.apply(e,t);function o(e){du(a,n,r,o,s,"next",e)}function s(e){du(a,n,r,o,s,"throw",e)}o(void 0)}))},function(){return s.apply(this,arguments)})}])&&bu(n.prototype,r),a&&bu(n,a),t}(Rr);function xu(e){return(xu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Su(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ou(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Pu(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Ou(i,r,a,o,s,"next",e)}function s(e){Ou(i,r,a,o,s,"throw",e)}o(void 0)}))}}function ju(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Cu(e,t,n){return(Cu="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Du(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Du(e){return(Du=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Iu(e,t){return(Iu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Eu(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Mu,Ru,Tu;!function(e){e[e.ResolveOnNext=1]="ResolveOnNext",e[e.ForceSpawnNew=2]="ForceSpawnNew"}(Mu||(Mu={})),function(e){e[e.Default=1]="Default",e[e.DownloadFirst=2]="DownloadFirst"}(Ru||(Ru={})),function(e){e[e.External=1]="External",e[e.SpawnQueue=2]="SpawnQueue",e[e.ResolveQueue=3]="ResolveQueue",e[e.MoreDirtyItems=4]="MoreDirtyItems",e[e.AfterDownloadFirst=5]="AfterDownloadFirst",e[e.IntegrityCheck=6]="IntegrityCheck",e[e.ResolveOutOfSync=7]="ResolveOutOfSync"}(Tu||(Tu={}));var Au=function(e){function t(e,n,r,a,i,o,s){var c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c=function(e,t){return!t||"object"!==xu(t)&&"function"!=typeof t?_u(e):t}(this,Du(t).call(this)),Eu(_u(c),"sessionManager",void 0),Eu(_u(c),"protocolService",void 0),Eu(_u(c),"storageService",void 0),Eu(_u(c),"modelManager",void 0),Eu(_u(c),"itemManager",void 0),Eu(_u(c),"apiService",void 0),Eu(_u(c),"interval",void 0),Eu(_u(c),"state",void 0),Eu(_u(c),"opStatus",void 0),Eu(_u(c),"resolveQueue",[]),Eu(_u(c),"spawnQueue",[]),Eu(_u(c),"completedOnlineDownloadFirstSync",!1),Eu(_u(c),"majorChangeThreshold",15),Eu(_u(c),"maxDiscordance",5),Eu(_u(c),"locked",!1),Eu(_u(c),"databaseLoaded",!1),Eu(_u(c),"syncToken",void 0),Eu(_u(c),"cursorToken",void 0),Eu(_u(c),"syncLock",void 0),Eu(_u(c),"_simulate_latency",void 0),Eu(_u(c),"localLoadPriorty",[P.a.ItemsKey,P.a.UserPrefs,P.a.Privileges,P.a.Component,P.a.Theme]),Eu(_u(c),"nonEncryptedTypes",[P.a.Mfa,P.a.ServerExtension]),c.itemManager=e,c.sessionManager=n,c.protocolService=r,c.modelManager=i,c.storageService=a,c.apiService=o,c.interval=s,c.initializeStatus(),c.initializeState(),c}var n,r,a,i,c,l,f,p,h,y,d,b,m,g,w,k,x,S,O,C,D,I,E,M,R,T,A,K,F;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Iu(e,t)}(t,e),n=t,(r=[{key:"onNewDatabaseCreated",value:(F=Pu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLastSyncToken();case 2:if(!e.sent){e.next=5;break}return e.next=5,this.clearSyncPositionTokens();case 5:case"end":return e.stop()}}),e,this)}))),function(){return F.apply(this,arguments)})},{key:"deinit",value:function(){this.sessionManager=void 0,this.itemManager=void 0,this.protocolService=void 0,this.modelManager=void 0,this.storageService=void 0,this.apiService=void 0,this.interval=void 0,this.state.reset(),this.opStatus.reset(),this.state=void 0,this.opStatus=void 0,this.resolveQueue.length=0,this.spawnQueue.length=0,Cu(Du(t.prototype),"deinit",this).call(this)}},{key:"initializeStatus",value:function(){var e=this;this.opStatus=new hc(this.interval,(function(t){e.notifyEvent(t)}))}},{key:"initializeState",value:function(){var e=this;this.state=new bc((function(t){t===Fa.a.EnterOutOfSync?e.notifyEvent(Fa.a.EnterOutOfSync):t===Fa.a.ExitOutOfSync&&e.notifyEvent(Fa.a.ExitOutOfSync)}),this.maxDiscordance)}},{key:"lockSyncing",value:function(){this.locked=!0}},{key:"unlockSyncing",value:function(){this.locked=!1}},{key:"isOutOfSync",value:function(){return this.state.isOutOfSync()}},{key:"getLastSyncDate",value:function(){return this.state.lastSyncDate}},{key:"getStatus",value:function(){return this.opStatus}},{key:"resetSyncState",value:function(){this.state.reset()}},{key:"isDatabaseLoaded",value:function(){return this.databaseLoaded}},{key:"getDatabasePayloads",value:(K=Pu(o.a.mark((function e(){var t=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getAllRawPayloads().catch((function(e){throw t.notifyEvent(Fa.a.DatabaseReadError,e),e})));case 1:case"end":return e.stop()}}),e,this)}))),function(){return K.apply(this,arguments)})},{key:"loadDatabasePayloads",value:(A=Pu(o.a.mark((function e(t){var n,r,a,i,s,c,l,f,p,h,y;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.databaseLoaded){e.next=2;break}throw"Attempting to initialize already initialized local database.";case 2:if(0!==t.length){e.next=6;break}return this.databaseLoaded=!0,this.opStatus.setDatabaseLoadStatus(0,0,!0),e.abrupt("return");case 6:return n=t.map((function(e){return Object(j.e)(e)})),r=lc(n,this.localLoadPriorty),a=r.filter((function(e){return e.content_type===P.a.ItemsKey})),Object(u.G)(r,a),e.next=12,this.protocolService.payloadsByDecryptingPayloads(a);case 12:return i=e.sent,e.next=15,this.modelManager.emitPayloads(i,_.a.LocalRetrieved);case 15:s=r.length,c=100,l=Math.ceil(s/c),f=0;case 19:if(!(f<l)){e.next=32;break}return p=f*c,h=r.slice(p,p+c),e.next=24,this.protocolService.payloadsByDecryptingPayloads(h);case 24:return y=e.sent,e.next=27,this.modelManager.emitPayloads(y,_.a.LocalRetrieved);case 27:this.notifyEvent(Fa.a.LocalDataIncrementalLoad),this.opStatus.setDatabaseLoadStatus(p,s,!1);case 29:f++,e.next=19;break;case 32:this.databaseLoaded=!0,this.opStatus.setDatabaseLoadStatus(0,0,!0);case 34:case"end":return e.stop()}}),e,this)}))),function(e){return A.apply(this,arguments)})},{key:"setLastSyncToken",value:(T=Pu(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=t,e.abrupt("return",this.storageService.setValue(Nt.LastSyncToken,t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return T.apply(this,arguments)})},{key:"setPaginationToken",value:(R=Pu(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken=t,!t){e.next=5;break}return e.abrupt("return",this.storageService.setValue(Nt.PaginationToken,t));case 5:return e.abrupt("return",this.storageService.removeValue(Nt.PaginationToken));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return R.apply(this,arguments)})},{key:"getLastSyncToken",value:(M=Pu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.syncToken){e.next=4;break}return e.next=3,this.storageService.getValue(Nt.LastSyncToken);case 3:this.syncToken=e.sent;case 4:return e.abrupt("return",this.syncToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return M.apply(this,arguments)})},{key:"getPaginationToken",value:(E=Pu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken){e.next=4;break}return e.next=3,this.storageService.getValue(Nt.PaginationToken);case 3:this.cursorToken=e.sent;case 4:return e.abrupt("return",this.cursorToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return E.apply(this,arguments)})},{key:"clearSyncPositionTokens",value:(I=Pu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=void 0,this.cursorToken=void 0,e.next=4,this.storageService.removeValue(Nt.LastSyncToken);case 4:return e.next=6,this.storageService.removeValue(Nt.PaginationToken);case 6:case"end":return e.stop()}}),e,this)}))),function(){return I.apply(this,arguments)})},{key:"itemsNeedingSync",value:(D=Pu(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.getDirtyItems(),e.abrupt("return",t);case 2:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"alternateUuidForItem",value:(C=Pu(o.a.mark((function e(t){var n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.itemManager.findItem(t),r=Object(j.e)(n),e.next=4,ia(r,this.modelManager.getMasterCollection());case 4:return a=e.sent,e.next=7,this.modelManager.emitPayloads(a,_.a.LocalChanged);case 7:return e.next=9,this.persistPayloads(a);case 9:return e.abrupt("return",this.itemManager.findItem(a[0].uuid));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"markAllItemsAsNeedingSync",value:(O=Pu(o.a.mark((function e(t){var n,r,a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Marking all items as needing sync"),!t){e.next=29;break}n=this.itemManager.items.filter((function(e){return!e.errorDecrypting})).slice(),r=!0,a=!1,i=void 0,e.prev=6,s=n[Symbol.iterator]();case 8:if(r=(c=s.next()).done){e.next=15;break}return u=c.value,e.next=12,this.alternateUuidForItem(u.uuid);case 12:r=!0,e.next=8;break;case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(6),a=!0,i=e.t0;case 21:e.prev=21,e.prev=22,r||null==s.return||s.return();case 24:if(e.prev=24,!a){e.next=27;break}throw i;case 27:return e.finish(24);case 28:return e.finish(21);case 29:return l=this.itemManager.items,f=l.map((function(e){return Object(j.e)(e,{dirty:!0,dirtiedDate:new Date})})),e.next=33,this.modelManager.emitPayloads(f,_.a.LocalChanged);case 33:return e.next=35,this.persistPayloads(f);case 35:case"end":return e.stop()}}),e,this,[[6,17,21,29],[22,,24,28]])}))),function(e){return O.apply(this,arguments)})},{key:"popPayloadsNeedingPreSyncSave",value:(S=Pu(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.state.lastPreSyncSave){e.next=3;break}return e.abrupt("return",t);case 3:return r=t.filter((function(e){return!e.dirtiedDate||e.dirtiedDate>n})),this.state.lastPreSyncSave=new Date,e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"queueStrategyResolveOnNext",value:function(){var e=this;return new Promise((function(t,n){e.resolveQueue.push({resolve:t,reject:n})}))}},{key:"queueStrategyForceSpawnNew",value:function(e){var t=this;return new Promise((function(n,r){t.spawnQueue.push({resolve:n,reject:r,options:e})}))}},{key:"popSpawnQueue",value:function(){if(0===this.spawnQueue.length)return null;var e=this.spawnQueue[0];return Object(u.C)(this.spawnQueue,0),this.log("Syncing again from spawn queue"),this.sync(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Su(Object(n),!0).forEach((function(t){Eu(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Su(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({queueStrategy:Mu.ForceSpawnNew,source:Tu.SpawnQueue},e.options)).then((function(){e.resolve()})).catch((function(){e.reject()}))}},{key:"payloadsByPreparingForServer",value:(x=Pu(o.a.mark((function e(t){var n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.payloadsByEncryptingPayloads(t,(function(e){return n.nonEncryptedTypes.includes(e.content_type)?Gt.a.SyncDecrypted:Gt.a.Sync})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"sync",value:(k=Pu(o.a.mark((function e(){var t,n,r,a,i,c,l,f,p,h,y,d,b,m,g,w,k,x,S,O,P,j,C,D,I,E=this,M=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=M.length>0&&void 0!==M[0]?M[0]:{},!this.locked){e.next=4;break}return this.log("Sync Locked"),e.abrupt("return");case 4:return n=function(){return E.syncLock},r=function(){E.syncLock=!0},a=function(){E.syncLock=!1},i=this.opStatus.syncInProgress,c=this.databaseLoaded,(l=!n())&&c&&!i&&r(),t.source||(t.source=Tu.External),e.next=14,this.itemsNeedingSync();case 14:return f=e.sent,p=f.filter((function(e){return e.neverSynced&&e.deleted})),Object(u.G)(f,p),h=f.map((function(e){return e.payloadRepresentation()})),e.next=20,this.popPayloadsNeedingPreSyncSave(h);case 20:return y=e.sent,e.next=23,this.persistPayloads(y);case 23:if(d=this.resolveQueue.slice(),b=Object(u.p)(t.queueStrategy)?Mu.ResolveOnNext:t.queueStrategy,!i&&c&&l){e.next=36;break}if(this.log(l?i?"Attempting to sync while existing sync in progress.":"Attempting to sync before local database has loaded.":"Another function call has begun preparing for sync."),b!==Mu.ResolveOnNext){e.next=31;break}return e.abrupt("return",this.queueStrategyResolveOnNext());case 31:if(b!==Mu.ForceSpawnNew){e.next=35;break}return e.abrupt("return",this.queueStrategyForceSpawnNew({mode:t.mode,checkIntegrity:t.checkIntegrity,source:t.source}));case 35:throw"Unhandled timing strategy ".concat(b);case 36:if(this.opStatus.setDidBegin(),this.notifyEvent(Fa.a.SyncWillBegin),Object(u.G)(this.resolveQueue,d),m=new Date,!(f.length>0)){e.next=43;break}return e.next=43,this.itemManager.changeItems(Object(s.b)(f),(function(e){e.lastSyncBegan=m}),v.c.NonDirtying,_.a.PreSyncSave);case 43:if(g=this.sessionManager.online(),o=t.mode,w=g&&!E.completedOnlineDownloadFirstSync?Ru.DownloadFirst:Object(u.p)(o)?Ru.Default:o,k=[],w!==Ru.Default){e.next=58;break}if(!g||this.completedOnlineDownloadFirstSync){e.next=49;break}throw"Attempting to default mode sync without having completed initial.";case 49:if(!g){e.next=55;break}return e.next=52,this.payloadsByPreparingForServer(h);case 52:k=e.sent,e.next=56;break;case 55:k=h;case 56:e.next=59;break;case 58:w===Ru.DownloadFirst&&(k=[]);case 59:if(!g){e.next=65;break}return e.next=62,this.syncOnlineOperation(k,t.checkIntegrity,t.source,w);case 62:x=e.sent,e.next=68;break;case 65:return e.next=67,this.syncOfflineOperation(k,t.source,w);case 67:x=e.sent;case 68:return e.next=70,x.run();case 70:if(this.opStatus.setDidEnd(),a(),!this.opStatus.hasError()){e.next=74;break}return e.abrupt("return");case 74:if(this.opStatus.reset(),this.state.lastSyncDate=new Date,x instanceof uu&&x.numberOfItemsInvolved>=this.majorChangeThreshold&&this.notifyEvent(Fa.a.MajorDataChange),!(p.length>0)){e.next=80;break}return e.next=80,this.handleNeverSyncedDeleted(p);case 80:if(w===Ru.DownloadFirst){e.next=83;break}return e.next=83,this.notifyEvent(Fa.a.FullSyncCompleted,{source:t.source});case 83:if(w!==Ru.DownloadFirst){e.next=91;break}return g&&(this.completedOnlineDownloadFirstSync=!0),e.next=87,this.notifyEvent(Fa.a.DownloadFirstSyncCompleted);case 87:return e.next=89,this.sync({source:Tu.AfterDownloadFirst,checkIntegrity:!0,awaitAll:t.awaitAll});case 89:e.next=117;break;case 91:if(this.popSpawnQueue()||!(this.resolveQueue.length>0)){e.next=99;break}if(this.log("Syncing again from resolve queue"),S=this.sync({source:Tu.ResolveQueue,checkIntegrity:t.checkIntegrity}),!t.awaitAll){e.next=97;break}return e.next=97,S;case 97:e.next=117;break;case 99:return e.next=101,this.itemsNeedingSync();case 101:if(e.t0=e.sent.length,!(e.t0>0)){e.next=107;break}return e.next=105,this.sync({source:Tu.MoreDirtyItems,checkIntegrity:t.checkIntegrity,awaitAll:t.awaitAll});case 105:e.next=117;break;case 107:if(!(x instanceof uu&&x.checkIntegrity)){e.next=116;break}if(!this.state.needsSync||!x.done){e.next=114;break}if(this.log("Syncing again from integrity check"),O=this.sync({checkIntegrity:!0,queueStrategy:Mu.ForceSpawnNew,source:Tu.IntegrityCheck,awaitAll:t.awaitAll}),!t.awaitAll){e.next=114;break}return e.next=114,O;case 114:e.next=117;break;case 116:this.state.clearIntegrityHashes();case 117:for(P=!0,j=!1,C=void 0,e.prev=120,D=d[Symbol.iterator]();!(P=(I=D.next()).done);P=!0)I.value.resolve();e.next=128;break;case 124:e.prev=124,e.t1=e.catch(120),j=!0,C=e.t1;case 128:e.prev=128,e.prev=129,P||null==D.return||D.return();case 131:if(e.prev=131,!j){e.next=134;break}throw C;case 134:return e.finish(131);case 135:return e.finish(128);case 136:case"end":return e.stop()}var o}),e,this,[[120,124,128,136],[129,,131,135]])}))),function(){return k.apply(this,arguments)})},{key:"syncOnlineOperation",value:(w=Pu(o.a.mark((function e(t,n,r,a){var i,s=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Syncing online user","source:",r,"integrity check",n,"mode:",a,"payloads:",t),e.t0=uu,e.t1=t,e.t2=function(){var e=Pu(o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==au.Response){e.next=10;break}if(!n.hasError){e.next=6;break}return e.next=4,s.handleErrorServerResponse(n);case 4:e.next=8;break;case 6:return e.next=8,s.handleSuccessServerResponse(i,n);case 8:e.next=13;break;case 10:if(t!==au.StatusChanged){e.next=13;break}return e.next=13,s.handleStatusChange(i);case 13:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),e.next=6,this.getLastSyncToken();case 6:return e.t3=e.sent,e.next=9,this.getPaginationToken();case 9:return e.t4=e.sent,e.t5=n,e.t6=this.apiService,i=new e.t0(e.t1,e.t2,e.t3,e.t4,e.t5,e.t6),e.abrupt("return",i);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return w.apply(this,arguments)})},{key:"syncOfflineOperation",value:(g=Pu(o.a.mark((function e(t,n,r){var a,i=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Syncing offline user","source:",n,"mode:",r,"payloads:",t),a=new hu(t,function(){var e=Pu(o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==au.Response){e.next=3;break}return e.next=3,i.handleOfflineResponse(n);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()),e.abrupt("return",a);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return g.apply(this,arguments)})},{key:"handleStatusChange",value:(m=Pu(o.a.mark((function e(t){var n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.pendingUploadCount(),r=t.totalUploadCount(),a=r-n,this.opStatus.setUploadStatus(a,r);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"handleOfflineResponse",value:(b=Pu(o.a.mark((function e(t){var n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Offline Sync Response",t.rawResponse),!((n=t.savedPayloads).length>0)){e.next=8;break}return e.next=5,this.modelManager.emitPayloads(n,_.a.LocalSaved);case 5:return r=this.modelManager.find(Object(s.b)(n)),e.next=8,this.persistPayloads(r);case 8:if(!((a=t.deletedPayloads).length>0)){e.next=12;break}return e.next=12,this.deletePayloads(a);case 12:return this.opStatus.clearError(),this.opStatus.setDownloadStatus(t.retrievedPayloads.length),e.next=16,this.notifyEvent(Fa.a.SingleSyncCompleted,t);case 16:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"handleErrorServerResponse",value:(d=Pu(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.log("Sync Error",t),401===t.status&&this.notifyEvent(Fa.a.InvalidSession),this.opStatus.setError(t.error),this.notifyEvent(Fa.a.SyncError,t.error);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"handleSuccessServerResponse",value:(y=Pu(o.a.mark((function e(t,n){var r,a,i,s,c,l,f,p,h,y,d,v,b,m,g,w,k,x,S,O;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._simulate_latency){e.next=3;break}return e.next=3,Object(u.E)(this._simulate_latency.latency);case 3:this.log("Online Sync Response",n.rawResponse),this.setLastSyncToken(n.lastSyncToken),this.setPaginationToken(n.paginationToken),this.opStatus.clearError(),this.opStatus.setDownloadStatus(n.retrievedPayloads.length),r=[],a=!0,i=!1,s=void 0,e.prev=12,c=n.allProcessedPayloads[Symbol.iterator]();case 14:if(a=(l=c.next()).done){e.next=25;break}if(!(f=l.value).deleted&&f.fields.includes(la.a.Content)){e.next=18;break}return e.abrupt("continue",22);case 18:return e.next=20,this.protocolService.payloadByDecryptingPayload(f);case 20:p=e.sent,r.push(p);case 22:a=!0,e.next=14;break;case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(12),i=!0,s=e.t0;case 31:e.prev=31,e.prev=32,a||null==c.return||c.return();case 34:if(e.prev=34,!i){e.next=37;break}throw s;case 37:return e.finish(34);case 38:return e.finish(31);case 39:return h=this.modelManager.getMasterCollection(),y=new tu(n,r,h,t.payloadsSavedOrSaving),e.next=43,y.collectionsByProcessingResponse();case 43:d=e.sent,v=!0,b=!1,m=void 0,e.prev=47,g=d[Symbol.iterator]();case 49:if(v=(w=g.next()).done){e.next=59;break}return k=w.value,e.next=53,this.modelManager.emitCollection(k);case 53:return x=this.modelManager.find(k.uuids()),e.next=56,this.persistPayloads(x);case 56:v=!0,e.next=49;break;case 59:e.next=65;break;case 61:e.prev=61,e.t1=e.catch(47),b=!0,m=e.t1;case 65:e.prev=65,e.prev=66,v||null==g.return||g.return();case 68:if(e.prev=68,!b){e.next=71;break}throw m;case 71:return e.finish(68);case 72:return e.finish(65);case 73:if(!((S=n.deletedPayloads).length>0)){e.next=77;break}return e.next=77,this.deletePayloads(S);case 77:return e.next=79,this.notifyEvent(Fa.a.SingleSyncCompleted,n);case 79:if(!n.checkIntegrity){e.next=85;break}return e.next=82,this.computeDataIntegrityHash();case 82:return O=e.sent,e.next=85,this.state.setIntegrityHashes(O,n.integrityHash);case 85:case"end":return e.stop()}}),e,this,[[12,27,31,39],[32,,34,38],[47,61,65,73],[66,,68,72]])}))),function(e,t){return y.apply(this,arguments)})},{key:"handleNeverSyncedDeleted",value:(h=Pu(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.map((function(e){return e.payloadRepresentation({dirty:!1})})),e.next=3,this.modelManager.emitPayloads(n,_.a.LocalChanged);case 3:return e.next=5,this.persistPayloads(n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"persistPayloads",value:(p=Pu(o.a.mark((function e(t){var n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return");case 2:return e.abrupt("return",this.storageService.savePayloads(t).catch((function(e){throw n.notifyEvent(Fa.a.DatabaseWriteError,e),e})));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"deletePayloads",value:(f=Pu(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.persistPayloads(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"computeDataIntegrityHash",value:(l=Pu(o.a.mark((function e(){var t,n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.itemManager.nonDeletedItems.sort((function(e,t){return t.updated_at.getTime()-e.updated_at.getTime()})),n=t.map((function(e){return e.updatedAtTimestamp()})),r=n.join(","),e.abrupt("return",this.protocolService.crypto.sha256(r));case 7:return e.prev=7,e.t0=e.catch(0),console.error("Error computing data integrity hash",e.t0),e.abrupt("return",void 0);case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(){return l.apply(this,arguments)})},{key:"resolveOutOfSync",value:(c=Pu(o.a.mark((function e(){var t,n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new kc(this.apiService,this.protocolService,void 0,"resolve-out-of-sync"),e.next=3,t.run();case 3:return n=e.sent,r=new ku(this.modelManager.getMasterCollection(),$r.WithPayloads(n,_.a.RemoteRetrieved)),e.next=7,r.resultingCollection();case 7:return a=e.sent,e.next=10,this.modelManager.emitCollection(a);case 10:return e.next=12,this.persistPayloads(a.payloads);case 12:return e.abrupt("return",this.sync({checkIntegrity:!0,source:Tu.ResolveOutOfSync}));case 13:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"statelessDownloadAllItems",value:(i=Pu(o.a.mark((function e(t,n){var r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new kc(this.apiService,this.protocolService,t,n),e.next=3,r.run();case 3:return a=e.sent,e.abrupt("return",a.map((function(e){return Ut(e)})));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"ut_setDatabaseLoaded",value:function(e){this.databaseLoaded=e}},{key:"ut_clearLastSyncDate",value:function(){this.state.lastSyncDate=void 0}},{key:"ut_beginLatencySimulator",value:function(e){this._simulate_latency={latency:e||1e3,enabled:!0}}},{key:"ut_endLatencySimulator",value:function(){this._simulate_latency=null}}])&&ju(n.prototype,r),a&&ju(n,a),t}(Qt.a);function Ku(e){return(Ku="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Fu(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Lu(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Fu(i,r,a,o,s,"next",e)}function s(e){Fu(i,r,a,o,s,"throw",e)}o(void 0)}))}}function Vu(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Nu(e,t,n){return(Nu="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Wu(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Wu(e){return(Wu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Uu(e,t){return(Uu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Bu(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Hu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function zu(e,t,n){return t&&Hu(e.prototype,t),n&&Hu(e,n),e}function qu(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ju=function(){function e(t,n,r,a){Bu(this,e),qu(this,"setClientFunctions",void 0),qu(this,"submitValues",void 0),qu(this,"setValidationStatus",void 0),qu(this,"cancel",void 0),this.setClientFunctions=t,this.submitValues=n,this.setValidationStatus=r,this.cancel=a}return zu(e,[{key:"setCallbacks",value:function(e,t,n,r){this.setClientFunctions(e,t,n,r)}}]),e}(),Gu=function e(t,n,r,a){Bu(this,e),qu(this,"onValidValue",void 0),qu(this,"onInvalidValue",void 0),qu(this,"onComplete",void 0),qu(this,"onCancel",void 0),this.onValidValue=t||function(e){},this.onInvalidValue=n||function(e){},this.onComplete=r||function(){},this.onCancel=a||function(){}},Qu=function(){function e(t,n){Bu(this,e),qu(this,"challenge",void 0),qu(this,"validate",void 0),qu(this,"validValues",[]),qu(this,"invalidValues",[]),qu(this,"artifacts",{}),qu(this,"client",void 0),qu(this,"resolve",void 0),qu(this,"orchestrator",void 0),this.challenge=t,this.validate=n}return zu(e,[{key:"setResolver",value:function(e){this.resolve=e}},{key:"complete",value:function(e){var t;e||(e=new x(this.challenge,this.validValues,this.artifacts)),this.resolve(e),null===(t=this.client)||void 0===t||t.onComplete()}},{key:"cancel",value:function(){var e;this.resolve(null),null===(e=this.client)||void 0===e||e.onCancel()}},{key:"isFinished",value:function(){return this.validValues.length===this.challenge.types.length}},{key:"setOrchestratorFunctions",value:function(e,t,n,r){this.orchestrator=new Ju(e,n,t,r)}},{key:"setValueStatus",value:function(e,t,n){var r,a,i=t?this.validValues:this.invalidValues,o=i.find((function(t){return t.type===e.type}));(o&&Object(u.B)(i,o),i.push(e),t?this.validValues=i:this.invalidValues=i,Object.assign(this.artifacts,n),this.isFinished())?this.complete():t?null===(r=this.client)||void 0===r||r.onValidValue(e):null===(a=this.client)||void 0===a||a.onInvalidValue(e)}}]),e}(),$u=function(e){function t(e,n){var r;return Bu(this,t),r=function(e,t){return!t||"object"!==Ku(t)&&"function"!=typeof t?Vu(e):t}(this,Wu(t).call(this)),qu(Vu(r),"storageService",void 0),qu(Vu(r),"protocolService",void 0),qu(Vu(r),"challengeOperations",{}),qu(Vu(r),"challengeHandler",void 0),r.storageService=e,r.protocolService=n,r}var n,r,a,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Uu(e,t)}(t,e),zu(t,[{key:"deinit",value:function(){this.storageService=void 0,this.protocolService=void 0,this.challengeHandler=void 0,Nu(Wu(t.prototype),"deinit",this).call(this)}},{key:"promptForChallengeResponse",value:(s=Lu(o.a.mark((function e(t){var n,r,a,i,s=this,c=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=!(c.length>1&&void 0!==c[1])||c[1],r=c.length>2?c[2]:void 0,a=this.getChallengeOperation(t),i=!a,a||(a=this.createChallengeOperation(t,n)),r&&(r.orchestrator=a.orchestrator),e.abrupt("return",new Promise((function(e){a.setResolver(e),i&&s.challengeHandler(t,a.orchestrator)})));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"validateChallengeValue",value:(i=Lu(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.type!==y.LocalPasscode){e.next=4;break}return e.abrupt("return",this.protocolService.validatePasscode(t.value));case 4:if(t.type!==y.AccountPassword){e.next=8;break}return e.abrupt("return",this.protocolService.validateAccountPassword(t.value));case 8:if(t.type!==y.Biometric){e.next=10;break}return e.abrupt("return",{valid:!0===t.value});case 10:throw"Cannot validate challenge type ".concat(t.type);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"getLaunchChallenge",value:(a=Lu(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],this.protocolService.hasPasscode()&&t.push(y.LocalPasscode),e.next=5,this.storageService.getValue(Nt.BiometricPrefs,qt.Nonwrapped);case 5:if((n=e.sent)&&n.enabled&&t.push(y.Biometric),!(t.length>0)){e.next=12;break}return e.abrupt("return",new w(t,d.ApplicationUnlock));case 12:return e.abrupt("return",null);case 13:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"isPasscodeLocked",value:function(){return this.protocolService.rootKeyNeedsUnwrapping()}},{key:"enableBiometrics",value:(r=Lu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setValue(Nt.BiometricPrefs,{enabled:!0},qt.Nonwrapped);case 2:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"createChallengeOperation",value:function(e,t){var n=this,r=new Qu(e,t);return r.setOrchestratorFunctions((function(e,t,n,a){var i=new Gu(e,t,n,a);r.client=i}),(function(t,r,a){n.setValidationStatusForChallenge(e,t,r,a)}),(function(t){n.submitValuesForChallenge(e,t)}),(function(){n.cancelChallenge(e)})),this.setChallengeOperation(r),r}},{key:"getChallengeOperation",value:function(e){return this.challengeOperations[e.id]}},{key:"setChallengeOperation",value:function(e){this.challengeOperations[e.challenge.id]=e}},{key:"deleteChallengeOperation",value:function(e){delete this.challengeOperations[e.challenge.id]}},{key:"cancelChallenge",value:function(e){var t=this.challengeOperations[e.id];t.cancel(),this.deleteChallengeOperation(t)}},{key:"submitValuesForChallenge",value:(n=Lu(o.a.mark((function e(t,n){var r,a,i,s,c,u,l,f,p,h,y;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}throw Error("Attempting to submit 0 values for challenge");case 2:if(!(r=this.getChallengeOperation(t)).validate){e.next=36;break}a=!0,i=!1,s=void 0,e.prev=7,c=n[Symbol.iterator]();case 9:if(a=(u=c.next()).done){e.next=20;break}return l=u.value,e.next=13,this.validateChallengeValue(l);case 13:f=e.sent,p=f.valid,h=f.artifacts,this.setValidationStatusForChallenge(t,l,p,h);case 17:a=!0,e.next=9;break;case 20:e.next=26;break;case 22:e.prev=22,e.t0=e.catch(7),i=!0,s=e.t0;case 26:e.prev=26,e.prev=27,a||null==c.return||c.return();case 29:if(e.prev=29,!i){e.next=32;break}throw s;case 32:return e.finish(29);case 33:return e.finish(26);case 34:e.next=38;break;case 36:y=new x(t,n),r.complete(y);case 38:case"end":return e.stop()}}),e,this,[[7,22,26,34],[27,,29,33]])}))),function(e,t){return n.apply(this,arguments)})},{key:"setValidationStatusForChallenge",value:function(e,t,n,r){var a=this.getChallengeOperation(e);a.setValueStatus(t,n,r),a.isFinished()&&this.deleteChallengeOperation(a)}}]),t}(Qt.a);function Yu(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Xu(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Yu(Object(n),!0).forEach((function(t){nl(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Yu(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Zu(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function el(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){Zu(i,r,a,o,s,"next",e)}function s(e){Zu(i,r,a,o,s,"throw",e)}o(void 0)}))}}function tl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function nl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var rl=function(){function e(t,n,r,a,i,o,s){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),nl(this,"environment",void 0),nl(this,"platform",void 0),nl(this,"namespace",void 0),nl(this,"swapClasses",void 0),nl(this,"skipClasses",void 0),nl(this,"crypto",void 0),nl(this,"deviceInterface",void 0),nl(this,"migrationService",void 0),nl(this,"alertService",void 0),nl(this,"httpService",void 0),nl(this,"modelManager",void 0),nl(this,"protocolService",void 0),nl(this,"storageService",void 0),nl(this,"apiService",void 0),nl(this,"sessionManager",void 0),nl(this,"syncService",void 0),nl(this,"challengeService",void 0),nl(this,"singletonManager",void 0),nl(this,"componentManager",void 0),nl(this,"privilegesService",void 0),nl(this,"actionsManager",void 0),nl(this,"historyManager",void 0),nl(this,"itemManager",void 0),nl(this,"eventHandlers",[]),nl(this,"services",[]),nl(this,"streamRemovers",[]),nl(this,"serviceObservers",[]),nl(this,"managedSubscribers",[]),nl(this,"autoSyncInterval",void 0),nl(this,"createdNewDatabase",!1),nl(this,"started",!1),nl(this,"launched",!1),nl(this,"dealloced",!1),!r)throw"Device Interface must be supplied.";if(!t)throw"Environment must be supplied when creating an application.";if(!n)throw"Platform must be supplied when creating an application.";if(!a)throw"Crypto has to be supplied when creating an application.";this.environment=t,this.platform=n,this.namespace=i||"",this.deviceInterface=r,this.crypto=a,this.swapClasses=o,this.skipClasses=s,this.constructServices()}var t,n,r,i,l,f,p,b,m,g,k,x,S,O,C,D,I,E,M,R,T,A,K,F,L,V,N,W,U,B,H,z,q,J,G,Q,$,Y,X,Z,ee,te,ne,re,ae,ie,oe,se,ce,ue,le,fe,pe,he,ye;return t=e,(n=[{key:"prepareForLaunch",value:(ye=el(o.a.mark((function e(t){var n,r=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setLaunchCallback(t),e.next=3,this.deviceInterface.openDatabase().catch((function(e){r.notifyEvent(c.a.LocalDatabaseReadError,e)}));case 3:return n=e.sent,this.createdNewDatabase=(null==n?void 0:n.isNewDatabase)||!1,e.next=7,this.migrationService.initialize();case 7:return e.next=9,this.handleStage(a.PreparingForLaunch_0);case 9:return e.next=11,this.storageService.initializeFromDisk();case 11:return e.next=13,this.protocolService.initialize();case 13:return e.next=15,this.handleStage(a.ReadyForLaunch_05);case 15:return this.started=!0,e.next=18,this.notifyEvent(c.a.Started);case 18:case"end":return e.stop()}}),e,this)}))),function(e){return ye.apply(this,arguments)})},{key:"setLaunchCallback",value:function(e){this.challengeService.challengeHandler=e.receiveChallenge}},{key:"launch",value:(he=el(o.a.mark((function e(){var t,n,r,i,s,u=this,l=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=l.length>0&&void 0!==l[0]&&l[0],this.launched=!1,e.next=4,this.challengeService.getLaunchChallenge();case 4:if(!(n=e.sent)){e.next=11;break}return e.next=8,this.challengeService.promptForChallengeResponse(n);case 8:return r=e.sent,e.next=11,this.handleLaunchChallengeResponse(r);case 11:if(!this.storageService.isStorageWrapped()){e.next=14;break}return e.next=14,this.storageService.decryptStorage();case 14:return e.next=16,this.handleStage(a.StorageDecrypted_09);case 16:return e.next=18,this.apiService.loadHost();case 18:return e.next=20,this.sessionManager.initializeFromDisk();case 20:return this.historyManager.initializeFromDisk(),this.launched=!0,e.next=24,this.notifyEvent(c.a.Launched);case 24:return e.next=26,this.handleStage(a.Launched_10);case 26:return e.next=28,this.syncService.getDatabasePayloads();case 28:return i=e.sent,e.next=31,this.handleStage(a.LoadingDatabase_11);case 31:if(!this.createdNewDatabase){e.next=34;break}return e.next=34,this.syncService.onNewDatabaseCreated();case 34:if(s=this.syncService.loadDatabasePayloads(i).then(el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!u.dealloced){e.next=2;break}throw"Application has been destroyed.";case 2:return e.next=4,u.handleStage(a.LoadedDatabase_12);case 4:return u.beginAutoSyncTimer(),e.abrupt("return",u.syncService.sync({mode:Ru.DownloadFirst}));case 6:case"end":return e.stop()}}),e)})))),!t){e.next=38;break}return e.next=38,s;case 38:case"end":return e.stop()}}),e,this)}))),function(){return he.apply(this,arguments)})},{key:"handleLaunchChallengeResponse",value:(pe=el(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.challenge.types.includes(y.LocalPasscode)){e.next=9;break}if(n=t.artifacts.wrappingKey){e.next=7;break}return r=t.getValueForType(y.LocalPasscode),e.next=6,this.protocolService.computeWrappingKey(r.value);case 6:n=e.sent;case 7:return e.next=9,this.protocolService.unwrapRootKey(n);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return pe.apply(this,arguments)})},{key:"beginAutoSyncTimer",value:function(){var e=this;this.autoSyncInterval=this.deviceInterface.interval((function(){e.syncService.log("Syncing from autosync"),e.sync()}),3e4)}},{key:"getMigrationChallengeResponder",value:function(){var e=this;return(function(){var t=el(o.a.mark((function t(n,r,a){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.challengeService.promptForChallengeResponse(n,r,a));case 1:case"end":return t.stop()}}),t)})));return function(e,n,r){return t.apply(this,arguments)}}())}},{key:"handleStage",value:(fe=el(o.a.mark((function e(t){var n,r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,r=!1,a=void 0,e.prev=3,i=this.services[Symbol.iterator]();case 5:if(n=(s=i.next()).done){e.next=12;break}return c=s.value,e.next=9,c.handleApplicationStage(t);case 9:n=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,a=e.t0;case 18:e.prev=18,e.prev=19,n||null==i.return||i.return();case 21:if(e.prev=21,!r){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return fe.apply(this,arguments)})},{key:"addEventObserver",value:function(e,t){var n=this,r={callback:e,singleEvent:t};return this.eventHandlers.push(r),function(){Object(u.B)(n.eventHandlers,r)}}},{key:"addSingleEventObserver",value:function(e,t){var n=function(){var n=el(o.a.mark((function n(r){return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r===e&&t(e);case 1:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}();return this.addEventObserver(n,e)}},{key:"notifyEvent",value:(le=el(o.a.mark((function e(t,n){var r,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,a=!1,i=void 0,e.prev=3,s=this.eventHandlers.slice()[Symbol.iterator]();case 5:if(r=(c=s.next()).done){e.next=18;break}if(!(u=c.value).singleEvent||u.singleEvent!==t){e.next=12;break}return e.next=10,u.callback(t,n||{});case 10:e.next=15;break;case 12:if(u.singleEvent){e.next=15;break}return e.next=15,u.callback(t,n||{});case 15:r=!0,e.next=5;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(3),a=!0,i=e.t0;case 24:e.prev=24,e.prev=25,r||null==s.return||s.return();case 27:if(e.prev=27,!a){e.next=30;break}throw i;case 30:return e.finish(27);case 31:return e.finish(24);case 32:this.migrationService.handleApplicationEvent(t);case 33:case"end":return e.stop()}}),e,this,[[3,20,24,32],[25,,27,31]])}))),function(e,t){return le.apply(this,arguments)})},{key:"isDatabaseLoaded",value:function(){return this.syncService.isDatabaseLoaded()}},{key:"savePayload",value:(ue=el(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(j.b)(t,{dirty:!0,dirtiedDate:new Date}),e.next=3,this.modelManager.emitPayload(n,_.a.LocalChanged);case 3:return e.next=5,this.syncService.sync();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return ue.apply(this,arguments)})},{key:"findItem",value:function(e){return this.itemManager.findItem(e)}},{key:"allItems",value:function(){return this.itemManager.items}},{key:"findItems",value:function(e){return this.itemManager.itemsMatchingPredicate(e)}},{key:"getAll",value:function(e){return this.itemManager.findItems(e)}},{key:"mergeItem",value:(ce=el(o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.emitItemFromPayload(t.payloadRepresentation(),n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return ce.apply(this,arguments)})},{key:"createManagedItem",value:(se=el(o.a.mark((function e(t,n){var r,a,i,s=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]&&s[2],a=s.length>3?s[3]:void 0,e.next=4,this.itemManager.createItem(t,n,r,a);case 4:return i=e.sent,e.abrupt("return",i);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return se.apply(this,arguments)})},{key:"createTemplateItem",value:(oe=el(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.createTemplateItem(t,n);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return oe.apply(this,arguments)})},{key:"createItemFromPayload",value:function(e){return Ut(e)}},{key:"createPayloadFromObject",value:function(e){return Object(j.e)(e)}},{key:"getLastSyncDate",value:function(){return this.syncService.getLastSyncDate()}},{key:"getSyncStatus",value:function(){return this.syncService.getStatus()}},{key:"setItemNeedsSync",value:(ie=el(o.a.mark((function e(t){var n,r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],e.abrupt("return",this.itemManager.setItemDirty(t.uuid,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return ie.apply(this,arguments)})},{key:"setItemsNeedsSync",value:(ae=el(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.setItemsDirty(Object(s.b)(t)));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return ae.apply(this,arguments)})},{key:"deleteItem",value:(re=el(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.setItemToBeDeleted(t.uuid);case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return re.apply(this,arguments)})},{key:"deleteItemLocally",value:(ne=el(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.itemManager.removeItemLocally(t);case 1:case"end":return e.stop()}}),e,this)}))),function(e){return ne.apply(this,arguments)})},{key:"emptyTrash",value:(te=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.emptyTrash();case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),e,this)}))),function(){return te.apply(this,arguments)})},{key:"getTrashedItems",value:function(){return this.itemManager.trashedItems}},{key:"setDisplayOptions",value:function(e,t,n,r){this.itemManager.setDisplayOptions(e,t,n,r)}},{key:"getDisplayableItems",value:function(e){return this.itemManager.getDisplayableItems(e)}},{key:"insertItem",value:(ee=el(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.insertItem(t);case 2:return n=e.sent,e.next=5,this.itemManager.changeItems([n.uuid]);case 5:return e.abrupt("return",this.findItem(t.uuid));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return ee.apply(this,arguments)})},{key:"saveItem",value:(Z=el(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.itemManager.findItem(t)){e.next=3;break}throw Error("Attempting to save non-inserted item");case 3:if(n.dirty){e.next=6;break}return e.next=6,this.itemManager.changeItem(t);case 6:return e.next=8,this.syncService.sync();case 8:case"end":return e.stop()}}),e,this)}))),function(e){return Z.apply(this,arguments)})},{key:"changeAndSaveItem",value:(X=el(o.a.mark((function e(t,n){var r,a,i,s=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.length>2&&void 0!==s[2]&&s[2],a=s.length>3?s[3]:void 0,i=s.length>4?s[4]:void 0,Object(u.s)(t)){e.next=5;break}throw Error("Must use uuid to change item");case 5:return e.next=7,this.itemManager.changeItems([t],n,r?v.c.UserInteraction:void 0,a);case 7:return e.next=9,this.syncService.sync(i);case 9:return e.abrupt("return",this.findItem(t));case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return X.apply(this,arguments)})},{key:"changeAndSaveItems",value:(Y=el(o.a.mark((function e(t,n){var r,a,i,s=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]&&s[2],a=s.length>3?s[3]:void 0,i=s.length>4?s[4]:void 0,e.next=5,this.itemManager.changeItems(t,n,r?v.c.UserInteraction:void 0,a);case 5:return e.next=7,this.syncService.sync(i);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return Y.apply(this,arguments)})},{key:"changeItem",value:($=el(o.a.mark((function e(t,n){var r,a=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>2&&void 0!==a[2]&&a[2],Object(u.s)(t)){e.next=3;break}throw Error("Must use uuid to change item");case 3:return e.next=5,this.itemManager.changeItems([t],n,r?v.c.UserInteraction:void 0);case 5:return e.abrupt("return",this.findItem(t));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return $.apply(this,arguments)})},{key:"changeItems",value:(Q=el(o.a.mark((function e(t,n){var r,a=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]&&a[2],e.abrupt("return",this.itemManager.changeItems(t,n,r?v.c.UserInteraction:void 0));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return Q.apply(this,arguments)})},{key:"getItems",value:function(e){return this.itemManager.getItems(e)}},{key:"notesMatchingSmartTag",value:function(e){return this.itemManager.notesMatchingSmartTag(e)}},{key:"referencesForItem",value:function(e,t){var n=this.itemManager.referencesForItem(e.uuid);return t&&(n=n.filter((function(e){return(null==e?void 0:e.content_type)===t}))),n}},{key:"referencingForItem",value:function(e,t){var n=this.itemManager.itemsReferencingItem(e.uuid);return t&&(n=n.filter((function(e){return(null==e?void 0:e.content_type)===t}))),n}},{key:"findTagByTitle",value:function(e){return this.itemManager.findTagByTitle(e)}},{key:"findOrCreateTag",value:(G=el(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.findOrCreateTagByTitle(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return G.apply(this,arguments)})},{key:"getSmartTags",value:function(){return this.itemManager.getSmartTags()}},{key:"getNoteCount",value:function(){return this.itemManager.noteCount}},{key:"streamItems",value:function(e,t){var n=this,r=this.itemManager.addObserver(e,(function(e,n,r,a){var i=e.concat(n).concat(r);t(i,a)})),a=this.itemManager.getItems(e);return a.length>0&&t(a),this.streamRemovers.push(r),function(){r(),Object(u.B)(n.streamRemovers,r)}}},{key:"setHost",value:(J=el(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.setHost(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return J.apply(this,arguments)})},{key:"getHost",value:(q=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.getHost());case 1:case"end":return e.stop()}}),e,this)}))),function(){return q.apply(this,arguments)})},{key:"getUser",value:function(){if(!this.launched)throw"Attempting to access user before application unlocked";return this.sessionManager.getUser()}},{key:"getUserVersion",value:(z=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.getUserVersion());case 1:case"end":return e.stop()}}),e,this)}))),function(){return z.apply(this,arguments)})},{key:"protocolUpgradeAvailable",value:(H=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.upgradeAvailable());case 1:case"end":return e.stop()}}),e,this)}))),function(){return H.apply(this,arguments)})},{key:"isEncryptionAvailable",value:(B=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!Object(u.p)(this.getUser())||this.hasPasscode());case 1:case"end":return e.stop()}}),e,this)}))),function(){return B.apply(this,arguments)})},{key:"upgradeProtocolVersion",value:(U=el(o.a.mark((function e(){var t,n,r,a,i,s,c,u,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.hasPasscode(),n=!this.noAccount(),r=[],t&&r.push(y.LocalPasscode),n&&r.push(y.AccountPassword),a=new w(r,d.ProtocolUpgrade),e.next=8,this.challengeService.promptForChallengeResponse(a);case 8:if(i=e.sent){e.next=11;break}return e.abrupt("return");case 11:if(s=[],!t){e.next=17;break}return u=i.getValueForType(y.LocalPasscode),c=u.value,e.next=17,this.changePasscode(c);case 17:if(!n){e.next=24;break}return l=i.getValueForType(y.AccountPassword),f=l.value,e.next=22,this.changePassword(f,f,c);case 22:(null==(p=e.sent)?void 0:p.error)&&s.push(p.error);case 24:return e.abrupt("return",s);case 25:case"end":return e.stop()}}),e,this)}))),function(){return U.apply(this,arguments)})},{key:"noAccount",value:function(){var e=this.getUser();return Object(u.p)(e)}},{key:"importData",value:(W=el(o.a.mark((function e(t,n){var r,a,i,s,c,u,l=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=l.length>2&&void 0!==l[2]&&l[2],e.next=3,this.protocolService.payloadsByDecryptingBackupFile(t,n);case 3:return a=e.sent,i=a.filter((function(e){return!e.errorDecrypting})).map((function(e){return e.content_type===P.a.Component&&e.safeContent.active?Object(j.b)(e,{content:Xu({},e.safeContent,{active:!1})}):e})),e.next=7,this.modelManager.importPayloads(i);case 7:if(s=e.sent,c=this.sync(),!r){e.next=12;break}return e.next=12,c;case 12:return u=this.getAll(s),e.abrupt("return",{affectedItems:u,errorCount:a.length-i.length});case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return W.apply(this,arguments)})},{key:"createBackupFile",value:(N=el(o.a.mark((function e(t,n){var r,a=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]&&a[2],e.abrupt("return",this.protocolService.createBackupFile(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return N.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.storageService.isEphemeralSession()}},{key:"lockSyncing",value:function(){this.syncService.lockSyncing()}},{key:"unlockSyncing",value:function(){this.syncService.unlockSyncing()}},{key:"sync",value:(V=el(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.sync(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return V.apply(this,arguments)})},{key:"isOutOfSync",value:(L=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.isOutOfSync());case 1:case"end":return e.stop()}}),e,this)}))),function(){return L.apply(this,arguments)})},{key:"resolveOutOfSync",value:(F=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.resolveOutOfSync());case 1:case"end":return e.stop()}}),e,this)}))),function(){return F.apply(this,arguments)})},{key:"setValue",value:(K=el(o.a.mark((function e(t,n,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.setValue(t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return K.apply(this,arguments)})},{key:"getValue",value:(A=el(o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(t,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return A.apply(this,arguments)})},{key:"removeValue",value:(T=el(o.a.mark((function e(t,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.removeValue(t,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return T.apply(this,arguments)})},{key:"clearDatabase",value:(R=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.clearAllPayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return R.apply(this,arguments)})},{key:"rewriteItemsKeys",value:(M=el(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.itemsKeys(),n=t.map((function(e){return e.payloadRepresentation()})),e.next=4,this.storageService.deletePayloads(n);case 4:return e.next=6,this.syncService.persistPayloads(n);case 6:case"end":return e.stop()}}),e,this)}))),function(){return M.apply(this,arguments)})},{key:"prepareForDeinit",value:(E=el(o.a.mark((function e(){var t,n,r=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.length>0&&void 0!==r[0]?r[0]:0,n=Promise.all(this.services.map((function(e){return e.blockDeinit()}))),0!==t){e.next=7;break}return e.next=5,n;case 5:e.next=9;break;case 7:return e.next=9,Promise.race([n,Object(u.E)(t)]);case 9:case"end":return e.stop()}}),e,this)}))),function(){return E.apply(this,arguments)})},{key:"deinit",value:function(){clearInterval(this.autoSyncInterval);var e=!0,t=!1,n=void 0;try{for(var r,a=this.serviceObservers[Symbol.iterator]();!(e=(r=a.next()).done);e=!0)(0,r.value)()}catch(e){t=!0,n=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw n}}var i=!0,o=!1,s=void 0;try{for(var c,u=this.managedSubscribers[Symbol.iterator]();!(i=(c=u.next()).done);i=!0)(0,c.value)()}catch(e){o=!0,s=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw s}}var l=!0,f=!1,p=void 0;try{for(var h,y=this.services[Symbol.iterator]();!(l=(h=y.next()).done);l=!0)h.value.deinit()}catch(e){f=!0,p=e}finally{try{l||null==y.return||y.return()}finally{if(f)throw p}}this.deviceInterface.deinit(),this.deviceInterface=void 0,this.crypto=void 0,this.createdNewDatabase=!1,this.services.length=0,this.serviceObservers.length=0,this.managedSubscribers.length=0,this.streamRemovers.length=0,this.clearServices(),this.dealloced=!0,this.started=!1}},{key:"getWrappingKeyIfNecessary",value:(I=el(o.a.mark((function e(t){var n,r,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasPasscode()){e.next=2;break}return e.abrupt("return",{});case 2:if(t){e.next=11;break}return n=new w([y.LocalPasscode],d.ResaveRootKey),e.next=6,this.challengeService.promptForChallengeResponse(n);case 6:if(r=e.sent){e.next=9;break}return e.abrupt("return",{canceled:!0});case 9:a=r.getValueForType(y.LocalPasscode),t=a.value;case 11:return e.next=13,this.protocolService.computeWrappingKey(t);case 13:return i=e.sent,e.abrupt("return",{wrappingKey:i});case 15:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"register",value:(D=el(o.a.mark((function e(t,n){var r,a,i,s,u,l=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=l.length>2&&void 0!==l[2]&&l[2],a=!(l.length>3&&void 0!==l[3])||l[3],e.next=4,this.getWrappingKeyIfNecessary();case 4:if(i=e.sent,s=i.wrappingKey,!i.canceled){e.next=9;break}return e.abrupt("return");case 9:return this.lockSyncing(),e.next=12,this.sessionManager.register(t,n);case 12:if((u=e.sent).response.error){e.next=35;break}return e.next=16,this.protocolService.setNewRootKey(u.rootKey,u.keyParams,s);case 16:return this.syncService.resetSyncState(),e.next=19,this.storageService.setPersistencePolicy(r?Ht.Ephemeral:Ht.Default);case 19:if(!a){e.next=24;break}return e.next=22,this.syncService.markAllItemsAsNeedingSync(!0);case 22:e.next=27;break;case 24:return this.itemManager.removeAllItemsFromMemory(),e.next=27,this.clearDatabase();case 27:return e.next=29,this.notifyEvent(c.a.SignedIn);case 29:return this.unlockSyncing(),e.next=32,this.syncService.sync({mode:Ru.DownloadFirst,queueStrategy:Mu.ForceSpawnNew});case 32:this.protocolService.decryptErroredItems(),e.next=36;break;case 35:this.unlockSyncing();case 36:return e.abrupt("return",u.response);case 37:case"end":return e.stop()}}),e,this)}))),function(e,t){return D.apply(this,arguments)})},{key:"signIn",value:(C=el(o.a.mark((function e(t,n){var r,a,i,s,u,l,f,p,h,y,d=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=d.length>2&&void 0!==d[2]&&d[2],a=d.length>3&&void 0!==d[3]&&d[3],i=d.length>4?d[4]:void 0,s=d.length>5?d[5]:void 0,u=!(d.length>6&&void 0!==d[6])||d[6],l=d.length>7&&void 0!==d[7]&&d[7],e.next=8,this.getWrappingKeyIfNecessary();case 8:if(f=e.sent,p=f.wrappingKey,!f.canceled){e.next=13;break}return e.abrupt("return");case 13:return this.lockSyncing(),e.next=16,this.sessionManager.signIn(t,n,r,i,s);case 16:if((h=e.sent).response.error){e.next=45;break}return e.next=20,this.protocolService.setNewRootKey(h.rootKey,h.keyParams,p);case 20:return this.syncService.resetSyncState(),e.next=23,this.storageService.setPersistencePolicy(a?Ht.Ephemeral:Ht.Default);case 23:if(!u){e.next=28;break}return e.next=26,this.syncService.markAllItemsAsNeedingSync(!0);case 26:e.next=31;break;case 28:return this.itemManager.removeAllItemsFromMemory(),e.next=31,this.clearDatabase();case 31:return e.next=33,this.notifyEvent(c.a.SignedIn);case 33:if(this.unlockSyncing(),y=this.syncService.sync({mode:Ru.DownloadFirst,checkIntegrity:!0,queueStrategy:Mu.ForceSpawnNew,awaitAll:l}),!l){e.next=42;break}return e.next=38,y;case 38:return e.next=40,this.protocolService.decryptErroredItems();case 40:e.next=43;break;case 42:this.protocolService.decryptErroredItems();case 43:e.next=46;break;case 45:this.unlockSyncing();case 46:return e.abrupt("return",h.response);case 47:case"end":return e.stop()}}),e,this)}))),function(e,t){return C.apply(this,arguments)})},{key:"changePassword",value:(O=el(o.a.mark((function e(t,n,r){var a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappingKeyIfNecessary(r);case 2:if(a=e.sent,i=a.wrappingKey,!a.canceled){e.next=7;break}return e.abrupt("return");case 7:return e.next=9,this.protocolService.getRootKeyParams();case 9:return s=e.sent,this.lockSyncing(),e.next=13,this.sessionManager.changePassword(t,s,n);case 13:if((c=e.sent).response.error){e.next=24;break}return e.next=17,this.protocolService.setNewRootKey(c.rootKey,c.keyParams,i);case 17:return e.next=19,this.protocolService.createNewDefaultItemsKey();case 19:return this.unlockSyncing(),e.next=22,this.syncService.sync();case 22:e.next=25;break;case 24:this.unlockSyncing();case 25:return e.abrupt("return",c.response);case 26:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return O.apply(this,arguments)})},{key:"signOut",value:(S=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionManager.signOut();case 2:return e.next=4,this.protocolService.clearLocalKeyState();case 4:return e.next=6,this.storageService.clearAllData();case 6:return e.next=8,this.notifyEvent(c.a.SignedOut);case 8:return e.next=10,this.prepareForDeinit();case 10:this.deinit();case 11:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"validateAccountPassword",value:(x=el(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.protocolService.validateAccountPassword(t);case 2:return n=e.sent,r=n.valid,e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"isStarted",value:function(){return this.started}},{key:"isLaunched",value:function(){return this.launched}},{key:"hasPasscode",value:function(){return this.protocolService.hasPasscode()}},{key:"isLocked",value:(k=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.started){e.next=2;break}return e.abrupt("return",!0);case 2:return e.abrupt("return",this.challengeService.isPasscodeLocked());case 3:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"lock",value:(g=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,this.prepareForDeinit(500);case 3:return e.abrupt("return",this.deinit());case 4:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"setPasscode",value:(m=el(o.a.mark((function e(t){var n,r,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateUuid();case 2:return n=e.sent,e.next=5,this.protocolService.createRootKey(n,t);case 5:return r=e.sent,a=r.key,i=r.keyParams,e.next=10,this.protocolService.setNewRootKeyWrapper(a,i);case 10:return e.next=12,this.rewriteItemsKeys();case 12:return e.next=14,this.syncService.sync();case 14:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"removePasscode",value:(b=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.protocolService.removeRootKeyWrapper();case 2:return e.next=4,this.rewriteItemsKeys();case 4:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"changePasscode",value:(p=el(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.removePasscode();case 2:return e.abrupt("return",this.setPasscode(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"setStorageEncryptionPolicy",value:(f=el(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setEncryptionPolicy(t);case 2:return e.abrupt("return",this.protocolService.repersistAllItems());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"generateUuid",value:(l=el(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",h.GenerateUuid());case 1:case"end":return e.stop()}}),e)}))),function(){return l.apply(this,arguments)})},{key:"changeDeviceInterface",value:(i=el(o.a.mark((function e(t){var n,r,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(this.deviceInterface=t,n=!0,r=!1,a=void 0,e.prev=4,i=this.services[Symbol.iterator]();!(n=(s=i.next()).done);n=!0)(c=s.value).deviceInterface&&(c.deviceInterface=t);e.next=12;break;case 8:e.prev=8,e.t0=e.catch(4),r=!0,a=e.t0;case 12:e.prev=12,e.prev=13,n||null==i.return||i.return();case 15:if(e.prev=15,!r){e.next=18;break}throw a;case 18:return e.finish(15);case 19:return e.finish(12);case 20:case"end":return e.stop()}}),e,this,[[4,8,12,20],[13,,15,19]])}))),function(e){return i.apply(this,arguments)})},{key:"constructServices",value:function(){this.createModelManager(),this.createItemManager(),this.createStorageManager(),this.createProtocolService();var e={payloadByEncryptingPayload:this.protocolService.payloadByEncryptingPayload.bind(this.protocolService),payloadByDecryptingPayload:this.protocolService.payloadByDecryptingPayload.bind(this.protocolService)};this.storageService.encryptionDelegate=e,this.createMigrationService(),this.createAlertManager(),this.createHttpManager(),this.createApiService(),this.createSessionManager(),this.createSyncManager(),this.createChallengeService(),this.createSingletonManager(),this.createComponentManager(),this.createPrivilegesService(),this.createHistoryManager(),this.createActionsManager()}},{key:"clearServices",value:function(){this.migrationService=void 0,this.alertService=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.sessionManager=void 0,this.syncService=void 0,this.challengeService=void 0,this.singletonManager=void 0,this.componentManager=void 0,this.privilegesService=void 0,this.actionsManager=void 0,this.historyManager=void 0,this.itemManager=void 0,this.services=[]}},{key:"createMigrationService",value:function(){this.migrationService=new Ji({protocolService:this.protocolService,deviceInterface:this.deviceInterface,storageService:this.storageService,itemManager:this.itemManager,environment:this.environment,namespace:this.namespace},this.getMigrationChallengeResponder()),this.services.push(this.migrationService)}},{key:"createAlertManager",value:function(){this.shouldSkipClass(dn)||(this.alertService=new(this.getClass(dn))(this.deviceInterface),this.services.push(this.alertService))}},{key:"createApiService",value:function(){this.apiService=new cr(this.httpService,this.storageService),this.services.push(this.apiService)}},{key:"createItemManager",value:function(){this.itemManager=new uc(this.modelManager),this.services.push(this.itemManager)}},{key:"createComponentManager",value:function(){this.shouldSkipClass(Dr)||(this.componentManager=new Dr(this.itemManager,this.syncService,this.alertService,this.environment,this.platform,this.deviceInterface.timeout),this.services.push(this.componentManager))}},{key:"createHttpManager",value:function(){this.httpService=new Gn,this.services.push(this.httpService)}},{key:"createModelManager",value:function(){this.modelManager=new Ka,this.services.push(this.modelManager)}},{key:"createSingletonManager",value:function(){this.singletonManager=new Ja(this.itemManager,this.syncService),this.services.push(this.singletonManager)}},{key:"createStorageManager",value:function(){this.storageService=new on(this.deviceInterface,this.namespace),this.services.push(this.storageService)}},{key:"createProtocolService",value:function(){var e=this;this.protocolService=new ns(this.itemManager,this.modelManager,this.deviceInterface,this.storageService,this.crypto),this.protocolService.onKeyStatusChange(el(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.notifyEvent(c.a.KeyStatusChanged);case 2:case"end":return t.stop()}}),t)})))),this.services.push(this.protocolService)}},{key:"createSessionManager",value:function(){this.sessionManager=new Ln(this.storageService,this.apiService,this.alertService,this.protocolService),this.services.push(this.sessionManager)}},{key:"createSyncManager",value:function(){var e=this;this.syncService=new Au(this.itemManager,this.sessionManager,this.protocolService,this.storageService,this.modelManager,this.apiService,this.deviceInterface.interval);var t=function(){var t=el(o.a.mark((function t(n){var r;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r=Object(c.c)(n))){t.next=4;break}return t.next=4,e.notifyEvent(r);case 4:return t.next=6,e.protocolService.onSyncEvent(n);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),n=this.syncService.addEventObserver(t);this.serviceObservers.push(n),this.services.push(this.syncService)}},{key:"createChallengeService",value:function(){this.challengeService=new $u(this.storageService,this.protocolService),this.services.push(this.challengeService)}},{key:"createPrivilegesService",value:function(){this.privilegesService=new Hs(this.itemManager,this.syncService,this.singletonManager,this.protocolService,this.storageService,this.sessionManager),this.services.push(this.privilegesService)}},{key:"createHistoryManager",value:function(){this.historyManager=new Es(this.itemManager,this.storageService,[P.a.Note],this.deviceInterface.timeout),this.services.push(this.historyManager)}},{key:"createActionsManager",value:function(){this.actionsManager=new ri(this.itemManager,this.alertService,this.deviceInterface,this.httpService,this.modelManager,this.protocolService,this.syncService),this.services.push(this.actionsManager)}},{key:"shouldSkipClass",value:function(e){return this.skipClasses&&this.skipClasses.includes(e)}},{key:"getClass",value:function(e){var t=this.swapClasses&&this.swapClasses.find((function(t){return t.swap===e}));return t?t.with:e}}])&&tl(t.prototype,n),r&&tl(t,r),e}();function al(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function il(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ol(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var sl=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ol(this,"timeout",void 0),ol(this,"interval",void 0),ol(this,"namespace",void 0),this.namespace=t,this.timeout=n||setTimeout.bind(Object(u.m)()),this.interval=r||setInterval.bind(Object(u.m)())}var t,n,r,a,i;return t=e,(n=[{key:"deinit",value:function(){this.timeout=null,this.interval=null}},{key:"getJsonParsedStorageValue",value:(a=o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRawStorageValue(t);case 2:return n=e.sent,e.abrupt("return",n?JSON.parse(n):n);case 4:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){al(i,n,r,o,s,"next",e)}function s(e){al(i,n,r,o,s,"throw",e)}o(void 0)}))},function(e){return i.apply(this,arguments)})}])&&il(t.prototype,n),r&&il(t,r),e}();function cl(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ul(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ll(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var fl=function(){function e(t,n,r){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ll(this,"item",void 0),ll(this,"removeObserver",void 0),this.item=n.findItem(t),r&&r(this.item),this.removeObserver=n.streamItems(this.item.content_type,function(){var e,n=(e=o.a.mark((function e(n){var i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(i=n.find((function(e){return e.uuid===t})))&&(a.item=i,r&&r(a.item));case 2:case"end":return e.stop()}}),e)})),function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){cl(i,r,a,o,s,"next",e)}function s(e){cl(i,r,a,o,s,"throw",e)}o(void 0)}))});return function(e){return n.apply(this,arguments)}}())}var t,n,r;return t=e,(n=[{key:"deinit",value:function(){this.removeObserver(),this.removeObserver=void 0}}])&&ul(t.prototype,n),r&&ul(t,r),e}(),pl=n(78),hl=n(28)}])}));