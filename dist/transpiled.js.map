{"version":3,"sources":["lib.js"],"names":["SNComponentManager","modelManager","syncManager","desktopManager","nativeExtManager","alertManager","$uiRunner","$timeout","environment","platform","ClientDataDomain","fn","setTimeout","bind","window","streamObservers","contextStreamObservers","activeComponents","isDesktop","isMobile","configureForNonMobileUsage","configureForGeneralUsage","permissionDialogs","handlers","addItemSyncObserver","allItems","validItems","deletedItems","source","sourceKey","syncedComponents","filter","item","content_type","length","SFModelManager","MappingSourceRemoteSaved","syncComponentsInstallation","component","activeComponent","_","find","uuid","active","deleted","activateComponent","deactivateComponent","observer","relevantItems","contentTypes","indexOf","requiredPermissions","name","content_types","sort","runWithPermissions","sendItemsInReply","originalMessage","requiredContextPermissions","handler","areas","includes","area","contextRequestHandler","itemInContext","matchingItem","sendContextItemInReply","detectFocusChange","event","document","activeElement","iframeForComponent","focusChangedForComponent","addEventListener","attachEvent","registerUpdateObserver","isTheme","postActiveThemesToAllComponents","loggingEnabled","console","log","data","sessionKey","handleMessage","componentForSessionKey","components","postActiveThemesToComponent","componentsForArea","theme","themes","getActiveThemes","map","urlForComponent","urls","urlsForActiveThemes","sendMessageToComponent","action","observers","hidden","contextObserver","identifier","handleStreamContextItemMessage","streamObserver","handleStreamItemsMessage","params","created_at","updated_at","content","createContentJSONFromProperties","clientData","getDomainDataItem","getClientDataKey","MappingSourceLocalSaved","isMetadataUpdate","removePrivatePropertiesFromResponseItems","type","items","message","response","mapped","jsonForItem","replyToMessage","replyData","reply","original","permissibleActionsWhileHidden","origin","startsWith","location","href","alert","text","JSON","stringify","postMessage","offlinePrefix","offlineOnly","local_url","replace","getApplicationDataPath","url","hosted_url","legacy_url","localReplacement","key","componentForSessionKeyHandler","readwriteActions","readonly","handleSetComponentDataMessage","handleDeleteItemsMessage","handleCreateItemsMessage","handleSaveItemsMessage","componentToToggle","findItem","handleToggleComponentMessage","handleRequestPermissionsMessage","handleInstallLocalComponentMessage","handleDuplicateItemMessage","actionHandler","responseItems","options","privateTopLevelProperties","responseItem","setDirty","error","privateProperty","isSystemExtension","privateContentProperties","includeUrls","concat","prop","push","contentType","validItemsForContentType","handlersForArea","itemIdsInJurisdiction","itemIdsInContextJurisdictionForComponent","itemIds","candidate","itemIdsInContextJurisdiction","pendingResponseItems","slice","pull","requiredContentTypes","uniq","i","ids","findItems","lockedCount","locked","remove","itemNoun","auxVerb","title","mapResponseItemsToLocalModels","MappingSourceComponentRetrieved","localItems","setDomainDataItem","setItemDirty","sync","then","saveMessage","Object","assign","itemParams","duplicate","duplicateItemAndAdd","uniqueContentTypes","processedItems","createItem","addItem","resolveReferencesForItem","itemsData","noun","confirm","itemData","model","setItemToBeDeleted","notifySyncObserversOfModels","permissions","approved","componentData","sourceComponent","targetComponent","toggleComponent","openModalComponent","activeThemes","isLayerable","installComponent","runFunction","parse","acquiredPermissions","required","respectiveAcquired","acquiredContentType","promptForPermissions","callback","permissionsString","permissionsStringForPermissions","actionBlock","permission","matchingPermission","pendingDialog","containsObjectSubset","target","some","val","presentPermissionsDialog","existingDialog","dialog","splice","componentWindow","SFJS","crypto","generateUUID","activeThemeUrls","notifyComponentActivation","dontSync","didChange","activationHandler","o","Promise","resolve","reject","Array","from","getElementsByTagName","frame","componentId","dataset","focused","focusHandler","setSize","element","size","widthString","width","heightString","height","setAttribute","selector","getElementById","iframe","parent","parentElement","note","editors","editor","isExplicitlyEnabledForItem","mobilePrefersPlainEditor","getDefaultEditor","getAppDataItem","e","isDefaultEditor","finalString","permissionsCount","addSeparator","index","forEach","types","desc","humanReadableDisplayForContentType","typesString","mapping","allItemsMatchingTypes","SNComponent","json_obj","disassociatedItemIds","associatedItemIds","valid_until","Date","autoupdateDisabled","package_info","superParams","setAppDataItem","acceptsThemes","Component","associativeAreas","SFItem","SNEditor","notes","default","systemEditor","references","uuids","ref","newItem","oldUUID","newUUID","value","dataHasChanged","Action","json","merge","running","lastExecuted","SNExtension","actions","context","description","supported_types","a","omit","SNNote","tags","addItemAsRelationship","clearSavedTagsString","tag","savedTagsString","SNTag","arrayToDisplayString","filtered","dummy","setIsNoLongerBeingReferencedBy","tagDidFinishSyncing","b","join","SNEncryptedStorage","storage","SNMfa","SNServerExtension","SNSmartTag","json_ob","SystemSmartTagIdAllNotes","isSystemTag","isAllTag","predicate","SFPredicate","fromArray","SystemSmartTagIdArchivedNotes","isArchiveTag","SystemSmartTagIdTrashedNotes","isTrashTag","SNTheme","layerable","rules","constants","na"],"mappings":"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","file":"transpiled.js","sourcesContent":["export class SNComponentManager {\n\n  /*\n    @param {string} environment: one of [web, desktop, mobile]\n    @param {string} platform: one of [ios, android, linux-${environment}, mac-${environment}, windows-${environment}]\n  */\n  constructor({modelManager, syncManager, desktopManager, nativeExtManager,\n    alertManager, $uiRunner, $timeout, environment, platform}) {\n    /* This domain will be used to save context item client data */\n    SNComponentManager.ClientDataDomain = \"org.standardnotes.sn.components\";\n\n    // Some actions need to be run on the ui thread (desktop/web only)\n    this.$uiRunner = $uiRunner || ((fn) => {fn()});\n    this.$timeout = $timeout || setTimeout.bind(window);\n\n    this.modelManager = modelManager;\n    this.syncManager = syncManager;\n    this.desktopManager = desktopManager;\n    this.nativeExtManager = nativeExtManager;\n    this.alertManager = alertManager;\n\n    this.streamObservers = [];\n    this.contextStreamObservers = [];\n    this.activeComponents = [];\n\n    this.environment = environment;\n    this.platform = platform;\n    this.isDesktop = this.environment == \"desktop\";\n    this.isMobile = this.environment == \"mobile\";\n\n    if(environment != \"mobile\") {\n      this.configureForNonMobileUsage();\n    }\n\n    this.configureForGeneralUsage();\n\n    // this.loggingEnabled = true;\n\n    this.permissionDialogs = [];\n\n    this.handlers = [];\n  }\n\n  configureForGeneralUsage() {\n    this.modelManager.addItemSyncObserver(\"component-manager\", \"*\", (allItems, validItems, deletedItems, source, sourceKey) => {\n      let syncedComponents = allItems.filter((item) => {\n        return item.content_type === \"SN|Component\" || item.content_type == \"SN|Theme\"\n      });\n\n      /* We only want to sync if the item source is Retrieved, not MappingSourceRemoteSaved to avoid\n        recursion caused by the component being modified and saved after it is updated.\n      */\n      if(syncedComponents.length > 0 && source != SFModelManager.MappingSourceRemoteSaved) {\n        // Ensure any component in our data is installed by the system\n        if(this.isDesktop) {\n          this.desktopManager.syncComponentsInstallation(syncedComponents);\n        }\n      }\n\n      for(var component of syncedComponents) {\n        var activeComponent = _.find(this.activeComponents, {uuid: component.uuid});\n        if(component.active && !component.deleted && !activeComponent) {\n          this.activateComponent(component);\n        } else if(!component.active && activeComponent) {\n          this.deactivateComponent(component);\n        }\n      }\n\n      for(let observer of this.streamObservers) {\n        if(sourceKey && sourceKey == observer.component.uuid) {\n          // Don't notify source of change, as it is the originator, doesn't need duplicate event.\n          continue;\n        }\n\n        let relevantItems = allItems.filter((item) => {\n          return observer.contentTypes.indexOf(item.content_type) !== -1;\n        })\n\n        if(relevantItems.length == 0) {\n          continue;\n        }\n\n        let requiredPermissions = [{\n          name: \"stream-items\",\n          content_types: observer.contentTypes.sort()\n        }];\n\n        this.runWithPermissions(observer.component, requiredPermissions, () => {\n          this.sendItemsInReply(observer.component, relevantItems, observer.originalMessage);\n        })\n      }\n\n      let requiredContextPermissions = [{\n        name: \"stream-context-item\"\n      }];\n\n      for(let observer of this.contextStreamObservers) {\n        if(sourceKey && sourceKey == observer.component.uuid) {\n          // Don't notify source of change, as it is the originator, doesn't need duplicate event.\n          continue;\n        }\n\n        for(let handler of this.handlers) {\n          if(!handler.areas.includes(observer.component.area) && !handler.areas.includes(\"*\")) {\n            continue;\n          }\n          if(handler.contextRequestHandler) {\n            var itemInContext = handler.contextRequestHandler(observer.component);\n            if(itemInContext) {\n              var matchingItem = _.find(allItems, {uuid: itemInContext.uuid});\n              if(matchingItem) {\n                this.runWithPermissions(observer.component, requiredContextPermissions, () => {\n                  this.sendContextItemInReply(observer.component, matchingItem, observer.originalMessage, source);\n                })\n              }\n            }\n          }\n        }\n      }\n    });\n  }\n\n  configureForNonMobileUsage() {\n    const detectFocusChange = (event) => {\n      for(var component of this.activeComponents) {\n        if(document.activeElement == this.iframeForComponent(component)) {\n          this.$timeout(() => {\n            this.focusChangedForComponent(component);\n          })\n          break;\n        }\n      }\n    }\n\n    window.addEventListener ? window.addEventListener('focus', detectFocusChange, true) : window.attachEvent('onfocusout', detectFocusChange);\n    window.addEventListener ? window.addEventListener('blur', detectFocusChange, true) : window.attachEvent('onblur', detectFocusChange);\n\n    this.desktopManager.registerUpdateObserver((component) => {\n      // Reload theme if active\n      if(component.active && component.isTheme()) {\n        this.postActiveThemesToAllComponents();\n      }\n    })\n\n    // On mobile, events listeners are handled by a respective component\n    window.addEventListener(\"message\", (event) => {\n      if(this.loggingEnabled) {\n        console.log(\"Web app: received message\", event);\n      }\n\n      // Make sure this message is for us\n      if(event.data.sessionKey) {\n        this.handleMessage(this.componentForSessionKey(event.data.sessionKey), event.data);\n      }\n    }, false);\n  }\n\n  postActiveThemesToAllComponents() {\n    for(let component of this.components) {\n      // Skip over components that are themes themselves,\n      // or components that are not active, or components that don't have a window\n      if(component.isTheme() || !component.active || !component.window) {\n        continue;\n      }\n\n      this.postActiveThemesToComponent(component);\n    }\n  }\n\n  getActiveThemes() {\n    return this.componentsForArea(\"themes\").filter((theme) => {return theme.active});\n  }\n\n  urlsForActiveThemes() {\n    let themes = this.getActiveThemes();\n    return themes.map((theme) => {\n      return this.urlForComponent(theme);\n    })\n  }\n\n  postActiveThemesToComponent(component) {\n    let urls = this.urlsForActiveThemes();\n    let data = { themes: urls }\n\n    this.sendMessageToComponent(component, {action: \"themes\", data: data})\n  }\n\n  contextItemDidChangeInArea(area) {\n    for(let handler of this.handlers) {\n      if(handler.areas.includes(area) === false && !handler.areas.includes(\"*\")) {\n        continue;\n      }\n      var observers = this.contextStreamObservers.filter((observer) => {\n        return observer.component.area === area;\n      })\n\n      for(let observer of observers) {\n        if(handler.contextRequestHandler) {\n          var itemInContext = handler.contextRequestHandler(observer.component);\n          if(itemInContext) {\n            this.sendContextItemInReply(observer.component, itemInContext, observer.originalMessage);\n          }\n        }\n      }\n    }\n  }\n\n  setComponentHidden(component, hidden) {\n    /*\n      A hidden component will not receive messages.\n      However, when a component is unhidden, we need to send it any items it may have\n      registered streaming for.\n    */\n    if(hidden) {\n      component.hidden = true;\n    } else if(component.hidden) {\n      // Only enter this condition if component is hidden to make this note have double side effects.\n      component.hidden = false;\n\n      // streamContextItem\n      let contextObserver = _.find(this.contextStreamObservers, {identifier: component.uuid});\n      if(contextObserver) {\n        this.handleStreamContextItemMessage(component, contextObserver.originalMessage);\n      }\n\n      // streamItems\n      let streamObserver = _.find(this.streamObservers, {identifier: component.uuid});\n      if(streamObserver) {\n        this.handleStreamItemsMessage(component, streamObserver.originalMessage);\n      }\n    }\n  }\n\n  jsonForItem(item, component, source) {\n    var params = {uuid: item.uuid, content_type: item.content_type, created_at: item.created_at, updated_at: item.updated_at, deleted: item.deleted};\n    params.content = item.createContentJSONFromProperties();\n    params.clientData = item.getDomainDataItem(component.getClientDataKey(), SNComponentManager.ClientDataDomain) || {};\n\n    // isMetadataUpdate implies that the extension should make reference of updated metadata,\n    // but not update content values as they may be stale relative to what the extension currently has\n    // Changes are always metadata updates if the mapping source is SFModelManager.MappingSourceRemoteSaved || source == SFModelManager.MappingSourceLocalSaved.\n    //\n    if(source && (source == SFModelManager.MappingSourceRemoteSaved || source == SFModelManager.MappingSourceLocalSaved)) {\n      params.isMetadataUpdate = true;\n    }\n\n    this.removePrivatePropertiesFromResponseItems([params], component, {type: \"outgoing\"});\n    return params;\n  }\n\n  sendItemsInReply(component, items, message, source) {\n    if(this.loggingEnabled) {console.log(\"Web|componentManager|sendItemsInReply\", component, items, message)};\n    let response = {items: {}};\n    let mapped = items.map((item) => {\n      return this.jsonForItem(item, component, source);\n    });\n\n    response.items = mapped;\n    this.replyToMessage(component, message, response);\n  }\n\n  sendContextItemInReply(component, item, originalMessage, source) {\n    if(this.loggingEnabled) {console.log(\"Web|componentManager|sendContextItemInReply\", component, item, originalMessage)};\n    let response = {item: this.jsonForItem(item, component, source)};\n    this.replyToMessage(component, originalMessage, response);\n  }\n\n  replyToMessage(component, originalMessage, replyData) {\n    var reply = {\n      action: \"reply\",\n      original: originalMessage,\n      data: replyData\n    }\n\n    this.sendMessageToComponent(component, reply);\n  }\n\n  sendMessageToComponent(component, message) {\n    let permissibleActionsWhileHidden = [\"component-registered\", \"themes\"];\n    if(component.hidden && !permissibleActionsWhileHidden.includes(message.action)) {\n      if(this.loggingEnabled) {\n        console.log(\"Component disabled for current item, not sending any messages.\", component.name);\n      }\n      return;\n    }\n\n    if(this.loggingEnabled) {\n      console.log(\"Web|sendMessageToComponent\", component, message);\n    }\n\n    var origin = this.urlForComponent(component, \"file://\");\n    if(!origin.startsWith(\"http\") && !origin.startsWith(\"file\")) {\n      // Native extension running in web, prefix current host\n      origin = window.location.href + origin;\n    }\n\n    if(!component.window) {\n      this.alertManager.alert({text: `Standard Notes is trying to communicate with ${component.name}, but an error is occurring. Please restart this extension and try again.`})\n    }\n\n    // Mobile messaging requires json\n    if(this.isMobile) {\n      message = JSON.stringify(message);\n    }\n\n    component.window.postMessage(message, origin);\n  }\n\n  get components() {\n    return this.modelManager.allItemsMatchingTypes([\"SN|Component\", \"SN|Theme\"]);\n  }\n\n  componentsForArea(area) {\n    return this.components.filter((component) => {\n      return component.area === area;\n    })\n  }\n\n  urlForComponent(component, offlinePrefix = \"\") {\n    // offlineOnly is available only on desktop, and not on web or mobile.\n    if(component.offlineOnly && !this.isDesktop) {\n      return null;\n    }\n\n    if(component.offlineOnly || (this.isDesktop && component.local_url)) {\n      return component.local_url && component.local_url.replace(\"sn://\", offlinePrefix + this.desktopManager.getApplicationDataPath() + \"/\");\n    } else {\n      let url = component.hosted_url || component.legacy_url;\n      if(this.isMobile) {\n        let localReplacement = this.platform == \"ios\" ? \"localhost\" : \"10.0.2.2\";\n        url = url.replace(\"localhost\", localReplacement).replace(\"sn.local\", localReplacement);\n      }\n      return url;\n    }\n  }\n\n  componentForUrl(url) {\n    return this.components.filter((component) => {\n      return component.hosted_url === url || component.legacy_url === url;\n    })[0];\n  }\n\n  componentForSessionKey(key) {\n    let component = _.find(this.components, {sessionKey: key});\n    if(!component) {\n      for(let handler of this.handlers) {\n        if(handler.componentForSessionKeyHandler) {\n          component = handler.componentForSessionKeyHandler(key);\n          if(component) {\n            break;\n          }\n        }\n      }\n    }\n    return component;\n  }\n\n  handleMessage(component, message) {\n\n    if(!component) {\n      console.log(\"Component not defined for message, returning\", message);\n      this.alertManager.alert({text: \"An extension is trying to communicate with Standard Notes, but there is an error establishing a bridge. Please restart the app and try again.\"});\n      return;\n    }\n\n    // Actions that won't succeeed with readonly mode\n    let readwriteActions = [\n      \"save-items\",\n      \"associate-item\",\n      \"deassociate-item\",\n      \"create-item\",\n      \"create-items\",\n      \"delete-items\",\n      \"set-component-data\"\n    ];\n\n    if(component.readonly && readwriteActions.includes(message.action)) {\n      // A component can be marked readonly if changes should not be saved.\n      // Particullary used for revision preview windows where the notes should not be savable.\n      this.alertManager.alert({text: `The extension ${component.name} is trying to save, but it is in a locked state and cannot accept changes.`});\n      return;\n    }\n\n    /**\n    Possible Messages:\n      set-size\n      stream-items\n      stream-context-item\n      save-items\n      select-item\n      associate-item\n      deassociate-item\n      clear-selection\n      create-item\n      create-items\n      delete-items\n      set-component-data\n      install-local-component\n      toggle-activate-component\n      request-permissions\n      present-conflict-resolution\n    */\n\n    if(message.action === \"stream-items\") {\n      this.handleStreamItemsMessage(component, message);\n    } else if(message.action === \"stream-context-item\") {\n      this.handleStreamContextItemMessage(component, message);\n    } else if(message.action === \"set-component-data\") {\n      this.handleSetComponentDataMessage(component, message);\n    } else if(message.action === \"delete-items\") {\n      this.handleDeleteItemsMessage(component, message);\n    } else if(message.action === \"create-items\" || message.action === \"create-item\") {\n      this.handleCreateItemsMessage(component, message);\n    } else if(message.action === \"save-items\") {\n      this.handleSaveItemsMessage(component, message);\n    } else if(message.action === \"toggle-activate-component\") {\n      let componentToToggle = this.modelManager.findItem(message.data.uuid);\n      this.handleToggleComponentMessage(component, componentToToggle, message);\n    } else if(message.action === \"request-permissions\") {\n      this.handleRequestPermissionsMessage(component, message);\n    } else if(message.action === \"install-local-component\") {\n      this.handleInstallLocalComponentMessage(component, message);\n    } else if(message.action === \"duplicate-item\") {\n      this.handleDuplicateItemMessage(component, message);\n    }\n\n    // Notify observers\n    for(let handler of this.handlers) {\n      if(handler.actionHandler && (handler.areas.includes(component.area) || handler.areas.includes(\"*\"))) {\n        this.$timeout(() => {\n          handler.actionHandler(component, message.action, message.data);\n        })\n      }\n    }\n  }\n\n  removePrivatePropertiesFromResponseItems(responseItems, component, options = {}) {\n    // can be 'incoming' or 'outgoing'. We want to remove updated_at if incoming, but keep it if outgoing\n    if(options.type == \"incoming\") {\n      let privateTopLevelProperties = [\"updated_at\"];\n      // Maintaining our own updated_at value is imperative for sync to work properly, we ignore any incoming value.\n      for(let responseItem of responseItems) {\n        if(typeof responseItem.setDirty === 'function') {\n          console.error(\"Attempting to pass object. Use JSON.\");\n          continue;\n        }\n        for(let privateProperty of privateTopLevelProperties) {\n          delete responseItem[privateProperty];\n        }\n      }\n    }\n\n    if(component) {\n      // System extensions can bypass this step\n      if(this.nativeExtManager && this.nativeExtManager.isSystemExtension(component)) {\n        return;\n      }\n    }\n    // Don't allow component to overwrite these properties.\n    let privateContentProperties = [\"autoupdateDisabled\", \"permissions\", \"active\"];\n    if(options) {\n      if(options.includeUrls) { privateContentProperties = privateContentProperties.concat([\"url\", \"hosted_url\", \"local_url\"])}\n    }\n    for(let responseItem of responseItems) {\n      // Do not pass in actual items here, otherwise that would be destructive.\n      // Instead, generic JS/JSON objects should be passed.\n      if(typeof responseItem.setDirty === 'function') {\n        console.error(\"Attempting to pass object. Use JSON.\");\n        continue;\n      }\n\n      for(var prop of privateContentProperties) {\n        delete responseItem.content[prop];\n      }\n    }\n  }\n\n  handleStreamItemsMessage(component, message) {\n    let requiredPermissions = [\n      {\n        name: \"stream-items\",\n        content_types: message.data.content_types.sort()\n      }\n    ];\n\n    this.runWithPermissions(component, requiredPermissions, () => {\n      if(!_.find(this.streamObservers, {identifier: component.uuid})) {\n        // for pushing laster as changes come in\n        this.streamObservers.push({\n          identifier: component.uuid,\n          component: component,\n          originalMessage: message,\n          contentTypes: message.data.content_types\n        })\n      }\n\n      // push immediately now\n      var items = [];\n      for(var contentType of message.data.content_types) {\n        items = items.concat(this.modelManager.validItemsForContentType(contentType));\n      }\n      this.sendItemsInReply(component, items, message);\n    });\n  }\n\n  handleStreamContextItemMessage(component, message) {\n\n    var requiredPermissions = [\n      {\n        name: \"stream-context-item\"\n      }\n    ];\n\n    this.runWithPermissions(component, requiredPermissions, () => {\n      if(!_.find(this.contextStreamObservers, {identifier: component.uuid})) {\n        // for pushing laster as changes come in\n        this.contextStreamObservers.push({\n          identifier: component.uuid,\n          component: component,\n          originalMessage: message\n        })\n      }\n\n      // push immediately now\n      for(let handler of this.handlersForArea(component.area)) {\n        if(handler.contextRequestHandler) {\n          var itemInContext = handler.contextRequestHandler(component);\n          if(itemInContext) {\n            this.sendContextItemInReply(component, itemInContext, message);\n          }\n        }\n      }\n    })\n  }\n\n  isItemIdWithinComponentContextJurisdiction(uuid, component) {\n    let itemIdsInJurisdiction = this.itemIdsInContextJurisdictionForComponent(component);\n    return itemIdsInJurisdiction.includes(uuid);\n  }\n\n  /* Returns items that given component has context permissions for */\n  itemIdsInContextJurisdictionForComponent(component) {\n    let itemIds = [];\n    for(let handler of this.handlersForArea(component.area)) {\n      if(handler.contextRequestHandler) {\n        var itemInContext = handler.contextRequestHandler(component);\n        if(itemInContext) {\n          itemIds.push(itemInContext.uuid);\n        }\n      }\n    }\n\n    return itemIds;\n  }\n\n  handlersForArea(area) {\n    return this.handlers.filter((candidate) => {return candidate.areas.includes(area)});\n  }\n\n  async handleSaveItemsMessage(component, message) {\n    let responseItems = message.data.items;\n    let requiredPermissions = [];\n\n    let itemIdsInContextJurisdiction = this.itemIdsInContextJurisdictionForComponent(component);\n\n    // Pending as in needed to be accounted for in permissions.\n    let pendingResponseItems = responseItems.slice();\n\n    for(let responseItem of responseItems.slice()) {\n      if(itemIdsInContextJurisdiction.includes(responseItem.uuid)) {\n        requiredPermissions.push({\n          name: \"stream-context-item\"\n        });\n        _.pull(pendingResponseItems, responseItem);\n        // We break because there can only be one context item\n        break;\n      }\n    }\n\n    // Check to see if additional privileges are required\n    if(pendingResponseItems.length > 0) {\n      let requiredContentTypes = _.uniq(pendingResponseItems.map((i) => {return i.content_type})).sort();\n      requiredPermissions.push({\n        name: \"stream-items\",\n        content_types: requiredContentTypes\n      });\n    }\n\n    this.runWithPermissions(component, requiredPermissions, async () => {\n\n      this.removePrivatePropertiesFromResponseItems(responseItems, component, {includeUrls: true, type: \"incoming\"});\n\n      /*\n      We map the items here because modelManager is what updates the UI. If you were to instead get the items directly,\n      this would update them server side via sync, but would never make its way back to the UI.\n      */\n\n      // Filter locked items\n      let ids = responseItems.map((i) => {return i.uuid});\n      let items = this.modelManager.findItems(ids);\n      let lockedCount = 0;\n      for(let item of items) {\n        if(item.locked) {\n          _.remove(responseItems, {uuid: item.uuid});\n          lockedCount++;\n        }\n      }\n\n      if(lockedCount > 0) {\n        let itemNoun = lockedCount == 1 ? \"item\" : \"items\";\n        let auxVerb = lockedCount == 1 ? \"is\" : \"are\";\n        this.alertManager.alert({title: 'Items Locked', text: `${lockedCount} ${itemNoun} you are attempting to save ${auxVerb} locked and cannot be edited.`});\n      }\n\n      let localItems = await this.modelManager.mapResponseItemsToLocalModels(responseItems, SFModelManager.MappingSourceComponentRetrieved, component.uuid);\n\n      for(let responseItem of responseItems) {\n        let item = _.find(localItems, {uuid: responseItem.uuid});\n        if(!item) {\n          // An item this extension is trying to save was possibly removed locally, notify user\n          this.alertManager.alert({text: `The extension ${component.name} is trying to save an item with type ${responseItem.content_type}, but that item does not exist. Please restart this extension and try again.`});\n          continue;\n        }\n\n        if(!item.locked) {\n          if(responseItem.clientData) {\n            item.setDomainDataItem(component.getClientDataKey(), responseItem.clientData, SNComponentManager.ClientDataDomain);\n          }\n          this.modelManager.setItemDirty(item, true, true, SFModelManager.MappingSourceComponentRetrieved, component.uuid);\n        }\n      }\n\n      this.syncManager.sync().then((response) => {\n        // Allow handlers to be notified when a save begins and ends, to update the UI\n        let saveMessage = Object.assign({}, message);\n        saveMessage.action = response && response.error ? \"save-error\" : \"save-success\";\n        this.replyToMessage(component, message, {error: response && response.error})\n        this.handleMessage(component, saveMessage);\n      });\n    });\n  }\n\n  handleDuplicateItemMessage(component, message) {\n    var itemParams = message.data.item;\n    var item = this.modelManager.findItem(itemParams.uuid);\n    var requiredPermissions = [\n      {\n        name: \"stream-items\",\n        content_types: [item.content_type]\n      }\n    ];\n\n    this.runWithPermissions(component, requiredPermissions, () => {\n      var duplicate = this.modelManager.duplicateItemAndAdd(item);\n      this.syncManager.sync();\n\n      this.replyToMessage(component, message, {item: this.jsonForItem(duplicate, component)});\n    });\n  }\n\n  handleCreateItemsMessage(component, message) {\n    var responseItems = message.data.item ? [message.data.item] : message.data.items;\n    let uniqueContentTypes = _.uniq(responseItems.map((item) => {return item.content_type}));\n    var requiredPermissions = [\n      {\n        name: \"stream-items\",\n        content_types: uniqueContentTypes\n      }\n    ];\n\n    this.runWithPermissions(component, requiredPermissions, () => {\n      this.removePrivatePropertiesFromResponseItems(responseItems, component, {type: \"incoming\"});\n      var processedItems = [];\n      for(let responseItem of responseItems) {\n        var item = this.modelManager.createItem(responseItem);\n        if(responseItem.clientData) {\n          item.setDomainDataItem(component.getClientDataKey(), responseItem.clientData, SNComponentManager.ClientDataDomain);\n        }\n        this.modelManager.addItem(item);\n        this.modelManager.resolveReferencesForItem(item, true);\n        this.modelManager.setItemDirty(item, true);\n        processedItems.push(item);\n      }\n\n      this.syncManager.sync();\n\n      // \"create-item\" or \"create-items\" are possible messages handled here\n      let reply =\n        message.action == \"create-item\" ?\n          {item: this.jsonForItem(processedItems[0], component)}\n        :\n          {items: processedItems.map((item) => {return this.jsonForItem(item, component)})}\n\n      this.replyToMessage(component, message, reply)\n    });\n  }\n\n  handleDeleteItemsMessage(component, message) {\n    var requiredContentTypes = _.uniq(message.data.items.map((i) => {return i.content_type})).sort();\n    var requiredPermissions = [\n      {\n        name: \"stream-items\",\n        content_types: requiredContentTypes\n      }\n    ];\n\n    this.runWithPermissions(component, requiredPermissions, () => {\n      var itemsData = message.data.items;\n      var noun = itemsData.length == 1 ? \"item\" : \"items\";\n      var reply = null;\n      if(confirm(`Are you sure you want to delete ${itemsData.length} ${noun}?`)) {\n        // Filter for any components and deactivate before deleting\n        for(var itemData of itemsData) {\n          var model = this.modelManager.findItem(itemData.uuid);\n          if([\"SN|Component\", \"SN|Theme\"].includes(model.content_type)) {\n            this.deactivateComponent(model, true);\n          }\n          this.modelManager.setItemToBeDeleted(model);\n          // Currently extensions are not notified of association until a full server sync completes.\n          // We manually notify observers.\n          this.modelManager.notifySyncObserversOfModels([model], SFModelManager.MappingSourceRemoteSaved);\n        }\n\n        this.syncManager.sync();\n        reply = {deleted: true};\n      } else {\n        // Rejected by user\n        reply = {deleted: false};\n      }\n\n      this.replyToMessage(component, message, reply)\n    });\n  }\n\n  handleRequestPermissionsMessage(component, message) {\n    this.runWithPermissions(component, message.data.permissions, () => {\n      this.replyToMessage(component, message, {approved: true});\n    });\n  }\n\n  handleSetComponentDataMessage(component, message) {\n    // A component setting its own data does not require special permissions\n    this.runWithPermissions(component, [], () => {\n      component.componentData = message.data.componentData;\n      this.modelManager.setItemDirty(component, true);\n      this.syncManager.sync();\n    });\n  }\n\n  handleToggleComponentMessage(sourceComponent, targetComponent, message) {\n    this.toggleComponent(targetComponent);\n  }\n\n  toggleComponent(component) {\n    if(component.area == \"modal\") {\n      this.openModalComponent(component);\n    } else {\n      if(component.active) {\n        this.deactivateComponent(component);\n      } else {\n        if(component.content_type == \"SN|Theme\") {\n          // Deactive currently active theme if new theme is not layerable\n          var activeThemes = this.getActiveThemes();\n\n          // Activate current before deactivating others, so as not to flicker\n          this.activateComponent(component);\n\n          if(!component.isLayerable()) {\n            setTimeout(() => {\n              for(var theme of activeThemes) {\n                if(theme && !theme.isLayerable()) {\n                  this.deactivateComponent(theme);\n                }\n              }\n            }, 10);\n          }\n        } else {\n          this.activateComponent(component);\n        }\n      }\n    }\n  }\n\n  handleInstallLocalComponentMessage(sourceComponent, message) {\n    // Only extensions manager has this permission\n    if(this.nativeExtManager && !this.nativeExtManager.isSystemExtension(sourceComponent)) {\n      return;\n    }\n\n    let targetComponent = this.modelManager.findItem(message.data.uuid);\n    this.desktopManager.installComponent(targetComponent);\n  }\n\n  runWithPermissions(component, requiredPermissions, runFunction) {\n    if(!component.permissions) {\n      component.permissions = [];\n    }\n\n    // Make copy as not to mutate input values\n    requiredPermissions = JSON.parse(JSON.stringify(requiredPermissions));\n\n    var acquiredPermissions = component.permissions;\n\n    for(let required of requiredPermissions.slice()) {\n      // Remove anything we already have\n      let respectiveAcquired = acquiredPermissions.find((candidate) => candidate.name == required.name);\n      if(!respectiveAcquired) {\n        continue;\n      }\n\n      // We now match on name, lets substract from required.content_types anything we have in acquired.\n      let requiredContentTypes = required.content_types;\n\n      if(!requiredContentTypes) {\n        // If this permission does not require any content types (i.e stream-context-item)\n        // then we can remove this from required since we match by name (respectiveAcquired.name == required.name)\n        _.pull(requiredPermissions, required);\n        continue;\n      }\n\n      for(let acquiredContentType of respectiveAcquired.content_types) {\n        // console.log(\"Removing content_type\", acquiredContentType, \"from\", requiredContentTypes);\n        _.pull(requiredContentTypes, acquiredContentType);\n      }\n\n      if(requiredContentTypes.length == 0)  {\n        // We've removed all acquired and end up with zero, means we already have all these permissions\n        _.pull(requiredPermissions, required);\n      }\n    }\n\n    if(requiredPermissions.length > 0) {\n      this.promptForPermissions(component, requiredPermissions, (approved) => {\n        if(approved) {\n          runFunction();\n        }\n      });\n    } else {\n      runFunction();\n    }\n  }\n\n  promptForPermissions(component, permissions, callback) {\n    var params = {};\n    params.component = component;\n    params.permissions = permissions;\n    params.permissionsString = this.permissionsStringForPermissions(permissions, component);\n    params.actionBlock = callback;\n\n    params.callback = (approved) => {\n      if(approved) {\n        for(let permission of permissions) {\n          let matchingPermission = component.permissions.find((candidate) => candidate.name == permission.name);\n          if(!matchingPermission) {\n            component.permissions.push(permission);\n          } else {\n            // Permission already exists, but content_types may have been expanded\n            let contentTypes = matchingPermission.content_types || [];\n            matchingPermission.content_types = _.uniq(contentTypes.concat(permission.content_types));\n          }\n        }\n        this.modelManager.setItemDirty(component, true);\n        this.syncManager.sync();\n      }\n\n      this.permissionDialogs = this.permissionDialogs.filter((pendingDialog) => {\n        // Remove self\n        if(pendingDialog == params) {\n          pendingDialog.actionBlock && pendingDialog.actionBlock(approved);\n          return false;\n        }\n\n        /* Use with numbers and strings, not objects */\n        const containsObjectSubset = function(source, target) {\n          return !target.some(val => !source.find((candidate) => candidate == val));\n        }\n\n        if(pendingDialog.component == component) {\n          // remove pending dialogs that are encapsulated by already approved permissions, and run its function\n          if(pendingDialog.permissions == permissions || containsObjectSubset(permissions, pendingDialog.permissions)) {\n            // If approved, run the action block. Otherwise, if canceled, cancel any pending ones as well, since the user was\n            // explicit in their intentions\n            if(approved) {\n              pendingDialog.actionBlock && pendingDialog.actionBlock(approved);\n            }\n            return false;\n          }\n        }\n        return true;\n      })\n\n      if(this.permissionDialogs.length > 0) {\n        this.presentPermissionsDialog(this.permissionDialogs[0]);\n      }\n    };\n\n    // since these calls are asyncronous, multiple dialogs may be requested at the same time. We only want to present one and trigger all callbacks based on one modal result\n    var existingDialog = _.find(this.permissionDialogs, {component: component});\n\n    this.permissionDialogs.push(params);\n\n    if(!existingDialog) {\n      this.presentPermissionsDialog(params);\n    } else {\n      console.log(\"Existing dialog, not presenting.\");\n    }\n  }\n\n  presentPermissionsDialog(dialog) {\n    console.error(\"Must override\");\n  }\n\n  openModalComponent(component) {\n    console.error(\"Must override\");\n  }\n\n  registerHandler(handler) {\n    this.handlers.push(handler);\n  }\n\n  deregisterHandler(identifier) {\n    var handler = _.find(this.handlers, {identifier: identifier});\n    if(!handler) {\n      console.log(\"Attempting to deregister non-existing handler\");\n      return;\n    }\n    this.handlers.splice(this.handlers.indexOf(handler), 1);\n  }\n\n  // Called by other views when the iframe is ready\n  async registerComponentWindow(component, componentWindow) {\n    if(component.window === componentWindow) {\n      if(this.loggingEnabled) {\n        console.log(\"Web|componentManager\", \"attempting to re-register same component window.\")\n      }\n    }\n\n    if(this.loggingEnabled) {\n      console.log(\"Web|componentManager|registerComponentWindow\", component);\n    }\n    component.window = componentWindow;\n    component.sessionKey = await SFJS.crypto.generateUUID();\n    this.sendMessageToComponent(component, {\n      action: \"component-registered\",\n      sessionKey: component.sessionKey,\n      componentData: component.componentData,\n      data: {\n        uuid: component.uuid,\n        environment: this.environment,\n        platform: this.platform,\n        activeThemeUrls: this.urlsForActiveThemes()\n      }\n    });\n\n    this.postActiveThemesToComponent(component);\n\n    if(this.desktopManager) {\n      this.desktopManager.notifyComponentActivation(component);\n    }\n  }\n\n  activateComponent(component, dontSync = false) {\n    var didChange = component.active != true;\n\n    component.active = true;\n    for(let handler of this.handlers) {\n      if(handler.areas.includes(component.area) || handler.areas.includes(\"*\")) {\n        // We want to run the handler in a $timeout so the UI updates, but we also don't want it to run asyncronously\n        // so that the steps below this one are run before the handler. So we run in a waitTimeout.\n        // Update 12/18: We were using this.waitTimeout previously, however, that caused the iframe.onload callback to never be called\n        // for some reason for iframes on desktop inside the revision-preview-modal. So we'll use safeApply instead. I'm not quite sure\n        // where the original \"so the UI updates\" comment applies to, but we'll have to keep an eye out to see if this causes problems somewhere else.\n        this.$uiRunner(() => {\n          handler.activationHandler && handler.activationHandler(component);\n        })\n      }\n    }\n\n    if(didChange && !dontSync) {\n      this.modelManager.setItemDirty(component, true);\n      this.syncManager.sync();\n    }\n\n    if(!this.activeComponents.includes(component)) {\n      this.activeComponents.push(component);\n    }\n\n    if(component.area == \"themes\") {\n      this.postActiveThemesToAllComponents();\n    }\n  }\n\n  deactivateComponent(component, dontSync = false) {\n    var didChange = component.active != false;\n    component.active = false;\n    component.sessionKey = null;\n\n    for(let handler of this.handlers) {\n      if(handler.areas.includes(component.area) || handler.areas.includes(\"*\")) {\n        // See comment in activateComponent regarding safeApply and awaitTimeout\n        this.$uiRunner(() => {\n          handler.activationHandler && handler.activationHandler(component);\n        })\n      }\n    }\n\n    if(didChange && !dontSync) {\n      this.modelManager.setItemDirty(component, true);\n      this.syncManager.sync();\n    }\n\n    _.pull(this.activeComponents, component);\n\n    this.streamObservers = this.streamObservers.filter((o) => {\n      return o.component !== component;\n    })\n\n    this.contextStreamObservers = this.contextStreamObservers.filter((o) => {\n      return o.component !== component;\n    })\n\n    if(component.area == \"themes\") {\n      this.postActiveThemesToAllComponents();\n    }\n  }\n\n  async reloadComponent(component) {\n    //\n    // Do soft deactivate\n    //\n    component.active = false;\n\n    for(let handler of this.handlers) {\n      if(handler.areas.includes(component.area) || handler.areas.includes(\"*\")) {\n        // See comment in activateComponent regarding safeApply and awaitTimeout\n        this.$uiRunner(() => {\n          handler.activationHandler && handler.activationHandler(component);\n        })\n      }\n    }\n\n    this.streamObservers = this.streamObservers.filter((o) => {\n      return o.component !== component;\n    })\n\n    this.contextStreamObservers = this.contextStreamObservers.filter((o) => {\n      return o.component !== component;\n    })\n\n    if(component.area == \"themes\") {\n      this.postActiveThemesToAllComponents();\n    }\n\n    //\n    // Do soft activate\n    //\n\n    return new Promise((resolve, reject) => {\n      this.$timeout(() => {\n        component.active = true;\n        for(var handler of this.handlers) {\n          if(handler.areas.includes(component.area) || handler.areas.includes(\"*\")) {\n            // See comment in activateComponent regarding safeApply and awaitTimeout\n            this.$uiRunner(() => {\n              handler.activationHandler && handler.activationHandler(component);\n              resolve();\n            })\n          }\n        }\n\n        if(!this.activeComponents.includes(component)) {\n          this.activeComponents.push(component);\n        }\n\n        if(component.area == \"themes\") {\n          this.postActiveThemesToAllComponents();\n        }\n        // Resolve again in case first resolve in for loop isn't reached.\n        // Should be no effect if resolved twice, only first will be used.\n        resolve();\n      })\n    })\n  }\n\n  deleteComponent(component) {\n    this.modelManager.setItemToBeDeleted(component);\n    this.syncManager.sync();\n  }\n\n  isComponentActive(component) {\n    return component.active;\n  }\n\n  iframeForComponent(component) {\n    for(var frame of Array.from(document.getElementsByTagName(\"iframe\"))) {\n      var componentId = frame.dataset.componentId;\n      if(componentId === component.uuid) {\n        return frame;\n      }\n    }\n  }\n\n  focusChangedForComponent(component) {\n    let focused = document.activeElement == this.iframeForComponent(component);\n    for(var handler of this.handlers) {\n      // Notify all handlers, and not just ones that match this component type\n      handler.focusHandler && handler.focusHandler(component, focused);\n    }\n  }\n\n  handleSetSizeEvent(component, data) {\n    var setSize = (element, size) => {\n      var widthString = typeof size.width === 'string' ? size.width : `${data.width}px`;\n      var heightString = typeof size.height === 'string' ? size.height : `${data.height}px`;\n      if(element) {\n        element.setAttribute(\"style\", `width:${widthString}; height:${heightString};`);\n      }\n    }\n\n    if(component.area == \"rooms\" || component.area == \"modal\") {\n      var selector = component.area == \"rooms\" ? \"inner\" : \"outer\";\n      var content = document.getElementById(`component-content-${selector}-${component.uuid}`);\n      if(content) {\n        setSize(content, data);\n      }\n    } else {\n      var iframe = this.iframeForComponent(component);\n      if(!iframe) {\n        return;\n      }\n\n      setSize(iframe, data);\n\n      // On Firefox, resizing a component iframe does not seem to have an effect with editor-stack extensions.\n      // Sizing the parent does the trick, however, we can't do this globally, otherwise, areas like the note-tags will\n      // not be able to expand outside of the bounds (to display autocomplete, for example).\n      if(component.area == \"editor-stack\") {\n        let parent = iframe.parentElement;\n        if(parent) {\n          setSize(parent, data);\n        }\n      }\n\n      // content object in this case is === to the iframe object above. This is probably\n      // legacy code from when we would size content and container individually, which we no longer do.\n      // var content = document.getElementById(`component-iframe-${component.uuid}`);\n      // console.log(\"content === iframe\", content == iframe);\n      // if(content) {\n      //   setSize(content, data);\n      // }\n    }\n  }\n\n  editorForNote(note) {\n    let editors = this.componentsForArea(\"editor-editor\");\n    for(var editor of editors) {\n      if(editor.isExplicitlyEnabledForItem(note)) {\n        return editor;\n      }\n    }\n\n    // No editor found for note. Use default editor, if note does not prefer system editor\n    if(this.isMobile) {\n      if(!note.content.mobilePrefersPlainEditor) {\n        return this.getDefaultEditor();\n      }\n    } else {\n      if(!note.getAppDataItem(\"prefersPlainEditor\")) {\n        return editors.filter((e) => {return e.isDefaultEditor()})[0];\n      }\n    }\n  }\n\n  permissionsStringForPermissions(permissions, component) {\n    var finalString = \"\";\n    let permissionsCount = permissions.length;\n\n    let addSeparator = (index, length) => {\n      if(index > 0) {\n        if(index == length - 1) {\n          if(length == 2) {\n            return \" and \";\n          } else {\n            return \", and \"\n          }\n        } else {\n          return \", \";\n        }\n      }\n\n      return \"\";\n    }\n\n    permissions.forEach((permission, index) => {\n      if(permission.name === \"stream-items\") {\n        var types = permission.content_types.map((type) => {\n          var desc = this.modelManager.humanReadableDisplayForContentType(type);\n          if(desc) {\n            return desc + \"s\";\n          } else {\n            return \"items of type \" + type;\n          }\n        })\n        var typesString = \"\";\n\n        for(var i = 0;i < types.length;i++) {\n          var type = types[i];\n          typesString += addSeparator(i, types.length + permissionsCount - index - 1);\n          typesString += type;\n        }\n\n        finalString += addSeparator(index, permissionsCount);\n\n        finalString += typesString;\n\n        if(types.length >= 2 && index < permissionsCount - 1) {\n          // If you have a list of types, and still an additional root-level permission coming up, add a comma\n          finalString += \", \";\n        }\n      } else if(permission.name === \"stream-context-item\") {\n        var mapping = {\n          \"editor-stack\" : \"working note\",\n          \"note-tags\" : \"working note\",\n          \"editor-editor\": \"working note\"\n        }\n\n        finalString += addSeparator(index, permissionsCount, true);\n\n        finalString += mapping[component.area];\n      }\n    })\n\n    return finalString + \".\";\n  }\n}\n;export class SNComponent extends SFItem {\n\n  constructor(json_obj) {\n    // If making a copy of an existing component (usually during sign in if you have a component active in the session),\n    // which may have window set, you may get a cross-origin exception since you'll be trying to copy the window. So we clear it here.\n    json_obj.window = null;\n\n    super(json_obj);\n\n    if(!this.componentData) {\n      this.componentData = {};\n    }\n\n    if(!this.disassociatedItemIds) {\n      this.disassociatedItemIds = [];\n    }\n\n    if(!this.associatedItemIds) {\n      this.associatedItemIds = [];\n    }\n  }\n\n  mapContentToLocalProperties(content) {\n    super.mapContentToLocalProperties(content)\n    /* Legacy */\n    // We don't want to set the url directly, as we'd like to phase it out.\n    // If the content.url exists, we'll transfer it to legacy_url\n    // We'll only need to set this if content.hosted_url is blank, otherwise, hosted_url is the url replacement.\n    if(!content.hosted_url) {\n      this.legacy_url = content.url;\n    }\n\n    /* New */\n    this.local_url = content.local_url;\n    this.hosted_url = content.hosted_url || content.url;\n    this.offlineOnly = content.offlineOnly;\n\n    if(content.valid_until) {\n      this.valid_until = new Date(content.valid_until);\n    }\n\n    this.name = content.name;\n    this.autoupdateDisabled = content.autoupdateDisabled;\n\n    this.package_info = content.package_info;\n\n    // the location in the view this component is located in. Valid values are currently tags-list, note-tags, and editor-stack`\n    this.area = content.area;\n\n    this.permissions = content.permissions;\n    if(!this.permissions) {\n      this.permissions = [];\n    }\n\n    this.active = content.active;\n\n    // custom data that a component can store in itself\n    this.componentData = content.componentData || {};\n\n    // items that have requested a component to be disabled in its context\n    this.disassociatedItemIds = content.disassociatedItemIds || [];\n\n    // items that have requested a component to be enabled in its context\n    this.associatedItemIds = content.associatedItemIds || [];\n  }\n\n  handleDeletedContent() {\n    super.handleDeletedContent();\n\n    this.active = false;\n  }\n\n  structureParams() {\n    var params = {\n      legacy_url: this.legacy_url,\n      hosted_url: this.hosted_url,\n      local_url: this.local_url,\n      valid_until: this.valid_until,\n      offlineOnly: this.offlineOnly,\n      name: this.name,\n      area: this.area,\n      package_info: this.package_info,\n      permissions: this.permissions,\n      active: this.active,\n      autoupdateDisabled: this.autoupdateDisabled,\n      componentData: this.componentData,\n      disassociatedItemIds: this.disassociatedItemIds,\n      associatedItemIds: this.associatedItemIds,\n    };\n\n    var superParams = super.structureParams();\n    Object.assign(superParams, params);\n    return superParams;\n  }\n\n  get content_type() {\n    return \"SN|Component\";\n  }\n\n  isEditor() {\n    return this.area == \"editor-editor\";\n  }\n\n  isTheme() {\n    return this.content_type == \"SN|Theme\" || this.area == \"themes\";\n  }\n\n  isDefaultEditor() {\n    return this.getAppDataItem(\"defaultEditor\") == true;\n  }\n\n  setLastSize(size) {\n    this.setAppDataItem(\"lastSize\", size);\n  }\n\n  getLastSize() {\n    return this.getAppDataItem(\"lastSize\");\n  }\n\n  acceptsThemes() {\n    if(this.content.package_info && \"acceptsThemes\" in this.content.package_info) {\n      return this.content.package_info.acceptsThemes;\n    }\n    return true;\n  }\n\n  /*\n    The key used to look up data that this component may have saved to an item.\n    This key will be look up on the item, and not on itself.\n   */\n  getClientDataKey() {\n    if(this.legacy_url) {\n      return this.legacy_url;\n    } else {\n      return this.uuid;\n    }\n  }\n\n  hasValidHostedUrl() {\n    return this.hosted_url || this.legacy_url;\n  }\n\n  keysToIgnoreWhenCheckingContentEquality() {\n    return [\"active\", \"disassociatedItemIds\", \"associatedItemIds\"].concat(super.keysToIgnoreWhenCheckingContentEquality());\n  }\n\n\n  /*\n    An associative component depends on being explicitly activated for a given item, compared to a dissaciative component,\n    which is enabled by default in areas unrelated to a certain item.\n   */\n   static associativeAreas() {\n     return [\"editor-editor\"];\n   }\n\n  isAssociative() {\n    return Component.associativeAreas().includes(this.area);\n  }\n\n  associateWithItem(item) {\n    this.associatedItemIds.push(item.uuid);\n  }\n\n  isExplicitlyEnabledForItem(item) {\n    return this.associatedItemIds.indexOf(item.uuid) !== -1;\n  }\n\n  isExplicitlyDisabledForItem(item) {\n    return this.disassociatedItemIds.indexOf(item.uuid) !== -1;\n  }\n}\n;export class SNEditor extends SFItem {\n\n  constructor(json_obj) {\n    super(json_obj);\n    if(!this.notes) {\n      this.notes = [];\n    }\n    if(!this.data) {\n      this.data = {};\n    }\n  }\n\n  mapContentToLocalProperties(content) {\n    super.mapContentToLocalProperties(content)\n    this.url = content.url;\n    this.name = content.name;\n    this.data = content.data || {};\n    this.default = content.default;\n    this.systemEditor = content.systemEditor;\n  }\n\n  structureParams() {\n    var params = {\n      url: this.url,\n      name: this.name,\n      data: this.data,\n      default: this.default,\n      systemEditor: this.systemEditor\n    };\n\n    var superParams = super.structureParams();\n    Object.assign(superParams, params);\n    return superParams;\n  }\n\n  referenceParams() {\n    var references = _.map(this.notes, function(note){\n      return {uuid: note.uuid, content_type: note.content_type};\n    })\n\n    return references;\n  }\n\n  addItemAsRelationship(item) {\n    if(item.content_type == \"Note\") {\n      if(!_.find(this.notes, item)) {\n        this.notes.push(item);\n      }\n    }\n    super.addItemAsRelationship(item);\n  }\n\n  removeItemAsRelationship(item) {\n    if(item.content_type == \"Note\") {\n      _.pull(this.notes, item);\n    }\n    super.removeItemAsRelationship(item);\n  }\n\n  removeAndDirtyAllRelationships() {\n    super.removeAndDirtyAllRelationships();\n    this.notes = [];\n  }\n\n  removeReferencesNotPresentIn(references) {\n    super.removeReferencesNotPresentIn(references);\n\n    var uuids = references.map(function(ref){return ref.uuid});\n    this.notes.forEach(function(note){\n      if(!uuids.includes(note.uuid)) {\n        _.remove(this.notes, {uuid: note.uuid});\n      }\n    }.bind(this))\n  }\n\n  potentialItemOfInterestHasChangedItsUUID(newItem, oldUUID, newUUID) {\n    if(newItem.content_type === \"Note\" && _.find(this.notes, {uuid: oldUUID})) {\n      _.remove(this.notes, {uuid: oldUUID});\n      this.notes.push(newItem);\n    }\n  }\n\n  get content_type() {\n    return \"SN|Editor\";\n  }\n\n  setData(key, value) {\n    var dataHasChanged = JSON.stringify(this.data[key]) !== JSON.stringify(value);\n    if(dataHasChanged) {\n      this.data[key] = value;\n      return true;\n    }\n    return false;\n  }\n\n  dataForKey(key) {\n    return this.data[key] || {};\n  }\n}\n;export class Action {\n  constructor(json) {\n    _.merge(this, json);\n    this.running = false; // in case running=true was synced with server since model is uploaded nondiscriminatory\n    this.error = false;\n    if(this.lastExecuted) {\n      // is string\n      this.lastExecuted = new Date(this.lastExecuted);\n    }\n  }\n}\n\nexport class SNExtension extends SFItem {\n  constructor(json) {\n      super(json);\n\n      if(json.actions) {\n        this.actions = json.actions.map(function(action){\n          return new Action(action);\n        })\n      }\n\n      if(!this.actions) {\n        this.actions = [];\n      }\n  }\n\n  actionsWithContextForItem(item) {\n    return this.actions.filter(function(action){\n      return action.context == item.content_type || action.context == \"Item\";\n    })\n  }\n\n  mapContentToLocalProperties(content) {\n    super.mapContentToLocalProperties(content)\n    this.description = content.description;\n    this.url = content.url;\n    this.name = content.name;\n    this.package_info = content.package_info;\n    this.supported_types = content.supported_types;\n    if(content.actions) {\n      this.actions = content.actions.map(function(action){\n        return new Action(action);\n      })\n    }\n  }\n\n  get content_type() {\n    return \"Extension\";\n  }\n\n  structureParams() {\n    var params = {\n      name: this.name,\n      url: this.url,\n      package_info: this.package_info,\n      description: this.description,\n      actions: this.actions.map((a) => {return _.omit(a, [\"subrows\", \"subactions\"])}),\n      supported_types: this.supported_types\n    };\n\n    var superParams = super.structureParams();\n    Object.assign(superParams, params);\n    return superParams;\n  }\n\n}\n;export class SNNote extends SFItem {\n\n  constructor(json_obj) {\n    super(json_obj);\n\n    if(!this.text) {\n      // Some external editors can't handle a null value for text.\n      // Notes created on mobile with no text have a null value for it,\n      // so we'll just set a default here.\n      this.text = \"\";\n    }\n\n    if(!this.tags) {\n      this.tags = [];\n    }\n  }\n\n  mapContentToLocalProperties(content) {\n    super.mapContentToLocalProperties(content)\n    this.title = content.title;\n    this.text = content.text;\n  }\n\n  structureParams() {\n    var params = {\n      title: this.title,\n      text: this.text\n    };\n\n    var superParams = super.structureParams();\n    Object.assign(superParams, params);\n    return superParams;\n  }\n\n  addItemAsRelationship(item) {\n    /*\n    Legacy.\n    Previously, note/tag relationships were bidirectional, however in some cases there\n    may be broken links such that a note has references to a tag and not vice versa.\n    Now, only tags contain references to notes. For old notes that may have references to tags,\n    we want to transfer them over to the tag.\n     */\n    if(item.content_type == \"Tag\") {\n      item.addItemAsRelationship(this);\n    }\n    super.addItemAsRelationship(item);\n  }\n\n  setIsBeingReferencedBy(item) {\n    super.setIsBeingReferencedBy(item);\n    this.clearSavedTagsString();\n  }\n\n  setIsNoLongerBeingReferencedBy(item) {\n    super.setIsNoLongerBeingReferencedBy(item);\n    this.clearSavedTagsString();\n  }\n\n  isBeingRemovedLocally() {\n    this.tags.forEach(function(tag){\n      _.remove(tag.notes, {uuid: this.uuid});\n    }.bind(this))\n    super.isBeingRemovedLocally();\n  }\n\n  static filterDummyNotes(notes) {\n    var filtered = notes.filter(function(note){return note.dummy == false || note.dummy == null});\n    return filtered;\n  }\n\n  informReferencesOfUUIDChange(oldUUID, newUUID) {\n    super.informReferencesOfUUIDChange();\n    for(var tag of this.tags) {\n      _.remove(tag.notes, {uuid: oldUUID});\n      tag.notes.push(this);\n    }\n  }\n\n  tagDidFinishSyncing(tag) {\n    this.clearSavedTagsString();\n  }\n\n  safeText() {\n    return this.text || \"\";\n  }\n\n  safeTitle() {\n    return this.title || \"\";\n  }\n\n  get content_type() {\n    return \"Note\";\n  }\n\n  get displayName() {\n    return \"Note\";\n  }\n\n  clearSavedTagsString() {\n    this.savedTagsString = null;\n  }\n\n  tagsString() {\n    this.savedTagsString = SNTag.arrayToDisplayString(this.tags);\n    return this.savedTagsString;\n  }\n}\n;export class SNTag extends SFItem {\n\n  constructor(json_obj) {\n    super(json_obj);\n\n    if(!this.content_type) {\n      this.content_type = \"Tag\";\n    }\n\n    if(!this.notes) {\n      this.notes = [];\n    }\n  }\n\n  mapContentToLocalProperties(content) {\n    super.mapContentToLocalProperties(content)\n    this.title = content.title;\n  }\n\n  structureParams() {\n    var params = {\n      title: this.title\n    };\n\n    var superParams = super.structureParams();\n    Object.assign(superParams, params);\n    return superParams;\n  }\n\n  addItemAsRelationship(item) {\n    if(item.content_type == \"Note\") {\n      if(!_.find(this.notes, {uuid: item.uuid})) {\n        this.notes.push(item);\n        item.tags.push(this);\n      }\n    }\n    super.addItemAsRelationship(item);\n  }\n\n  removeItemAsRelationship(item) {\n    if(item.content_type == \"Note\") {\n      _.remove(this.notes, {uuid: item.uuid});\n      _.remove(item.tags, {uuid: this.uuid});\n    }\n    super.removeItemAsRelationship(item);\n  }\n\n  updateLocalRelationships() {\n    var references = this.content.references;\n\n    var uuids = references.map(function(ref){return ref.uuid});\n    this.notes.slice().forEach(function(note){\n      if(!uuids.includes(note.uuid)) {\n        _.remove(note.tags, {uuid: this.uuid});\n        _.remove(this.notes, {uuid: note.uuid});\n\n        note.setIsNoLongerBeingReferencedBy(this);\n      }\n    }.bind(this))\n  }\n\n  isBeingRemovedLocally() {\n    this.notes.forEach((note) => {\n      _.remove(note.tags, {uuid: this.uuid});\n      note.setIsNoLongerBeingReferencedBy(this);\n    })\n\n    this.notes.length = 0;\n\n    super.isBeingRemovedLocally();\n  }\n\n  informReferencesOfUUIDChange(oldUUID, newUUID) {\n    for(var note of this.notes) {\n      _.remove(note.tags, {uuid: oldUUID});\n      note.tags.push(this);\n    }\n  }\n\n  didFinishSyncing() {\n    for(var note of this.notes) {\n      note.tagDidFinishSyncing(this);\n    }\n  }\n\n  isSmartTag() {\n    return this.content_type == \"SN|SmartTag\";\n  }\n\n  get displayName() {\n    return \"Tag\";\n  }\n\n  static arrayToDisplayString(tags) {\n    return tags.sort((a, b) => {return a.title > b.title}).map(function(tag, i){\n      return \"#\" + tag.title;\n    }).join(\" \");\n  }\n}\n;export class SNEncryptedStorage extends SFItem {\n\n  mapContentToLocalProperties(content) {\n    super.mapContentToLocalProperties(content)\n    this.storage = content.storage;\n  }\n\n  get content_type() {\n    return \"SN|EncryptedStorage\";\n  }\n\n}\n;export class SNMfa extends SFItem {\n\n  constructor(json_obj) {\n    super(json_obj);\n  }\n\n  // mapContentToLocalProperties(content) {\n  //   super.mapContentToLocalProperties(content)\n  //   this.serverContent = content;\n  // }\n  //\n  // structureParams() {\n  //   return _.merge(this.serverContent, super.structureParams());\n  // }\n\n  get content_type() {\n    return \"SF|MFA\";\n  }\n\n  doNotEncrypt() {\n    return true;\n  }\n\n}\n;export class SNServerExtension extends SFItem {\n\n  mapContentToLocalProperties(content) {\n    super.mapContentToLocalProperties(content)\n    this.url = content.url;\n  }\n\n  get content_type() {\n    return \"SF|Extension\";\n  }\n\n  doNotEncrypt() {\n    return true;\n  }\n}\n;export class SNSmartTag extends SNTag {\n\n  constructor(json_ob) {\n    super(json_ob);\n    this.content_type = \"SN|SmartTag\";\n  }\n\n  static systemSmartTags() {\n    return [\n      new SNSmartTag({\n        uuid: SNSmartTag.SystemSmartTagIdAllNotes,\n        dummy: true,\n        content: {\n          title: \"All notes\",\n          isSystemTag: true,\n          isAllTag: true,\n          predicate: new SFPredicate.fromArray([\"content_type\", \"=\", \"Note\"])\n        }\n      }),\n      new SNSmartTag({\n        uuid: SNSmartTag.SystemSmartTagIdArchivedNotes,\n        dummy: true,\n        content: {\n          title: \"Archived\",\n          isSystemTag: true,\n          isArchiveTag: true,\n          predicate: new SFPredicate.fromArray([\"archived\", \"=\", true])\n        }\n      }),\n      new SNSmartTag({\n        uuid: SNSmartTag.SystemSmartTagIdTrashedNotes,\n        dummy: true,\n        content: {\n          title: \"Trash\",\n          isSystemTag: true,\n          isTrashTag: true,\n          predicate: new SFPredicate.fromArray([\"content.trashed\", \"=\", true])\n        }\n      })\n    ]\n  }\n}\n\nSNSmartTag.SystemSmartTagIdAllNotes = \"all-notes\";\nSNSmartTag.SystemSmartTagIdArchivedNotes = \"archived-notes\";\nSNSmartTag.SystemSmartTagIdTrashedNotes = \"trashed-notes\";\n;export class SNTheme extends SNComponent {\n\n  constructor(json_obj) {\n    super(json_obj);\n    this.area = \"themes\";\n  }\n\n  isLayerable() {\n    return this.package_info && this.package_info.layerable;\n  }\n\n  get content_type() {\n    return \"SN|Theme\";\n  }\n\n  get displayName() {\n    return \"Theme\";\n  }\n\n  setMobileRules(rules) {\n    this.setAppDataItem(\"mobileRules\", rules);\n  }\n\n  getMobileRules() {\n    return this.getAppDataItem(\"mobileRules\") || {constants: {}, rules: {}};\n  }\n\n  // Same as getMobileRules but without default value\n  hasMobileRules() {\n    return this.getAppDataItem(\"mobileRules\");\n  }\n\n  setNotAvailOnMobile(na) {\n    this.setAppDataItem(\"notAvailableOnMobile\", na);\n  }\n\n  getNotAvailOnMobile() {\n    return this.getAppDataItem(\"notAvailableOnMobile\");\n  }\n\n  /* We must not use .active because if you set that to true, it will also activate that theme on desktop/web */\n  setMobileActive(active) {\n    this.setAppDataItem(\"mobileActive\", active);\n  }\n\n  isMobileActive() {\n    return this.getAppDataItem(\"mobileActive\");\n  }\n}\n;import {SFItem} from 'standard-file-js';\n\nif(typeof window !== 'undefined' && window !== null) {\n  // window is for some reason defined in React Native, but throws an exception when you try to set to it\n  try {\n    window.SNNote = SNNote;\n    window.SNTag = SNTag;\n    window.SNSmartTag = SNSmartTag;\n    window.SNMfa = SNMfa;\n    window.SNServerExtension = SNServerExtension;\n    window.SNComponent = SNComponent;\n    window.SNEditor = SNEditor;\n    window.SNExtension = SNExtension;\n    window.SNTheme = SNTheme;\n    window.SNEncryptedStorage = SNEncryptedStorage;\n    window.SNComponentManager = SNComponentManager;\n  } catch (e) {\n    console.log(\"Exception while exporting snjs window variables\", e);\n  }\n}\n"]}