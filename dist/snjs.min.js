!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("SNLibrary",[],t):"object"==typeof exports?exports.SNLibrary=t():e.SNLibrary=t()}(window,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/dist/",r(r.s=211)}([function(e,t,r){e.exports=r(94)},function(e,t,r){"use strict";(function(e){r.d(t,"h",(function(){return h})),r.d(t,"o",(function(){return v})),r.d(t,"g",(function(){return d})),r.d(t,"m",(function(){return m})),r.d(t,"k",(function(){return b})),r.d(t,"l",(function(){return g})),r.d(t,"n",(function(){return w})),r.d(t,"i",(function(){return k})),r.d(t,"z",(function(){return x})),r.d(t,"q",(function(){return S})),r.d(t,"f",(function(){return P})),r.d(t,"x",(function(){return O})),r.d(t,"u",(function(){return _})),r.d(t,"b",(function(){return j})),r.d(t,"v",(function(){return I})),r.d(t,"c",(function(){return E})),r.d(t,"s",(function(){return D})),r.d(t,"r",(function(){return C})),r.d(t,"p",(function(){return R})),r.d(t,"a",(function(){return A})),r.d(t,"e",(function(){return T})),r.d(t,"t",(function(){return M})),r.d(t,"d",(function(){return K})),r.d(t,"j",(function(){return L})),r.d(t,"y",(function(){return F})),r.d(t,"w",(function(){return N}));var n=r(0),a=r.n(n),o=r(4),i=r.n(o),s=r(90),c=r.n(s),u=r(91),l=r.n(u);function f(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function p(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){f(o,n,a,i,s,"next",e)}function s(e){f(o,n,a,i,s,"throw",e)}i(void 0)}))}}function y(e){return(y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function h(){return"undefined"!=typeof window?window:void 0!==e?e:null}function v(){return null!==h()}function d(e,t,r){return e.find((function(e){return e[t]===r}))}function m(e){return null!==e&&("function"==typeof e||"object"===y(e))}function b(e){return null!==e&&"function"==typeof e}function g(e){return null==e}function w(e){return"string"==typeof e||e instanceof String}function k(e,t){return e>t?e:t}function x(e,t,r){return l()(e.concat(t),(function(e,t){var n=!0,a=!1,o=void 0;try{for(var i,s=r[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var c=i.value;if(e[c]!==t[c])return!1}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return!0}))}function S(e){return e[e.length-1]}function P(e,t){var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;e.push(s)}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}function O(e,t){var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;e.splice(e.indexOf(s),1)}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}function _(e,t){e.splice(e.indexOf(t),1)}function j(e,t){return e.filter((function(e){return!t.includes(e)})).concat(t.filter((function(t){return!e.includes(t)})))}function I(e,t){e.splice(t,1)}function E(e,t){var r=e.slice();return I(r,t),r}function D(e,t){if(e){var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){delete e[o.value]}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}}function C(e,t){var r=Object.assign({},e),n=!0,a=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){delete r[i.value]}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return r}function R(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.map((function(e,t){return 0===t?e.trim().replace(/[\/]*$/g,""):e.trim().replace(/(^[\/]*|[\/]*$)/g,"")})).filter((function(e){return e.length})).join("/")}function A(e){return JSON.parse(JSON.stringify(e))}function T(e,t){if(!e||!t)throw"Attempting to deepMerge with null values";return c()(e,t,(function(e,t){if(i()(e))return t})),e}function M(e,t){var r={},n=!0,a=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var c=i.value;r[c]=e[c]}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return A(r)}function K(e){var t=Object.getOwnPropertyNames(e),r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value,c=e[s];e[s]=c&&"object"===y(c)?K(c):c}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}return Object.freeze(e)}function L(e,t){var r=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(e),t);return r&&!g(r.get)}function F(e,t){var r=t/4;return e.substring(0,r)}function N(e){return U.apply(this,arguments)}function U(){return(U=p(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.warn("Sleeping for",t),e.abrupt("return",new Promise((function(e,r){setTimeout((function(){e()}),t)})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}).call(this,r(54))},function(e,t,r){var n=r(18),a=r(186);e.exports=function(e,t){var r=[];if(!e||!e.length)return r;var o=-1,i=[],s=e.length;for(t=n(t,3);++o<s;){var c=e[o];t(c,o,e)&&(r.push(c),i.push(o))}return a(e,i),r}},function(e,t,r){var n=r(71)(r(183));e.exports=n},function(e,t){var r=Array.isArray;e.exports=r},function(e,t,r){var n=r(178)(r(179));e.exports=n},function(e,t,r){(function(e){var r,n,a,o;function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}window,o=function(){return function(e){function t(t){for(var r,a,o=t[0],i=t[1],s=0,c=[];s<o.length;s++)a=o[s],Object.prototype.hasOwnProperty.call(n,a)&&n[a]&&c.push(n[a][0]),n[a]=0;for(r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r]);for(u&&u(t);c.length;)c.shift()()}var r={},n={1:0,2:0};function a(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.e=function(e){var t=[],r=n[e];if(0!==r)if(r)t.push(r[2]);else{var o=new Promise((function(t,a){r=n[e]=[t,a]}));t.push(r[2]=o);var i,s=document.createElement("script");s.charset="utf-8",s.timeout=120,a.nc&&s.setAttribute("nonce",a.nc),s.src=function(e){return a.p+""+({0:"libsodium",3:"vendors~libsodium"}[e]||e)+".bundle.js"}(e);var c=new Error;i=function(t){s.onerror=s.onload=null,clearTimeout(u);var r=n[e];if(0!==r){if(r){var a=t&&("load"===t.type?"missing":t.type),o=t&&t.target&&t.target.src;c.message="Loading chunk "+e+" failed.\n("+a+": "+o+")",c.name="ChunkLoadError",c.type=a,c.request=o,r[1](c)}n[e]=void 0}};var u=setTimeout((function(){i({type:"timeout",target:s})}),12e4);s.onerror=s.onload=i,document.head.appendChild(s)}return Promise.all(t)},a.m=e,a.c=r,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==i(e)&&e&&e.__esModule)return e;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(r,n,function(t){return e[t]}.bind(null,n));return r},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/dist/",a.oe=function(e){throw console.error(e),e};var o=window.webpackJsonpSNCrypto=window.webpackJsonpSNCrypto||[],s=o.push.bind(o);o.push=t,o=o.slice();for(var c=0;c<o.length;c++)t(o[c]);var u=s;return a(a.s=11)}([function(e,t,r){e.exports=r(6)},function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return c})),r.d(t,"j",(function(){return u})),r.d(t,"o",(function(){return l})),r.d(t,"k",(function(){return f})),r.d(t,"i",(function(){return p})),r.d(t,"n",(function(){return y})),r.d(t,"p",(function(){return h})),r.d(t,"d",(function(){return d})),r.d(t,"c",(function(){return b})),r.d(t,"l",(function(){return w})),r.d(t,"g",(function(){return x})),r.d(t,"b",(function(){return P})),r.d(t,"m",(function(){return _})),r.d(t,"h",(function(){return I})),r.d(t,"f",(function(){return D})),r.d(t,"e",(function(){return C})),r.d(t,"q",(function(){return R}));var n=r(0),a=r.n(n);function o(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function i(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var i=e.apply(t,r);function s(e){o(i,n,a,s,c,"next",e)}function c(e){o(i,n,a,s,c,"throw",e)}s(void 0)}))}}var s=r(7),c=r(2).Buffer;function u(){return"undefined"!=typeof window?window:void 0!==e?e:null}function l(){return!("undefined"!=typeof document&&document.documentMode||/Edge/.test(navigator.userAgent))&&u().crypto&&!!u().crypto.subtle}function f(){return u().crypto?u().crypto.subtle:null}function p(){var e=u(),t=e.crypto||e.msCrypto;if(t){var r=new Uint32Array(4);t.getRandomValues(r);var n=-1;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){n++;var t=r[n>>3]>>n%8*4&15;return("x"===e?t:3&t|8).toString(16)}))}var a=(new Date).getTime();return e.performance&&"function"==typeof e.performance.now&&(a+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===e?t:3&t|8).toString(16)}))}function y(e){return"string"==typeof e||e instanceof String}function h(e){return v.apply(this,arguments)}function v(){return(v=i(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){var n=new Blob([t]),a=new FileReader;a.onload=function(t){e(t.target.result)},a.readAsArrayBuffer(n)})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function d(e){return m.apply(this,arguments)}function m(){return(m=i(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){var n=new Blob([t]),a=new FileReader;a.onload=function(t){e(t.target.result)},a.readAsText(n)})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function b(e){return g.apply(this,arguments)}function g(){return(g=i(a.a.mark((function e(t){var r,n,o,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(r=new Uint8Array(t),n="",i=0;i<r.byteLength;i++)(o=r[i].toString(16)).length<2&&(o="0"+o),n+=o;return e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function w(e){return k.apply(this,arguments)}function k(){return(k=i(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(r=[],n=0;n<t.length;n+=2)r.push(parseInt(t.substr(n,2),16));return e.abrupt("return",new Uint8Array(r));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e){return S.apply(this,arguments)}function S(){return(S=i(a.a.mark((function e(t){var r,n,o,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,C(t);case 2:for(r=e.sent,n=r.length,o=new Uint8Array(n),i=0;i<n;i++)o[i]=r.charCodeAt(i);return e.abrupt("return",o.buffer);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function P(e){return O.apply(this,arguments)}function O(){return(O=i(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){var n=new Blob([t],{type:"application/octet-binary"}),a=new FileReader;a.onload=function(t){var r=t.target.result;e(r.substr(r.indexOf(",")+1))},a.readAsDataURL(n)})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _(e){return j.apply(this,arguments)}function j(){return(j=i(a.a.mark((function e(t){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=c.from(t,"hex"),e.abrupt("return",r.toString("base64"));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function I(e){return E.apply(this,arguments)}function E(){return(E=i(a.a.mark((function e(t){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=c.from(t,"base64"),e.abrupt("return",r.toString("hex"));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function D(e){return u().btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)})))}function C(e){return u().atob(e)}function R(e){return A.apply(this,arguments)}function A(){return(A=i(a.a.mark((function e(t){var r,n=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.length>1&&void 0!==n[1]?n[1]:"binary",!c.isBuffer(t)){e.next=5;break}return e.abrupt("return",t);case 5:if(null!==t){e.next=9;break}return e.abrupt("return",null);case 9:if("string"!=typeof t){e.next=13;break}return e.abrupt("return",c.from(t,r));case 13:if(!(t instanceof Uint8Array)){e.next=17;break}return e.abrupt("return",s(t));case 17:if(!(t instanceof Promise)){e.next=21;break}return e.abrupt("return",t);case 21:throw new TypeError("Invalid type; string or buffer expected");case 22:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}).call(this,r(3))},function(e,t,r){"use strict";(function(e){
/*!
       * The buffer module from node.js, for the browser.
       *
       * @author   Feross Aboukhadijeh <http://feross.org>
       * @license  MIT
       */
var n=r(8),a=r(9),o=r(5);function i(){return c.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function s(e,t){if(i()<t)throw new RangeError("Invalid typed array length");return c.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=c.prototype:(null===e&&(e=new c(t)),e.length=t),e}function c(e,t,r){if(!(c.TYPED_ARRAY_SUPPORT||this instanceof c))return new c(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return f(this,e)}return u(this,e,t,r)}function u(e,t,r,n){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,r,n){if(t.byteLength,r<0||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(n||0))throw new RangeError("'length' is out of bounds");return t=void 0===r&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,r):new Uint8Array(t,r,n),c.TYPED_ARRAY_SUPPORT?(e=t).__proto__=c.prototype:e=p(e,t),e}(e,t,r,n):"string"==typeof t?function(e,t,r){if("string"==typeof r&&""!==r||(r="utf8"),!c.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var n=0|h(t,r),a=(e=s(e,n)).write(t,r);return a!==n&&(e=e.slice(0,a)),e}(e,t,r):function(e,t){if(c.isBuffer(t)){var r=0|y(t.length);return 0===(e=s(e,r)).length||t.copy(e,0,0,r),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(n=t.length)!=n?s(e,0):p(e,t);if("Buffer"===t.type&&o(t.data))return p(e,t.data)}var n;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function f(e,t){if(l(t),e=s(e,t<0?0:0|y(t)),!c.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function p(e,t){var r=t.length<0?0:0|y(t.length);e=s(e,r);for(var n=0;n<r;n+=1)e[n]=255&t[n];return e}function y(e){if(e>=i())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i().toString(16)+" bytes");return 0|e}function h(e,t){if(c.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return U(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return B(e).length;default:if(n)return U(e).length;t=(""+t).toLowerCase(),n=!0}}function v(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return E(this,t,r);case"utf8":case"utf-8":return _(this,t,r);case"ascii":return j(this,t,r);case"latin1":case"binary":return I(this,t,r);case"base64":return O(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return D(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function d(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function m(e,t,r,n,a){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=a?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(a)return-1;r=e.length-1}else if(r<0){if(!a)return-1;r=0}if("string"==typeof t&&(t=c.from(t,n)),c.isBuffer(t))return 0===t.length?-1:b(e,t,r,n,a);if("number"==typeof t)return t&=255,c.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?a?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):b(e,[t],r,n,a);throw new TypeError("val must be string, number or Buffer")}function b(e,t,r,n,a){var o,i=1,s=e.length,c=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;i=2,s/=2,c/=2,r/=2}function u(e,t){return 1===i?e[t]:e.readUInt16BE(t*i)}if(a){var l=-1;for(o=r;o<s;o++)if(u(e,o)===u(t,-1===l?0:o-l)){if(-1===l&&(l=o),o-l+1===c)return l*i}else-1!==l&&(o-=o-l),l=-1}else for(r+c>s&&(r=s-c),o=r;o>=0;o--){for(var f=!0,p=0;p<c;p++)if(u(e,o+p)!==u(t,p)){f=!1;break}if(f)return o}return-1}function g(e,t,r,n){r=Number(r)||0;var a=e.length-r;n?(n=Number(n))>a&&(n=a):n=a;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");n>o/2&&(n=o/2);for(var i=0;i<n;++i){var s=parseInt(t.substr(2*i,2),16);if(isNaN(s))return i;e[r+i]=s}return i}function w(e,t,r,n){return V(U(t,e.length-r),e,r,n)}function k(e,t,r,n){return V(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function x(e,t,r,n){return k(e,t,r,n)}function S(e,t,r,n){return V(B(t),e,r,n)}function P(e,t,r,n){return V(function(e,t){for(var r,n,a,o=[],i=0;i<e.length&&!((t-=2)<0);++i)n=(r=e.charCodeAt(i))>>8,a=r%256,o.push(a),o.push(n);return o}(t,e.length-r),e,r,n)}function O(e,t,r){return 0===t&&r===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,r))}function _(e,t,r){r=Math.min(e.length,r);for(var n=[],a=t;a<r;){var o,i,s,c,u=e[a],l=null,f=u>239?4:u>223?3:u>191?2:1;if(a+f<=r)switch(f){case 1:u<128&&(l=u);break;case 2:128==(192&(o=e[a+1]))&&(c=(31&u)<<6|63&o)>127&&(l=c);break;case 3:o=e[a+1],i=e[a+2],128==(192&o)&&128==(192&i)&&(c=(15&u)<<12|(63&o)<<6|63&i)>2047&&(c<55296||c>57343)&&(l=c);break;case 4:o=e[a+1],i=e[a+2],s=e[a+3],128==(192&o)&&128==(192&i)&&128==(192&s)&&(c=(15&u)<<18|(63&o)<<12|(63&i)<<6|63&s)>65535&&c<1114112&&(l=c)}null===l?(l=65533,f=1):l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|1023&l),n.push(l),a+=f}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);for(var r="",n=0;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=4096));return r}(n)}function j(e,t,r){var n="";r=Math.min(e.length,r);for(var a=t;a<r;++a)n+=String.fromCharCode(127&e[a]);return n}function I(e,t,r){var n="";r=Math.min(e.length,r);for(var a=t;a<r;++a)n+=String.fromCharCode(e[a]);return n}function E(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var a="",o=t;o<r;++o)a+=N(e[o]);return a}function D(e,t,r){for(var n=e.slice(t,r),a="",o=0;o<n.length;o+=2)a+=String.fromCharCode(n[o]+256*n[o+1]);return a}function C(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function R(e,t,r,n,a,o){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>a||t<o)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function A(e,t,r,n){t<0&&(t=65535+t+1);for(var a=0,o=Math.min(e.length-r,2);a<o;++a)e[r+a]=(t&255<<8*(n?a:1-a))>>>8*(n?a:1-a)}function T(e,t,r,n){t<0&&(t=4294967295+t+1);for(var a=0,o=Math.min(e.length-r,4);a<o;++a)e[r+a]=t>>>8*(n?a:3-a)&255}function M(e,t,r,n,a,o){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function K(e,t,r,n,o){return o||M(e,0,r,4),a.write(e,t,r,n,23,4),r+4}function L(e,t,r,n,o){return o||M(e,0,r,8),a.write(e,t,r,n,52,8),r+8}t.Buffer=c,t.SlowBuffer=function(e){return+e!=e&&(e=0),c.alloc(+e)},t.INSPECT_MAX_BYTES=50,c.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=i(),c.poolSize=8192,c._augment=function(e){return e.__proto__=c.prototype,e},c.from=function(e,t,r){return u(null,e,t,r)},c.TYPED_ARRAY_SUPPORT&&(c.prototype.__proto__=Uint8Array.prototype,c.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&c[Symbol.species]===c&&Object.defineProperty(c,Symbol.species,{value:null,configurable:!0})),c.alloc=function(e,t,r){return function(e,t,r,n){return l(t),t<=0?s(e,t):void 0!==r?"string"==typeof n?s(e,t).fill(r,n):s(e,t).fill(r):s(e,t)}(null,e,t,r)},c.allocUnsafe=function(e){return f(null,e)},c.allocUnsafeSlow=function(e){return f(null,e)},c.isBuffer=function(e){return!(null==e||!e._isBuffer)},c.compare=function(e,t){if(!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,n=t.length,a=0,o=Math.min(r,n);a<o;++a)if(e[a]!==t[a]){r=e[a],n=t[a];break}return r<n?-1:n<r?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!o(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var n=c.allocUnsafe(t),a=0;for(r=0;r<e.length;++r){var i=e[r];if(!c.isBuffer(i))throw new TypeError('"list" argument must be an Array of Buffers');i.copy(n,a),a+=i.length}return n},c.byteLength=h,c.prototype._isBuffer=!0,c.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)d(this,t,t+1);return this},c.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)d(this,t,t+3),d(this,t+1,t+2);return this},c.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)d(this,t,t+7),d(this,t+1,t+6),d(this,t+2,t+5),d(this,t+3,t+4);return this},c.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?_(this,0,e):v.apply(this,arguments)},c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){var e="",r=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,r).match(/.{2}/g).join(" "),this.length>r&&(e+=" ... ")),"<Buffer "+e+">"},c.prototype.compare=function(e,t,r,n,a){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===a&&(a=this.length),t<0||r>e.length||n<0||a>this.length)throw new RangeError("out of range index");if(n>=a&&t>=r)return 0;if(n>=a)return-1;if(t>=r)return 1;if(this===e)return 0;for(var o=(a>>>=0)-(n>>>=0),i=(r>>>=0)-(t>>>=0),s=Math.min(o,i),u=this.slice(n,a),l=e.slice(t,r),f=0;f<s;++f)if(u[f]!==l[f]){o=u[f],i=l[f];break}return o<i?-1:i<o?1:0},c.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},c.prototype.indexOf=function(e,t,r){return m(this,e,t,r,!0)},c.prototype.lastIndexOf=function(e,t,r){return m(this,e,t,r,!1)},c.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var a=this.length-t;if((void 0===r||r>a)&&(r=a),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return g(this,e,t,r);case"utf8":case"utf-8":return w(this,e,t,r);case"ascii":return k(this,e,t,r);case"latin1":case"binary":return x(this,e,t,r);case"base64":return S(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,e,t,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},c.prototype.slice=function(e,t){var r,n=this.length;if((e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e),c.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=c.prototype;else{var a=t-e;r=new c(a,void 0);for(var o=0;o<a;++o)r[o]=this[o+e]}return r},c.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||C(e,t,this.length);for(var n=this[e],a=1,o=0;++o<t&&(a*=256);)n+=this[e+o]*a;return n},c.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||C(e,t,this.length);for(var n=this[e+--t],a=1;t>0&&(a*=256);)n+=this[e+--t]*a;return n},c.prototype.readUInt8=function(e,t){return t||C(e,1,this.length),this[e]},c.prototype.readUInt16LE=function(e,t){return t||C(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUInt16BE=function(e,t){return t||C(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUInt32LE=function(e,t){return t||C(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUInt32BE=function(e,t){return t||C(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||C(e,t,this.length);for(var n=this[e],a=1,o=0;++o<t&&(a*=256);)n+=this[e+o]*a;return n>=(a*=128)&&(n-=Math.pow(2,8*t)),n},c.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||C(e,t,this.length);for(var n=t,a=1,o=this[e+--n];n>0&&(a*=256);)o+=this[e+--n]*a;return o>=(a*=128)&&(o-=Math.pow(2,8*t)),o},c.prototype.readInt8=function(e,t){return t||C(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){t||C(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt16BE=function(e,t){t||C(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt32LE=function(e,t){return t||C(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return t||C(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readFloatLE=function(e,t){return t||C(e,4,this.length),a.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return t||C(e,4,this.length),a.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return t||C(e,8,this.length),a.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return t||C(e,8,this.length),a.read(this,e,!1,52,8)},c.prototype.writeUIntLE=function(e,t,r,n){e=+e,t|=0,r|=0,n||R(this,e,t,r,Math.pow(2,8*r)-1,0);var a=1,o=0;for(this[t]=255&e;++o<r&&(a*=256);)this[t+o]=e/a&255;return t+r},c.prototype.writeUIntBE=function(e,t,r,n){e=+e,t|=0,r|=0,n||R(this,e,t,r,Math.pow(2,8*r)-1,0);var a=r-1,o=1;for(this[t+a]=255&e;--a>=0&&(o*=256);)this[t+a]=e/o&255;return t+r},c.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,1,255,0),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},c.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):A(this,e,t,!0),t+2},c.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):A(this,e,t,!1),t+2},c.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):T(this,e,t,!0),t+4},c.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):T(this,e,t,!1),t+4},c.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t|=0,!n){var a=Math.pow(2,8*r-1);R(this,e,t,r,a-1,-a)}var o=0,i=1,s=0;for(this[t]=255&e;++o<r&&(i*=256);)e<0&&0===s&&0!==this[t+o-1]&&(s=1),this[t+o]=(e/i>>0)-s&255;return t+r},c.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t|=0,!n){var a=Math.pow(2,8*r-1);R(this,e,t,r,a-1,-a)}var o=r-1,i=1,s=0;for(this[t+o]=255&e;--o>=0&&(i*=256);)e<0&&0===s&&0!==this[t+o+1]&&(s=1),this[t+o]=(e/i>>0)-s&255;return t+r},c.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,1,127,-128),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):A(this,e,t,!0),t+2},c.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):A(this,e,t,!1),t+2},c.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,4,2147483647,-2147483648),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):T(this,e,t,!0),t+4},c.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||R(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):T(this,e,t,!1),t+4},c.prototype.writeFloatLE=function(e,t,r){return K(this,e,t,!0,r)},c.prototype.writeFloatBE=function(e,t,r){return K(this,e,t,!1,r)},c.prototype.writeDoubleLE=function(e,t,r){return L(this,e,t,!0,r)},c.prototype.writeDoubleBE=function(e,t,r){return L(this,e,t,!1,r)},c.prototype.copy=function(e,t,r,n){if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var a,o=n-r;if(this===e&&r<t&&t<n)for(a=o-1;a>=0;--a)e[a+t]=this[a+r];else if(o<1e3||!c.TYPED_ARRAY_SUPPORT)for(a=0;a<o;++a)e[a+t]=this[a+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+o),t);return o},c.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),1===e.length){var a=e.charCodeAt(0);a<256&&(e=a)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!c.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var o;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(o=t;o<r;++o)this[o]=e;else{var i=c.isBuffer(e)?e:U(new c(e,n).toString()),s=i.length;for(o=0;o<r-t;++o)this[o+t]=i[o%s]}return this};var F=/[^+\/0-9A-Za-z-_]/g;function N(e){return e<16?"0"+e.toString(16):e.toString(16)}function U(e,t){var r;t=t||1/0;for(var n=e.length,a=null,o=[],i=0;i<n;++i){if((r=e.charCodeAt(i))>55295&&r<57344){if(!a){if(r>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(i+1===n){(t-=3)>-1&&o.push(239,191,189);continue}a=r;continue}if(r<56320){(t-=3)>-1&&o.push(239,191,189),a=r;continue}r=65536+(a-55296<<10|r-56320)}else a&&(t-=3)>-1&&o.push(239,191,189);if(a=null,r<128){if((t-=1)<0)break;o.push(r)}else if(r<2048){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function B(e){return n.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(F,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function V(e,t,r,n){for(var a=0;a<n&&!(a+r>=t.length||a>=e.length);++a)t[a+r]=e[a];return a}}).call(this,r(3))},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==i(Symbol.iterator)?function(e){return i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":i(e)})(e)}var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":r(window))&&(n=window)}e.exports=n},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){var r={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==r.call(e)}},function(e,t,r){(function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==i(Symbol.iterator)?function(e){return i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":i(e)})(e)}var r=function(e){"use strict";var r=Object.prototype,n=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new S(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function y(){}var h={};h[o]=function(){return this};var v=Object.getPrototypeOf,d=v&&v(v(P([])));d&&d!==r&&n.call(d,o)&&(h=d);var m=y.prototype=f.prototype=Object.create(h);function b(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function g(e,r){var a;this._invoke=function(o,i){function s(){return new r((function(a,s){!function a(o,i,s,c){var l=u(e[o],e,i);if("throw"!==l.type){var f=l.arg,p=f.value;return p&&"object"===t(p)&&n.call(p,"__await")?r.resolve(p.__await).then((function(e){a("next",e,s,c)}),(function(e){a("throw",e,s,c)})):r.resolve(p).then((function(e){f.value=e,s(f)}),(function(e){return a("throw",e,s,c)}))}c(l.arg)}(o,i,a,s)}))}return a=a?a.then(s,s):s()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function P(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,a=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:O}}function O(){return{value:void 0,done:!0}}return p.prototype=m.constructor=y,y.constructor=p,y[s]=p.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},b(g.prototype),g.prototype[i]=function(){return this},e.AsyncIterator=g,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new g(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},b(m),m[s]="Generator",m[o]=function(){return this},m.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=P,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var s=n.call(o,"catchLoc"),c=n.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:P(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}("object"===t(e)?e.exports:{});try{regeneratorRuntime=r}catch(e){Function("r","regeneratorRuntime = r")(r)}}).call(this,r(4)(e))},function(e,t,r){(function(t){var n=r(10).strict;e.exports=function(e){if(n(e)){var r=t.from(e.buffer);return e.byteLength!==e.buffer.byteLength&&(r=r.slice(e.byteOffset,e.byteOffset+e.byteLength)),r}return t.from(e)}}).call(this,r(2).Buffer)},function(e,t,r){"use strict";t.byteLength=function(e){var t=u(e),r=t[0],n=t[1];return 3*(r+n)/4-n},t.toByteArray=function(e){var t,r,n=u(e),i=n[0],s=n[1],c=new o(function(e,t,r){return 3*(t+r)/4-r}(0,i,s)),l=0,f=s>0?i-4:i;for(r=0;r<f;r+=4)t=a[e.charCodeAt(r)]<<18|a[e.charCodeAt(r+1)]<<12|a[e.charCodeAt(r+2)]<<6|a[e.charCodeAt(r+3)],c[l++]=t>>16&255,c[l++]=t>>8&255,c[l++]=255&t;return 2===s&&(t=a[e.charCodeAt(r)]<<2|a[e.charCodeAt(r+1)]>>4,c[l++]=255&t),1===s&&(t=a[e.charCodeAt(r)]<<10|a[e.charCodeAt(r+1)]<<4|a[e.charCodeAt(r+2)]>>2,c[l++]=t>>8&255,c[l++]=255&t),c},t.fromByteArray=function(e){for(var t,r=e.length,a=r%3,o=[],i=0,s=r-a;i<s;i+=16383)o.push(l(e,i,i+16383>s?s:i+16383));return 1===a?(t=e[r-1],o.push(n[t>>2]+n[t<<4&63]+"==")):2===a&&(t=(e[r-2]<<8)+e[r-1],o.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),o.join("")};for(var n=[],a=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,c=i.length;s<c;++s)n[s]=i[s],a[i.charCodeAt(s)]=s;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function l(e,t,r){for(var a,o,i=[],s=t;s<r;s+=3)a=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(255&e[s+2]),i.push(n[(o=a)>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]);return i.join("")}a["-".charCodeAt(0)]=62,a["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,r,n,a){var o,i,s=8*a-n-1,c=(1<<s)-1,u=c>>1,l=-7,f=r?a-1:0,p=r?-1:1,y=e[t+f];for(f+=p,o=y&(1<<-l)-1,y>>=-l,l+=s;l>0;o=256*o+e[t+f],f+=p,l-=8);for(i=o&(1<<-l)-1,o>>=-l,l+=n;l>0;i=256*i+e[t+f],f+=p,l-=8);if(0===o)o=1-u;else{if(o===c)return i?NaN:1/0*(y?-1:1);i+=Math.pow(2,n),o-=u}return(y?-1:1)*i*Math.pow(2,o-n)},t.write=function(e,t,r,n,a,o){var i,s,c,u=8*o-a-1,l=(1<<u)-1,f=l>>1,p=23===a?Math.pow(2,-24)-Math.pow(2,-77):0,y=n?0:o-1,h=n?1:-1,v=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,i=l):(i=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-i))<1&&(i--,c*=2),(t+=i+f>=1?p/c:p*Math.pow(2,1-f))*c>=2&&(i++,c/=2),i+f>=l?(s=0,i=l):i+f>=1?(s=(t*c-1)*Math.pow(2,a),i+=f):(s=t*Math.pow(2,f-1)*Math.pow(2,a),i=0));a>=8;e[r+y]=255&s,y+=h,s/=256,a-=8);for(i=i<<a|s,u+=a;u>0;e[r+y]=255&i,y+=h,i/=256,u-=8);e[r+y-h]|=128*v}},function(e,t){e.exports=a,a.strict=o,a.loose=i;var r=Object.prototype.toString,n={"[object Int8Array]":!0,"[object Int16Array]":!0,"[object Int32Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Uint16Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0};function a(e){return o(e)||i(e)}function o(e){return e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array}function i(e){return n[r.call(e)]}},function(e,t,r){"use strict";r.r(t),r.d(t,"SNPureCrypto",(function(){return u})),r.d(t,"SNWebCrypto",(function(){return x})),r.d(t,"isWebCryptoAvailable",(function(){return o.o})),r.d(t,"Buffer",(function(){return o.a})),r.d(t,"base64Encode",(function(){return o.f})),r.d(t,"base64Decode",(function(){return o.e})),r.d(t,"base64ToHex",(function(){return o.h})),r.d(t,"hexToBase64",(function(){return o.m}));var n=r(0),a=r.n(n),o=r(1);function s(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n,i;return t=e,(r=[{key:"generateUUIDSync",value:function(){return Object(o.i)()}},{key:"generateUUID",value:(n=a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(o.i)());case 1:case"end":return e.stop()}}),e)})),i=function(){var e=this,t=arguments;return new Promise((function(r,a){var o=n.apply(e,t);function i(e){s(o,r,a,i,c,"next",e)}function c(e){s(o,r,a,i,c,"throw",e)}i(void 0)}))},function(){return i.apply(this,arguments)})},{key:"timingSafeEqual",value:function(e,t){var r=String(e),n=String(t),a=r.length,o=0;a!==n.length&&(n=r,o=1);for(var i=0;i<a;i++)o|=r.charCodeAt(i)^n.charCodeAt(i);return 0===o}}])&&c(t.prototype,r),e}();function l(e){return(l="function"==typeof Symbol&&"symbol"==i(Symbol.iterator)?function(e){return i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":i(e)})(e)}function f(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function p(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){f(o,n,a,i,s,"next",e)}function s(e){f(o,n,a,i,s,"throw",e)}i(void 0)}))}}function y(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t){return!t||"object"!==l(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function v(e){return(v=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var m=o.k(),b="AES-CBC",g="SHA-256",w="PBKDF2",k="HMAC",x=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=h(this,v(t).call(this))).ready=Promise.all([r.e(3),r.e(0)]).then(r.bind(null,168)).then((function(t){return e.sodium=t,e.sodium.ready})),e}var n,i,s,c,u,l,f,x,S,P,O,_,j,I;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}(t,e),n=t,(i=[{key:"pbkdf2",value:(I=p(a.a.mark((function e(t,r,n,o){var i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.webCryptoImportKey(t,w,["deriveBits"]);case 2:if(i=e.sent){e.next=6;break}return console.error("Key is null, unable to continue"),e.abrupt("return",null);case 6:return e.abrupt("return",this.webCryptoDeriveBits(i,r,n,o));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return I.apply(this,arguments)})},{key:"generateRandomKey",value:(j=p(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t/8,n=o.j().crypto.getRandomValues(new Uint8Array(r)),e.abrupt("return",o.c(n));case 3:case"end":return e.stop()}}),e)}))),function(e){return j.apply(this,arguments)})},{key:"aes256CbcEncrypt",value:(_=p(a.a.mark((function e(t,r,n){var i,s,c,u,l,f,p;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.l(n);case 2:return i=e.sent,e.next=5,o.l(r);case 5:return s=e.sent,c={name:b,iv:s},e.next=9,this.webCryptoImportKey(i,c.name,["encrypt"]);case 9:return u=e.sent,e.next=12,o.p(t);case 12:return l=e.sent,e.next=15,crypto.subtle.encrypt(c,u,l);case 15:return f=e.sent,e.next=18,o.b(f);case 18:return p=e.sent,e.abrupt("return",p);case 20:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return _.apply(this,arguments)})},{key:"aes256CbcDecrypt",value:(O=p(a.a.mark((function e(t,r,n){var i,s,c,u,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.l(n);case 2:return i=e.sent,e.next=5,o.l(r);case 5:return s=e.sent,c={name:b,iv:s},e.next=9,this.webCryptoImportKey(i,c.name,["decrypt"]);case 9:return u=e.sent,e.next=12,o.g(t);case 12:return l=e.sent,e.abrupt("return",crypto.subtle.decrypt(c,u,l).then(function(){var e=p(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",o.d(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){return console.error("Error performing AES-CBC decryption:",e),null})));case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return O.apply(this,arguments)})},{key:"hmac256",value:(P=p(a.a.mark((function e(t,r){var n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.l(r);case 2:return n=e.sent,e.next=5,this.webCryptoImportKey(n,k,["sign"],{name:g});case 5:return i=e.sent,e.next=8,o.p(t);case 8:return s=e.sent,e.abrupt("return",crypto.subtle.sign({name:k},i,s).then((function(e){return o.c(e)})).catch((function(e){return console.error("Error computing HMAC:",e),null})));case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return P.apply(this,arguments)})},{key:"sha256",value:(S=p(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.p(t);case 2:return r=e.sent,e.next=5,crypto.subtle.digest(g,r);case 5:return n=e.sent,e.abrupt("return",o.c(n));case 7:case"end":return e.stop()}}),e)}))),function(e){return S.apply(this,arguments)})},{key:"unsafeSha1",value:(x=p(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.p(t);case 2:return r=e.sent,e.next=5,crypto.subtle.digest("SHA-1",r);case 5:return n=e.sent,e.abrupt("return",o.c(n));case 7:case"end":return e.stop()}}),e)}))),function(e){return x.apply(this,arguments)})},{key:"webCryptoImportKey",value:(f=p(a.a.mark((function e(t,r,n,i){var s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!o.n(t)){e.next=6;break}return e.next=3,o.p(t);case 3:e.t0=e.sent,e.next=7;break;case 6:e.t0=t;case 7:return s=e.t0,e.abrupt("return",m.importKey("raw",s,{name:r,hash:i},!1,n).then((function(e){return e})).catch((function(e){return console.error(e),null})));case 9:case"end":return e.stop()}}),e)}))),function(e,t,r,n){return f.apply(this,arguments)})},{key:"webCryptoDeriveBits",value:(l=p(a.a.mark((function e(t,r,n,i){var s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=w,e.next=3,o.p(r);case 3:return e.t1=e.sent,e.t2=n,e.t3={name:"SHA-512"},s={name:e.t0,salt:e.t1,iterations:e.t2,hash:e.t3},e.abrupt("return",m.deriveBits(s,t,i).then((function(e){return o.c(new Uint8Array(e))})).catch((function(e){return console.error(e),null})));case 8:case"end":return e.stop()}}),e)}))),function(e,t,r,n){return l.apply(this,arguments)})},{key:"argon2",value:(u=p(a.a.mark((function e(t,r,n,i,s){var c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready;case 2:return e.t0=this.sodium,e.t1=s,e.next=6,o.q(t,"binary");case 6:return e.t2=e.sent,e.next=9,o.q(r,"hex");case 9:return e.t3=e.sent,e.t4=n,e.t5=i,e.t6=this.sodium.crypto_pwhash_ALG_DEFAULT,c=e.t0.crypto_pwhash.call(e.t0,e.t1,e.t2,e.t3,e.t4,e.t5,e.t6,"hex"),e.abrupt("return",c);case 15:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a){return u.apply(this,arguments)})},{key:"xchacha20Encrypt",value:(c=p(a.a.mark((function e(t,r,n,i){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready;case 2:if(48===r.length){e.next=4;break}throw"Nonce must be 24 bytes";case 4:return e.t0=this.sodium,e.next=7,o.q(t);case 7:return e.t1=e.sent,e.next=10,o.q(i);case 10:return e.t2=e.sent,e.next=13,o.q(r,"hex");case 13:return e.t3=e.sent,e.next=16,o.q(n,"hex");case 16:return e.t4=e.sent,e.abrupt("return",e.t0.crypto_aead_xchacha20poly1305_ietf_encrypt.call(e.t0,e.t1,e.t2,null,e.t3,e.t4,"base64"));case 18:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return c.apply(this,arguments)})},{key:"xchacha20Decrypt",value:(s=p(a.a.mark((function e(t,r,n,i){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready;case 2:if(48===r.length){e.next=4;break}throw"Nonce must be 24 bytes";case 4:return e.prev=4,e.t0=this.sodium,e.next=8,o.q(t,"base64");case 8:return e.t1=e.sent,e.next=11,o.q(i);case 11:return e.t2=e.sent,e.next=14,o.q(r,"hex");case 14:return e.t3=e.sent,e.next=17,o.q(n,"hex");case 17:return e.t4=e.sent,e.abrupt("return",e.t0.crypto_aead_xchacha20poly1305_ietf_decrypt.call(e.t0,null,e.t1,e.t2,e.t3,e.t4,"text"));case 21:return e.prev=21,e.t5=e.catch(4),e.abrupt("return",null);case 24:case"end":return e.stop()}}),e,this,[[4,21]])}))),function(e,t,r,n){return s.apply(this,arguments)})}])&&y(n.prototype,i),t}(u)}])},"object"==i(t)&&"object"==i(e)?e.exports=o():(n=[],void 0===(a="function"==typeof(r=o)?r.apply(t,n):r)||(e.exports=a))}).call(this,r(16)(e))},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(56),o="object"==("undefined"==typeof self?"undefined":n(self))&&self&&self.Object===Object&&self,i=a||o||Function("return this")();e.exports=i},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=r(e);return null!=e&&("object"==t||"function"==t)}},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){return null!=e&&"object"==r(e)}},function(e,t,r){var n=r(105),a=r(110);e.exports=function(e,t){var r=a(e,t);return n(r)?r:void 0}},function(e,t,r){var n=r(37),a=r(44);e.exports=function(e){return null!=e&&a(e.length)&&!n(e)}},function(e,t,r){var n=r(13),a=r(106),o=r(107),i=n?n.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?a(e):o(e)}},function(e,t,r){var n=r(7).Symbol;e.exports=n},function(e,t,r){var n=r(68),a=r(39);e.exports=function(e,t,r,o){var i=!r;r||(r={});for(var s=-1,c=t.length;++s<c;){var u=t[s],l=o?o(r[u],e[u],u,r,e):void 0;void 0===l&&(l=e[u]),i?a(r,u,l):n(r,u,l)}return r}},function(e,t,r){var n=r(69),a=r(155),o=r(11);e.exports=function(e){return o(e)?n(e):a(e)}},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){e.exports=function(e,t){return e===t||e!=e&&t!=t}},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(147),o=r(161),i=r(47),s=r(4),c=r(171);e.exports=function(e){return"function"==typeof e?e:null==e?i:"object"==n(e)?s(e)?o(e[0],e[1]):a(e):c(e)}},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(12),o=r(9);e.exports=function(e){return"symbol"==n(e)||o(e)&&"[object Symbol]"==a(e)}},function(e,t,r){var n=r(19);e.exports=function(e){if("string"==typeof e||n(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(e,t,r){var n=r(74);e.exports=function(e){return e&&e.length?n(e):[]}},function(e,t,r){var n=r(23),a=r(100),o=r(101),i=r(102),s=r(103),c=r(104);function u(e){var t=this.__data__=new n(e);this.size=t.size}u.prototype.clear=a,u.prototype.delete=o,u.prototype.get=i,u.prototype.has=s,u.prototype.set=c,e.exports=u},function(e,t,r){var n=r(95),a=r(96),o=r(97),i=r(98),s=r(99);function c(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}c.prototype.clear=n,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,r){var n=r(17);e.exports=function(e,t){for(var r=e.length;r--;)if(n(e[r][0],t))return r;return-1}},function(e,t,r){var n=r(10)(Object,"create");e.exports=n},function(e,t,r){var n=r(119);e.exports=function(e,t){var r=e.__data__;return n(t)?r["string"==typeof t?"string":"hash"]:r.map}},function(e,t,r){var n=r(126),a=r(9),o=Object.prototype,i=o.hasOwnProperty,s=o.propertyIsEnumerable,c=n(function(){return arguments}())?n:function(e){return a(e)&&i.call(e,"callee")&&!s.call(e,"callee")};e.exports=c},function(e,t,r){(function(e){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(7),o=r(128),i="object"==n(t)&&t&&!t.nodeType&&t,s=i&&"object"==n(e)&&e&&!e.nodeType&&e,c=s&&s.exports===i?a.Buffer:void 0,u=(c?c.isBuffer:void 0)||o;e.exports=u}).call(this,r(16)(e))},function(e,t){e.exports=function(e){return function(t){return e(t)}}},function(e,t,r){var n=r(69),a=r(132),o=r(11);e.exports=function(e){return o(e)?n(e,!0):a(e)}},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n=/^(?:0|[1-9]\d*)$/;e.exports=function(e,t){var a=r(e);return!!(t=null==t?9007199254740991:t)&&("number"==a||"symbol"!=a&&n.test(e))&&e>-1&&e%1==0&&e<t}},function(e,t){e.exports=function(e,t){for(var r=-1,n=null==e?0:e.length,a=Array(n);++r<n;)a[r]=t(e[r],r,e);return a}},function(e,t,r){var n=r(157),a=r(36),o=r(158),i=r(79),s=r(159),c=r(12),u=r(57),l=u(n),f=u(a),p=u(o),y=u(i),h=u(s),v=c;(n&&"[object DataView]"!=v(new n(new ArrayBuffer(1)))||a&&"[object Map]"!=v(new a)||o&&"[object Promise]"!=v(o.resolve())||i&&"[object Set]"!=v(new i)||s&&"[object WeakMap]"!=v(new s))&&(v=function(e){var t=c(e),r="[object Object]"==t?e.constructor:void 0,n=r?u(r):"";if(n)switch(n){case l:return"[object DataView]";case f:return"[object Map]";case p:return"[object Promise]";case y:return"[object Set]";case h:return"[object WeakMap]"}return t}),e.exports=v},function(e,t,r){var n=r(4),a=r(52),o=r(163),i=r(166);e.exports=function(e,t){return n(e)?e:a(e,t)?[e]:o(i(e))}},function(e,t,r){var n=r(55),a=r(70)((function(e,t,r){n(e,t,r)}));e.exports=a},function(e,t,r){var n=r(10)(r(7),"Map");e.exports=n},function(e,t,r){var n=r(12),a=r(8);e.exports=function(e){if(!a(e))return!1;var t=n(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},function(e,t,r){var n=r(111),a=r(118),o=r(120),i=r(121),s=r(122);function c(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}c.prototype.clear=n,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,r){var n=r(59);e.exports=function(e,t,r){"__proto__"==t&&n?n(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}},function(e,t,r){var n=r(63);e.exports=function(e){var t=new e.constructor(e.byteLength);return new n(t).set(new n(e)),t}},function(e,t){e.exports=function(e,t){var r=-1,n=e.length;for(t||(t=Array(n));++r<n;)t[r]=e[r];return t}},function(e,t,r){var n=r(65)(Object.getPrototypeOf,Object);e.exports=n},function(e,t){var r=Object.prototype;e.exports=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||r)}},function(e,t){e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},function(e,t,r){var n=r(129),a=r(29),o=r(46),i=o&&o.isTypedArray,s=i?a(i):n;e.exports=s},function(e,t,r){(function(e){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(56),o="object"==n(t)&&t&&!t.nodeType&&t,i=o&&"object"==n(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o&&a.process,c=function(){try{var e=i&&i.require&&i.require("util").types;return e||s&&s.binding&&s.binding("util")}catch(e){}}();e.exports=c}).call(this,r(16)(e))},function(e,t){e.exports=function(e){return e}},function(e,t){e.exports=function(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r}},function(e,t){e.exports=function(e,t){for(var r=-1,n=t.length,a=e.length;++r<n;)e[a+r]=t[r];return e}},function(e,t,r){var n=r(154),a=r(84),o=Object.prototype.propertyIsEnumerable,i=Object.getOwnPropertySymbols,s=i?function(e){return null==e?[]:(e=Object(e),n(i(e),(function(t){return o.call(e,t)})))}:a;e.exports=s},function(e,t,r){var n=r(34),a=r(20);e.exports=function(e,t){for(var r=0,o=(t=n(t,e)).length;null!=e&&r<o;)e=e[a(t[r++])];return r&&r==o?e:void 0}},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(4),o=r(19),i=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,s=/^\w*$/;e.exports=function(e,t){if(a(e))return!1;var r=n(e);return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!o(e))||(s.test(e)||!i.test(e)||null!=t&&e in Object(t))}},function(e,t,r){var n=r(18),a=r(210);e.exports=function(e,t,r){return a(e,t,n(r,2))}},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":r(window))&&(n=window)}e.exports=n},function(e,t,r){var n=r(22),a=r(58),o=r(60),i=r(124),s=r(8),c=r(30),u=r(67);e.exports=function e(t,r,l,f,p){t!==r&&o(r,(function(o,c){if(p||(p=new n),s(o))i(t,r,c,l,e,f,p);else{var y=f?f(u(t,c),o,c+"",t,r,p):void 0;void 0===y&&(y=o),a(t,c,y)}}),c)}},function(e,t,r){(function(t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n="object"==(void 0===t?"undefined":r(t))&&t&&t.Object===Object&&t;e.exports=n}).call(this,r(54))},function(e,t){var r=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return r.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},function(e,t,r){var n=r(39),a=r(17);e.exports=function(e,t,r){(void 0===r||a(e[t],r))&&(void 0!==r||t in e)||n(e,t,r)}},function(e,t,r){var n=r(10),a=function(){try{var e=n(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=a},function(e,t,r){var n=r(123)();e.exports=n},function(e,t,r){(function(e){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(7),o="object"==n(t)&&t&&!t.nodeType&&t,i=o&&"object"==n(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o?a.Buffer:void 0,c=s?s.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var r=e.length,n=c?c(r):new e.constructor(r);return e.copy(n),n}}).call(this,r(16)(e))},function(e,t,r){var n=r(40);e.exports=function(e,t){var r=t?n(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}},function(e,t,r){var n=r(7).Uint8Array;e.exports=n},function(e,t,r){var n=r(125),a=r(42),o=r(43);e.exports=function(e){return"function"!=typeof e.constructor||o(e)?{}:n(a(e))}},function(e,t){e.exports=function(e,t){return function(r){return e(t(r))}}},function(e,t,r){var n=r(12),a=r(42),o=r(9),i=Function.prototype,s=Object.prototype,c=i.toString,u=s.hasOwnProperty,l=c.call(Object);e.exports=function(e){if(!o(e)||"[object Object]"!=n(e))return!1;var t=a(e);if(null===t)return!0;var r=u.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&c.call(r)==l}},function(e,t){e.exports=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}},function(e,t,r){var n=r(39),a=r(17),o=Object.prototype.hasOwnProperty;e.exports=function(e,t,r){var i=e[t];o.call(e,t)&&a(i,r)&&(void 0!==r||t in e)||n(e,t,r)}},function(e,t,r){var n=r(131),a=r(27),o=r(4),i=r(28),s=r(31),c=r(45),u=Object.prototype.hasOwnProperty;e.exports=function(e,t){var r=o(e),l=!r&&a(e),f=!r&&!l&&i(e),p=!r&&!l&&!f&&c(e),y=r||l||f||p,h=y?n(e.length,String):[],v=h.length;for(var d in e)!t&&!u.call(e,d)||y&&("length"==d||f&&("offset"==d||"parent"==d)||p&&("buffer"==d||"byteLength"==d||"byteOffset"==d)||s(d,v))||h.push(d);return h}},function(e,t,r){var n=r(71),a=r(138);e.exports=function(e){return n((function(t,r){var n=-1,o=r.length,i=o>1?r[o-1]:void 0,s=o>2?r[2]:void 0;for(i=e.length>3&&"function"==typeof i?(o--,i):void 0,s&&a(r[0],r[1],s)&&(i=o<3?void 0:i,o=1),t=Object(t);++n<o;){var c=r[n];c&&e(t,c,n,i)}return t}))}},function(e,t,r){var n=r(47),a=r(72),o=r(73);e.exports=function(e,t){return o(a(e,t,n),e+"")}},function(e,t,r){var n=r(134),a=Math.max;e.exports=function(e,t,r){return t=a(void 0===t?e.length-1:t,0),function(){for(var o=arguments,i=-1,s=a(o.length-t,0),c=Array(s);++i<s;)c[i]=o[t+i];i=-1;for(var u=Array(t+1);++i<t;)u[i]=o[i];return u[t]=r(c),n(e,this,u)}}},function(e,t,r){var n=r(135),a=r(137)(n);e.exports=a},function(e,t,r){var n=r(75),a=r(141),o=r(144),i=r(78),s=r(145),c=r(48);e.exports=function(e,t,r){var u=-1,l=a,f=e.length,p=!0,y=[],h=y;if(r)p=!1,l=o;else if(f>=200){var v=t?null:s(e);if(v)return c(v);p=!1,l=i,h=new n}else h=t?[]:y;e:for(;++u<f;){var d=e[u],m=t?t(d):d;if(d=r||0!==d?d:0,p&&m==m){for(var b=h.length;b--;)if(h[b]===m)continue e;t&&h.push(m),y.push(d)}else l(h,m,r)||(h!==y&&h.push(m),y.push(d))}return y}},function(e,t,r){var n=r(38),a=r(139),o=r(140);function i(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new n;++t<r;)this.add(e[t])}i.prototype.add=i.prototype.push=a,i.prototype.has=o,e.exports=i},function(e,t,r){var n=r(77),a=r(142),o=r(143);e.exports=function(e,t,r){return t==t?o(e,t,r):n(e,a,r)}},function(e,t){e.exports=function(e,t,r,n){for(var a=e.length,o=r+(n?1:-1);n?o--:++o<a;)if(t(e[o],o,e))return o;return-1}},function(e,t){e.exports=function(e,t){return e.has(t)}},function(e,t,r){var n=r(10)(r(7),"Set");e.exports=n},function(e,t,r){var n=r(149),a=r(9);e.exports=function e(t,r,o,i,s){return t===r||(null==t||null==r||!a(t)&&!a(r)?t!=t&&r!=r:n(t,r,o,i,e,s))}},function(e,t,r){var n=r(75),a=r(150),o=r(78);e.exports=function(e,t,r,i,s,c){var u=1&r,l=e.length,f=t.length;if(l!=f&&!(u&&f>l))return!1;var p=c.get(e);if(p&&c.get(t))return p==t;var y=-1,h=!0,v=2&r?new n:void 0;for(c.set(e,t),c.set(t,e);++y<l;){var d=e[y],m=t[y];if(i)var b=u?i(m,d,y,t,e,c):i(d,m,y,e,t,c);if(void 0!==b){if(b)continue;h=!1;break}if(v){if(!a(t,(function(e,t){if(!o(v,t)&&(d===e||s(d,e,r,i,c)))return v.push(t)}))){h=!1;break}}else if(d!==m&&!s(d,m,r,i,c)){h=!1;break}}return c.delete(e),c.delete(t),h}},function(e,t,r){var n=r(83),a=r(50),o=r(15);e.exports=function(e){return n(e,o,a)}},function(e,t,r){var n=r(49),a=r(4);e.exports=function(e,t,r){var o=t(e);return a(e)?o:n(o,r(e))}},function(e,t){e.exports=function(){return[]}},function(e,t,r){var n=r(8);e.exports=function(e){return e==e&&!n(e)}},function(e,t){e.exports=function(e,t){return function(r){return null!=r&&(r[e]===t&&(void 0!==t||e in Object(r)))}}},function(e,t,r){var n=r(34),a=r(187),o=r(188),i=r(20);e.exports=function(e,t){return t=n(t,e),null==(e=o(e,t))||delete e[i(a(t))]}},function(e,t,r){var n=r(49),a=r(42),o=r(50),i=r(84),s=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)n(t,o(e)),e=a(e);return t}:i;e.exports=s},function(e,t,r){var n=r(83),a=r(88),o=r(30);e.exports=function(e){return n(e,o,a)}},function(e,t,r){var n=r(55),a=r(70)((function(e,t,r,a){n(e,t,r,a)}));e.exports=a},function(e,t,r){var n=r(74);e.exports=function(e,t){return t="function"==typeof t?t:void 0,e&&e.length?n(e,void 0,t):[]}},function(e,t,r){var n=r(32),a=r(18),o=r(174),i=r(4);e.exports=function(e,t){return(i(e)?n:o)(e,a(t,3))}},function(e,t,r){var n=r(32),a=r(190),o=r(87),i=r(34),s=r(14),c=r(205),u=r(206),l=r(89),f=u((function(e,t){var r={};if(null==e)return r;var u=!1;t=n(t,(function(t){return t=i(t,e),u||(u=t.length>1),t})),s(e,l(e),r),u&&(r=a(r,7,c));for(var f=t.length;f--;)o(r,t[f]);return r}));e.exports=f},function(e,t,r){(function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r=function(e){"use strict";var r=Object.prototype,n=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new S(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return O()}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function y(){}var h={};h[o]=function(){return this};var v=Object.getPrototypeOf,d=v&&v(v(P([])));d&&d!==r&&n.call(d,o)&&(h=d);var m=y.prototype=f.prototype=Object.create(h);function b(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function g(e,r){var a;this._invoke=function(o,i){function s(){return new r((function(a,s){!function a(o,i,s,c){var l=u(e[o],e,i);if("throw"!==l.type){var f=l.arg,p=f.value;return p&&"object"===t(p)&&n.call(p,"__await")?r.resolve(p.__await).then((function(e){a("next",e,s,c)}),(function(e){a("throw",e,s,c)})):r.resolve(p).then((function(e){f.value=e,s(f)}),(function(e){return a("throw",e,s,c)}))}c(l.arg)}(o,i,a,s)}))}return a=a?a.then(s,s):s()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function P(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,a=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:O}}function O(){return{value:void 0,done:!0}}return p.prototype=m.constructor=y,y.constructor=p,y[s]=p.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},b(g.prototype),g.prototype[i]=function(){return this},e.AsyncIterator=g,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new g(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},b(m),m[s]="Generator",m[o]=function(){return this},m.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=P,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var s=n.call(o,"catchLoc"),c=n.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:P(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}("object"===t(e)?e.exports:{});try{regeneratorRuntime=r}catch(e){Function("r","regeneratorRuntime = r")(r)}}).call(this,r(16)(e))},function(e,t){e.exports=function(){this.__data__=[],this.size=0}},function(e,t,r){var n=r(24),a=Array.prototype.splice;e.exports=function(e){var t=this.__data__,r=n(t,e);return!(r<0)&&(r==t.length-1?t.pop():a.call(t,r,1),--this.size,!0)}},function(e,t,r){var n=r(24);e.exports=function(e){var t=this.__data__,r=n(t,e);return r<0?void 0:t[r][1]}},function(e,t,r){var n=r(24);e.exports=function(e){return n(this.__data__,e)>-1}},function(e,t,r){var n=r(24);e.exports=function(e,t){var r=this.__data__,a=n(r,e);return a<0?(++this.size,r.push([e,t])):r[a][1]=t,this}},function(e,t,r){var n=r(23);e.exports=function(){this.__data__=new n,this.size=0}},function(e,t){e.exports=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r}},function(e,t){e.exports=function(e){return this.__data__.get(e)}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t,r){var n=r(23),a=r(36),o=r(38);e.exports=function(e,t){var r=this.__data__;if(r instanceof n){var i=r.__data__;if(!a||i.length<199)return i.push([e,t]),this.size=++r.size,this;r=this.__data__=new o(i)}return r.set(e,t),this.size=r.size,this}},function(e,t,r){var n=r(37),a=r(108),o=r(8),i=r(57),s=/^\[object .+?Constructor\]$/,c=Function.prototype,u=Object.prototype,l=c.toString,f=u.hasOwnProperty,p=RegExp("^"+l.call(f).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!o(e)||a(e))&&(n(e)?p:s).test(i(e))}},function(e,t,r){var n=r(13),a=Object.prototype,o=a.hasOwnProperty,i=a.toString,s=n?n.toStringTag:void 0;e.exports=function(e){var t=o.call(e,s),r=e[s];try{e[s]=void 0;var n=!0}catch(e){}var a=i.call(e);return n&&(t?e[s]=r:delete e[s]),a}},function(e,t){var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},function(e,t,r){var n,a=r(109),o=(n=/[^.]+$/.exec(a&&a.keys&&a.keys.IE_PROTO||""))?"Symbol(src)_1."+n:"";e.exports=function(e){return!!o&&o in e}},function(e,t,r){var n=r(7)["__core-js_shared__"];e.exports=n},function(e,t){e.exports=function(e,t){return null==e?void 0:e[t]}},function(e,t,r){var n=r(112),a=r(23),o=r(36);e.exports=function(){this.size=0,this.__data__={hash:new n,map:new(o||a),string:new n}}},function(e,t,r){var n=r(113),a=r(114),o=r(115),i=r(116),s=r(117);function c(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}c.prototype.clear=n,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,r){var n=r(25);e.exports=function(){this.__data__=n?n(null):{},this.size=0}},function(e,t){e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},function(e,t,r){var n=r(25),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(n){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return a.call(t,e)?t[e]:void 0}},function(e,t,r){var n=r(25),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return n?void 0!==t[e]:a.call(t,e)}},function(e,t,r){var n=r(25);e.exports=function(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=n&&void 0===t?"__lodash_hash_undefined__":t,this}},function(e,t,r){var n=r(26);e.exports=function(e){var t=n(this,e).delete(e);return this.size-=t?1:0,t}},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=r(e);return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},function(e,t,r){var n=r(26);e.exports=function(e){return n(this,e).get(e)}},function(e,t,r){var n=r(26);e.exports=function(e){return n(this,e).has(e)}},function(e,t,r){var n=r(26);e.exports=function(e,t){var r=n(this,e),a=r.size;return r.set(e,t),this.size+=r.size==a?0:1,this}},function(e,t){e.exports=function(e){return function(t,r,n){for(var a=-1,o=Object(t),i=n(t),s=i.length;s--;){var c=i[e?s:++a];if(!1===r(o[c],c,o))break}return t}}},function(e,t,r){var n=r(58),a=r(61),o=r(62),i=r(41),s=r(64),c=r(27),u=r(4),l=r(127),f=r(28),p=r(37),y=r(8),h=r(66),v=r(45),d=r(67),m=r(130);e.exports=function(e,t,r,b,g,w,k){var x=d(e,r),S=d(t,r),P=k.get(S);if(P)n(e,r,P);else{var O=w?w(x,S,r+"",e,t,k):void 0,_=void 0===O;if(_){var j=u(S),I=!j&&f(S),E=!j&&!I&&v(S);O=S,j||I||E?u(x)?O=x:l(x)?O=i(x):I?(_=!1,O=a(S,!0)):E?(_=!1,O=o(S,!0)):O=[]:h(S)||c(S)?(O=x,c(x)?O=m(x):y(x)&&!p(x)||(O=s(S))):_=!1}_&&(k.set(S,O),g(O,S,b,w,k),k.delete(S)),n(e,r,O)}}},function(e,t,r){var n=r(8),a=Object.create,o=function(){function e(){}return function(t){if(!n(t))return{};if(a)return a(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}();e.exports=o},function(e,t,r){var n=r(12),a=r(9);e.exports=function(e){return a(e)&&"[object Arguments]"==n(e)}},function(e,t,r){var n=r(11),a=r(9);e.exports=function(e){return a(e)&&n(e)}},function(e,t){e.exports=function(){return!1}},function(e,t,r){var n=r(12),a=r(44),o=r(9),i={};i["[object Float32Array]"]=i["[object Float64Array]"]=i["[object Int8Array]"]=i["[object Int16Array]"]=i["[object Int32Array]"]=i["[object Uint8Array]"]=i["[object Uint8ClampedArray]"]=i["[object Uint16Array]"]=i["[object Uint32Array]"]=!0,i["[object Arguments]"]=i["[object Array]"]=i["[object ArrayBuffer]"]=i["[object Boolean]"]=i["[object DataView]"]=i["[object Date]"]=i["[object Error]"]=i["[object Function]"]=i["[object Map]"]=i["[object Number]"]=i["[object Object]"]=i["[object RegExp]"]=i["[object Set]"]=i["[object String]"]=i["[object WeakMap]"]=!1,e.exports=function(e){return o(e)&&a(e.length)&&!!i[n(e)]}},function(e,t,r){var n=r(14),a=r(30);e.exports=function(e){return n(e,a(e))}},function(e,t){e.exports=function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}},function(e,t,r){var n=r(8),a=r(43),o=r(133),i=Object.prototype.hasOwnProperty;e.exports=function(e){if(!n(e))return o(e);var t=a(e),r=[];for(var s in e)("constructor"!=s||!t&&i.call(e,s))&&r.push(s);return r}},function(e,t){e.exports=function(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t}},function(e,t){e.exports=function(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)}},function(e,t,r){var n=r(136),a=r(59),o=r(47),i=a?function(e,t){return a(e,"toString",{configurable:!0,enumerable:!1,value:n(t),writable:!0})}:o;e.exports=i},function(e,t){e.exports=function(e){return function(){return e}}},function(e,t){var r=Date.now;e.exports=function(e){var t=0,n=0;return function(){var a=r(),o=16-(a-n);if(n=a,o>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}},function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=r(17),o=r(11),i=r(31),s=r(8);e.exports=function(e,t,r){if(!s(r))return!1;var c=n(t);return!!("number"==c?o(r)&&i(t,r.length):"string"==c&&t in r)&&a(r[t],e)}},function(e,t){e.exports=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t,r){var n=r(76);e.exports=function(e,t){return!!(null==e?0:e.length)&&n(e,t,0)>-1}},function(e,t){e.exports=function(e){return e!=e}},function(e,t){e.exports=function(e,t,r){for(var n=r-1,a=e.length;++n<a;)if(e[n]===t)return n;return-1}},function(e,t){e.exports=function(e,t,r){for(var n=-1,a=null==e?0:e.length;++n<a;)if(r(t,e[n]))return!0;return!1}},function(e,t,r){var n=r(79),a=r(146),o=r(48),i=n&&1/o(new n([,-0]))[1]==1/0?function(e){return new n(e)}:a;e.exports=i},function(e,t){e.exports=function(){}},function(e,t,r){var n=r(148),a=r(160),o=r(86);e.exports=function(e){var t=a(e);return 1==t.length&&t[0][2]?o(t[0][0],t[0][1]):function(r){return r===e||n(r,e,t)}}},function(e,t,r){var n=r(22),a=r(80);e.exports=function(e,t,r,o){var i=r.length,s=i,c=!o;if(null==e)return!s;for(e=Object(e);i--;){var u=r[i];if(c&&u[2]?u[1]!==e[u[0]]:!(u[0]in e))return!1}for(;++i<s;){var l=(u=r[i])[0],f=e[l],p=u[1];if(c&&u[2]){if(void 0===f&&!(l in e))return!1}else{var y=new n;if(o)var h=o(f,p,l,e,t,y);if(!(void 0===h?a(p,f,3,o,y):h))return!1}}return!0}},function(e,t,r){var n=r(22),a=r(81),o=r(151),i=r(153),s=r(33),c=r(4),u=r(28),l=r(45),f="[object Object]",p=Object.prototype.hasOwnProperty;e.exports=function(e,t,r,y,h,v){var d=c(e),m=c(t),b=d?"[object Array]":s(e),g=m?"[object Array]":s(t),w=(b="[object Arguments]"==b?f:b)==f,k=(g="[object Arguments]"==g?f:g)==f,x=b==g;if(x&&u(e)){if(!u(t))return!1;d=!0,w=!1}if(x&&!w)return v||(v=new n),d||l(e)?a(e,t,r,y,h,v):o(e,t,b,r,y,h,v);if(!(1&r)){var S=w&&p.call(e,"__wrapped__"),P=k&&p.call(t,"__wrapped__");if(S||P){var O=S?e.value():e,_=P?t.value():t;return v||(v=new n),h(O,_,r,y,v)}}return!!x&&(v||(v=new n),i(e,t,r,y,h,v))}},function(e,t){e.exports=function(e,t){for(var r=-1,n=null==e?0:e.length;++r<n;)if(t(e[r],r,e))return!0;return!1}},function(e,t,r){var n=r(13),a=r(63),o=r(17),i=r(81),s=r(152),c=r(48),u=n?n.prototype:void 0,l=u?u.valueOf:void 0;e.exports=function(e,t,r,n,u,f,p){switch(r){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!f(new a(e),new a(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return o(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var y=s;case"[object Set]":var h=1&n;if(y||(y=c),e.size!=t.size&&!h)return!1;var v=p.get(e);if(v)return v==t;n|=2,p.set(e,t);var d=i(y(e),y(t),n,u,f,p);return p.delete(e),d;case"[object Symbol]":if(l)return l.call(e)==l.call(t)}return!1}},function(e,t){e.exports=function(e){var t=-1,r=Array(e.size);return e.forEach((function(e,n){r[++t]=[n,e]})),r}},function(e,t,r){var n=r(82),a=Object.prototype.hasOwnProperty;e.exports=function(e,t,r,o,i,s){var c=1&r,u=n(e),l=u.length;if(l!=n(t).length&&!c)return!1;for(var f=l;f--;){var p=u[f];if(!(c?p in t:a.call(t,p)))return!1}var y=s.get(e);if(y&&s.get(t))return y==t;var h=!0;s.set(e,t),s.set(t,e);for(var v=c;++f<l;){var d=e[p=u[f]],m=t[p];if(o)var b=c?o(m,d,p,t,e,s):o(d,m,p,e,t,s);if(!(void 0===b?d===m||i(d,m,r,o,s):b)){h=!1;break}v||(v="constructor"==p)}if(h&&!v){var g=e.constructor,w=t.constructor;g!=w&&"constructor"in e&&"constructor"in t&&!("function"==typeof g&&g instanceof g&&"function"==typeof w&&w instanceof w)&&(h=!1)}return s.delete(e),s.delete(t),h}},function(e,t){e.exports=function(e,t){for(var r=-1,n=null==e?0:e.length,a=0,o=[];++r<n;){var i=e[r];t(i,r,e)&&(o[a++]=i)}return o}},function(e,t,r){var n=r(43),a=r(156),o=Object.prototype.hasOwnProperty;e.exports=function(e){if(!n(e))return a(e);var t=[];for(var r in Object(e))o.call(e,r)&&"constructor"!=r&&t.push(r);return t}},function(e,t,r){var n=r(65)(Object.keys,Object);e.exports=n},function(e,t,r){var n=r(10)(r(7),"DataView");e.exports=n},function(e,t,r){var n=r(10)(r(7),"Promise");e.exports=n},function(e,t,r){var n=r(10)(r(7),"WeakMap");e.exports=n},function(e,t,r){var n=r(85),a=r(15);e.exports=function(e){for(var t=a(e),r=t.length;r--;){var o=t[r],i=e[o];t[r]=[o,i,n(i)]}return t}},function(e,t,r){var n=r(80),a=r(162),o=r(168),i=r(52),s=r(85),c=r(86),u=r(20);e.exports=function(e,t){return i(e)&&s(t)?c(u(e),t):function(r){var i=a(r,e);return void 0===i&&i===t?o(r,e):n(t,i,3)}}},function(e,t,r){var n=r(51);e.exports=function(e,t,r){var a=null==e?void 0:n(e,t);return void 0===a?r:a}},function(e,t,r){var n=r(164),a=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,o=/\\(\\)?/g,i=n((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(a,(function(e,r,n,a){t.push(n?a.replace(o,"$1"):r||e)})),t}));e.exports=i},function(e,t,r){var n=r(165);e.exports=function(e){var t=n(e,(function(e){return 500===r.size&&r.clear(),e})),r=t.cache;return t}},function(e,t,r){var n=r(38);function a(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var r=function r(){var n=arguments,a=t?t.apply(this,n):n[0],o=r.cache;if(o.has(a))return o.get(a);var i=e.apply(this,n);return r.cache=o.set(a,i)||o,i};return r.cache=new(a.Cache||n),r}a.Cache=n,e.exports=a},function(e,t,r){var n=r(167);e.exports=function(e){return null==e?"":n(e)}},function(e,t,r){var n=r(13),a=r(32),o=r(4),i=r(19),s=n?n.prototype:void 0,c=s?s.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(o(t))return a(t,e)+"";if(i(t))return c?c.call(t):"";var r=t+"";return"0"==r&&1/t==-1/0?"-0":r}},function(e,t,r){var n=r(169),a=r(170);e.exports=function(e,t){return null!=e&&a(e,t,n)}},function(e,t){e.exports=function(e,t){return null!=e&&t in Object(e)}},function(e,t,r){var n=r(34),a=r(27),o=r(4),i=r(31),s=r(44),c=r(20);e.exports=function(e,t,r){for(var u=-1,l=(t=n(t,e)).length,f=!1;++u<l;){var p=c(t[u]);if(!(f=null!=e&&r(e,p)))break;e=e[p]}return f||++u!=l?f:!!(l=null==e?0:e.length)&&s(l)&&i(p,l)&&(o(e)||a(e))}},function(e,t,r){var n=r(172),a=r(173),o=r(52),i=r(20);e.exports=function(e){return o(e)?n(i(e)):a(e)}},function(e,t){e.exports=function(e){return function(t){return null==t?void 0:t[e]}}},function(e,t,r){var n=r(51);e.exports=function(e){return function(t){return n(t,e)}}},function(e,t,r){var n=r(175),a=r(11);e.exports=function(e,t){var r=-1,o=a(e)?Array(e.length):[];return n(e,(function(e,n,a){o[++r]=t(e,n,a)})),o}},function(e,t,r){var n=r(176),a=r(177)(n);e.exports=a},function(e,t,r){var n=r(60),a=r(15);e.exports=function(e,t){return e&&n(e,t,a)}},function(e,t,r){var n=r(11);e.exports=function(e,t){return function(r,a){if(null==r)return r;if(!n(r))return e(r,a);for(var o=r.length,i=t?o:-1,s=Object(r);(t?i--:++i<o)&&!1!==a(s[i],i,s););return r}}},function(e,t,r){var n=r(18),a=r(11),o=r(15);e.exports=function(e){return function(t,r,i){var s=Object(t);if(!a(t)){var c=n(r,3);t=o(t),r=function(e){return c(s[e],e,s)}}var u=e(t,r,i);return u>-1?s[c?t[u]:u]:void 0}}},function(e,t,r){var n=r(77),a=r(18),o=r(180),i=Math.max;e.exports=function(e,t,r){var s=null==e?0:e.length;if(!s)return-1;var c=null==r?0:o(r);return c<0&&(c=i(s+c,0)),n(e,a(t,3),c)}},function(e,t,r){var n=r(181);e.exports=function(e){var t=n(e),r=t%1;return t==t?r?t-r:t:0}},function(e,t,r){var n=r(182);e.exports=function(e){return e?(e=n(e))===1/0||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},function(e,t,r){var n=r(8),a=r(19),o=/^\s+|\s+$/g,i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,c=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(a(e))return NaN;if(n(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=n(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(o,"");var r=s.test(e);return r||c.test(e)?u(e.slice(2),r?2:8):i.test(e)?NaN:+e}},function(e,t,r){var n=r(184);e.exports=function(e,t){return e&&e.length&&t&&t.length?n(e,t):e}},function(e,t,r){var n=r(32),a=r(76),o=r(185),i=r(29),s=r(41),c=Array.prototype.splice;e.exports=function(e,t,r,u){var l=u?o:a,f=-1,p=t.length,y=e;for(e===t&&(t=s(t)),r&&(y=n(e,i(r)));++f<p;)for(var h=0,v=t[f],d=r?r(v):v;(h=l(y,d,h,u))>-1;)y!==e&&c.call(y,h,1),c.call(e,h,1);return e}},function(e,t){e.exports=function(e,t,r,n){for(var a=r-1,o=e.length;++a<o;)if(n(e[a],t))return a;return-1}},function(e,t,r){var n=r(87),a=r(31),o=Array.prototype.splice;e.exports=function(e,t){for(var r=e?t.length:0,i=r-1;r--;){var s=t[r];if(r==i||s!==c){var c=s;a(s)?o.call(e,s,1):n(e,s)}}return e}},function(e,t){e.exports=function(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}},function(e,t,r){var n=r(51),a=r(189);e.exports=function(e,t){return t.length<2?e:n(e,a(t,0,-1))}},function(e,t){e.exports=function(e,t,r){var n=-1,a=e.length;t<0&&(t=-t>a?0:a+t),(r=r>a?a:r)<0&&(r+=a),a=t>r?0:r-t>>>0,t>>>=0;for(var o=Array(a);++n<a;)o[n]=e[n+t];return o}},function(e,t,r){var n=r(22),a=r(191),o=r(68),i=r(192),s=r(193),c=r(61),u=r(41),l=r(194),f=r(195),p=r(82),y=r(89),h=r(33),v=r(196),d=r(197),m=r(64),b=r(4),g=r(28),w=r(201),k=r(8),x=r(203),S=r(15),P={};P["[object Arguments]"]=P["[object Array]"]=P["[object ArrayBuffer]"]=P["[object DataView]"]=P["[object Boolean]"]=P["[object Date]"]=P["[object Float32Array]"]=P["[object Float64Array]"]=P["[object Int8Array]"]=P["[object Int16Array]"]=P["[object Int32Array]"]=P["[object Map]"]=P["[object Number]"]=P["[object Object]"]=P["[object RegExp]"]=P["[object Set]"]=P["[object String]"]=P["[object Symbol]"]=P["[object Uint8Array]"]=P["[object Uint8ClampedArray]"]=P["[object Uint16Array]"]=P["[object Uint32Array]"]=!0,P["[object Error]"]=P["[object Function]"]=P["[object WeakMap]"]=!1,e.exports=function e(t,r,O,_,j,I){var E,D=1&r,C=2&r,R=4&r;if(O&&(E=j?O(t,_,j,I):O(t)),void 0!==E)return E;if(!k(t))return t;var A=b(t);if(A){if(E=v(t),!D)return u(t,E)}else{var T=h(t),M="[object Function]"==T||"[object GeneratorFunction]"==T;if(g(t))return c(t,D);if("[object Object]"==T||"[object Arguments]"==T||M&&!j){if(E=C||M?{}:m(t),!D)return C?f(t,s(E,t)):l(t,i(E,t))}else{if(!P[T])return j?t:{};E=d(t,T,D)}}I||(I=new n);var K=I.get(t);if(K)return K;I.set(t,E),x(t)?t.forEach((function(n){E.add(e(n,r,O,n,t,I))})):w(t)&&t.forEach((function(n,a){E.set(a,e(n,r,O,a,t,I))}));var L=R?C?y:p:C?keysIn:S,F=A?void 0:L(t);return a(F||t,(function(n,a){F&&(n=t[a=n]),o(E,a,e(n,r,O,a,t,I))})),E}},function(e,t){e.exports=function(e,t){for(var r=-1,n=null==e?0:e.length;++r<n&&!1!==t(e[r],r,e););return e}},function(e,t,r){var n=r(14),a=r(15);e.exports=function(e,t){return e&&n(t,a(t),e)}},function(e,t,r){var n=r(14),a=r(30);e.exports=function(e,t){return e&&n(t,a(t),e)}},function(e,t,r){var n=r(14),a=r(50);e.exports=function(e,t){return n(e,a(e),t)}},function(e,t,r){var n=r(14),a=r(88);e.exports=function(e,t){return n(e,a(e),t)}},function(e,t){var r=Object.prototype.hasOwnProperty;e.exports=function(e){var t=e.length,n=new e.constructor(t);return t&&"string"==typeof e[0]&&r.call(e,"index")&&(n.index=e.index,n.input=e.input),n}},function(e,t,r){var n=r(40),a=r(198),o=r(199),i=r(200),s=r(62);e.exports=function(e,t,r){var c=e.constructor;switch(t){case"[object ArrayBuffer]":return n(e);case"[object Boolean]":case"[object Date]":return new c(+e);case"[object DataView]":return a(e,r);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return s(e,r);case"[object Map]":return new c;case"[object Number]":case"[object String]":return new c(e);case"[object RegExp]":return o(e);case"[object Set]":return new c;case"[object Symbol]":return i(e)}}},function(e,t,r){var n=r(40);e.exports=function(e,t){var r=t?n(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}},function(e,t){var r=/\w*$/;e.exports=function(e){var t=new e.constructor(e.source,r.exec(e));return t.lastIndex=e.lastIndex,t}},function(e,t,r){var n=r(13),a=n?n.prototype:void 0,o=a?a.valueOf:void 0;e.exports=function(e){return o?Object(o.call(e)):{}}},function(e,t,r){var n=r(202),a=r(29),o=r(46),i=o&&o.isMap,s=i?a(i):n;e.exports=s},function(e,t,r){var n=r(33),a=r(9);e.exports=function(e){return a(e)&&"[object Map]"==n(e)}},function(e,t,r){var n=r(204),a=r(29),o=r(46),i=o&&o.isSet,s=i?a(i):n;e.exports=s},function(e,t,r){var n=r(33),a=r(9);e.exports=function(e){return a(e)&&"[object Set]"==n(e)}},function(e,t,r){var n=r(66);e.exports=function(e){return n(e)?void 0:e}},function(e,t,r){var n=r(207),a=r(72),o=r(73);e.exports=function(e){return o(a(e,void 0,n),e+"")}},function(e,t,r){var n=r(208);e.exports=function(e){return(null==e?0:e.length)?n(e,1):[]}},function(e,t,r){var n=r(49),a=r(209);e.exports=function e(t,r,o,i,s){var c=-1,u=t.length;for(o||(o=a),s||(s=[]);++c<u;){var l=t[c];r>0&&o(l)?r>1?e(l,r-1,o,i,s):n(s,l):i||(s[s.length]=l)}return s}},function(e,t,r){var n=r(13),a=r(27),o=r(4),i=n?n.isConcatSpreadable:void 0;e.exports=function(e){return o(e)||a(e)||!!(i&&e&&e[i])}},function(e,t,r){var n=r(19),a=Math.floor,o=Math.min;e.exports=function(e,t,r,i){t=r(t);for(var s=0,c=null==e?0:e.length,u=t!=t,l=null===t,f=n(t),p=void 0===t;s<c;){var y=a((s+c)/2),h=r(e[y]),v=void 0!==h,d=null===h,m=h==h,b=n(h);if(u)var g=i||m;else g=p?m&&(i||v):l?m&&v&&(i||!d):f?m&&v&&!d&&(i||!b):!d&&!b&&(i?h<=t:h<t);g?s=y+1:c=y}return o(c,4294967294)}},function(e,t,r){"use strict";r.r(t),r.d(t,"SNApplication",(function(){return pl})),r.d(t,"SNProtocolService",(function(){return fc})),r.d(t,"SNProtocolOperator001",(function(){return Se})),r.d(t,"SNProtocolOperator002",(function(){return Te})),r.d(t,"SNProtocolOperator003",(function(){return He})),r.d(t,"SNProtocolOperator004",(function(){return et})),r.d(t,"DeviceInterface",(function(){return ml})),r.d(t,"SNItem",(function(){return z})),r.d(t,"SNItemsKey",(function(){return ct})),r.d(t,"SNPredicate",(function(){return v})),r.d(t,"SNNote",(function(){return cr})),r.d(t,"SNTag",(function(){return tr})),r.d(t,"SNSmartTag",(function(){return Ir})),r.d(t,"SNActionsExtension",(function(){return Gt})),r.d(t,"Action",(function(){return Bt})),r.d(t,"SNTheme",(function(){return Mr})),r.d(t,"SNEncryptedStorage",(function(){return Wr})),r.d(t,"SNComponent",(function(){return kt})),r.d(t,"SNEditor",(function(){return Kt})),r.d(t,"SNComponentManager",(function(){return _i})),r.d(t,"HistorySession",(function(){return _c})),r.d(t,"ItemHistory",(function(){return Pc})),r.d(t,"ItemHistoryEntry",(function(){return yc})),r.d(t,"SNPrivileges",(function(){return xr})),r.d(t,"SNWebCrypto",(function(){return se.SNWebCrypto})),r.d(t,"SNModelManager",(function(){return Yi})),r.d(t,"SNHttpService",(function(){return Mi})),r.d(t,"DeviceAuthService",(function(){return sl})),r.d(t,"ChallengeResponse",(function(){return bl})),r.d(t,"PureService",(function(){return ho})),r.d(t,"SNStorageService",(function(){return js})),r.d(t,"StoragePersistencePolicies",(function(){return Ss})),r.d(t,"StorageEncryptionPolicies",(function(){return Ps})),r.d(t,"StorageValueModes",(function(){return Os})),r.d(t,"ValueModesKeys",(function(){return _s})),r.d(t,"Challenges",(function(){return A})),r.d(t,"SNSyncService",(function(){return Zu})),r.d(t,"SyncSources",(function(){return Xu})),r.d(t,"SyncModes",(function(){return $u})),r.d(t,"TIMING_STRATEGY_RESOLVE_ON_NEXT",(function(){return Ju})),r.d(t,"TIMING_STRATEGY_FORCE_SPAWN_NEW",(function(){return Qu})),r.d(t,"SNSessionManager",(function(){return To})),r.d(t,"SNMigrationService",(function(){return tc})),r.d(t,"SNAlertService",(function(){return So})),r.d(t,"SNHistoryManager",(function(){return Tc})),r.d(t,"SNPrivilegesService",(function(){return Gc})),r.d(t,"SNSingletonManager",(function(){return ts})),r.d(t,"SNKeyManager",(function(){return iu})),r.d(t,"KEY_MODE_ROOT_KEY_NONE",(function(){return ru})),r.d(t,"KEY_MODE_ROOT_KEY_ONLY",(function(){return nu})),r.d(t,"KEY_MODE_ROOT_KEY_PLUS_WRAPPER",(function(){return au})),r.d(t,"KEY_MODE_WRAPPER_ONLY",(function(){return ou})),r.d(t,"SNApiService",(function(){return Xo})),r.d(t,"findInArray",(function(){return i.g})),r.d(t,"isNullOrUndefined",(function(){return i.l})),r.d(t,"deepMerge",(function(){return i.e})),r.d(t,"extendArray",(function(){return i.f})),r.d(t,"removeFromIndex",(function(){return i.v})),r.d(t,"subtractFromArray",(function(){return i.x})),r.d(t,"arrayByDifference",(function(){return i.b})),r.d(t,"uniqCombineObjArrays",(function(){return i.z})),r.d(t,"greaterOfTwoDates",(function(){return i.i})),r.d(t,"getGlobalScope",(function(){return i.h})),r.d(t,"truncateHexString",(function(){return i.y})),r.d(t,"Uuid",(function(){return U})),r.d(t,"EncryptionIntents",(function(){return G})),r.d(t,"isLocalStorageIntent",(function(){return J})),r.d(t,"isFileIntent",(function(){return Q})),r.d(t,"isDecryptedIntent",(function(){return $})),r.d(t,"intentRequiresEncryption",(function(){return X})),r.d(t,"ContentTypes",(function(){return c})),r.d(t,"ApplicationEvents",(function(){return b})),r.d(t,"Environments",(function(){return I})),r.d(t,"Platforms",(function(){return E})),r.d(t,"isEnvironmentWebOrDesktop",(function(){return C})),r.d(t,"isEnvironmentMobile",(function(){return R})),r.d(t,"platformFromString",(function(){return D})),r.d(t,"SyncEvents",(function(){return d})),r.d(t,"SNPureItemPayload",(function(){return yn})),r.d(t,"SNStorageItemPayload",(function(){return wn})),r.d(t,"PayloadCollection",(function(){return f})),r.d(t,"CreateMaxPayloadFromAnyObject",(function(){return no})),r.d(t,"CreateSourcedPayloadFromObject",(function(){return oo})),r.d(t,"PayloadSources",(function(){return rn})),r.d(t,"isPayloadSourceRetrieved",(function(){return nn})),r.d(t,"ProtocolVersions",(function(){return q})),r.d(t,"PayloadFormats",(function(){return ie})),r.d(t,"StorageKeys",(function(){return T})),r.d(t,"BaseMigration",(function(){return qs})),r.d(t,"ProtectedActions",(function(){return Vc})),r.d(t,"PrivilegeCredentials",(function(){return Hc})),r.d(t,"PRIVILEGE_SESSION_LENGTH_NONE",(function(){return Wc})),r.d(t,"PRIVILEGE_SESSION_LENGTH_FIVE_MINUTES",(function(){return zc})),r.d(t,"PRIVILEGE_SESSION_LENGTH_ONE_HOUR",(function(){return qc})),r.d(t,"PRIVILEGE_SESSION_LENGTH_ONE_WEEK",(function(){return Yc}));var n={};r.r(n),r.d(n,"Migration20200115",(function(){return Ls}));var a=r(0),o=r.n(a),i=r(1);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var c={Item:"SF|Item",RootKey:"SN|RootKey|NoSync",ItemsKey:"SN|ItemsKey",EncryptedStorage:"SN|EncryptedStorage",Note:"Note",Tag:"Tag",SmartTag:"SN|SmartTag",Component:"SN|Component",Editor:"SN|Editor",ActionsExtension:"Extension",UserPrefs:"SN|UserPreferences",Privileges:"SN|Privileges",HistorySession:"SN|HistorySession",Theme:"SN|Theme",Mfa:"SF|MFA",ServerExtension:"SF|Extension",FilesafeCredentials:"SN|FileSafe|Credentials",FilesafeFileMetadata:"SN|FileSafe|FileMetadata",FilesafeIntegration:"SN|FileSafe|Integration",ExtensionRepo:"SN|ExtensionRepo"};function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.payloads,n=void 0===r?[]:r,a=t.source;u(this,e),this.source=a,this.payloadMap={},this.allPayloads=n;var o=!0,i=!1,s=void 0;try{for(var c,l=n[Symbol.iterator]();!(o=(c=l.next()).done);o=!0){var f=c.value;this.payloadMap[f.uuid]=f}}catch(e){i=!0,s=e}finally{try{o||null==l.return||l.return()}finally{if(i)throw s}}Object.freeze(this)}var t,r,n;return t=e,(r=[{key:"findPayload",value:function(e){return this.payloadMap[e]}},{key:"concat",value:function(t){var r=t.allPayloads.slice(),n=!0,a=!1,o=void 0;try{for(var s,c=this.allPayloads[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var u=s.value;Object(i.g)(t.allPayloads,"uuid",u.uuid)||r.push(u)}}catch(e){a=!0,o=e}finally{try{n||null==c.return||c.return()}finally{if(a)throw o}}return new e({payloads:r,source:this.source})}},{key:"payloadsThatReferencePayload",value:function(e){for(var t=[],r=0,n=Object.keys(this.payloadMap);r<n.length;r++){var a=n[r],o=this.findPayload(a);o.errorDecrypting||Object(i.g)(o.content.references,"uuid",e.uuid)&&t.push(o)}return t}}])&&l(t.prototype,r),n&&l(t,n),e}();function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var y=function(){function e(t){var r=t.collections;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.collections=r,Object.freeze(this)}var t,r,n;return t=e,(r=[{key:"collectionForSource",value:function(e){return this.collections.find((function(t){return t.source===e}))}}])&&p(t.prototype,r),n&&p(t,n),e}();function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var v=function(){function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.keypath=t,this.operator=r,this.value=n,e.IsRecursiveOperator(this.operator)&&(this.value=this.value.map((function(t){return Array.isArray(t)?e.FromArray(t):t})))}var t,r,n;return t=e,n=[{key:"CompoundPredicate",value:function(t){return new e("ignored","and",t)}},{key:"FromArray",value:function(t){return new e(t[0],t[1],t[2])}},{key:"ObjectSatisfiesPredicate",value:function(t,r){if(Array.isArray(r)&&(r=this.FromArray(r)),e.IsRecursiveOperator(r.operator)){if("and"===r.operator){var n=!0,a=!1,o=void 0;try{for(var i,s=r.value[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var c=i.value;if(!this.ObjectSatisfiesPredicate(t,c))return!1}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return!0}if("or"===r.operator){var u=!0,l=!1,f=void 0;try{for(var p,y=r.value[Symbol.iterator]();!(u=(p=y.next()).done);u=!0){var h=p.value;if(this.ObjectSatisfiesPredicate(t,h))return!0}}catch(e){l=!0,f=e}finally{try{u||null==y.return||y.return()}finally{if(l)throw f}}return!1}}var v=r.value;"string"==typeof v&&v.includes(".ago")&&(v=this.DateFromString(v));var d=r.keypath.split(".").reduce((function(e,t){return e&&e[t]}),t),m=[!1,"",null,void 0,NaN];return void 0===d?"!="===r.operator?!m.includes(r.value):m.includes(r.value):"="===r.operator?Array.isArray(d)?JSON.stringify(d)===JSON.stringify(v):d===v:"!="===r.operator?Array.isArray(d)?JSON.stringify(d)!==JSON.stringify(v):d!==v:"<"===r.operator?d<v:">"===r.operator?d>v:"<="===r.operator?d<=v:">="===r.operator?d>=v:"startsWith"===r.operator?d.startsWith(v):"in"===r.operator?-1!==v.indexOf(d):"includes"===r.operator?this.resolveIncludesPredicate(d,v):"matches"===r.operator&&new RegExp(v).test(d)}},{key:"resolveIncludesPredicate",value:function(t,r){if("string"==typeof r)return t.includes(r);var n;n=Array.isArray(r)?e.FromArray(r):r;var a=!0,o=!1,i=void 0;try{for(var s,c=t[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var u=s.value;if(this.ObjectSatisfiesPredicate(u,n))return!0}}catch(e){o=!0,i=e}finally{try{a||null==c.return||c.return()}finally{if(o)throw i}}return!1}},{key:"ItemSatisfiesPredicate",value:function(t,r){return Array.isArray(r)&&(r=e.FromArray(r)),this.ObjectSatisfiesPredicate(t,r)}},{key:"ItemSatisfiesPredicates",value:function(e,t){var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(!this.ItemSatisfiesPredicate(e,s))return!1}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}return!0}},{key:"DateFromString",value:function(e){var t=e.split("."),r=t[1],n=new Date,a=parseInt(t[0]);return"days"===r?n.setDate(n.getDate()-a):"hours"===r&&n.setHours(n.getHours()-a),n}},{key:"IsRecursiveOperator",value:function(e){return["and","or"].includes(e)}}],(r=null)&&h(t.prototype,r),n&&h(t,n),e}(),d={FullSyncCompleted:"sync:full-completed",SingleSyncCompleted:"sync:single-completed",DownloadFirstSyncCompleted:"sync:initial-completed",SyncTakingTooLong:"sync:taking-too-long",SyncError:"sync:error",SyncException:"sync:sync-exception",InvalidSession:"sync:invalid-session",MajorDataChange:"major-data-change",LocalDataIncrementalLoad:"local-data-incremental-load",EnterOutOfSync:"enter-out-of-sync",ExitOutOfSync:"exit-out-of-sync"};function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var b={SignedIn:2,SignedOut:3,CompletedSync:5,FailedSync:6,HighLatencySync:7,EnteredOutOfSync:8,ExitedOutOfSync:9,Started:10,Launched:11,KeyStatusChanged:12};var g=0,w=.5,k=.9,x=1,S=1.1,P=1.2,O=1.3,_=3;function j(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var I={Web:1,Desktop:2,Mobile:3},E={Ios:1,Android:2,MacWeb:3,MacDesktop:4,WindowsWeb:5,WindowsDesktop:6,LinuxWeb:7,LinuxDesktop:8};function D(e){return{"mac-web":E.MacWeb,"mac-desktop":E.MacDesktop,"linux-web":E.LinuxWeb,"linux-desktop":E.LinuxDesktop,"windows-web":E.WindowsWeb,"windows-desktop":E.WindowsDesktop,ios:E.Ios,android:E.Android}[e]}function C(e){return e===I.Web||e===I.Desktop}function R(e){return e===I.Mobile}var A={LocalPasscode:1,AccountPassword:2,Biometric:3},T={RootKeyParams:"ROOT_KEY_PARAMS",WrappedRootKey:"WRAPPED_ROOT_KEY",RootKeyWrapperKeyParams:"ROOT_KEY_WRAPPER_KEY_PARAMS",Session:"session",User:"user",ServerHost:"server",LegacyUuid:"uuid",LastSyncToken:"syncToken",PaginationToken:"cursorToken",StorageObject:"storage",BiometricPrefs:"biometrics_prefs",MobilePasscodeTiming:"passcode_timing",PrivilegesExpirey:"SessionExpiresAtKey",PrivilegesSessionLength:"SessionLengthKey",SessionHistoryPersistable:"sessionHistory_persist",SessionHistoryRevisions:"sessionHistory_revisions",SessionHistoryOptimize:"sessionHistory_autoOptimize"};function M(e,t){return e?"".concat(e,"-").concat(t):t}function K(e){var t=e.leftContent,r=e.rightContent,n=e.keysToIgnore,a=e.appDataKeysToIgnore;if((t=JSON.parse(JSON.stringify(t))).appData){var o=t.appData["org.standardnotes.sn"];Object(i.s)(o,a),o?0===Object.keys(o).length&&delete t.appData:delete t.appData}if(Object(i.s)(t,n),(r=JSON.parse(JSON.stringify(r))).appData){var s=r.appData["org.standardnotes.sn"];Object(i.s)(s,a),s?0===Object.keys(s).length&&delete r.appData:delete r.appData}return Object(i.s)(r,n),JSON.stringify(t)===JSON.stringify(r)}function L(e,t,r){return r||(r=[]),!K({leftContent:e.content,rightContent:t.content,keysToIgnore:e.contentKeysToIgnoreWhenCheckingEquality().concat(r),appDataKeysToIgnore:e.appDatacontentKeysToIgnoreWhenCheckingEquality()})}function F(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function N(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var U=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n,a,s;return t=e,r=null,n=[{key:"SetGenerators",value:function(e){var t=e.syncImpl,r=e.asyncImpl;this.syncUuidFunc=t,this.asyncUuidFunc=r}},{key:"canGenSync",value:function(){return!Object(i.l)(this.syncUuidFunc)}},{key:"GenerateUuid",value:(a=o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.syncUuidFunc){e.next=4;break}return e.abrupt("return",this.syncUuidFunc());case 4:return e.abrupt("return",this.asyncUuidFunc());case 5:case"end":return e.stop()}}),e,this)})),s=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){F(o,r,n,i,s,"next",e)}function s(e){F(o,r,n,i,s,"throw",e)}i(void 0)}))},function(){return s.apply(this,arguments)})},{key:"GenerateUuidSynchronously",value:function(){return this.syncUuidFunc()}}],r&&N(t.prototype,r),n&&N(t,n),e}();function B(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function V(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function H(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var W=1,z=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.content={references:[],appData:V({},"org.standardnotes.sn",{})},this.resetLocalReferencePointers(),t){if(!t.isPayload)throw"Attempting to construct SNItem from non-payload object ".concat(t,".");this.updateFromPayload(t)}this.uuid||U.canGenSync()&&(this.uuid=U.GenerateUuidSynchronously())}var t,r,n,a,s;return t=e,(r=[{key:"payloadRepresentation",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.override;return no({object:this,override:t})}},{key:"populateDefaultContentValues",value:function(){this.errorDecrypting||this.deleted||(this.content.references||(this.content.references=[]),this.content.appData||(this.content.appData=V({},"org.standardnotes.sn",{})))}},{key:"initUUID",value:(a=o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.uuid){t.next=4;break}return t.next=3,e.GenerateUuid();case 3:this.uuid=t.sent;case 4:case"end":return t.stop()}}),t,this)})),s=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){B(o,r,n,i,s,"next",e)}function s(e){B(o,r,n,i,s,"throw",e)}i(void 0)}))},function(){return s.apply(this,arguments)})},{key:"updateFromPayload",value:function(e){if(e){var t=[fe.Content],r=!0,n=!1,a=void 0;try{for(var o,s=e.fields()[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value;if(!Object(i.j)(this,c)){var u=e[c];if(t.includes(c)){var l=Object(i.a)(u||null);this[c]=l}else this[c]=u}}}catch(e){n=!0,a=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw a}}this.content?this.mapContentToLocalProperties(this.content):!0===e.deleted&&this.handleDeletedContent(),this.dirtiedDate&&"string"==typeof this.dirtiedDate&&(this.dirtiedDate=new Date(this.dirtiedDate)),this.lastSyncBegan&&"string"==typeof this.lastSyncBegan&&(this.lastSyncBegan=new Date(this.lastSyncBegan)),this.lastSyncEnd&&"string"==typeof this.lastSyncEnd&&(this.lastSyncEnd=new Date(this.lastSyncEnd)),this.created_at?this.created_at=new Date(this.created_at):this.created_at=new Date,this.updated_at?this.updated_at=new Date(this.updated_at):this.updated_at=new Date(0),this._client_updated_at=null,this.populateDefaultContentValues()}}},{key:"mapContentToLocalProperties",value:function(e){}},{key:"collapseContent",value:function(){var e=this.structureParams();return Object(i.e)(this.content,e),e}},{key:"structureParams",value:function(){return this.getContentCopy()}},{key:"handleDeletedContent",value:function(){}},{key:"setDirty",value:function(e){var t=e.dirty,r=e.updateClientDate;if(!e.authorized)throw"Do not call setDirty directly. Use modelManager.setItemDirty";this.dirty=t,this.dirtiedDate=new Date,t&&r?this.client_updated_at=new Date:this.hasRawClientUpdatedAtValue()||(this.client_updated_at=new Date(this.updated_at)),this.collapseContent()}},{key:"updateLocalRelationships",value:function(){for(var e=this.content.references.map((function(e){return e.uuid})),t=0,r=Object.keys(this._referencedItems);t<r.length;t++){var n=r[t],a=this._referencedItems[n];e.includes(a.uuid)||(delete this._referencedItems[n],a.setIsNoLongerReferencedBy(this))}}},{key:"addItemAsRelationship",value:function(e){if(e.setIsBeingReferencedBy(this),this._referencedItems[e.uuid]||(this._referencedItems[e.uuid]=e),!this.hasRelationshipWithItem(e)){var t=this.content.references||[];t.push({uuid:e.uuid,content_type:e.content_type}),this.content.references=t}}},{key:"removeItemAsRelationship",value:function(e){e.setIsNoLongerReferencedBy(this),this.removeReferenceWithUuid(e.uuid),delete this._referencedItems[e.uuid]}},{key:"setIsBeingReferencedBy",value:function(e){this._referencingItems[e.uuid]||(this._referencingItems[e.uuid]=e)}},{key:"setIsNoLongerReferencedBy",value:function(e){delete this._referencingItems[e.uuid]}},{key:"removeReferenceWithUuid",value:function(e){var t=this.content.references||[];t=t.filter((function(t){return t.uuid!==e})),this.content.references=t,delete this._referencedItems[e]}},{key:"hasRelationshipWithItem",value:function(e){var t=this.content.references.find((function(t){return t.uuid===e.uuid}));return!Object(i.l)(t)}},{key:"isBeingRemovedLocally",value:function(){for(var e=0,t=Object.keys(this._referencedItems);e<t.length;e++){var r=t[e];this._referencedItems[r].setIsNoLongerReferencedBy(this)}}},{key:"resetLocalReferencePointers",value:function(){this._referencingItems={},this._referencedItems={}}},{key:"didCompleteMapping",value:function(e){}},{key:"setDomainDataItem",value:function(e,t,r){if(r){if(!this.errorDecrypting){this.content.appData||(this.content.appData={});var n=this.content.appData[r];n||(n={}),n[e]=t,this.content.appData[r]=n}}else console.error("DEFAULT_APP_DOMAIN needs to be set.")}},{key:"getDomainDataItem",value:function(e,t){if(t){if(!this.errorDecrypting){this.content.appData||(this.content.appData={});var r=this.content.appData[t];return r?r[e]:null}}else console.error("DEFAULT_APP_DOMAIN needs to be set.")}},{key:"setAppDataItem",value:function(e,t){this.setDomainDataItem(e,t,"org.standardnotes.sn")}},{key:"getAppDataItem",value:function(e){return this.getDomainDataItem(e,"org.standardnotes.sn")}},{key:"hasRawClientUpdatedAtValue",value:function(){return null!=this.getAppDataItem("client_updated_at")}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["conflict_of"]}},{key:"appDatacontentKeysToIgnoreWhenCheckingEquality",value:function(){return["client_updated_at"]}},{key:"getContentCopy",value:function(){return JSON.parse(JSON.stringify(this.content))}},{key:"strategyWhenConflictingWithItem",value:function(e){var t=e.item;return this.errorDecrypting?oa.KeepLeftDuplicateRight:this.isSingleton?oa.KeepLeft:this.deleted||t.deleted?oa.KeepRight:L(this,t)?L(this,t,["references"])?oa.KeepLeftDuplicateRight:oa.KeepLeftMergeRefs:oa.KeepRight}},{key:"isItemContentEqualWith",value:function(e){return K({leftContent:this.content,rightContent:e.content,keysToIgnore:this.contentKeysToIgnoreWhenCheckingEquality(),appDataKeysToIgnore:this.appDatacontentKeysToIgnoreWhenCheckingEquality()})}},{key:"satisfiesPredicate",value:function(e){return v.ItemSatisfiesPredicate(this,e)}},{key:"createdAtString",value:function(){return this.dateToLocalizedString(this.created_at)}},{key:"updatedAtString",value:function(){return this.dateToLocalizedString(this.client_updated_at)}},{key:"updatedAtTimestamp",value:function(){return this.updated_at.getTime()}},{key:"dateToLocalizedString",value:function(t){if("undefined"!=typeof Intl&&Intl.DateTimeFormat){if(!e.sharedDateFormatter){var r=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language;e.sharedDateFormatter=new Intl.DateTimeFormat(r,{year:"numeric",month:"short",day:"2-digit",weekday:"long",hour:"2-digit",minute:"2-digit"})}return e.sharedDateFormatter.format(t)}return t.toDateString()+" "+t.toLocaleTimeString()}},{key:"isItem",get:function(){return!0}},{key:"referencedItemsCount",get:function(){return Object.keys(this._referencedItems).length}},{key:"referencingItemsCount",get:function(){return Object.keys(this._referencingItems).length}},{key:"allReferencingItems",get:function(){var e=this;return Object.keys(this._referencingItems).map((function(t){return e._referencingItems[t]}))}},{key:"pinned",get:function(){return this.getAppDataItem("pinned")}},{key:"archived",get:function(){return this.getAppDataItem("archived")}},{key:"locked",get:function(){return this.getAppDataItem("locked")}},{key:"client_updated_at",get:function(){if(!this._client_updated_at){var e=this.getAppDataItem("client_updated_at");this._client_updated_at=e?new Date(e):new Date(this.updated_at)}return this._client_updated_at},set:function(e){this._client_updated_at=e,this.setAppDataItem("client_updated_at",e)}},{key:"neverSynced",get:function(){return!this.updated_at||0===this.updated_at.getTime()}},{key:"isSingleton",get:function(){return!1}},{key:"singletonPredicate",get:function(){throw"Must override SNItem.singletonPredicate"}},{key:"singletonStrategy",get:function(){return W}}])&&H(t.prototype,r),n&&H(t,n),e}(),q={V000Base64Decrypted:"000",V001:"001",V002:"002",V003:"003",V004:"004",VersionLength:3};function Y(e,t){return Number(e)-Number(t)}var G={Sync:0,SyncDecrypted:1,LocalStorageEncrypted:2,LocalStorageDecrypted:3,LocalStoragePreferEncrypted:4,FileEncrypted:5,FileDecrypted:6,FilePreferEncrypted:7};function J(e){return e===G.LocalStorageEncrypted||e===G.LocalStorageDecrypted||e===G.LocalStoragePreferEncrypted}function Q(e){return e===G.FileEncrypted||e===G.FileDecrypted||e===G.FilePreferEncrypted}function $(e){return e===G.SyncDecrypted||e===G.LocalStorageDecrypted||e===G.FileDecrypted}function X(e){return e===G.Sync||e===G.LocalStorageEncrypted||e===G.FileEncrypted}function Z(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ee(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function te(e,t,r){return t&&ee(e.prototype,t),r&&ee(e,r),e}var re=function(){var e,t;function r(e){var t=e.uuid,n=e.content;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.uuid=t,this.content=Object(i.a)(n),this.content.version||(this.content.dataAuthenticationKey?this.content.version=q.V002:this.content.version=q.V001),!this.content.version)throw"Attempting to create key without version.";Object.freeze(this)}return te(r,null,[{key:"Create",value:(e=o.a.mark((function e(t){var n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.uuid,a=t.content,n){e.next=5;break}return e.next=4,U.GenerateUuid();case 4:n=e.sent;case 5:return e.abrupt("return",new r({uuid:n,content:a}));case 6:case"end":return e.stop()}}),e)})),t=function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Z(o,n,a,i,s,"next",e)}function s(e){Z(o,n,a,i,s,"throw",e)}i(void 0)}))},function(e){return t.apply(this,arguments)})}]),te(r,[{key:"compare",value:function(e){if(this.version!==e.version)return!1;var t=this.serverPassword&&e.serverPassword;return this.masterKey===e.masterKey&&(!t||this.serverPassword===e.serverPassword)}},{key:"getPersistableValue",value:function(){var e={version:this.version};return this.masterKey&&(e.masterKey=this.masterKey),this.dataAuthenticationKey&&(e.dataAuthenticationKey=this.dataAuthenticationKey),e}},{key:"version",get:function(){return this.content.version}},{key:"isRootKey",get:function(){return!0}},{key:"itemsKey",get:function(){return this.masterKey}},{key:"masterKey",get:function(){return this.content.masterKey}},{key:"serverPassword",get:function(){return this.content.serverPassword}},{key:"dataAuthenticationKey",get:function(){return this.content.dataAuthenticationKey}}],[{key:"contentType",value:function(){return c.RootKey}}]),r}();function ne(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ae(e){return new oe(e)}var oe=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!Object(i.m)(t)||t.isKeyParamsObject)throw"Attempting to construct root key params with non-object";this.content=t}var t,r,n;return t=e,(r=[{key:"getPortableValue",value:function(){return Y(this.version,q.V003)>=0?Object(i.r)(this.content,["pw_cost"]):this.content}},{key:"isKeyParamsObject",get:function(){return!0}},{key:"kdfIterations",get:function(){return this.content.pw_cost}},{key:"seed",get:function(){return this.content.pw_nonce}},{key:"identifier",get:function(){return this.content.identifier||this.content.email}},{key:"salt",get:function(){return this.content.pw_salt}},{key:"version",get:function(){return this.content.version}}])&&ne(t.prototype,r),n&&ne(t,n),e}(),ie={EncryptedString:0,DecryptedBareObject:1,DecryptedBase64String:2},se=r(6);function ce(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ue(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){ce(o,n,a,i,s,"next",e)}function s(e){ce(o,n,a,i,s,"throw",e)}i(void 0)}))}}function le(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var fe={Uuid:"uuid",ContentType:"content_type",ItemsKeyId:"items_key_id",EncItemKey:"enc_item_key",Content:"content",CreatedAt:"created_at",UpdatedAt:"updated_at",Deleted:"deleted",Legacy003AuthHash:"auth_hash",Legacy003AuthParams:"auth_params",Dirty:"dirty",DirtiedDate:"dirtiedDate",WaitingForKey:"waitingForKey",ErrorDecrypting:"errorDecrypting",ErrorDecryptingChanged:"errorDecryptingValueChanged",Dummy:"dummy",LastSyncBegan:"lastSyncBegan",LastSyncEnd:"lastSyncEnd"};function pe(e){return(pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ye(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function he(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ve(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){he(o,n,a,i,s,"next",e)}function s(e){he(o,n,a,i,s,"throw",e)}i(void 0)}))}}function de(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function me(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function be(e,t){return!t||"object"!==pe(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ge(e,t,r){return(ge="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=we(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function we(e){return(we=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ke(e,t){return(ke=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xe="00000000000000000000000000000000",Se=function(e){function t(){return de(this,t),be(this,we(t).apply(this,arguments))}var r,n,a,i,s,c,u,l,f,p,y;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ke(e,t)}(t,e),r=t,n=[{key:"generateNewItemsKeyContent",value:(y=ve(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,this.crypto.generateRandomKey(256);case 3:return t=e.sent,r=this.constructor.versionString(),e.abrupt("return",{itemsKey:t,version:r});case 6:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"createRootKey",value:(p=ve(o.a.mark((function e(t){var r,n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.identifier,n=t.password,a=this.constructor.pwCost(),e.next=4,this.crypto.generateRandomKey(128);case 4:return i=e.sent,e.next=7,this.crypto.unsafeSha1(r+"SN"+i);case 7:return s=e.sent,e.next=10,this.deriveKey({password:n,pwSalt:s,pwCost:a});case 10:return c=e.sent,u=ae({email:r,pw_cost:a,pw_nonce:i,pw_salt:s,version:q.V001}),e.abrupt("return",{key:c,keyParams:u});case 13:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"computeRootKey",value:(f=ve(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.password,(n=t.keyParams).isKeyParamsObject){e.next=3;break}throw"Attempting to compute root key with non params object.";case 3:return e.next=5,this.deriveKey({password:r,pwSalt:n.salt,pwCost:n.kdfIterations});case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"decryptString",value:(l=ve(o.a.mark((function e(t,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,xe,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"encryptString",value:(u=ve(o.a.mark((function e(t,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,xe,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"generateEncryptionParameters",value:(c=ve(o.a.mark((function e(r){var n,a,i,s,c,u,l,f,p,y,h;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=r.payload,i=r.key,(s=r.format)!==ie.DecryptedBareObject&&s!==ie.DecryptedBase64String){e.next=3;break}return e.abrupt("return",ge(we(t.prototype),"generateEncryptionParameters",this).call(this,{payload:a,key:i,format:s}));case 3:if(s===ie.EncryptedString){e.next=5;break}throw"Unsupport format for generateEncryptionParameters ".concat(s);case 5:if(i&&i.itemsKey){e.next=7;break}throw"Attempting to generateEncryptionParameters with no itemsKey.";case 7:return e.next=9,this.crypto.generateRandomKey(512);case 9:return c=e.sent,e.next=12,this.encryptString(c,i.itemsKey);case 12:return u=e.sent,e.next=15,this.firstHalfOfKey(c);case 15:return l=e.sent,e.next=18,this.secondHalfOfKey(c);case 18:return f=e.sent,e.next=21,this.encryptString(JSON.stringify(a.content),l);case 21:return p=e.sent,y=i.version+p,e.next=25,this.crypto.hmac256(y,f);case 25:return h=e.sent,e.abrupt("return",co((ye(n={},fe.ItemsKeyId,i.isItemsKey?i.uuid:null),ye(n,fe.Content,y),ye(n,fe.EncItemKey,u),ye(n,fe.Legacy003AuthHash,h),n)));case 27:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(s=ve(o.a.mark((function e(r){var n,a,i,s,c,u,l,f,p,y,h,v,d,m;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.encryptedParameters,a=r.key,(i=n.getContentFormat())!==ie.DecryptedBareObject&&i!==ie.DecryptedBase64String){e.next=4;break}return e.abrupt("return",ge(we(t.prototype),"generateDecryptedParameters",this).call(this,{encryptedParameters:n,key:a}));case 4:if(n.enc_item_key){e.next=7;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",n);case 7:if(s=n.enc_item_key,s=q.V001+s,!(c=this.encryptionComponentsFromString(s,a.itemsKey)).uuid||c.uuid===n.uuid){e.next=13;break}return console.error("Item key params UUID does not match item UUID"),e.abrupt("return",uo({encryptionParameters:n,override:(u={},ye(u,fe.ErrorDecrypting,!0),ye(u,fe.ErrorDecryptingChanged,!n.errorDecrypting),u)}));case 13:return e.next=15,this.decryptString(c.contentCiphertext,c.encryptionKey);case 15:if(l=e.sent){e.next=19;break}return console.error("Error decrypting parameters",n),e.abrupt("return",uo({encryptionParameters:n,override:(f={},ye(f,fe.ErrorDecrypting,!0),ye(f,fe.ErrorDecryptingChanged,!n.errorDecrypting),f)}));case 19:return e.next=21,this.firstHalfOfKey(l);case 21:if(p=e.sent,!(y=this.encryptionComponentsFromString(n.content,p)).uuid||y.uuid===n.uuid){e.next=25;break}return e.abrupt("return",uo({encryptionParameters:n,override:(h={},ye(h,fe.ErrorDecrypting,!0),ye(h,fe.ErrorDecryptingChanged,!n.errorDecrypting),h)}));case 25:return e.next=27,this.decryptString(y.contentCiphertext,y.encryptionKey);case 27:if(v=e.sent){e.next=32;break}return e.abrupt("return",uo({encryptionParameters:n,override:(d={},ye(d,fe.ErrorDecrypting,!0),ye(d,fe.ErrorDecryptingChanged,!n.errorDecrypting),d)}));case 32:return e.abrupt("return",uo({encryptionParameters:n,override:(m={},ye(m,fe.Content,JSON.parse(v)),ye(m,fe.ErrorDecrypting,!1),ye(m,fe.ErrorDecryptingChanged,!0===n.errorDecrypting),ye(m,fe.WaitingForKey,!1),m)}));case 33:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"encryptionComponentsFromString",value:function(e,t){var r=e.substring(0,q.VersionLength);return{contentCiphertext:e.substring(q.VersionLength,e.length),encryptionVersion:r,encryptionKey:t}}},{key:"deriveKey",value:(i=ve(o.a.mark((function e(){var t,r,n,a,i,s,c,u=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>0&&void 0!==u[0]?u[0]:{},r=t.password,n=t.pwSalt,a=t.pwCost,e.next=3,this.crypto.pbkdf2(r,n,a,512);case 3:return i=e.sent,e.next=6,this.splitKey({key:i,numParts:2});case 6:return s=e.sent,e.next=9,re.Create({content:{serverPassword:s[0],masterKey:s[1],version:this.constructor.versionString()}});case 9:return c=e.sent,e.abrupt("return",c);case 11:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})}],a=[{key:"pwCost",value:function(){return 3e3}},{key:"versionString",value:function(){return q.V001}}],n&&me(r.prototype,n),a&&me(r,a),t}(function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.crypto=t}var t,r,n,a,i,s,c,u,l,f;return t=e,(r=[{key:"firstHalfOfKey",value:(f=ue(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(0,t.length/2));case 1:case"end":return e.stop()}}),e)}))),function(e){return f.apply(this,arguments)})},{key:"secondHalfOfKey",value:(l=ue(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(t.length/2,t.length));case 1:case"end":return e.stop()}}),e)}))),function(e){return l.apply(this,arguments)})},{key:"splitKey",value:(u=ue(o.a.mark((function e(t){var r,n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(r=t.key,n=t.numParts,a=r.length,i=a/n,s=[],c=0;c<n;c++)u=r.slice(i*c,i*(c+1)),s.push(u);return e.abrupt("return",s);case 6:case"end":return e.stop()}}),e)}))),function(e){return u.apply(this,arguments)})},{key:"generateNewItemsKeyContent",value:(c=ue(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override generateNewItemsKeyContent";case 1:case"end":return e.stop()}}),e)}))),function(){return c.apply(this,arguments)})},{key:"createItemsKey",value:(s=ue(o.a.mark((function e(){var t,r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateNewItemsKeyContent();case 2:return t=e.sent,r=no({object:{content:t}}),n=new ct(r),e.next=7,n.initUUID();case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"generateEncryptionParameters",value:(i=ue(o.a.mark((function e(t){var r,n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.payload,t.key,(n=t.format)!==ie.DecryptedBareObject){e.next=5;break}return e.abrupt("return",co({content:r.content}));case 5:if(n!==ie.DecryptedBase64String){e.next=14;break}return a=JSON.stringify(r.content),e.next=9,Object(se.base64Encode)(a);case 9:return i=e.sent,s=q.V000Base64Decrypted+i,e.abrupt("return",co({content:s}));case 14:throw"Must override generateEncryptionParameters to handle format ".concat(n,".");case 15:case"end":return e.stop()}}),e)}))),function(e){return i.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(a=ue(o.a.mark((function e(t){var r,n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.encryptedParameters,t.key,r.isEncryptionParameters){e.next=3;break}throw"Atempting to generate decrypted parameters from non-parameters object.";case 3:if((n=r.getContentFormat())!==ie.DecryptedBareObject){e.next=8;break}return e.abrupt("return",co(r));case 8:if(n!==ie.DecryptedBase64String){e.next=23;break}return a=r.content.substring(q.VersionLength,r.content.length),e.prev=10,e.next=13,Object(se.base64Decode)(a);case 13:s=e.sent,i=JSON.parse(s),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(10),i=r.content;case 20:return e.abrupt("return",uo({encryptionParameters:r,override:{content:i}}));case 23:throw"Must override generateDecryptedParameters to handle format ".concat(n,".");case 24:case"end":return e.stop()}}),e,null,[[10,17]])}))),function(e){return a.apply(this,arguments)})}])&&le(t.prototype,r),n&&le(t,n),e}());function Pe(e){return(Pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Oe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _e(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function je(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){_e(o,n,a,i,s,"next",e)}function s(e){_e(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Ie(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ee(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function De(e,t){return!t||"object"!==Pe(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ce(e,t,r){return(Ce="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Re(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Re(e){return(Re=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ae(e,t){return(Ae=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Te=function(e){function t(){return Ie(this,t),De(this,Re(t).apply(this,arguments))}var r,n,a,i,s,c,u,l,f,p,y,h,v;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ae(e,t)}(t,e),r=t,n=[{key:"generateNewItemsKeyContent",value:(v=je(o.a.mark((function e(){var t,r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=256,e.next=3,this.crypto.generateRandomKey(t);case 3:return r=e.sent,e.next=6,this.crypto.generateRandomKey(t);case 6:return n=e.sent,a=this.constructor.versionString(),e.abrupt("return",{itemsKey:r,dataAuthenticationKey:n,version:a});case 9:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"createRootKey",value:(h=je(o.a.mark((function e(t){var r,n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.identifier,n=t.password,a=this.constructor.pwCost(),e.next=4,this.crypto.generateRandomKey(128);case 4:return i=e.sent,e.next=7,this.crypto.unsafeSha1(r+":"+i);case 7:return s=e.sent,e.next=10,this.deriveKey({password:n,pwSalt:s,pwCost:a});case 10:return c=e.sent,u=ae({email:r,pw_cost:a,pw_nonce:i,pw_salt:s,version:q.V002}),e.abrupt("return",{key:c,keyParams:u});case 13:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"computeRootKey",value:(y=je(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.password,(n=t.keyParams).isKeyParamsObject){e.next=3;break}throw"Attempting to compute root key with non params object.";case 3:return e.next=5,this.deriveKey({password:r,pwSalt:n.salt,pwCost:n.kdfIterations});case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"decryptString",value:(p=je(o.a.mark((function e(t,r,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return p.apply(this,arguments)})},{key:"encryptString",value:(f=je(o.a.mark((function e(t,r,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return f.apply(this,arguments)})},{key:"encryptTextParams",value:(l=je(o.a.mark((function e(t,r,n,a,i){var s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(128);case 2:return s=e.sent,e.next=5,this.encryptString(t,r,s);case 5:return c=e.sent,u=[i,a,s,c].join(":"),e.next=9,this.crypto.hmac256(u,n);case 9:return l=e.sent,f=[i,l,a,s,c].join(":"),e.abrupt("return",f);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a){return l.apply(this,arguments)})},{key:"decryptTextParams",value:(u=je(o.a.mark((function e(t){var r,n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.ciphertextToAuth,n=t.contentCiphertext,a=t.encryptionKey,i=t.iv,s=t.authHash,c=t.authKey,a){e.next=3;break}throw"Attempting to decryptTextParams with null encryptionKey";case 3:return e.next=5,this.crypto.hmac256(r,c);case 5:if(u=e.sent,!1!==this.crypto.timingSafeEqual(s,u)){e.next=9;break}return console.error("Auth hash does not match, returning null."),e.abrupt("return",null);case 9:return e.abrupt("return",this.decryptString(n,a,i));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"generateEncryptionParameters",value:(c=je(o.a.mark((function e(r){var n,a,i,s,c,u,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=r.payload,i=r.key,(s=r.format)!==ie.DecryptedBareObject&&s!==ie.DecryptedBase64String){e.next=3;break}return e.abrupt("return",Ce(Re(t.prototype),"generateEncryptionParameters",this).call(this,{payload:a,key:i,format:s}));case 3:if(s===ie.EncryptedString){e.next=5;break}throw"Unsupport format for generateEncryptionParameters ".concat(s);case 5:if(i&&i.itemsKey){e.next=7;break}throw"Attempting to generateEncryptionParameters with no itemsKey.";case 7:return e.next=9,this.crypto.generateRandomKey(512);case 9:return c=e.sent,e.next=12,this.encryptTextParams(c,i.itemsKey,i.dataAuthenticationKey,a.uuid,i.version);case 12:return u=e.sent,e.next=15,this.firstHalfOfKey(c);case 15:return l=e.sent,e.next=18,this.secondHalfOfKey(c);case 18:return f=e.sent,e.next=21,this.encryptTextParams(JSON.stringify(a.content),l,f,a.uuid,i.version);case 21:return p=e.sent,e.abrupt("return",co((Oe(n={},fe.ItemsKeyId,i.isItemsKey?i.uuid:null),Oe(n,fe.Content,p),Oe(n,fe.EncItemKey,u),n)));case 23:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(s=je(o.a.mark((function e(r){var n,a,i,s,c,u,l,f,p,y,h,v,d,m;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.encryptedParameters,a=r.key,(i=n.getContentFormat())!==ie.DecryptedBareObject&&i!==ie.DecryptedBase64String){e.next=4;break}return e.abrupt("return",Ce(Re(t.prototype),"generateDecryptedParameters",this).call(this,{encryptedParameters:n,key:a}));case 4:if(n.enc_item_key){e.next=7;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",n);case 7:if(a&&a.itemsKey){e.next=9;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 9:return s=n.enc_item_key,c=this.encryptionComponentsFromString(s,a.itemsKey,a.dataAuthenticationKey),e.next=13,this.decryptTextParams(c);case 13:if(u=e.sent){e.next=17;break}return console.error("Error decrypting item_key parameters",n),e.abrupt("return",uo({encryptionParameters:n,override:(l={},Oe(l,fe.ErrorDecrypting,!0),Oe(l,fe.ErrorDecryptingChanged,!n.errorDecrypting),l)}));case 17:return e.next=19,this.firstHalfOfKey(u);case 19:return f=e.sent,e.next=22,this.secondHalfOfKey(u);case 22:return p=e.sent,y=this.encryptionComponentsFromString(n.content,f,p),e.next=26,this.decryptTextParams(y);case 26:if(h=e.sent){e.next=31;break}return e.abrupt("return",uo({encryptionParameters:n,override:(v={},Oe(v,fe.ErrorDecrypting,!0),Oe(v,fe.ErrorDecryptingChanged,!n.errorDecrypting),v)}));case 31:return e.prev=31,e.t0=JSON,e.next=35,Object(se.base64Decode)(y.authParams);case 35:e.t1=e.sent,m=e.t0.parse.call(e.t0,e.t1),e.next=41;break;case 39:e.prev=39,e.t2=e.catch(31);case 41:return e.abrupt("return",uo({encryptionParameters:n,override:(d={},Oe(d,fe.Content,JSON.parse(h)),Oe(d,fe.Legacy003AuthParams,m),Oe(d,fe.ErrorDecrypting,!1),Oe(d,fe.ErrorDecryptingChanged,!0===n.errorDecrypting),Oe(d,fe.WaitingForKey,!1),d)}));case 42:case"end":return e.stop()}}),e,this,[[31,39]])}))),function(e){return s.apply(this,arguments)})},{key:"deriveKey",value:(i=je(o.a.mark((function e(){var t,r,n,a,i,s,c,u=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=u.length>0&&void 0!==u[0]?u[0]:{},r=t.password,n=t.pwSalt,(a=t.pwCost)&&n&&r){e.next=3;break}throw"Attempting to 003.deriveKey with invalid parameters";case 3:return e.next=5,this.crypto.pbkdf2(r,n,a,768);case 5:return i=e.sent,e.next=8,this.splitKey({key:i,numParts:3});case 8:return s=e.sent,e.next=11,re.Create({content:{serverPassword:s[0],masterKey:s[1],dataAuthenticationKey:s[2],version:this.constructor.versionString()}});case 11:return c=e.sent,e.abrupt("return",c);case 13:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"encryptionComponentsFromString",value:function(e,t,r){var n=e.split(":");return{encryptionVersion:n[0],authHash:n[1],uuid:n[2],iv:n[3],contentCiphertext:n[4],ciphertextToAuth:[n[0],n[2],n[3],n[4]].join(":"),encryptionKey:t,authKey:r}}}],a=[{key:"pwCost",value:function(){return 3e3}},{key:"versionString",value:function(){return q.V002}}],n&&Ee(r.prototype,n),a&&Ee(r,a),t}(Se);function Me(e){return(Me="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ke(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Le(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ke(o,n,a,i,s,"next",e)}function s(e){Ke(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Fe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ne(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ue(e,t){return!t||"object"!==Me(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Be(e){return(Be=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ve(e,t){return(Ve=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var He=function(e){function t(){return Fe(this,t),Ue(this,Be(t).apply(this,arguments))}var r,n,a,i,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ve(e,t)}(t,e),r=t,n=[{key:"computeRootKey",value:(c=Le(o.a.mark((function e(t){var r,n,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.password,(n=t.keyParams).isKeyParamsObject){e.next=3;break}throw"Attempting to compute root key with non params object.";case 3:return a=this.constructor.pwCost(),i=this.constructor.versionString(),e.next=7,this.generateSalt(n.identifier,i,a,n.seed);case 7:return s=e.sent,e.next=10,this.deriveKey({password:r,pwSalt:s,pwCost:a});case 10:return c=e.sent,e.abrupt("return",c);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"createRootKey",value:(s=Le(o.a.mark((function e(t){var r,n,a,i,s,c,u,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.identifier,n=t.password,a=this.constructor.versionString(),i=this.constructor.pwCost(),e.next=5,this.crypto.generateRandomKey(256);case 5:return s=e.sent,e.next=8,this.generateSalt(r,a,i,s);case 8:return c=e.sent,e.next=11,this.deriveKey({password:n,pwSalt:c,pwCost:i});case 11:return u=e.sent,l=ae({identifier:r,pw_cost:i,pw_nonce:s,version:a}),e.abrupt("return",{key:u,keyParams:l});case 14:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"generateSalt",value:(i=Le(o.a.mark((function e(t,r,n,a){var i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.sha256([t,"SF",r,n,a].join(":"));case 2:return i=e.sent,e.abrupt("return",i);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return i.apply(this,arguments)})}],a=[{key:"pwCost",value:function(){return 11e4}},{key:"versionString",value:function(){return q.V003}}],n&&Ne(r.prototype,n),a&&Ne(r,a),t}(Te);function We(e){return(We="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ze(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function qe(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Ye(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){qe(o,n,a,i,s,"next",e)}function s(e){qe(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Ge(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Je(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Qe(e,t){return!t||"object"!==We(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function $e(e,t,r){return($e="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Xe(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Xe(e){return(Xe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ze(e,t){return(Ze=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var et=function(e){function t(){return Ge(this,t),Qe(this,Xe(t).apply(this,arguments))}var r,n,a,s,c,u,l,f,p,y,h,v,d;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ze(e,t)}(t,e),r=t,n=[{key:"generateNewItemsKeyContent",value:(d=Ye(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(256);case 2:return t=e.sent,r=this.constructor.versionString(),e.abrupt("return",{itemsKey:t,version:r});case 5:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"generateSalt",value:(v=Ye(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.identifier,n=t.seed,e.next=3,this.crypto.sha256([r,n].join(":"));case 3:return a=e.sent,e.abrupt("return",Object(i.y)(a,128));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"computeRootKey",value:(h=Ye(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.password,(n=t.keyParams).isKeyParamsObject){e.next=3;break}throw"Attempting to compute root key with non params object.";case 3:return e.next=5,this.generateSalt({identifier:n.identifier,seed:n.seed});case 5:return a=e.sent,e.next=8,this.deriveKey({password:r,salt:a,iterations:this.constructor.kdfIterations()});case 8:return i=e.sent,e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"createRootKey",value:(y=Ye(o.a.mark((function e(t){var r,n,a,i,s,c,u,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.identifier,n=t.password,a=this.constructor.versionString(),i=this.constructor.kdfIterations(),e.next=5,this.crypto.generateRandomKey(256);case 5:return s=e.sent,e.next=8,this.generateSalt({identifier:r,seed:s});case 8:return c=e.sent,e.next=11,this.deriveKey({password:n,salt:c,iterations:i});case 11:return u=e.sent,l=ae({identifier:r,pw_cost:i,pw_nonce:s,version:a}),e.abrupt("return",{key:u,keyParams:l});case 14:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"encryptString",value:(p=Ye(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.plaintext,n=t.rawKey,a=t.nonce,i=t.aad,a){e.next=3;break}throw"encryptString null nonce";case 3:if(n){e.next=5;break}throw"encryptString null rawKey";case 5:return e.abrupt("return",this.crypto.xchacha20Encrypt(r,a,n,JSON.stringify(i)));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"decryptString",value:(f=Ye(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.ciphertext,n=t.rawKey,a=t.nonce,i=t.aad,e.abrupt("return",this.crypto.xchacha20Decrypt(r,a,n,JSON.stringify(i)));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"generateEncryptedProtocolString",value:(l=Ye(o.a.mark((function e(t){var r,n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.plaintext,n=t.rawKey,a=t.itemUuid,e.next=3,this.crypto.generateRandomKey(192);case 3:return i=e.sent,s=this.constructor.versionString(),e.next=7,this.encryptString({plaintext:r,rawKey:n,nonce:i,aad:{u:a,v:s}});case 7:return c=e.sent,u=[s,i,c].join(":"),e.abrupt("return",u);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"generateEncryptionParameters",value:(u=Ye(o.a.mark((function e(r){var n,a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=r.payload,i=r.key,(s=r.format)!==ie.DecryptedBareObject&&s!==ie.DecryptedBase64String){e.next=3;break}return e.abrupt("return",$e(Xe(t.prototype),"generateEncryptionParameters",this).call(this,{payload:a,key:i,format:s}));case 3:if(s===ie.EncryptedString){e.next=5;break}throw"Unsupport format for generateEncryptionParameters ".concat(s);case 5:if(i&&i.itemsKey){e.next=7;break}throw"Attempting to generateEncryptionParameters with no itemsKey.";case 7:return e.next=9,this.crypto.generateRandomKey(256);case 9:return c=e.sent,u=JSON.stringify(a.content),e.next=13,this.generateEncryptedProtocolString({plaintext:u,rawKey:c});case 13:return l=e.sent,e.next=16,this.generateEncryptedProtocolString({plaintext:c,rawKey:i.itemsKey});case 16:return f=e.sent,e.abrupt("return",co((ze(n={},fe.ItemsKeyId,i.isItemsKey?i.uuid:null),ze(n,fe.Content,l),ze(n,fe.EncItemKey,f),n)));case 18:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(c=Ye(o.a.mark((function e(r){var n,a,i,s,c,u,l,f,p,y;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.encryptedParameters,a=r.key,(i=n.getContentFormat())!==ie.DecryptedBareObject&&i!==ie.DecryptedBase64String){e.next=4;break}return e.abrupt("return",$e(Xe(t.prototype),"generateDecryptedParameters",this).call(this,{encryptedParameters:n,key:a}));case 4:if(a&&a.itemsKey){e.next=6;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 6:return s=this.deconstructEncryptedPayloadString(n.enc_item_key),e.next=9,this.decryptString({ciphertext:s.ciphertext,rawKey:a.itemsKey,nonce:s.nonce,aad:{u:s.uuid,v:s.version}});case 9:if(c=e.sent){e.next=13;break}return console.error("Error decrypting itemKey parameters",n),e.abrupt("return",uo({encryptionParameters:n,override:(u={},ze(u,fe.ErrorDecrypting,!0),ze(u,fe.ErrorDecryptingChanged,!n.errorDecrypting),u)}));case 13:return l=this.deconstructEncryptedPayloadString(n.content),e.next=16,this.decryptString({ciphertext:l.ciphertext,rawKey:c,nonce:l.nonce,aad:{u:l.uuid,v:l.version}});case 16:if(f=e.sent){e.next=21;break}return e.abrupt("return",uo({encryptionParameters:n,override:(p={},ze(p,fe.ErrorDecrypting,!0),ze(p,fe.ErrorDecryptingChanged,!n.errorDecrypting),p)}));case 21:return e.abrupt("return",uo({encryptionParameters:n,override:(y={},ze(y,fe.Content,JSON.parse(f)),ze(y,fe.ErrorDecrypting,!1),ze(y,fe.ErrorDecryptingChanged,!0===n.errorDecrypting),ze(y,fe.WaitingForKey,!1),y)}));case 22:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"deconstructEncryptedPayloadString",value:function(e){var t=e.split(":");return{version:t[0],nonce:t[1],ciphertext:t[2]}}},{key:"deriveKey",value:(s=Ye(o.a.mark((function e(){var t,r,n,a,i,s,c,u,l=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=l.length>0&&void 0!==l[0]?l[0]:{},r=t.password,n=t.salt,(a=t.iterations)&&n&&r){e.next=3;break}throw"Attempting to 004.deriveKey with invalid parameters";case 3:return e.next=5,this.crypto.argon2(r,n,a,67108864,64);case 5:return i=e.sent,e.next=8,this.splitKey({key:i,numParts:2});case 8:return s=e.sent,c=s[0],u=s[1],e.abrupt("return",re.Create({content:{masterKey:c,serverPassword:u,version:this.constructor.versionString()}}));case 12:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})}],a=[{key:"versionString",value:function(){return q.V004}},{key:"kdfIterations",value:function(){return 5}}],n&&Je(r.prototype,n),a&&Je(r,a),t}(He);function tt(e){return(tt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function rt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function nt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function at(e,t){return!t||"object"!==tt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ot(e,t,r){return(ot="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=it(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function it(e){return(it=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function st(e,t){return(st=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ct=function(e){function t(){return rt(this,t),at(this,it(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&st(e,t)}(t,e),r=t,a=[{key:"FromRaw",value:function(e){return new t(no({object:{content:e}}))}}],(n=[{key:"strategyWhenConflictingWithItem",value:function(e){var r=e.item;return this.errorDecrypting?ot(it(t.prototype),"strategyWhenConflictingWithItem",this).call(this,{item:r}):oa.KeepLeft}},{key:"content_type",get:function(){return c.ItemsKey}},{key:"version",get:function(){return this.content.version}},{key:"isItemsKey",get:function(){return!0}},{key:"isDefault",get:function(){return this.content.isDefault}},{key:"itemsKey",get:function(){return this.content.itemsKey}},{key:"dataAuthenticationKey",get:function(){if(this.version===q.V004)throw"Attempting to access legacy data authentication key.";return this.content.dataAuthenticationKey}}])&&nt(r.prototype,n),a&&nt(r,a),t}(z);function ut(e){return(ut="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function lt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ft(e,t){return!t||"object"!==ut(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function pt(e,t,r){return(pt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=yt(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function yt(e){return(yt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ht(e,t){return(ht=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var vt="editor-editor",dt="themes",mt="editor-stack",bt="note-tags",gt="rooms",wt="modal",kt=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=ft(this,yt(t).call(this,e))).componentData||(r.componentData={}),r.disassociatedItemIds||(r.disassociatedItemIds=[]),r.associatedItemIds||(r.associatedItemIds=[]),r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ht(e,t)}(t,e),r=t,a=[{key:"associativeAreas",value:function(){return[vt]}}],(n=[{key:"mapContentToLocalProperties",value:function(e){pt(yt(t.prototype),"mapContentToLocalProperties",this).call(this,e),e.hosted_url||(this.legacy_url=e.url),this.local_url=e.local_url,this.hosted_url=e.hosted_url||e.url,this.offlineOnly=e.offlineOnly,this.name=e.name,this.autoupdateDisabled=e.autoupdateDisabled,this.package_info=e.package_info,this.area=e.area,this.active=e.active,this.permissions=e.permissions,this.permissions||(this.permissions=[]),e.valid_until&&(this.valid_until=new Date(e.valid_until)),this.componentData=e.componentData||{},this.disassociatedItemIds=e.disassociatedItemIds||[],this.associatedItemIds=e.associatedItemIds||[]}},{key:"handleDeletedContent",value:function(){pt(yt(t.prototype),"handleDeletedContent",this).call(this),this.active=!1}},{key:"structureParams",value:function(){var e={legacy_url:this.legacy_url,hosted_url:this.hosted_url,local_url:this.local_url,valid_until:this.valid_until,offlineOnly:this.offlineOnly,name:this.name,area:this.area,package_info:this.package_info,permissions:this.permissions,active:this.active,autoupdateDisabled:this.autoupdateDisabled,componentData:this.componentData,disassociatedItemIds:this.disassociatedItemIds,associatedItemIds:this.associatedItemIds},r=pt(yt(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"strategyWhenConflictingWithItem",value:function(e){var r=e.item;return this.errorDecrypting?pt(yt(t.prototype),"strategyWhenConflictingWithItem",this).call(this,{item:r}):oa.KeepLeft}},{key:"isEditor",value:function(){return this.area===vt}},{key:"isTheme",value:function(){return this.content_type===c.Theme||this.area===dt}},{key:"isDefaultEditor",value:function(){return!0===this.getAppDataItem("defaultEditor")}},{key:"setLastSize",value:function(e){this.setAppDataItem("lastSize",e)}},{key:"getLastSize",value:function(){return this.getAppDataItem("lastSize")}},{key:"acceptsThemes",value:function(){return!this.content.package_info||!0===this.content.package_info.acceptsThemes}},{key:"getClientDataKey",value:function(){return this.legacy_url?this.legacy_url:this.uuid}},{key:"hasValidHostedUrl",value:function(){return this.hosted_url||this.legacy_url}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["active","disassociatedItemIds","associatedItemIds"].concat(pt(yt(t.prototype),"contentKeysToIgnoreWhenCheckingEquality",this).call(this))}},{key:"isAssociative",value:function(){return t.associativeAreas().includes(this.area)}},{key:"associateWithItem",value:function(e){this.associatedItemIds.push(e.uuid)}},{key:"isExplicitlyEnabledForItem",value:function(e){return-1!==this.associatedItemIds.indexOf(e.uuid)}},{key:"isExplicitlyDisabledForItem",value:function(e){return-1!==this.disassociatedItemIds.indexOf(e.uuid)}},{key:"content_type",get:function(){return c.Component}}])&&lt(r.prototype,n),a&&lt(r,a),t}(z),xt=r(92),St=r.n(xt),Pt=r(5),Ot=r.n(Pt),_t=r(3),jt=r.n(_t),It=r(2),Et=r.n(It);function Dt(e){return(Dt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ct(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Rt(e,t){return!t||"object"!==Dt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function At(e,t,r){return(At="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Tt(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Tt(e){return(Tt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Mt(e,t){return(Mt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Kt=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Rt(this,Tt(t).call(this,e))).notes||(r.notes=[]),r.data||(r.data={}),r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Mt(e,t)}(t,e),r=t,(n=[{key:"mapContentToLocalProperties",value:function(e){At(Tt(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.url=e.url,this.name=e.name,this.data=e.data||{},this.default=e.default,this.systemEditor=e.systemEditor}},{key:"structureParams",value:function(){var e={url:this.url,name:this.name,data:this.data,default:this.default,systemEditor:this.systemEditor},r=At(Tt(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"referenceParams",value:function(){return St()(this.notes,(function(e){return{uuid:e.uuid,content_type:e.content_type}}))}},{key:"addItemAsRelationship",value:function(e){e.content_type===c.Note&&(Ot()(this.notes,e)||this.notes.push(e)),At(Tt(t.prototype),"addItemAsRelationship",this).call(this,e)}},{key:"removeItemAsRelationship",value:function(e){e.content_type===c.Note&&jt()(this.notes,e),At(Tt(t.prototype),"removeItemAsRelationship",this).call(this,e)}},{key:"removeAndDirtyAllRelationships",value:function(){At(Tt(t.prototype),"removeAndDirtyAllRelationships",this).call(this),this.notes=[]}},{key:"removeReferencesNotPresentIn",value:function(e){var r=this;At(Tt(t.prototype),"removeReferencesNotPresentIn",this).call(this,e);var n=e.map((function(e){return e.uuid}));this.notes.forEach((function(e){n.includes(e.uuid)||Et()(r.notes,{uuid:e.uuid})}))}},{key:"setData",value:function(e,t){return!(JSON.stringify(this.data[e])===JSON.stringify(t)||(this.data[e]=t,0))}},{key:"dataForKey",value:function(e){return this.data[e]||{}}},{key:"content_type",get:function(){return c.Editor}}])&&Ct(r.prototype,n),a&&Ct(r,a),t}(z),Lt=r(93),Ft=r.n(Lt),Nt=r(35),Ut=r.n(Nt);var Bt=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ut()(this,t),this.running=!1,this.error=!1,this.lastExecuted&&(this.lastExecuted=new Date(this.lastExecuted))};function Vt(e){return(Vt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ht(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Wt(e,t){return!t||"object"!==Vt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function zt(e,t,r){return(zt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=qt(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function qt(e){return(qt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Yt(e,t){return(Yt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Gt=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=Wt(this,qt(t).call(this,e)),e.actions&&(r.actions=e.actions.map((function(e){return new Bt(e)}))),r.actions||(r.actions=[]),r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Yt(e,t)}(t,e),r=t,(n=[{key:"actionsWithContextForItem",value:function(e){return this.actions.filter((function(t){return t.context===e.content_type||"Item"===t.context}))}},{key:"mapContentToLocalProperties",value:function(e){zt(qt(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.description=e.description,this.url=e.url,this.name=e.name,this.package_info=e.package_info,this.supported_types=e.supported_types,e.actions&&(this.actions=e.actions.map((function(e){return new Bt(e)})))}},{key:"structureParams",value:function(){var e={name:this.name,url:this.url,package_info:this.package_info,description:this.description,actions:this.actions.map((function(e){return Ft()(e,["subrows","subactions"])})),supported_types:this.supported_types},r=zt(qt(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"content_type",get:function(){return c.ActionsExtension}}])&&Ht(r.prototype,n),a&&Ht(r,a),t}(z);function Jt(e){return(Jt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Qt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function $t(e,t){return!t||"object"!==Jt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Xt(e,t,r){return(Xt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Zt(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Zt(e){return(Zt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function er(e,t){return(er=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tr=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=$t(this,Zt(t).call(this,e))).content_type||(r.content_type=c.Tag),r.notes||(r.notes=[]),r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&er(e,t)}(t,e),r=t,a=[{key:"arrayToDisplayString",value:function(e){return e.sort((function(e,t){return e.title>t.title})).map((function(e,t){return"#"+e.title})).join(" ")}}],(n=[{key:"mapContentToLocalProperties",value:function(e){Xt(Zt(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.title=e.title}},{key:"structureParams",value:function(){var e={title:this.title},r=Xt(Zt(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"addItemAsRelationship",value:function(e){e.content_type===c.Note&&(Object(i.g)(this.notes,"uuid",e.uuid)||this.notes.push(e)),Xt(Zt(t.prototype),"addItemAsRelationship",this).call(this,e)}},{key:"removeItemAsRelationship",value:function(e){e.content_type===c.Note&&Et()(this.notes,{uuid:e.uuid}),Xt(Zt(t.prototype),"removeItemAsRelationship",this).call(this,e)}},{key:"updateLocalRelationships",value:function(){var e=this,t=this.content.references.map((function(e){return e.uuid}));this.notes.slice().forEach((function(r){t.includes(r.uuid)||(Et()(e.notes,{uuid:r.uuid}),r.setIsNoLongerReferencedBy(e))}))}},{key:"isBeingRemovedLocally",value:function(){var e=this;this.notes.forEach((function(t){t.setIsNoLongerReferencedBy(e)})),this.notes.length=0,Xt(Zt(t.prototype),"isBeingRemovedLocally",this).call(this)}},{key:"didCompleteMapping",value:function(e){var t=!0,r=!1,n=void 0;try{for(var a,o=this.notes[Symbol.iterator]();!(t=(a=o.next()).done);t=!0)a.value.tagDidCompleteMapping(this)}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}}},{key:"isSmartTag",value:function(){return this.content_type===c.SmartTag}}])&&Qt(r.prototype,n),a&&Qt(r,a),t}(z);function rr(e){return(rr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function nr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ar(e,t){return!t||"object"!==rr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function or(e,t,r){return(or="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ir(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function ir(e){return(ir=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function sr(e,t){return(sr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var cr=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=ar(this,ir(t).call(this,e))).text||(r.text=""),r.tags||(r.tags=[]),r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&sr(e,t)}(t,e),r=t,a=[{key:"filterDummyNotes",value:function(e){return e.filter((function(e){return!e.dummy}))}}],(n=[{key:"mapContentToLocalProperties",value:function(e){or(ir(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.title=e.title,this.text=e.text}},{key:"structureParams",value:function(){var e={title:this.title,text:this.text},r=or(ir(t.prototype),"structureParams",this).call(this);return Object.assign(r,e),r}},{key:"addItemAsRelationship",value:function(e){e.content_type===c.Tag&&e.addItemAsRelationship(this),or(ir(t.prototype),"addItemAsRelationship",this).call(this,e)}},{key:"setIsBeingReferencedBy",value:function(e){e.content_type===c.Tag&&(Object(i.g)(this.tags,"uuid",e.uuid)||this.tags.push(e)),or(ir(t.prototype),"setIsBeingReferencedBy",this).call(this,e),this.clearSavedTagsString()}},{key:"setIsNoLongerReferencedBy",value:function(e){or(ir(t.prototype),"setIsNoLongerReferencedBy",this).call(this,e),e.content_type===c.Tag&&Object(i.u)(this.tags,e),e.content_type===c.Tag&&this.hasRelationshipWithItem(e)&&this.removeReferenceWithUuid(e.uuid),this.clearSavedTagsString()}},{key:"tagDidCompleteMapping",value:function(e){this.clearSavedTagsString()}},{key:"safeText",value:function(){return this.text||""}},{key:"safeTitle",value:function(){return this.title||""}},{key:"clearSavedTagsString",value:function(){this.savedTagsString=null}},{key:"tagsString",value:function(){return this.savedTagsString=tr.arrayToDisplayString(this.tags),this.savedTagsString}},{key:"content_type",get:function(){return c.Note}}])&&nr(r.prototype,n),a&&nr(r,a),t}(z);function ur(e){return(ur="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function lr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function fr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function pr(e,t){return!t||"object"!==ur(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function yr(e){return(yr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function hr(e,t){return(hr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var vr=function(e){function t(){return lr(this,t),pr(this,yr(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&hr(e,t)}(t,e),r=t,a=[{key:"contentType",value:function(){return c.UserPrefs}}],(n=[{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new v("content_type","=",this.content_type)}}])&&fr(r.prototype,n),a&&fr(r,a),t}(z);function dr(e){return(dr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function mr(e,t){return!t||"object"!==dr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function br(e){return(br=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function gr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function wr(e,t,r){return t&&gr(e.prototype,t),r&&gr(e,r),e}function kr(e,t){return(kr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xr=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=mr(this,br(t).call(this,e))).errorDecrypting||r.content.desktopPrivileges||(r.content.desktopPrivileges={}),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&kr(e,t)}(t,e),wr(t,null,[{key:"contentType",value:function(){return c.Privileges}}]),wr(t,[{key:"setCredentialsForAction",value:function(e,t){this.content.desktopPrivileges[e]=t}},{key:"getCredentialsForAction",value:function(e){return this.content.desktopPrivileges[e]||[]}},{key:"toggleCredentialForAction",value:function(e,t){this.isCredentialRequiredForAction(e,t)?this.removeCredentialForAction(e,t):this.addCredentialForAction(e,t)}},{key:"removeCredentialForAction",value:function(e,t){jt()(this.content.desktopPrivileges[e],t)}},{key:"addCredentialForAction",value:function(e,t){var r=this.getCredentialsForAction(e);r.push(t),this.setCredentialsForAction(e,r)}},{key:"isCredentialRequiredForAction",value:function(e,t){return this.getCredentialsForAction(e).includes(t)}},{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new v("content_type","=",this.content_type)}}]),t}(z);function Sr(e){return(Sr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Pr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Or(e,t){return!t||"object"!==Sr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function _r(e){return(_r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function jr(e,t){return(jr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ir=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Or(this,_r(t).call(this,e))).content_type=c.SmartTag,r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&jr(e,t)}(t,e),r=t,a=[{key:"systemSmartTags",value:function(){var e=no({object:{uuid:"all-notes",dummy:!0,content:{title:"All notes",isSystemTag:!0,isAllTag:!0,predicate:new v.FromArray(["content_type","=",c.Note])}}}),r=no({object:{uuid:"archived-notes",dummy:!0,content:{title:"Archived",isSystemTag:!0,isArchiveTag:!0,predicate:new v.FromArray(["archived","=",!0])}}}),n=no({object:{uuid:"trashed-notes",dummy:!0,content:{title:"Trash",isSystemTag:!0,isTrashTag:!0,predicate:new v.FromArray(["content.trashed","=",!0])}}});return[new t(e),new t(r),new t(n)]}}],(n=null)&&Pr(r.prototype,n),a&&Pr(r,a),t}(tr);function Er(e){return(Er="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Dr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Cr(e,t){return!t||"object"!==Er(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Rr(e,t,r){return(Rr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ar(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Ar(e){return(Ar=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Tr(e,t){return(Tr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Mr=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Cr(this,Ar(t).call(this,e))).area="themes",r}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Tr(e,t)}(t,e),r=t,(n=[{key:"isLayerable",value:function(){return this.package_info&&this.package_info.layerable}},{key:"strategyWhenConflictingWithItem",value:function(e){var r=e.item;return this.errorDecrypting?Rr(Ar(t.prototype),"strategyWhenConflictingWithItem",this).call(this,{item:r}):oa.KeepLeft}},{key:"setMobileRules",value:function(e){this.setAppDataItem("mobileRules",e)}},{key:"getMobileRules",value:function(){return this.getAppDataItem("mobileRules")||{constants:{},rules:{}}}},{key:"hasMobileRules",value:function(){return this.getAppDataItem("mobileRules")}},{key:"setNotAvailOnMobile",value:function(e){this.setAppDataItem("notAvailableOnMobile",e)}},{key:"getNotAvailOnMobile",value:function(){return this.getAppDataItem("notAvailableOnMobile")}},{key:"setMobileActive",value:function(e){this.setAppDataItem("mobileActive",e)}},{key:"isMobileActive",value:function(){return this.getAppDataItem("mobileActive")}},{key:"content_type",get:function(){return c.Theme}}])&&Dr(r.prototype,n),a&&Dr(r,a),t}(kt);function Kr(e){return(Kr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Lr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Fr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Nr(e,t){return!t||"object"!==Kr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ur(e,t,r){return(Ur="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Br(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Br(e){return(Br=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Vr(e,t){return(Vr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Hr,Wr=function(e){function t(){return Lr(this,t),Nr(this,Br(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Vr(e,t)}(t,e),r=t,(n=[{key:"mapContentToLocalProperties",value:function(e){Ur(Br(t.prototype),"mapContentToLocalProperties",this).call(this,e),this.storage=e.storage}},{key:"content_type",get:function(){return c.EncryptedStorage}}])&&Fr(r.prototype,n),a&&Fr(r,a),t}(z);function zr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var qr=(zr(Hr={},c.Note,cr),zr(Hr,c.Tag,tr),zr(Hr,c.ItemsKey,ct),zr(Hr,c.SmartTag,Ir),zr(Hr,c.ActionsExtension,Gt),zr(Hr,c.Editor,Kt),zr(Hr,c.Theme,Mr),zr(Hr,c.Component,kt),zr(Hr,c.Privileges,xr),zr(Hr,c.UserPrefs,vr),Hr);function Yr(e){if(!e.isPayload)throw"Attempting to create item from non-payload object.";return new(qr[e.content_type]||z)(e)}function Gr(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Jr(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Gr(o,n,a,i,s,"next",e)}function s(e){Gr(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Qr(e){return $r.apply(this,arguments)}function $r(){return($r=Jr(o.a.mark((function e(t){var r,n,a,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.payload,n=t.baseCollection,a=t.isConflict,s=[],e.next=4,U.GenerateUuid();case 4:return e.t0=e.sent,c={uuid:e.t0,dirty:!0,dirtiedDate:null,lastSyncBegan:null,lastSyncEnd:null},a&&(c.content={conflict_of:r.uuid}),u=so({payload:r,override:c}),s.push(u),l=n.payloadsThatReferencePayload(r),e.next=12,en({payloads:l,add:[{uuid:u.uuid,content_type:u.content_type}]});case 12:return f=e.sent,Object(i.f)(s,f),e.abrupt("return",s);case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Xr(e){return Zr.apply(this,arguments)}function Zr(){return(Zr=Jr(o.a.mark((function e(t){var r,n,a,s,c,u,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.payload,n=t.baseCollection,a=[],e.t0=so,e.t1=r,e.next=6,U.GenerateUuid();case 6:return e.t2=e.sent,e.t3={uuid:e.t2,dirty:!0},e.t4={payload:e.t1,override:e.t3},s=(0,e.t0)(e.t4),a.push(s),c=n.payloadsThatReferencePayload(r),e.next=14,en({payloads:c,add:[{uuid:s.uuid,content_type:s.content_type}],removeIds:[r.uuid]});case 14:return u=e.sent,Object(i.f)(a,u),l=so({payload:r,override:{deleted:!0,dirty:!1,content:{references:[]}}}),a.push(l),e.abrupt("return",a);case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function en(e){return tn.apply(this,arguments)}function tn(){return(tn=Jr(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p,y,h,v,d,m,b,g,w,k,x,S,P,O,_;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.payloads,n=t.add,a=t.removeIds,i=[],s=!0,c=!1,u=void 0,e.prev=5,l=r[Symbol.iterator]();case 7:if(s=(f=l.next()).done){e.next=55;break}if(p=f.value,y=p.content.references.slice(),!n){e.next=30;break}for(h=!0,v=!1,d=void 0,e.prev=14,m=n[Symbol.iterator]();!(h=(b=m.next()).done);h=!0)g=b.value,y.push(g);e.next=22;break;case 18:e.prev=18,e.t0=e.catch(14),v=!0,d=e.t0;case 22:e.prev=22,e.prev=23,h||null==m.return||m.return();case 25:if(e.prev=25,!v){e.next=28;break}throw d;case 28:return e.finish(25);case 29:return e.finish(22);case 30:if(!a){e.next=50;break}for(w=!0,k=!1,x=void 0,e.prev=34,S=a[Symbol.iterator]();!(w=(P=S.next()).done);w=!0)O=P.value,Et()(y,{uuid:O});e.next=42;break;case 38:e.prev=38,e.t1=e.catch(34),k=!0,x=e.t1;case 42:e.prev=42,e.prev=43,w||null==S.return||S.return();case 45:if(e.prev=45,!k){e.next=48;break}throw x;case 48:return e.finish(45);case 49:return e.finish(42);case 50:_=so({payload:p,override:{dirty:!0,content:{references:y}}}),i.push(_);case 52:s=!0,e.next=7;break;case 55:e.next=61;break;case 57:e.prev=57,e.t2=e.catch(5),c=!0,u=e.t2;case 61:e.prev=61,e.prev=62,s||null==l.return||l.return();case 64:if(e.prev=64,!c){e.next=67;break}throw u;case 67:return e.finish(64);case 68:return e.finish(61);case 69:return e.abrupt("return",i);case 70:case"end":return e.stop()}}),e,null,[[5,57,61,69],[14,18,22,30],[23,,25,29],[34,38,42,50],[43,,45,49],[62,,64,68]])})))).apply(this,arguments)}var rn={RemoteRetrieved:1,RemoteSaved:2,LocalSaved:3,LocalRetrieved:4,LocalDirtied:5,ComponentRetrieved:6,DesktopInstalled:7,RemoteActionRetrieved:8,FileImport:9,RemoteConflict:10,ImportConflict:11,SaveOrSaving:12,DecryptedTransient:13,ConflictUuid:14,ConflictData:15};function nn(e){return[rn.RemoteRetrieved,rn.ComponentRetrieved,rn.RemoteActionRetrieved].includes(e)}function an(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var on=function(){function e(t,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t.isItem)throw"Cannot create payload from item directly";if(!r)throw"Do not construct payloads directly. Use generator functions";var n=!0,a=!1,o=void 0;try{for(var s,c=this.constructor.fields()[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var u=s.value,l=t[u];Object(i.l)(l)||(this[u]=l)}}catch(e){a=!0,o=e}finally{try{n||null==c.return||c.return()}finally{if(a)throw o}}}var t,r,n;return t=e,n=[{key:"fields",value:function(){throw"Must override PurePayload.fields"}}],(r=[{key:"mergedWith",value:function(e){return so({payload:this,override:e})}},{key:"fields",value:function(){return this.constructor.fields()}},{key:"getFormat",value:function(){if(Object(i.n)(this.content))return this.content.startsWith(q.V000Base64Decrypted)?ie.DecryptedBase64String:ie.EncryptedString;if(Object(i.m)(this.content))return ie.DecryptedBareObject;throw"Unhandle content format for payload.getFormat()"}},{key:"version",get:function(){return Object(i.n)(this.content)?this.content.substring(0,q.VersionLength):this.content.version}},{key:"isPayload",get:function(){return!0}}])&&an(t.prototype,r),n&&an(t,n),e}();function sn(e){return(sn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function cn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function un(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ln(e,t){return!t||"object"!==sn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function fn(e){return(fn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function pn(e,t){return(pn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var yn=function(e){function t(){return cn(this,t),ln(this,fn(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&pn(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){throw"Must override SNPureItemPayload.fields"}}],(n=[{key:"compareContentFields",value:function(e){var t=new z(this),r=new z(e);return t.isItemContentEqualWith(r)}},{key:"version",get:function(){return this.content.substring(0,q.VersionLength)}},{key:"discardable",get:function(){return this.deleted&&!this.dirty}}])&&un(r.prototype,n),a&&un(r,a),t}(on);function hn(e){return(hn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function vn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function dn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function mn(e,t){return!t||"object"!==hn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function bn(e){return(bn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function gn(e,t){return(gn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wn=function(e){function t(){return vn(this,t),mn(this,bn(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&gn(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[fe.Uuid,fe.ContentType,fe.ItemsKeyId,fe.EncItemKey,fe.Content,fe.CreatedAt,fe.UpdatedAt,fe.Deleted,fe.Legacy003AuthHash,fe.Legacy003AuthParams,fe.Dirty,fe.DirtiedDate,fe.ErrorDecrypting,fe.WaitingForKey]}}],(n=null)&&dn(r.prototype,n),a&&dn(r,a),t}(yn);function kn(e){return(kn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function xn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Sn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Pn(e,t){return!t||"object"!==kn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function On(e){return(On=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _n(e,t){return(_n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var jn=function(e){function t(){return xn(this,t),Pn(this,On(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_n(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[fe.Uuid,fe.ContentType,fe.ItemsKeyId,fe.EncItemKey,fe.Content,fe.CreatedAt,fe.UpdatedAt,fe.Deleted,fe.Legacy003AuthHash]}}],(n=null)&&Sn(r.prototype,n),a&&Sn(r,a),t}(yn);function In(e){return(In="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function En(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Dn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Cn(e,t){return!t||"object"!==In(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Rn(e){return(Rn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function An(e,t){return(An=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Tn=function(e){function t(){return En(this,t),Cn(this,Rn(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&An(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[fe.Uuid,fe.ContentType,fe.ItemsKeyId,fe.EncItemKey,fe.Content,fe.CreatedAt,fe.UpdatedAt,fe.Legacy003AuthHash]}}],(n=null)&&Dn(r.prototype,n),a&&Dn(r,a),t}(yn);function Mn(e){return(Mn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Kn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ln(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Fn(e,t){return!t||"object"!==Mn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Nn(e){return(Nn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Un(e,t){return(Un=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Bn=function(e){function t(){return Kn(this,t),Fn(this,Nn(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Un(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[fe.Uuid,fe.ContentType,fe.ItemsKeyId,fe.EncItemKey,fe.Content,fe.CreatedAt,fe.UpdatedAt,fe.Deleted,fe.Legacy003AuthHash,fe.Legacy003AuthParams,fe.Dirty,fe.DirtiedDate,fe.ErrorDecrypting,fe.ErrorDecryptingChanged,fe.WaitingForKey,fe.Dummy,fe.LastSyncBegan,fe.LastSyncEnd]}}],(n=null)&&Ln(r.prototype,n),a&&Ln(r,a),t}(yn);function Vn(e){return(Vn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Hn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Wn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function zn(e,t){return!t||"object"!==Vn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function qn(e){return(qn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Yn(e,t){return(Yn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Gn=function(e){function t(){return Hn(this,t),zn(this,qn(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Yn(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[fe.Uuid,fe.ContentType,fe.UpdatedAt,fe.Deleted,fe.Dirty,fe.LastSyncEnd]}}],(n=null)&&Wn(r.prototype,n),a&&Wn(r,a),t}(yn);function Jn(e){return(Jn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Qn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function $n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Xn(e,t){return!t||"object"!==Jn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Zn(e){return(Zn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ea(e,t){return(ea=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ta=function(e){function t(){return Qn(this,t),Xn(this,Zn(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ea(e,t)}(t,e),r=t,a=[{key:"fields",value:function(){return[fe.ItemsKeyId,fe.EncItemKey,fe.Content,fe.Legacy003AuthHash,fe.ErrorDecrypting,fe.ErrorDecryptingChanged,fe.WaitingForKey]}}],(n=[{key:"getContentFormat",value:function(){return"string"==typeof this.content?this.content.startsWith(q.V000Base64Decrypted)?ie.DecryptedBase64String:ie.EncryptedString:ie.DecryptedBareObject}},{key:"isEncryptionParameters",get:function(){return!0}}])&&$n(r.prototype,n),a&&$n(r,a),t}(on);function ra(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function na(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var aa=function(){function e(t){var r=t.baseCollection,n=t.applyCollection,a=t.relatedCollectionSet;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseCollection=r,this.applyCollection=n,this.relatedCollectionSet=a}var t,r,n,a,i;return t=e,(r=[{key:"resultingCollection",value:(a=o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override PayloadDelta.resultingCollection.";case 1:case"end":return e.stop()}}),e)})),i=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){ra(o,r,n,i,s,"next",e)}function s(e){ra(o,r,n,i,s,"throw",e)}i(void 0)}))},function(){return i.apply(this,arguments)})},{key:"findBasePayload",value:function(e){var t=e.id;return this.baseCollection.findPayload(t)}},{key:"findRelatedPayload",value:function(e){var t=e.id,r=e.source;return this.relatedCollectionSet.collectionForSource(r).findPayload(t)}}])&&na(t.prototype,r),n&&na(t,n),e}(),oa={KeepLeft:1,KeepRight:2,KeepLeftDuplicateRight:3,DuplicateLeftKeepRight:4,KeepLeftMergeRefs:5};function ia(e){return(ia="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function sa(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ca(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){sa(o,n,a,i,s,"next",e)}function s(e){sa(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ua(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function la(e,t){return!t||"object"!==ia(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function fa(e){return(fa=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function pa(e,t){return(pa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ya=function(e){function t(e){var r,n=e.baseCollection,a=e.basePayload,o=e.applyPayload,i=e.source;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=la(this,fa(t).call(this,{baseCollection:n}))).basePayload=a,r.applyPayload=o,r.source=i,r}var r,n,a,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&pa(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:(c=ca(o.a.mark((function e(){var t,r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Yr(this.basePayload),r=Yr(this.applyPayload),n=t.strategyWhenConflictingWithItem({item:r}),e.next=5,this.payloadsByHandlingStrategy({strategy:n});case 5:return a=e.sent,e.abrupt("return",new f({payloads:a,source:this.source}));case 7:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"payloadsByHandlingStrategy",value:(s=ca(o.a.mark((function e(t){var r,n,a,s,c,u,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.strategy)!==oa.KeepLeft){e.next=3;break}return e.abrupt("return",[this.basePayload]);case 3:if(r!==oa.KeepRight){e.next=5;break}return e.abrupt("return",[this.applyPayload]);case 5:if(r!==oa.KeepLeftDuplicateRight){e.next=12;break}return n=Object(i.i)(this.basePayload.updated_at,this.applyPayload.updated_at),a=so({payload:this.basePayload,override:{updated_at:n,dirty:!0}}),e.next=10,Qr({payload:this.applyPayload,baseCollection:this.baseCollection,isConflict:!0});case 10:return s=e.sent,e.abrupt("return",[a].concat(s));case 12:if(r!==oa.DuplicateLeftKeepRight){e.next=18;break}return e.next=15,Qr({payload:this.basePayload,baseCollection:this.baseCollection,isConflict:!0});case 15:return c=e.sent,u=this.applyPayload,e.abrupt("return",c.concat([u]));case 18:if(r!==oa.KeepLeftMergeRefs){e.next=23;break}return l=Object(i.z)(this.basePayload.content.references,this.applyPayload.content.references,["uuid","content_type"]),f=Object(i.i)(this.basePayload.updated_at,this.applyPayload.updated_at),p=so({payload:this.basePayload,override:{updated_at:f,dirty:!0,content:{references:l}}}),e.abrupt("return",[p]);case 23:throw"Unhandled strategy";case 24:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})}])&&ua(r.prototype,n),a&&ua(r,a),t}(aa);function ha(e){return(ha="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function va(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function da(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){va(o,n,a,i,s,"next",e)}function s(e){va(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ma(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ba(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ga(e,t){return!t||"object"!==ha(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function wa(e){return(wa=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ka(e,t){return(ka=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xa=function(e){function t(){return ma(this,t),ga(this,wa(t).apply(this,arguments))}var r,n,a,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ka(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:(c=da(o.a.mark((function e(){var t,r,n,a,s,c,u,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],r=!0,n=!1,a=void 0,e.prev=4,s=this.applyCollection.allPayloads[Symbol.iterator]();case 6:if(r=(c=s.next()).done){e.next=15;break}return u=c.value,e.next=10,this.payloadsByHandlingPayload({payload:u,currentResults:t});case 10:l=e.sent,Object(i.f)(t,l);case 12:r=!0,e.next=6;break;case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(4),n=!0,a=e.t0;case 21:e.prev=21,e.prev=22,r||null==s.return||s.return();case 24:if(e.prev=24,!n){e.next=27;break}throw a;case 27:return e.finish(24);case 28:return e.finish(21);case 29:return e.abrupt("return",new f({payloads:t,source:rn.FileImport}));case 30:case"end":return e.stop()}}),e,this,[[4,17,21,29],[22,,24,28]])}))),function(){return c.apply(this,arguments)})},{key:"payloadsByHandlingPayload",value:(s=da(o.a.mark((function e(t){var r,n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.payload,n=t.currentResults,(a=n.find((function(e){return e.content.conflict_of===r.uuid})))||(a=n.find((function(e){return e.uuid===r.uuid}))),a||(a=this.findBasePayload({id:r.uuid})),a){e.next=6;break}return e.abrupt("return",[r]);case 6:return i=new ya({baseCollection:this.baseCollection,basePayload:a,applyPayload:r}),e.next=9,i.resultingCollection();case 9:return s=e.sent,e.abrupt("return",s.allPayloads);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})}])&&ba(r.prototype,n),a&&ba(r,a),t}(aa);function Sa(e){return(Sa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Pa(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Oa(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ja(e,t){return!t||"object"!==Sa(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ia(e){return(Ia=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ea(e,t){return(Ea=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Da=function(e){function t(){return Oa(this,t),ja(this,Ia(t).apply(this,arguments))}var r,n,a,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ea(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:(s=o.a.mark((function e(){var t,r,n,a,s,c,u,l,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],r=!0,n=!1,a=void 0,e.prev=4,s=this.applyCollection.allPayloads[Symbol.iterator]();case 6:if(r=(c=s.next()).done){e.next=22;break}if(u=c.value,t.push(u),l=this.findBasePayload({id:u.uuid})){e.next=12;break}return e.abrupt("continue",19);case 12:if(o=l,y=void 0,h=void 0,y=Yr(u),h=Yr(o),!y.isItemContentEqualWith(h)){e.next=15;break}return e.abrupt("continue",19);case 15:return e.next=17,Qr({payload:l,baseCollection:this.baseCollection,isConflict:!0});case 17:p=e.sent,Object(i.f)(t,p);case 19:r=!0,e.next=6;break;case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(4),n=!0,a=e.t0;case 28:e.prev=28,e.prev=29,r||null==s.return||s.return();case 31:if(e.prev=31,!n){e.next=34;break}throw a;case 34:return e.finish(31);case 35:return e.finish(28);case 36:return e.abrupt("return",new f({payloads:t,source:rn.RemoteRetrieved}));case 37:case"end":return e.stop()}var o,y,h}),e,this,[[4,24,28,36],[29,,31,35]])})),c=function(){var e=this,t=arguments;return new Promise((function(r,n){var a=s.apply(e,t);function o(e){Pa(a,r,n,o,i,"next",e)}function i(e){Pa(a,r,n,o,i,"throw",e)}o(void 0)}))},function(){return c.apply(this,arguments)})}])&&_a(r.prototype,n),a&&_a(r,a),t}(aa);function Ca(e){return(Ca="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ra(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Aa(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ra(o,n,a,i,s,"next",e)}function s(e){Ra(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Ta(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ma(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ka(e,t){return!t||"object"!==Ca(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function La(e){return(La=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Fa(e,t){return(Fa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Na=function(e){function t(){return Ta(this,t),Ka(this,La(t).apply(this,arguments))}var r,n,a,s,c,u;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Fa(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:(u=Aa(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.applyCollection.source!==rn.ConflictUuid){e.next=4;break}return e.abrupt("return",this.collectionsByHandlingUuidConflicts());case 4:if(this.applyCollection.source!==rn.ConflictData){e.next=8;break}return e.abrupt("return",this.collectionsByHandlingDataConflicts());case 8:throw"Unhandled conflict type ".concat(this.applyCollection.source);case 9:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"collectionsByHandlingDataConflicts",value:(c=Aa(o.a.mark((function e(){var t,r,n,a,s,c,u,l,p,y,h,v;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],r=!0,n=!1,a=void 0,e.prev=4,s=this.applyCollection.allPayloads[Symbol.iterator]();case 6:if(r=(c=s.next()).done){e.next=27;break}if(u=c.value,l=this.findBasePayload({id:u.uuid})){e.next=12;break}return t.push(u),e.abrupt("continue",24);case 12:if(p=this.findRelatedPayload({id:u.uuid,source:rn.DecryptedTransient})){e.next=18;break}if(u.deleted){e.next=16;break}throw"Unable to find decrypted counterpart for data conflict.";case 16:return t.push(u),e.abrupt("continue",24);case 18:return y=new ya({baseCollection:this.baseCollection,basePayload:l,applyPayload:p}),e.next=21,y.resultingCollection();case 21:h=e.sent,v=h.allPayloads,Object(i.f)(t,v);case 24:r=!0,e.next=6;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(4),n=!0,a=e.t0;case 33:e.prev=33,e.prev=34,r||null==s.return||s.return();case 36:if(e.prev=36,!n){e.next=39;break}throw a;case 39:return e.finish(36);case 40:return e.finish(33);case 41:return e.abrupt("return",new f({payloads:t,source:rn.RemoteRetrieved}));case 42:case"end":return e.stop()}}),e,this,[[4,29,33,41],[34,,36,40]])}))),function(){return c.apply(this,arguments)})},{key:"collectionsByHandlingUuidConflicts",value:(s=Aa(o.a.mark((function e(){var t,r,n,a,s,c,u,l,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],r=!0,n=!1,a=void 0,e.prev=4,s=this.applyCollection.allPayloads[Symbol.iterator]();case 6:if(r=(c=s.next()).done){e.next=16;break}return u=c.value,l=this.findRelatedPayload({id:u.uuid,source:rn.DecryptedTransient}),e.next=11,Xr({baseCollection:this.baseCollection,payload:l});case 11:p=e.sent,Object(i.f)(t,p);case 13:r=!0,e.next=6;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(4),n=!0,a=e.t0;case 22:e.prev=22,e.prev=23,r||null==s.return||s.return();case 25:if(e.prev=25,!n){e.next=28;break}throw a;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return e.abrupt("return",new f({payloads:t,source:rn.RemoteRetrieved}));case 31:case"end":return e.stop()}}),e,this,[[4,18,22,30],[23,,25,29]])}))),function(){return s.apply(this,arguments)})}])&&Ma(r.prototype,n),a&&Ma(r,a),t}(aa);function Ua(e){return(Ua="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ba(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Va(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ha(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Wa(e,t){return!t||"object"!==Ua(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function za(e){return(za=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function qa(e,t){return(qa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ya=function(e){function t(){return Va(this,t),Wa(this,za(t).apply(this,arguments))}var r,n,a,s,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qa(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:(s=o.a.mark((function e(){var t,r,n,a,s,c,u,l,p,y,h,v,d,m,b,g,w,k;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],r=[],n=!0,a=!1,s=void 0,e.prev=5,c=this.applyCollection.allPayloads[Symbol.iterator]();case 7:if(n=(u=c.next()).done){e.next=27;break}if(l=u.value,p=this.findRelatedPayload({id:l.uuid,source:rn.SavedOrSaving}),y=this.findRelatedPayload({id:l.uuid,source:rn.DecryptedTransient})){e.next=16;break}if(l.deleted){e.next=14;break}throw"Cannot find decrypted for non-deleted payload.";case 14:return t.push(l),e.abrupt("continue",24);case 16:if(!p){e.next=19;break}return r.push(y),e.abrupt("continue",24);case 19:if(!(h=this.findBasePayload({id:l.uuid}))||!h.dirty){e.next=23;break}return r.push(y),e.abrupt("continue",24);case 23:t.push(y);case 24:n=!0,e.next=7;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(5),a=!0,s=e.t0;case 33:e.prev=33,e.prev=34,n||null==c.return||c.return();case 36:if(e.prev=36,!a){e.next=39;break}throw s;case 39:return e.finish(36);case 40:return e.finish(33);case 41:v=[],d=0,m=r;case 43:if(!(d<m.length)){e.next=60;break}if(b=m[d],g=this.findRelatedPayload({id:b.uuid,source:rn.DecryptedTransient})){e.next=48;break}return e.abrupt("continue",57);case 48:if(w=this.findBasePayload({id:b.uuid})){e.next=51;break}return e.abrupt("continue",57);case 51:if(w.compareContentFields(g)){e.next=57;break}return e.next=55,Qr({payload:g,baseCollection:this.baseCollection,isConflict:!0});case 55:k=e.sent,Object(i.f)(v,k);case 57:d++,e.next=43;break;case 60:return e.abrupt("return",new f({payloads:t.concat(v),source:rn.RemoteRetrieved}));case 61:case"end":return e.stop()}}),e,this,[[5,29,33,41],[34,,36,40]])})),c=function(){var e=this,t=arguments;return new Promise((function(r,n){var a=s.apply(e,t);function o(e){Ba(a,r,n,o,i,"next",e)}function i(e){Ba(a,r,n,o,i,"throw",e)}o(void 0)}))},function(){return c.apply(this,arguments)})}])&&Ha(r.prototype,n),a&&Ha(r,a),t}(aa);function Ga(e){return(Ga="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ja(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Qa(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function $a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Xa(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Za(e,t){return!t||"object"!==Ga(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function eo(e){return(eo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function to(e,t){return(to=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ro=function(e){function t(){return $a(this,t),Za(this,eo(t).apply(this,arguments))}var r,n,a,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&to(e,t)}(t,e),r=t,(n=[{key:"resultingCollection",value:(i=o.a.mark((function e(){var t,r,n,a,i,s,c,u,l,p,y;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t=[],r=!0,n=!1,a=void 0,e.prev=4,i=this.applyCollection.allPayloads[Symbol.iterator]();!(r=(s=i.next()).done);r=!0)u=s.value,l=this.findBasePayload({id:u.uuid}),p=l?l.deleted:u.deleted,y=oo({object:u,source:rn.RemoteSaved,override:(c={},Ja(c,fe.LastSyncEnd,new Date),Ja(c,fe.Deleted,p),c)}),t.push(y);e.next=12;break;case 8:e.prev=8,e.t0=e.catch(4),n=!0,a=e.t0;case 12:e.prev=12,e.prev=13,r||null==i.return||i.return();case 15:if(e.prev=15,!n){e.next=18;break}throw a;case 18:return e.finish(15);case 19:return e.finish(12);case 20:return e.abrupt("return",new f({payloads:t,source:rn.RemoteSaved}));case 21:case"end":return e.stop()}}),e,this,[[4,8,12,20],[13,,15,19]])})),s=function(){var e=this,t=arguments;return new Promise((function(r,n){var a=i.apply(e,t);function o(e){Qa(a,r,n,o,s,"next",e)}function s(e){Qa(a,r,n,o,s,"throw",e)}o(void 0)}))},function(){return s.apply(this,arguments)})}])&&Xa(r.prototype,n),a&&Xa(r,a),t}(aa);function no(e){var t=e.object,r=e.source,n=e.intent,a=e.override;if(!Object(i.l)(r))throw"Use CreateSourcedPayloadFromObject if creating payload with source.";if(!Object(i.l)(n))throw"Use CreateIntentPayloadFromObject if creating payload with intent.";return io({object:t,payloadClass:Bn,override:a})}function ao(e){var t=e.object,r=e.intent,n=e.override;return io({object:t,payloadClass:function(e){if(e===G.FileEncrypted||e===G.FileDecrypted||e===G.FilePreferEncrypted)return Tn;if(e===G.LocalStoragePreferEncrypted||e===G.LocalStorageDecrypted||e===G.LocalStorageEncrypted)return wn;if(e===G.Sync||e===G.SyncDecrypted)return jn;throw"No item payload class found for intent ".concat(e)}(r),override:n})}function oo(e){var t=e.object,r=e.source,n=e.override;return io({object:t,payloadClass:lo(r),override:n})}function io(e){var t=e.object,r=e.payloadClass,n=e.override,a=Object(i.t)(t,r.fields());if(n){if(!Object(i.m)(n))throw"Attempting to override payload with non-object";Object(i.e)(a,Object(i.a)(n))}return Object(i.d)(new r(a,!0))}function so(e){var t=e.payload,r=e.override,n=Object(i.t)(t,t.fields());return r&&Object(i.e)(n,Object(i.a)(r)),Object(i.d)(new t.constructor(n,!0))}function co(e){var t=Object(i.a)(e);return Object(i.d)(new ta(t,!0))}function uo(e){var t=e.encryptionParameters,r=e.override;if(!t.isEncryptionParameters)throw"Attempting to copy encryption parameters from non-parameters object.";var n=Object(i.t)(t,ta.fields());return r&&Object(i.e)(n,Object(i.a)(r)),Object(i.d)(new ta(n,!0))}function lo(e){if(e===rn.FileImport)return Tn;if(e===rn.LocalRetrieved||e===rn.LocalDirtied)return wn;if(e===rn.RemoteRetrieved||e===rn.ConflictData||e===rn.ConflictUuid)return jn;if(e===rn.LocalSaved||e===rn.RemoteSaved)return Gn;throw"No item payload class found for source ".concat(e)}function fo(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function po(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){fo(o,n,a,i,s,"next",e)}function s(e){fo(o,n,a,i,s,"throw",e)}i(void 0)}))}}function yo(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var ho=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.eventObservers=[]}var t,r,n,a,i,s;return t=e,(r=[{key:"addEventObserver",value:function(e){var t=this;return this.eventObservers.push(e),function(){jt()(t.eventObservers,e)}}},{key:"notifyEvent",value:(s=po(o.a.mark((function e(t,r){var n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,a=!1,i=void 0,e.prev=3,s=this.eventObservers[Symbol.iterator]();case 5:if(n=(c=s.next()).done){e.next=12;break}return u=c.value,e.next=9,u(t,r||{});case 9:n=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),a=!0,i=e.t0;case 18:e.prev=18,e.prev=19,n||null==s.return||s.return();case 21:if(e.prev=21,!a){e.next=24;break}throw i;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e,t){return s.apply(this,arguments)})},{key:"deinit",value:(i=po(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return i.apply(this,arguments)})},{key:"handleApplicationStage",value:(a=po(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(e){return a.apply(this,arguments)})},{key:"log",value:function(e){if(this.loggingEnabled){for(var t,r=new Date,n=r.toLocaleTimeString().replace(" PM","").replace(" AM",""),a="".concat(n,".").concat(r.getMilliseconds()),o=arguments.length,i=new Array(o>1?o-1:0),s=1;s<o;s++)i[s-1]=arguments[s];i?(t=console).log.apply(t,[a,e].concat(i)):console.log(a,e)}}}])&&yo(t.prototype,r),n&&yo(t,n),e}();function vo(e){return(vo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function mo(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function bo(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){mo(o,n,a,i,s,"next",e)}function s(e){mo(o,n,a,i,s,"throw",e)}i(void 0)}))}}function go(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function wo(e,t){return!t||"object"!==vo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ko(e){return(ko=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function xo(e,t){return(xo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var So=function(e){function t(e){var r,n=e.deviceInterface;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=wo(this,ko(t).call(this))).deviceInterface=n,r}var r,n,a,i,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&xo(e,t)}(t,e),r=t,(n=[{key:"alert",value:(s=bo(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){window.alert(t.text),e()})));case 1:case"end":return e.stop()}}),e)}))),function(e){return s.apply(this,arguments)})},{key:"confirm",value:(i=bo(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){window.confirm(t.text)?e():r()})));case 1:case"end":return e.stop()}}),e)}))),function(e){return i.apply(this,arguments)})}])&&go(r.prototype,n),a&&go(r,a),t}(ho);var Po=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.token=t};function Oo(e){return"\n          Your password must be at least ".concat(e," characters in length.\n          For your security, please choose a longer password or,\n          ideally, a passphrase, and try again.\n         ")}function _o(e,t){return"\n          Strict sign in refused server sign in parameters.\n          The latest security version is ".concat(t,", but your account is\n          reported to have version ").concat(e,". If you'd like to proceed\n          with sign in anyway, please disable strict sign in and try again.\n          ")}function jo(e){return(jo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Io(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Eo(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Io(o,n,a,i,s,"next",e)}function s(e){Io(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Do(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Co(e,t){return!t||"object"!==jo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ro(e){return(Ro=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ao(e,t){return(Ao=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var To=function(e){function t(e){var r,n=e.storageService,a=e.apiService,o=e.alertService,i=e.protocolService;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!n||!i)throw"Invalid SessionManager construction";return(r=Co(this,Ro(t).call(this))).protocolService=i,r.storageService=n,r.apiService=a,r.alertService=o||new So,r}var r,n,a,s,c,u,l,f,p,y;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ao(e,t)}(t,e),r=t,(n=[{key:"initializeFromDisk",value:(y=Eo(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(T.User);case 2:if(this.user=e.sent,this.user){e.next=8;break}return e.next=6,this.storageService.getValue(T.LegacyUuid);case 6:(t=e.sent)&&(this.user={uuid:t});case 8:return e.next=10,this.storageService.getValue(T.Session);case 10:if(!(r=e.sent)){e.next=14;break}return e.next=14,this.setSession(new Po(r));case 14:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"setSession",value:(p=Eo(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.session=t,this.apiService.setSession(this.session);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"online",value:function(){return!this.offline()}},{key:"offline",value:function(){return Object(i.l)(this.session)}},{key:"getUser",value:function(){return this.user}},{key:"signOut",value:(f=Eo(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.user=null,this.session=null;case 2:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"register",value:(l=Eo(o.a.mark((function e(t){var r,n,a,i,s,c,u=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.email,!((n=t.password).length<8)){e.next=3;break}return e.abrupt("return",this.apiService.error(Oo(8)));case 3:return e.next=5,this.protocolService.createRootKey({identifier:r,password:n});case 5:return a=e.sent,i=a.key.serverPassword,s=a.keyParams,c=a.key,e.abrupt("return",this.apiService.register({email:r,serverPassword:i,keyParams:s}).then(function(){var e=Eo(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:s,rootKey:c});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"signIn",value:(u=Eo(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p,y,h,v=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.email,n=t.password,a=t.strict,i=t.mfaKeyPath,s=t.mfaCode,e.next=3,this.apiService.getAccountKeyParams({email:r,mfaKeyPath:i,mfaCode:s}).then((function(e){return{keyParams:v.protocolService.createKeyParams(e)}}));case 3:if(!(c=e.sent).error){e.next=6;break}return e.abrupt("return",c);case 6:if((u=c.keyParams)&&u.version){e.next=9;break}return e.abrupt("return",this.apiService.error("Invalid email or password."));case 9:if(this.protocolService.supportedVersions().includes(u.version)){e.next=15;break}if(!this.protocolService.isVersionNewerThanLibraryVersion(u.version)){e.next=14;break}return e.abrupt("return",this.apiService.error("This version of the application does not support your\n                                                      newer account type. Please upgrade to the latest version\n                                                      of Standard Notes to sign in."));case 14:return e.abrupt("return",this.apiService.error("The protocol version associated with your account is\n                                                      outdated and no longer supported by this application.\n                                                      Please visit standardnotes.org/help/security for more\n                                                      information."));case 15:if(!this.protocolService.isProtocolVersionOutdated(u.version)){e.next=26;break}if(l=this.protocolService.costMinimumForVersion(u.version),!(u.kdfIterations<l)){e.next=19;break}return e.abrupt("return",this.apiService.error("Unable to login due to insecure password parameters.\n                                                      Please visit standardnotes.org/help/security for\n                                                      more information."));case 19:return e.next=23,this.alertService.confirm({title:"Update Recommended",text:"The encryption version for your account is outdated and\n                                                      requires upgrade. You may proceed with login, but are\n                                                      advised to perform a security update using the web or\n                                                      desktop application. Please visit\n                                                      standardnotes.org/help/security for more information.",confirmButtonText:"Sign In"}).catch((function(){}));case 23:if(e.sent){e.next=26;break}return e.abrupt("return",this.apiService.error());case 26:if(this.protocolService.platformSupportsKeyDerivation(u)){e.next=28;break}return e.abrupt("return",this.apiService.error("Your account was created on a platform with higher security\n                                                      capabilities than this browser supports. If we attempted\n                                                      to generate your login keys here, it would take hours. Please\n                                                      use a browser with more up to date security capabilities,\n                                                      like Google Chrome or Firefox, to log in."));case 28:if(!a){e.next=32;break}if(f=this.protocolService.getLatestVersion(),u.version===f){e.next=32;break}return e.abrupt("return",this.apiService.error(_o(u.version,f)));case 32:return e.next=34,this.protocolService.computeRootKey({password:n,keyParams:u}).then((function(e){return{rootKey:e,serverPassword:e.serverPassword}}));case 34:return p=e.sent,y=p.rootKey,h=p.serverPassword,e.abrupt("return",this.apiService.signIn({email:r,serverPassword:h,mfaKeyPath:i,mfaCode:s}).then(function(){var e=Eo(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:u,rootKey:y});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 38:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"changePassword",value:(c=Eo(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.email,n=t.currentPassword,a=t.currentKeyParams,!((i=t.newPassword).length<8)){e.next=3;break}return e.abrupt("return",this.apiService.error(Oo(8)));case 3:return e.next=5,this.protocolService.computeRootKey({password:n,keyParams:a}).then((function(e){return e.serverPassword}));case 5:return s=e.sent,e.next=8,this.protocolService.createRootKey({identifier:r,password:i}).then((function(e){return{newRootKey:e.key,newServerPassword:e.key.serverPassword,newKeyParams:e.keyParams}}));case 8:return c=e.sent,u=c.newServerPassword,l=c.newRootKey,f=c.newKeyParams,e.abrupt("return",this.apiService.changePassword({email:r,currentServerPassword:s,newServerPassword:u,newKeyParams:f}).then(function(){var e=Eo(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:f,rootKey:l});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 13:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"handleAuthResponse",value:(s=Eo(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.user,this.user=r,e.next=4,this.storageService.setValue(T.User,r);case 4:return n=new Po(t.token),e.next=7,this.storageService.setValue(T.Session,n);case 7:return e.next=9,this.setSession(n);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})}])&&Do(r.prototype,n),a&&Do(r,a),t}(ho),Mo="sync_token",Ko="cursor_token",Lo="compute_integrity",Fo="integrity_hash",No="limit",Uo="items",Bo="api";function Vo(e){return(Vo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ho(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Wo(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ho(Object(r),!0).forEach((function(t){zo(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ho(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function zo(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function qo(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Yo(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){qo(o,n,a,i,s,"next",e)}function s(e){qo(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Go(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Jo(e,t){return!t||"object"!==Vo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Qo(e){return(Qo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function $o(e,t){return($o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Xo=function(e){function t(e){var r,n=e.httpService,a=e.storageService,o=e.host;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Jo(this,Qo(t).call(this))).httpService=n,r.storageService=a,r.host=o,r}var r,n,a,s,c,u,l,f,p,y,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&$o(e,t)}(t,e),r=t,(n=[{key:"setHost",value:(h=Yo(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.host=t,e.next=3,this.storageService.setValue(T.ServerHost,t);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"getHost",value:(y=Yo(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.host){e.next=5;break}return e.next=3,this.storageService.getValue(T.ServerHost);case 3:t=e.sent,this.host=t||window._default_sf_server;case 5:return e.abrupt("return",this.host);case 6:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"setSession",value:function(e){this.session=e}},{key:"path",value:(p=Yo(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getHost();case 2:if(r=e.sent){e.next=5;break}throw"Attempting to build path ".concat(t," with no host.");case 5:if(t){e.next=7;break}throw"Attempting to build path with null path.";case 7:return e.abrupt("return",Object(i.p)(r,t));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"params",value:function(e){var t=Ut()(e,zo({},Bo,"20190520"));return t}},{key:"error",value:function(e){return{response:{error:{message:e}}}}},{key:"errorResponse",value:function(e,t){return this.log("".concat(t,": ").concat(e)),Object(i.m)(e)?e:Object(i.n)(e)?this.error(e):this.error(t)}},{key:"getAccountKeyParams",value:(f=Yo(o.a.mark((function e(t){var r,n,a,i,s,c,u=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.email,n=t.mfaKeyPath,a=t.mfaCode,e.next=3,this.path("/auth/params");case 3:return i=e.sent,s=this.params(zo({email:r},n,a)),e.next=7,this.httpService.getAbsolute({url:i,params:s}).catch((function(e){return u.errorResponse(e,"A server error occurred while trying to sign in. Please try again.")}));case 7:return c=e.sent,e.abrupt("return",c);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"register",value:(l=Yo(o.a.mark((function e(t){var r,n,a,i,s,c,u=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.email,n=t.serverPassword,a=t.keyParams,!this.registering){e.next=3;break}return e.abrupt("return",this.error("An existing registration request is already in progress."));case 3:return this.registering=!0,e.next=6,this.path("/auth");case 6:return i=e.sent,s=this.params(Wo({password:n,email:r},a.getPortableValue())),e.next=10,this.httpService.postAbsolute({url:i,params:s}).catch((function(e){return u.errorResponse(e,"A server error occurred while trying to register. Please try again.")}));case 10:return c=e.sent,this.registering=!1,e.abrupt("return",c);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"signIn",value:(u=Yo(o.a.mark((function e(t){var r,n,a,i,s,c,u,l=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.email,n=t.serverPassword,a=t.mfaKeyPath,i=t.mfaCode,!this.authenticating){e.next=3;break}return e.abrupt("return",this.error("An existing sign in request is already in progress."));case 3:return this.authenticating=!0,e.next=6,this.path("/auth/sign_in");case 6:return s=e.sent,c=this.params(zo({email:r,password:n},a,i)),e.next=10,this.httpService.postAbsolute({url:s,params:c}).catch((function(e){return l.errorResponse(e,"A server error occurred while trying to sign in. Please try again.")}));case 10:return u=e.sent,this.authenticating=!1,e.abrupt("return",u);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"changePassword",value:(c=Yo(o.a.mark((function e(t){var r,n,a,i,s,c,u=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.email,r=t.currentServerPassword,n=t.newServerPassword,a=t.newKeyParams,!this.changing){e.next=3;break}return e.abrupt("return",this.error("An existing change password request is already in progress."));case 3:return this.changing=!0,e.next=6,this.path("/auth/change_pw");case 6:return i=e.sent,s=Wo({current_password:r,new_password:n},a.getPortableValue()),e.next=10,this.httpService.postAbsolute({url:i,params:s,authentication:this.session.token}).catch((function(e){return u.errorResponse(e,"Something went wrong while changing your password.\n                                                      Your password was not changed. Please try again.")}));case 10:return c=e.sent,this.changing=!1,e.abrupt("return",c);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"sync",value:(s=Yo(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p,y,h=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.payloads,a=t.lastSyncToken,i=t.paginationToken,s=t.limit,c=t.checkIntegrity,u=t.contentType,l=t.customEvent,e.next=3,this.path("/items/sync");case 3:return f=e.sent,p=this.params((zo(r={},Uo,n),zo(r,Mo,a),zo(r,Ko,i),zo(r,Lo,c),zo(r,No,s),zo(r,"content_type",u),zo(r,"event",l),r)),e.next=7,this.httpService.postAbsolute({url:f,params:p,authentication:this.session.token}).catch((function(e){return h.errorResponse(e,"Could not connect to server.")}));case 7:return y=e.sent,e.abrupt("return",y);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})}])&&Go(r.prototype,n),a&&Go(r,a),t}(ho),Zo=r(21),ei=r.n(Zo);function ti(e){return(ti="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ri(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ni(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){ri(o,n,a,i,s,"next",e)}function s(e){ri(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ai(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function oi(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ii(e,t,r){return(ii="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=si(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function si(e){return(si=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ci(e,t){return(ci=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ui(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var li="stream-items",fi="stream-context-item",pi="save-items",yi="associate-item",hi="deassociate-item",vi="create-item",di="create-items",mi="delete-items",bi="set-component-data",gi="install-local-component",wi="toggle-activate-component",ki="request-permissions",xi="duplicate-item",Si="component-registered",Pi="themes",Oi="reply",_i=function(e){function t(e){var r,n=e.modelManager,a=e.syncService,o=e.alertService,i=e.timeout,s=e.environment,c=e.platform;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=function(e,t){return!t||"object"!==ti(t)&&"function"!=typeof t?oi(e):t}(this,si(t).call(this)),ui(oi(r),"detectFocusChange",(function(){var e=!0,t=!1,n=void 0;try{for(var a,o=function(){var e=a.value;if(document.activeElement===r.iframeForComponent(e))return r.timeout((function(){r.focusChangedForComponent(e)})),"break"},i=r.activeComponents[Symbol.iterator]();!(e=(a=i.next()).done);e=!0){if("break"===o())break}}catch(e){t=!0,n=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw n}}})),ui(oi(r),"onWindowMessage",(function(e){r.log("Web app: received message",e),e.data.sessionKey&&r.handleMessage(r.componentForSessionKey(e.data.sessionKey),e.data)})),t.ClientDataDomain="org.standardnotes.sn.components",r.timeout=i||setTimeout.bind(window),r.modelManager=n,r.syncService=a,r.alertService=o,r.environment=s,r.platform=c,r.isDesktop=r.environment===I.Desktop,r.isMobile=r.environment===I.Mobile,r.streamObservers=[],r.contextStreamObservers=[],r.activeComponents=[],r.permissionDialogs=[],r.handlers=[],r.configureForGeneralUsage(),s!==I.Mobile&&r.configureForNonMobileUsage(),r}var r,n,a,u,l,f,p,y,h,v,d;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ci(e,t)}(t,e),r=t,(n=[{key:"setDesktopManager",value:function(e){this.desktopManager=e,this.configureForDesktop()}},{key:"configureForGeneralUsage",value:function(){var e=this;this.modelManager.addMappingObserver("*",function(){var t=ni(o.a.mark((function t(r,n,a,i,s){var u,l,f,p,y,h,v,d,m,b,g,w,k,x,S,P,O,_,j,I,E;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:(u=r.filter((function(e){return e.content_type===c.Component||e.content_type===c.Theme}))).length>0&&i!==rn.RemoteSaved&&e.isDesktop&&e.desktopManager.syncComponentsInstallation(u),l=!0,f=!1,p=void 0,t.prev=5,y=u[Symbol.iterator]();case 7:if(l=(h=y.next()).done){t.next=21;break}if(v=h.value,d=Ot()(e.activeComponents,{uuid:v.uuid}),!v.active||v.deleted||d){t.next=15;break}return t.next=13,e.activateComponent(v);case 13:t.next=18;break;case 15:if(v.active||!d){t.next=18;break}return t.next=18,e.deactivateComponent(v);case 18:l=!0,t.next=7;break;case 21:t.next=27;break;case 23:t.prev=23,t.t0=t.catch(5),f=!0,p=t.t0;case 27:t.prev=27,t.prev=28,l||null==y.return||y.return();case 30:if(t.prev=30,!f){t.next=33;break}throw p;case 33:return t.finish(30);case 34:return t.finish(27);case 35:m=!0,b=!1,g=void 0,t.prev=38,w=function(){var t=x.value;if(s&&s===t.component.uuid)return"continue";var n=r.filter((function(e){return-1!==t.contentTypes.indexOf(e.content_type)}));if(0===n.length)return"continue";var a=[{name:li,content_types:t.contentTypes.sort()}];e.runWithPermissions(t.component,a,(function(){e.sendItemsInReply(t.component,n,t.originalMessage)}))},k=e.streamObservers[Symbol.iterator]();case 41:if(m=(x=k.next()).done){t.next=48;break}if("continue"!==w()){t.next=45;break}return t.abrupt("continue",45);case 45:m=!0,t.next=41;break;case 48:t.next=54;break;case 50:t.prev=50,t.t1=t.catch(38),b=!0,g=t.t1;case 54:t.prev=54,t.prev=55,m||null==k.return||k.return();case 57:if(t.prev=57,!b){t.next=60;break}throw g;case 60:return t.finish(57);case 61:return t.finish(54);case 62:S=[{name:fi}],P=!0,O=!1,_=void 0,t.prev=66,j=function(){var t=E.value;if(s&&s===t.component.uuid)return"continue";var n=!0,a=!1,o=void 0;try{for(var c,u=e.handlers[Symbol.iterator]();!(n=(c=u.next()).done);n=!0){var l=c.value;if((l.areas.includes(t.component.area)||l.areas.includes("*"))&&l.contextRequestHandler){var f=l.contextRequestHandler(t.component);f&&function(){var n=Ot()(r,{uuid:f.uuid});n&&e.runWithPermissions(t.component,S,(function(){e.sendContextItemInReply(t.component,n,t.originalMessage,i)}))}()}}}catch(e){a=!0,o=e}finally{try{n||null==u.return||u.return()}finally{if(a)throw o}}},I=e.contextStreamObservers[Symbol.iterator]();case 69:if(P=(E=I.next()).done){t.next=76;break}if("continue"!==j()){t.next=73;break}return t.abrupt("continue",73);case 73:P=!0,t.next=69;break;case 76:t.next=82;break;case 78:t.prev=78,t.t2=t.catch(66),O=!0,_=t.t2;case 82:t.prev=82,t.prev=83,P||null==I.return||I.return();case 85:if(t.prev=85,!O){t.next=88;break}throw _;case 88:return t.finish(85);case 89:return t.finish(82);case 90:case"end":return t.stop()}}),t,null,[[5,23,27,35],[28,,30,34],[38,50,54,62],[55,,57,61],[66,78,82,90],[83,,85,89]])})));return function(e,r,n,a,o){return t.apply(this,arguments)}}())}},{key:"isNativeExtension",value:function(e){var t=[window._extensions_manager_location,window._batch_manager_location],r=e.content.hosted_url,n=e.content.local_url&&e.content.local_url.replace("sn://","");return t.includes(r)||t.includes(n)}},{key:"deinit",value:(d=ni(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:ii(si(t.prototype),"deinit",this).call(this),window&&(window.removeEventListener("focus",this.detectFocusChange,!0),window.removeEventListener("blur",this.detectFocusChange,!0),window.removeEventListener("message",this.onWindowMessage));case 2:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"configureForNonMobileUsage",value:function(){window.addEventListener?window.addEventListener("focus",this.detectFocusChange,!0):window.attachEvent("onfocusout",this.detectFocusChange),window.addEventListener?window.addEventListener("blur",this.detectFocusChange,!0):window.attachEvent("onblur",this.detectFocusChange),window.addEventListener("message",this.onWindowMessage)}},{key:"configureForDesktop",value:function(){var e=this;this.desktopManager.registerUpdateObserver((function(t){t.active&&t.isTheme()&&e.postActiveThemesToAllComponents()}))}},{key:"postActiveThemesToAllComponents",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,a=this.components[Symbol.iterator]();!(e=(n=a.next()).done);e=!0){var o=n.value;!o.isTheme()&&o.active&&o.window&&this.postActiveThemesToComponent(o)}}catch(e){t=!0,r=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw r}}}},{key:"getActiveThemes",value:function(){return this.componentsForArea(dt).filter((function(e){return e.active}))}},{key:"urlsForActiveThemes",value:function(){var e=this;return this.getActiveThemes().map((function(t){return e.urlForComponent(t)}))}},{key:"postActiveThemesToComponent",value:function(e){var t={themes:this.urlsForActiveThemes()};this.sendMessageToComponent(e,{action:Pi,data:t})}},{key:"contextItemDidChangeInArea",value:function(e){var t=!0,r=!1,n=void 0;try{for(var a,o=this.handlers[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;if(!1!==i.areas.includes(e)||i.areas.includes("*")){var s=this.contextStreamObservers.filter((function(t){return t.component.area===e})),c=!0,u=!1,l=void 0;try{for(var f,p=s[Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var y=f.value;if(i.contextRequestHandler){var h=i.contextRequestHandler(y.component);h&&this.sendContextItemInReply(y.component,h,y.originalMessage)}}}catch(e){u=!0,l=e}finally{try{c||null==p.return||p.return()}finally{if(u)throw l}}}}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}}},{key:"setComponentHidden",value:function(e,t){if(t)e.hidden=!0;else if(e.hidden){e.hidden=!1;var r=Ot()(this.contextStreamObservers,{identifier:e.uuid});r&&this.handleStreamContextItemMessage(e,r.originalMessage);var n=Ot()(this.streamObservers,{identifier:e.uuid});n&&this.handleStreamItemsMessage(e,n.originalMessage)}}},{key:"jsonForItem",value:function(e,r,n){var a={uuid:e.uuid,content_type:e.content_type,created_at:e.created_at,updated_at:e.updated_at,deleted:e.deleted};return a.content=e.collapseContent(),a.clientData=e.getDomainDataItem(r.getClientDataKey(),t.ClientDataDomain)||{},!n||n!==rn.RemoteSaved&&n!==rn.LocalSaved||(a.isMetadataUpdate=!0),this.removePrivatePropertiesFromResponseItems([a],r),a}},{key:"sendItemsInReply",value:function(e,t,r,n){var a=this;this.log("Web|componentManager|sendItemsInReply",e,t,r);var o={items:{}},i=t.map((function(t){return a.jsonForItem(t,e,n)}));o.items=i,this.replyToMessage(e,r,o)}},{key:"sendContextItemInReply",value:function(e,t,r,n){this.log("Web|componentManager|sendContextItemInReply",e,t,r);var a={item:this.jsonForItem(t,e,n)};this.replyToMessage(e,r,a)}},{key:"replyToMessage",value:function(e,t,r){var n={action:Oi,original:t,data:r};this.sendMessageToComponent(e,n)}},{key:"sendMessageToComponent",value:function(e,t){var r=[Si,Pi];if(!e.hidden||r.includes(t.action)){this.log("Web|sendMessageToComponent",e,t);var n=this.urlForComponent(e);n.startsWith("http")||n.startsWith("file")||(n=window.location.href+n),e.window||this.alertService.alert({text:"Standard Notes is trying to communicate with ".concat(e.name,", \n        but an error is occurring. Please restart this extension and try again.")}),this.isMobile&&(t=JSON.stringify(t)),e.window.postMessage(t,n)}else this.log("Component disabled for current item, ignoring messages.",e.name)}},{key:"componentsForArea",value:function(e){return this.components.filter((function(t){return t.area===e}))}},{key:"urlForComponent",value:function(e){if(e.offlineOnly&&!this.isDesktop)return null;if(e.offlineOnly||this.isDesktop&&e.local_url)return e.local_url&&e.local_url.replace("sn://",this.desktopManager.getExtServerHost());var t=e.hosted_url||e.legacy_url;if(this.isMobile){var r=this.platform===E.Ios?"localhost":"10.0.2.2";t=t.replace("localhost",r).replace("sn.local",r)}return t}},{key:"componentForUrl",value:function(e){return this.components.filter((function(t){return t.hosted_url===e||t.legacy_url===e}))[0]}},{key:"componentForSessionKey",value:function(e){var t=Ot()(this.components,{sessionKey:e});if(!t){var r=!0,n=!1,a=void 0;try{for(var o,i=this.handlers[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(s.componentForSessionKeyHandler&&(t=s.componentForSessionKeyHandler(e)))break}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}return t}},{key:"handleMessage",value:function(e,t){var r=this;if(!e)return this.log("Component not defined for message, returning",t),void this.alertService.alert({text:"An extension is trying to communicate with Standard Notes,but there is an error establishing a bridge. Please restart the app and try again."});var n=[pi,yi,hi,vi,di,mi,bi];if(e.readonly&&n.includes(t.action))this.alertService.alert({text:"The extension ".concat(e.name," is trying to save, but it is in a locked state and cannot accept changes.")});else{if(t.action===li)this.handleStreamItemsMessage(e,t);else if(t.action===fi)this.handleStreamContextItemMessage(e,t);else if(t.action===bi)this.handleSetComponentDataMessage(e,t);else if(t.action===mi)this.handleDeleteItemsMessage(e,t);else if(t.action===di||t.action===vi)this.handleCreateItemsMessage(e,t);else if(t.action===pi)this.handleSaveItemsMessage(e,t);else if(t.action===wi){var a=this.modelManager.findItem(t.data.uuid);this.handleToggleComponentMessage(e,a,t)}else t.action===ki?this.handleRequestPermissionsMessage(e,t):t.action===gi?this.handleInstallLocalComponentMessage(e,t):t.action===xi&&this.handleDuplicateItemMessage(e,t);var o=!0,i=!1,s=void 0;try{for(var c,u=function(){var n=c.value;n.actionHandler&&(n.areas.includes(e.area)||n.areas.includes("*"))&&r.timeout((function(){n.actionHandler(e,t.action,t.data)}))},l=this.handlers[Symbol.iterator]();!(o=(c=l.next()).done);o=!0)u()}catch(e){i=!0,s=e}finally{try{o||null==l.return||l.return()}finally{if(i)throw s}}}}},{key:"removePrivatePropertiesFromResponseItems",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r.incoming){var n=["updated_at"],a=!0,o=!1,i=void 0;try{for(var s,c=e[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var u=s.value;if(u.isItem)console.error("Attempting to pass object. Use JSON.");else{var l=!0,f=!1,p=void 0;try{for(var y,h=n[Symbol.iterator]();!(l=(y=h.next()).done);l=!0){var v=y.value;delete u[v]}}catch(e){f=!0,p=e}finally{try{l||null==h.return||h.return()}finally{if(f)throw p}}}}}catch(e){o=!0,i=e}finally{try{a||null==c.return||c.return()}finally{if(o)throw i}}}if(!t||!this.isNativeExtension(t)){var d=["autoupdateDisabled","permissions","active"];r&&r.includeUrls&&(d=d.concat(["url","hosted_url","local_url"]));var m=!0,b=!1,g=void 0;try{for(var w,k=e[Symbol.iterator]();!(m=(w=k.next()).done);m=!0){var x=w.value;if(x.isItem)console.error("Attempting to pass object. Use JSON.");else{var S=!0,P=!1,O=void 0;try{for(var _,j=d[Symbol.iterator]();!(S=(_=j.next()).done);S=!0){var I=_.value;delete x.content[I]}}catch(e){P=!0,O=e}finally{try{S||null==j.return||j.return()}finally{if(P)throw O}}}}}catch(e){b=!0,g=e}finally{try{m||null==k.return||k.return()}finally{if(b)throw g}}}}},{key:"handleStreamItemsMessage",value:function(e,t){var r=this,n=[{name:li,content_types:t.data.content_types.sort()}];this.runWithPermissions(e,n,(function(){Ot()(r.streamObservers,{identifier:e.uuid})||r.streamObservers.push({identifier:e.uuid,component:e,originalMessage:t,contentTypes:t.data.content_types});var n=[],a=!0,o=!1,i=void 0;try{for(var s,c=t.data.content_types[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var u=s.value;n=n.concat(r.modelManager.validItemsForContentType(u))}}catch(e){o=!0,i=e}finally{try{a||null==c.return||c.return()}finally{if(o)throw i}}r.sendItemsInReply(e,n,t)}))}},{key:"handleStreamContextItemMessage",value:function(e,t){var r=this,n=[{name:fi}];this.runWithPermissions(e,n,(function(){Ot()(r.contextStreamObservers,{identifier:e.uuid})||r.contextStreamObservers.push({identifier:e.uuid,component:e,originalMessage:t});var n=!0,a=!1,o=void 0;try{for(var i,s=r.handlersForArea(e.area)[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var c=i.value;if(c.contextRequestHandler){var u=c.contextRequestHandler(e);u&&r.sendContextItemInReply(e,u,t)}}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}}))}},{key:"isItemIdWithinComponentContextJurisdiction",value:function(e,t){return this.itemIdsInContextJurisdictionForComponent(t).includes(e)}},{key:"itemIdsInContextJurisdictionForComponent",value:function(e){var t=[],r=!0,n=!1,a=void 0;try{for(var o,i=this.handlersForArea(e.area)[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(s.contextRequestHandler){var c=s.contextRequestHandler(e);c&&t.push(c.uuid)}}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}return t}},{key:"handlersForArea",value:function(e){return this.handlers.filter((function(t){return t.areas.includes(e)}))}},{key:"handleSaveItemsMessage",value:(v=ni(o.a.mark((function e(r,n){var a,i,s,c,u,l,f,p,y,h,v,d=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=n.data.items,i=[],s=this.itemIdsInContextJurisdictionForComponent(r),c=a.slice(),u=!0,l=!1,f=void 0,e.prev=7,p=a.slice()[Symbol.iterator]();case 9:if(u=(y=p.next()).done){e.next=18;break}if(h=y.value,!s.includes(h.uuid)){e.next=15;break}return i.push({name:fi}),jt()(c,h),e.abrupt("break",18);case 15:u=!0,e.next=9;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(7),l=!0,f=e.t0;case 24:e.prev=24,e.prev=25,u||null==p.return||p.return();case 27:if(e.prev=27,!l){e.next=30;break}throw f;case 30:return e.finish(27);case 31:return e.finish(24);case 32:c.length>0&&(v=ei()(c.map((function(e){return e.content_type}))).sort(),i.push({name:li,content_types:v})),this.runWithPermissions(r,i,ni(o.a.mark((function e(){var i,s,c,u,l,f,p,y,h,v,m,b,g,w,k,x,S,P,O,_;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(d.removePrivatePropertiesFromResponseItems(a,r,{includeUrls:!0,incoming:!0}),i=a.map((function(e){return e.uuid})),s=d.modelManager.findItems(i),c=0,u=!0,l=!1,f=void 0,e.prev=7,p=s[Symbol.iterator]();!(u=(y=p.next()).done);u=!0)(h=y.value).locked&&(Et()(a,{uuid:h.uuid}),c++);e.next=15;break;case 11:e.prev=11,e.t0=e.catch(7),l=!0,f=e.t0;case 15:e.prev=15,e.prev=16,u||null==p.return||p.return();case 18:if(e.prev=18,!l){e.next=21;break}throw f;case 21:return e.finish(18);case 22:return e.finish(15);case 23:return c>0&&(v=1===c?"item":"items",m=1===c?"is":"are",d.alertService.alert({title:"Items Locked",text:"".concat(c," ").concat(v," you are attempting to save ").concat(m," locked and cannot be edited.")})),b=a.map((function(e){return no({object:e})})),e.next=27,d.modelManager.mapPayloadsToLocalItems({paylods:b,source:rn.ComponentRetrieved,sourceKey:r.uuid});case 27:g=e.sent,w=!0,k=!1,x=void 0,e.prev=31,S=a[Symbol.iterator]();case 33:if(w=(P=S.next()).done){e.next=46;break}if(O=P.value,_=Ot()(g,{uuid:O.uuid})){e.next=39;break}return d.alertService.alert({text:"The extension ".concat(r.name," is trying to save an item with type")+"".concat(O.content_type,", but that item does not exist. Please restart this extension and try again.")}),e.abrupt("continue",43);case 39:if(_.locked){e.next=43;break}return O.clientData&&_.setDomainDataItem(r.getClientDataKey(),O.clientData,t.ClientDataDomain),e.next=43,d.modelManager.setItemDirty(_,!0,!0,rn.ComponentRetrieved,r.uuid);case 43:w=!0,e.next=33;break;case 46:e.next=52;break;case 48:e.prev=48,e.t1=e.catch(31),k=!0,x=e.t1;case 52:e.prev=52,e.prev=53,w||null==S.return||S.return();case 55:if(e.prev=55,!k){e.next=58;break}throw x;case 58:return e.finish(55);case 59:return e.finish(52);case 60:d.syncService.sync().then((function(e){var t=Object.assign({},n);t.action=e&&e.error?"save-error":"save-success",d.replyToMessage(r,n,{error:e&&e.error}),d.handleMessage(r,t)}));case 61:case"end":return e.stop()}}),e,null,[[7,11,15,23],[16,,18,22],[31,48,52,60],[53,,55,59]])}))));case 34:case"end":return e.stop()}}),e,this,[[7,20,24,32],[25,,27,31]])}))),function(e,t){return v.apply(this,arguments)})},{key:"handleDuplicateItemMessage",value:function(e,t){var r=this,n=t.data.item,a=this.modelManager.findItem(n.uuid),i=[{name:li,content_types:[a.content_type]}];this.runWithPermissions(e,i,ni(o.a.mark((function n(){var i;return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,r.modelManager.duplicateItem({item:a});case 2:i=n.sent,r.syncService.sync(),r.replyToMessage(e,t,{item:r.jsonForItem(i,e)});case 5:case"end":return n.stop()}}),n)}))))}},{key:"handleCreateItemsMessage",value:function(e,r){var n=this,a=r.data.item?[r.data.item]:r.data.items,i=ei()(a.map((function(e){return e.content_type}))),s=[{name:li,content_types:i}];this.runWithPermissions(e,s,ni(o.a.mark((function i(){var s,c,u,l,f,p,y,h,v,d;return o.a.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:n.removePrivatePropertiesFromResponseItems(a,e,{incoming:!0}),s=[],c=!0,u=!1,l=void 0,o.prev=5,f=a[Symbol.iterator]();case 7:if(c=(p=f.next()).done){o.next=21;break}return y=p.value,h=oo({object:y,source:rn.RemoteRetrieved}),v=Yr(h),y.clientData&&v.setDomainDataItem(e.getClientDataKey(),y.clientData,t.ClientDataDomain),n.modelManager.addItem(v),o.next=15,n.modelManager.resolveReferencesForItem(v,!0);case 15:return o.next=17,n.modelManager.setItemDirty(v,!0);case 17:s.push(v);case 18:c=!0,o.next=7;break;case 21:o.next=27;break;case 23:o.prev=23,o.t0=o.catch(5),u=!0,l=o.t0;case 27:o.prev=27,o.prev=28,c||null==f.return||f.return();case 30:if(o.prev=30,!u){o.next=33;break}throw l;case 33:return o.finish(30);case 34:return o.finish(27);case 35:n.syncService.sync(),d=r.action===vi?{item:n.jsonForItem(s[0],e)}:{items:s.map((function(t){return n.jsonForItem(t,e)}))},n.replyToMessage(e,r,d);case 38:case"end":return o.stop()}}),i,null,[[5,23,27,35],[28,,30,34]])}))))}},{key:"handleDeleteItemsMessage",value:function(e,t){var r=this,n=ei()(t.data.items.map((function(e){return e.content_type}))).sort(),a=[{name:li,content_types:n}];this.runWithPermissions(e,a,ni(o.a.mark((function n(){var a,i,s,u,l,f,p,y,h,v,d;return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=t.data.items,i=1===a.length?"item":"items",s=null,u=!0,n.next=6,r.alertService.confirm({text:"Are you sure you want to delete ".concat(a.length," ").concat(i,"?")}).catch((function(){u=!1}));case 6:if(!u){n.next=45;break}l=!0,f=!1,p=void 0,n.prev=10,y=a[Symbol.iterator]();case 12:if(l=(h=y.next()).done){n.next=27;break}if(v=h.value,d=r.modelManager.findItem(v.uuid)){n.next=18;break}return r.alertService.alert({text:"The item you are trying to delete cannot be found."}),n.abrupt("continue",24);case 18:if(![c.Component,c.Theme].includes(d.content_type)){n.next=21;break}return n.next=21,r.deactivateComponent(d,!0);case 21:return n.next=23,r.modelManager.setItemToBeDeleted(d);case 23:r.modelManager.notifyMappingObservers([d],rn.RemoteSaved);case 24:l=!0,n.next=12;break;case 27:n.next=33;break;case 29:n.prev=29,n.t0=n.catch(10),f=!0,p=n.t0;case 33:n.prev=33,n.prev=34,l||null==y.return||y.return();case 36:if(n.prev=36,!f){n.next=39;break}throw p;case 39:return n.finish(36);case 40:return n.finish(33);case 41:r.syncService.sync(),s={deleted:!0},n.next=46;break;case 45:s={deleted:!1};case 46:r.replyToMessage(e,t,s);case 47:case"end":return n.stop()}}),n,null,[[10,29,33,41],[34,,36,40]])}))))}},{key:"handleRequestPermissionsMessage",value:function(e,t){var r=this;this.runWithPermissions(e,t.data.permissions,(function(){r.replyToMessage(e,t,{approved:!0})}))}},{key:"handleSetComponentDataMessage",value:function(e,t){var r=this;this.runWithPermissions(e,[],ni(o.a.mark((function n(){return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return e.componentData=t.data.componentData,n.next=3,r.modelManager.setItemDirty(e,!0);case 3:r.syncService.sync();case 4:case"end":return n.stop()}}),n)}))))}},{key:"handleToggleComponentMessage",value:function(e,t,r){this.toggleComponent(t)}},{key:"toggleComponent",value:(h=ni(o.a.mark((function e(t){var r,n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.area!==wt){e.next=4;break}this.openModalComponent(t),e.next=18;break;case 4:if(!t.active){e.next=9;break}return e.next=7,this.deactivateComponent(t);case 7:e.next=18;break;case 9:if(t.content_type!==c.Theme){e.next=16;break}return r=this.getActiveThemes(),e.next=13,this.activateComponent(t);case 13:t.isLayerable()||setTimeout(ni(o.a.mark((function e(){var t,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,a=!1,i=void 0,e.prev=3,s=r[Symbol.iterator]();case 5:if(t=(c=s.next()).done){e.next=13;break}if(!(u=c.value)||u.isLayerable()){e.next=10;break}return e.next=10,n.deactivateComponent(u);case 10:t=!0,e.next=5;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(3),a=!0,i=e.t0;case 19:e.prev=19,e.prev=20,t||null==s.return||s.return();case 22:if(e.prev=22,!a){e.next=25;break}throw i;case 25:return e.finish(22);case 26:return e.finish(19);case 27:case"end":return e.stop()}}),e,null,[[3,15,19,27],[20,,22,26]])}))),10),e.next=18;break;case 16:return e.next=18,this.activateComponent(t);case 18:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"handleInstallLocalComponentMessage",value:function(e,t){if(this.isNativeExtension(e)){var r=this.modelManager.findItem(t.data.uuid);this.desktopManager.installComponent(r)}}},{key:"runWithPermissions",value:function(e,t,r){e.permissions||(e.permissions=[]),t=Object(i.a)(t);var n=e.permissions,a=!0,o=!1,s=void 0;try{for(var c,u=function(){var e=c.value,r=n.find((function(t){return t.name===e.name}));if(!r)return"continue";var a=e.content_types;if(!a)return jt()(t,e),"continue";var o=!0,i=!1,s=void 0;try{for(var u,l=r.content_types[Symbol.iterator]();!(o=(u=l.next()).done);o=!0){var f=u.value;jt()(a,f)}}catch(e){i=!0,s=e}finally{try{o||null==l.return||l.return()}finally{if(i)throw s}}0===a.length&&jt()(t,e)},l=t.slice()[Symbol.iterator]();!(a=(c=l.next()).done);a=!0)u()}catch(e){o=!0,s=e}finally{try{a||null==l.return||l.return()}finally{if(o)throw s}}t.length>0?this.promptForPermissions(e,t,(function(e){e&&r()})):r()}},{key:"promptForPermissions",value:function(e,t,r){var n=this,a={};a.component=e,a.permissions=t,a.permissionsString=this.permissionsStringForPermissions(t,e),a.actionBlock=r,a.callback=function(){var r=ni(o.a.mark((function r(i){var s,c,u,l,f,p;return o.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!i){r.next=24;break}for(s=!0,c=!1,u=void 0,r.prev=4,l=function(){var t=p.value,r=e.permissions.find((function(e){return e.name===t.name}));if(r){var n=r.content_types||[];r.content_types=ei()(n.concat(t.content_types))}else e.permissions.push(t)},f=t[Symbol.iterator]();!(s=(p=f.next()).done);s=!0)l();r.next=13;break;case 9:r.prev=9,r.t0=r.catch(4),c=!0,u=r.t0;case 13:r.prev=13,r.prev=14,s||null==f.return||f.return();case 16:if(r.prev=16,!c){r.next=19;break}throw u;case 19:return r.finish(16);case 20:return r.finish(13);case 21:return r.next=23,n.modelManager.setItemDirty(e,!0);case 23:n.syncService.sync();case 24:n.permissionDialogs=n.permissionDialogs.filter((function(r){return r===a?(r.actionBlock&&r.actionBlock(i),!1):!!(r.component!==e||r.permissions!==t&&(n=t,r.permissions.some((function(e){return!n.find((function(t){return JSON.stringify(t)===JSON.stringify(e)}))}))))||(i&&r.actionBlock&&r.actionBlock(i),!1);var n})),n.permissionDialogs.length>0&&n.presentPermissionsDialog(n.permissionDialogs[0]);case 26:case"end":return r.stop()}}),r,null,[[4,9,13,21],[14,,16,20]])})));return function(e){return r.apply(this,arguments)}}();var i=Ot()(this.permissionDialogs,{component:e});this.permissionDialogs.push(a),i?this.log("Existing dialog, not presenting."):this.presentPermissionsDialog(a)}},{key:"presentPermissionsDialog",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"openModalComponent",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"registerHandler",value:function(e){this.handlers.push(e)}},{key:"deregisterHandler",value:function(e){var t=Ot()(this.handlers,{identifier:e});t?this.handlers.splice(this.handlers.indexOf(t),1):this.log("Attempting to deregister non-existing handler")}},{key:"registerComponentWindow",value:(y=ni(o.a.mark((function e(t,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.window===r&&this.log("Web|componentManager","attempting to re-register same component window."),this.log("Web|componentManager|registerComponentWindow",t),t.window=r,e.next=5,U.GenerateUuid();case 5:t.sessionKey=e.sent,this.sendMessageToComponent(t,{action:Si,sessionKey:t.sessionKey,componentData:t.componentData,data:{uuid:t.uuid,environment:(o=this.environment,i=void 0,(j(i={},I.Web,"web"),j(i,I.Desktop,"desktop"),j(i,I.Mobile,"mobile"),i)[o]),platform:(n=this.platform,a=void 0,(j(a={},E.MacWeb,"mac-web"),j(a,E.MacDesktop,"mac-desktop"),j(a,E.LinuxWeb,"linux-web"),j(a,E.LinuxDesktop,"linux-desktop"),j(a,E.WindowsWeb,"windows-web"),j(a,E.WindowsDesktop,"windows-desktop"),j(a,E.Ios,"ios"),j(a,E.Android,"android"),a)[n]),activeThemeUrls:this.urlsForActiveThemes()}}),this.postActiveThemesToComponent(t),this.desktopManager&&this.desktopManager.notifyComponentActivation(t);case 9:case"end":return e.stop()}var n,a,o,i}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"activateComponent",value:(p=ni(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(r=f.length>1&&void 0!==f[1]&&f[1],n=!0!==t.active,t.active=!0,a=!0,i=!1,s=void 0,e.prev=6,c=this.handlers[Symbol.iterator]();!(a=(u=c.next()).done);a=!0)((l=u.value).areas.includes(t.area)||l.areas.includes("*"))&&l.activationHandler&&l.activationHandler(t);e.next=14;break;case 10:e.prev=10,e.t0=e.catch(6),i=!0,s=e.t0;case 14:e.prev=14,e.prev=15,a||null==c.return||c.return();case 17:if(e.prev=17,!i){e.next=20;break}throw s;case 20:return e.finish(17);case 21:return e.finish(14);case 22:if(!n||r){e.next=26;break}return e.next=25,this.modelManager.setItemDirty(t,!0);case 25:this.syncService.sync();case 26:this.activeComponents.includes(t)||this.activeComponents.push(t),t.area===dt&&this.postActiveThemesToAllComponents();case 28:case"end":return e.stop()}}),e,this,[[6,10,14,22],[15,,17,21]])}))),function(e){return p.apply(this,arguments)})},{key:"deactivateComponent",value:(f=ni(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(r=f.length>1&&void 0!==f[1]&&f[1],n=!1!==t.active,t.active=!1,t.sessionKey=null,a=!0,i=!1,s=void 0,e.prev=7,c=this.handlers[Symbol.iterator]();!(a=(u=c.next()).done);a=!0)((l=u.value).areas.includes(t.area)||l.areas.includes("*"))&&l.activationHandler&&l.activationHandler(t);e.next=15;break;case 11:e.prev=11,e.t0=e.catch(7),i=!0,s=e.t0;case 15:e.prev=15,e.prev=16,a||null==c.return||c.return();case 18:if(e.prev=18,!i){e.next=21;break}throw s;case 21:return e.finish(18);case 22:return e.finish(15);case 23:if(!n||r){e.next=27;break}return e.next=26,this.modelManager.setItemDirty(t,!0);case 26:this.syncService.sync();case 27:jt()(this.activeComponents,t),this.streamObservers=this.streamObservers.filter((function(e){return e.component!==t})),this.contextStreamObservers=this.contextStreamObservers.filter((function(e){return e.component!==t})),t.area===dt&&this.postActiveThemesToAllComponents();case 31:case"end":return e.stop()}}),e,this,[[7,11,15,23],[16,,18,22]])}))),function(e){return f.apply(this,arguments)})},{key:"reloadComponent",value:(l=ni(o.a.mark((function e(t){var r,n,a,i,s,c,u=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t.active=!1,r=!0,n=!1,a=void 0,e.prev=4,i=this.handlers[Symbol.iterator]();!(r=(s=i.next()).done);r=!0)((c=s.value).areas.includes(t.area)||c.areas.includes("*"))&&c.activationHandler&&c.activationHandler(t);e.next=12;break;case 8:e.prev=8,e.t0=e.catch(4),n=!0,a=e.t0;case 12:e.prev=12,e.prev=13,r||null==i.return||i.return();case 15:if(e.prev=15,!n){e.next=18;break}throw a;case 18:return e.finish(15);case 19:return e.finish(12);case 20:return this.streamObservers=this.streamObservers.filter((function(e){return e.component!==t})),this.contextStreamObservers=this.contextStreamObservers.filter((function(e){return e.component!==t})),t.area===dt&&this.postActiveThemesToAllComponents(),e.abrupt("return",new Promise((function(e,r){u.timeout((function(){t.active=!0;var r=!0,n=!1,a=void 0;try{for(var o,i=u.handlers[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;(s.areas.includes(t.area)||s.areas.includes("*"))&&(s.activationHandler&&s.activationHandler(t),e())}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}u.activeComponents.includes(t)||u.activeComponents.push(t),t.area===dt&&u.postActiveThemesToAllComponents(),e()}))})));case 24:case"end":return e.stop()}}),e,this,[[4,8,12,20],[13,,15,19]])}))),function(e){return l.apply(this,arguments)})},{key:"deleteComponent",value:(u=ni(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.modelManager.setItemToBeDeleted(t);case 2:this.syncService.sync();case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"isComponentActive",value:function(e){return e.active}},{key:"iframeForComponent",value:function(e){for(var t=0,r=Array.from(document.getElementsByTagName("iframe"));t<r.length;t++){var n=r[t];if(n.dataset.componentId===e.uuid)return n}}},{key:"focusChangedForComponent",value:function(e){var t=document.activeElement===this.iframeForComponent(e),r=!0,n=!1,a=void 0;try{for(var o,i=this.handlers[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;s.focusHandler&&s.focusHandler(e,t)}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}},{key:"handleSetSizeEvent",value:function(e,t){var r=function(e,r){var n=Object(i.n)(r.width)?r.width:"".concat(t.width,"px"),a=Object(i.n)(r.height)?r.height:"".concat(t.height,"px");e&&e.setAttribute("style","width:".concat(n,"; height:").concat(a,";"))};if(e.area===gt||e.area===wt){var n=e.area===gt?"inner":"outer",a=document.getElementById("component-content-".concat(n,"-").concat(e.uuid));a&&r(a,t)}else{var o=this.iframeForComponent(e);if(!o)return;if(r(o,t),e.area===mt){var s=o.parentElement;s&&r(s,t)}}}},{key:"editorForNote",value:function(e){var t=this.componentsForArea(vt),r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(s.isExplicitlyEnabledForItem(e))return s}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}if(this.isMobile){if(!e.content.mobilePrefersPlainEditor)return this.getDefaultEditor()}else if(!e.getAppDataItem("prefersPlainEditor"))return t.filter((function(e){return e.isDefaultEditor()}))[0]}},{key:"permissionsStringForPermissions",value:function(e,t){var r="",n=e.length,a=function(e,t){return e>0?e===t-1?2===t?" and ":", and ":", ":""};return e.forEach((function(e,o){if(e.name===li){for(var i=e.content_types.map((function(e){var t,r,n=(t=e,(r={},s(r,c.Note,"note"),s(r,c.Tag,"tag"),s(r,c.SmartTag,"smart tag"),s(r,c.ActionsExtension,"action-based extension"),s(r,c.Component,"component"),s(r,c.Editor,"editor"),s(r,c.Theme,"theme"),s(r,c.ServerExtension,"server extension"),s(r,c.Mfa,"two-factor authentication setting"),s(r,c.FilesafeCredentials,"FileSafe credential"),s(r,c.FilesafeFileMetadata,"FileSafe file"),s(r,c.FilesafeIntegration,"FileSafe integration"),r)[t]);return n?n+"s":"items of type "+e})),u="",l=0;l<i.length;l++){var f=i[l];u+=a(l,i.length+n-o-1),u+=f}r+=a(o,n),r+=u,i.length>=2&&o<n-1&&(r+=", ")}else if(e.name===fi){var p,y=(ui(p={},mt,"working note"),ui(p,bt,"working note"),ui(p,vt,"working note"),p);r+=a(o,n),r+=y[t.area]}})),r+"."}},{key:"components",get:function(){return this.modelManager.getItems([c.Component,c.Theme])}}])&&ai(r.prototype,n),a&&ai(r,a),t}(ho);function ji(e){return(ji="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ii(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Ei(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ii(o,n,a,i,s,"next",e)}function s(e){Ii(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Di(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ci(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ri(e,t){return!t||"object"!==ji(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ai(e){return(Ai=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ti(e,t){return(Ti=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Mi=function(e){function t(){return Di(this,t),Ri(this,Ai(t).apply(this,arguments))}var r,n,a,s,c,u,l,f;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ti(e,t)}(t,e),r=t,(n=[{key:"getAbsolute",value:(f=Ei(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.url,n=t.params,a=t.authentication,e.abrupt("return",this.runHttp({verb:"get",url:r,params:n,authentication:a}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"postAbsolute",value:(l=Ei(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.url,n=t.params,a=t.authentication,e.abrupt("return",this.runHttp({verb:"post",url:r,params:n,authentication:a}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"patchAbsolute",value:(u=Ei(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.url,n=t.params,a=t.authentication,e.abrupt("return",this.runHttp({verb:"patch",url:r,params:n,authentication:a}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"runHttp",value:(c=Ei(o.a.mark((function e(t){var r,n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.verb,n=t.url,a=t.params,i=t.authentication,s=this.createRequest({verb:r,url:n,params:a,authentication:i}),e.abrupt("return",this.runRequest({request:s,verb:r,params:a}));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"createRequest",value:function(e){var t=e.verb,r=e.url,n=e.params,a=e.authentication,o=new XMLHttpRequest;return"get"===t&&Object.keys(n).length>0&&(r=this.urlForUrlAndParams(r,n)),o.open(t,r,!0),o.setRequestHeader("Content-type","application/json"),a&&o.setRequestHeader("Authorization","Bearer "+a),o}},{key:"runRequest",value:(s=Ei(o.a.mark((function e(t){var r,n,a,i=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.request,n=t.verb,a=t.params,e.abrupt("return",new Promise((function(e,t){r.onreadystatechange=function(){i.stateChangeHandlerForRequest(r,e,t)},"post"===n||"patch"===n?r.send(JSON.stringify(a)):r.send()})));case 2:case"end":return e.stop()}}),e)}))),function(e){return s.apply(this,arguments)})},{key:"stateChangeHandlerForRequest",value:function(e,t,r){if(4===e.readyState){var n=e.responseText;if(n)try{n=JSON.parse(n)}catch(e){}Object(i.m)(n)||(n={});var a=e.status;a>=200&&a<=299?(n.status=a,t(n)):(console.error("Request error:",n),Object(i.n)(n)&&(n={error:{message:n}}),n.error||(n.error={status:a}),n.status=a,r(n))}}},{key:"urlForUrlAndParams",value:function(e,t){var r=Object.keys(t).map((function(e){return e+"="+encodeURIComponent(t[e])})).join("&");return e.includes("?")?e+"&"+r:e+"?"+r}}])&&Ci(r.prototype,n),a&&Ci(r,a),t}(ho),Ki=r(53),Li=r.n(Ki);function Fi(e){return(Fi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ni(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var r=[],n=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Ui(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Bi(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ui(o,n,a,i,s,"next",e)}function s(e){Ui(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Vi(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Hi(e,t){return!t||"object"!==Fi(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Wi(e,t,r){return(Wi="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=zi(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function zi(e){return(zi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function qi(e,t){return(qi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Yi=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=Hi(this,zi(t).call(this))).mappingObservers=[],e.creationObservers=[],e.items=[],e.itemsKeys=[],e.notes=[],e.tags=[],e.components=[],e.itemsHash={},e.resolveQueue={},e.masterCollection=new f,e.systemSmartTags=Ir.systemSmartTags(),e}var r,n,a,s,u,l,p,y,h,d,m,b,g,w,k,x,S,P,O,_,j,I,E,D,C,R,A,T;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qi(e,t)}(t,e),r=t,(n=[{key:"getMasterCollection",value:function(){return this.masterCollection}},{key:"deinit",value:function(){Wi(zi(t.prototype),"deinit",this).call(this),this.resetState()}},{key:"resetState",value:function(){this.items.length=0,this.itemsKeys.length=0,this.notes.length=0,this.tags.length=0,this.components.length=0,this.itemsHash={},this.resolveQueue={},this.masterCollection=new f}},{key:"setItemProperties",value:(T=Bi(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.item,n=t.properties,e.abrupt("return",this.setItemsProperties({items:[r],properties:n}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return T.apply(this,arguments)})},{key:"setItemsProperties",value:(A=Bi(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p,y,h,v,d,m;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.items,n=t.properties,a=Object.keys(n),i=!0,s=!1,c=void 0,e.prev=5,u=r[Symbol.iterator]();case 7:if(i=(l=u.next()).done){e.next=31;break}for(f=l.value,p=!0,y=!1,h=void 0,e.prev=12,v=a[Symbol.iterator]();!(p=(d=v.next()).done);p=!0)m=d.value,f[m]=n[m];e.next=20;break;case 16:e.prev=16,e.t0=e.catch(12),y=!0,h=e.t0;case 20:e.prev=20,e.prev=21,p||null==v.return||v.return();case 23:if(e.prev=23,!y){e.next=26;break}throw h;case 26:return e.finish(23);case 27:return e.finish(20);case 28:i=!0,e.next=7;break;case 31:e.next=37;break;case 33:e.prev=33,e.t1=e.catch(5),s=!0,c=e.t1;case 37:e.prev=37,e.prev=38,i||null==u.return||u.return();case 40:if(e.prev=40,!s){e.next=43;break}throw c;case 43:return e.finish(40);case 44:return e.finish(37);case 45:return e.next=47,this.mapItems({items:r});case 47:case"end":return e.stop()}}),e,this,[[5,33,37,45],[12,16,20,28],[21,,23,27],[38,,40,44]])}))),function(e){return A.apply(this,arguments)})},{key:"modifyItem",value:(R=Bi(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.item,n=t.modifier,e.abrupt("return",this.modifyItems({items:[r],modifier:n}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return R.apply(this,arguments)})},{key:"modifyItems",value:(C=Bi(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.items,n=t.modifier,e.next=3,n();case 3:return e.next=5,this.setItemsDirty(r,!0);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"mapCollectionToLocalItems",value:(D=Bi(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.collection,n=t.sourceKey,e.abrupt("return",this.mapPayloadsToLocalItems({payloads:r.allPayloads,source:r.source,sourceKey:n}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return D.apply(this,arguments)})},{key:"mapItem",value:(E=Bi(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.item,n=t.source,a=t.sourceKey,e.next=3,this.mapItems({items:[r],source:n,sourceKey:a});case 3:return i=e.sent,e.abrupt("return",i[0]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"mapItems",value:(I=Bi(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.items,n=t.source,a=t.sourceKey,i=r.map((function(e){return e.payloadRepresentation()})),e.abrupt("return",this.mapPayloadsToLocalItems({payloads:i,source:n,sourceKey:a}));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"mapPayloadToLocalItem",value:(j=Bi(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.payload,e.next=3,this.mapPayloadsToLocalItems({payloads:[r]});case 3:return n=e.sent,e.abrupt("return",n[0]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return j.apply(this,arguments)})},{key:"mapPayloadsToLocalItems",value:(_=Bi(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,p,y,h,v,d,m,b,g,w,k,x,S,P,O,_,j,I,E,D,C,R;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.payloads,n=t.source,a=t.sourceKey,i=[],s=[],c={},u=!0,l=!1,p=void 0,e.prev=7,y=r[Symbol.iterator]();case 9:if(u=(h=y.next()).done){e.next=40;break}if(v=h.value){e.next=14;break}return console.error("Payload is null"),e.abrupt("continue",37);case 14:if(v.isPayload){e.next=16;break}throw"Attempting to map non-payload object into local model.";case 16:if(v.content_type&&v.uuid||v.deleted){e.next=20;break}return console.error("Payload is corrupt:",v),e.abrupt("continue",37);case 20:if(d=this.findItem(v.uuid),m=!1,!0!==v.deleted){e.next=34;break}if(!v.dirty){e.next=28;break}m=!0,d&&(this.removeItemFromRespectiveArray(d),d.updateLocalRelationships()),e.next=34;break;case 28:if(!d){e.next=33;break}return e.next=31,this.removeItemLocally(d);case 31:e.next=34;break;case 33:return e.abrupt("continue",37);case 34:d?d.updateFromPayload(v):(d=Yr(v),this.insertItems({items:[d],globalOnly:m}),s.push(d)),d.errorDecrypting||i.push(d),c[d.uuid]={item:d,payload:v};case 37:u=!0,e.next=9;break;case 40:e.next=46;break;case 42:e.prev=42,e.t0=e.catch(7),l=!0,p=e.t0;case 46:e.prev=46,e.prev=47,u||null==y.return||y.return();case 49:if(e.prev=49,!l){e.next=52;break}throw p;case 52:return e.finish(49);case 53:return e.finish(46);case 54:b=[],g=[],w=0,k=Object.keys(c);case 57:if(!(w<k.length)){e.next=89;break}if(x=k[w],S=c[x],P=S.item,O=S.payload,b.push(O),g.push(P),!O.content){e.next=65;break}return e.next=65,this.resolveReferencesForItem(P);case 65:for(_=this.popItemsInterestedInMissingItem({item:P}),j=!0,I=!1,E=void 0,e.prev=69,D=_[Symbol.iterator]();!(j=(C=D.next()).done);j=!0)C.value.addItemAsRelationship(P);e.next=77;break;case 73:e.prev=73,e.t1=e.catch(69),I=!0,E=e.t1;case 77:e.prev=77,e.prev=78,j||null==D.return||D.return();case 80:if(e.prev=80,!I){e.next=83;break}throw E;case 83:return e.finish(80);case 84:return e.finish(77);case 85:P.didCompleteMapping(n);case 86:w++,e.next=57;break;case 89:if(R=new f({payloads:g.map((function(e){return e.payloadRepresentation()})),source:n}),this.masterCollection=this.masterCollection.concat(R),!(s.length>0)){e.next=94;break}return e.next=94,this.notifyCreationObservers(s,n,a);case 94:return e.next=96,this.notifyMappingObservers(i,n,a);case 96:return e.abrupt("return",g);case 97:case"end":return e.stop()}}),e,this,[[7,42,46,54],[47,,49,53],[69,73,77,85],[78,,80,84]])}))),function(e){return _.apply(this,arguments)})},{key:"insertItem",value:function(e){var t=e.item;this.insertItems({items:[t]})}},{key:"insertItems",value:function(e){var t=e.items,r=e.globalOnly,n=!0,a=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var u=i.value;if(!this.itemsHash[u.uuid]&&(this.itemsHash[u.uuid]=u,this.items.push(u),!r))if(u.content_type===c.ItemsKey)this.itemsKeys.unshift(u);else if(u.content_type===c.Tag){var l=Li()(this.tags,u,(function(e){return e.title?e.title.toLowerCase():""}));this.tags.splice(l,0,u)}else u.content_type===c.Note?this.notes.unshift(u):u.content_type===c.Component&&this.components.unshift(u)}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}}},{key:"addItem",value:(O=Bi(o.a.mark((function e(t){var r,n=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>1&&void 0!==n[1]&&n[1],e.abrupt("return",this.addItems([t],r));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return O.apply(this,arguments)})},{key:"addItems",value:(P=Bi(o.a.mark((function e(t){var r,n=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.length>1&&void 0!==n[1]&&n[1],console.warn("ModelManager.addItems is depracated. Use mapPayloadsToLocalItems instead."),r=t.map((function(e){return no({object:e})})),e.next=5,this.mapPayloadsToLocalItems({payloads:r});case 5:case"end":return e.stop()}}),e,this)}))),function(e){return P.apply(this,arguments)})},{key:"resolveRelationshipWhenItemAvailable",value:function(e){var t=e.interestedItem,r=e.missingItemId,n=this.resolveQueue[r]||[];n.push(t),this.resolveQueue[r]=n}},{key:"popItemsInterestedInMissingItem",value:function(e){var t=e.item,r=this.resolveQueue[t.uuid];return delete this.resolveQueue[t.uuid],r||[]}},{key:"resolveReferencesForItem",value:(S=Bi(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p,y,h,v,d,m,b=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=b.length>1&&void 0!==b[1]&&b[1],!t.errorDecrypting){e.next=3;break}return e.abrupt("return");case 3:if(n=t.content,t.updateLocalRelationships(),n.references&&!t.deleted){e.next=7;break}return e.abrupt("return");case 7:a=n.references.slice(),i=a.map((function(e){return e.uuid})),s=!0,c=this.findItems(i,s),u=!0,l=!1,f=void 0,e.prev=14,p=c.entries()[Symbol.iterator]();case 16:if(u=(y=p.next()).done){e.next=30;break}if(h=Ni(y.value,2),v=h[0],!(d=h[1])){e.next=25;break}if(t.addItemAsRelationship(d),!r){e.next=23;break}return e.next=23,this.setItemDirty(d,!0);case 23:e.next=27;break;case 25:m=i[v],this.resolveRelationshipWhenItemAvailable({interestedItem:t,missingItemId:m});case 27:u=!0,e.next=16;break;case 30:e.next=36;break;case 32:e.prev=32,e.t0=e.catch(14),l=!0,f=e.t0;case 36:e.prev=36,e.prev=37,u||null==p.return||p.return();case 39:if(e.prev=39,!l){e.next=42;break}throw f;case 42:return e.finish(39);case 43:return e.finish(36);case 44:case"end":return e.stop()}}),e,this,[[14,32,36,44],[37,,39,43]])}))),function(e){return S.apply(this,arguments)})},{key:"addCreationObserver",value:function(e){var t=this;return this.creationObservers.push(e),function(){Et()(t.creationObservers,e)}}},{key:"notifyCreationObservers",value:(x=Bi(o.a.mark((function e(t,r,n){var a,i,s,c,u,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=!0,i=!1,s=void 0,e.prev=3,c=this.creationObservers[Symbol.iterator]();case 5:if(a=(u=c.next()).done){e.next=12;break}return l=u.value,e.next=9,l.callback({items:t,source:r,sourceKey:n});case 9:a=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),i=!0,s=e.t0;case 18:e.prev=18,e.prev=19,a||null==c.return||c.return();case 21:if(e.prev=21,!i){e.next=24;break}throw s;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e,t,r){return x.apply(this,arguments)})},{key:"addMappingObserver",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;Array.isArray(e)||(e=[e]);var a={types:e,priority:n,callback:t};return this.mappingObservers.push(a),function(){jt()(r.mappingObservers,a)}}},{key:"notifyMappingObservers",value:(k=Bi(o.a.mark((function e(t,r,n){var a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=this.mappingObservers.sort((function(e,t){return e.priority<t.priority?-1:1})),i=!0,s=!1,c=void 0,e.prev=4,u=o.a.mark((function e(){var a,i,s,c,u,l,p,y,h,v;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(a=f.value,i=a.types.includes("*")?t:t.filter((function(e){return a.types.includes(e.content_type)})),s=[],c=[],u=!0,l=!1,p=void 0,e.prev=7,y=i[Symbol.iterator]();!(u=(h=y.next()).done);u=!0)(v=h.value).deleted?c.push(v):s.push(v);e.next=15;break;case 11:e.prev=11,e.t0=e.catch(7),l=!0,p=e.t0;case 15:e.prev=15,e.prev=16,u||null==y.return||y.return();case 18:if(e.prev=18,!l){e.next=21;break}throw p;case 21:return e.finish(18);case 22:return e.finish(15);case 23:if(!(i.length>0)){e.next=26;break}return e.next=26,a.callback(i,s,c,r,n);case 26:case"end":return e.stop()}}),e,null,[[7,11,15,23],[16,,18,22]])})),l=a[Symbol.iterator]();case 7:if(i=(f=l.next()).done){e.next=12;break}return e.delegateYield(u(),"t0",9);case 9:i=!0,e.next=7;break;case 12:e.next=18;break;case 14:e.prev=14,e.t1=e.catch(4),s=!0,c=e.t1;case 18:e.prev=18,e.prev=19,i||null==l.return||l.return();case 21:if(e.prev=21,!s){e.next=24;break}throw c;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[4,14,18,26],[19,,21,25]])}))),function(e,t,r){return k.apply(this,arguments)})},{key:"setItemDirty",value:(w=Bi(o.a.mark((function e(t){var r,n,a,i,s=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=!(s.length>1&&void 0!==s[1])||s[1],n=s.length>2?s[2]:void 0,a=s.length>3?s[3]:void 0,i=s.length>4?s[4]:void 0,t.content_type===c.Tag&&this.reorderTagLocation(t),e.abrupt("return",this.setItemsDirty([t],r,n,a,i));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"setItemsDirty",value:(g=Bi(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p,y=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!(y.length>1&&void 0!==y[1])||y[1],n=y.length>2?y[2]:void 0,a=y.length>3?y[3]:void 0,i=y.length>4?y[4]:void 0,s=!0,c=!1,u=void 0,e.prev=7,l=t[Symbol.iterator]();case 9:if(s=(f=l.next()).done){e.next=17;break}if((p=f.value).isItem){e.next=13;break}throw"Attempting to dirty non-item object.";case 13:p.setDirty({dirty:r,updateClientDate:n,authorized:!0});case 14:s=!0,e.next=9;break;case 17:e.next=23;break;case 19:e.prev=19,e.t0=e.catch(7),c=!0,u=e.t0;case 23:e.prev=23,e.prev=24,s||null==l.return||l.return();case 26:if(e.prev=26,!c){e.next=29;break}throw u;case 29:return e.finish(26);case 30:return e.finish(23);case 31:return e.abrupt("return",this.mapItems({items:t,source:a||rn.LocalDirtied,sourceKey:i}));case 32:case"end":return e.stop()}}),e,this,[[7,19,23,31],[24,,26,30]])}))),function(e){return g.apply(this,arguments)})},{key:"duplicateItem",value:(b=Bi(o.a.mark((function e(t){var r,n,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.item,n=t.isConflict,r.isItem){e.next=3;break}throw"Attempting to duplicate non-item object.";case 3:return a=no({object:r}),e.next=6,Qr({payload:a,baseCollection:this.getMasterCollection(),isConflict:n});case 6:return i=e.sent,e.next=9,this.mapPayloadsToLocalItems({payloads:i});case 9:return s=e.sent,c=s.find((function(e){return e.uuid===i[0].uuid})),e.abrupt("return",c);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"createItem",value:(m=Bi(o.a.mark((function e(t){var r,n,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.contentType,n=t.content,a=t.add,i=t.needsSync,r){e.next=3;break}throw"Attempting to create item with no contentType";case 3:return e.t0=no,e.next=6,U.GenerateUuid();case 6:if(e.t1=e.sent,e.t2=r,e.t3=n,e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},e.t5={object:e.t4},s=(0,e.t0)(e.t5),c=Yr(s),!a){e.next=20;break}if(this.insertItem({item:c}),!i){e.next=18;break}return e.next=18,this.setItemDirty(c);case 18:return e.next=20,this.notifyCreationObservers([c]);case 20:return e.abrupt("return",c);case 21:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"getDirtyItems",value:function(){return this.items.filter((function(e){return e.dirty&&!e.dummy&&(!e.errorDecrypting||e.deleted)}))}},{key:"setItemToBeDeleted",value:(d=Bi(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.deleted=!0,t.dummy){e.next=4;break}return e.next=4,this.setItemDirty(t,!0);case 4:return e.next=6,this.handleReferencesForItemDeletion(t);case 6:this.removeItemFromRespectiveArray(t);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"setItemsToBeDeleted",value:(h=Bi(o.a.mark((function e(t){var r,n,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,n=!1,a=void 0,e.prev=3,i=t[Symbol.iterator]();case 5:if(r=(s=i.next()).done){e.next=12;break}return c=s.value,e.next=9,this.setItemToBeDeleted(c);case 9:r=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),n=!0,a=e.t0;case 18:e.prev=18,e.prev=19,r||null==i.return||i.return();case 21:if(e.prev=21,!n){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return h.apply(this,arguments)})},{key:"handleReferencesForItemDeletion",value:(y=Bi(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p,y,h,v,d;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.errorDecrypting){e.next=32;break}r=!0,n=!1,a=void 0,e.prev=4,i=t.content.references[Symbol.iterator]();case 6:if(r=(s=i.next()).done){e.next=18;break}if(c=s.value,!(u=this.findItem(c.uuid))){e.next=15;break}if(t.removeItemAsRelationship(u),!u.hasRelationshipWithItem(t)){e.next=15;break}return u.removeItemAsRelationship(t),e.next=15,this.setItemDirty(u,!0);case 15:r=!0,e.next=6;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(4),n=!0,a=e.t0;case 24:e.prev=24,e.prev=25,r||null==i.return||i.return();case 27:if(e.prev=27,!n){e.next=30;break}throw a;case 30:return e.finish(27);case 31:return e.finish(24);case 32:l=t.allReferencingItems,f=!0,p=!1,y=void 0,e.prev=36,h=l[Symbol.iterator]();case 38:if(f=(v=h.next()).done){e.next=46;break}return(d=v.value).removeItemAsRelationship(t),e.next=43,this.setItemDirty(d,!0);case 43:f=!0,e.next=38;break;case 46:e.next=52;break;case 48:e.prev=48,e.t1=e.catch(36),p=!0,y=e.t1;case 52:e.prev=52,e.prev=53,f||null==h.return||h.return();case 55:if(e.prev=55,!p){e.next=58;break}throw y;case 58:return e.finish(55);case 59:return e.finish(52);case 60:t.resetLocalReferencePointers();case 61:case"end":return e.stop()}}),e,this,[[4,20,24,32],[25,,27,31],[36,48,52,60],[53,,55,59]])}))),function(e){return y.apply(this,arguments)})},{key:"removeItemLocally",value:(p=Bi(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Et()(this.items,{uuid:t.uuid}),delete this.itemsHash[t.uuid],this.removeItemFromRespectiveArray(t),t.isBeingRemovedLocally();case 4:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"removeItemFromRespectiveArray",value:function(e){e.content_type===c.Tag?Et()(this.tags,{uuid:e.uuid}):e.content_type===c.Note?Et()(this.notes,{uuid:e.uuid}):e.content_type===c.Component?Et()(this.components,{uuid:e.uuid}):e.content_type===c.ItemsKey&&Et()(this.itemsKeys,{uuid:e.uuid})}},{key:"getItems",value:function(e){return Array.isArray(e)?this.allItems.filter((function(t){return!t.dummy&&(e.includes(t.content_type)||e.includes("*"))})):this.managedItemsForContentType(e)||this.getItems([e])}},{key:"managedItemsForContentType",value:function(e){return e===c.Note?this.notes:e===c.Component?this.components:e===c.Tag?this.tags:null}},{key:"invalidItems",value:function(){return this.allItems.filter((function(e){return e.errorDecrypting}))}},{key:"validItemsForContentType",value:function(e){return(this.managedItemsForContentType(e)||this.allItems).filter((function(t){return!t.errorDecrypting&&(Array.isArray(e)?e.includes(t.content_type):t.content_type===e)}))}},{key:"findItem",value:function(e){return this.itemsHash[e]}},{key:"findItems",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=[],n=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var c=i.value,u=this.itemsHash[c];(u||t)&&r.push(u)}}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return r}},{key:"itemsMatchingPredicate",value:function(e){return this.itemsMatchingPredicates([e])}},{key:"itemsMatchingPredicates",value:function(e){return this.filterItemsWithPredicates(this.allItems,e)}},{key:"filterItemsWithPredicates",value:function(e,t){return e.filter((function(e){if(e.deleted)return!1;var r=!0,n=!1,a=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;if(!e.satisfiesPredicate(s))return!1}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}return!0}))}},{key:"importPayloads",value:(l=Bi(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new xa({baseCollection:this.getMasterCollection(),applyCollection:new f({payloads:t,source:rn.FileImport})}),e.next=3,r.resultingCollection();case 3:return n=e.sent,e.next=6,this.mapCollectionToLocalItems({collection:n});case 6:a=e.sent,i=!0,s=!1,c=void 0,e.prev=10,u=a[Symbol.iterator]();case 12:if(i=(l=u.next()).done){e.next=20;break}return p=l.value,e.next=16,this.setItemDirty(p,!0,!1);case 16:p.deleted=!1;case 17:i=!0,e.next=12;break;case 20:e.next=26;break;case 22:e.prev=22,e.t0=e.catch(10),s=!0,c=e.t0;case 26:e.prev=26,e.prev=27,i||null==u.return||u.return();case 29:if(e.prev=29,!s){e.next=32;break}throw c;case 32:return e.finish(29);case 33:return e.finish(26);case 34:return e.abrupt("return",a);case 35:case"end":return e.stop()}}),e,this,[[10,22,26,34],[27,,29,33]])}))),function(e){return l.apply(this,arguments)})},{key:"noteCount",value:function(){return this.notes.filter((function(e){return!e.dummy})).length}},{key:"removeAllItemsFromMemory",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,a=this.items[Symbol.iterator]();!(e=(n=a.next()).done);e=!0)n.value.deleted=!0}catch(e){t=!0,r=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw r}}this.notifyMappingObservers(this.items),this.resetState()}},{key:"findTagByTitle",value:function(e){return Object(i.g)(this.tags,"title",e)}},{key:"findOrCreateTagByTitle",value:(u=Bi(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.findTagByTitle(t)){e.next=5;break}return e.next=4,this.createItem({contentType:"Tag",content:{title:t},add:!0,needsSync:!0});case 4:r=e.sent;case 5:return e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"reorderTagLocation",value:function(e){jt()(this.tags,e),this.tags.splice(Li()(this.tags,e,(function(e){return e.title?e.title.toLowerCase():""})),0,e)}},{key:"notesMatchingSmartTag",value:function(e){var t=[new v("content_type","=","Note"),e.content.predicate];if(!e.content.isTrashTag){var r=new v("content.trashed","=",!1);t.push(r)}return this.itemsMatchingPredicates(t)}},{key:"trashSmartTag",value:function(){return this.systemSmartTags.find((function(e){return e.content.isTrashTag}))}},{key:"trashedItems",value:function(){return this.notesMatchingSmartTag(this.trashSmartTag())}},{key:"emptyTrash",value:(s=Bi(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.trashedItems(),e.abrupt("return",this.setItemsToBeDeleted(t));case 2:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"getSmartTags",value:function(){var e=this.validItemsForContentType(c.SmartTag).sort((function(e,t){return e.content.title<t.content.title?-1:1}));return this.systemSmartTags.concat(e)}},{key:"allItems",get:function(){return this.items.slice()}},{key:"allNondummyItems",get:function(){return this.items.filter((function(e){return!e.dummy}))}},{key:"nonDeletedItems",get:function(){return this.items.filter((function(e){return!e.dummy&&!e.deleted}))}}])&&Vi(r.prototype,n),a&&Vi(r,a),t}(ho);function Gi(e){return(Gi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ji(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Qi(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ji(o,n,a,i,s,"next",e)}function s(e){Ji(o,n,a,i,s,"throw",e)}i(void 0)}))}}function $i(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Xi(e,t){return!t||"object"!==Gi(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Zi(e){return(Zi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function es(e,t){return(es=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ts=function(e){function t(e){var r,n=e.modelManager,a=e.syncService;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Xi(this,Zi(t).call(this))).syncService=a,r.modelManager=n,r.addObservers(),r.resolveQueue=[],r.registeredPredicates=[],r}var r,n,a,s,c,u;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&es(e,t)}(t,e),r=t,(n=[{key:"popResolveQueue",value:function(){var e=this.resolveQueue.slice();return this.resolveQueue=[],e}},{key:"addObservers",value:function(){var e=this;this.modelManager.addCreationObserver({callback:function(t){var r=t.items;e.resolveQueue=e.resolveQueue.concat(r)}}),this.syncService.addEventObserver(function(){var t=Qi(o.a.mark((function t(r){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r!==d.DownloadFirstSyncCompleted&&r!==d.FullSyncCompleted){t.next=3;break}return t.next=3,e.resolveSingletonsForItems(e.popResolveQueue(),r);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"registerPredicate",value:function(e){this.registeredPredicates.push(e)}},{key:"validItemsMatchingPredicate",value:function(e){return this.modelManager.itemsMatchingPredicate(e).filter((function(e){return!e.deleted&&!e.errorDecrypting}))}},{key:"resolveSingletonsForItems",value:(u=Qi(o.a.mark((function e(t,r){var n,a,s,c,u,l,f,p,y,h,v,m=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=function(e){var t=!0,r=!1,n=void 0;try{for(var a,o=m.registeredPredicates[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;if(e.satisfiesPredicate(i))return m.validItemsMatchingPredicate(i)}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}},a=function(e){return e.isSingleton?m.validItemsMatchingPredicate(e.singletonPredicate):null},s=function(e){var t=a(e);return t||n(e)},c=[],u=!0,l=!1,f=void 0,e.prev=7,p=t[Symbol.iterator]();case 9:if(u=(y=p.next()).done){e.next=22;break}if(h=y.value,!c.includes(h)){e.next=13;break}return e.abrupt("continue",19);case 13:if(v=s(h),Object(i.f)(c,v||[]),v&&!(v.length<=1)){e.next=17;break}return e.abrupt("continue",19);case 17:return e.next=19,this.handleStrategy({items:v,strategy:h.singletonStrategy});case 19:u=!0,e.next=9;break;case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(7),l=!0,f=e.t0;case 28:e.prev=28,e.prev=29,u||null==p.return||p.return();case 31:if(e.prev=31,!l){e.next=34;break}throw f;case 34:return e.finish(31);case 35:return e.finish(28);case 36:c.length>0&&r===d.FullSyncCompleted&&setTimeout((function(){m.syncService.sync()}));case 37:case"end":return e.stop()}}),e,this,[[7,24,28,36],[29,,31,35]])}))),function(e,t){return u.apply(this,arguments)})},{key:"handleStrategy",value:(c=Qi(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.items,t.strategy===W){e.next=3;break}throw"Unhandled singleton strategy";case 3:return n=r.sort((function(e,t){return e.errorDecrypting?1:t.errorDecrypting||e.created_at<t.created_at?-1:1})),a=Object(i.c)(n,0),e.next=7,this.modelManager.setItemsToBeDeleted(a);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"findOrCreateSingleton",value:(s=Qi(o.a.mark((function e(t){var r,n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.predicate,n=t.createPayload,!((a=this.validItemsMatchingPredicate(r)).length>0)){e.next=4;break}return e.abrupt("return",a[0]);case 4:if(this.syncService.getLastSyncDate()){e.next=7;break}return e.next=7,this.syncService.sync();case 7:if(!((i=this.validItemsMatchingPredicate(r)).length>0)){e.next=10;break}return e.abrupt("return",i[0]);case 10:return s=this.modelManager.itemsMatchingPredicate(r).filter((function(e){return e.errorDecrypting})),e.next=13,this.modelManager.setItemsToBeDeleted(s);case 13:return e.t0=so,e.t1=n,e.next=17,U.GenerateUuid();case 17:return e.t2=e.sent,e.t3={uuid:e.t2,dirty:!0},e.t4={payload:e.t1,override:e.t3},c=(0,e.t0)(e.t4),e.next=23,this.modelManager.mapPayloadToLocalItem({payload:c});case 23:return u=e.sent,e.next=26,this.syncService.sync();case 26:return e.abrupt("return",u);case 27:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})}])&&$i(r.prototype,n),a&&$i(r,a),t}(ho);function rs(e){return(rs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ns(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function as(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){ns(o,n,a,i,s,"next",e)}function s(e){ns(o,n,a,i,s,"throw",e)}i(void 0)}))}}function os(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function is(e,t){return!t||"object"!==rs(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ss(e){return(ss=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function cs(e,t){return(cs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var us=function(e){function t(e){var r,n=e.alertService,a=e.deviceInterface,o=e.httpService,i=e.modelManager,s=e.protocolService,c=e.syncService;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=is(this,ss(t).call(this))).alertService=n,r.deviceInterface=a,r.httpService=o,r.modelManager=i,r.protocolService=s,r.syncService=c,r.previousPasswords=[],r}var r,n,a,i,s,u,l,f,p,y,h,v;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&cs(e,t)}(t,e),r=t,(n=[{key:"getExtensions",value:function(){return this.modelManager.validItemsForContentType(c.ActionsExtension)}},{key:"extensionsInContextOfItem",value:function(e){return this.getExtensions().filter((function(t){return t.supported_types.includes(e.content_type)||t.actionsWithContextForItem(e).length>0}))}},{key:"loadExtensionInContextOfItem",value:(v=as(o.a.mark((function e(t,r){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={content_type:r.content_type,item_uuid:r.uuid},e.abrupt("return",this.httpService.getAbsolute({url:t.url,params:n}).then((function(e){return e.description&&(t.description=e.description),e.supported_types&&(t.supported_types=e.supported_types),e.actions?t.actions=e.actions.map((function(e){return new Bt(e)})):t.actions=[],t})).catch((function(e){return console.error("Error loading extension",e),null})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return v.apply(this,arguments)})},{key:"runAction",value:(h=as(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.action,n=t.item,a=t.passwordRequestHandler,r.running=!0,e.t0=r.verb,e.next="get"===e.t0?5:"render"===e.t0?9:"show"===e.t0?13:"post"===e.t0?17:21;break;case 5:return e.next=7,this.handleGetAction({action:r,passwordRequestHandler:a});case 7:return i=e.sent,e.abrupt("break",22);case 9:return e.next=11,this.handleRenderAction({action:r,passwordRequestHandler:a});case 11:return i=e.sent,e.abrupt("break",22);case 13:return e.next=15,this.handleShowAction(r);case 15:return i=e.sent,e.abrupt("break",22);case 17:return e.next=19,this.handlePostAction(r,n);case 19:return i=e.sent,e.abrupt("break",22);case 21:return e.abrupt("break",22);case 22:return r.lastExecuted=new Date,r.running=!1,e.abrupt("return",i);case 25:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"handleGetAction",value:(y=as(o.a.mark((function e(t){var r,n,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.action,n=t.passwordRequestHandler,e.abrupt("return",new Promise((function(e,t){a.alertService.confirm({text:"Are you sure you want to replace the current note contents with this action's results?",onConfirm:function(){a.runConfirmedGetAction({action:r,passwordRequestHandler:n}).then(e)}})})));case 2:case"end":return e.stop()}}),e)}))),function(e){return y.apply(this,arguments)})},{key:"runConfirmedGetAction",value:(p=as(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p,y,h=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.action,n=t.passwordRequestHandler,e.next=3,this.httpService.getAbsolute({url:r.url}).catch((function(e){var t=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return h.alertService.alert({text:t.message}),r.error=!0,{error:t}}));case 3:if(!(a=e.sent).error){e.next=6;break}return e.abrupt("return",a);case 6:return r.error=!1,e.next=9,this.payloadByDecryptingResponse({response:a,passwordRequestHandler:n});case 9:return i=e.sent,e.next=12,this.modelManager.mapPayload({payload:i,source:rn.RemoteActionRetrieved});case 12:for(s=e.sent,c=!0,u=!1,l=void 0,e.prev=16,f=s[Symbol.iterator]();!(c=(p=f.next()).done);c=!0)y=p.value,this.modelManager.setItemDirty(y,!0);e.next=24;break;case 20:e.prev=20,e.t0=e.catch(16),u=!0,l=e.t0;case 24:e.prev=24,e.prev=25,c||null==f.return||f.return();case 27:if(e.prev=27,!u){e.next=30;break}throw l;case 30:return e.finish(27);case 31:return e.finish(24);case 32:return this.syncService.sync(),e.abrupt("return",{response:a,item:a.item});case 34:case"end":return e.stop()}}),e,this,[[16,20,24,32],[25,,27,31]])}))),function(e){return p.apply(this,arguments)})},{key:"handleRenderAction",value:(f=as(o.a.mark((function e(t){var r,n,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.action,n=t.passwordRequestHandler,e.abrupt("return",this.httpService.getAbsolute({url:r.url}).then(function(){var e=as(o.a.mark((function e(t){var i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.error=!1,e.next=3,a.payloadByDecryptingResponse({response:t,passwordRequestHandler:n});case 3:if(!(i=e.sent)){e.next=7;break}return s=a.modelManager.mapPayload({payload:i}),e.abrupt("return",{response:t,item:s});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){var t=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return a.alertService.alert({text:t.message}),r.error=!0,{error:t}})));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"payloadByDecryptingResponse",value:(l=as(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f,p,y,h,v,d,m;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.response,n=t.key,a=t.passwordRequestHandler,i=no({object:r.item}),e.next=4,this.protocolService.payloadByDecryptingPayload({payload:i,key:n});case 4:if((s=e.sent).errorDecrypting){e.next=7;break}return e.abrupt("return",s);case 7:if(r.auth_params){e.next=10;break}return this.alertService.alert({text:"We were unable to decrypt this revision using your current keys, \n            and this revision is missing metadata that would allow us to try different \n            keys to decrypt it. This can likely be fixed with some manual intervention. \n            Please email hello@standardnotes.org for assistance."}),e.abrupt("return",null);case 10:c=[],u=!0,l=!1,f=void 0,e.prev=14,p=this.previousPasswords[Symbol.iterator]();case 16:if(u=(y=p.next()).done){e.next=34;break}if(h=y.value,!c.includes(h)){e.next=20;break}return e.abrupt("continue",31);case 20:return c.push(h),e.next=23,this.protocolService.computeRootKey({password:h,keyParams:r.auth_params});case 23:if(v=e.sent){e.next=26;break}return e.abrupt("continue",31);case 26:return e.next=28,this.payloadByDecryptingResponse({response:r,key:v,passwordRequestHandler:a});case 28:if(!(d=e.sent)){e.next=31;break}return e.abrupt("return",d);case 31:u=!0,e.next=16;break;case 34:e.next=40;break;case 36:e.prev=36,e.t0=e.catch(14),l=!0,f=e.t0;case 40:e.prev=40,e.prev=41,u||null==p.return||p.return();case 43:if(e.prev=43,!l){e.next=46;break}throw f;case 46:return e.finish(43);case 47:return e.finish(40);case 48:return e.next=50,a();case 50:return m=e.sent,this.previousPasswords.push(m),e.abrupt("return",this.payloadByDecryptingResponse({response:r,key:n,passwordRequestHandler:a}));case 53:case"end":return e.stop()}}),e,this,[[14,36,40,48],[41,,43,47]])}))),function(e){return l.apply(this,arguments)})},{key:"handlePostAction",value:(u=as(o.a.mark((function e(t,r){var n,a,i,s=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="decrypted"===t.access_type,e.next=3,this.outgoingPayloadForItem({item:r,decrypted:n});case 3:return a=e.sent,i={items:[a]},e.abrupt("return",this.httpService.postAbsolute({url:t.url,params:i}).then((function(e){return t.error=!1,{response:e}})).catch((function(e){return t.error=!0,console.error("Action error response:",e),s.alertService.alert({text:"An issue occurred while processing this action. Please try again."}),{response:e}})));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"handleShowAction",value:(s=as(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.deviceInterface.openUrl(t.url),e.abrupt("return",{response:null});case 2:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"outgoingPayloadForItem",value:(i=as(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.item,n=t.decrypted,a=void 0!==n&&n?G.FileDecrypted:G.FileEncrypted,e.abrupt("return",this.protocolService.payloadByEncryptingPayload({payload:r.payloadRepresentation(),intent:a}));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})}])&&os(r.prototype,n),a&&os(r,a),t}(ho);function ls(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function fs(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){ls(o,n,a,i,s,"next",e)}function s(e){ls(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ps(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var ys=function(){function e(t){var r=t.application,n=t.challengeResponder;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.application=r,this.challengeResponder=n,this.stageHandlers={},this.registerStageHandlers()}var t,r,n,a,i;return t=e,r=[{key:"registerStageHandlers",value:function(){throw"Must override Migration.registerStageHandlers"}},{key:"registerStageHandler",value:function(e,t){this.stageHandlers[e]=t}},{key:"markDone",value:function(){this.done=!0,this.onDoneHandler&&this.onDoneHandler(),this.onDoneHandler=null}},{key:"onDone",value:function(e){this.onDoneHandler=e}},{key:"handleStage",value:(i=fs(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=this.stageHandlers[t])){e.next=4;break}return e.next=4,r();case 4:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"requestChallengeResponse",value:(a=fs(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.challengeResponder(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})}],n=[{key:"timestamp",value:function(){throw"Must override Migration.timestamp"}}],r&&ps(t.prototype,r),n&&ps(t,n),e}();function hs(e){return(hs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function vs(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ds(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ms(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){ds(o,n,a,i,s,"next",e)}function s(e){ds(o,n,a,i,s,"throw",e)}i(void 0)}))}}function bs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function gs(e,t){return!t||"object"!==hs(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ws(e,t,r){return(ws="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ks(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function ks(e){return(ks=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function xs(e,t){return(xs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ss={Default:1,Ephemeral:2},Ps={Default:1,Disabled:2},Os={Default:1,Nonwrapped:2},_s={Wrapped:"wrapped",Unwrapped:"unwrapped",Nonwrapped:"nonwrapped"},js=function(e){function t(e){var r,n=e.protocolService,a=e.deviceInterface,o=e.namespace;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=gs(this,ks(t).call(this))).deviceInterface=a,r.protocolService=n,r.namespace=o,r.setPersistencePolicy(Ss.Default),r.setEncryptionPolicy(Ps.Default),r.storagePersistable=!1,r}var r,n,a,s,u,l,f,p,y,h,v,d,m,b,g,w,k,S,P,O,_,j,I,E;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&xs(e,t)}(t,e),r=t,n=[{key:"handleApplicationStage",value:(E=ms(o.a.mark((function e(r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ws(ks(t.prototype),"handleApplicationStage",this).call(this,r);case 2:r===x&&(this.storagePersistable=!0);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"setPersistencePolicy",value:(I=ms(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy=t,this.persistencePolicy!==Ss.Ephemeral){e.next=6;break}return e.next=4,this.deviceInterface.removeAllRawStorageValues();case 4:return e.next=6,this.clearAllPayloads();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"setEncryptionPolicy",value:(j=ms(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.encryptionPolicy=t;case 1:case"end":return e.stop()}}),e,this)}))),function(e){return j.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.persistencePolicy===Ss.Ephemeral}},{key:"initializeFromDisk",value:(_=ms(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getRawStorageValue(this.getPersistenceKey());case 2:t=e.sent,r=t?JSON.parse(t):null,this.setInitialValues(r);case 5:case"end":return e.stop()}}),e,this)}))),function(){return _.apply(this,arguments)})},{key:"persistAsValueToDisk",value:(O=ms(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.setRawStorageValue(this.getPersistenceKey(),JSON.stringify(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return O.apply(this,arguments)})},{key:"setInitialValues",value:function(e){e||(e=this.defaultValuesObject()),e[_s.Unwrapped]||(e[_s.Unwrapped]={}),this.values=e}},{key:"isStorageWrapped",value:function(){var e=this.values[_s.Wrapped];return!Object(i.l)(e)&&Object.keys(e).length>0}},{key:"canDecryptWithKey",value:(P=ms(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.values[_s.Wrapped],e.next=3,this.decryptWrappedValue({wrappedValue:r,key:t,throws:!1});case 3:return n=e.sent,e.abrupt("return",!n.errorDecrypting);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return P.apply(this,arguments)})},{key:"decryptWrappedValue",value:(S=ms(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.wrappedValue,n=t.key,r.content_type){e.next=3;break}throw"Attempting to decrypt nonexistent wrapped value";case 3:return a=no({object:r,override:{content_type:c.EncryptedStorage}}),e.next=6,this.protocolService.payloadByDecryptingPayload({payload:a,key:n});case 6:return i=e.sent,e.abrupt("return",i);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"decryptStorage",value:(k=ms(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.values[_s.Wrapped],e.next=3,this.decryptWrappedValue({wrappedValue:t});case 3:if(!(r=e.sent).errorDecrypting){e.next=6;break}throw"Unable to decrypt storage.";case 6:this.values[_s.Unwrapped]=Object(i.a)(r.content),delete this.values[_s.Wrapped];case 8:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"generatePersistenceValue",value:(w=ms(o.a.mark((function e(){var t,r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object.assign({},this.values),r=t[_s.Unwrapped],e.t0=no,e.next=5,U.GenerateUuid();case 5:return e.t1=e.sent,e.t2=r,e.t3=c.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},e.t5={object:e.t4},n=(0,e.t0)(e.t5),e.next=13,this.protocolService.payloadByEncryptingPayload({payload:n,intent:G.LocalStoragePreferEncrypted});case 13:return a=e.sent,t[_s.Wrapped]=a,t[_s.Unwrapped]=null,e.abrupt("return",t);case 17:case"end":return e.stop()}}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"repersistToDisk",value:(g=ms(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.storagePersistable){e.next=2;break}return e.abrupt("return");case 2:if(this.persistencePolicy!==Ss.Ephemeral){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,this.generatePersistenceValue();case 6:return t=e.sent,this.values[_s.Wrapped]=t[_s.Wrapped],e.abrupt("return",this.persistAsValueToDisk(t));case 9:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"setValue",value:(b=ms(o.a.mark((function e(t,r){var n,a=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=a.length>2&&void 0!==a[2]?a[2]:Os.Default,this.values){e.next=3;break}throw"Attempting to set storage key ".concat(t," before loading local storage.");case 3:return this.values[this.domainKeyForMode(n)][t]=r,e.abrupt("return",this.repersistToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return b.apply(this,arguments)})},{key:"getValue",value:(m=ms(o.a.mark((function e(t){var r,n=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.length>1&&void 0!==n[1]?n[1]:Os.Default,this.values){e.next=3;break}throw"Attempting to get storage key ".concat(t," before loading local storage.");case 3:if(this.values[this.domainKeyForMode(r)]){e.next=5;break}throw"Storage domain mode not available ".concat(r," for key ").concat(t);case 5:return e.abrupt("return",this.values[this.domainKeyForMode(r)][t]);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"removeValue",value:(d=ms(o.a.mark((function e(t){var r,n=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.length>1&&void 0!==n[1]?n[1]:Os.Default,this.values){e.next=3;break}throw"Attempting to remove storage key ".concat(t," before loading local storage.");case 3:return delete this.values[this.domainKeyForMode(r)][t],e.abrupt("return",this.repersistToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"getPersistenceKey",value:function(){return M(this.namespace,T.StorageObject)}},{key:"defaultValuesObject",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.wrapped,r=e.unwrapped,n=e.nonwrapped;return this.constructor.defaultValuesObject({wrapped:t,unwrapped:r,nonwrapped:n})}},{key:"domainKeyForMode",value:function(e){return this.constructor.domainKeyForMode(e)}},{key:"clearValues",value:(v=ms(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setInitialValues(),e.next=3,this.repersistToDisk();case 3:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"getAllRawPayloads",value:(h=ms(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.getAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"savePayload",value:(y=ms(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.savePayloads([t]));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"savePayloads",value:(p=ms(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy!==Ss.Ephemeral){e.next=2;break}return e.abrupt("return");case 2:r=[],n=[],a=!0,i=!1,s=void 0,e.prev=7,c=t[Symbol.iterator]();case 9:if(a=(u=c.next()).done){e.next=22;break}if(!(l=u.value).discardable){e.next=15;break}r.push(l),e.next=19;break;case 15:return e.next=17,this.protocolService.payloadByEncryptingPayload({payload:l,intent:this.encryptionPolicy===Ps.Default?G.LocalStoragePreferEncrypted:G.LocalStorageDecrypted});case 17:f=e.sent,n.push(f);case 19:a=!0,e.next=9;break;case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(7),i=!0,s=e.t0;case 28:e.prev=28,e.prev=29,a||null==c.return||c.return();case 31:if(e.prev=31,!i){e.next=34;break}throw s;case 34:return e.finish(31);case 35:return e.finish(28);case 36:if(!(r.length>0)){e.next=39;break}return e.next=39,this.deletePayloads(r);case 39:return e.next=41,this.deviceInterface.saveRawDatabasePayloads(n);case 41:case"end":return e.stop()}}),e,this,[[7,24,28,36],[29,,31,35]])}))),function(e){return p.apply(this,arguments)})},{key:"deletePayloads",value:(f=ms(o.a.mark((function e(t){var r,n,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,n=!1,a=void 0,e.prev=3,i=t[Symbol.iterator]();case 5:if(r=(s=i.next()).done){e.next=12;break}return c=s.value,e.next=9,this.deletePayloadWithId(c.uuid);case 9:r=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),n=!0,a=e.t0;case 18:e.prev=18,e.prev=19,r||null==i.return||i.return();case 21:if(e.prev=21,!n){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return f.apply(this,arguments)})},{key:"deletePayloadWithId",value:(l=ms(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.removeRawDatabasePayloadWithId(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"clearAllPayloads",value:(u=ms(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.removeAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"clearAllData",value:(s=ms(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([this.clearValues(),this.clearAllPayloads()]));case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})}],a=[{key:"defaultValuesObject",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.wrapped,n=void 0===r?{}:r,a=t.unwrapped,o=void 0===a?{}:a,i=t.nonwrapped,s=void 0===i?{}:i;return vs(e={},_s.Wrapped,n),vs(e,_s.Unwrapped,o),vs(e,_s.Nonwrapped,s),e}},{key:"domainKeyForMode",value:function(e){if(e===Os.Default)return _s.Unwrapped;if(e===Os.Nonwrapped)return _s.Nonwrapped;throw"Invalid mode"}}],n&&bs(r.prototype,n),a&&bs(r,a),t}(ho);function Is(e){return(Is="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Es(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ds(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Cs(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ds(o,n,a,i,s,"next",e)}function s(e){Ds(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Rs(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function As(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ts(e,t){return!t||"object"!==Is(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ms(e){return(Ms=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ks(e,t){return(Ks=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ls=function(e){function t(){return Rs(this,t),Ts(this,Ms(t).apply(this,arguments))}var r,n,a,s,u,l,f,p,y,h,v,d;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ks(e,t)}(t,e),r=t,n=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(g,Cs(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!C(e.application.environment)){t.next=4;break}return t.abrupt("return",e.migrateStorageStructureForWebDesktop());case 4:if(!R(e.application.environment)){t.next=6;break}return t.abrupt("return",e.migrateStorageStructureForMobile());case 6:case"end":return t.stop()}}),t)})))),this.registerStageHandler(k,Cs(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateArbitraryRawStorageToManagedStorageAllPlatforms();case 2:return t.next=4,e.migrateSessionStorage();case 4:case"end":return t.stop()}}),t)})))),this.registerStageHandler(S,Cs(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.createDefaultItemsKeyForAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateStorageStructureForWebDesktop",value:(d=Cs(o.a.mark((function e(){var t,r,n,a,s,c,u,l,f,p,y,h,v,d,m,b,g,w;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.application.deviceInterface,Es(t={},_s.Wrapped,null),Es(t,_s.Unwrapped,{}),Es(t,_s.Nonwrapped,{}),n=t,e.next=4,r.getJsonParsedStorageValue("auth_params");case 4:return(a=e.sent)&&(n.nonwrapped[T.RootKeyParams]=a),e.next=8,r.getJsonParsedStorageValue("encryptedStorage");case 8:if(!(s=e.sent)){e.next=35;break}return c=no({object:s}),e.next=13,this.webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage(c);case 13:if(u=e.sent,l=u.key,f=u.decryptedStoragePayload,p=u.keyParams,n.nonwrapped[T.RootKeyWrapperKeyParams]=p.getPortableValue(),y=Object(i.a)(f.content.storage),n.nonwrapped[T.RootKeyParams]=y.auth_params,h=l,Object(i.l)(y.mk)){e.next=30;break}return e.next=25,this.webDesktopHelperExtractAndWrapAccountKeysFromValueStore(l,y);case 25:v=e.sent,d=v.accountKey,m=v.wrappedKey,h=d,n.nonwrapped[T.WrappedRootKey]=m;case 30:return e.next=32,this.webDesktopHelperEncryptStorage(h,f,y);case 32:n.wrapped=e.sent,e.next=55;break;case 35:return e.next=37,this.application.deviceInterface.getRawStorageValue("ak");case 37:return b=e.sent,g=Object(i.l)(b)?q.V002:q.V003,e.t0=re,e.next=42,this.application.deviceInterface.getRawStorageValue("mk");case 42:return e.t1=e.sent,e.next=45,this.application.deviceInterface.getRawStorageValue("pw");case 45:return e.t2=e.sent,e.t3=b,e.t4=g,e.t5={masterKey:e.t1,serverPassword:e.t2,dataAuthenticationKey:e.t3,version:e.t4},e.t6={content:e.t5},e.next=52,e.t0.Create.call(e.t0,e.t6);case 52:return w=e.sent,e.next=55,this.application.deviceInterface.setKeychainValue(w.getPersistableValue());case 55:return e.next=57,this.allPlatformHelperSetStorageStructure(n);case 57:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"allPlatformHelperSetStorageStructure",value:(v=Cs(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=js.defaultValuesObject(t))[_s.Unwrapped]=null,e.next=4,this.application.deviceInterface.setRawStorageValue(M(this.application.namespace,T.StorageObject),JSON.stringify(r));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage",value:(h=Cs(o.a.mark((function e(t){var r,n,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.application.deviceInterface.getJsonParsedStorageValue("offlineParams");case 2:r=e.sent,n=this.application.protocolService.createKeyParams(r),a={errorDecrypting:!0};case 5:if(!a.errorDecrypting){e.next=18;break}return e.next=8,this.requestChallengeResponse(A.LocalPasscode);case 8:return s=e.sent,c=s.value,e.next=12,this.application.protocolService.computeRootKey({password:c,keyParams:n});case 12:return i=e.sent,e.next=15,this.application.protocolService.payloadByDecryptingPayload({payload:t,key:i});case 15:a=e.sent,e.next=5;break;case 18:return e.abrupt("return",{decryptedStoragePayload:a,key:i,keyParams:n});case 19:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"webDesktopHelperExtractAndWrapAccountKeysFromValueStore",value:(y=Cs(o.a.mark((function e(t,r){var n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.ak?q.V003:q.V002,e.next=3,re.Create({content:{masterKey:r.mk,serverPassword:r.pw,dataAuthenticationKey:r.ak,version:n}});case 3:if(a=e.sent,delete r.mk,delete r.pw,delete r.ak,i=no({object:a}),!t){e.next=12;break}return e.next=11,this.application.protocolService.payloadByEncryptingPayload({payload:i,key:t,intent:G.LocalStorageEncrypted});case 11:s=e.sent;case 12:return e.abrupt("return",{accountKey:a,wrappedKey:s});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"webDesktopHelperEncryptStorage",value:(p=Cs(o.a.mark((function e(t,r,n){var a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.application.protocolService.payloadByEncryptingPayload({key:t,intent:G.LocalStoragePreferEncrypted,payload:so({payload:r,override:{content_type:c.EncryptedStorage,content:n}})});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return p.apply(this,arguments)})},{key:"migrateStorageStructureForMobile",value:(f=Cs(o.a.mark((function e(){var t,r,n,a,s,u,l,f,p,y,h,v,d,m,b,g,w,k,x,S,P=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.application.deviceInterface.getJsonParsedStorageValue("encrypted_account_keys");case 2:return r=e.sent,e.next=5,this.application.deviceInterface.getJsonParsedStorageValue("auth_params");case 5:return n=e.sent,e.next=8,this.application.deviceInterface.getJsonParsedStorageValue("pc_params");case 8:return a=e.sent,s={nonwrapped:(t={},Es(t,T.WrappedRootKey,r),Es(t,T.RootKeyWrapperKeyParams,a),Es(t,T.RootKeyParams,n),t),unwrapped:{}},e.next=12,this.application.deviceInterface.getKeychainValue();case 12:if(u=e.sent,!a){e.next=57;break}if(l=this.application.protocolService.createKeyParams(a),f=function(){var e=Cs(o.a.mark((function e(){var t,r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=u.offline.pw,r={serverPassword:null};case 2:if(r.serverPassword===t){e.next=12;break}return e.next=5,P.requestChallengeResponse(A.LocalPasscode);case 5:return n=e.sent,a=n.value,e.next=9,P.application.protocolService.computeRootKey({password:a,keyParams:l});case 9:r=e.sent,e.next=2;break;case 12:return e.abrupt("return",r);case 13:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),p=u.offline.timing,s.unwrapped[T.MobilePasscodeTiming]=p,!r){e.next=36;break}return e.next=21,f();case 21:return y=e.sent,e.next=24,this.application.protocolService.payloadByDecryptingPayload({payload:no({object:r}),key:y});case 24:return h=e.sent,v=h.content.accountKeys,d=Object(i.l)(v.ak)?q.V002:q.V003,m=so({payload:h,override:{content:{masterKey:v.mk,serverPassword:v.pw,dataAuthenticationKey:v.ak,version:v.version||d,accountKeys:null}}}),e.next=30,this.application.protocolService.payloadByEncryptingPayload({payload:m,key:y,intent:G.LocalStoragePreferEncrypted});case 30:return b=e.sent,s.nonwrapped[T.WrappedRootKey]=b,e.next=34,this.application.deviceInterface.clearKeychainValue();case 34:e.next=55;break;case 36:if(r){e.next=55;break}return e.next=39,f();case 39:return g=e.sent,e.t0=no,e.next=43,U.GenerateUuid();case 43:return e.t1=e.sent,e.t2=s.unwrapped,e.t3=c.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},e.t5={object:e.t4},w=(0,e.t0)(e.t5),e.next=51,this.application.protocolService.payloadByEncryptingPayload({payload:w,key:g,intent:G.LocalStoragePreferEncrypted});case 51:return k=e.sent,s.wrapped=k,e.next=55,this.application.deviceInterface.clearKeychainValue();case 55:e.next=65;break;case 57:if(!u||!u.mk){e.next=65;break}return x=Object(i.l)(u.ak)?q.V002:q.V003,e.next=62,re.Create({content:{masterKey:u.mk,serverPassword:u.pw,dataAuthenticationKey:u.ak,version:u.version||x}});case 62:return S=e.sent,e.next=65,this.application.deviceInterface.setKeychainValue(S.getPersistableValue());case 65:return e.next=67,this.allPlatformHelperSetStorageStructure(s);case 67:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"migrateArbitraryRawStorageToManagedStorageAllPlatforms",value:(l=Cs(o.a.mark((function e(){var t,r,n,a,s,c,u,l,f,p,y,h;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.application.deviceInterface.getAllRawStorageKeyValues();case 2:t=e.sent,r=[M(this.application.namespace,T.StorageObject),"encryptedStorage","offlineParams","pc_params"],n=function(e){try{return JSON.parse(e)}catch(t){return e}},a=!0,s=!1,c=void 0,e.prev=8,u=t[Symbol.iterator]();case 10:if(a=(l=u.next()).done){e.next=23;break}if(f=l.value,p=f.key,y=f.value,!r.includes(p)){e.next=16;break}return e.abrupt("continue",20);case 16:if(Object(i.l)(y)){e.next=20;break}return h=n(y),e.next=20,this.application.storageService.setValue(p,h);case 20:a=!0,e.next=10;break;case 23:e.next=29;break;case 25:e.prev=25,e.t0=e.catch(8),s=!0,c=e.t0;case 29:e.prev=29,e.prev=30,a||null==u.return||u.return();case 32:if(e.prev=32,!s){e.next=35;break}throw c;case 35:return e.finish(32);case 36:return e.finish(29);case 37:case"end":return e.stop()}}),e,this,[[8,25,29,37],[30,,32,36]])}))),function(){return l.apply(this,arguments)})},{key:"migrateSessionStorage",value:(u=Cs(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.application.storageService.getValue("jwt");case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return");case 5:return r=new Po(t),e.next=8,this.application.storageService.setValue(T.Session,r);case 8:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"createDefaultItemsKeyForAllPlatforms",value:(s=Cs(o.a.mark((function e(){var t,r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.application.keyManager.getRootKey();case 2:if(!(t=e.sent)){e.next=14;break}return e.next=6,this.application.keyManager.getRootKeyParams();case 6:return r=e.sent,n=ct.FromRaw({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:r.version}),e.next=10,n.initUUID();case 10:return e.next=12,this.application.modelManager.mapItem({item:n});case 12:return e.next=14,this.application.modelManager.setItemDirty(n);case 14:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})}],a=[{key:"timestamp",value:function(){return new Date("2020-01-15").getTime()}}],n&&As(r.prototype,n),a&&As(r,a),t}(ys);function Fs(e){return(Fs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ns(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Us(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ns(o,n,a,i,s,"next",e)}function s(e){Ns(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Bs(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Vs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Hs(e,t){return!t||"object"!==Fs(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ws(e){return(Ws=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function zs(e,t){return(zs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var qs=function(e){function t(){return Bs(this,t),Hs(this,Ws(t).apply(this,arguments))}var r,n,a,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&zs(e,t)}(t,e),r=t,n=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(g,Us(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateMigrationTimestampAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateMigrationTimestampAllPlatforms",value:(s=Us(o.a.mark((function e(){var t,r,n,a,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!1,r=0,n=["migrations","ephemeral","user","cachedThemes","syncToken"];case 3:if(!(r<n.length)){e.next=14;break}return a=n[r],e.next=7,this.application.deviceInterface.getRawStorageValue(a);case 7:if(!e.sent){e.next=11;break}return t=!0,e.abrupt("break",14);case 11:r++,e.next=3;break;case 14:return s=M(this.application.namespace,"last_migration_timestamp"),e.next=17,this.application.deviceInterface.getRawStorageValue(s);case 17:if(c=e.sent,(u=!Object(i.l)(c))||!t){e.next=25;break}return l=new Date(0).getTime(),e.next=23,this.application.deviceInterface.setRawStorageValue(s,l);case 23:e.next=32;break;case 25:if(u||t){e.next=31;break}return f=(new Date).getTime(),e.next=29,this.application.deviceInterface.setRawStorageValue(s,f);case 29:e.next=32;break;case 31:case 32:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})}],a=[{key:"timestamp",value:function(){return new Date("2020-01-01").getTime()}}],n&&Vs(r.prototype,n),a&&Vs(r,a),t}(ys);function Ys(e){return(Ys="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Gs(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Js(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Gs(o,n,a,i,s,"next",e)}function s(e){Gs(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Qs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function $s(e,t){return!t||"object"!==Ys(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Xs(e,t,r){return(Xs="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Zs(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Zs(e){return(Zs=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ec(e,t){return(ec=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tc=function(e){function t(e){var r,n=e.application,a=e.challengeResponder;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=$s(this,Zs(t).call(this))).application=n,r.challengeResponder=a,r}var r,a,s,c,u,l,f,p,y,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ec(e,t)}(t,e),r=t,(a=[{key:"initialize",value:(h=Js(o.a.mark((function e(){var t,r=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.runBaseMigration();case 2:return e.next=4,this.getRequiredMigrations();case 4:this.activeMigrations=e.sent,this.activeMigrations.length>0&&(t=Object(i.q)(this.activeMigrations)).onDone(Js(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.saveLastMigrationTimestamp(t.constructor.timestamp());case 2:case"end":return e.stop()}}),e)}))));case 6:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"handleApplicationStage",value:(y=Js(o.a.mark((function e(r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Xs(Zs(t.prototype),"handleApplicationStage",this).call(this,r);case 2:return r===w&&(this.addLoginObserver(),this.addSyncObserver()),e.next=5,this.handleStage(r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"runBaseMigration",value:(p=Js(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new qs({application:this.application}),e.next=3,t.handleStage(g);case 3:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"getRequiredMigrations",value:(f=Js(o.a.mark((function e(){var t,r,a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLastMigrationTimestamp();case 2:for(t=e.sent,r=[],a=Object.keys(n).map((function(e){return n[e]})).sort((function(e,t){var r=e.timestamp(),n=t.timestamp();return r<n?-1:r>n?1:0})),i=!0,s=!1,c=void 0,e.prev=8,u=a[Symbol.iterator]();!(i=(l=u.next()).done);i=!0)(f=l.value).timestamp()>t&&r.push(new f({application:this.application,challengeResponder:this.challengeResponder}));e.next=16;break;case 12:e.prev=12,e.t0=e.catch(8),s=!0,c=e.t0;case 16:e.prev=16,e.prev=17,i||null==u.return||u.return();case 19:if(e.prev=19,!s){e.next=22;break}throw c;case 22:return e.finish(19);case 23:return e.finish(16);case 24:return e.abrupt("return",r);case 25:case"end":return e.stop()}}),e,this,[[8,12,16,24],[17,,19,23]])}))),function(){return f.apply(this,arguments)})},{key:"getTimeStampKey",value:function(){return M(this.application.namespace,"last_migration_timestamp")}},{key:"getLastMigrationTimestamp",value:(l=Js(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.application.deviceInterface.getRawStorageValue(this.getTimeStampKey());case 2:if(t=e.sent,!Object(i.l)(t)){e.next=5;break}throw"Timestamp should not be null. Be sure to run base migration first.";case 5:return e.abrupt("return",JSON.parse(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"saveLastMigrationTimestamp",value:(u=Js(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.application.deviceInterface.setRawStorageValue(this.getTimeStampKey(),JSON.stringify(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"addLoginObserver",value:function(){var e=this;this.application.addEventObserver(function(){var t=Js(o.a.mark((function t(r,n){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r!==b.SignedIn){t.next=3;break}return t.next=3,e.handleStage(_);case 3:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"addSyncObserver",value:function(){var e=this;this.application.syncService.addEventObserver(function(){var t=Js(o.a.mark((function t(r,n){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r!==d.FullSyncCompleted){t.next=3;break}return t.next=3,e.handleStage(O);case 3:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"handleStage",value:(c=Js(o.a.mark((function e(t){var r,n,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,n=!1,a=void 0,e.prev=3,i=this.activeMigrations[Symbol.iterator]();case 5:if(r=(s=i.next()).done){e.next=12;break}return c=s.value,e.next=9,c.handleStage(t);case 9:r=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),n=!0,a=e.t0;case 18:e.prev=18,e.prev=19,r||null==i.return||i.return();case 21:if(e.prev=21,!n){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return c.apply(this,arguments)})}])&&Qs(r.prototype,a),s&&Qs(r,s),t}(ho);function rc(e){return(rc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function nc(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ac(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function oc(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){ac(o,n,a,i,s,"next",e)}function s(e){ac(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ic(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function sc(e,t){return!t||"object"!==rc(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function cc(e,t,r){return(cc="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=uc(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function uc(e){return(uc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function lc(e,t){return(lc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var fc=function(e){function t(e){var r,n=e.modelManager,a=e.crypto;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!n)throw"Invalid ProtocolService construction.";return(r=sc(this,uc(t).call(this))).operators=[],r.modelManager=n,r.crypto=a,!r.crypto&&Object(i.o)()&&Object(se.isWebCryptoAvailable)()&&(r.crypto=new se.SNWebCrypto),U.SetGenerators({syncImpl:r.crypto.generateUUIDSync,asyncImpl:r.crypto.generateUUIDSync}),r}var r,n,a,s,c,u,l,f,p,y,h,v,d,m,b;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&lc(e,t)}(t,e),r=t,(n=[{key:"setKeyManager",value:function(e){this.keyManager=e}},{key:"setItemsKeyManager",value:function(e){var t=this;this.keyObsUnsubscribe=e.addItemsKeyChangeObserver(oc(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.decryptErroredItems();case 2:case"end":return e.stop()}}),e)}))))}},{key:"deinit",value:(b=oc(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.keyObsUnsubscribe(),e.abrupt("return",cc(uc(t.prototype),"deinit",this).call(this));case 2:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"getLatestVersion",value:function(){return q.V004}},{key:"getUserVersion",value:(m=oc(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.keyManager.getRootKeyParams();case 2:return t=e.sent,e.abrupt("return",t&&t.version);case 4:case"end":return e.stop()}}),e,this)}))),function(){return m.apply(this,arguments)})},{key:"upgradeAvailable",value:(d=oc(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getUserVersion();case 2:return e.t0=e.sent,e.t1=this.getLatestVersion(),e.abrupt("return",e.t0!==e.t1);case 5:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"platformSupportsKeyDerivation",value:function(e){return Y(e.version,q.V004)>=0||!!Object(se.isWebCryptoAvailable)()}},{key:"supportedVersions",value:function(){return[q.V001,q.V002,q.V003,q.V004]}},{key:"isVersionNewerThanLibraryVersion",value:function(e){return 1===Y(e,this.getLatestVersion())}},{key:"isProtocolVersionOutdated",value:function(e){var t={};t[q.V001]=Date.parse("2018-01-01"),t[q.V002]=Date.parse("2020-01-01");var r=t[e];return!!r&&new Date>r}},{key:"costMinimumForVersion",value:function(e){if(Y(e,q.V003)>=0)throw"Cost minimums only apply to versions <= 002";if(e===q.V001)return Se.pwCost();if(e===q.V002)return Te.pwCost();throw"Invalid version for cost minimum: ".concat(e)}},{key:"createOperatorForLatestVersion",value:function(){return this.createOperatorForVersion(this.getLatestVersion())}},{key:"createOperatorForVersion",value:function(e){if(e===q.V001)return new Se(this.crypto);if(e===q.V002)return new Te(this.crypto);if(e===q.V003)return new He(this.crypto);if(e===q.V004)return new et(this.crypto);if(e===q.V000Base64Decrypted)return this.createOperatorForLatestVersion();throw"Unable to find operator for version ".concat(e)}},{key:"operatorForVersion",value:function(e){var t=e,r=this.operators[t];return r||(r=this.createOperatorForVersion(e),this.operators[t]=r),r}},{key:"defaultOperator",value:function(){return this.operatorForVersion(this.getLatestVersion())}},{key:"computeRootKey",value:(v=oc(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.password,n=t.keyParams,a=n.version,i=this.operatorForVersion(a),e.abrupt("return",i.computeRootKey({password:r,keyParams:n}));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"createRootKey",value:(h=oc(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.identifier,n=t.password,a=this.defaultOperator(),e.abrupt("return",a.createRootKey({identifier:r,password:n}));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"payloadContentFormatForIntent",value:function(e){var t=e.key,r=e.intent;if(t){if(r===G.Sync||r===G.FileEncrypted||r===G.FilePreferEncrypted||r===G.LocalStorageEncrypted||r===G.LocalStoragePreferEncrypted)return ie.EncryptedString;throw"Unhandled encrypted case in protocolService.payloadContentFormatForIntent."}if(r===G.LocalStorageDecrypted||r===G.LocalStoragePreferEncrypted||r===G.FileDecrypted||r===G.FilePreferEncrypted)return ie.DecryptedBareObject;if(r===G.SyncDecrypted)return ie.DecryptedBase64String;throw"Unhandled decrypted case in protocolService.payloadContentFormatForIntent."}},{key:"payloadByEncryptingPayload",value:(y=oc(o.a.mark((function e(t){var r,n,a,s,c,u,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.payload,n=t.key,a=t.intent,!r.errorDecrypting){e.next=3;break}return e.abrupt("return",r);case 3:if(!Object(i.l)(a)){e.next=5;break}throw"Attempting to encrypt payload with null intent";case 5:if(n||$(a)){e.next=9;break}return e.next=8,this.keyManager.keyToUseForEncryptionOfPayload({payload:r,intent:a});case 8:n=e.sent;case 9:if(n||!X(a)){e.next=11;break}throw"Attempting to generate encrypted payload with no key.";case 11:if(r.getFormat()===ie.DecryptedBareObject){e.next=13;break}throw"Attempting to encrypt already encrypted payload.";case 13:if(r.isPayload){e.next=15;break}throw"Attempting to encrypt non-payload.";case 15:if(r.content){e.next=17;break}throw"Attempting to encrypt payload with no content.";case 17:if(r.uuid){e.next=19;break}throw"Attempting to encrypt payload with no uuid.";case 19:return s=n?n.version:this.getLatestVersion(),c=this.payloadContentFormatForIntent({key:n,intent:a}),u=this.operatorForVersion(s),e.next=24,u.generateEncryptionParameters({payload:r,key:n,format:c});case 24:if(l=e.sent){e.next=27;break}throw"Unable to generate encryption parameters";case 27:return e.abrupt("return",ao({object:r,override:l,intent:a}));case 28:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"payloadsByEncryptingPayloads",value:(p=oc(o.a.mark((function e(t){var r,n,a,s,c,u,l,f,p,y,h;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.payloads,n=t.intent,a=[],s=!0,c=!1,u=void 0,e.prev=5,l=r[Symbol.iterator]();case 7:if(s=(f=l.next()).done){e.next=17;break}return p=f.value,y=Object(i.k)(n)?n(p):n,e.next=12,this.payloadByEncryptingPayload({payload:p,intent:y});case 12:h=e.sent,a.push(h);case 14:s=!0,e.next=7;break;case 17:e.next=23;break;case 19:e.prev=19,e.t0=e.catch(5),c=!0,u=e.t0;case 23:e.prev=23,e.prev=24,s||null==l.return||l.return();case 26:if(e.prev=26,!c){e.next=29;break}throw u;case 29:return e.finish(26);case 30:return e.finish(23);case 31:return e.abrupt("return",a);case 32:case"end":return e.stop()}}),e,this,[[5,19,23,31],[24,,26,30]])}))),function(e){return p.apply(this,arguments)})},{key:"payloadByDecryptingPayload",value:(f=oc(o.a.mark((function e(t){var r,n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.payload,n=t.key,r.content){e.next=3;break}throw"Attempting to decrypt payload that has no content.";case 3:if(r.isPayload){e.next=5;break}throw"Attempting to decrypt non-payload.";case 5:if((a=r.getFormat())!==ie.DecryptedBareObject){e.next=8;break}return e.abrupt("return",r);case 8:if(n||a!==ie.EncryptedString){e.next=14;break}return e.next=11,this.keyManager.keyToUseForDecryptionOfPayload({payload:r});case 11:if(n=e.sent){e.next=14;break}return e.abrupt("return",no({object:r,override:{waitingForKey:!0,errorDecrypting:!0}}));case 14:return i=r.version,s=this.operatorForVersion(i),c=co(r),e.next=19,s.generateDecryptedParameters({encryptedParameters:c,key:n});case 19:return u=e.sent,e.abrupt("return",no({object:r,override:u}));case 21:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"payloadsByDecryptingPayloads",value:(l=oc(o.a.mark((function e(t){var r,n,a,s,c,u,l,f,p,y,h;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.payloads,n=t.key,a=[],s=!0,c=!1,u=void 0,e.prev=5,l=r[Symbol.iterator]();case 7:if(s=(f=l.next()).done){e.next=35;break}if(p=f.value){e.next=12;break}return a.push(p),e.abrupt("continue",32);case 12:if(p.isPayload){e.next=14;break}throw"Attempting to decrypt non-payload object in payloadsByDecryptingPayloads.";case 14:if(!0!==p.deleted||!Object(i.l)(p.content)){e.next=17;break}return a.push(p),e.abrupt("continue",32);case 17:if(Object(i.n)(p.content)){e.next=21;break}return a.push(p),e.abrupt("continue",32);case 21:return e.prev=21,e.next=24,this.payloadByDecryptingPayload({payload:p,key:n});case 24:y=e.sent,a.push(y),e.next=32;break;case 28:e.prev=28,e.t0=e.catch(21),a.push(no({object:p,override:(h={},nc(h,fe.ErrorDecrypting,!0),nc(h,fe.ErrorDecryptingChanged,!p.errorDecrypting),h)})),console.error("Error decrypting payload",p,e.t0);case 32:s=!0,e.next=7;break;case 35:e.next=41;break;case 37:e.prev=37,e.t1=e.catch(5),c=!0,u=e.t1;case 41:e.prev=41,e.prev=42,s||null==l.return||l.return();case 44:if(e.prev=44,!c){e.next=47;break}throw u;case 47:return e.finish(44);case 48:return e.finish(41);case 49:return e.abrupt("return",a);case 50:case"end":return e.stop()}}),e,this,[[5,37,41,49],[21,28],[42,,44,48]])}))),function(e){return l.apply(this,arguments)})},{key:"decryptErroredItems",value:(u=oc(o.a.mark((function e(){var t,r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(t=this.modelManager.allItems.filter((function(e){return e.waitingForKey||e.errorDecrypting}))).length){e.next=3;break}return e.abrupt("return");case 3:return r=t.map((function(e){return e.payloadRepresentation()})),e.next=6,this.payloadsByDecryptingPayloads({payloads:r});case 6:return n=e.sent,e.next=9,this.modelManager.mapPayloadsToLocalItems({payloads:n});case 9:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"payloadsByDecryptingBackupFile",value:(c=oc(o.a.mark((function e(t){var r,n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.data,n=t.password,a=r.keyParams||r.auth_params,i=r.items,s=i.map((function(e){return oo({object:e,source:rn.FileImport})})),!a){e.next=13;break}return e.next=7,this.computeRootKey({password:n,keyParams:a});case 7:return u=e.sent,e.next=10,this.payloadsByDecryptingPayloads({payloads:s,key:u});case 10:c=e.sent,e.next=14;break;case 13:c=s;case 14:return e.abrupt("return",c);case 15:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"createKeyParams",value:function(e){if(e.isKeyParamsObject)throw"Attempting to create key params from non-raw value.";return e.version||(e.version=q.V002),ae(e)}},{key:"createBackupFile",value:(s=oc(o.a.mark((function e(){var t,r,n,a,i,s,c,u,l,f,p=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=p.length>0&&void 0!==p[0]?p[0]:{},r=t.subItems,n=t.intent,a=t.returnIfEmpty,i=r||this.modelManager.allItems,!a||0!==i.length){e.next=4;break}return e.abrupt("return",null);case 4:return n||(n=G.FilePreferEncrypted),s=i.map((function(e){return no({object:e})})),e.next=8,this.payloadsByEncryptingPayloads({payloads:s,intent:n});case 8:return c=e.sent,u={items:c},e.next=12,this.keyManager.getRootKeyParams();case 12:return(l=e.sent)&&n!==G.FileDecrypted&&(u.keyParams=l.getPortableValue()),f=2,e.abrupt("return",JSON.stringify(u,null,f));case 16:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})}])&&ic(r.prototype,n),a&&ic(r,a),t}(ho);function pc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var yc=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.item=Object(i.e)({},t),this.defaultContentKeyToDiffOn="text",this.textCharDiffLength=0,Object(i.n)(this.item.updated_at)&&(this.item.updated_at=new Date(this.item.updated_at))}var t,r,n;return t=e,(r=[{key:"setPreviousEntry",value:function(e){this.hasPreviousEntry=null!=e,this.item.content[this.defaultContentKeyToDiffOn]&&(this.textCharDiffLength=e?this.item.content[this.defaultContentKeyToDiffOn].length-e.item.content[this.defaultContentKeyToDiffOn].length:this.item.content[this.defaultContentKeyToDiffOn].length)}},{key:"operationVector",value:function(){return void 0!==this.textCharDiffLength?this.hasPreviousEntry&&0!==this.textCharDiffLength?this.textCharDiffLength<0?-1:1:0:1}},{key:"deltaSize",value:function(){return void 0!==this.textCharDiffLength?Math.abs(this.textCharDiffLength):1}},{key:"isSameAsEntry",value:function(e){if(!e)return!1;var t=new z(no({object:this.item})),r=new z(no({object:e.item}));return t.isItemContentEqualWith(r)}}])&&pc(t.prototype,r),n&&pc(t,n),e}();function hc(e){return(hc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function vc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function dc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function mc(e,t){return!t||"object"!==hc(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function bc(e){return(bc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function gc(e,t){return(gc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wc=function(e){function t(){return vc(this,t),mc(this,bc(t).apply(this,arguments))}var r,n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&gc(e,t)}(t,e),r=t,(n=[{key:"previewTitle",value:function(){return this.item.updated_at.toLocaleString()}},{key:"previewSubTitle",value:function(){return this.hasPreviousEntry?this.textCharDiffLength<0?"".concat(-1*this.textCharDiffLength," characters removed"):this.textCharDiffLength>0?"".concat(this.textCharDiffLength," characters added"):"Title or metadata changed":"".concat(this.textCharDiffLength," characters loaded")}}])&&dc(r.prototype,n),a&&dc(r,a),t}(yc);function kc(e){var t,r,n,a=(t={},r=c.Note,n=wc,r in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,t)[e.content_type];if(!a)throw"Invalid item history class";return new a(e)}function xc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Sc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Pc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(xc(this,e),this.entries||(this.entries=[]),t.entries){var r=!0,n=!1,a=void 0;try{for(var o,i=t.entries[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value,c=this.createEntryForItem(s.item);c.setPreviousEntry(this.getLastEntry()),this.entries.push(c)}}catch(e){n=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw a}}}}var t,r,n;return t=e,(r=[{key:"createEntryForItem",value:function(e){return kc(e)}},{key:"getLastEntry",value:function(){return this.entries[this.entries.length-1]}},{key:"addHistoryEntryForItem",value:function(e){var t=this.createEntryForItem(e),r=this.getLastEntry();if(t.setPreviousEntry(r),!t.isSameAsEntry(r))return this.entries.push(t),t}},{key:"clear",value:function(){this.entries.length=0}},{key:"optimize",value:function(){var e=this,t=[],r=function(e){return e.deltaSize()>15},n=function(n,a,o){if(o)t.push(n);else{var i=t.indexOf(n);-1!==i&&t.splice(i,1)}if(o&&r(n)&&-1===n.operationVector()){var s=e.entries[a-1];s&&t.push(s)}};this.entries.forEach((function(t,a){if(0===a||a===e.entries.length-1)n(t,a,!0);else{var o=r(t);n(t,a,o)}})),this.entries=this.entries.filter((function(e,r){return-1!==t.indexOf(e)}))}}])&&Sc(t.prototype,r),n&&Sc(t,n),e}();function Oc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var _c=function(){function e(t){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Object.assign(this,t),this.content||(this.content={}),this.content.itemUUIDToItemHistoryMapping||(this.content.itemUUIDToItemHistoryMapping={}),Object.keys(this.content.itemUUIDToItemHistoryMapping).forEach((function(e){var t=r.content.itemUUIDToItemHistoryMapping[e];r.content.itemUUIDToItemHistoryMapping[e]=new Pc(t)})),this.setItemRevisionThreshold(60)}var t,r,n;return t=e,(r=[{key:"addEntryForItem",value:function(e){return this.historyForItem(e).addHistoryEntryForItem(e)}},{key:"historyForItem",value:function(e){var t=this.content.itemUUIDToItemHistoryMapping[e.uuid];return t||(t=new Pc,this.content.itemUUIDToItemHistoryMapping[e.uuid]=t),t}},{key:"clearItemHistory",value:function(e){this.historyForItem(e).clear()}},{key:"clearAllHistory",value:function(){this.content.itemUUIDToItemHistoryMapping={}}},{key:"setItemRevisionThreshold",value:function(e){this.itemRevisionThreshold=e}},{key:"optimizeHistoryForItem",value:function(e){var t=this.historyForItem(e);t.entries.length>this.itemRevisionThreshold&&t.optimize()}}])&&Oc(t.prototype,r),n&&Oc(t,n),e}();function jc(e){return(jc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ic(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Ec(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ic(o,n,a,i,s,"next",e)}function s(e){Ic(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Dc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Cc(e,t){return!t||"object"!==jc(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Rc(e){return(Rc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ac(e,t){return(Ac=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Tc=function(e){function t(e){var r,n=e.modelManager,a=e.storageService,o=e.contentTypes,i=e.timeout;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=Cc(this,Rc(t).call(this))).modelManager=n,r.storageService=a,r.contentTypes=o,r.timeout=i,r}var r,n,a,s,c,u,l,f,p,y;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ac(e,t)}(t,e),r=t,(n=[{key:"initializeFromDisk",value:(y=Ec(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(T.SessionHistoryPersistable);case 2:return this.persistable=e.sent,e.next=5,this.storageService.getValue(T.SessionHistoryRevisions).then((function(e){return new _c(e)}));case 5:return this.historySession=e.sent,e.next=8,this.storageService.getValue(T.SessionHistoryOptimize);case 8:t=e.sent,Object(i.l)(t)?this.autoOptimize=!0:this.autoOptimize=t,this.addMappingObserver();case 11:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"addMappingObserver",value:function(){var e=this;this.modelManager.addMappingObserver(this.contentTypes,(function(t,r,n,a,o){if(a!==rn.LocalDirtied){var i=!0,s=!1,c=void 0;try{for(var u,l=t[Symbol.iterator]();!(i=(u=l.next()).done);i=!0){var f=u.value;try{f.deleted||e.addHistoryEntryForItem(f)}catch(e){console.error("Unable to add item history entry:",e)}}}catch(e){s=!0,c=e}finally{try{i||null==l.return||l.return()}finally{if(s)throw c}}}}))}},{key:"isDiskEnabled",value:function(){return this.persistable}},{key:"isAutoOptimizeEnabled",value:function(){return this.autoOptimize}},{key:"saveToDisk",value:(p=Ec(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable){e.next=2;break}return e.abrupt("return");case 2:this.storageService.setValue(T.SessionHistoryRevisions,this.historySession);case 3:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"setSessionItemRevisionThreshold",value:function(e){this.historySession.setItemRevisionThreshold(e)}},{key:"addHistoryEntryForItem",value:(f=Ec(o.a.mark((function e(t){var r,n,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r={uuid:t.uuid,content_type:t.content_type,updated_at:t.updated_at,content:t.getContentCopy()},n=this.historySession.addEntryForItem(r),this.autoOptimize&&this.historySession.optimizeHistoryForItem(t),n&&this.persistable&&(this.diskTimeout&&(this.timeout.hasOwnProperty("cancel")?this.timeout.cancel(this.diskTimeout):clearTimeout(this.diskTimeout)),this.diskTimeout=this.timeout((function(){a.saveToDisk()}),2e3));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"historyForItem",value:function(e){return this.historySession.historyForItem(e)}},{key:"clearHistoryForItem",value:(l=Ec(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearItemHistory(t),e.abrupt("return",this.saveToDisk());case 2:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"clearAllHistory",value:(u=Ec(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearAllHistory(),e.abrupt("return",this.storageService.removeValue(T.SessionHistoryRevisions));case 2:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"toggleDiskSaving",value:(c=Ec(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable=!this.persistable,!this.persistable){e.next=6;break}this.storageService.setValue(T.SessionHistoryPersistable,!0),this.saveToDisk(),e.next=8;break;case 6:return this.storageService.setValue(T.SessionHistoryPersistable,!1),e.abrupt("return",this.storageService.removeValue(T.SessionHistoryRevisions));case 8:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"toggleAutoOptimize",value:(s=Ec(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.autoOptimize=!this.autoOptimize,this.autoOptimize?this.storageService.setValue(T.SessionHistoryOptimize,!0):this.storageService.setValue(T.SessionHistoryOptimize,!1);case 2:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})}])&&Dc(r.prototype,n),a&&Dc(r,a),t}(ho);function Mc(e){return(Mc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Kc(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Lc(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Kc(o,n,a,i,s,"next",e)}function s(e){Kc(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Fc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Nc(e,t){return!t||"object"!==Mc(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Uc(e){return(Uc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Bc(e,t){return(Bc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Vc={ManageExtensions:"ActionManageExtensions",ManageBackups:"ActionManageBackups",ViewProtectedNotes:"ActionViewProtectedNotes",ManagePrivileges:"ActionManagePrivileges",ManagePasscode:"ActionManagePasscode",DeleteNote:"ActionDeleteNote"},Hc={AccountPassword:"CredentialAccountPassword",LocalPasscode:"CredentialLocalPasscode"},Wc=0,zc=300,qc=3600,Yc=604800,Gc=function(e){function t(e){var r,n=e.modelManager,a=e.syncService,o=e.singletonManager,i=e.keyManager,s=e.storageService,c=e.sessionManager;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!(n&&a&&o&&i))throw"Invalid privileges manager construction.";return(r=Nc(this,Uc(t).call(this))).modelManager=n,r.syncService=a,r.singletonManager=o,r.keyManager=i,r.storageService=s,r.sessionManager=c,r.loadDefaults(),r}var r,n,a,i,s,c,u,l,f,p,y,h,d,m;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Bc(e,t)}(t,e),r=t,(n=[{key:"loadDefaults",value:function(){this.availableActions=Object.keys(Vc).map((function(e){return Vc[e]})),this.availableCredentials=[Hc.AccountPassword,Hc.LocalPasscode],this.sessionLengths=[Wc,zc,qc,Yc]}},{key:"getAvailableActions",value:function(){return this.availableActions}},{key:"getAvailableCredentials",value:function(){return this.availableCredentials}},{key:"netCredentialsForAction",value:(m=Lc(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getPrivileges();case 2:r=e.sent,n=r.getCredentialsForAction(t),a=[],i=!0,s=!1,c=void 0,e.prev=8,u=n[Symbol.iterator]();case 10:if(i=(l=u.next()).done){e.next=27;break}if((f=l.value)!==Hc.AccountPassword){e.next=19;break}return e.next=15,this.sessionManager.online();case 15:e.sent&&a.push(f),e.next=24;break;case 19:if(f!==Hc.LocalPasscode){e.next=24;break}return e.next=22,this.keyManager.hasRootKeyWrapper();case 22:e.sent&&a.push(f);case 24:i=!0,e.next=10;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(8),s=!0,c=e.t0;case 33:e.prev=33,e.prev=34,i||null==u.return||u.return();case 36:if(e.prev=36,!s){e.next=39;break}throw c;case 39:return e.finish(36);case 40:return e.finish(33);case 41:return e.abrupt("return",a);case 42:case"end":return e.stop()}}),e,this,[[8,29,33,41],[34,,36,40]])}))),function(e){return m.apply(this,arguments)})},{key:"getPrivileges",value:(d=Lc(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=xr.contentType(),r=new v("content_type","=",t),e.abrupt("return",this.singletonManager.findOrCreateSingleton({predicate:r,createPayload:no({object:{content_type:t,content:{}}})}));case 3:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"savePrivileges",value:(h=Lc(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getPrivileges();case 2:return t=e.sent,e.next=5,this.modelManager.setItemDirty(t);case 5:return e.abrupt("return",this.syncService.sync());case 6:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"setSessionLength",value:(y=Lc(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,a=void 0,(a=new Date).setSeconds(a.getSeconds()+n),r=a,e.next=4,this.storageService.setValue(T.PrivilegesExpirey,r);case 4:return e.next=6,this.storageService.setValue(T.PrivilegesSessionLength,t);case 6:case"end":return e.stop()}var n,a}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"clearSession",value:(p=Lc(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setSessionLength(Wc));case 1:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"getSelectedSessionLength",value:(f=Lc(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(T.PrivilegesSessionLength);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",t);case 7:return e.abrupt("return",Wc);case 8:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"getSessionExpirey",value:(l=Lc(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(T.PrivilegesExpirey);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",new Date(t));case 7:return e.abrupt("return",new Date);case 8:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"actionHasPrivilegesConfigured",value:(u=Lc(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:return e.t0=e.sent.length,e.abrupt("return",e.t0>0);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"actionRequiresPrivilege",value:(c=Lc(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSessionExpirey();case 2:if(!(e.sent>new Date)){e.next=5;break}return e.abrupt("return",!1);case 5:return e.next=7,this.netCredentialsForAction(t);case 7:return r=e.sent,e.abrupt("return",r.length>0);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"authenticateAction",value:(s=Lc(o.a.mark((function e(t,r){var n,a,i,s,c,u,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:n=e.sent,a=[],i=[],s=!0,c=!1,u=void 0,e.prev=8,l=n[Symbol.iterator]();case 10:if(s=(f=l.next()).done){e.next=19;break}return p=f.value,e.next=14,this.verifyAuthenticationParameters(p,r[p]);case 14:e.sent?a.push(p):i.push(p);case 16:s=!0,e.next=10;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(8),c=!0,u=e.t0;case 25:e.prev=25,e.prev=26,s||null==l.return||l.return();case 28:if(e.prev=28,!c){e.next=31;break}throw u;case 31:return e.finish(28);case 32:return e.finish(25);case 33:return e.abrupt("return",{success:0===i.length,successfulCredentials:a,failedCredentials:i});case 34:case"end":return e.stop()}}),e,this,[[8,21,25,33],[26,,28,32]])}))),function(e,t){return s.apply(this,arguments)})},{key:"verifyAuthenticationParameters",value:(i=Lc(o.a.mark((function e(t,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==Hc.AccountPassword){e.next=4;break}return e.abrupt("return",this.keyManager.validateAccountPassword(r));case 4:if(t!==Hc.LocalPasscode){e.next=6;break}return e.abrupt("return",this.keyManager.validatePasscode(r));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"displayInfoForCredential",value:function(e){var t={};return t[Hc.AccountPassword]={label:"Account Password",prompt:"Please enter your account password."},t[Hc.LocalPasscode]={label:"Local Passcode",prompt:"Please enter your local passcode."},t[e]}},{key:"displayInfoForAction",value:function(e){var t={};return t[Vc.ManageExtensions]={label:"Manage Extensions"},t[Vc.ManageBackups]={label:"Download/Import Backups"},t[Vc.ViewProtectedNotes]={label:"View Protected Notes"},t[Vc.ManagePrivileges]={label:"Manage Privileges"},t[Vc.ManagePasscode]={label:"Manage Passcode"},t[Vc.DeleteNote]={label:"Delete Notes"},t[e]}},{key:"getSessionLengthOptions",value:function(){return[{value:Wc,label:"Don't Remember"},{value:zc,label:"5 Minutes"},{value:qc,label:"1 Hour"},{value:Yc,label:"1 Week"}]}}])&&Fc(r.prototype,n),a&&Fc(r,a),t}(ho);function Jc(e){return(Jc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Qc(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function $c(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Qc(o,n,a,i,s,"next",e)}function s(e){Qc(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Xc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Zc(e){return(Zc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function eu(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function tu(e,t){return(tu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ru=0,nu=1,au=2,ou=3,iu=function(e){function t(e){var r,n=e.modelManager,a=e.storageService,o=e.protocolService,i=e.itemsKeyManager,s=e.deviceInterface;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!(n&&a&&o&&i&&s))throw"Invalid KeyManager construction";return(r=function(e,t){return!t||"object"!==Jc(t)&&"function"!=typeof t?eu(e):t}(this,Zc(t).call(this))).keyMode=ru,r.protocolService=o,r.modelManager=n,r.storageService=a,r.itemsKeyManager=i,r.deviceInterface=s,r.keyObservers=[],Object.defineProperty(eu(r),"rootKey",{enumerable:!1,writable:!0}),r}var r,n,a,s,u,l,f,p,y,h,v,d,m,b,g,w,k,x,S,P,O,_,j,I,E,D;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&tu(e,t)}(t,e),r=t,(n=[{key:"initialize",value:(D=$c(o.a.mark((function e(){var t,r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKeyFromStorage();case 2:return t=e.sent,e.next=5,this.getAccountKeyParams();case 5:return r=e.sent,e.next=8,this.hasRootKeyWrapper();case 8:if(n=e.sent,a=!Object(i.l)(t)||!Object(i.l)(r),!n||!a){e.next=14;break}this.keyMode=au,e.next=27;break;case 14:if(!n||a){e.next=18;break}this.keyMode=ou,e.next=27;break;case 18:if(n||!a){e.next=22;break}this.keyMode=nu,e.next=27;break;case 22:if(n||a){e.next=26;break}this.keyMode=ru,e.next=27;break;case 26:throw"Invalid key mode condition";case 27:if(this.keyMode!==nu){e.next=33;break}return e.next=30,this.getRootKeyFromKeychain();case 30:return this.rootKey=e.sent,e.next=33,this.notifyObserversOfChange();case 33:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"onStatusChange",value:function(e){var t=this;return this.keyObservers.push(e),function(){Object(i.u)(t.keyObservers,e)}}},{key:"notifyObserversOfChange",value:(E=$c(o.a.mark((function e(){var t,r,n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,r=!1,n=void 0,e.prev=3,a=this.keyObservers[Symbol.iterator]();case 5:if(t=(i=a.next()).done){e.next=12;break}return s=i.value,e.next=9,s();case 9:t=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,n=e.t0;case 18:e.prev=18,e.prev=19,t||null==a.return||a.return();case 21:if(e.prev=21,!r){e.next=24;break}throw n;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(){return E.apply(this,arguments)})},{key:"getRootKeyFromKeychain",value:(I=$c(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getKeychainValue();case 2:if(t=e.sent,!Object(i.l)(t)){e.next=5;break}return e.abrupt("return",null);case 5:return e.next=7,re.Create({content:t});case 7:return r=e.sent,e.abrupt("return",r);case 9:case"end":return e.stop()}}),e,this)}))),function(){return I.apply(this,arguments)})},{key:"saveRootKeyToKeychain",value:(j=$c(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(i.l)(this.rootKey)){e.next=2;break}throw"Attempting to non-existent root key to the keychain.";case 2:if(this.keyMode===nu){e.next=4;break}throw"Should not be persisting wrapped key to keychain.";case 4:return t=this.rootKey.getPersistableValue(),e.next=7,this.deviceInterface.setKeychainValue(t);case 7:case"end":return e.stop()}}),e,this)}))),function(){return j.apply(this,arguments)})},{key:"hasRootKeyWrapper",value:(_=$c(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return t=e.sent,e.abrupt("return",!Object(i.l)(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return _.apply(this,arguments)})},{key:"hasPasscode",value:function(){return this.keyMode===ou||this.keyMode===au}},{key:"rootKeyNeedsUnwrapping",value:(O=$c(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.hasRootKeyWrapper();case 2:if(e.t0=e.sent,!e.t0){e.next=5;break}e.t0=Object(i.l)(this.rootKey);case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}}),e,this)}))),function(){return O.apply(this,arguments)})},{key:"getRootKeyWrapperKeyParams",value:(P=$c(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(T.RootKeyWrapperKeyParams,Os.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",null);case 5:return e.abrupt("return",this.protocolService.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return P.apply(this,arguments)})},{key:"getWrappedRootKeyFromStorage",value:(S=$c(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(T.WrappedRootKey,Os.Nonwrapped));case 1:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"getRootKeyParams",value:(x=$c(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==ou){e.next=4;break}return e.abrupt("return",this.getRootKeyWrapperKeyParams());case 4:if(this.keyMode!==nu&&this.keyMode!==au){e.next=8;break}return e.abrupt("return",this.getAccountKeyParams());case 8:throw"Unhandled key mode for getRootKeyParams ".concat(this.keyMode);case 9:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"getAccountKeyParams",value:(k=$c(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(T.RootKeyParams,Os.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",null);case 5:return e.abrupt("return",this.protocolService.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"validateWrappingKey",value:(w=$c(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKeyFromStorage();case 2:if(r=e.sent,this.keyMode!==ou){e.next=7;break}return e.abrupt("return",this.storageService.canDecryptWithKey(t));case 7:if(this.keyMode!==nu&&this.keyMode!==au){e.next=15;break}return n=no({object:r}),e.next=11,this.protocolService.payloadByDecryptingPayload({payload:n,key:t});case 11:return a=e.sent,e.abrupt("return",!a.errorDecrypting);case 15:throw"Unhandled case in validateWrappingKey";case 16:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"computeWrappingKey",value:(g=$c(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.passcode,e.next=3,this.getRootKeyWrapperKeyParams();case 3:return n=e.sent,e.next=6,this.protocolService.computeRootKey({password:r,keyParams:n});case 6:return a=e.sent,e.abrupt("return",a);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"unwrapRootKey",value:(b=$c(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.wrappingKey,this.keyMode!==ou){e.next=4;break}return this.rootKey=r,e.abrupt("return");case 4:if(this.keyMode===au){e.next=6;break}throw"Invalid key mode condition for unwrapping.";case 6:return e.next=8,this.getWrappedRootKeyFromStorage();case 8:return n=e.sent,a=no({object:n}),e.next=12,this.protocolService.payloadByDecryptingPayload({payload:a,key:r});case 12:if(!(i=e.sent).errorDecrypting){e.next=17;break}throw"Unable to decrypt root key with provided wrapping key.";case 17:return e.next=19,re.Create({uuid:i.uuid,content:i.content});case 19:return this.rootKey=e.sent,e.next=22,this.notifyObserversOfChange();case 22:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"setNewRootKeyWrapper",value:(m=$c(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.wrappingKey,n=t.keyParams,this.keyMode!==ru){e.next=5;break}this.keyMode=ou,e.next=10;break;case 5:if(this.keyMode!==nu){e.next=9;break}this.keyMode=au,e.next=10;break;case 9:throw"Attempting to set wrapper on already wrapped key.";case 10:return e.next=12,this.deviceInterface.clearKeychainValue();case 12:if(this.keyMode!==ou&&this.keyMode!==au){e.next=27;break}if(this.keyMode!==ou){e.next=19;break}return this.rootKey=r,e.next=17,this.itemsKeyManager.reencryptItemsKeys();case 17:e.next=21;break;case 19:return e.next=21,this.wrapAndPersistRootKey({wrappingKey:r});case 21:return e.next=23,this.storageService.setValue(T.RootKeyWrapperKeyParams,n.getPortableValue(),Os.Nonwrapped);case 23:return e.next=25,this.notifyObserversOfChange();case 25:e.next=28;break;case 27:throw"Invalid keyMode on setNewRootKeyWrapper";case 28:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"wrapAndPersistRootKey",value:(d=$c(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.wrappingKey,n=no({object:this.rootKey,override:{content:this.rootKey.getPersistableValue()}}),e.next=4,this.protocolService.payloadByEncryptingPayload({payload:n,key:r,intent:G.LocalStorageEncrypted});case 4:return a=e.sent,e.next=7,this.storageService.setValue(T.WrappedRootKey,a,Os.Nonwrapped);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"removeRootKeyWrapper",value:(v=$c(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode===ou||this.keyMode===au){e.next=2;break}throw"Attempting to remove root key wrapper on unwrapped key.";case 2:return this.keyMode===ou?(this.keyMode=ru,this.rootKey=null):this.keyMode===au&&(this.keyMode=nu),e.next=5,this.storageService.removeValue(T.WrappedRootKey,Os.Nonwrapped);case 5:return e.next=7,this.storageService.removeValue(T.RootKeyWrapperKeyParams,Os.Nonwrapped);case 7:if(this.keyMode!==nu){e.next=10;break}return e.next=10,this.saveRootKeyToKeychain();case 10:return e.next=12,this.notifyObserversOfChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"setNewRootKey",value:(h=$c(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.key,n=t.keyParams,r.isRootKey){e.next=3;break}throw"Root key must be a ".concat(c.RootKey," object.");case 3:if(n){e.next=5;break}throw"keyParams must be supplied if setting root key.";case 5:if(this.keyMode!==ou){e.next=9;break}this.keyMode=au,e.next=17;break;case 9:if(this.keyMode!==ru){e.next=13;break}this.keyMode=nu,e.next=17;break;case 13:if(this.keyMode!==nu&&this.keyMode!==au){e.next=16;break}e.next=17;break;case 16:throw"Unhandled key mode for setNewRootKey ".concat(this.keyMode);case 17:if(a=this.rootKey,this.rootKey=r,a!==r){e.next=21;break}throw"Attempting to set root key as same current value.";case 21:return e.next=23,this.storageService.setValue(T.RootKeyParams,n.getPortableValue(),Os.Nonwrapped);case 23:if(this.keyMode!==nu){e.next=28;break}return e.next=26,this.saveRootKeyToKeychain();case 26:e.next=31;break;case 28:if(this.keyMode!==au){e.next=31;break}return e.next=31,this.wrapAndPersistRootKey({wrappingKey:a});case 31:return e.next=33,this.notifyObserversOfChange(c.RootKey);case 33:return e.next=35,this.itemsKeyManager.reencryptItemsKeys();case 35:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"getRootKey",value:(y=$c(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rootKey);case 1:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"clearLocalKeyState",value:(p=$c(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.clearKeychainValue();case 2:return e.next=4,this.storageService.removeValue(T.WrappedRootKey,Os.Nonwrapped);case 4:return e.next=6,this.storageService.removeValue(T.RootKeyWrapperKeyParams,Os.Nonwrapped);case 6:return e.next=8,this.storageService.removeValue(T.RootKeyParams,Os.Nonwrapped);case 8:return this.keyMode=ru,this.rootKey=null,e.next=12,this.notifyObserversOfChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"validateAccountPassword",value:(f=$c(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyParams();case 2:return r=e.sent,e.next=5,this.protocolService.computeRootKey({password:t,keyParams:r});case 5:return n=e.sent,a=n.compare(this.rootKey),e.abrupt("return",a?n:null);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"validatePasscode",value:(l=$c(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return r=e.sent,e.next=5,this.protocolService.computeRootKey({password:t,keyParams:r});case 5:return n=e.sent,e.abrupt("return",this.validateWrappingKey(n));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"contentTypeUsesRootKeyEncryption",value:function(e){return e===c.ItemsKey||e===c.EncryptedStorage}},{key:"keyToUseForEncryptionOfPayload",value:(u=$c(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.payload,n=t.intent,!Object(i.l)(n)){e.next=3;break}throw"Intent must be supplied when looking up key for encryption of item.";case 3:if(!this.contentTypeUsesRootKeyEncryption(r.content_type)){e.next=16;break}return e.next=6,this.getRootKey();case 6:if(a=e.sent){e.next=13;break}if(!X(n)){e.next=12;break}throw"Root key encryption is required but no root key is available.";case 12:return e.abrupt("return",null);case 13:return e.abrupt("return",a);case 16:return e.abrupt("return",this.itemsKeyManager.getDefaultItemsKey());case 17:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"keyToUseForDecryptionOfPayload",value:(s=$c(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.payload,!this.contentTypeUsesRootKeyEncryption(r.content_type)){e.next=3;break}return e.abrupt("return",this.getRootKey());case 3:if(!r.items_key_id){e.next=6;break}return n=this.itemsKeyManager.itemsKeyForPayload(r),e.abrupt("return",n);case 6:if((a=r.version)!==this.protocolService.getLatestVersion()){e.next=9;break}throw"No associated key found for item encrypted with latest protocol version.";case 9:return e.abrupt("return",this.itemsKeyManager.defaultItemsKeyForItemVersion(a));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})}])&&Xc(r.prototype,n),a&&Xc(r,a),t}(ho);function su(e){return(su="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function cu(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function uu(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){cu(o,n,a,i,s,"next",e)}function s(e){cu(o,n,a,i,s,"throw",e)}i(void 0)}))}}function lu(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function fu(e,t){return!t||"object"!==su(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function pu(e){return(pu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function yu(e,t){return(yu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var hu=q.V003,vu=function(e){function t(e){var r,n=e.syncService,a=e.modelManager,i=e.protocolService;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=fu(this,pu(t).call(this))).syncService=n,r.modelManager=a,r.protocolService=i,r.keyObservers=[],r.registerSyncObserver(),r.modelManager.addMappingObserver([c.ItemsKey],uu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.notifyObserversOfChange();case 2:case"end":return e.stop()}}),e)})))),r}var r,n,a,s,u,l,f,p,y;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&yu(e,t)}(t,e),r=t,(n=[{key:"setKeyManager",value:function(e){this.keyManager=e}},{key:"addItemsKeyChangeObserver",value:function(e){var t=this;return this.keyObservers.push(e),function(){Object(i.u)(t.keyObservers,e)}}},{key:"notifyObserversOfChange",value:(y=uu(o.a.mark((function e(){var t,r,n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,r=!1,n=void 0,e.prev=3,a=this.keyObservers[Symbol.iterator]();case 5:if(t=(i=a.next()).done){e.next=12;break}return s=i.value,e.next=9,s();case 9:t=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,n=e.t0;case 18:e.prev=18,e.prev=19,t||null==a.return||a.return();case 21:if(e.prev=21,!r){e.next=24;break}throw n;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(){return y.apply(this,arguments)})},{key:"registerSyncObserver",value:function(){var e=this;this.syncService.addEventObserver(function(){var t=uu(o.a.mark((function t(r){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r!==d.FullSyncCompleted){t.next=3;break}return t.next=3,e.handleFullSyncCompletion();case 3:if(r!==d.DownloadFirstSyncCompleted){t.next=6;break}return t.next=6,e.handleDownloadFirstSyncCompletion();case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"handleDownloadFirstSyncCompletion",value:(p=uu(o.a.mark((function e(){var t,r,n,a,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.allItemsKeys,r=t.filter((function(e){return e.neverSynced})),n=t.find((function(e){return!e.neverSynced&&e.isDefault})),Object(i.l)(n)){e.next=9;break}return e.next=7,this.modelManager.setItemsToBeDeleted(r);case 7:e.next=20;break;case 9:return e.next=11,this.keyManager.getRootKey();case 11:if(!(a=e.sent)){e.next=20;break}if(!((s=r.filter((function(e){return e.version!==a.version}))).length>0)){e.next=17;break}return e.next=17,this.modelManager.setItemsToBeDeleted(s);case 17:if(0!==t.length){e.next=20;break}return e.next=20,this.createNewDefaultItemsKey();case 20:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"handleFullSyncCompletion",value:(f=uu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.getDefaultItemsKey()){e.next=6;break}return e.next=4,this.createNewDefaultItemsKey();case 4:if(this.keyManager.keyMode!==ou){e.next=6;break}return e.abrupt("return",this.syncService.repersistAllItems());case 6:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"itemsKeyForPayload",value:function(e){return this.allItemsKeys.find((function(t){return t.uuid===e.items_key_id}))}},{key:"getDefaultItemsKey",value:function(){return 1===this.allItemsKeys.length?this.allItemsKeys[0]:this.allItemsKeys.find((function(e){return e.isDefault}))}},{key:"reencryptItemsKeys",value:(l=uu(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((t=this.allItemsKeys).length>0)){e.next=4;break}return e.next=4,this.modelManager.setItemsDirty(t);case 4:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"defaultItemsKeyForItemVersion",value:(u=uu(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.allItemsKeys.find((function(e){return e.version===t})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"createNewDefaultItemsKey",value:(s=uu(o.a.mark((function e(){var t,r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.keyManager.getRootKey();case 2:if(t=e.sent,!(Y(r=t?t.version:this.protocolService.getLatestVersion(),hu)<=0)){e.next=10;break}return n=ct.FromRaw({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:r}),e.next=8,n.initUUID();case 8:e.next=13;break;case 10:return e.next=12,this.protocolService.operatorForVersion(r).createItemsKey();case 12:n=e.sent;case 13:if(!(a=this.getDefaultItemsKey())){e.next=18;break}return a.content.isDefault=!1,e.next=18,this.modelManager.setItemDirty(a);case 18:return n.content.isDefault=!0,i=n.payloadRepresentation({override:{dirty:!0}}),e.next=22,this.modelManager.mapPayloadToLocalItem({payload:i});case 22:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"allItemsKeys",get:function(){return this.modelManager.itemsKeys}}])&&lu(r.prototype,n),a&&lu(r,a),t}(ho);function du(e,t){return e.sort((function(e,r){var n=new Date(r.updated_at)-new Date(e.updated_at),a=0,o=0;return t&&(a=t.indexOf(e.content_type),o=t.indexOf(r.content_type),-1===a&&(a=t.length),-1===o&&(o=t.length)),a===o?n:a<o?-1:1}))}function mu(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var bu=function(){function e(t){var r=t.interval,n=t.receiver;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.interval=r,this.receiver=n}var t,r,n;return t=e,(r=[{key:"setSyncInProgress",value:function(e){this.inProgress=!0}},{key:"setUploadStatus",value:function(e){var t=e.completed,r=e.total;this.completedUpload=t,this.totalUpload=r}},{key:"setDownloadStatus",value:function(e){var t=e.downloaded;this.downloaded=t}},{key:"setDatabaseLoadStatus",value:function(e){var t=e.current,r=e.total,n=e.done;this.databaseLoadCurrent=t,this.databaseLoadTotal=r,this.databaseLoadDone=n}},{key:"setDidBegin",value:function(){this.syncing=!0,this.syncStart=new Date}},{key:"setDidEnd",value:function(){this.syncing=!1,this.syncEnd=new Date}},{key:"startTimingMonitor",value:function(){var e=this;this.timingMonitor&&this.this.stopTimingMonitor(),this.timingMonitor=this.interval((function(){e.secondsSinceSyncStart>5&&(e.receiver(d.SyncTakingTooLong),e.stopTimingMonitor())}),500)}},{key:"stopTimingMonitor",value:function(){this.interval.hasOwnProperty("cancel")?this.interval.cancel(this.timingMonitor):clearInterval(this.timingMonitor),this.timingMonitor=null}},{key:"hasError",value:function(){return this.error}},{key:"setError",value:function(e){this.error=e}},{key:"clearError",value:function(){this.error=null}},{key:"reset",value:function(){this.downloaded=0,this.completedUpload=0,this.totalUpload=0,this.inProgress=!1,this.syncing=!1,this.error=null}},{key:"syncInProgress",get:function(){return!0===this.syncing}},{key:"secondsSinceSyncStart",get:function(){return(new Date-this.syncStart)/1e3}}])&&mu(t.prototype,r),n&&mu(t,n),e}();function gu(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function wu(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var ku=function(){function e(t){var r=t.receiver,n=t.maxDiscordance;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.discordance=0,this.receiver=r,this.maxDiscordance=n,this.reset()}var t,r,n,a,i;return t=e,(r=[{key:"setLastPresaveSyncDate",value:function(e){this._lastPreSyncSave=e}},{key:"setLastSyncDate",value:function(e){this._lastSyncDate=e}},{key:"isOutOfSync",value:function(){return this.outOfSync}},{key:"reset",value:function(){this._lastSyncDate=null,this._lastPreSyncSave=null,this.discordance=0,this.outOfSync=!1}},{key:"getLastClientIntegrityHash",value:function(){return this.lastClientHash}},{key:"clearIntegrityHashes",value:function(){this.lastClientHash=null,this.lastServerHash=null}},{key:"setIntegrityHashes",value:(a=o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.clientHash,n=t.serverHash,this.lastClientHash=r,this.lastServerHash=n,n&&0!==n.length&&r&&r!==n?(this.discordance++,this.discordance>=this.maxDiscordance&&!this.outOfSync&&(this.outOfSync=!0,this.receiver(d.EnterOutOfSync))):(this.outOfSync&&(this.outOfSync=!1,this.receiver(d.ExitOutOfSync)),this.discordance=0);case 5:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){gu(o,r,n,i,s,"next",e)}function s(e){gu(o,r,n,i,s,"throw",e)}i(void 0)}))},function(e){return i.apply(this,arguments)})},{key:"lastPreSyncSaveDate",get:function(){return this._lastPreSyncSave}},{key:"lastSyncDate",get:function(){return this._lastSyncDate}},{key:"needsSync",get:function(){return this.discordance>0&&this.discordance<this.maxDiscordance}}])&&wu(t.prototype,r),n&&wu(t,n),e}();function xu(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Su(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Pu=function(){function e(t){var r=t.apiService,n=t.protocolService,a=t.contentType,o=t.customEvent,i=t.limit;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.apiService=r,this.protocolService=n,this.contentType=a,this.customEvent=o,this.limit=i,this.progressObj={retrievedPayloads:[]}}var t,r,n,a,i;return t=e,(r=[{key:"run",value:(a=o.a.mark((function e(){var t,r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.apiService.sync({lastSyncToken:this.progressObj.lastSyncToken,paginationToken:this.progressObj.paginationToken,limit:this.limit||500,contentType:this.contentType,customEvent:this.customEvent});case 2:return t=e.sent,r=t.retrieved_items.map((function(e){return oo({object:e,source:rn.RemoteRetrieved})})),e.next=6,this.protocolService.payloadsByDecryptingPayloads({payloads:r});case 6:if(n=e.sent,this.progressObj.retrievedPayloads=this.progressObj.retrievedPayloads.concat(n),this.progressObj.lastSyncToken=t.sync_token,this.progressObj.paginationToken=t.cursor_token,!t.cursor_token){e.next=14;break}return e.abrupt("return",this.run());case 14:return e.abrupt("return",this.progressObj.retrievedPayloads);case 15:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){xu(o,r,n,i,s,"next",e)}function s(e){xu(o,r,n,i,s,"throw",e)}i(void 0)}))},function(){return i.apply(this,arguments)})}])&&Su(t.prototype,r),n&&Su(t,n),e}();function Ou(e){return e===rn.RemoteRetrieved?Ya:e===rn.RemoteSaved?ro:e===rn.ConflictData||e===rn.ConflictUuid?Na:void 0}function _u(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ju(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){_u(o,n,a,i,s,"next",e)}function s(e){_u(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Iu(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Eu=function(){function e(t){var r=t.response,n=t.decryptedResponsePayloads,a=t.baseCollection,o=t.payloadsSavedOrSaving;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.response=r,this.baseCollection=a,this.relatedCollectionSet=new y({collections:[new f({payloads:n,source:rn.DecryptedTransient}),new f({payloads:o,source:rn.SavedOrSaving})]})}var t,r,n,a,i;return t=e,(r=[{key:"collectionsByProcessingResponse",value:(i=ju(o.a.mark((function e(){var t,r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,this.collectionByProcessingRawItems({rawItems:this.response.rawRetrievedItems,source:rn.RemoteRetrieved});case 3:return r=e.sent,t.push(r),e.next=7,this.collectionByProcessingRawItems({rawItems:this.response.rawSavedItems,source:rn.RemoteSaved});case 7:return n=e.sent,t.push(n),e.next=11,this.collectionByProcessingRawItems({rawItems:this.response.rawUuidConflictItems,source:rn.ConflictUuid});case 11:return a=e.sent,t.push(a),e.next=15,this.collectionByProcessingRawItems({rawItems:this.response.rawDataConflictItems,source:rn.ConflictData});case 15:return i=e.sent,t.push(i),e.abrupt("return",t);case 18:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"collectionByProcessingRawItems",value:(a=ju(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,p=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.rawItems,n=t.source,a=r.map((function(e){return oo({object:e,source:n})})),i=new f({payloads:a,source:n}),s=Ou(n),c=new s({baseCollection:this.baseCollection,applyCollection:i,relatedCollectionSet:this.relatedCollectionSet}),e.next=7,c.resultingCollection();case 7:return u=e.sent,l=u.allPayloads.map((function(e){return so({payload:e,override:{dirty:p.finalDirtyStateForPayload(e)}})})),e.abrupt("return",new f({payloads:l,source:n}));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"finalDirtyStateForPayload",value:function(e){var t=this.baseCollection.findPayload(e.uuid);return t?t.dirtiedDate>t.lastSyncBegan:e.dirty}}])&&Iu(t.prototype,r),n&&Iu(t,n),e}();function Du(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Cu=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.rawResponse=t,Object(i.d)(this)}var t,r,n;return t=e,(r=[{key:"error",get:function(){return this.rawResponse.error}},{key:"lastSyncToken",get:function(){return this.rawResponse[Mo]}},{key:"paginationToken",get:function(){return this.rawResponse[Ko]}},{key:"integrityHash",get:function(){return this.rawResponse[Fo]}},{key:"checkIntegrity",get:function(){return this.integrityHash&&!this.paginationToken}},{key:"numberOfItemsInvolved",get:function(){return this.rawSavedItems.concat(this.rawRetrievedItems).concat(this.rawItemsFromConflicts).length}},{key:"allProcessedPayloads",get:function(){return this.retrievedPayloads.concat(this.savedPayloads).concat(this.conflictPayloads)}},{key:"savedPayloads",get:function(){return this.rawSavedItems.map((function(e){return oo({object:e,source:rn.RemoteSaved})}))}},{key:"retrievedPayloads",get:function(){return this.rawRetrievedItems.map((function(e){return oo({object:e,source:rn.RemoteRetrieved})}))}},{key:"conflictPayloads",get:function(){return this.rawItemsFromConflicts.map((function(e){return oo({object:e,source:rn.RemoteRetrieved})}))}},{key:"rawSavedItems",get:function(){return this.rawResponse.saved_items||[]}},{key:"rawRetrievedItems",get:function(){return this.rawResponse.retrieved_items||[]}},{key:"rawUuidConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return"uuid_conflict"===e.type})).map((function(e){return e.unsaved_item||e.item}))}},{key:"rawDataConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return"sync_conflict"===e.type})).map((function(e){return e.server_item||e.item}))}},{key:"rawItemsFromConflicts",get:function(){var e=this.rawResponse.conflicts||[],t=this.rawResponse.unsaved||[],r=e.map((function(e){return e.unsaved_item||e.server_item})),n=t.map((function(e){return e.item}));return r.concat(n)}},{key:"rawConflictObjects",get:function(){var e=this.rawResponse.conflicts||[],t=this.rawResponse.unsaved||[];return e.concat(t)}},{key:"hasError",get:function(){return!Object(i.l)(this.rawResponse.error)}}])&&Du(t.prototype,r),n&&Du(t,n),e}();function Ru(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Au(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Tu=function(){function e(t){var r=t.payloads,n=t.receiver,a=t.lastSyncToken,o=t.paginationToken,i=t.checkIntegrity,s=t.apiService;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.payloads=r,this.pendingPayloads=r,this.lastSyncToken=a,this.paginationToken=o,this.checkIntegrity=i,this.apiService=s,this.receiver=n,this.responses=[]}var t,r,n,a,s;return t=e,(r=[{key:"popPayloads",value:function(e){var t=this.pendingPayloads.slice(0,e);return Object(i.x)(this.pendingPayloads,t),t}},{key:"run",value:(a=o.a.mark((function e(){var t,r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.popPayloads(this.upLimit),e.next=3,this.apiService.sync({payloads:t,lastSyncToken:this.lastSyncToken,paginationToken:this.paginationToken,limit:this.downLimit,checkIntegrity:this.checkIntegrity});case 3:return r=e.sent,n=new Cu(r),this.responses.push(n),this.lastSyncToken=n.lastSyncToken,this.paginationToken=n.paginationToken,e.next=10,this.receiver(n,1);case 10:if(this.done){e.next=12;break}return e.abrupt("return",this.run());case 12:case"end":return e.stop()}}),e,this)})),s=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){Ru(o,r,n,i,s,"next",e)}function s(e){Ru(o,r,n,i,s,"throw",e)}i(void 0)}))},function(){return s.apply(this,arguments)})},{key:"payloadsSavedOrSaving",get:function(){return Object(i.b)(this.payloads,this.pendingPayloads)}},{key:"done",get:function(){return 0===this.pendingPayloads.length&&!this.paginationToken}},{key:"upLimit",get:function(){return 150}},{key:"downLimit",get:function(){return 150}},{key:"numberOfItemsInvolved",get:function(){var e=0,t=!0,r=!1,n=void 0;try{for(var a,o=this.responses[Symbol.iterator]();!(t=(a=o.next()).done);t=!0)e+=a.value.numberOfItemsInvolved}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}return e}}])&&Au(t.prototype,r),n&&Au(t,n),e}();function Mu(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ku(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Lu(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Fu=function(){function e(t){var r=t.payloads,n=t.receiver;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.payloads=r,this.receiver=n}var t,r,n,a,i;return t=e,(r=[{key:"run",value:(a=o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.payloads.map((function(e){var t;return oo({object:e,source:rn.LocalSaved,override:(t={},Mu(t,fe.Dirty,!1),Mu(t,fe.LastSyncEnd,new Date),t)})})),r={payloads:t},e.next=4,this.receiver(r,1);case 4:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){Ku(o,r,n,i,s,"next",e)}function s(e){Ku(o,r,n,i,s,"throw",e)}i(void 0)}))},function(){return i.apply(this,arguments)})}])&&Lu(t.prototype,r),n&&Lu(t,n),e}();function Nu(e){return(Nu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Uu(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Bu(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Vu(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Hu(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Vu(o,n,a,i,s,"next",e)}function s(e){Vu(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Wu(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function zu(e,t){return!t||"object"!==Nu(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function qu(e,t,r){return(qu="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Yu(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function Yu(e){return(Yu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Gu(e,t){return(Gu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ju=1,Qu=2,$u={Default:1,DownloadFirst:2},Xu={External:1,SpawnQueue:2,ResolveQueue:3,MoreDirtyItems:4,AfterDownloadFirst:5,IntegrityCheck:6,ResolveOutOfSync:7},Zu=function(e){function t(e){var r,n=e.sessionManager,a=e.protocolService,o=e.storageService,i=e.modelManager,s=e.apiService,u=e.interval;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=zu(this,Yu(t).call(this))).sessionManager=n,r.protocolService=a,r.modelManager=i,r.storageService=o,r.apiService=s,r.interval=u,r.statusObservers=[],r.resolveQueue=[],r.spawnQueue=[],r.majorChangeThreshold=15,r.maxDiscordance=5,r.initializeStatus(),r.initializeState(),r.localLoadPriorty=[c.ItemsKey,c.UserPrefs,c.Privileges,c.Component,c.Theme],r.nonEncryptedTypes=[c.Mfa,c.ServerExtension],r}var r,n,a,s,u,l,p,y,h,v,m,b,g,w,k,x,S,P,O,_,j,I,E,D,C,R,A,M;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Gu(e,t)}(t,e),r=t,(n=[{key:"initializeStatus",value:function(){var e=this;this.opStatus=new bu({interval:this.interval,receiver:function(t){e.notifyEvent(t)}})}},{key:"initializeState",value:function(){var e=this;this.state=new ku({maxDiscordance:this.maxDiscordance,receiver:function(t){t===d.EnterOutOfSync?e.notifyEvent(d.EnterOutOfSync):t===d.ExitOutOfSync&&e.notifyEvent(d.ExitOutOfSync)}})}},{key:"lockSyncing",value:function(){this.locked=!0}},{key:"unlockSyncing",value:function(){this.locked=!1}},{key:"isOutOfSync",value:function(){return this.state.isOutOfSync()}},{key:"getLastSyncDate",value:function(){return this.state.lastSyncDate}},{key:"resetSyncState",value:function(){this.state.reset()}},{key:"getDatabasePayloads",value:(M=Hu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getAllRawPayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return M.apply(this,arguments)})},{key:"isDatabaseLoaded",value:function(){return this.databaseLoaded}},{key:"loadDatabasePayloads",value:(A=Hu(o.a.mark((function e(t){var r,n,a,s,u,l,f,p,y,h,v;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.databaseLoaded){e.next=2;break}throw"Attempting to initialize already initialized local database.";case 2:return r=t.map((function(e){return no({object:e})})),n=du(r,this.localLoadPriorty),a=n.filter((function(e){return e.content_type===c.ItemsKey})),Object(i.x)(n,a),e.next=8,this.protocolService.payloadsByDecryptingPayloads({payloads:a});case 8:return s=e.sent,e.next=11,this.modelManager.mapPayloadsToLocalItems({payloads:s,source:rn.LocalRetrieved});case 11:u=n.length,l=100,f=Math.ceil(u/l),p=0;case 15:if(!(p<f)){e.next=28;break}return y=p*l,h=n.slice(y,y+l),e.next=20,this.protocolService.payloadsByDecryptingPayloads({payloads:h});case 20:return v=e.sent,e.next=23,this.modelManager.mapPayloadsToLocalItems({payloads:v,source:rn.LocalRetrieved});case 23:this.notifyEvent(d.LocalDataIncrementalLoad),this.opStatus.setDatabaseLoadStatus({current:y,total:u});case 25:p++,e.next=15;break;case 28:this.opStatus.setDatabaseLoadStatus({done:!0}),this.databaseLoaded=!0;case 30:case"end":return e.stop()}}),e,this)}))),function(e){return A.apply(this,arguments)})},{key:"setLastSyncToken",value:(R=Hu(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=t,e.abrupt("return",this.storageService.setValue(T.LastSyncToken,t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return R.apply(this,arguments)})},{key:"setPaginationToken",value:(C=Hu(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken=t,!t){e.next=5;break}return e.abrupt("return",this.storageService.setValue(T.PaginationToken,t));case 5:return e.abrupt("return",this.storageService.removeValue(T.PaginationToken));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"getLastSyncToken",value:(D=Hu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.syncToken){e.next=4;break}return e.next=3,this.storageService.getValue(T.LastSyncToken);case 3:this.syncToken=e.sent;case 4:return e.abrupt("return",this.syncToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"getPaginationToken",value:(E=Hu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken){e.next=4;break}return e.next=3,this.storageService.getValue(T.PaginationToken);case 3:this.cursorToken=e.sent;case 4:return e.abrupt("return",this.cursorToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return E.apply(this,arguments)})},{key:"clearSyncPositionTokens",value:(I=Hu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=null,this.cursorToken=null,e.next=4,this.storageService.removeValue(T.LastSyncToken);case 4:return e.next=6,this.storageService.removeValue(T.PaginationToken);case 6:case"end":return e.stop()}}),e,this)}))),function(){return I.apply(this,arguments)})},{key:"itemsNeedingSync",value:(j=Hu(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.modelManager.getDirtyItems(),e.abrupt("return",t);case 2:case"end":return e.stop()}}),e,this)}))),function(){return j.apply(this,arguments)})},{key:"alternateUuidForItem",value:(_=Hu(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.isItem){e.next=2;break}throw"Attempting to alternate uuid of non-item object";case 2:return r=no({object:t}),e.next=5,Xr({payload:r,baseCollection:this.modelManager.getMasterCollection()});case 5:return n=e.sent,e.next=8,this.modelManager.mapPayloadsToLocalItems({payloads:n,source:rn.LocalSaved});case 8:return a=e.sent,e.next=11,this.persistPayloads({decryptedPayloads:n});case 11:return e.abrupt("return",a[0]);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"markAllItemsAsNeedingSync",value:(O=Hu(o.a.mark((function e(){var t,r,n,a,i,s,c,u,l,f,p,y=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=y.length>0&&void 0!==y[0]?y[0]:{},r=t.alternateUuids,this.log("Marking all items as needing sync"),!r){e.next=30;break}n=this.modelManager.allNondummyItems.filter((function(e){return!e.errorDecrypting})).slice(),a=!0,i=!1,s=void 0,e.prev=7,c=n[Symbol.iterator]();case 9:if(a=(u=c.next()).done){e.next=16;break}return l=u.value,e.next=13,this.alternateUuidForItem(l);case 13:a=!0,e.next=9;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(7),i=!0,s=e.t0;case 22:e.prev=22,e.prev=23,a||null==c.return||c.return();case 25:if(e.prev=25,!i){e.next=28;break}throw s;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return f=this.modelManager.allNondummyItems,p=f.map((function(e){return no({object:e,override:{dirty:!0}})})),e.next=34,this.modelManager.mapPayloadsToLocalItems({payloads:p});case 34:return e.next=36,this.persistPayloads({decryptedPayloads:p});case 36:case"end":return e.stop()}}),e,this,[[7,18,22,30],[23,,25,29]])}))),function(){return O.apply(this,arguments)})},{key:"repersistAllItems",value:(P=Hu(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.modelManager.allItems,r=t.map((function(e){return no({object:e})})),e.abrupt("return",this.persistPayloads({decryptedPayloads:r}));case 3:case"end":return e.stop()}}),e,this)}))),function(){return P.apply(this,arguments)})},{key:"popPayloadsNeedingPreSyncSave",value:(S=Hu(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.state.lastPreSyncSaveDate){e.next=3;break}return e.abrupt("return",t);case 3:return n=t.filter((function(e){return!e.dirtiedDate||e.dirtiedDate>r})),this.state.setLastPresaveSyncDate(new Date),e.abrupt("return",n);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"timingStrategyResolveOnNext",value:function(){var e=this;return new Promise((function(t,r){e.resolveQueue.push({resolve:t,reject:r})}))}},{key:"timingStrategyForceSpawnNew",value:function(e){var t=this;return new Promise((function(r,n){t.spawnQueue.push({resolve:r,reject:n,options:e})}))}},{key:"popSpawnQueue",value:function(){if(0===this.spawnQueue.length)return null;var e=this.spawnQueue[0];return Object(i.v)(this.spawnQueue,0),this.log("Syncing again from spawn queue"),this.sync(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Uu(Object(r),!0).forEach((function(t){Bu(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Uu(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({timingStrategy:Qu,source:Xu.SpawnQueue},e.options)).then((function(){e.resolve()})).catch((function(){e.reject()}))}},{key:"payloadsByPreparingForServer",value:function(e){var t=this;return this.protocolService.payloadsByEncryptingPayloads({payloads:e,intent:function(e){return t.nonEncryptedTypes.includes(e.content_type)?G.SyncDecrypted:G.Sync}})}},{key:"sync",value:(x=Hu(o.a.mark((function e(){var t,r,n,a,s,c,u,l,f,p,y,h,v,m,b,g,w,k,x,S,P,O,_,j,I,E,D,C=this,R=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=R.length>0&&void 0!==R[0]?R[0]:{},r=t.timingStrategy,n=t.mode,a=t.checkIntegrity,s=t.source,!this.locked){e.next=4;break}return this.log("Sync Locked"),e.abrupt("return");case 4:return c=function(){return C.syncLock},u=function(){C.syncLock=!0},l=function(){C.syncLock=!1},f=this.opStatus.syncInProgress,p=this.databaseLoaded,(y=!c())&&p&&!f&&u(),s||(s=Xu.External),e.next=14,this.itemsNeedingSync();case 14:return h=e.sent,v=h.filter((function(e){return e.neverSynced&&e.deleted})),Object(i.x)(h,v),m=h.map((function(e){return e.payloadRepresentation()})),e.next=20,this.popPayloadsNeedingPreSyncSave(m);case 20:return b=e.sent,e.next=23,this.persistPayloads({decryptedPayloads:b});case 23:if(g=this.resolveQueue.slice(),w=Object(i.l)(r)?Ju:r,!f&&p&&y){e.next=36;break}if(this.log(y?f?"Attempting to sync while existing sync in progress.":"Attempting to sync before local database has loaded.":"Another function call has begun preparing for sync."),w!==Ju){e.next=31;break}return e.abrupt("return",this.timingStrategyResolveOnNext());case 31:if(w!==Qu){e.next=35;break}return e.abrupt("return",this.timingStrategyForceSpawnNew({mode:n,checkIntegrity:a,source:s}));case 35:throw"Unhandled timing strategy ".concat(w);case 36:return this.opStatus.setDidBegin(),k=new Date,e.next=40,this.modelManager.setItemsProperties({items:h,properties:Bu({},fe.LastSyncBegan,k)});case 40:return x=Object(i.l)(n)?$u.Default:n,e.next=43,this.sessionManager.online();case 43:if(S=e.sent,x!==$u.Default){e.next=56;break}if(this.completedInitialSync){e.next=47;break}throw"Attempting to default mode sync without having completed initial.";case 47:if(!S){e.next=53;break}return e.next=50,this.payloadsByPreparingForServer(m);case 50:P=e.sent,e.next=54;break;case 53:P=m;case 54:e.next=57;break;case 56:x===$u.DownloadFirst&&(P=[]);case 57:if(!S){e.next=63;break}return e.next=60,this.syncOnlineOperation({payloads:P,checkIntegrity:a,source:s,mode:x});case 60:O=e.sent,e.next=66;break;case 63:return e.next=65,this.syncOfflineOperation({payloads:P});case 65:O=e.sent;case 66:return e.next=68,O.run();case 68:for(this.opStatus.setDidEnd(),l(),_=!0,j=!1,I=void 0,e.prev=73,E=g[Symbol.iterator]();!(_=(D=E.next()).done);_=!0)D.value.resolve();e.next=81;break;case 77:e.prev=77,e.t0=e.catch(73),j=!0,I=e.t0;case 81:e.prev=81,e.prev=82,_||null==E.return||E.return();case 84:if(e.prev=84,!j){e.next=87;break}throw I;case 87:return e.finish(84);case 88:return e.finish(81);case 89:if(Object(i.x)(this.resolveQueue,g),!this.opStatus.hasError()){e.next=92;break}return e.abrupt("return");case 92:return this.opStatus.reset(),this.state.setLastSyncDate(new Date),O.numberOfItemsInvolved>=this.majorChangeThreshold&&this.notifyEvent(d.MajorDataChange),e.next=97,this.handleNeverSyncedDeleted(v);case 97:if(x===$u.DownloadFirst){e.next=100;break}return e.next=100,this.notifyEvent(d.FullSyncCompleted,{source:s});case 100:if(x!==$u.DownloadFirst){e.next=107;break}return this.completedInitialSync=!0,e.next=104,this.notifyEvent(d.DownloadFirstSyncCompleted);case 104:return e.abrupt("return",this.sync({source:Xu.AfterDownloadFirst,checkIntegrity:!0}));case 107:if(this.popSpawnQueue()||!(this.resolveQueue.length>0)){e.next=112;break}this.log("Syncing again from resolve queue"),this.sync({source:Xu.ResolveQueue}),e.next=125;break;case 112:return e.next=114,this.itemsNeedingSync();case 114:if(e.t1=e.sent.length,!(e.t1>0)){e.next=119;break}return e.abrupt("return",this.sync({source:Xu.MoreDirtyItems}));case 119:if(!O.checkIntegrity){e.next=123;break}this.state.needsSync&&O.done&&(this.log("Syncing again from integrity check"),this.sync({checkIntegrity:!0,timingStrategy:Qu,source:Xu.IntegrityCheck})),e.next=125;break;case 123:return e.next=125,this.state.clearIntegrityHashes();case 125:case"end":return e.stop()}}),e,this,[[73,77,81,89],[82,,84,88]])}))),function(){return x.apply(this,arguments)})},{key:"syncOnlineOperation",value:(k=Hu(o.a.mark((function e(t){var r,n,a,i,s,c=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.payloads,n=t.checkIntegrity,a=t.source,i=t.mode,this.log("Syncing online user","source:",a,"mode:",i,"payloads:",r),e.t0=Tu,e.t1=this.apiService,e.t2=r,e.t3=n,e.next=8,this.getLastSyncToken();case 8:return e.t4=e.sent,e.next=11,this.getPaginationToken();case 11:return e.t5=e.sent,e.t6=function(){var e=Hu(o.a.mark((function e(t,r){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(1!==r){e.next=11;break}if(!(n=t).hasError){e.next=7;break}return e.next=5,c.handleErrorServerResponse({operation:s,response:n});case 5:e.next=9;break;case 7:return e.next=9,c.handleSuccessServerResponse({operation:s,response:n});case 9:e.next=14;break;case 11:if(2!==r){e.next=14;break}return e.next=14,c.handleStatusChange({operation:s});case 14:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),e.t7={apiService:e.t1,payloads:e.t2,checkIntegrity:e.t3,lastSyncToken:e.t4,paginationToken:e.t5,receiver:e.t6},s=new e.t0(e.t7),e.abrupt("return",s);case 16:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"syncOfflineOperation",value:(w=Hu(o.a.mark((function e(t){var r,n,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.payloads,this.log("Syncing offline user",r),n=new Fu({payloads:r,receiver:function(){var e=Hu(o.a.mark((function e(t,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(1!==r){e.next=5;break}return e.next=3,a.handleOfflineResponse(t);case 3:e.next=8;break;case 5:if(2!==r){e.next=8;break}return e.next=8,a.handleStatusChange({operation:n});case 8:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()}),e.abrupt("return",n);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"handleStatusChange",value:(g=Hu(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.operation,n=r.pendingUploadCount(),a=r.totalUploadCount(),i=a-n,this.opStatus.setUploadStatus({completed:i,total:a});case 5:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"handleOfflineResponse",value:(b=Hu(o.a.mark((function e(t){var r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.payloads,n=this.modelManager.getMasterCollection(),a=r.map((function(e){return n.findPayload(e.uuid).mergedWith(e)})),e.next=5,this.persistPayloads({decryptedPayloads:a});case 5:return e.next=7,this.modelManager.mapPayloadsToLocalItems({payloads:r,source:rn.LocalSaved});case 7:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"handleErrorServerResponse",value:(m=Hu(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.operation,r=t.response,this.log("Sync Error",r),401===r.status&&this.notifyEvent(d.InvalidSession),this.opStatus.setError(r.error),this.notifyEvent(d.SyncError,r.error);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"handleSuccessServerResponse",value:(v=Hu(o.a.mark((function e(t){var r,n,a,s,c,u,l,f,p,y,h,v,m,b,g,w,k,x,S,P,O,_;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.operation,n=t.response,!this._simulate_latency){e.next=4;break}return e.next=4,Object(i.w)(this._simulate_latency.latency);case 4:this.log("Online Sync Response",n.rawResponse),this.setLastSyncToken(n.lastSyncToken),this.setPaginationToken(n.paginationToken),this.opStatus.clearError(),this.opStatus.setDownloadStatus({downloaded:n.allProcessedPayloads.length}),a=[],s=!0,c=!1,u=void 0,e.prev=13,l=n.allProcessedPayloads[Symbol.iterator]();case 15:if(s=(f=l.next()).done){e.next=26;break}if(!(p=f.value).deleted&&p.fields().includes(fe.Content)){e.next=19;break}return e.abrupt("continue",23);case 19:return e.next=21,this.protocolService.payloadByDecryptingPayload({payload:p});case 21:y=e.sent,a.push(y);case 23:s=!0,e.next=15;break;case 26:e.next=32;break;case 28:e.prev=28,e.t0=e.catch(13),c=!0,u=e.t0;case 32:e.prev=32,e.prev=33,s||null==l.return||l.return();case 35:if(e.prev=35,!c){e.next=38;break}throw u;case 38:return e.finish(35);case 39:return e.finish(32);case 40:return h=this.modelManager.getMasterCollection(),v=new Eu({response:n,decryptedResponsePayloads:a,payloadsSavedOrSaving:r.payloadsSavedOrSaving,baseCollection:h}),e.next=44,v.collectionsByProcessingResponse();case 44:m=e.sent,b=!0,g=!1,w=void 0,e.prev=48,k=m[Symbol.iterator]();case 50:if(b=(x=k.next()).done){e.next=62;break}return S=x.value,e.next=54,this.modelManager.mapCollectionToLocalItems({collection:S});case 54:return P=void 0,O=lo(S.source),P=O.fields().includes(fe.Content)?S.allPayloads:S.allPayloads.map((function(e){return h.findPayload(e.uuid).mergedWith(e)})),e.next=59,this.persistPayloads({decryptedPayloads:P});case 59:b=!0,e.next=50;break;case 62:e.next=68;break;case 64:e.prev=64,e.t1=e.catch(48),g=!0,w=e.t1;case 68:e.prev=68,e.prev=69,b||null==k.return||k.return();case 71:if(e.prev=71,!g){e.next=74;break}throw w;case 74:return e.finish(71);case 75:return e.finish(68);case 76:return e.next=78,this.notifyEvent(d.SingleSyncCompleted,n);case 78:if(!n.checkIntegrity){e.next=84;break}return e.next=81,this.computeDataIntegrityHash();case 81:return _=e.sent,e.next=84,this.state.setIntegrityHashes({clientHash:_,serverHash:n.integrityHash});case 84:case"end":return e.stop()}}),e,this,[[13,28,32,40],[33,,35,39],[48,64,68,76],[69,,71,75]])}))),function(e){return v.apply(this,arguments)})},{key:"handleNeverSyncedDeleted",value:(h=Hu(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.map((function(e){return e.payloadRepresentation({override:{dirty:!1}})})),e.next=3,this.modelManager.mapPayloadsToLocalItems({payloads:r});case 3:return e.next=5,this.persistPayloads({decryptedPayloads:r});case 5:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"persistPayloads",value:(y=Hu(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.decryptedPayloads,0!==(n=void 0===r?[]:r).length){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,this.storageService.savePayloads(n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"computeDataIntegrityHash",value:(p=Hu(o.a.mark((function e(){var t,r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.modelManager.nonDeletedItems.sort((function(e,t){return t.updated_at-e.updated_at})),r=t.map((function(e){return e.updatedAtTimestamp()})),n=r.join(","),e.abrupt("return",this.protocolService.crypto.sha256(n));case 7:return e.prev=7,e.t0=e.catch(0),console.error("Error computing data integrity hash",e.t0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(){return p.apply(this,arguments)})},{key:"deinit",value:(l=Hu(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return qu(Yu(t.prototype),"deinit",this).call(this),this.state.reset(),this.opStatus.reset(),this.resolveQueue=[],this.spawnQueue=[],e.next=7,this.clearSyncPositionTokens();case 7:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"resolveOutOfSync",value:(u=Hu(o.a.mark((function e(){var t,r,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Pu({apiService:this.apiService,protocolService:this.protocolService,customEvent:"resolve-out-of-sync"}),e.next=3,t.run();case 3:return r=e.sent,n=new Da({baseCollection:this.modelManager.getMasterCollection(),applyCollection:new f({payloads:r,source:rn.RemoteRetrieved})}),e.next=7,n.resultingCollection();case 7:return a=e.sent,e.next=10,this.modelManager.mapCollectionToLocalItems({collection:a});case 10:return e.next=12,this.persistPayloads({decryptedPayloads:a.payloads});case 12:return e.abrupt("return",this.sync({checkIntegrity:!0,source:Xu.ResolveOutOfSync}));case 13:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"statelessDownloadAllItems",value:(s=Hu(o.a.mark((function e(){var t,r,n,a,i,s=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]?s[0]:{},r=t.contentType,n=t.customEvent,a=new Pu({apiService:this.apiService,protocolService:this.protocolService,contentType:r,customEvent:n}),e.next=4,a.run();case 4:return i=e.sent,e.abrupt("return",i.map((function(e){return Yr(e)})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"ut_setDatabaseLoaded",value:function(e){this.databaseLoaded=e}},{key:"ut_beginLatencySimulator",value:function(e){this._simulate_latency={latency:e||1e3,enabled:!0}}},{key:"ut_endLatencySimulator",value:function(){this._simulate_latency=null}}])&&Wu(r.prototype,n),a&&Wu(r,a),t}(ho);function el(e){return(el="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function tl(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function rl(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){tl(o,n,a,i,s,"next",e)}function s(e){tl(o,n,a,i,s,"throw",e)}i(void 0)}))}}function nl(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function al(e,t){return!t||"object"!==el(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ol(e){return(ol=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function il(e,t){return(il=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var sl=function(e){function t(e){var r,n=e.storageService,a=e.keyManager,o=e.protocolService;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=al(this,ol(t).call(this))).storageService=n,r.keyManager=a,r.protocolService=o,r}var r,n,a,i,s,c,u;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&il(e,t)}(t,e),r=t,(n=[{key:"isPasscodeLocked",value:function(){return this.keyManager.rootKeyNeedsUnwrapping()}},{key:"getLaunchChallenges",value:(u=rl(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,this.keyManager.hasPasscode();case 3:return e.sent&&t.push(A.LocalPasscode),e.next=7,this.storageService.getValue(T.BiometricPrefs,Os.Nonwrapped);case 7:return(r=e.sent)&&r.enabled&&t.push(A.Biometric),e.abrupt("return",t);case 11:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"enableBiometrics",value:(c=rl(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setValue(T.BiometricPrefs,{enabled:!0},Os.Nonwrapped);case 2:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"validateChallengeResponse",value:(s=rl(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.challenge!==A.LocalPasscode){e.next=4;break}return e.abrupt("return",this.keyManager.validatePasscode(t.value));case 4:if(t.challenge!==A.AccountPassword){e.next=8;break}return e.abrupt("return",this.keyManager.validateAccountPassword(t.value));case 8:if(t.challenge!==A.Biometric){e.next=10;break}return e.abrupt("return",!0===t.value);case 10:throw"Cannot validate challenge type ".concat(t.challenge);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"handleChallengeResponse",value:(i=rl(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.challenge!==A.LocalPasscode){e.next=8;break}return e.next=3,this.keyManager.computeWrappingKey({passcode:t.value});case 3:return r=e.sent,e.next=6,this.keyManager.unwrapRootKey({wrappingKey:r});case 6:e.next=8;break;case 8:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})}])&&nl(r.prototype,n),a&&nl(r,a),t}(ho);function cl(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ul(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){cl(o,n,a,i,s,"next",e)}function s(e){cl(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ll(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function fl(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var pl=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.environment,n=t.platform,a=t.namespace,o=t.host,i=t.deviceInterface,s=t.swapClasses,c=t.skipClasses,u=t.crypto;if(ll(this,e),!i)throw"Device Interface must be supplied.";if(!r)throw"Environment must be supplied when creating an application.";if(!n)throw"Platform must be supplied when creating an application.";this.environment=r,this.platform=n,this.namespace=a||"",this.host=o,this.deviceInterface=i,this.crypto=u,this.swapClasses=s,this.skipClasses=c,this.eventHandlers=[],this.services=[],this.streamObservers=[],this.serviceObservers=[],this.managedSubscribers=[],this.constructServices()}var t,r,n,a,s,u,l,f,p,y,h,v,O,_,j,I,E,D,C,R,A,T,M,K,L,F,N,U,B,V,H,W,z,q,Y,G,J,Q,$,X,Z,ee,te,re,ne,ae,oe,ie,se;return t=e,(r=[{key:"prepareForLaunch",value:(se=ul(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.callbacks).requiresChallengeResponses){e.next=3;break}throw"Application.launch callbacks are not properly configured.";case 3:return this.launchCallbacks=r,e.next=6,this.deviceInterface.openDatabase();case 6:return e.next=8,this.migrationService.initialize();case 8:return e.next=10,this.handleStage(g);case 10:return e.next=12,this.storageService.initializeFromDisk();case 12:return e.next=14,this.keyManager.initialize();case 14:return e.next=16,this.handleStage(w);case 16:return this.started=!0,e.next=19,this.notifyEvent(b.Started);case 19:case"end":return e.stop()}}),e,this)}))),function(e){return se.apply(this,arguments)})},{key:"launch",value:(ie=ul(o.a.mark((function e(){var t,r,n,a,i=this,s=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]?s[0]:{},r=t.awaitDatabaseLoad,e.next=3,this.handleLaunchAuthentication();case 3:return e.next=5,this.storageService.isStorageWrapped();case 5:if(!e.sent){e.next=8;break}return e.next=8,this.storageService.decryptStorage();case 8:return e.next=10,this.handleStage(k);case 10:return e.next=12,this.sessionManager.initializeFromDisk();case 12:return this.historyManager.initializeFromDisk(),this.unlocked=!0,e.next=16,this.notifyEvent(b.Launched);case 16:return e.next=18,this.handleStage(x);case 18:return e.next=20,this.syncService.getDatabasePayloads();case 20:return n=e.sent,e.next=23,this.handleStage(S);case 23:if(a=this.syncService.loadDatabasePayloads(n).then(ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.dealloced){e.next=2;break}throw"Application has been destroyed.";case 2:return e.next=4,i.handleStage(P);case 4:return i.beginAutoSyncTimer(),e.abrupt("return",i.syncService.sync({mode:$u.DownloadFirst}));case 6:case"end":return e.stop()}}),e)})))),!r){e.next=27;break}return e.next=27,a;case 27:case"end":return e.stop()}}),e,this)}))),function(){return ie.apply(this,arguments)})},{key:"beginAutoSyncTimer",value:function(){var e=this;this.autoSyncInterval=this.deviceInterface.interval((function(){e.syncService.log("Syncing from autosync"),e.sync()}),3e4)}},{key:"handleLaunchAuthentication",value:(oe=ul(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceAuthService.getLaunchChallenges();case 2:return t=e.sent,e.next=5,this.handleLaunchChallenge(t);case 5:case"end":return e.stop()}}),e,this)}))),function(){return oe.apply(this,arguments)})},{key:"handleLaunchChallenge",value:(ae=ul(o.a.mark((function e(t){var r,n,a,s,c,u,l,f,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.slice();case 1:if(!(r.length>0)){e.next=43;break}return e.next=4,this.launchCallbacks.requiresChallengeResponses(r);case 4:n=e.sent,a=Array.isArray(n)?n:[n],s=!0,c=!1,u=void 0,e.prev=9,l=a[Symbol.iterator]();case 11:if(s=(f=l.next()).done){e.next=27;break}return p=f.value,e.next=15,this.deviceAuthService.validateChallengeResponse(p);case 15:if(!e.sent){e.next=22;break}return e.next=19,this.deviceAuthService.handleChallengeResponse(p);case 19:Object(i.u)(r,p.challenge),e.next=24;break;case 22:return e.next=24,this.launchCallbacks.handleChallengeFailures([p]);case 24:s=!0,e.next=11;break;case 27:e.next=33;break;case 29:e.prev=29,e.t0=e.catch(9),c=!0,u=e.t0;case 33:e.prev=33,e.prev=34,s||null==l.return||l.return();case 36:if(e.prev=36,!c){e.next=39;break}throw u;case 39:return e.finish(36);case 40:return e.finish(33);case 41:e.next=1;break;case 43:case"end":return e.stop()}}),e,this,[[9,29,33,41],[34,,36,40]])}))),function(e){return ae.apply(this,arguments)})},{key:"getMigrationChallengeResponder",value:function(){var e=this;return(function(){var t=ul(o.a.mark((function t(r){var n;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.launchCallbacks.requiresChallengeResponses([r]);case 2:return n=t.sent,t.abrupt("return",n[0]);case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"handleStage",value:(ne=ul(o.a.mark((function e(t){var r,n,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,n=!1,a=void 0,e.prev=3,i=this.services[Symbol.iterator]();case 5:if(r=(s=i.next()).done){e.next=12;break}return c=s.value,e.next=9,c.handleApplicationStage(t);case 9:r=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),n=!0,a=e.t0;case 18:e.prev=18,e.prev=19,r||null==i.return||i.return();case 21:if(e.prev=21,!n){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}}),e,this,[[3,14,18,26],[19,,21,25]])}))),function(e){return ne.apply(this,arguments)})},{key:"addEventObserver",value:function(e,t){var r=this,n={callback:e,singleEvent:t};return this.eventHandlers.push(n),function(){Object(i.u)(r.eventHandlers,n)}}},{key:"addSingleEventObserver",value:function(e,t){return this.addEventObserver((function(r){r===e&&t()}),e)}},{key:"notifyEvent",value:(re=ul(o.a.mark((function e(t,r){var n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,a=!1,i=void 0,e.prev=3,s=this.eventHandlers.slice()[Symbol.iterator]();case 5:if(n=(c=s.next()).done){e.next=18;break}if(!(u=c.value).singleEvent||u.singleEvent!==t){e.next=12;break}return e.next=10,u.callback(t,r||{});case 10:e.next=15;break;case 12:if(u.singleEvent){e.next=15;break}return e.next=15,u.callback(t,r||{});case 15:n=!0,e.next=5;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(3),a=!0,i=e.t0;case 24:e.prev=24,e.prev=25,n||null==s.return||s.return();case 27:if(e.prev=27,!a){e.next=30;break}throw i;case 30:return e.finish(27);case 31:return e.finish(24);case 32:case"end":return e.stop()}}),e,this,[[3,20,24,32],[25,,27,31]])}))),function(e,t){return re.apply(this,arguments)})},{key:"isDatabaseLoaded",value:function(){return this.syncService.isDatabaseLoaded()}},{key:"savePayload",value:(te=ul(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.payload,n=so({payload:r,override:{dirty:!0}}),e.next=4,this.modelManager.mapPayloadToLocalItem({payload:n});case 4:return e.next=6,this.syncService.sync();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return te.apply(this,arguments)})},{key:"findItem",value:function(e){var t=e.uuid;return this.modelManager.findItem(t)}},{key:"findItems",value:function(e){var t=e.predicate;return this.modelManager.itemsMatchingPredicate(t)}},{key:"mergeItem",value:(ee=ul(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.item,n=t.source,e.abrupt("return",this.modelManager.mapItem({item:r,source:n}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return ee.apply(this,arguments)})},{key:"createItem",value:(Z=ul(o.a.mark((function e(t){var r,n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.contentType,n=t.content,a=t.add,i=t.needsSync,e.next=3,this.modelManager.createItem({contentType:r,content:n,add:a,needsSync:i});case 3:return s=e.sent,e.abrupt("return",s);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return Z.apply(this,arguments)})},{key:"saveItem",value:(X=ul(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.item,e.next=3,this.modelManager.setItemDirty(r,!0);case 3:return e.next=5,this.syncService.sync();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return X.apply(this,arguments)})},{key:"saveItems",value:($=ul(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.items,e.next=3,this.modelManager.setItemsDirty(r);case 3:return e.next=5,this.syncService.sync();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return $.apply(this,arguments)})},{key:"setItemNeedsSync",value:(Q=ul(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.item,n=t.updateUserModifiedDate,e.abrupt("return",this.modelManager.setItemDirty(r,!0,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return Q.apply(this,arguments)})},{key:"setItemsNeedsSync",value:(J=ul(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.items,e.abrupt("return",this.modelManager.setItemsDirty(r));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return J.apply(this,arguments)})},{key:"deleteItem",value:(G=ul(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.item,this.modelManager.setItemToBeDeleted(r),this.sync();case 3:case"end":return e.stop()}}),e,this)}))),function(e){return G.apply(this,arguments)})},{key:"deleteItemLocally",value:(Y=ul(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.item,this.modelManager.removeItemLocally(r);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return Y.apply(this,arguments)})},{key:"emptyTrash",value:(q=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.modelManager.emptyTrash();case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),e,this)}))),function(){return q.apply(this,arguments)})},{key:"getTrashedItems",value:function(){return this.modelManager.trashedItems()}},{key:"getItems",value:function(e){var t=e.contentType;return this.modelManager.getItems(t)}},{key:"getDisplayableItems",value:function(e){var t=e.contentType;return this.modelManager.validItemsForContentType(t)}},{key:"getNotesMatchingSmartTag",value:function(e){var t=e.smartTag;return this.modelManager.notesMatchingSmartTag(t)}},{key:"findTag",value:function(e){var t=e.title;return this.modelManager.findTagByTitle(t)}},{key:"findOrCreateTag",value:(z=ul(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.title,e.abrupt("return",this.modelManager.findOrCreateTagByTitle(r));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return z.apply(this,arguments)})},{key:"getSmartTags",value:function(){return this.modelManager.getSmartTags()}},{key:"getNoteCount",value:function(){return this.modelManager.noteCount()}},{key:"streamItems",value:function(e){var t=this,r=e.contentType,n=e.stream,a=this.modelManager.addMappingObserver(r,(function(e,t,r,a,o){var i=e.map((function(e){return e.content_type}));n({items:e,contentTypes:i,source:a,sourceKey:o})}));return this.streamObservers.push(a),function(){Object(i.u)(t.streamObservers,a)}}},{key:"setHost",value:(W=ul(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.setHost(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return W.apply(this,arguments)})},{key:"getHost",value:(H=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.getHost());case 1:case"end":return e.stop()}}),e,this)}))),function(){return H.apply(this,arguments)})},{key:"getUser",value:function(){if(!this.unlocked)throw"Attempting to access user before application unlocked";return this.sessionManager.getUser()}},{key:"getUserVersion",value:(V=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.getUserVersion());case 1:case"end":return e.stop()}}),e,this)}))),function(){return V.apply(this,arguments)})},{key:"protocolUpgradeAvailable",value:(B=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.upgradeAvailable());case 1:case"end":return e.stop()}}),e,this)}))),function(){return B.apply(this,arguments)})},{key:"noAccount",value:function(){var e=this.getUser();return Object(i.l)(e)}},{key:"importData",value:(U=ul(o.a.mark((function e(t){var r,n,a,i,s,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.data,n=t.password,a=t.awaitSync,e.next=3,this.protocolService.payloadsByDecryptingBackupFile({data:r,password:n});case 3:return i=e.sent,s=i.filter((function(e){return!e.errorDecrypting})),e.next=7,this.modelManager.importPayloads(s);case 7:if(c=e.sent,u=this.sync(),!a){e.next=12;break}return e.next=12,u;case 12:return e.abrupt("return",{affectedItems:c,errorCount:i.length-s.length});case 13:case"end":return e.stop()}}),e,this)}))),function(e){return U.apply(this,arguments)})},{key:"createBackupFile",value:(N=ul(o.a.mark((function e(){var t,r,n,a,i=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.length>0&&void 0!==i[0]?i[0]:{},r=t.subItems,n=t.intent,a=t.returnIfEmpty,e.abrupt("return",this.protocolService.createBackupFile({subItems:r,intent:n,returnIfEmpty:a}));case 2:case"end":return e.stop()}}),e,this)}))),function(){return N.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.storageService.isEphemeralSession()}},{key:"lockSyncing",value:function(){this.syncService.lockSyncing()}},{key:"unlockSyncing",value:function(){this.syncService.unlockSyncing()}},{key:"getSyncStatus",value:(F=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.status);case 1:case"end":return e.stop()}}),e,this)}))),function(){return F.apply(this,arguments)})},{key:"sync",value:(L=ul(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.sync(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return L.apply(this,arguments)})},{key:"resolveOutOfSync",value:(K=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.resolveOutOfSync());case 1:case"end":return e.stop()}}),e,this)}))),function(){return K.apply(this,arguments)})},{key:"setValue",value:(M=ul(o.a.mark((function e(t,r,n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.setValue(t,r,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return M.apply(this,arguments)})},{key:"getValue",value:(T=ul(o.a.mark((function e(t,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(t,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return T.apply(this,arguments)})},{key:"removeValue",value:(A=ul(o.a.mark((function e(t,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.removeValue(t,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return A.apply(this,arguments)})},{key:"clearDatabase",value:(R=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.clearAllPayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return R.apply(this,arguments)})},{key:"rewriteItemsKeys",value:(C=ul(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemsKeyManager.allItemsKeys,r=t.map((function(e){return e.payloadRepresentation()})),e.next=4,this.storageService.deletePayloads(r);case 4:return e.next=6,this.syncService.persistPayloads({decryptedPayloads:r});case 6:case"end":return e.stop()}}),e,this)}))),function(){return C.apply(this,arguments)})},{key:"restart",value:(D=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deinit();case 2:return this.dealloced=!1,this.constructServices(),e.next=6,this.prepareForLaunch({callbacks:this.launchCallbacks});case 6:return e.next=8,this.launch({awaitDatabaseLoad:!0});case 8:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"deinit",value:(E=ul(o.a.mark((function e(){var t,r,n,a,i,s,c,u,l,f,p,y,h,v,d,m;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(clearInterval(this.autoSyncInterval),t=!0,r=!1,n=void 0,e.prev=4,a=this.serviceObservers[Symbol.iterator]();!(t=(i=a.next()).done);t=!0)(0,i.value)();e.next=12;break;case 8:e.prev=8,e.t0=e.catch(4),r=!0,n=e.t0;case 12:e.prev=12,e.prev=13,t||null==a.return||a.return();case 15:if(e.prev=15,!r){e.next=18;break}throw n;case 18:return e.finish(15);case 19:return e.finish(12);case 20:for(s=!0,c=!1,u=void 0,e.prev=23,l=this.managedSubscribers[Symbol.iterator]();!(s=(f=l.next()).done);s=!0)(0,f.value)();e.next=31;break;case 27:e.prev=27,e.t1=e.catch(23),c=!0,u=e.t1;case 31:e.prev=31,e.prev=32,s||null==l.return||l.return();case 34:if(e.prev=34,!c){e.next=37;break}throw u;case 37:return e.finish(34);case 38:return e.finish(31);case 39:p=!0,y=!1,h=void 0,e.prev=42,v=this.services[Symbol.iterator]();case 44:if(p=(d=v.next()).done){e.next=52;break}if(!(m=d.value).deinit){e.next=49;break}return e.next=49,m.deinit();case 49:p=!0,e.next=44;break;case 52:e.next=58;break;case 54:e.prev=54,e.t2=e.catch(42),y=!0,h=e.t2;case 58:e.prev=58,e.prev=59,p||null==v.return||v.return();case 61:if(e.prev=61,!y){e.next=64;break}throw h;case 64:return e.finish(61);case 65:return e.finish(58);case 66:this.streamObservers=[],this.clearServices(),this.dealloced=!0,this.started=!1;case 70:case"end":return e.stop()}}),e,this,[[4,8,12,20],[13,,15,19],[23,27,31,39],[32,,34,38],[42,54,58,66],[59,,61,65]])}))),function(){return E.apply(this,arguments)})},{key:"registerService",value:function(e){this.services.push(e)}},{key:"register",value:(I=ul(o.a.mark((function e(t){var r,n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.email,n=t.password,a=t.ephemeral,i=t.mergeLocal,this.lockSyncing(),e.next=4,this.sessionManager.register({email:r,password:n});case 4:if((s=e.sent).response.error){e.next=27;break}return e.next=8,this.keyManager.setNewRootKey({key:s.rootKey,keyParams:s.keyParams});case 8:return this.syncService.resetSyncState(),e.next=11,this.storageService.setPersistencePolicy(a?Ss.Ephemeral:Ss.Default);case 11:if(!i){e.next=16;break}return e.next=14,this.syncService.markAllItemsAsNeedingSync({alternateUuids:!0});case 14:e.next=19;break;case 16:return this.modelManager.removeAllItemsFromMemory(),e.next=19,this.clearDatabase();case 19:return e.next=21,this.notifyEvent(b.SignedIn);case 21:return this.unlockSyncing(),e.next=24,this.syncService.sync({mode:$u.DownloadFirst,timingStrategy:Qu});case 24:this.protocolService.decryptErroredItems(),e.next=28;break;case 27:this.unlockSyncing();case 28:return e.abrupt("return",s.response);case 29:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"signIn",value:(j=ul(o.a.mark((function e(t){var r,n,a,i,s,c,u,l,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.email,n=t.password,a=t.strict,i=t.ephemeral,s=t.mfaKeyPath,c=t.mfaCode,u=t.mergeLocal,l=void 0===u||u,this.lockSyncing(),e.next=4,this.sessionManager.signIn({email:r,password:n,strict:a,mfaKeyPath:s,mfaCode:c});case 4:if((f=e.sent).response.error){e.next=27;break}return e.next=8,this.keyManager.setNewRootKey({key:f.rootKey,keyParams:f.keyParams});case 8:return this.syncService.resetSyncState(),e.next=11,this.storageService.setPersistencePolicy(i?Ss.Ephemeral:Ss.Default);case 11:if(!l){e.next=16;break}return e.next=14,this.syncService.markAllItemsAsNeedingSync({alternateUuids:!0});case 14:e.next=19;break;case 16:return this.modelManager.removeAllItemsFromMemory(),e.next=19,this.clearDatabase();case 19:return e.next=21,this.notifyEvent(b.SignedIn);case 21:return this.unlockSyncing(),e.next=24,this.syncService.sync({mode:$u.DownloadFirst,checkIntegrity:!0,timingStrategy:Qu});case 24:this.protocolService.decryptErroredItems(),e.next=28;break;case 27:this.unlockSyncing();case 28:return e.abrupt("return",f.response);case 29:case"end":return e.stop()}}),e,this)}))),function(e){return j.apply(this,arguments)})},{key:"changePassword",value:(_=ul(o.a.mark((function e(t){var r,n,a,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.email,n=t.currentPassword,a=t.newPassword,e.next=3,this.keyManager.getRootKeyParams();case 3:return i=e.sent,this.lockSyncing(),e.next=7,this.sessionManager.changePassword({email:r,currentPassword:n,currentKeyParams:i,newPassword:a});case 7:if((s=e.sent).response.error){e.next=18;break}return e.next=11,this.keyManager.setNewRootKey({key:s.rootKey,keyParams:s.keyParams});case 11:return e.next=13,this.itemsKeyManager.createNewDefaultItemsKey();case 13:return this.unlockSyncing(),e.next=16,this.syncService.sync();case 16:e.next=19;break;case 18:this.unlockSyncing();case 19:return e.abrupt("return",s.response);case 20:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"signOut",value:(O=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionManager.signOut();case 2:return e.next=4,this.keyManager.clearLocalKeyState();case 4:return e.next=6,this.storageService.clearAllData();case 6:return e.next=8,this.notifyEvent(b.SignedOut);case 8:return e.next=10,this.restart();case 10:case"end":return e.stop()}}),e,this)}))),function(){return O.apply(this,arguments)})},{key:"validateAccountPassword",value:(v=ul(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.password,e.abrupt("return",this.keyManager.validateAccountPassword(r));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"isStarted",value:function(){return this.started}},{key:"hasPasscode",value:function(){return this.keyManager.hasPasscode()}},{key:"isLocked",value:(h=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.started){e.next=2;break}return e.abrupt("return",!0);case 2:return e.abrupt("return",this.deviceAuthService.isPasscodeLocked());case 3:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"lock",value:(y=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.restart());case 1:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"setPasscode",value:(p=ul(o.a.mark((function e(t){var r,n,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.protocolService.crypto.generateUUID();case 2:return r=e.sent,e.next=5,this.protocolService.createRootKey({identifier:r,password:t});case 5:return n=e.sent,a=n.key,i=n.keyParams,e.next=10,this.keyManager.setNewRootKeyWrapper({wrappingKey:a,keyParams:i});case 10:return e.next=12,this.rewriteItemsKeys();case 12:return e.next=14,this.syncService.sync();case 14:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"removePasscode",value:(f=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.keyManager.removeRootKeyWrapper();case 2:return e.next=4,this.rewriteItemsKeys();case 4:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"changePasscode",value:(l=ul(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.removePasscode();case 2:return e.abrupt("return",this.setPasscode(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"setStorageEncryptionPolicy",value:(u=ul(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setEncryptionPolicy(t);case 2:return e.abrupt("return",this.syncService.repersistAllItems());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"generateUuid",value:(s=ul(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.crypto.generateUUID());case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"changeDeviceInterface",value:(a=ul(o.a.mark((function e(t){var r,n,a,i,s,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(this.deviceInterface=t,r=!0,n=!1,a=void 0,e.prev=4,i=this.services[Symbol.iterator]();!(r=(s=i.next()).done);r=!0)(c=s.value).deviceInterface&&(c.deviceInterface=t);e.next=12;break;case 8:e.prev=8,e.t0=e.catch(4),n=!0,a=e.t0;case 12:e.prev=12,e.prev=13,r||null==i.return||i.return();case 15:if(e.prev=15,!n){e.next=18;break}throw a;case 18:return e.finish(15);case 19:return e.finish(12);case 20:case"end":return e.stop()}}),e,this,[[4,8,12,20],[13,,15,19]])}))),function(e){return a.apply(this,arguments)})},{key:"constructServices",value:function(){this.createModelManager(),this.createProtocolService(this.modelManager),this.createMigrationService(),this.createAlertManager(),this.createHttpManager(),this.createStorageManager(),this.createApiService(),this.createSessionManager(),this.createSyncManager(),this.createItemsKeyManager(),this.createKeyManager(),this.protocolService.setKeyManager(this.keyManager),this.protocolService.setItemsKeyManager(this.itemsKeyManager),this.itemsKeyManager.setKeyManager(this.keyManager),this.createDeviceAuthService(),this.createSingletonManager(),this.createComponentManager(),this.createPrivilegesManager(),this.createHistoryManager(),this.createActionsManager()}},{key:"clearServices",value:function(){this.migrationService=null,this.alertService=null,this.httpService=null,this.modelManager=null,this.protocolService=null,this.storageService=null,this.apiService=null,this.sessionManager=null,this.syncService=null,this.keyManager=null,this.itemsKeyManager=null,this.deviceAuthService=null,this.singletonManager=null,this.componentManager=null,this.privilegesService=null,this.actionsManager=null,this.services=[]}},{key:"createMigrationService",value:function(){this.migrationService=new(this.getClass(tc))({application:this,challengeResponder:this.getMigrationChallengeResponder()}),this.services.push(this.migrationService)}},{key:"createAlertManager",value:function(){this.shouldSkipClass(So)||(this.alertService=new(this.getClass(So))({deviceInterface:this.deviceInterface}),this.services.push(this.alertService))}},{key:"createApiService",value:function(){this.apiService=new(this.getClass(Xo))({storageService:this.storageService,httpService:this.httpService,host:this.host}),this.services.push(this.apiService)}},{key:"createComponentManager",value:function(){this.shouldSkipClass(_i)||(this.componentManager=new(this.getClass(_i))({modelManager:this.modelManager,syncService:this.syncService,alertService:this.alertService,timeout:this.deviceInterface.timeout,environment:this.environment,platform:this.platform}),this.services.push(this.componentManager))}},{key:"createHttpManager",value:function(){this.httpService=new(this.getClass(Mi)),this.services.push(this.httpService)}},{key:"createKeyManager",value:function(){var e=this;this.keyManager=new(this.getClass(iu))({modelManager:this.modelManager,storageService:this.storageService,protocolService:this.protocolService,itemsKeyManager:this.itemsKeyManager,deviceInterface:this.deviceInterface}),this.keyManager.onStatusChange(ul(o.a.mark((function t(){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.notifyEvent(b.KeyStatusChanged);case 2:case"end":return t.stop()}}),t)})))),this.services.push(this.keyManager)}},{key:"createItemsKeyManager",value:function(){this.itemsKeyManager=new(this.getClass(vu))({modelManager:this.modelManager,syncService:this.syncService,protocolService:this.protocolService}),this.services.push(this.itemsKeyManager)}},{key:"createModelManager",value:function(){this.modelManager=new(this.getClass(Yi)),this.services.push(this.modelManager)}},{key:"createSingletonManager",value:function(){this.singletonManager=new(this.getClass(ts))({modelManager:this.modelManager,syncService:this.syncService}),this.services.push(this.singletonManager)}},{key:"createStorageManager",value:function(){this.storageService=new(this.getClass(js))({protocolService:this.protocolService,namespace:this.namespace,deviceInterface:this.deviceInterface}),this.services.push(this.storageService)}},{key:"createProtocolService",value:function(e){this.protocolService=new(this.getClass(fc))({modelManager:e,crypto:this.crypto}),this.services.push(this.protocolService)}},{key:"createSessionManager",value:function(){this.sessionManager=new(this.getClass(To))({storageService:this.storageService,alertService:this.alertService,protocolService:this.protocolService,apiService:this.apiService,timeout:this.deviceInterface.timeout}),this.services.push(this.sessionManager)}},{key:"createSyncManager",value:function(){var e=this;this.syncService=new(this.getClass(Zu))({modelManager:this.modelManager,storageService:this.storageService,sessionManager:this.sessionManager,protocolService:this.protocolService,apiService:this.apiService,interval:this.deviceInterface.interval});var t=this.syncService.addEventObserver(function(){var t=ul(o.a.mark((function t(r){var n;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=r,o=void 0,!(n=(o={},m(o,d.FullSyncCompleted,b.CompletedSync),m(o,d.SyncError,b.FailedSync),m(o,d.SyncTakingTooLong,b.HighLatencySync),m(o,d.EnterOutOfSync,b.EnteredOutOfSync),m(o,d.ExitOutOfSync,b.ExitedOutOfSync),o)[a])){t.next=4;break}return t.next=4,e.notifyEvent(n);case 4:case"end":return t.stop()}var a,o}),t)})));return function(e){return t.apply(this,arguments)}}());this.serviceObservers.push(t),this.services.push(this.syncService)}},{key:"createDeviceAuthService",value:function(){this.deviceAuthService=new(this.getClass(sl))({storageService:this.storageService,protocolService:this.protocolService,keyManager:this.keyManager}),this.services.push(this.deviceAuthService)}},{key:"createPrivilegesManager",value:function(){this.privilegesService=new(this.getClass(Gc))({storageService:this.storageService,keyManager:this.keyManager,modelManager:this.modelManager,syncService:this.syncService,sessionManager:this.sessionManager,singletonManager:this.singletonManager}),this.services.push(this.privilegesService)}},{key:"createHistoryManager",value:function(){this.historyManager=new(this.getClass(Tc))({storageService:this.storageService,modelManager:this.modelManager,contentTypes:[c.Note],timeout:this.deviceInterface.timeout}),this.services.push(this.historyManager)}},{key:"createActionsManager",value:function(){this.actionsManager=new(this.getClass(us))({alertService:this.alertService,deviceInterface:this.deviceInterface,httpService:this.httpService,modelManager:this.modelManager,protocolService:this.protocolService,syncService:this.syncService}),this.services.push(this.actionsManager)}},{key:"shouldSkipClass",value:function(e){return this.skipClasses&&this.skipClasses.includes(e)}},{key:"getClass",value:function(e){var t=this.swapClasses&&this.swapClasses.find((function(t){return t.swap===e}));return t?t.with:e}}])&&fl(t.prototype,r),n&&fl(t,n),e}();function yl(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function hl(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){yl(o,n,a,i,s,"next",e)}function s(e){yl(o,n,a,i,s,"throw",e)}i(void 0)}))}}function vl(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function dl(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var ml=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.namespace,n=t.timeout,a=t.interval;if(vl(this,e),!n||!a)throw"'timeout' and 'interval' are required to initialize device interface.";this.namespace=r,this.timeout=n||setTimeout.bind(Object(i.h)()),this.interval=a||setInterval.bind(Object(i.h)())}var t,r,n,a,s,c,u,l,f,p,y,h,v,d,m,b,g,w;return t=e,(r=[{key:"getRawStorageValue",value:(w=hl(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.getRawStorageValue";case 1:case"end":return e.stop()}}),e)}))),function(e){return w.apply(this,arguments)})},{key:"getJsonParsedStorageValue",value:(g=hl(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRawStorageValue(t);case 2:return r=e.sent,e.abrupt("return",r?JSON.parse(r):r);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"getAllRawStorageKeyValues",value:(b=hl(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.getAllRawStorageKeyValues";case 1:case"end":return e.stop()}}),e)}))),function(){return b.apply(this,arguments)})},{key:"setRawStorageValue",value:(m=hl(o.a.mark((function e(t,r){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.setRawStorageValue";case 1:case"end":return e.stop()}}),e)}))),function(e,t){return m.apply(this,arguments)})},{key:"removeRawStorageValue",value:(d=hl(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.removeRawStorageValue";case 1:case"end":return e.stop()}}),e)}))),function(e){return d.apply(this,arguments)})},{key:"removeAllRawStorageValues",value:(v=hl(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.removeAllRawStorageValues";case 1:case"end":return e.stop()}}),e)}))),function(){return v.apply(this,arguments)})},{key:"openDatabase",value:(h=hl(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.openDatabase";case 1:case"end":return e.stop()}}),e)}))),function(){return h.apply(this,arguments)})},{key:"getAllRawDatabasePayloads",value:(y=hl(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.getAllRawDatabasePayloads";case 1:case"end":return e.stop()}}),e)}))),function(){return y.apply(this,arguments)})},{key:"saveRawDatabasePayload",value:(p=hl(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.saveRawDatabasePayload";case 1:case"end":return e.stop()}}),e)}))),function(e){return p.apply(this,arguments)})},{key:"saveRawDatabasePayloads",value:(f=hl(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.saveRawDatabasePayloads";case 1:case"end":return e.stop()}}),e)}))),function(e){return f.apply(this,arguments)})},{key:"removeRawDatabasePayloadWithId",value:(l=hl(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.removeRawDatabasePayloadWithId";case 1:case"end":return e.stop()}}),e)}))),function(e){return l.apply(this,arguments)})},{key:"removeAllRawDatabasePayloads",value:(u=hl(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.removeAllRawDatabasePayloads";case 1:case"end":return e.stop()}}),e)}))),function(){return u.apply(this,arguments)})},{key:"getKeychainValue",value:(c=hl(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.getKeychainValue";case 1:case"end":return e.stop()}}),e)}))),function(){return c.apply(this,arguments)})},{key:"setKeychainValue",value:(s=hl(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.setKeychainValue";case 1:case"end":return e.stop()}}),e)}))),function(e){return s.apply(this,arguments)})},{key:"clearKeychainValue",value:(a=hl(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override DeviceInterface.clearKeychainValue";case 1:case"end":return e.stop()}}),e)}))),function(){return a.apply(this,arguments)})}])&&dl(t.prototype,r),n&&dl(t,n),e}();var bl=function e(t){var r=t.challenge,n=t.value;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.challenge=r,this.value=n,Object.freeze(this)}}])}));
//# sourceMappingURL=snjs.min.js.map